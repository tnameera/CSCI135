function WRTCPeer(a,b){this.peerConnection=null,this.subid=a,this.remoteVideo=b,this.remoteStream=null,this.nextState=null,this._posX=-1,this._posY=-1,this._posWidth=-1,this._posHeight=-1,this._videoWidth=-1,this._videoHeight=-1,this._callEstablished=!1,this._muted=!1,this._streamAttached=!1,this.recvdBitrate=0,this.sentBitrate=0,this.plps=0,this.prps=0,this.peerObject=null,this.timerRunning=!1,this._publishingSS=!1,this._desktopStreamID=null,this.updateRV=function(a){},this.audioRecordingInitiated=function(){webRTC.sendMessageToID(this.subid,{type:webRTC.MSG_TYPE_INIT_AUDIO_RECORDING})},this.placeSSCall=function(){ssController._desktopStream&&this.peerConnection&&("connected"==this.peerConnection.iceConnectionState||"completed"==this.peerConnection.iceConnectionState)&&(this._publishingSS=!0,this.peerConnection.addStream(ssController._desktopStream),this.initiateReNegotiation(!1))},this.initiateReNegotiation=function(a){if("ANSWER"==this.lastState)a?webRTC.sendMessageToID(this.subid,{type:webRTC.MSG_TYPE_RENEGOTIATE,restartIce:!0}):webRTC.sendMessageToID(this.subid,{type:webRTC.MSG_TYPE_RENEGOTIATE});else{var b=webRTC.mediaConstraintsAV;zwrtc._video||(b=webRTC.mediaConstraintsA),this.renegotiateOffer(b,a)}},this.renegotiateOffer=function(a,b){if(a&&a.optional)for(var c=0;c<a.optional.length;c++)for(key in a.optional[c])"IceRestart"==key&&(a.optional[c].IceRestart=b,b=!1);b&&a.optional.push({IceRestart:!0}),this.peerConnection.createOffer(this.setLocalAndSendMessage.bind(this),this.onCreateSessionDescriptionError,a)},this.endSSCall=function(){!this.peerConnection||"connected"!=this.peerConnection.iceConnectionState&&"completed"!=this.peerConnection.iceConnectionState||(this._publishingSS=!1,this.peerConnection.removeStream(ssController._desktopStream),this.initiateReNegotiation(!1))},this.hideConnecting=function(){if(webRTC.log("P2P:hideConnecting"),!zwrtc._useCustomGUI&&this.remoteVideo){var a=$("#"+this.remoteVideo.id+"_conn"),b=$("#"+this.remoteVideo.id+"_conn_img");a.hide(),b.length>0&&(b[0].src="")}},this.attachStream=function(){return webRTC.log("P2P:attachStream"),zwrtc.isMCU()&&CallManager._srCommandID==-1?void webRTC.log("P2P:attachStream: mcu call going on returning..."):(this._pendingAttachStream=!1,this._streamAttached=!0,this.hideConnecting(),zwrtc._useCustomGUI&&(rtcSFU._sfuStreams[this.userId]=this.remoteStream,ConnectionManager._dispatchEvent("ZWRTC_ATTACH_RV_STREAM",{stream:this.remoteStream,id:this.subid,userId:this.userId})),void(!webRTC.isVideoMuted&&"VOICE"!=CallManager._type||ssController._desktopStream||webRTC.sendToAllPeers({type:webRTC.MSG_TYPE_PVD,avatarUrl:DataStore.getUserData("avatarurl")})))},this.clearRV=function(){this._desktopStreamID&&this.screenShareStreamRemoved()},this.startDebugInfo=function(){if(!this.timerRunning){var a=0,b=0,c=0,d=0,e=0,f=0,g=0,h=this;this._pendingAttachStream=!0,this.debugInfoTimer=setInterval(function(){h.timerRunning=!0;var i=h.peerConnection;i&&i.getStats&&i.getStats(function(i){for(var j=i.result(),k=0;k<j.length;++k){var l=j[k];if((!l.local||l.local===l)&&"ssrc"==l.type)if(l.stat("googFrameWidthReceived")){var m=parseInt(l.stat("bytesReceived")),n=parseInt(l.stat("packetsLost")),o=parseInt(l.stat("packetsReceived"));c>0&&(h.recvdBitrate=Math.round(8*(m-a)/(l.timestamp-c)),h.plps=n-e,h.prps=o-f,h.prps>0&&(g=h.plps/h.prps)),h.recvdBitrate>0&&h._pendingAttachStream&&h.attachStream(),c=l.timestamp,a=m,e=n,f=o}else if(l.stat("googFrameWidthInput")){var m=parseInt(l.stat("bytesSent"));if(d>0){var p=l.timestamp-d,q=m-b;p>0&&(h.sentBitrate=Math.round(8*q/p))}d=l.timestamp,b=m}}})},1e3)}},this.fullScreenStatus=function(){return document.fullscreen||document.mozFullScreen||document.webkitIsFullScreen},this.resize=function(){this.setRV(this._posX,this._posY,this._posWidth,this._posHeight,this._videoWidth,this._videoHeight,this._mainRV)},this.setRV=function(a,b,c,d,e,f,g){if(!zwrtc._useCustomGUI&&(this._posX=a,this._posY=b,this._posWidth=c,this._posHeight=d,this._videoWidth=e,this._videoHeight=f,this._mainRV=g,this.remoteVideo)){var h=$("#"+this.remoteVideo.id),i=$("#"+this.remoteVideo.id+"_avatar"),j=$("#"+this.remoteVideo.id+"_div");if(this._streamAttached&&this._posX!=-1&&this._posY!=-1&&null!=g){webRTC.log("SHOW RV:"+this._posX+"X"+this._posY);var k=g.width(),l=g.height(),m=parseFloat(g.css("margin-left")),n=k/2,o=Math.ceil(a*k/e),p=Math.ceil(b*l/f),q=Math.ceil(c*k/e),r=Math.ceil(d*l/f);this.fullScreenStatus()&&isNaN(parseInt($("#zcdiv").css("left")))&&(m=(screen.width-k)/2),j.removeClass("rv_left"),j.removeClass("rv_right"),j.removeClass("rv_center"),o>n?j.addClass("rv_right"):o+q<n?j.addClass("rv_left"):j.addClass("rv_center"),j.length>0?(j.width(q),j.height(r),j.css("left",o+"px"),j.css("top",p+"px"),j.css("position","absolute"),j.css("margin-left",m+"px"),this._muted?(h.hide(),i.length>0&&(i.css("width","100%"),i.css("height","100%"),i.show())):(h.css("width","100%"),h.css("height","100%"),h.show(),i.length>0&&i.hide())):(this.remoteVideo.style.width=q+"px",this.remoteVideo.style.height=r+"px",this.remoteVideo.style.left=o+"px",this.remoteVideo.style.top=p+"px",this.remoteVideo.style.position="absolute",this.remoteVideo.style.display="inline",this.remoteVideo.style.marginLeft=m+"px"),j.length>0&&j.show()}else webRTC.log("HIDE RV:"+this._posX+"X"+this._posY),h.length>0?h.show():this.remoteVideo.style.display="none",j.length>0&&j.hide()}},this.reattachMediaStream=function(a,b){webRTC.log("Reattaching media stream"),a&&b&&(navigator.mozGetUserMedia?(a.mozSrcObject=b.mozSrcObject,a.play()):a.src=b.src)},this.createPeerConnection=function(){if(void 0==this.peerConnection)try{"firefox"==webRTC.webrtcDetectedBrowser&&(webRTC.stunserver_config={iceServers:[{url:"stun:23.21.150.121"}]});var a={optional:[{DtlsSrtpKeyAgreement:CallManager.DtlsSrtpKeyAgreement}]};this.peerConnection=RTCPeerConnection(webRTC.stunserver_config,a),webRTC.log('Created RTCPeerConnnection with:\n  config: "'+JSON.stringify(webRTC.stunserver_config)+'";\n  constraints: "'+JSON.stringify(a)+'".'),null==this.debugInfoTimer&&this.startDebugInfo()}catch(b){return void webRTC.log("Failed to create PeerConnection, exception: "+b.message)}},this.onUserMediaSuccess=function(){webRTC.log("onUserMediaSuccess: "+this.nextState+" "+this.subid),"OFFER"==this.nextState?this.processOffer():"ANSWER"==this.nextState&&this.processAnswer()},this.doOffer=function(){this.createPeerConnection(),this.peerConnection.onicecandidate=this.onIceCandidate.bind(this),this.peerConnection.onaddstream=this.onRemoteStreamAdded.bind(this),this.peerConnection.onremovestream=this.onRemoteStreamRemoved.bind(this),this.peerConnection.oniceconnectionstatechange=this.onIceConnectionStateChanged.bind(this),this.processOffer()},this.addLocalStreamToPC=function(){"VOICE"==CallManager._type?zwrtc.removeVideoTracks():zwrtc.addVideoTracks(),this.peerConnection.addStream(webRTC.localStream)},this.processOffer=function(){if(webRTC.log("processOffer: "+webRTC.localStream),this.lastState="OFFER",CallManager.muteP2PAudioFromStartTillRecording&&webRTC.doMuteTillRecording(),webRTC.localStream||zwrtc.viewOnly){try{webRTC.localVideoStream?this.peerConnection.addStream(webRTC.localVideoStream):webRTC.localStream?(webRTC.log("processOffer: "+webRTC.localStream.id),webRTC.remoteDestination&&webRTC.remoteDestination.stream&&this.peerConnection.removeStream(webRTC.remoteDestination.stream),this.addLocalStreamToPC()):(webRTC.log("processOffer: webRTC.remoteDestination:"+webRTC.remoteDestination),null==webRTC.remoteDestination&&webRTC.createMediaSource(),webRTC.log("processOffer: webRTC.remoteDestination.stream"+webRTC.remoteDestination),this.peerConnection.addStream(webRTC.remoteDestination.stream),webRTC.log("processOffer: webRTC.remoteDestination.stream attached"))}catch(a){webRTC.log("processOffer: "+a)}this.nextState=null;var b=webRTC.sdpConstraintsAV;if(zwrtc._video||(b=webRTC.sdpConstraintsA),"firefox"!=webRTC.webrtcDetectedBrowser)for(prop in b.mandatory)prop.indexOf("Moz")!=-1&&delete b.mandatory[prop];this.peerConnection.createOffer(this.setLocalAndSendMessage.bind(this),this.onCreateSessionDescriptionError,b),webRTC.log('Creating Offer with:\n constraints: "'+JSON.stringify(webRTC.constr)+'".')}else this.nextState="OFFER"},this.doAnswer=function(a){a.sdp=webRTC.removeOpusStereo(a.sdp),this.createPeerConnection(),"firefox"!=webRTC.webrtcDetectedBrowser&&(a.sdp=webRTC.setBandwidth(a.sdp)),this.peerConnection.setRemoteDescription(new RTCSessionDescription(a)),this.peerConnection.onicecandidate=this.onIceCandidate.bind(this),this.peerConnection.onaddstream=this.onRemoteStreamAdded.bind(this),this.peerConnection.onremovestream=this.onRemoteStreamRemoved.bind(this),this.peerConnection.oniceconnectionstatechange=this.onIceConnectionStateChanged.bind(this),this.processAnswer()},this.onIceConnectionStateChanged=function(a){this.peerConnection&&(webRTC.log("P2P:onIceConnectionStateChanged:"+this.peerConnection.iceConnectionState),"disconnected"!=this.peerConnection.iceConnectionState&&"closed"!=this.peerConnection.iceConnectionState||"ANSWER"==this.lastState)},this.onCreateSessionDescriptionError=function(a){webRTC.log("Failed to create session description: "+a.toString())},this.processAnswer=function(){if(webRTC.log("processAnswer: "+webRTC.localStream),webRTC._hangupByPeer=!1,this.lastState="ANSWER",CallManager.muteP2PAudioFromStartTillRecording&&webRTC.doMuteTillRecording(),webRTC.localStream||zwrtc.viewOnly){this.nextState=null,webRTC.localVideoStream?this.peerConnection.addStream(webRTC.localVideoStream):webRTC.localStream&&this.addLocalStreamToPC();var a=webRTC.mediaConstraintsAV;zwrtc._video||(a=webRTC.mediaConstraintsA),this.peerConnection.createAnswer(this.setLocalAndSendMessage.bind(this),this.onCreateSessionDescriptionError,a),webRTC.log('Creating Answer with:\n constraints: "'+JSON.stringify(a)+'".'),this.isP2PEstablished()||ConnectionManager._dispatchEvent("ZWRTC_P2P_ANSWERED",{msg_string:""})}else this.nextState="ANSWER";webRTC.log("processAnswer: "+this.nextState)},this.ObjSize=function(a){var b,c=0;for(b in a)a.hasOwnProperty(b)&&c++;return c},this.onRemoteStreamAdded=function(a){function b(){var a=c.remoteStream.getVideoTracks();0===a.length||void 0==c.remoteVideo||c.remoteVideo.currentTime>0?c.attachStream():setTimeout(function(){b()},250)}if(this.remoteStream&&!this.remoteStream.ended)null==this.rsArr&&(this.rsArr={}),0==this.ObjSize(this.rsArr)&&(this.rsArr[this.remoteStream.id]=this.remoteStream),this.rsArr[a.stream.id]=a.stream,zwrtc._useCustomGUI||this._desktopStreamID==a.stream.id?(rtcSFU._sfuStreams[this.userId]=a.stream,ConnectionManager._dispatchEvent("ZWRTC_ATTACH_RV_STREAM",{stream:a.stream,id:this.subid,userId:this.userId})):this.attachStream();else if(this._desktopStreamID!=a.stream.id){this.remoteStream=a.stream;var c=this;b(),this.attachStream()}try{if(this._desktopStreamID==a.stream.id){ssController._incomingRemoteSSStream=a.stream,CallManager._ssDetected||ConnectionManager._dispatchEvent("ZSCREENSHARE_RECEIVER_START",{stream:a.stream}),CallManager._ssDetected=!0;var d=this;setTimeout(function(){var a=d.remoteVideo.videoWidth,b=d.remoteVideo.videoHeight;a!=CallManager._videoWidth&&b!=CallManager._videoHeight&&(CallManager._videoWidth=a,CallManager._videoHeight=b,ConnectionManager._dispatchEvent("UPDATE_RV"))},1e3)}}catch(e){}webRTC.log("Received remote stream"),this.checkP2PEstablished()},this.onRemoteStreamRemoved=function(a){webRTC.log("Remote stream removed"),this.remoteStream.id==a.stream.id?this.remoteStream=null:null!=this.rsArr&&(delete this.rsArr[a.stream.id],zwrtc._useCustomGUI?(rtcSFU._sfuStreams[this.userId]=this.remoteStream,ConnectionManager._dispatchEvent("ZWRTC_ATTACH_RV_STREAM",{stream:this.remoteStream,id:this.subid,userId:this.userId})):this.attachStream()),this._desktopStreamID==a.stream.id&&this.screenShareStreamRemoved()},this.screenShareStreamRemoved=function(){ConnectionManager._dispatchEvent("ZSCREENSHARE_RECEIVER_STOP"),CallManager._ssDetected=!1,this._desktopStreamID=null,ssController._incomingRemoteSSStream=null},this.onIceCandidate=function(a){if(navigator.mozGetUserMedia&&(webRTC.disableWebrtcTickleIce=!1),a.candidate)if(webRTC.disableWebrtcTickleIce||webRTC.batchCandidates){this.iceCandidateArray||(this.iceCandidateArray={candidates:[]});var b=this.iceCandidateArray.candidates;b&&(b[b.length]={type:"candidate",label:a.candidate.sdpMLineIndex,id:a.candidate.sdpMid,candidate:a.candidate.candidate}),webRTC.batchCandidates&&this.iceCandidateArray&&this.iceCandidateArray.candidates.length>=webRTC.batchCandidateLimit&&(webRTC.sendMessageToID(this.subid,this.iceCandidateArray),this.iceCandidateArray={candidates:[]})}else webRTC.sendMessageToID(this.subid,{type:"candidate",label:a.candidate.sdpMLineIndex,id:a.candidate.sdpMid,candidate:a.candidate.candidate});else webRTC.log("End of candidates."),webRTC.disableWebrtcTickleIce&&this.iceCandidateArray&&webRTC.sendMessageToID(this.subid,this.iceCandidateArray);this.checkP2PEstablished()},this.isP2PEstablished=function(){return this.peerConnection&&webRTC.log("isP2PEstablished:"+this.peerConnection.iceConnectionState+" "+this.peerConnection.iceGatheringState),!(!this.peerConnection||"connected"!=this.peerConnection.iceConnectionState&&"completed"!=this.peerConnection.iceConnectionState)},this.checkP2PEstablished=function(){if("VOICE"==CallManager._type&&(this._muted=!0,ConnectionManager._dispatchEvent("ZWRTC_RV_MUTED",{avatarUrl:null,id:this.subid,userId:this.userId}),webRTC.isVideoMuted||webRTC.toggleVideoMute(),this.resize()),!this._callEstablished&&(this.peerConnection&&webRTC.log("checkP2PEstablished:"+this.peerConnection.iceConnectionState+" "+this.peerConnection.iceGatheringState),CallManager._videoWidth<1&&this.remoteVideo.videoWidth>0&&(CallManager._videoWidth=this.remoteVideo.videoWidth),CallManager._videoHeight<1&&this.remoteVideo.videoHeight>0&&(CallManager._videoHeight=this.remoteVideo.videoHeight),this.peerConnection&&("connected"==this.peerConnection.iceConnectionState||"completed"==this.peerConnection.iceConnectionState))){this._callEstablished=!0,webRTC.log("ICE Process completed and connected, p2p established");try{webRTC.log("Dispatching ZWRTC_REMOTE_STREAM_ATTACHED"),ConnectionManager._dispatchEvent("ZWRTC_REMOTE_STREAM_ATTACHED",{msg_string:"ZWRTC p2p peer media recvd",rv:this.remoteVideo}),ConnectionManager._dispatchEvent("ZWRTC_P2P_ESTABLISHED",{msg_string:"ZWRTC p2p peer media recvd",rv:this.remoteVideo,rstream:this.remoteStream}),CallManager._dispatchEvent(CallManager.Event.CONNECTED,{type:"p2p"}),webRTC.isVideoMuted&&!ssController._desktopStream&&webRTC.sendToAllPeers({type:webRTC.MSG_TYPE_PVD,avatarUrl:DataStore.getUserData("avatarurl")})}catch(a){}}},this.checkSS=function(a){},this.processSignalingMessage=function(a){var b=JSON.parse(a);if(b.candidates){for(var c=0;c<b.candidates.length;c++)if(this.peerConnection&&b.candidates[c]){var d=new RTCIceCandidate({sdpMLineIndex:b.label,candidate:b.candidates[c].candidate});webRTC.log("peerConnection.addIceCandidate"+d),this.peerConnection.addIceCandidate(d)}}else if(b.type||(b=JSON.parse(b)),webRTC.log("processSignalingMessage:"+b.type),b.type==webRTC.MSG_TYPE_OFFER)b.ssStreamID?this._desktopStreamID=b.ssStreamID:this._desktopStreamID&&ssController._incomingRemoteSSStream&&ssController._incomingRemoteSSStream.id==this._desktopStreamID?this.screenShareStreamRemoved():this._desktopStreamID=null,this.doAnswer(b);else if(b.type==webRTC.MSG_TYPE_ANSWER)b.ssStreamID?this._desktopStreamID=b.ssStreamID:this._desktopStreamID&&ssController._incomingRemoteSSStream&&ssController._incomingRemoteSSStream.id==this._desktopStreamID?this.screenShareStreamRemoved():this._desktopStreamID=null,this.peerConnection&&(b.sdp=webRTC.removeOpusStereo(b.sdp),webRTC.log("peerConnection.setRemoteDescription"),"firefox"!=webRTC.webrtcDetectedBrowser&&(b.sdp=webRTC.setBandwidth(b.sdp)),this.peerConnection.setRemoteDescription(new RTCSessionDescription(b)));else if(b.type==webRTC.MSG_TYPE_CANDIDATE){if(this.peerConnection){var d=new RTCIceCandidate({sdpMLineIndex:b.label,candidate:b.candidate});webRTC.log("peerConnection.addIceCandidate"+d),this.peerConnection.addIceCandidate(d)}}else if(b.type==webRTC.MSG_TYPE_PVD)this._muted=!0,ConnectionManager._dispatchEvent("ZWRTC_RV_MUTED",{avatarUrl:b.avatarUrl,id:this.subid,userId:this.userId}),this.loadAvatar(b.avatarUrl),this.resize();else if(b.type==webRTC.MSG_TYPE_PVE)ConnectionManager._dispatchEvent("ZWRTC_RV_UNMUTED",{id:this.subid,userId:this.userId}),this._muted=!1,this.resize();else if(b.type==webRTC.MSG_TYPE_RENEGOTIATE){if("ANSWER"!=this.lastState){var e=webRTC.mediaConstraintsAV;zwrtc._video||(e=webRTC.mediaConstraintsA),b.restartIce?this.renegotiateOffer(e,!0):this.renegotiateOffer(e,!1)}}else b.type==webRTC.MSG_TYPE_INIT_AUDIO_RECORDING&&ConnectionManager._dispatchEvent("PEER_INITIATED_AUDIO_RECORDING")},this.loadAvatar=function(a){if(a&&this.remoteVideo){var b=$("#"+this.remoteVideo.id+"_avatar");b.length>0&&(b[0].src=a)}},this.setLocalAndSendMessage=function(a){if(this.peerConnection)if(a.sdp=webRTC.preferAudioCodec(a.sdp,"ISAC/16000"),"firefox"==webRTC.webrtcDetectedBrowser&&a.type==webRTC.MSG_TYPE_OFFER){webRTC.log("Need to add crypto line");var b=JSON.stringify(a);if(b.indexOf("a=crypto")==-1){webRTC.log("Need to add crypto line:1"),webRTC.log("SDP No crypto line");for(var c="a=crypto:1 AES_CM_128_HMAC_SHA1_80 inline:BAADBAADBAADBAADBAADBAADBAADBAADBAADBAAD\\r\\n",d=b.indexOf("c=IN",0);d!=-1&&d<b.length;){var e=b.length;b=b.substring(0,d)+c+b.substring(d,e),d=b.indexOf("c=IN",d+c.length+1)}}this.peerConnection.setLocalDescription(a),webRTC.log("C->S: "+b),wsServer.send(null,b),webRTC.sendMessageToID(this.subid,b)}else"firefox"!=webRTC.webrtcDetectedBrowser&&(a.sdp=webRTC.setBandwidth(a.sdp),a.sdp=webRTC.setFramerate(a.sdp)),this.peerConnection.setLocalDescription(a),webRTC.log("SDP \n"+a.sdp),this._publishingSS&&(a.ssStreamID=ssController._desktopStream.id),webRTC.sendMessageToID(this.subid,a)}}function webrtcP2PEstablished(){webRTC.log("transitionToActive:P2P Established");try{webRTC.failoverToFlash=!1,"VOICE"==webRTC._callType?(wrtcShowUserAvatar(),webRTC.isVideoMuted||webRTC.toggleVideoMute()):(webRTC.isVideoMuted&&webRTC.toggleVideoMute(),wrtcShowLocalVideo()),webRTC.isVideoMuted&&!ssController._desktopStream&&webRTC.sendMessage({type:webRTC.MSG_TYPE_PVD,avatarUrl:DataStore.getUserData("avatarurl")}),showWRTC()}catch(a){}}function showWRTC(){}function mediaAccessFailed(){}function showAllowGuide(){}function showRememberGuide(){}function hideAllowGuide(){}function continueAsVideo(){$("#webrtc_setting").hide(),$("#wrtc_cam_title").hide();try{initWebRTCSDK()}catch(a){}}function continueAsVoice(){$("#webrtc_setting").hide(),ConnectionManager.createCookie("confirmAV","mic",14),$("#wrtc_cam_title").hide();try{initWebRTCSDK()}catch(a){}}function continueAsViewOnly(){viewOnly=!0,$("#webrtc_setting").hide(),$("#wrtc_cam_title").hide();try{initWebRTCSDK()}catch(a){}}function refreshDeviceList(){wrtcSetting.refreshingDevice=!0,wrtcSetting.usingNoCam||(wrtcSetting.mic_disabled&&micSelectionDisabled(),wrtcSetting.cam_disabled&&camSelectionDisabled(),CallManager._flashEnabled?ConnectionManager._dispatchEvent("FLASH_SETTING_REFRESH_DEVICE_LIST",{msg:""}):wrtcSetting.readDeviceList())}function showSettingContinue(){wrtcSetting.settingState=wrtcSetting.CONTINUE,wrtcSetting.refreshingDevice?showSettingRefresh():($("#cvoice_btn").hide(),$("#cview_btn").hide(),$("#cav_btn").show(),$("#rp_btn").hide())}function showSettingContinueVoice(){if(wrtcSetting.settingState=wrtcSetting.CONTINUE_VOICE,wrtcSetting.refreshingDevice)showSettingRefresh();else{var a=ConnectionManager.readCookie("confirmAV");"mic"==a?($("#cav_btn").show(),$("#cvoice_btn").hide()):($("#cvoice_btn").show(),$("#cav_btn").hide()),$("#cview_btn").hide(),$("#rp_btn").hide()}}function showSettingContinueView(){wrtcSetting.settingState=wrtcSetting.CONTINUE_VIEW,wrtcSetting.refreshingDevice?showSettingRefresh():($("#cvoice_btn").hide(),$("#cview_btn").show(),$("#cav_btn").hide(),$("#rp_btn").hide())}function showSettingRefresh(){$("#cav_btn").hide(),navigator.mozGetUserMedia&&!CallManager._flashEnabled||$("#rp_btn").show(),$("#wrtc_cam_title").show(),$("#cam_pic").hide(),$("#cvoice_btn").hide(),$("#cview_btn").hide(),$("#cav_btn").hide()}function camMicChanged(){log("Selected Camera:"+$("#camCombo option:selected").text()),log("Selected Microphone:"+$("#micCombo option:selected").text()),log("Selected Camera source id:"+$("#camCombo option:selected").val()),log("Selected Microphone source id:"+$("#micCombo option:selected").val()),zwrtc.audioSourceID=$("#micCombo option:selected").val();var a=$("#camCombo option:selected").val();"PHONE"==zwrtc.audioSourceID&&a==zwrtc.videoSourceID||(zwrtc.videoSourceID=a,"PHONE"==zwrtc.audioSourceID&&"NONE"==zwrtc.videoSourceID||wrtcSetting.accessMedia(zwrtc.videoSourceID,zwrtc.audioSourceID),"NONE"==zwrtc.videoSourceID&&wrtcSetting._spkDetectionCheck&&(showFinishBtn(),$("#cav_btn").removeClass("disabled")))}function showFinishBtn(){$("#cavhelp_btn").show(),$("#cav_btn").html("Finish"),$("#cam_act_label").show()}function devicePopulated(a){if(confirmAV=ConnectionManager.readCookie("confirmAV"),"msg"==confirmAV)try{initWebRTCSDK()}catch(b){}else{var c=!1,d=!1;$("#camCombo option").remove(),$("#micCombo option").remove();var e=wrtcSetting.audioSource,f=wrtcSetting.videoSource;a&&(a.audioSource&&(e=a.audioSource),a.videoSource&&(f=a.videoSource));for(var g=0;g<e.length;g++){var h=e[g],i="";(zwrtc.audioSourceID==h.id||h.selected)&&(i="selected"),$("#micCombo").append($("<option "+i+"></option>").attr("value",h.id).text(h.label)),d=!0}if(d?wrtcSetting.usingPhone=!1:(wrtcSetting.usingPhone=!0,$("#listen_btn").addClass("disabled"),ConnectionManager._dispatchEvent("SETTING_PHONE_SELECTED",null)),0==wrtcSetting.phoneList.length){var i="";"PHONE"==zwrtc.audioSourceID&&(i="selected");var j="Telephone";try{Z&&Z.zjs&&Z.zjs.ZLocale&&Z.zjs.ZLocale.getString&&(j=Z.zjs.ZLocale.getString("zjs_telephone","Telephone"))}catch(b){alert(b)}$("#micCombo").append($("<option "+i+"></option>").attr("value","PHONE").text(j)),d=!0}else for(var g=0;g<wrtcSetting.phoneList.length;g++)$("#micCombo").append($("<option></option>").attr("value","PHONE").text(wrtcSetting.phoneList[g])),d=!0;if("mic"==confirmAV||wrtcSetting.cam_disabled)$("#vsComboTd").hide();else{if(!wrtcSetting._micOnly)for(var g=0;g<f.length;g++){var h=f[g],i="";(zwrtc.videoSourceID==h.id||h.selected)&&(i="selected"),$("#camCombo").append($("<option "+i+"></option>").attr("value",h.id).text(h.label)),c=!0}wrtcSetting.noVideo&&($("#camCombo").append($("<option></option>").attr("value","NONE").text(wrtcSetting.noVideo)),c||(wrtcSetting.usingNoCam=!0),c=!0),c?(zwrtc.videoSourceID=$("#camCombo option:selected").val(),$("#vsicon")[0].src=wrtcSetting._assetPath+"/images/wrtc_set_yes.png",$("#camCombo")[0].disabled=!1,$("#camToggleButton").removeClass("disabled")):camSelDisabled("No device detected.","Using headshot")}if(attachMediaToSetting(),d?(zwrtc.audioSourceID=$("#micCombo option:selected").val(),wrtcSetting.isMicDisabled()||wrtcSetting.usingPhone?$("#listen_btn").addClass("disabled"):$("#listen_btn").removeClass("disabled"),$("#asicon")[0].src=wrtcSetting._assetPath+"/images/wrtc_set_yes.png",$("#micCombo")[0].disabled=!1,wrtcSetting.mediaDenied?($("#micToggleButton").addClass("disabled"),showSettingContinueView()):$("#micToggleButton").removeClass("disabled"),"mic"==confirmAV||!c||wrtcSetting.cam_disabled?showSettingContinueVoice():showSettingContinue()):(micDisabled("No device detected.","Please connect using a Phone or SIP client"),showSettingContinueView()),wrtcSetting.callZInit){wrtcSetting.callZInit=!1,showSettingRefresh(),wrtcSetting.refreshingDevice=!0;try{initWebRTCSDK()}catch(b){}}else CallManager._flashEnabled?($("#settingLocalVideo").show(),$("#webrtc_warn_txt").hide(),$("#allow_pic").hide(),$("#zcdiv").removeClass("floating_client_allow"),$("#webrtc_setting").show(),wrtcSetting.setTpLayout(!1),$("#wrtc_cam_title").show(),$("#webRTCControls").hide(),wrtcSetting.tpDialog?$("#sp_flash_container").addClass("fp_setting_lv_tp"):($("#zcdiv").addClass("floating_client_tech_check"),$("#sp_flash_container").addClass("webrtc_video_resol_rv_mark"),$("#sp_flash_container").addClass("webrtc_video_resol_rv"),$("#sp_flash_container").addClass("rtcsettinglv"),$("#sp_flash_container").addClass("fp_setting_lv"))):($("#settingLocalVideo").show(),$("#webrtc_warn_txt").hide(),$("#allow_pic").hide(),$("#allow_pic").removeClass("ainit"),$("#zcdiv").removeClass("floating_client_allow"),wrtcSetting.tpDialog||$("#zcdiv").addClass("floating_client_tech_check"),$("#webrtc_setting").show(),wrtcSetting.setTpLayout(!1),$("#wrtc_cam_title").show())}wrtcSetting.tpDialog?($("#camToggleButton").show(),$("#micToggleButton").show()):($("#camToggleButton").hide(),$("#micToggleButton").hide(),showSettingContinue())}function micSelectionDisabled(){wrtcSetting.mediaDenied||(wrtcSetting.mic_disabled?(wrtcSetting.mic_disabled=!1,wrtcSetting.cam_disabled=!1,micEnabled(),camEnabled(),wrtcSetting.deviceListPopulated=!1):(wrtcSetting.mic_disabled=!0,wrtcSetting.cam_disabled=!0,micDisabled(),camSelDisabled(),showSettingContinueView(),$("#rp_btn").addClass("disabled")))}function micEnabled(){$("#asourcetd1")[0].innerHTML="Audio Source",$("#asourcetd2")[0].innerHTML="<select style='width:100%;' id='micCombo'></select>",$("#micToggleButton").removeClass("disabled"),$("#listen_btn").removeClass("disabled"),$("#micToggleButtonIcon")[0].src=wrtcSetting._assetPath+"/images/wrtc_set_mic_en.png",$("#rp_btn").removeClass("disabled"),wrtcSetting.muteMicrophone(!1),$("#micCombo").change(camMicChanged)}function micDisabled(a,b){a?$("#asourcetd1")[0].innerHTML=a:$("#asourcetd1")[0].innerHTML="Disabled",b?$("#asourcetd2")[0].innerHTML=b:$("#asourcetd2")[0].innerHTML="You may only view",$("#micCombo").hide(),$("#micToggleButton").addClass("disabled"),$("#listen_btn").addClass("disabled"),$("#asicon")[0].src=wrtcSetting._assetPath+"/images/wrtc_set_cross.png",$("#micToggleButtonIcon")[0].src=wrtcSetting._assetPath+"/images/wrtc_set_mic_dis.png",wrtcSetting.muteMicrophone(!0)}function displayCamComboTitle(a){a&&($("#vsourcetd1")[0].innerHTML="<b>"+a+"</b>")}function displayMicComboTitle(a){a&&($("#asourcetd1")[0].innerHTML="<b>"+a+"</b>")}function camEnabled(){$("#vsourcetd1")[0]&&($("#vsourcetd1")[0].innerHTML="Video Source"),$("#vsourcetd2")[0]&&($("#vsourcetd2")[0].innerHTML="<select style='width:100%;' id='camCombo'></select>"),$("#camToggleButton").removeClass("disabled"),$("#camToggleButtonIcon")[0]&&($("#camToggleButtonIcon")[0].src=wrtcSetting._assetPath+"/images/wrtc_set_cam.png"),wrtcSetting.muteCamera(!1),devicePopulated(),attachMediaToSetting(),$("#camCombo").change(camMicChanged)}function camSelDisabled(a,b){a?$("#vsourcetd1")[0].innerHTML=a:$("#vsourcetd1")[0].innerHTML="Disabled",b?$("#vsourcetd2")[0].innerHTML=b:$("#vsourcetd2")[0].innerHTML="Using headshot",$("#camCombo").hide(),$("#camToggleButton").addClass("disabled"),$("#vsicon")[0].src=wrtcSetting._assetPath+"/images/wrtc_set_cross.png",$("#camToggleButtonIcon")[0].src=wrtcSetting._assetPath+"/images/wrtc_set_cam_dis.png",wrtcSetting.muteCamera(!0),attachMediaToSetting()}function retryCamAccess(){wrtcSetting.accessMedia(zwrtc.videoSourceID,"PHONE")}function retryMicAccess(){wrtcSetting._micOnly=!0,wrtcSetting.accessMedia("NONE",zwrtc.audioSourceID)}function camSelectionDisabled(){wrtcSetting.mediaDenied||(wrtcSetting.cam_disabled?wrtcSetting.mic_disabled||(wrtcSetting.cam_disabled=!1,camEnabled(),wrtcSetting.deviceListPopulated=!1):(wrtcSetting.cam_disabled=!0,camSelDisabled(),zwrtc.audioSourceID=$("#micCombo option:selected").val(),wrtcSetting.mic_disabled?showSettingContinueView():showSettingContinueVoice()))}function updateCSS(){var a=!1;wrtcSetting.hideRTCCheckSym(),wrtcSetting._showListenBtn?$("#listen_btn").show():$("#listen_btn").hide(),wrtcSetting.tpDialog?($("#vsicontd").hide(),$("#asicontd").hide(),displayCamComboTitle(wrtcSetting.stringVideo),displayMicComboTitle(wrtcSetting.stringAudio),wrtcSetting.usingNoCam?($("#camToggleButtonIcon")[0].src="/communicator/custom/tp/img/viewer_webcam.png",$("#camToggleButton").addClass("notAvailable")):($("#camToggleButton").removeClass("notAvailable"),webRTC.isVideoMuted?$("#camToggleButtonIcon")[0].src="/communicator/custom/tp/img/viewer_webcam_mute.png":$("#camToggleButtonIcon")[0].src="/communicator/custom/tp/img/viewer_webcam.png"),wrtcSetting.usingPhone?($("#micToggleButtonIcon")[0].src="/communicator/custom/tp/img/viewer_speak.png",$("#micToggleButton").addClass("notAvailable")):($("#micToggleButton").removeClass("notAvailable"),webRTC.isAudioMuted?$("#micToggleButtonIcon")[0].src="/communicator/custom/tp/img/viewer_speak_mute.png":$("#micToggleButtonIcon")[0].src="/communicator/custom/tp/img/viewer_speak.png")):(displayCamComboTitle(wrtcSetting.stringCamera),displayMicComboTitle(wrtcSetting.stringMic),$("#vsicontd").show(),$("#asicontd").show()),webRTC.isVideoMuted||wrtcSetting.usingNoCam||wrtcSetting._pendingAccessMedia?(wrtcSetting.usingNoCam?(wrtcSetting.displayLVMsg(!0,wrtcSetting.stringNVSS),$("#cav_btn").removeClass("disabled")):wrtcSetting._pendingAccessMedia?(wrtcSetting.noWorkingCam(),showFinishBtn(),$("#cav_btn").addClass("disabled")):(wrtcSetting.displayLVMsg(!0,wrtcSetting.stringVSD),$("#cav_btn").removeClass("disabled")),$("#camToggleButton").addClass("tech_check_disabled"),$("#rp_btn").addClass("notAvailable"),$("#vsicon")[0].src=wrtcSetting._assetPath+"/images/wrtc_set_cross.png",ConnectionManager._dispatchEvent("SETTING_WEBCAM_DISABLED",null)):($("#cav_btn").removeClass("disabled"),$("#camToggleButton").removeClass("tech_check_disabled"),$("#rp_btn").removeClass("notAvailable"),wrtcSetting.displayLVMsg(!1),$("#vsicon")[0].src=wrtcSetting._assetPath+"/images/wrtc_set_yes.png",ConnectionManager._dispatchEvent("SETTING_WEBCAM_ENABLED",null)),webRTC.isAudioMuted||wrtcSetting.usingPhone||wrtcSetting._pendingAccessMedia?($("#listen_btn").addClass("disabled"),$("#listen_btn").addClass("notAvailable"),$("#micToggleButton").addClass("tech_check_disabled"),$("#asicon")[0].src=wrtcSetting._assetPath+"/images/wrtc_set_cross.png"):($("#listen_btn").removeClass("disabled"),$("#listen_btn").removeClass("notAvailable"),$("#micToggleButton").removeClass("tech_check_disabled"),$("#asicon")[0].src=wrtcSetting._assetPath+"/images/wrtc_set_yes.png"),wrtcSetting.tpDialog?($(".rtcsettinglv").addClass("rtcsettinglv_tp"),$(".rtcsetting_general_res").addClass("rtcsetting_general_res_tp"),$(".rtcsetting_general_res").removeClass("rtcsetting_general_res"),$(".rtcsettingtb_res").addClass("rtcsettingtb_res_tp"),$(".rtcsettingtb_res").removeClass("rtcsettingtb_res"),a=!0,$("#camToggleButton").show(),$("#micToggleButton").show()):($("#camToggleButton").hide(),$("#micToggleButton").hide(),showSettingContinue()),a&&$(".rtcsettinglv").removeClass("rtcsettinglv")}function showLocalAvatar(){$("#settingLocalAvatar")[0].src=top.DataStore.getUserData("avatarurl"),$("#settingLocalAvatar")[0].style.opacity=1,CallManager._flashEnabled?$("#sp_flash_container").css("opacity",0):setTimeout(function(){$("#settingLocalVideo")[0].style.opacity=0},500)}function attachMediaToSetting(){wrtcSetting.localStream&&attachMediaStream($("#settingLocalVideo")[0],wrtcSetting.localStream),wrtcSetting.cam_disabled||wrtcSetting.usingNoCam?showLocalAvatar():CallManager._flashEnabled?$("#sp_flash_container").css("opacity",1):wrtcSetting.localStream&&(navigator.mozGetUserMedia||wrtcSetting.localStream.getVideoTracks().length>0)?($("#settingLocalVideo")[0].style.opacity=1,setTimeout(function(){$("#settingLocalAvatar")[0].style.opacity=0},500)):showLocalAvatar()}function cancelCapture(){$("#webrtc_setting").show(),$("#webrtc_camcapture").hide(),CallManager._flashEnabled?($("#sp_flash_container").addClass("flash_tp_Setting"),$("#sp_flash_container").removeClass("flash_cam_cap_lv")):wrtcSetting.camcaptureLV.pause(),
tryAgainCapture(),ConnectionManager._dispatchEvent("webcam_upload_done",null),navigator.mozGetUserMedia&&reattachMediaStream($("#camcaptureLV")[0],$("#settingLocalVideo")[0])}function imageCaptured(){CallManager._flashEnabled?$("#camcap_prev_box").hide():$("#camcap_prev_box").show(),$("#camcaptureLV").hide(),$("#capture_cancel_btn").hide(),$("#webcam_capture_btn").hide(),$("#capture_tryagain_btn").show(),$("#capture_save_btn").show(),$("#capture_save_btn").css("display","inline")}function tryAgainCapture(){$("#capture_tryagain_btn").hasClass("disabled")||(CallManager._flashEnabled?ConnectionManager._dispatchEvent("FLASH_SETTING_CAPTURE_AGAIN",{msg:""}):$("#camcaptureLV").show(),$("#camcap_prev_box").hide(),$("#capture_cancel_btn").show(),$("#webcam_capture_btn").show(),$("#capture_tryagain_btn").hide(),$("#capture_save_btn").hide())}function camMicAllowed(a){ConnectionManager._dispatchEvent("CAM_MIC_ALLOWED",{value:a}),flashClient._initSwfRecvd&&flashClient._initAllowDenyRcvd&&flashClient.accessGranted(a)}function onInvoke(a,b){flashClient.onInvoke(a,b)}function onRVInvoke(a,b){flashClient.onRVInvoke(a,b)}function callEnded(a){flashClient.callEnded(a)}function ORTCMedia(){this.iceGatherer=null,this.iceTransport=null,this.dtlsTransport=null,this.audioSender=null,this.videoSender=null,this.desktopSender=null,this.receivers=null,this.ortcStatsTimer=null,this.audioSendParams=null,this.videoSendParams=null,this.desktopSendParams=null,this.logEnabled=!0,this.initiateConnection=function(a,b){this.iceOptions=a,this.call_id=b,this.localCapabilities={ice:{},candidates:[],receiveAudioCaps:null,sendAudioCaps:null,receiveVideoCaps:null,sendVideoCaps:null},this.iceGatherer=new RTCIceGatherer(this.iceOptions),this.iceGatherer.onlocalcandidate=this.onIceCandidate.bind(this),this.iceGatherer.onerror=this.onIceGatheringError.bind(this),this.iceTransport=new RTCIceTransport,this.iceTransport.onicestatechange=this.onIceStateChanged.bind(this),this.iceTransport.oncandidatepairchange=this.onCandidatePairChanged.bind(this),this.dtlsTransport=new RTCDtlsTransport(this.iceTransport),this.dtlsTransport.ondtlsstatechange=this.onDtlsStatechange.bind(this),this.dtlsTransport.onerror=this.onDtlsError.bind(this),this.localCapabilities.ice=this.iceGatherer.getLocalParameters(),this.localCapabilities.dtls=this.dtlsTransport.getLocalParameters(),this.localCapabilities.receiveAudioCaps=RTCRtpReceiver.getCapabilities("audio"),this.localCapabilities.receiveVideoCaps=RTCRtpReceiver.getCapabilities("video"),this.localCapabilities.sendAudioCaps=RTCRtpSender.getCapabilities("audio"),this.localCapabilities.sendVideoCaps=RTCRtpSender.getCapabilities("video"),this.createSenders(webRTC.localStream,ssController.desktopStream)},this.onIceCandidate=function(a){Object.keys(a.candidate).length>0?(this.log("onIceCandidate:"+a.candidate),this.localCapabilities.candidates.push(a.candidate)):(this.log("End of local ICE candidates"),this.sendPlaceCall())},this.getIceState=function(){var a="new";return this.iceTransport&&(a=this.iceTransport.state),a},this.onIceStateChanged=function(a){this.log("onIceStateChanged: ICE state changed to |"+a.state+"|"+this.getIceState()),"connected"===a.state||"completed"===a.state?this.dispatchShadowConnected():ConnectionManager._dispatchEvent("ORTC_ICE_STATE_CHANGED")},this.onCandidatePairChanged=function(a){this.log("onCandidatePairChanged: ICE candidate pair changed to:"+a.pair)},this.onIceGatheringError=function(a){this.log("onIceGatheringError: ICE transport failed "+a)},this.onDtlsStatechange=function(a){this.log("onDtlsStatechange: DTLS state changed to |"+a.state+"|")},this.onDtlsError=function(a){this.log("onDtlsError: DTLS transport failed "+a),this.closeConnection(),ConnectionManager._dispatchEvent("ORTC_DTLS_ERROR")},this.sendPlaceCall=function(){var a=new Zebra("PLACE_CALL");a.setZEvent("call_id",this.call_id),a.setZEvent("to","sip:rtcshadow_size_640_360@localhost"),a.setZEvent("from","SHADOW_SFU_"+rtcSFU.getUserName()+"@localhost"),CallManager.httpLegID&&a.setZEvent("http_leg_id",CallManager.httpLegID),ConnectionManager.webRTCBrowser&&a.setZEvent("browser",ConnectionManager.webRTCBrowser),null!=ConnectionManager.webRTCBrowserVersion&&a.setZEvent("browser_ver",ConnectionManager.webRTCBrowserVersion),a.setZEvent("capabilities",JSON.stringify(this.localCapabilities)),a.setZebraAttribute("userId",rtcSFU.getUserName()),this.log("PLACE_CALL zebra:\n"+a.toXML()),ConnectionManager.sendZSCommand("sendMessageToMCU","&event=PLACE_CALL&call_id="+this.call_id+"&command=zebra&contents="+encodeURIComponent(a.toXML()))},this.parseZebra=function(a,b){var c=a.getZEvent(b).value;if(c){var d=JSON.parse(c);if(d)return this.log("Zebra parsed field "+b+" : "+c),d;this.log("Could not parse Zebra field "+b+" : "+c)}else this.log("Zebra field "+b+" not present.");return null},this.generateStreamMapping=function(a){var b=[];try{var c=a.getZEvent("item_fields").value,d=a.getZEvent("item_keys").value;if(d){var e=d.split(",");if(c)for(var f=c.split(","),g=0;g<e.length;g++){for(var h=e[g],i={},j=0;j<f.length;j++){var k=f[j];try{i[k]=a.getZEvent(k+"_"+h).value,i.index=h}catch(l){this.log(l)}}var m=i.msid;rtcSFU.mssrcStreams[m]&&(i.stream=rtcSFU.mssrcStreams[m].stream),rtcSFU.mssrcStreams[m]=i,i.index&&(b.push(i.index),rtcSFU.mssrcVidReference[i.index]=i,"BandNormal"!=CallManager.lowBrMode&&0===parseInt(i.index)&&i.stream&&(this.log("LOW_BR: lowbr mode :"+CallManager.lowBrMode+" reassign sfu 0 media stream"),rtcSFU.attachLowBRStream(i.stream)))}}}catch(l){this.log(l)}var n=!1;try{n="true"===a.getZEvent("micOn").value}catch(o){}if(CallManager.initialMicUnmuted=n,rtcSFU.mssrcVidReference)for(var p in rtcSFU.mssrcVidReference)p&&b.indexOf(p)==-1&&delete rtcSFU.mssrcVidReference[p];b=null},this.handleMediaResponse=function(a){if(a&&this.iceTransport&&this.dtlsTransport){if(this.generateStreamMapping(a),this.remoteCapabilities=this.parseZebra(a,"capabilities"),this.remoteSenders=this.parseZebra(a,"senders"),!this.remoteCapabilities||!this.remoteSenders)return void this.log("Invalid remoteCapabilities || remoteSenders");if(this.remoteCapabilities.ice&&this.remoteCapabilities.candidates){var b="controlled";this.remoteCapabilities.ice.iceLite&&(b="controlling"),this.log("Starting "+b+" ICE "+JSON.stringify(this.remoteCapabilities.candidates)),this.iceTransport.setRemoteCandidates(this.remoteCapabilities.candidates),this.iceTransport.start(this.iceGatherer,this.remoteCapabilities.ice,b)}this.remoteCapabilities.dtls&&(this.log("Starting DTLS: "+JSON.stringify(this.remoteCapabilities.dtls)),this.dtlsTransport.start(this.remoteCapabilities.dtls)),this.log("remoteSenders: "+JSON.stringify(this.remoteSenders)),null==rtcSFU.ssrcMsidMap&&(rtcSFU.ssrcMsidMap={});var c=null;if(this.localStream){var d=this.localStream.getVideoTracks();d.length>0&&"ended"!==d[0].readyState&&(c=d[0])}for(var e=0;e<this.remoteSenders.length;e++){var f={renderStream:null,audio:null,audioSsrc:null,video:null,videoSsrc:null,msid:null,dummySender:null};if(this.receivers||(this.receivers=[]),this.receivers[e]=f,f.renderStream=new MediaStream,f.msid=this.remoteSenders[e].msid,null==rtcSFU.ssrcMsidMap&&(rtcSFU.ssrcMsidMap={}),this.remoteSenders[e].audio){var g=new RTCRtpReceiver(this.dtlsTransport,"audio");g.label="Remote Audio "+(e+1),f.audio=g,f.audioSsrc=this.remoteSenders[e].audio.encodings[0].ssrc,rtcSFU.ssrcMsidMap[f.audioSsrc]=f.msid,g.receive(this.remoteSenders[e].audio),f.renderStream.addTrack(g.track),this.log("Started audio receiver "+e+" "+this.remoteSenders[e].audio+" "+g+" audioSsrc="+f.audioSsrc)}if(this.remoteSenders[e].video){var h=new RTCRtpReceiver(this.dtlsTransport,"video");if(h.label="Remote Video "+(e+1),f.video=h,f.videoSsrc=this.remoteSenders[e].video.encodings[0].ssrc,rtcSFU.ssrcMsidMap[f.videoSsrc]=f.msid,h.receive(this.remoteSenders[e].video),f.renderStream.addTrack(h.track),this.log("Started video receiver "+e+" "+this.remoteSenders[e].video+" "+h+" videoSsrc="+f.videoSsrc),c&&"ended"!==c.readyState){var i=ORTCUtils.getRTCRtpParameters(this.localCapabilities.sendVideoCaps,this.remoteCapabilities.receiveVideoCaps,this.remoteSenders[e].video);i.encodings=[{ssrc:0,active:!1}],this.log("Creating dummy video sender: "+JSON.stringify(i)),f.dummySender=new RTCRtpSender(d[0],this.dtlsTransport),f.dummySender.send(i)}}this.handleRemoteStreamAdded(f.renderStream,f.msid)}var j=null,k=0,l=null,m=null,a=new Zebra("MEDIA_ANSWER");a.setZEvent("call_id",this.call_id);var n=[];if(webRTC.localStream&&(j=k.toString(),a.setZEvent("msid_"+j,this.getStreamLabel(webRTC.localStream)),a.setZEvent("type_"+j,"RV_C_HIGH"),k++,l={msid:this.getStreamLabel(webRTC.localStream),audio:null,video:null},n.push(l)),ssController.desktopStream){var o=k.toString();a.setZEvent("msid_"+o,this.getStreamLabel(ssController.desktopStream)),a.setZEvent("type_"+o,"Screen"),k++,j?j+=","+o:j=o,m={msid:this.getStreamLabel(ssController.desktopStream),audio:null,video:null},n.push(m)}this.audioSender&&(this.audioSendParams?(this.log("Local audioSendParams: "+JSON.stringify(this.audioSendParams)),l.audio=this.audioSendParams):(this.audioSendParams=ORTCUtils.getRTCRtpParameters(this.localCapabilities.sendAudioCaps,this.remoteCapabilities.receiveAudioCaps,this.remoteSenders[0].audio),this.audioSendParams&&(this.log("Local audioSendParams: "+JSON.stringify(this.audioSendParams)),this.audioSender.send(this.audioSendParams),l.audio=this.audioSendParams))),this.videoSender&&(this.videoSendParams?(this.log("Local videoSendParams: "+JSON.stringify(this.videoSendParams)),l.video=this.videoSendParams):(this.videoSendParams=ORTCUtils.getRTCRtpParameters(this.localCapabilities.sendVideoCaps,this.remoteCapabilities.receiveVideoCaps,this.remoteSenders[0].video),this.videoSendParams&&(this.log("Local videoSendParams: "+JSON.stringify(this.videoSendParams)),this.videoSender.send(this.videoSendParams),l.video=this.videoSendParams))),this.desktopSender?this.desktopSendParams?(this.log("Local desktopSendParams: "+JSON.stringify(this.desktopSendParams)),m.video=this.desktopSendParams):(this.desktopSendParams=ORTCUtils.getRTCRtpParameters(this.localCapabilities.sendVideoCaps,this.remoteCapabilities.receiveVideoCaps,this.remoteSenders[0].video),this.desktopSendParams&&(this.log("Local desktopSendParams: "+JSON.stringify(this.desktopSendParams)),this.desktopSender.send(this.desktopSendParams),m.video=this.desktopSendParams)):this.desktopSendParams&&this.desktopSendParams.encodings&&(m.video={encodings:this.desktopSendParams.encodings}),a.setZEvent("senders",JSON.stringify(n)),a.setZEvent("item_fields","type,msid"),a.setZEvent("item_keys",j),ConnectionManager.webRTCBrowser&&a.setZEvent("browser",ConnectionManager.webRTCBrowser),null!=ConnectionManager.webRTCBrowserVersion&&a.setZEvent("browser_ver",ConnectionManager.webRTCBrowserVersion),a.setZebraAttribute("userId",rtcSFU.getUserName()),ConnectionManager.sendZSCommand("sendMessageToMCU","&command=zebra&contents="+encodeURIComponent(a.toXML())),this.log("sendMediaAnswer:MEDIA_ANSWER sent \n "+a.toXML())}},this.handleRemoteStreamAdded=function(a,b){var c=rtcSFU.mssrcStreams[b];c?(this.log("found stream id="+b),c.stream=a,this.log("onRemoteStreamAdded:stream added"),"BandNormal"!=CallManager.lowBrMode&&0===parseInt(c.index)&&(this.log("LOW_BR: lowbr mode detected :"+CallManager.lowBrMode+" reassign sfu 0 media stream"),rtcSFU.attachLowBRStream(c.stream)),c.vid&&c.type&&("Screen"==c.type?(ssController.incomingRemoteSSStream&&ssController.incomingRemoteSSStream!=a&&ConnectionManager._dispatchEvent("ZSCREENSHARE_RECEIVER_STOP",{userId:ssController.userId}),this.log("this.onRemoteStreamAdded:dispatching ZSCREENSHARE_RECEIVER_START:"+c.type),ssController.incomingRemoteSSStream=a,ssController.userId=c.vid,ConnectionManager._dispatchEvent("ZSCREENSHARE_RECEIVER_START",{userId:ssController.userId,extraChannels:!0})):rtcSFU.sfuVidReference[c.vid]&&rtcSFU.sfuVidReference[c.vid].handleRemoteStream(a,c.type))):rtcSFU.mssrcStreams[b]={stream:a},this.checkIfAllStreamsPresent()},this.dispatchShadowConnected=function(){var a=new Zebra("SHADOW_CONNECT");a.setZEvent("shadow_from","SHADOW_SFU_"+rtcSFU.getUserName()),ConnectionManager._dispatchEvent("ZEBRA:SHADOW_CONNECT",a)},this.isAudioStream=function(a){return a&&a.getAudioTracks()&&a.getAudioTracks().length>0},this.checkIfAllStreamsPresent=function(){var a=!1,b={},c={slot_map:[]};if(rtcSFU.remoteAudioStream){var d=rtcSFU.remoteAudioStream;this.isAudioStream(d)&&(a=!0,b[d.id]=d,c.slot_map[e]=d)}else if(rtcSFU.mssrcVidReference)for(var e in rtcSFU.mssrcVidReference)if(e&&rtcSFU.mssrcVidReference[e]){var d=rtcSFU.mssrcVidReference[e].stream;if(null==d){a=!1;break}this.isAudioStream(d)&&(a=!0,b[d.id]=d,c.slot_map[e]=d)}a&&(ConnectionManager._dispatchEvent("MEDIA_STREAMS_UPDATED",b),ConnectionManager._dispatchEvent("RECORD_STREAMS_SLOT",c))},this.createSenders=function(a,b){if(this.localStream!==a&&(this.localStream=a,this.localStream)){if(this.receivers)for(var c=0;c<this.receivers.length;c++){var d=this.receivers[c];d.dummySender&&d.dummySender.stop(),d.dummySender=null}var e=this.localStream.getAudioTracks(),f=this.localStream.getVideoTracks();this.stopSender(this.audioSender),this.stopSender(this.videoSender),this.audioSender=null,this.videoSender=null,e.length>0&&"ended"!==e[0].readyState&&(this.log("Creating new audio sender"),this.audioSender=new RTCRtpSender(e[0],this.dtlsTransport),this.audioSendParams=null),f.length>0&&"ended"!==f[0].readyState&&(this.log("Creating new video sender"),this.videoSender=new RTCRtpSender(f[0],this.dtlsTransport),this.videoSendParams=null)}if(this.desktopStream!==b&&(this.stopSender(this.desktopSender),this.desktopSender=null,this.desktopStream=b,b)){var f=this.desktopStream.getVideoTracks();f.length>0&&"ended"!==f[0].readyState&&(this.log("Creating new desktop sender"),this.desktopSender=new RTCRtpSender(f[0],this.dtlsTransport),this.desktopSendParams=null)}},this.stopSender=function(a){if(a){this.log("Stopping sender");try{this.sender.stop()}catch(b){}}},this.removeDesktopStream=function(){this.stopSender(this.desktopSender),this.desktopSender=null,this.generateRenegZebra()},this.addDesktopStream=function(){ssController.desktopStream&&(this.log("a:addDesktopStream: "+ssController.desktopStream.id),this.createSenders(this.localStream,ssController.desktopStream),this.generateRenegZebra())},this.updateStream=function(a,b){return this.log("updateStream: "+this.localStream+" "+a),a&&this.remoteCapabilities&&this.remoteSenders?(this.createSenders(a,ssController.desktopStream),void this.generateRenegZebra()):void this.log("updateStream: one of highStream || remoteCapabilities || remoteSenders is null")},this.getStreamLabel=function(a){return a?a.id:null},this.generateRenegZebra=function(){var a=new Zebra("MEDIA_RENEGOTIATE");a.setZEvent("call_id",this.call_id),a.setZebraAttribute("userId",rtcSFU.getUserName());var b=null,c=0,d=null,e=null,f=[];if(webRTC.localStream&&(b=c.toString(),a.setZEvent("msid_"+b,this.getStreamLabel(webRTC.localStream)),a.setZEvent("type_"+b,"RV_C_HIGH"),c++,d={msid:this.getStreamLabel(webRTC.localStream),audio:null,video:null},f.push(d)),ssController.desktopStream){var g=c.toString();a.setZEvent("msid_"+g,this.getStreamLabel(ssController.desktopStream)),a.setZEvent("type_"+g,"Screen"),c++,b?b+=","+g:b=g,e={msid:this.getStreamLabel(ssController.desktopStream),audio:null,video:null},f.push(e)}this.audioSender&&(this.audioSendParams?(this.log("Local audioSendParams: "+JSON.stringify(this.audioSendParams)),d&&(d.audio=this.audioSendParams)):(this.audioSendParams=ORTCUtils.getRTCRtpParameters(this.localCapabilities.sendAudioCaps,this.remoteCapabilities.receiveAudioCaps,this.remoteSenders[0].audio),this.audioSendParams&&(this.log("Local audioSendParams: "+JSON.stringify(this.audioSendParams)),this.audioSender.send(this.audioSendParams),d&&(d.audio=this.audioSendParams)))),this.videoSender&&(this.videoSendParams?(this.log("Local videoSendParams: "+JSON.stringify(this.videoSendParams)),d&&(d.video=this.videoSendParams)):(this.videoSendParams=ORTCUtils.getRTCRtpParameters(this.localCapabilities.sendVideoCaps,this.remoteCapabilities.receiveVideoCaps,this.remoteSenders[0].video),this.videoSendParams&&(this.log("Local videoSendParams: "+JSON.stringify(this.videoSendParams)),this.videoSender.send(this.videoSendParams),d&&(d.video=this.videoSendParams)))),this.desktopSender?this.desktopSendParams?(this.log("Local desktopSendParams: "+JSON.stringify(this.desktopSendParams)),e.video=this.desktopSendParams):(this.desktopSendParams=ORTCUtils.getRTCRtpParameters(this.localCapabilities.sendVideoCaps,this.remoteCapabilities.receiveVideoCaps,this.remoteSenders[0].video),this.desktopSendParams&&(this.log("Local desktopSendParams: "+JSON.stringify(this.desktopSendParams)),this.desktopSender.send(this.desktopSendParams),e.video=this.desktopSendParams)):this.desktopSendParams&&this.desktopSendParams.encodings&&(e.video={encodings:this.desktopSendParams.encodings}),a.setZEvent("item_fields","type,msid"),a.setZEvent("item_keys",b),a.setZEvent("senders",JSON.stringify(f)),ConnectionManager.sendZSCommand("sendMessageToMCU","&command=zebra&contents="+encodeURIComponent(a.toXML()))},this.startStatsGathering=function(){var a=this;this.ortcStatsTimer=setInterval(function(){a.getStats()},1e3)},this.getStats=function(){if(this.receivers){for(var a=this,b=0;b<this.receivers.length;b++){var c=this.receivers[b];c.audio&&c.audio.getStats().then(function(b){for(var c in b)b.hasOwnProperty(c)&&a.handleOrtcInStats(b[c],!0)})["catch"](function(a){}),c.video&&c.video.getStats().then(function(b){for(var c in b)b.hasOwnProperty(c)&&a.handleOrtcInStats(b[c],!1)})["catch"](function(a){})}rtcSFU.rvCompositeHigh&&rtcSFU.rvCompositeHigh.processInBoundStats()}},this.handleOrtcInStats=function(a,b){if(a&&!a.isRemote){var c=rtcSFU.fixStatsType(a);if("inbound-rtp"===c){var d=a.ssrc;if(d&&rtcSFU.ssrcMsidMap&&rtcSFU.ssrcMsidMap[d]){var e=rtcSFU.ssrcMsidMap[d];if(e&&rtcSFU.mssrcStreams[e]){var f=rtcSFU.mssrcStreams[e],g=parseInt(f.index);b?(4===g&&rtcSFU.handleInboundStats("inAudioTrack4",a),f.audioSsrcId=d):(f.videoSSRC=d,4!==g&&rtcSFU.handleInboundStats("inVideoTrack"+g,a))}}}}},this.unregister=function(){this.iceGatherer&&(this.iceGatherer.onlocalcandidate=null,this.iceGatherer.onerror=null),this.iceTransport&&(this.iceTransport.onicestatechange=null,this.iceTransport.oncandidatepairchange=null),this.dtlsTransport&&(this.dtlsTransport.ondtlsstatechange=null,this.dtlsTransport.onerror=null)},this.closeConnection=function(){if(this.log("closeConnection"),this.ortcStatsTimer&&clearInterval(this.ortcStatsTimer),this.stopSender(this.audioSender),this.stopSender(this.videoSender),this.stopSender(this.desktopSender),this.audioSender=null,this.videoSender=null,this.desktopSender=null,this.receivers)for(var a=0;a<this.receivers.length;a++){var b=this.receivers[a];b.audio&&b.audio.stop(),b.video&&b.video.stop(),b.dummySender&&b.dummySender.stop(),this.receivers[a]=null}this.receivers=[],this.unregister(),this.iceTransport&&(this.iceTransport.stop(),this.iceTransport=null),this.dtlsTransport&&(this.dtlsTransport.stop(),this.dtlsTransport=null),this.remoteCapabilities=null,this.localCapabilities=null},this.log=function(a){(this.logEnabled||Platform.debugLogEnabled)&&Platform.log("ORTCMedia:"+a)}}function rtcMedia(){this._sfuType=null,this._mainMediaConnection=!1,this.localStream=null,this.remoteStream=null,this._ws=null,this._objID=null,this.peerConnection=null,this._lv=null,this._rv=null,this._destination=null,this._username=null,this._userId=null,this.sfu_media="audio",this._host=null,this._disableWS=!1,this._viewOnly=!1,this._video=!0,this._videoOnly=!1,this._renegotiate=!1,this._iceRestart=!1,this._screen=!1,this.state=null,this.bandwidth={audio:80,video:800},this.sdpConstraints={offerToReceiveAudio:!0,offerToReceiveVideo:!0},this.stunTurn=null,this.pcConfig={iceServers:[]},this._iceStateCompleted=!1,this._enableLocalCandidates=!1,this._posX=-1,this._posY=-1,this._posWidth=-1,this._posHeight=-1,this._videoWidth=-1,this._videoHeight=-1,this.CONST_STRING_HIGH="HIGH",this.CONST_STRING_LOW="LOW",this.CONST_STRING_TECH_CHECK="TECH_CHECK",this.CONST_STRING_SCREEN="SCREEN",this.CONST_STRING_SCREEN_LOW="SCREEN_LOW",this._debug=!1,this.debugInfoTimer=null,this.pingTimer=null,this.plps=0,this.prps=0,this.recvdBitrate=0,this._useProxy=!1,this._muted=!1,this._camStateUpdated=!1,this._audioMuted=!1,this.audioCheckPending=!1,this.outVideoCheckPending=!1,this.outAudioCheckPending=!1,this.checkForMedia=!1,this._defaultAvatar="assets/images/avatar.gif",this._connImg="/header/img/webrtc/connecting.gif",this._pendingAttachStream=!1,this._startStatsDebugTimeout=1e4,this.lastMCUVideoPacketCount=0,this.lastMCUVideoPacketChangeTime=0,this.allowCall=!0,this.evtListnerString=null,this._pcNECounter=0,this._pceMaxTime=5,this._mediaStarted=!1,this.addAudioTrack=!1,this.screenShareMedia=!1,this._sdpSent=!1,this._useBase64Enc=!1,this.micWorking=!1,this.offerContainAudioNack=!1,this.renegTimeout=1e4,this.useNumericKeys=!0,this._mainRV=null,this.logEnabled=!0,this.sendBrTh=0,this.replaceTrackSupported=!1,this.initSDK=function(a,b,c,d,e){this._lv=a,d?this._screen=!0:this._screen=!1,this._sfuType=e,null==this._sfuType||this._sfuType==this.CONST_STRING_HIGH||this._sfuType==this.CONST_STRING_LOW||this._sfuType==this.CONST_STRING_TECH_CHECK?this._mainMediaConnection=!0:this._mainMediaConnection=!1,this._rv=b,c&&(this.stunTurn=c),null==this.evtListnerString&&(this.evtListnerString="RTC_MEDIA_"+(new Date).getTime()),"undefined"!=typeof ConnectionManager&&(this._disableWS=!0,ConnectionManager.addListener("ZEBRA:ZWRTC_ZS_ON_OPEN",this.evtListnerString,this.zsOnOpen.bind(this),!0),ConnectionManager.addListener("ZEBRA:ZWRTC_ZS_ON_MESSAGE",this.evtListnerString,this.zsOnMessage.bind(this),!0),ConnectionManager.addListener("ZEBRA:ZWRTC_ZS_ON_CLOSE",this.evtListnerString,this.zsOnClose.bind(this),!0),ConnectionManager.addListener("ZEBRA:SHADOW_CONNECT",this.evtListnerString,this.shadowConnectRecvd.bind(this),!0),ConnectionManager.addListener("ZEBRA:PLACE_CALL_RESPONSE",this.evtListnerString,this.answerSDPRecvd.bind(this),!0),ConnectionManager.addListener("ZEBRA:MEDIA_OFFER",this.evtListnerString,this.offerSDPRecvd.bind(this),!0),ConnectionManager.addListener("ZEBRA:com.blackboard.saturn.zag.zebra.VideoConference#ClientToMCUConnect:response",this.evtListnerString,this.connectResponse.bind(this)),ConnectionManager.addListener("ZEBRA:MEDIA_RENEGOTIATE",this.evtListnerString,this.mediaRenegotiateRecvd.bind(this),!0),ConnectionManager.addListener("ZSCREENSHARE_RECEIVER_STOP",this.evtListnerString,this.stoppedReceivingSS.bind(this),!0),ConnectionManager.addListener("ORTC_ICE_STATE_CHANGED",this.evtListnerString,this.ortcIceStateChanged.bind(this),!0),ConnectionManager.addListener("ORTC_DTLS_ERROR",this.evtListnerString,this.ortcDtlsError.bind(this),!0)),this.generateStun(this.stunTurn)},this.uninit=function(){this.log("this.uninit:"+this.evtListnerString),"undefined"!=typeof ConnectionManager&&(ConnectionManager.removeListener("ZEBRA:ZWRTC_ZS_ON_OPEN",this.evtListnerString,this.zsOnOpen),ConnectionManager.removeListener("ZEBRA:ZWRTC_ZS_ON_MESSAGE",this.evtListnerString,this.zsOnMessage),ConnectionManager.removeListener("ZEBRA:ZWRTC_ZS_ON_CLOSE",this.evtListnerString,this.zsOnClose),ConnectionManager.removeListener("ZEBRA:SHADOW_CONNECT",this.evtListnerString,this.shadowConnectRecvd),ConnectionManager.removeListener("ZEBRA:PLACE_CALL_RESPONSE",this.evtListnerString,this.answerSDPRecvd.bind(this),!0),ConnectionManager.removeListener("ZEBRA:MEDIA_OFFER",this.evtListnerString,this.offerSDPRecvd.bind(this),!0),ConnectionManager.removeListener("ZEBRA:MEDIA_RENEGOTIATE",this.evtListnerString,this.mediaRenegotiateRecvd.bind(this),!0),ConnectionManager.removeListener("ZEBRA:com.blackboard.saturn.zag.zebra.VideoConference#ClientToMCUConnect:response",this.evtListnerString,this.connectResponse.bind(this)),ConnectionManager.removeListener("ZSCREENSHARE_RECEIVER_STOP",this.evtListnerString,this.stoppedReceivingSS.bind(this)),ConnectionManager.removeListener("ORTC_ICE_STATE_CHANGED",this.evtListnerString,this.ortcIceStateChanged.bind(this)),ConnectionManager.removeListener("ORTC_DTLS_ERROR",this.evtListnerString,this.ortcDtlsError.bind(this)))},this.showConnecting=function(){if(this.log("rtcSFU:this.showConnecting"),!zwrtc._useCustomGUI&&this._rv&&zwrtc.callEstablished){var a=$("#"+this._rv.id+"_conn"),b=$("#"+this._rv.id+"_conn_img");b.length>0&&(b[0].src=this._connImg),a.show()}},this.hideConnecting=function(){if(this.log("rtcSFU:this.hideConnecting"),!zwrtc._useCustomGUI&&this._rv){var a=$("#"+this._rv.id+"_conn"),b=$("#"+this._rv.id+"_conn_img");a.hide(),b.length>0&&(b[0].src="")}},this.getDummyStream=function(){return window.AudioContext=window.AudioContext,this.audioContext||(this.audioContext=new AudioContext),this.mediaSource&&(this.mediaSource.disconnect(),this.mediaSource=null),this.remoteDestination&&(this.remoteDestination.disconnect(),this.remoteDestination=null),this.remoteDestination=this.audioContext.createMediaStreamDestination(),this.mediaSource=this.audioContext.createBufferSource(),this.mediaSource.connect(this.remoteDestination),this.remoteDestination.stream},this.getZEvent=function(a,b,c){try{return a.getZEvent(b).value}catch(d){}return c},this.updateCamState=function(a,b,c){if("off"==a){if(b||!this._muted&&this._userId&&this._userId!=ConnectionManager.userId&&!this.screenShareMedia){var d={avatarUrl:"",id:this._objID,userId:this._userId};c&&(d.reason=c),ConnectionManager._dispatchEvent("ZWRTC_RV_MUTED",d)}this._muted=!0}else{if(b||(!this._camStateUpdated||this._muted)&&this._userId&&this._userId!=ConnectionManager.userId&&!this.screenShareMedia){var e=rtcSFU.mssrcVidReference[this._sfuType];if(e&&e.camMuted)return this.log("Not getting media from MCU, ignoring unmuting request"),void ConnectionManager._dispatchEvent("ZWRTC_RV_MUTED",{userId:this._userId,reason:"bandwidth"});ConnectionManager._dispatchEvent("ZWRTC_RV_UNMUTED",{id:this._objID,userId:this._userId}),this._camStateUpdated=!0}this._muted=!1}},this.updateCamMicState=function(a,b,c){this.updateCamState(a,c),"off"==b?this._audioMuted=!0:(this._audioMuted=!1,this.audioCheckPending&&(this.checkForMedia=!0,this.checkForMediaTS=DateTimeUtil.getNow()))},this.deviceToggled=function(){this.outVideoCheckPending&&!TechCheck.isVideoMuted?(this.outVideoCheckPending=!1,this.checkForMedia=!0,this.checkForMediaTS=DateTimeUtil.getNow()):this.outAudioCheckPending&&!TechCheck.isAudioMuted&&this.micWorking&&(this.outAudioCheckPending=!1,this.checkForMedia=!0,this.checkForMediaTS=DateTimeUtil.getNow()),this.checkForMediaTS=DateTimeUtil.getNow()},this.shadowConnected=function(a){var b=this.getZEvent(a,"shadow_from",null),c="SHADOW_SFU_"+rtcSFU.getUserName();this._username!=b&&c!=b||(this.shadowZebra=a,this.callEstablished())},this.dispatchConnected=function(){zwrtc._callConnected=!0,zwrtc.callEstablished=!0;var a="RTC_MAIN";this._sfuType==this.CONST_STRING_SCREEN||this._sfuType==this.CONST_STRING_SCREEN_LOW?a="RTC_SS":this.startDebugInfo(),CallManager._dispatchEvent(CallManager.Event.CONNECTED,{type:"mcu",sfu_type:this._sfuType,conn_type:a}),ConnectionManager._dispatchEvent("ZWRTC_CALL_ESTABLISHED",{msg_string:"",sfu_type:this._sfuType,conn_type:a})},this.callEstablished=function(){this.stopPlaceCallResponseTimeout();var a=this.peerConnection,b=this.getIceState();if(this.log("callEstablished: iceConnectionState = "+b),"connected"===b||"completed"===b){if(this._callEstablished||(this._callEstablished=!0,this._mainMediaConnection?(this.dispatchConnected(),this.ortcMedia&&this.ortcMedia.startStatsGathering()):("SCREEN"==this._sfuType&&(CallManager.screenCallEstablished(),CallManager._dispatchEvent(CallManager.Event.CONNECTED,{type:"mcu",sfu_type:this._sfuType,conn_type:"RTC_SS"})),ConnectionManager._dispatchEvent("ZWRTC_CALL_ESTABLISHED_"+this._sfuType,{msg_string:""}),this.setRV(this._posX,this._posY,this._posWidth,this._posHeight,this._videoWidth,this._videoHeight,this._mainRV))),!this.checkIfAllStreamsPresent()&&a){var c=a.getRemoteStreams();if(c)for(var d=0;d<=c.length;d++){var e=c[d],f=e.label?e.label:e.id;this.handleRemoteStreamAdded(e,f)}}}else this.log("ice connection not established, need to redial call: iceConnectionState = "+b)},this.startPlaceCallResponseTimeout=function(){this.stopPlaceCallResponseTimeout();var a=this;this.pcrTimeout=setInterval(function(){var b=a.peerConnection;!b||"connected"!=b.iceConnectionState&&"completed"!=b.iceConnectionState?a.hangupWithError(AVSDKErrors.ICE_NOT_CONNECTED):a.hangupWithError(AVSDKErrors.NO_SHADOW_TIMEOUT)},3e4)},this.stopPlaceCallResponseTimeout=function(){this.pcrTimeout&&clearInterval(this.pcrTimeout)},this.startPing=function(){var a=this;this.pingTimer&&clearInterval(this.pingTimer),this.pingTimer=setInterval(function(){a.sendMessage("PING")},18e5)},this.checkMcuVideoOnSlot=function(a){var b="inVideoTrack"+a,c=0;if(rtcSFU.connDebug&&rtcSFU.connDebug[b]){var d=DateTimeUtil.getNow(),e=rtcSFU.mssrcVidReference[a];if(c=rtcSFU.connDebug[b].packetsReceived,ssController.incomingRemoteSSStream&&ssController.incomingRemoteSSStream.id===e.msid)return;if(e&&"on"===e.camEnabled){var f=rtcSFU.connDebug[b].lastInBoundPackets;if(null!=f)if(rtcSFU.testNoInVideo!==a&&"all"!==rtcSFU.testNoInVideo||(c=f),c-f>0)rtcSFU.connDebug[b].lastNoInBoundPacketTS=0,(e.camMuted||e.noVideoDetected)&&(this.log("Starts receiving video from MCU, showing video again"),e.camMuted=!1,e.noVideoDetected=!1,rtcSFU.rvSFUArray[a]&&rtcSFU.rvSFUArray[a].updateCamState("on"));else if(!e.camMuted)if(null==rtcSFU.connDebug[b].lastNoInBoundPacketTS||0==rtcSFU.connDebug[b].lastNoInBoundPacketTS)rtcSFU.connDebug[b].lastNoInBoundPacketTS=d;else{var g=d-rtcSFU.connDebug[b].lastNoInBoundPacketTS,h="No Video Incoming packets on SFU slot "+a+":"+f+" "+g+"ms";if(g>rtcSFU.noVideoAvatarTh){h+="\nNo incoming packet for "+rtcSFU.noVideoAvatarTh+"ms, displaying avatar",e.camMuted=!0;var i=rtcSFU.rvSFUArray[a];i&&(h+="\n userId = "+i._userId+" "+e.noVidUserId,this.log(h),e.noVidUserId=i._userId,i.updateCamState("off",!1,"bandwidth"))}else if(g>=rtcSFU.noVideoTh){if(!e.noVideoDetected){e.noVideoDetected=!0;var i=rtcSFU.rvSFUArray[a];i&&(this.log("No incoming packet for "+rtcSFU.noVideoTh+"ms, dispatching ZWRTC_RV_NOVIDEO: userId = "+i._userId+" "+e.noVidUserId),e.noVidUserId=i._userId,ConnectionManager._dispatchEvent("ZWRTC_RV_NOVIDEO",{userId:i._userId}))}}else this.log(h)}}rtcSFU.connDebug[b].lastInBoundPackets=c}return c},this.checkMcuAudioOnSlot=function(a){var b="inAudioTrack"+a,c=0;if(rtcSFU.connDebug&&rtcSFU.connDebug[b]){DateTimeUtil.getNow(),rtcSFU.mssrcVidReference[a];c=rtcSFU.connDebug[b].packetsReceived,rtcSFU.connDebug[b].lastInBoundPackets=c}return c},this.processInBoundStats=function(){var a=DateTimeUtil.getNow(),b=0;if(rtcSFU.checkMcuVideo)for(var c=0;c<6;c++)b+=4===c?this.checkMcuAudioOnSlot(c):this.checkMcuVideoOnSlot(c);if(rtcSFU.connDebug&&(rtcSFU.connDebug.totalPacketsReceived=b,"SCREEN"!=this._sfuType&&rtcSFU.remotePeerSpeaking)){var d=rtcSFU.connDebug.lastInBoundPackets;if(null!=d&&d>0&&rtcSFU._queueSize>1)if(b-d>0)rtcSFU.connDebug.lastNoInBoundPacketTS=0;else if(null==rtcSFU.connDebug.lastNoInBoundPacketTS||0==rtcSFU.connDebug.lastNoInBoundPacketTS)rtcSFU.connDebug.lastNoInBoundPacketTS=a;else{var e=a-rtcSFU.connDebug.lastNoInBoundPacketTS;this.log("No Incoming packets:"+d+" "+e+"ms"),e>1e4&&(this.log("No incoming packet for 10sec, redialling call"),this.hangupWithError(AVSDKErrors.NO_PACKET_IN))}rtcSFU.connDebug.lastInBoundPackets=b}},this.startDebugInfo=function(){if(rtcStats.startRtcStatsTimer(),!this.debugInfoTimer){var a=this;this.debugInfoTimer=setInterval(function(){a.processInBoundStats()},1e3)}},this.shadowConnectRecvd=function(a){this.isCallAllowed()&&this.shadowConnected(a)},this.renegotiateCall=function(){var a=this.peerConnection;!a||"connected"!=a.iceConnectionState&&"completed"!=a.iceConnectionState||(this._renegotiate=!0,
this.processOffer())},this.placeCall=function(a,b,c,d,e){if(this._renegotiate=!1,this._iceRestart=!1,d&&(this._video=!1),this._pendingAttachStream=!0,a&&(this._username=a),b&&(this._host=b),c&&(this._destination=c),ConnectionManager.isEdge())return this._objID=CallManager.generateCallID(),this.ortcMedia=new ORTCMedia,void this.ortcMedia.initiateConnection(this.pcConfig,this._objID);var f=this.peerConnection;if(f&&e)if("connected"==f.iceConnectionState||"completed"==f.iceConnectionState)this.removeStream(this.peerConnection,this.localStream),this.localStream=e,this.renegotiateCall();else{this.hangup(!1,"rtcMedia:placeCall: hangup old call"),this.localStream=e,this._renegotiate=!1;var g=this;setTimeout(function(){g.connect()},500)}else e&&(this.localStream=e),(this.localStream||this._viewOnly||zwrtc.viewOnly)&&this.connect()},this.doOffer=function(){this.createPeerConnection(),rtcSFU._useMcuOffer&&this._sfuType!=this.CONST_STRING_SCREEN&&this._sfuType!=this.CONST_STRING_SCREEN_LOW?this.generatePlaceCallZebra(null):this.processOffer()},this.doAnswer=function(){this.processAnswer()},this.setFramerate=function(a){var b={minptime:10,maxptime:10};return b=b||{},a=a.replace("a=fmtp:111 minptime=10","a=fmtp:111 minptime="+(b.minptime||10)),a=a.replace("a=maxptime:60","a=maxptime:"+(b.maxptime||60)),a=a.replace("a=maxptime:255","a=maxptime:"+(b.minptime||10))},this.updateSDP=function(a){if(ConnectionManager.isFF())return a;var b=this.bandwidth;b=b||{},a=a.replace(/b=AS([^\r\n]+\r\n)/g,"");var c=a.indexOf("m=video");if(c!=-1&&CallManager.limitRTCBwd){var d=a.indexOf("\r\nc=",c);if(d==-1&&(d=a.indexOf("\r\nb=",c)),d!=-1){var e=a.substr(0,d+2),f=a.substr(d+2);a=e+"b=AS:"+(b.video||2048)+"\r\n"+f}}return a.indexOf("x-google-max-bitrate")==-1&&(a=a.replace(/a=rtpmap:100 VP8\/90000\r\n/g,"a=rtpmap:100 VP8/90000\r\na=fmtp:100 x-google-max-bitrate="+(b.video||2048)+"; x-google-max-quantization=40\r\n")),this._sfuType!=this.CONST_STRING_SCREEN&&this._sfuType!=this.CONST_STRING_SCREEN_LOW||(a=a.replace("a=sendrecv","a=sendonly")),this.setFramerate(a)},this.updateDesktopStream=function(a){var b=this.peerConnection;if(!b||"connected"!=b.iceConnectionState&&"completed"!=b.iceConnectionState)this._destination?(this.hangup(!1,"updateDesktopStream"),this.localStream=a,this._renegotiate=!1,this.connect()):this.localStream=a;else{var c=null;b.getSenders&&(c=b.getSenders()),c&&c.length>0&&"function"==typeof c[0].replaceTrack&&(this.replaceTrackSupported=!0),this.replaceTrackSupported?b.getSenders().map(function(b){b.replaceTrack(a.getTracks().find(function(a){return a.kind===b.track.kind}),a)}):(this.removeStream(this.peerConnection,this.localStream),this.localStream=a,this.renegotiateCall())}ssController.desktopStream&&a&&ssController.desktopStream!=a&&rtcSFU.stopStreamTracks(ssController.desktopStream),this.localStream=ssController.desktopStream=a,CallManager.screenCallEstablished()},this.removeStream=function(a,b){if(a&&b){var c=b.getTracks(),d=a.getSenders();d&&d.forEach(function(b){c.indexOf(b.track)!==-1&&a.removeTrack(b)})}},this.compareStreams=function(a,b){if(null===a||null===b)return!1;var c=a.getAudioTracks()[0],d=a.getVideoTracks()[0],e=b.getAudioTracks()[0],f=b.getVideoTracks()[0];return c===e&&d===f},this.updateStream=function(a,b){this.log("updateStream:"+this.localStream+" "+a);var c=this.peerConnection;if(this.ortcMedia)return void this.ortcMedia.updateStream(a,b);if(!c||"connected"!=c.iceConnectionState&&"completed"!=c.iceConnectionState)this._destination?(this.hangup(!1,"updateStream"),this.localStream=a,this._renegotiate=!1,this.allowCall=!0,this.connect()):this.localStream=a;else{if(this.compareStreams(this.localStream,a))return void ConnectionManager._dispatchEvent("ZWRTC_REMOTE_STREAM_ATTACHED");var d=null;if(c.getSenders&&(d=c.getSenders()),d&&d.length>0&&"function"==typeof d[0].replaceTrack){this.replaceTrackSupported=!0;const e=a.getVideoTracks()[0],f=a.getAudioTracks()[0];var g=!1;if(f&&"ended"!==f.readyState){var h=d.find(function(a){return a.track&&a.track.kind==f.kind});h?h.replaceTrack(f):(c.addTrack(f,a),g=!0)}if(e&&"ended"!==e.readyState){var i=d.find(function(a){return a.track&&a.track.kind==e.kind});i?i.replaceTrack(e):(c.addTrack(e,a),g=!0)}return this.localStream=a,void(g?this.generateRenegotiationZebra(!1):ConnectionManager._dispatchEvent("ZWRTC_REMOTE_STREAM_ATTACHED"))}this.removeStream(this.peerConnection,this.localStream),this.localStream=a,b&&rtcSFU.setLowResolStream(b),rtcSFU._useMcuOffer?(this.initConnection(),this.generateRenegotiationZebra(!1)):this.renegotiateCall()}},this.renegotiateOffer=function(a,b){if(this.log("this.renegotiateOffer:restartIce:"+b),this._iceRestart=b,a&&a.optional)for(var c=0;c<a.optional.length;c++)for(key in a.optional[c])"IceRestart"==key&&(a.optional[c].IceRestart=b,b=!1);if(b&&a&&a.optional&&a.optional.push({IceRestart:!0}),this._renegotiate=!0,this._iceRestart){this._iceStateCompleted=!1,this._sdpSent=!1,this._localIP=null,this._answered=!1;var d="RTC_MAIN";this._sfuType!=this.CONST_STRING_SCREEN&&this._sfuType!=this.CONST_STRING_SCREEN_LOW||(d="RTC_SS"),CallManager._dispatchEvent(CallManager.Event.CONNECTING,{type:"mcu",conn_type:d})}this.enableSimulcast(),this.peerConnection.createOffer(this.setLocalAndSendMessage.bind(this),this.onCreateSessionDescriptionError.bind(this),a),this.log('Creating Offer with:\n constraints: "'+JSON.stringify(a)+'".')},this.addMediaStream=function(a){if(null!=a&&this.peerConnection){var b=this;if(ConnectionManager.isChrome()&&b._sfuType===b.CONST_STRING_SCREEN&&ssController.appshareConfig.simulcast.enabled){var c="detail",d={streams:[a],sendEncodings:[]};return a.getAudioTracks().forEach(function(a){"ended"!==a.readyState&&(c="motion","contentHint"in a&&ConnectionManager.isChrome()&&(a.contentHint=c),a.contentHint!==c&&b.log("Invalid audio track contentHint: '"+c+"'"),b.peerConnection.addTransceiver(a,d))}),void a.getVideoTracks().forEach(function(d){"ended"!==d.readyState&&("contentHint"in d&&(d.contentHint=c),d.contentHint!==c&&b.log("Invalid video track contentHint: '"+c+"'"),b.peerConnection.addTransceiver(d,{direction:"sendonly",streams:[a],sendEncodings:ssController.appshareConfig.simulcast.encodings}))})}ConnectionManager.isSafari()?a.getTracks().forEach(function(c){"ended"!==c.readyState&&b.peerConnection.addTrack(c,a)}):(a.getTracks().forEach(function(b){"ended"===b.readyState&&a.removeTrack(b)}),this.peerConnection.addStream(a))}},this.placeSSCall=function(){ssController.desktopStream&&this.isMediaConnected()&&(this._publishingSS=!0,ssController.desktopStream&&this.addMediaStream(ssController.desktopStream),rtcSFU._useMcuOffer?this.generateRenegotiationZebra(!1):(this._answered=!1,this.renegotiateOffer(this.sdpConstraints,!1)),CallManager.screenCallEstablished())},this.endSSCall=function(){ssController.desktopStream&&this.isMediaConnected()&&(this._publishingSS=!1,this.removeStream(this.peerConnection,ssController.desktopStream),rtcSFU._useMcuOffer?this.generateRenegotiationZebra(!1):(this._answered=!1,this.renegotiateOffer(this.sdpConstraints,!1)),CallManager.screenCallTerminated())},this.replaceAudioTrack=function(){this.log("replaceAudioTrack");var a=this.peerConnection;if(a&&ConnectionManager.isFF()&&webRTC.localAudioStream){var b=a.getSenders();if(b)for(i=b.length-1;i>=0;i--)try{var c=b[i];"audio"===c.track.kind&&(this.log("Removing track in FF:"+i+" "+c),a.removeTrack(c))}catch(d){this.log("Unable to remove track in FF:"+i+" "+b[i])}var e=webRTC.localAudioStream.getAudioTracks();if(e)for(i=0;i<e.length;i++)a.addTrack(e[i],webRTC.localAudioStream),this.log("Audio track added to peerconnection:"+e[i].id)}},this.isScreenConnection=function(){return this._sfuType===this.CONST_STRING_SCREEN},this.initConnection=function(){this.localStream?(this.addMediaStream(this.localStream),rtcSFU._useSimulcast&&this._sfuType!=this.CONST_STRING_SCREEN&&this._sfuType!=this.CONST_STRING_SCREEN_LOW&&rtcSFU.getLowResolStream()&&this.addMediaStream(rtcSFU.getLowResolStream()),this.replaceAudioTrack()):this.addAudioTrack&&(this._viewOnly||zwrtc.viewOnly)&&this.addMediaStream(this.getDummyStream()),this.isScreenConnection()?(this.sdpConstraints.offerToReceiveVideo=!1,this.sdpConstraints.offerToReceiveAudio=!1):(this.sdpConstraints.offerToReceiveVideo=!0,this.sdpConstraints.offerToReceiveAudio=!0)},this.enableSimulcast=function(){if(ConnectionManager.isFF()&&this._sfuType===this.CONST_STRING_SCREEN&&ssController.appshareConfig.simulcast.enabled){var a=this.peerConnection.getSenders().find(function(a){return"video"===a.track.kind});if(a){var b=a.getParameters();b||(b={}),b.encodings=ssController.appshareConfig.simulcast.encodings,a.setParameters(b)}}},this.processOffer=function(){this.log("processOffer"),this.initConnection(),this._answered=!1,this.enableSimulcast(),this.peerConnection.createOffer(this.sdpConstraints).then(this.setLocalAndSendMessage.bind(this))["catch"](this.onCreateSessionDescriptionError.bind(this)),this.log('Creating Offer with:\n constraints: "'+JSON.stringify(this.sdpConstraints)+'".')},this.processAnswer=function(){this._renegotiate||this.initConnection(),this.peerConnection.createAnswer(this.sdpConstraints).then(this.setLocalAndSendMessage.bind(this))["catch"](this.onCreateSessionDescriptionError.bind(this)),this.log('Creating Answer with:\n constraints: "'+JSON.stringify(this.sdpConstraints)+'".')},this.onCreateSessionDescriptionError=function(a){this.log("Failed to create session description: "+a.toString()),this.hangupWithError(AVSDKErrors.SDP_CREATE_ERROR)},this.setLocalAndSendMessage=function(a){this.peerConnection&&(a.sdp=this.updateSDP(a.sdp),a.sdp=SDPUtils2.updateLocalSDP(a.sdp),this.peerConnection.setLocalDescription(a),this._localOffer=a,this.log("SDP _renegotiate="+this._renegotiate+" this._iceRestart="+this._iceRestart),this.debugLog(a.sdp),this._localIP&&(this._sdpSent=!1,this.sendSDP()))},this.stoppedReceivingSS=function(a){this.screenShareMedia=!1},this.gettingScreenShareMedia=function(){this.screenShareMedia||rtcSFU._useMcuOffer||(this.screenShareMedia=!0,this.sfu_media="audiovideo",this.remoteStream&&(this.log("this.gettingScreenShareMedia: dispatching ZSCREENSHARE_RECEIVER_START"),ssController.incomingRemoteSSStream=this.remoteStream,ConnectionManager._dispatchEvent("ZSCREENSHARE_RECEIVER_START",{userId:this._userId,extraChannels:!0})))},this.onRemoteStreamRemoved=function(a){this.log("onRemoteStreamRemoved:"+a.stream.id),rtcSFU._useMcuOffer&&delete rtcSFU.mssrcStreams[a.stream.id]},this.onRemoteStreamTrack=function(a){a&&a.streams&&a.streams.length>0&&this.onRemoteStreamAdded({stream:a.streams[0]})},this.onRemoteStreamAdded=function(a){if(a.stream){var b=a.stream.getVideoTracks().length;if(b>1)for(i=0;i<b;i++){var c=a.stream.clone(),d=null,e=c.getVideoTracks();for(j=0;j<e.length;j++)j!=i?c.removeTrack(e[j]):d=e[j].label?e[j].label:e[j].id;try{c.removeTrack(c.getAudioTracks()[0])}catch(f){}this.handleRemoteStreamAdded(c,d),rtcSFU.remoteAudioStream=a.stream}else this.handleRemoteStreamAdded(a.stream,a.stream.id)}},this.handleRemoteStreamAdded=function(a,b){if(rtcSFU._useMcuOffer){var c=rtcSFU.mssrcStreams[b];c?(this.log("found stream id="+b),c.stream=a,this.log("onRemoteStreamAdded:stream added"),"BandNormal"!=CallManager.lowBrMode&&0===parseInt(c.index)&&(this.log("LOW_BR: lowbr mode detected :"+CallManager.lowBrMode+" reassign sfu 0 media stream"),rtcSFU.attachLowBRStream(c.stream)),c.vid&&c.type&&("Screen"==c.type?(ssController.incomingRemoteSSStream&&ssController.incomingRemoteSSStream!=a&&ConnectionManager._dispatchEvent("ZSCREENSHARE_RECEIVER_STOP",{userId:ssController.userId}),this.log("this.onRemoteStreamAdded:dispatching ZSCREENSHARE_RECEIVER_START:"+c.type),ssController.incomingRemoteSSStream=a,ssController.userId=c.vid,ConnectionManager._dispatchEvent("ZSCREENSHARE_RECEIVER_START",{userId:ssController.userId,extraChannels:!0})):rtcSFU.sfuVidReference[c.vid]&&rtcSFU.sfuVidReference[c.vid].handleRemoteStream(a,c.type))):rtcSFU.mssrcStreams[b]={stream:a}}else this.handleRemoteStream(a,this.sfu_media);this.checkIfAllStreamsPresent()},this.updateMediaType=function(a){this.log("RV_STREAM: updateMediaType:old:"+this.sfu_media+" new:"+a),this.sfu_media!=a&&("audio"!=a||"audiovideo"!=this.sfu_media&&"video"!=this.sfu_media||this.dispatchRemoveEvent(),this.sfu_media=a,this._remoteStreamAttached=!1,this.dispatchAttachEvent())},this.handleRemoteStream=function(a,b){if(this.log("handleRemoteStream:"+a.id+" type:"+b+" userId:"+this._userId),this.screenShareMedia)this.log("handleRemoteStream:this.screenShareMedia:"+this._userId),this.remoteStream=ssController.incomingRemoteSSStream=a,ConnectionManager._dispatchEvent("ZSCREENSHARE_RECEIVER_START",{userId:this._userId,extraChannels:!0});else{if(rtcSFU._useMcuOffer&&zwrtc._useCustomGUI&&this.remoteStream&&this.remoteStream.id==a.id)return;b&&"audio"!=b.toLowerCase()&&(b="audiovideo"),this.remoteStream=a,this._remoteStreamAttached=!1,this.updateMediaType(b),this.dispatchRemoteStreamAttached()}},this.dispatchRemoteStreamAttached=function(){var a=this._renegotiate;if(this._renegotiate=!1,this._mainMediaConnection?(ConnectionManager._dispatchEvent("ZWRTC_REMOTE_STREAM_ATTACHED",{msg:""}),a&&this.dispatchConnected(),(this._viewOnly||zwrtc.viewOnly)&&this.callEstablished()):(ConnectionManager._dispatchEvent("REMOTE_STREAM_ATTACHED_"+this._sfuType,{msg:""}),this.callEstablished(),"SCREEN"==this._sfuType&&CallManager.screenCallEstablished()),zwrtc._useCustomGUI){if(this.screenShareMedia||"SCREEN"==this._sfuType)return;this._mainMediaConnection?rtcSFU._sfuRestricted&&this.dispatchAttachEvent():this._userId!=ConnectionManager.userId&&this.dispatchAttachEvent()}},this.dispatchAttachEvent=function(){if(this._userId&&this._userId!=ConnectionManager.userId&&!this._remoteStreamAttached&&this.remoteStream){this._remoteStreamAttached=!0,rtcSFU._sfuStreams[this._userId]=this.remoteStream;var a=new Object;a.stream=this.remoteStream,a.id=this._objID,a.userId=this._userId,a.mode=this.sfu_media,this.position&&(a.position=this.position),a.max=rtcSFU.SFU_MAX_VIDEO_LEN,ConnectionManager._dispatchEvent("ZWRTC_ATTACH_RV_STREAM",a)}},this.dispatchRemoveEvent=function(){this._remoteStreamAttached=!1,rtcSFU._sfuStreams[this._userId]&&delete rtcSFU._sfuStreams[this._userId],ConnectionManager._dispatchEvent("ZWRTC_REMOVE_RV_STREAM",{id:this._objID,userId:this._userId})},this.onIceCandidate=function(a){if(this._renegotiate&&!this._iceRestart)return void this.log("onIceCandidate: Ignoring as it is renegotiation");if(a.candidate){if(this._iceStateCompleted)return;if(this._localOffer){if(this._localOffer.candidates||(this._localOffer.candidates=[]),!this._enableLocalCandidates&&rtcSFU.useIceCandTo&&!this._localOffer.timeOut){var b=this;this._localOffer.timeOut=setTimeout(function(){b._iceStateCompleted||(b.log("Delay in ice candidate gathering, sending SDP to MCU"),b._iceStateCompleted=!0,b._localIP="127.0.0.1",b.sendSDP()),b._localOffer.timeOut=null},rtcSFU.iceGatheringTO)}this._localOffer.candidates.push(a.candidate.candidate),this._enableLocalCandidates&&(this._iceStateCompleted=!0)}this._localOffer.candidates&&this.log("candidates.length = "+this._localOffer.candidates.length+" iceStateCompleted = "+this._iceStateCompleted),this._iceStateCompleted&&(this._localIP="127.0.0.1",this.sendSDP())}else this.log("End of candidates."),this._iceStateCompleted||(this._iceStateCompleted=!0,this._localIP="127.0.0.1",this.sendSDP())},this.sendSDPZebra=function(){if(this._localOffer){var a=this._localOffer.candidates,b=null;if(a&&a.length)for(var c=0;c<a.length;c++){var d=a[c];0==d.indexOf("a=")||(d="a="+d),d.indexOf("\r\n",d.length-"\r\n".length)==-1&&(d+="\r\n"),null==b?b=d:b+=d}var e=this._localOffer.sdp;if(b){var f=e.indexOf("a=ice-ufrag:"),g=e.lastIndexOf("a=ice-ufrag:"),h=e.substring(0,f),i=e.substring(f,g),j=e.substring(g);e=f===g?h+b+j:h+b+i+b+j}var k="unknown";null!=ConnectionManager.webRTCBrowser&&(k=ConnectionManager.webRTCBrowser.toLowerCase()),e=e.replace(/0\.0\.0\.0/g,"127.0.0.1"),e=e.replace(/s=-\r\n/g,"s=Blackboard - "+k+"\r\n"),e=e.replace(/o=- /g,"o=blackboard "),rtcSFU._useMcuOffer&&this._sfuType!=this.CONST_STRING_SCREEN&&this._sfuType!=this.CONST_STRING_SCREEN_LOW?this.generateAnswerZebra(e):this.generatePlaceCallZebra(e)}},this.generateRenegotiationZebra=function(a){if(this._renegotiate=!0,this._iceRestart=a,this._iceRestart){var b="RTC_MAIN";this._sfuType!=this.CONST_STRING_SCREEN&&this._sfuType!=this.CONST_STRING_SCREEN_LOW||(b="RTC_SS"),CallManager._dispatchEvent(CallManager.Event.CONNECTING,{type:"mcu",conn_type:b}),this._iceStateCompleted=!1,this._sdpSent=!1,this._answered=!1}var c=new Zebra("MEDIA_RENEGOTIATE");c.setZEvent("call_id",this._objID),a&&c.setZEvent("IceRestart","true"),c.setZebraAttribute("userId",rtcSFU.getUserName()),ConnectionManager.sendZSCommand("sendMessageToMCU","&command=zebra&contents="+encodeURIComponent(c.toXML())),this.startMcuRenegTimer()},this.startMcuRenegTimer=function(){this._mediaRenegTimer&&clearInterval(this._mediaRenegTimer),this.log("startMcuRenegTimer: starting reneg timer:"+this.renegTimeout);var a=this;this._mediaRenegTimer=setInterval(function(){a.log("Not received MEDIA_OFFER from MCU, closing media leg for redialling"),a.hangupWithError(AVSDKErrors.NO_MO_TIMEOUT)},this.renegTimeout)},this.stopMcuRenegTimer=function(){this._mediaRenegTimer&&(this.log("stopMcuRenegTimer: closed reneg timer"),clearInterval(this._mediaRenegTimer))},this.getStreamLabel=function(a){return a?a.id:null},this.generateAnswerZebra=function(a){var b=new Zebra("MEDIA_ANSWER");b.setZEvent("call_id",this._objID),ConnectionManager.webRTCBrowser&&b.setZEvent("browser",ConnectionManager.webRTCBrowser),null!=ConnectionManager.webRTCBrowserVersion&&b.setZEvent("browser_ver",ConnectionManager.webRTCBrowserVersion);var c=null,d=0;if(this.localStream)if(this.useNumericKeys)c=d.toString(),b.setZEvent("msid_"+c,this.getStreamLabel(this.localStream)),b.setZEvent("type_"+c,"RV_C_HIGH"),d++;else{var e=this.getStreamLabel(this.localStream);c=e,b.setZEvent("type_"+e,"RV_C_HIGH")}var f=rtcSFU.getLowResolStream();if(rtcSFU._useSimulcast&&this._sfuType!=this.CONST_STRING_SCREEN&&this._sfuType!=this.CONST_STRING_SCREEN_LOW&&f){var e=d.toString();this.useNumericKeys?(b.setZEvent("msid_"+e,this.getStreamLabel(f)),b.setZEvent("type_"+e,"RV_C_LOW"),d++):(e=this.getStreamLabel(f),b.setZEvent("type_"+e,"RV_C_LOW")),c?c+=","+e:c=e}if(ssController.desktopStream){var e=d.toString();this.useNumericKeys?(b.setZEvent("msid_"+e,this.getStreamLabel(ssController.desktopStream)),b.setZEvent("type_"+e,"SCREEN"),d++):(e=this.getStreamLabel(ssController.desktopStream),b.setZEvent("type_"+e,"SCREEN")),c?c+=","+e:c=e}if(this.useNumericKeys?b.setZEvent("item_fields","type,msid"):b.setZEvent("item_fields","type"),void 0!=c?b.setZEvent("item_keys",c):b.setZEvent("item_keys",""),a?(rtcSFU.enableAudioNack&&(a=a.replace("m=video","a=rtcp-fb:* nack\r\nm=video")),this._useBase64Enc?b.setZEvent("sdp",window.btoa(window.btoa(a))):b.setZEvent("sdp",a)):b.setZEvent("sdp",""),b.setZebraAttribute("userId",rtcSFU.getUserName()),ConnectionManager.sendZSCommand("sendMessageToMCU","&command=zebra&contents="+encodeURIComponent(b.toXML())),this.log("MEDIA_ANSWER sent:\n"+b.toXML()),this._renegotiate){rtcSFU.reconnectHappen="ice reneg",this._iceRestart&&(rtcSFU.reconnectHappen="ice restart"),TelemetryZebraMsgs.sendTelemetryConnect();var g=this;setTimeout(function(){var a=g.peerConnection;!a||"connected"!=a.iceConnectionState&&"completed"!=a.iceConnectionState||g.dispatchRemoteStreamAttached()},1e3)}},this.generatePlaceCallZebra=function(a){if(this.startPlaceCallResponseTimeout(),CallManager.usingCallID)return this._objID=CallManager.usingCallID,CallManager.usingCallID=null,this.offerSDPRecvd(CallManager.connectResponseZebra),void(CallManager.connectResponseZebra=null);this._renegotiate||(this._objID=CallManager.generateCallID());var b=new Zebra("PLACE_CALL");b.setZEvent("call_id",this._objID),b.setZEvent("to",this._destination),CallManager.httpLegID&&b.setZEvent("http_leg_id",CallManager.httpLegID),ConnectionManager.webRTCBrowser&&b.setZEvent("browser",ConnectionManager.webRTCBrowser),null!=ConnectionManager.webRTCBrowserVersion&&b.setZEvent("browser_ver",ConnectionManager.webRTCBrowserVersion);var c=ConnectionManager.getSdpSemantics();this._sfuType===this.CONST_STRING_SCREEN&&ssController.appshareConfig.simulcast.enabled&&(c="unified-plan"),null!=c&&b.setZEvent("sdpSemantics",c),a?(b.setZEvent("from",this._username+"@"+this._host),this._useBase64Enc?b.setZEvent("sdp",window.btoa(window.btoa(a))):b.setZEvent("sdp",a)):(this.offerContainAudioNack=!1,b.setZEvent("sdp",""),this._sfuType==this.CONST_STRING_SCREEN||this._sfuType==this.CONST_STRING_SCREEN_LOW?b.setZEvent("from",this._username+"@"+this._host):b.setZEvent("from","SHADOW_SFU_"+rtcSFU.getUserName()+"@"+this._host)),this.log("PLACE_CALL zebra:\n"+b.toXML()),this._answerReceived=!1,b.setZebraAttribute("userId",rtcSFU.getUserName()),ConnectionManager.sendZSCommand("sendMessageToMCU","&event=PLACE_CALL&call_id="+this._objID+"&command=zebra&contents="+encodeURIComponent(b.toXML()))},this.sendSDP=function(){if(this.log("sendSDP:"+this._sdpSent+"   "+this._localIP),this._localOffer&&!this._sdpSent)if(this._sdpSent=!0,this._renegotiate&&!this._iceRestart&&(this._localOffer.candidates=[]),rtcSFU._useMcuZebra)this.sendSDPZebra();else{this._localOffer.username=this._username,this._localOffer.host=this._host,this._localOffer.destination=this._destination;var a=JSON.stringify(this._localOffer);this.log("SDP \n"+a),this.sendMessage(a)}},this.generateStun=function(a){if(null==a&&(a=zwrtc.stunserver_config),rtcSFU.lgTURNUrls&&(a.uris=rtcSFU.lgTURNUrls),this.pcConfig={iceServers:[]},rtcSFU.turnProtocol){if("UDP"===rtcSFU.turnProtocol){const b=new RegExp("turn:.*transport=udp","g"),c=a.uris.filter(function(a){return a.match(b)});return void this.pcConfig.iceServers.push({username:a.username,credential:a.password,urls:c})}if("TCP"===rtcSFU.turnProtocol){const b=new RegExp(".*transport=tcp","g"),c=a.uris.filter(function(a){return a.match(b)});return void this.pcConfig.iceServers.push({username:a.username,credential:a.password,urls:c})}if("TCP_TLS"===rtcSFU.turnProtocol){const b=new RegExp("turns:.*transport=tcp","g"),c=a.uris.filter(function(a){return a.match(b)});return void this.pcConfig.iceServers.push({username:a.username,credential:a.password,urls:c})}}if(rtcSFU.iceCandType===rtcSFU.iceCandTypes.ALL){if(ConnectionManager.isFF()){const b=new RegExp("turn:.*transport=tcp","g"),d=a.uris.filter(function(a){return!a.match(b)});return void this.pcConfig.iceServers.push({username:a.username,credential:a.password,urls:d})}if(ConnectionManager.isEdge()){for(this.pcConfig.gatherPolicy="all",i=0;i<a.uris.length;i++){var e=a.uris[i];if(0===e.indexOf("turn:")&&e.indexOf("transport=udp")!==-1&&e.indexOf("turn:[")===-1&&(this.pcConfig.iceServers.push({username:a.username,credential:a.password,urls:e}),rtcSFU.edgeSupportsSingleTurn))return}return}return this.pcConfig.iceServers.push({username:a.username,credential:a.password,urls:a.uris}),void(this.pcConfig.iceTransportPolicy=rtcSFU.iceTransportPolicies.ALL)}if(rtcSFU.iceCandType===rtcSFU.iceCandTypes.TURN){var d=a.uris;if(ConnectionManager.isFF()){const b=new RegExp("turn:.*transport=tcp","g");d=a.uris.filter(function(a){return!a.match(b)})}return this.pcConfig.iceServers.push({username:a.username,credential:a.password,urls:d}),void(this.pcConfig.iceTransportPolicy=rtcSFU.iceTransportPolicies.RELAY)}if(rtcSFU.iceCandType===rtcSFU.iceCandTypes.TURN_TCP_TLS){var b=new RegExp(".*transport=tcp","g");ConnectionManager.isFF()&&(b=new RegExp("turn:.*transport=tcp","g"));const c=a.uris.filter(function(a){return a.match(b)});return this.pcConfig.iceServers.push({username:a.username,credential:a.password,urls:c}),void(this.pcConfig.iceTransportPolicy=rtcSFU.iceTransportPolicies.RELAY)}if(rtcSFU.iceCandType===rtcSFU.iceCandTypes.TURN_TLS){const b=new RegExp("turns:.*transport=tcp","g"),c=a.uris.filter(function(a){return a.match(b)});return this.pcConfig.iceServers.push({username:a.username,credential:a.password,urls:c}),void(this.pcConfig.iceTransportPolicy=rtcSFU.iceTransportPolicies.RELAY)}this.pcConfig.iceServers.push({username:a.username,credential:a.password,urls:a.uris})},this.createPeerConnection=function(){if(void 0==this.peerConnection)try{var a={optional:[{DtlsSrtpKeyAgreement:CallManager.DtlsSrtpKeyAgreement}]};rtcSFU.enableHangConst&&(a.optional.push({googCpuOveruseDetection:!0}),a.optional.push({googCpuOveruseEncodeUsage:!0}),a.optional.push({googCpuUnderuseThreshold:55}),a.optional.push({googCpuOveruseThreshold:85}),a.optional.push({googScreencastMinBitrate:400}),a.optional.push({googPayloadPadding:!0}),a.optional.push({googHighStartBitrate:0})),a.optional.push({googDscp:!0}),null!=rtcSFU.iceTransportPolicy&&(this.pcConfig.iceTransportPolicy=rtcSFU.iceTransportPolicy);var b=ConnectionManager.getSdpSemantics();this._sfuType===this.CONST_STRING_SCREEN&&ssController.appshareConfig.simulcast.enabled&&(b="unified-plan"),null!=b&&(this.pcConfig.sdpSemantics=b),null!=rtcSFU.iceCandidatePoolSize&&(this.pcConfig.iceCandidatePoolSize=rtcSFU.iceCandidatePoolSize),this.pcConfig.bundlePolicy="max-bundle",this.log('Created RTCPeerConnnection with:\n  config: "'+JSON.stringify(this.pcConfig)+'";\n  constraints: "'+JSON.stringify(a)+'".'),this.peerConnection=new RTCPeerConnection(this.pcConfig,a),this.peerConnection.onicecandidate=this.onIceCandidate.bind(this),this.peerConnection.ontrack=this.onRemoteStreamTrack.bind(this),this.peerConnection.onremovestream=this.onRemoteStreamRemoved.bind(this),ConnectionManager.isChrome()&&ConnectionManager.webRTCBrowserVersion>79||ConnectionManager.isSafari()?this.peerConnection.onconnectionstatechange=this.onIceConnectionStateChanged.bind(this):this.peerConnection.oniceconnectionstatechange=this.onIceConnectionStateChanged.bind(this),this.peerConnection.onnegotiationneeded=this.onNegotiationNeeded.bind(this)}catch(c){return void this.log("Failed to create PeerConnection, exception: "+c.message)}},this.onNegotiationNeeded=function(a){this.replaceTrackSupported&&"SCREEN"===this._sfuType&&this.renegotiateCall()},this.ortcDtlsError=function(a){this.hangupWithError(AVSDKErrors.DTLS_ERROR)},this.ortcIceStateChanged=function(a){this._sfuType===this.CONST_STRING_HIGH&&this.onIceConnectionStateChanged(a)},this.getIceState=function(){return this.peerConnection?ConnectionManager.isChrome()&&ConnectionManager.webRTCBrowserVersion>79||ConnectionManager.isSafari()?(this.log("getIceState: connectionState:"+this.peerConnection.connectionState+" iceConnectionState:"+this.peerConnection.iceConnectionState),this.peerConnection.connectionState):this.peerConnection.iceConnectionState:this.ortcMedia?this.ortcMedia.getIceState():"checking"},this.onIceConnectionStateChanged=function(a){if(this.peerConnection||this.ortcMedia){var b=this.getIceState();if(this._renegotiate)return void this.log("Ignoring onIceConnectionStateChanged:"+b);if(this.log("onIceConnectionStateChanged:"+b+" this._renegotiate:"+this._renegotiate),"failed"==b){if("SCREEN"!==this._sfuType){if(ConnectionManager.iceConnFailCount>=ConnectionManager.iceConnFailTh)return ConnectionManager.iceConnFailCount=0,CallManager.mediaConnectionFailed("ICE_CONNECTION_FAILED",{}),this.closePC(this.peerConnection),void(this.peerConnection=null);ConnectionManager.iceConnFailCount++,this.closePC(this.peerConnection),this.peerConnection=null;var c="onIceConnectionStateChanged: iceConnFailCount="+ConnectionManager.iceConnFailCount;return this.log(c),void CallManager.redialCall(c)}this.hangup(!0,AVSDKErrors.getReason(AVSDKErrors.ICE_CLOSED))}else"connected"!==b&&"completed"!==b||(isNaN(this.iceConnectedTime)&&(this.iceConnectedTime=DateTimeUtil.getNow()),ConnectionManager.iceConnFailCount=0,this.shadowZebra&&this.shadowConnected(this.shadowZebra));if(rtcSFU._useMcuZebra)if("closed"===b)this._callEstablished&&("SCREEN"===this._sfuType?this.hangup(!0,AVSDKErrors.getReason(AVSDKErrors.ICE_CLOSED)):this.hangupWithError(AVSDKErrors.ICE_CLOSED));else if("failed"===b)this.hangupWithError(AVSDKErrors.ICE_FAILED);else if("disconnected"===b){var d=this;setTimeout(function(){if(d.peerConnection||d.ortcMedia)if("disconnected"===d.getIceState()){if(rtcSFU.enableIceCandRestriction&&!isNaN(d.iceConnectedTime)){var a=DateTimeUtil.getNow()-d.iceConnectedTime-5e3;a<=rtcSFU.iceRestrictionTH&&rtcSFU.nextIceCandType()}rtcSFU._enableIceRenegotiation?rtcSFU._useMcuOffer&&d._sfuType!=d.CONST_STRING_SCREEN&&d._sfuType!=d.CONST_STRING_SCREEN_LOW?d.hangupWithError(AVSDKErrors.ICE_DISCONNECTED):(rtcSFU.getStateFromMCU(),d._answered=!1,d.renegotiateOffer(d.sdpConstraints,!0)):d.hangupWithError(AVSDKErrors.ICE_DISCONNECTED)}else"closed"!==d.getIceState()&&"failed"!==d.getIceState()||d.hangupWithError(AVSDKErrors.ICE_CLOSED)},5e3)}}},this.sendCreateSession=function(){if(this.isCallAllowed())if(this.log("sendCreateSession"),rtcSFU._useMcuZebra)this._objID=CallManager.generateCallID(),this._onopen();else{if(this._rv){var a=$("#"+this._rv.id);a.hide()}this._objID=(new Date).getTime();var b=new Zebra(ConnectionManager.zsZebraGateway+"#createWsSession");b.setZEvent("creationTime",this._objID),b.setZEvent("subprotocol","zensip"),ConnectionManager.sendZSZebraCommand("zsMessage",b)}},this.connect=function(){if(this.isCallAllowed())if(this._disableWS)if(this.log("connect:"+ConnectionManager.zsState),null==ConnectionManager.zsState||"disconnected"==ConnectionManager.zsState){this._connCheckTimer&&clearInterval(this._connCheckTimer);var a=this;this._connCheckTimer=setInterval(function(){a.log("connect:"+ConnectionManager.zsState),null!=ConnectionManager.zsState&&"disconnected"!=ConnectionManager.zsState&&(a._connCheckTimer&&clearInterval(a._connCheckTimer),a.sendCreateSession())},1e3)}else this.sendCreateSession();else{var b=this;if(this._ws)this.log("this._ws.connecting:"+this._ws.connecting),this.log("this._ws.connected:"+this._ws.connected),b.doOffer();else{var c="ws://"+this._host+"/webrtc2sip/";this._ws=new WebSocket(c,"zensip"),this._ws.onopen=this._onopen.bind(this),this._ws.onmessage=this._onmessage.bind(this),this._ws.onclose=this._onclose.bind(this)}}},this._onopen=function(){this.isCallAllowed()&&this.doOffer()},this.sendMessage=function(a){if(this._disableWS){var b=new Zebra(ConnectionManager.zsZebraGateway+"#sendMessageToWS");this._useBase64Enc?b.setZEvent("data",window.btoa(window.btoa(a))):b.setZEvent("data",a),b.setZEvent("creationTime",this._objID),b.setZEvent("subprotocol","zensip"),ConnectionManager.sendZSZebraCommand("zsMessage",b)}else this._ws&&this._ws.send(a)},this.processMessage=function(a){this.processMessageObj(JSON.parse(a))},this.processMessageObj=function(a){if(a&&a.type)switch(a.type){case"offer":this._video&&(a.sdp=this.updateSDP(a.sdp)),this.debugLog("SDP \n"+a.sdp),a.sdp.indexOf("\r\n")===-1&&(a.sdp=a.sdp.replace(/\n/g,"\r\n")),a.sdp=SDPUtils2.updateRemoteSDP(a.sdp),this.debugLog("SDP \n"+a.sdp);var b=this,c=null;c=ConnectionManager.isSafari()?a:new RTCSessionDescription(a),this.peerConnection.setRemoteDescription(c).then(this.doAnswer.bind(this))["catch"](function(a){console.error("Error in SetRemoteDescription:err"+a),b.hangupWithError(AVSDKErrors.MO_INVALID)});break;case"answer":if(!this._answered){this._answered=!0,this._video&&(a.sdp=this.updateSDP(a.sdp)),a.sdp.indexOf("\r\n")===-1&&(a.sdp=a.sdp.replace(/\n/g,"\r\n")),a.sdp=SDPUtils2.updateRemoteSDP(a.sdp),this.debugLog("SDP \n"+a.sdp);var b=this;if(this.peerConnection.setRemoteDescription(new RTCSessionDescription(a),function(){b.log("SDP:onSuccess:Answer fits with Offer. Media will start")},function(a){b.log("SDP:onFailure:Answer does not fit the Offer. Accept the call and Terminate:"+a),b.hangupWithError(AVSDKErrors.MA_INVALID)}),this._renegotiate){var b=this;setTimeout(function(){var a=b.peerConnection;!a||"connected"!=a.iceConnectionState&&"completed"!=a.iceConnectionState||b.dispatchRemoteStreamAttached()},1e3)}}break;default:
this.log("_onMessage:"+a.type+"\n"+a.sdp)}},this._onmessage=function(a){this.isCallAllowed()&&this.processMessage(a.data)},this._onclose=function(a){this._ws=null},this.isCallAllowed=function(){return!(!this.allowCall||CallManager._srCommandID!=-1&&this._sfuType!=rtcSFU.CONST_STRING_AUDIO_RECORD)},this.mediaRenegotiateRecvd=function(a){if(a&&rtcSFU._useMcuOffer&&this._sfuType==this.CONST_STRING_HIGH){var b=parseInt(a.getZebraAttribute("error_code"));isNaN(b)||0==b?this.ortcMedia&&(this.log("Devices negotiated with MCU"),ConnectionManager._dispatchEvent("ZWRTC_REMOTE_STREAM_ATTACHED")):(this.log("Recvd MEDIA_RENEGOTIATE from MCU with error code :"+b+", closing media leg so it can be redialled"),this.hangupWithError(AVSDKErrors.ME_RENEG_ERROR))}},this.connectResponse=function(a){try{var b=a.getZEvent("sdp").value;b&&this.offerSDPRecvd(a)}catch(c){}},this.offerSDPRecvd=function(a){var b=a.getZEvent("call_id").value;if(b==this._objID){if(this.log("offerSDPRecvd:"+this._objID),this.debugLog(a.toXML()),this._answerReceived=!0,this.stopMcuRenegTimer(),"HIGH"!=this._sfuType)return void this.processOfferSDP(a);var c=[];try{var d=a.getZEvent("item_fields").value,e=a.getZEvent("item_keys").value;if(e){var f=e.split(",");if(d)for(var g=d.split(","),h=0;h<f.length;h++){for(var i=f[h],j={},k=0;k<g.length;k++){var l=g[k];try{j[l]=a.getZEvent(l+"_"+i).value,j.index=i}catch(m){this.log(m)}}var n=j.msid;rtcSFU.mssrcStreams[n]&&(j.stream=rtcSFU.mssrcStreams[n].stream),rtcSFU.mssrcStreams[n]=j,j.index&&(c.push(j.index),rtcSFU.mssrcVidReference[j.index]=j,"BandNormal"!=CallManager.lowBrMode&&0===parseInt(j.index)&&j.stream&&(this.log("LOW_BR: lowbr mode :"+CallManager.lowBrMode+" reassign sfu 0 media stream"),rtcSFU.attachLowBRStream(j.stream)))}}}catch(m){this.log(m)}var o=!1;try{o="true"===a.getZEvent("micOn").value}catch(p){}if(CallManager.initialMicUnmuted=o,rtcSFU.mssrcVidReference)for(var q in rtcSFU.mssrcVidReference)q&&c.indexOf(q)==-1&&delete rtcSFU.mssrcVidReference[q];c=null,this.processOfferSDP(a)}},this.getSlotData=function(){var a={slot_map:[]};if(rtcSFU.remoteAudioStream)a.slot_map[b]=rtcSFU.remoteAudioStream;else if(rtcSFU.mssrcVidReference)for(var b in rtcSFU.mssrcVidReference)if(b&&rtcSFU.mssrcVidReference[b]){var c=rtcSFU.mssrcVidReference[b].stream;if(!c)break;a.slot_map[b]=c}return a},this.getMediaStreams=function(){var a={};for(var b in rtcSFU.mssrcVidReference)if(b&&rtcSFU.mssrcVidReference[b]){var c=rtcSFU.mssrcVidReference[b].stream;null!=c&&(a[c.id]=c)}return a},this.isAudioStream=function(a){return null!=a&&null!=a.getAudioTracks()[0]},this.checkIfAllStreamsPresent=function(){var a=!1,b={},c={slot_map:[]};if(rtcSFU.remoteAudioStream){var d=rtcSFU.remoteAudioStream;a=!0,ConnectionManager.isUsingPlugin||(b[d.id]=d),c.slot_map[e]=d}else if(rtcSFU.mssrcVidReference)for(var e in rtcSFU.mssrcVidReference)if(e&&rtcSFU.mssrcVidReference[e]){var d=rtcSFU.mssrcVidReference[e].stream;if(null==d){a=!1;break}a=!0,!ConnectionManager.isUsingPlugin&&this.isAudioStream(d)&&(b[d.id]=d),c.slot_map[e]=d}if(a){if(ConnectionManager.isUsingPlugin){var d=rtcSFU.mssrcVidReference[rtcSFU.SFU_MAX_VIDEO_LEN].stream;null!=d&&(b[d.id]=d)}ConnectionManager._dispatchEvent("MEDIA_STREAMS_UPDATED",b),ConnectionManager._dispatchEvent("RECORD_STREAMS_SLOT",c)}return a},this.processOfferSDP=function(a){var b=this.peerConnection;!b||"connected"!=b.iceConnectionState&&"completed"!=b.iceConnectionState||(this._renegotiate=!0);var c=a.getZEvent("sdp").value;c&&(c=c.replace("<![CDATA[","").replace("]]>",""));var d=c;c.indexOf("v=0")==-1?(this._useBase64Enc=!0,d=window.atob(window.atob(c).replace(/\s/g,""))):this._useBase64Enc=!1,b&&this.debugLog("decodedSDP:"+this._renegotiate+" "+b.iceConnectionState+"\n"+d);var e=d.indexOf("m=video"),f=this.regexIndexOf(d,"a=rtcp-fb:.* nack",0);f!=-1&&(e==-1||f<e)&&(this.offerContainAudioNack=!0),d.indexOf("v=0")>-1&&this.processMessageObj({type:"offer",sdp:d})},this.regexIndexOf=function(a,b,c){var d=a.substring(c||0).search(b);return d>=0?d+(c||0):d},this.answerSDPRecvd=function(a){var b=null;try{b=a.getZEvent("call_id").value}catch(c){b=this._objID}if(b==this._objID){if(this.log("answerSDPRecvd:\n"+a.toXML()),this._answerReceived=!0,this.ortcMedia)return void this.ortcMedia.handleMediaResponse(a);var d=a.getZEvent("sdp").value;d&&(d=d.replace("<![CDATA[","").replace("]]>",""));var e=d;d.indexOf("v=0")==-1?(this._useBase64Enc=!0,e=window.atob(window.atob(d).replace(/\s/g,""))):this._useBase64Enc=!1,this.log("decodedSDP:\n"+e),e.indexOf("v=0")>-1&&this.processMessageObj({type:"answer",sdp:e})}},this.zsOnOpen=function(a){if(this.isCallAllowed()){var b=a.getZEvent("data").value,c=a.getZEvent("creationTime").value;c==this._objID&&(this.log("zsOnOpen:"+b),this._onopen())}},this.zsOnMessage=function(a){if(this.isCallAllowed()){this.log("zsOnMessage:\n"+a.toXML());var b=a.getZEvent("creationTime").value,c=a.getZEvent("data").value;c=c.replace("<![CDATA[","").replace("]]>","");var d=window.atob(c).replace(/\s/g,""),e=window.atob(d);b==this._objID?(this.log("zsOnMessage:time"+b+" _objID:"+this._objID+"\n"+e),this.log("zsOnMessage:calling processMessage"),this.processMessage(e)):this.log("zsOnMessage:Ignoring message as creation time not matching")}},this.zsOnClose=function(a){var b=a.getZEvent("creationTime").value,c=a.getZEvent("data").value;b==this._objID&&this.log("zsOnClose:"+c+" "+b+" "+this._objID)},this.close=function(a){if(this.log("this._ws.close()"),CallManager.disableDisconnect&&"SCREEN"!==this._sfuType)CallManager.shadowCallID=this._objID;else if(rtcSFU._useMcuZebra){var b=new Zebra("END_CALL");b.setZEvent("call_id",this._objID),a&&b.setZEvent("error_msg",a),this.log("END_CALL zebra:\n"+b.toXML()),b.setZebraAttribute("userId",rtcSFU.getUserName()),ConnectionManager.sendZSCommand("sendMessageToMCU","&event=END_CALL&call_id="+this._objID+"&command=zebra&contents="+encodeURIComponent(b.toXML()))}else if(this._disableWS){var b=new Zebra(ConnectionManager.zsZebraGateway+"#closeWsSession");b.setZEvent("creationTime",this._objID),b.setZEvent("subprotocol","zensip"),ConnectionManager.sendZSZebraCommand("zsMessage",b)}else this._ws&&this._ws.close(),this._ws=null},this.clearRV=function(){if(this._rv&&this.remoteStream){var a=$("#"+this._rv.id);a.attr("stream_id")==this.remoteStream.id&&(this.log("Same stream attached, so clearing the stream:"+this._rv.id+" "+this.remoteStream.id),a.attr("stream_id",null))}},this.hangupWithError=function(a){var b=AVSDKErrors.getReason(a);rtcStats.saveOldStats(a,b),console.error("hangupWithError:error_code="+a+" reason="+b),TelemetryZebraMsgs.sendTelemetryDisconnect(b),ConnectionManager._dispatchEvent("REDIALLING_CaLL",{error:a,reason:AVSDKErrors.getReason(a)}),CallManager.uploadConsoleLogs(b),this.hangup(!0,"Code: "+a+" Message: "+b)},this.isMediaConnected=function(){if(this.peerConnection){var a=this.peerConnection.iceConnectionState;if("connected"===a||"completed"===a)return!0}return!1},this.hangup=function(a,b){if(this.log("this.hangup:"+this.allowCall+" "+this._sfuType+" "+this._userId),this.stopPlaceCallResponseTimeout(),zwrtc._useCustomGUI&&(rtcSFU._sfuStreams[this._userId]&&delete rtcSFU._sfuStreams[this._userId],"SCREEN"==this._sfuType||this._userId==ConnectionManager.userId||this.screenShareMedia||this.dispatchRemoveEvent()),this.screenShareMedia&&ssController.incomingRemoteSSStream&&this.remoteStream&&ssController.incomingRemoteSSStream.id==this.remoteStream.id&&(ssController.incomingRemoteSSStream=null,ConnectionManager._dispatchEvent("ZSCREENSHARE_RECEIVER_STOP",{userId:this._userId})),this._localOffer&&this._localOffer.timeOut&&clearTimeout(this._localOffer.timeOut),this._localOffer=null,this.stopMcuRenegTimer(),this._sdpSent=!1,this.clearRV(),this._video=!0,this.plps=0,this.prps=0,this._rv=null,this._lv=null,this._mediaStarted=!1,this.localStream=null,this.remoteStream=null,this.lastMCUVideoPacketChangeTime=0,this.lastMCUVideoPacketCount=0,this._pendingAttachStream=!1,this._iceStateCompleted=!1,this._callEstablished=!1,this._localIP=null,this.hideConnecting(),this.debugInfoTimer&&clearInterval(this.debugInfoTimer),"HIGH"===this._sfuType&&rtcStats.stopRtcStatsGathering(),this.pingTimer&&clearInterval(this.pingTimer),this.uninit(),this.peerConnection){var c=this.peerConnection;this.peerConnection=null,this.closePC(c),this.close(b),a&&this.isCallAllowed()&&ConnectionManager._dispatchEvent("ZWRTC_MEDIA_LEG_CLOSED",{sfuType:this._sfuType,sfu_media:this.sfu_media,error_msg:b})}else this.ortcMedia&&(this.ortcMedia.closeConnection(),this.close(b),a&&this.isCallAllowed()&&"SCREEN"!==this._sfuType&&ConnectionManager._dispatchEvent("ZWRTC_MEDIA_LEG_CLOSED",{sfuType:this._sfuType,sfu_media:this.sfu_media,error_msg:b}));this.allowCall=!1,ConnectionManager.isFF()&&this.stopMicActivity()},this.closePC=function(a){if(a)try{this.removeStream(a,this.localStream),a.onicecandidate=null,a.ontrack=null,a.onremovestream=null,a.oniceconnectionstatechange=null,a.onnegotiationneeded=null,a.close()}catch(b){}},this.loadAvatar=function(a){this._vid=a;var b=this._defaultAvatar;if(zwrtc._useCustomGUI||(b="/"+this._defaultAvatar),"undefined"!=typeof ContactModel){var c=ContactModel.getContactByVid(this._vid);c&&c.avatarurl&&(b=c.avatarurl)}if(zwrtc._useCustomGUI&&this._userId&&this._userId!=ConnectionManager.userId&&!this.screenShareMedia);else if(this._rv){var d=$("#"+this._rv.id+"_avatar");d.length>0&&(d[0].src=b)}},this.resize=function(){this.isCallAllowed()&&this.setRV(this._posX,this._posY,this._posWidth,this._posHeight,this._videoWidth,this._videoHeight,this._mainRV)},this.setRV=function(a,b,c,d,e,f,g){if("VOICE"==CallManager._type?(this._posX=-1,this._posY=-1):(this._posX=a,this._posY=b),this._posWidth=c,this._posHeight=d,this._videoWidth=e,this._videoHeight=f,this._mainRV=g,this._rv&&this.isCallAllowed()){var h=$("#"+this._rv.id),i=$("#"+this._rv.id+"_avatar"),j=$("#"+this._rv.id+"_div");if(this._posX!=-1&&this._posY!=-1&&null!=g){var k=g.width(),l=g.height();$("#rvContainer").length>0&&(k=$("#rvContainer").width(),l=$("#rvContainer").height());var m=parseFloat(g.css("margin-left")),n=k/2,o=Math.ceil(a*k/e),p=Math.ceil(b*l/f),q=Math.ceil(c*k/e),r=Math.ceil(d*l/f);rtcSFU.fullScreenStatus()&&isNaN(parseInt($("#zcdiv").css("left")))&&(m=(screen.width-k)/2),j.removeClass("rv_left"),j.removeClass("rv_right"),j.removeClass("rv_center"),o>n?j.addClass("rv_right"):o+q<n?j.addClass("rv_left"):j.addClass("rv_center"),j.length>0?(j.width(q),j.height(r),j.css("left",o+"px"),j.css("top",p+"px"),j.css("position","absolute"),j.css("margin-left",m+"px"),this._callEstablished&&(this._mediaStarted?(this.hideConnecting(),this._muted?(h.hide(),i.length>0&&(i.css("width","100%"),i.css("height","100%"),i.show())):(h.css("width","100%"),h.css("height","100%"),h.show(),i.length>0&&i.hide())):this.showConnecting()),j.show()):(this._rv.style.width=q+"px",this._rv.style.height=r+"px",this._rv.style.left=o+"px",this._rv.style.top=p+"px",this._rv.style.position="absolute",this._rv.style.display="inline",this._rv.style.marginLeft=m+"px")}else this.log("HIDE RV:"+this._posX+"X"+this._posY),h.length>0&&"VOICE"!=CallManager._type?h.show():this._rv&&(this._rv.style.display="none"),j.length>0&&j.hide()}},this.startMicActivity=function(){if(this.stopMicActivity(),this.remoteStream)try{if(null==this.audioContext&&"undefined"!=typeof AudioContext&&(this.audioContext=new AudioContext),this.audioContext){this.analyser=this.audioContext.createAnalyser(),this.microphone=this.audioContext.createMediaStreamSource(this.remoteStream),this.audioContext.createJavaScriptNode?this.javascriptNode=this.audioContext.createJavaScriptNode(2048,1,1):this.audioContext.createScriptProcessor&&(this.javascriptNode=this.audioContext.createScriptProcessor(2048,1,1)),this.analyser.smoothingTimeConstant=.3,this.analyser.fftSize=1024,this.microphone.connect(this.analyser),this.analyser.connect(this.javascriptNode),this.javascriptNode.connect(this.audioContext.destination);var a=this;this.javascriptNode.onaudioprocess=function(){if(a.analyser){var b=new Uint8Array(a.analyser.frequencyBinCount);a.analyser.getByteFrequencyData(b);for(var c=0,d=1,e=0;e<b.length;e++)c=Math.max(c,b[e]),d=Math.min(d,b[e]);if(a.remoteStream){var f=a.remoteStream.id;rtcSFU.mssrcStreams[f]&&(rtcSFU.mssrcStreams[f].audioOutputLevel=c,isNaN(rtcSFU.mssrcStreams[f].maxAudioOutputLevel)?rtcSFU.mssrcStreams[f].maxAudioOutputLevel=c:rtcSFU.mssrcStreams[f].maxAudioOutputLevel=Math.max(rtcSFU.mssrcStreams[f].maxAudioOutputLevel,c))}}}}}catch(b){}},this.stopMicActivity=function(){this.javascriptNode&&this.javascriptNode.disconnect(),this.analyser&&this.analyser.disconnect(),this.microphone&&this.microphone.disconnect(),this.javascriptNode=null,this.analyser=null,this.microphone=null},this.isPCConnected=function(){var a=this.peerConnection;return!(!a||"connected"!=a.iceConnectionState&&"completed"!=a.iceConnectionState)},this.log=function(a){(this.logEnabled||Platform.debugLogEnabled)&&Platform.log("rtcMedia:"+this._sfuType+" "+a)},this.debugLog=function(a){Platform.debugLogEnabled&&Platform.log("rtcMedia:"+this._sfuType+" "+a)}}function MicTest(){this.inputChannelCount=6,this.outputChannelCount=2,this.bufferSize=0,this.collectSeconds=2,this.silentThreshold=1/32767,this.lowVolumeThreshold=-60,this.monoDetectThreshold=1/65536,this.clipCountThreshold=6,this.clipThreshold=1,this.collectedAudio=null,this.collectedSampleCount=0,this.testRunning=!1,this.run=function(a){if(null==this.audioContext)try{window.AudioContext=window.AudioContext,this.audioContext=new AudioContext}catch(b){console.error("Failed to instantiate an audio context, error: "+b)}if(this.collectedAudio=null,this.collectedSampleCount=0,null==this.collectedAudio){this.collectedAudio=[];for(var c=0;c<this.inputChannelCount;++c)this.collectedAudio[c]=[]}return this.checkAudioTracks(a)?void this.createAudioBuffer():void this.testFinished()},this.testFinished=function(){console.log("==================testFinished")},this.checkAudioTracks=function(a){this.stream=a;var b=a.getAudioTracks();return!(b.length<1)},this.createAudioBuffer=function(){this.audioSource=this.audioContext.createMediaStreamSource(this.stream),this.scriptNode=this.audioContext.createScriptProcessor(this.bufferSize,this.inputChannelCount,this.outputChannelCount),this.audioSource.connect(this.scriptNode),this.scriptNode.connect(this.audioContext.destination),this.scriptNode.onaudioprocess=this.collectAudio.bind(this),this.testRunning=!0;var a=this;setTimeout(function(){a.stopCollectingAudio()},5e3)},this.collectAudio=function(a){for(var b=a.inputBuffer.length,c=!0,d=0;d<a.inputBuffer.numberOfChannels;d++){var e,f=a.inputBuffer.getChannelData(d),g=Math.abs(f[0]),h=Math.abs(f[b-1]);g>this.silentThreshold||h>this.silentThreshold?(e=new Float32Array(b),e.set(f),c=!1):e=new Float32Array,this.collectedAudio[d].push(e)}c||(this.collectedSampleCount+=b,this.collectedSampleCount/a.inputBuffer.sampleRate>=this.collectSeconds&&this.stopCollectingAudio())},this.stopCollectingAudio=function(){this.testRunning&&(this.testRunning=!1,this.audioSource.disconnect(this.scriptNode),this.scriptNode.disconnect(this.audioContext.destination),this.analyzeAudio(this.collectedAudio),this.testFinished())},this.analyzeAudio=function(a){for(var b=[],c=0;c<a.length;c++)this.channelStats(c,a[c])&&b.push(c);0===b.length?console.error("No active input channels detected. Microphone is most likely muted or broken, please check if muted in the sound settings or physically on the device. Then rerun the test."):console.error("Active audio input channels: "+b.length)},this.channelStats=function(a,b){for(var c=0,d=0,e=0,f=0,g=0;g<b.length;g++){var h=b[g];if(h.length>0){for(var i=0,j=0,k=0;k<h.length;k++)i=Math.abs(h[k]),c=Math.max(c,i),j+=i*i,c>=this.clipThreshold?(e++,f=Math.max(f,e)):e=0;j=Math.sqrt(j/h.length),d=Math.max(d,j)}}if(c>this.silentThreshold){var l=this.dBFS(c),m=this.dBFS(d);return console.error("Channel "+a+" levels: "+l.toFixed(1)+" dB (peak), "+m.toFixed(1)+" dB (RMS)"),m<this.lowVolumeThreshold&&console.error("Microphone input level is low, increase input volume or move closer to the microphone."),f>this.clipCountThreshold&&console.error("Clipping detected! Microphone input level is high. Decrease input volume or move away from the microphone."),!0}return!1},this.dBFS=function(a){var b=20*Math.log(a)/Math.log(10);return Math.round(10*b)/10}}function onSSInvoke(a,b){screenShareViewer.onInvoke(a,b)}"function"!=typeof String.prototype.trim&&(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),Array.prototype.filter||(Array.prototype.filter=function(a){"use strict";if(null==this)throw new TypeError;var b=Object(this),c=b.length>>>0;if("function"!=typeof a)throw new TypeError;for(var d=[],e=arguments[1],f=0;f<c;f++)if(f in b){var g=b[f];a.call(e,g,f,b)&&d.push(g)}return d}),this.JSON||(JSON={}),function(){function f(a){return a<10?"0"+a:a}function quote(a){return escapable.lastIndex=0,escapable.test(a)?'"'+a.replace(escapable,function(a){var b=meta[a];return"string"==typeof b?b:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+a+'"'}function str(a,b){var c,d,e,f,g,h=gap,i=b[a];switch(i&&"object"==typeof i&&"function"==typeof i.toJSON&&(i=i.toJSON(a)),"function"==typeof rep&&(i=rep.call(b,a,i)),typeof i){case"string":return quote(i);case"number":return isFinite(i)?String(i):"null";case"boolean":case"null":return String(i);case"object":if(!i)return"null";if(gap+=indent,g=[],"[object Array]"===Object.prototype.toString.apply(i)){for(f=i.length,c=0;c<f;c+=1)g[c]=str(c,i)||"null";return e=0===g.length?"[]":gap?"[\n"+gap+g.join(",\n"+gap)+"\n"+h+"]":"["+g.join(",")+"]",gap=h,e}if(rep&&"object"==typeof rep)for(f=rep.length,c=0;c<f;c+=1)d=rep[c],"string"==typeof d&&(e=str(d,i),e&&g.push(quote(d)+(gap?": ":":")+e));else for(d in i)Object.hasOwnProperty.call(i,d)&&(e=str(d,i),e&&g.push(quote(d)+(gap?": ":":")+e));return e=0===g.length?"{}":gap?"{\n"+gap+g.join(",\n"+gap)+"\n"+h+"}":"{"+g.join(",")+"}",gap=h,e}}"function"!=typeof Date.prototype.toJSON&&(Date.prototype.toJSON=function(a){return this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z"},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(a){return this.valueOf()});var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;"function"!=typeof JSON.stringify&&(JSON.stringify=function(a,b,c){var d;if(gap="",indent="","number"==typeof c)for(d=0;d<c;d+=1)indent+=" ";else"string"==typeof c&&(indent=c);if(rep=b,b&&"function"!=typeof b&&("object"!=typeof b||"number"!=typeof b.length))throw new Error("JSON.stringify");return str("",{"":a})}),"function"!=typeof JSON.parse&&(JSON.parse=function(text,reviver){function walk(a,b){var c,d,e=a[b];if(e&&"object"==typeof e)for(c in e)Object.hasOwnProperty.call(e,c)&&(d=walk(e,c),void 0!==d?e[c]=d:delete e[c]);return reviver.call(a,b,e)}var j;if(cx.lastIndex=0,cx.test(text)&&(text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})),/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return j=eval("("+text+")"),"function"==typeof reviver?walk({"":j},""):j;throw new SyntaxError("JSON.parse")})}(),function(){var a=!1,b=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){},Class.extend=function(c){function d(){!a&&this.init&&this.init.apply(this,arguments)}c=c||{};var e=this.prototype;a=!0;var f=new this;a=!1,c.init||(c.init=function(){e.init&&e.init()});for(var g in c)f[g]="function"==typeof c[g]&&"function"==typeof e[g]&&b.test(c[g])?function(a,b){return function(){return this._super=function(){e[a].apply(this,arguments)},b.apply(this,arguments)}}(g,c[g]):c[g];return d.prototype=f,d.constructor=d,d.extend=arguments.callee,d.extendAsSingleton=function(a){return new(d.extend(a))},d},Class.extendAsSingleton=function(a){return new(Class.extend(a))}}();var Platform={device:"web",console_buffer:new Array,console_buffer_lc:0,console_buffer_max_length:4e3,console_buffer_flash_max_length:4e3,enable_console_buffer:!0,OSVersion:"4.0",init_code:0,enable_logging:!1,is_uploading:!1,enable_cls_logging:!1,spm:!!window.spm,isSayPageApp:!0,mobileWeb:!1,useStore:!1,default_title:"",dialogId:0,logRollOverDuration:6e4,saveConsoleLogsLocally:!1,httpRequest:function(a,b,c,d,e){var f,g;if(window.XMLHttpRequest){f=new XMLHttpRequest;try{f.overrideMimeType("text/xml")}catch(h){}}else if(window.ActiveXObject)try{f=new ActiveXObject("Msxml2.XMLHTTP")}catch(h){try{f=new ActiveXObject("Microsoft.XMLHTTP")}catch(i){}}var j;/MSIE (\d+\.\d+);/.test(navigator.userAgent)&&(j=new Number(RegExp.$1));var k=j&&j<10&&b.indexOf(ConnectionManager.CLS)<0&&b.indexOf("zmobile")>-1;if(k){f=new XDomainRequest,f.onload=function(){Platform.log("request accessing data"),g&&clearTimeout(g),c(f.responseText,200,"200OK")},f.onprogress=function(){Platform.log("request progressing**")},a="GET",b=b.indexOf("?")>-1?b+"&"+d:b+"?"+d;var l=Math.random();b=b.lastIndexOf("&")==b.length-1?b+"ran="+l:b+"&ran="+l}if(!f&&c)return void c("",-1,"Could not obtain a proper AJAX Request Object for your browser");f.onreadystatechange=function(){4==f.readyState&&c&&(g&&clearTimeout(g),c(f.responseText,f.status,f.statusText))},c&&(f.onerror=function(){Platform.log("request onerror method called:"+b+"   "+d),c("",-2,"Unexpected AJAX Error")},f.onabort=function(){Platform.log("request onabort method called:"+b+"  "+d),c("",-2,"Unexpected AJAX Error")},f.doAbort=function(){Platform.log("ABORT called because ZJS timeout:"+b+" "+d),c("",-2,"Unexpected AJAX Error")});try{k?f.open(a,b):f.open(a,b,null==e||e),"POST"==a&&(k||f.setRequestHeader("Content-type","application/x-www-form-urlencoded")),k?f.send():f.send(d)}catch(h){Platform.log("error in sending request"),c&&c("",-2,"Unexpected AJAX Error: "+h.name+" - "+h.message)}c&&(g=setTimeout(f.doAbort,45e3))},persistence:function(a){return void 0==this.storeCommon&&(Platform.useStore?(this.storeCommon=new Persist.Store("ZCommon"),this.storeUser=new Persist.Store("ZUser")):(this.storeCommon={},this.storeUser={})),this.save=function(b,c,d){if(a){Platform.useStore&&this.storeCommon.set(b,c);var e;Platform.useStore&&(e=this.storeCommon.get("zkeys")),void 0==e&&(e="");var f=0==e.indexOf(b+",");f||e.indexOf(","+b+",")!=-1||(e=e+b+","),Platform.useStore&&this.storeCommon.set("zkeys",e)}else{Platform.useStore&&this.storeUser.set(b,c);var e;Platform.useStore&&(e=this.storeUser.get("zkeys")),void 0==e&&(e="");var f=0==e.indexOf(b+",");f||e.indexOf(","+b+",")!=-1||(e=e+b+","),Platform.useStore&&this.storeUser.set("zkeys",e)}},this.retrieve=function(b){if(b){var c,d,e={};if(d=a?this.storeCommon:this.storeUser,Platform.useStore&&(c=d.get("zkeys")),null!=c)for(var f=c.toString().split(","),g=0;g<f.length;g++)Platform.useStore&&d.get(f[g])&&(e[f[g]]=d.get(f[g]));b(e||{},null)}},this.clear=function(b){var c,d,e={};if(d=a?this.storeCommon:this.storeUser,Platform.useStore&&(c=d.get("zkeys")),null!=c)for(var f=c.toString().split(","),g=0;g<f.length;g++)Platform.useStore&&d.get(f[g])&&d.remove(f[g]);b(e||{},null)},this},papi:function(a){return this.log(" STORE ENABLED="+Platform.useStore+" "+a),void 0==this.allStores&&(this.allStores={}),void 0==this.allStores[a]&&(Platform.useStore?this.allStores[a]=new Persist.Store(a):this.allStores[a]={}),this.addOrUpdateItems=function(b,c){var d,e=this.allStores[a];Platform.useStore&&(d=e.get("zkeys")),void 0==d&&(d="");for(var f in b){Platform.useStore&&e.set(f,b[f]);var g=0==d.indexOf(f+",");g||d.indexOf(","+f+",")!=-1||(d=d+f+",")}Platform.useStore&&e.set("zkeys",d)},this.load=function(b){if(b){var c,d=this.allStores[a],e={};if(Platform.useStore&&(c=d.get("zkeys")),null!=c)for(var f=c.toString().split(","),g=0;g<f.length;g++)d.get(f[g])&&Platform.useStore&&(e[f[g]]=d.get(f[g]));b(e||{},null)}},this.clearModel=function(b){var c,d=this.allStores[a],e={};if(Platform.useStore&&(c=d.get("zkeys")),null!=c){for(var f=c.toString().split(","),g=0;g<f.length;g++)Platform.useStore&&d.get(f[g])&&d.remove(f[g]);Platform.useStore&&d.remove("zkeys")}b&&b(e||{},null)},this.deleteRow=function(b,c){var d,e=this.allStores[a],f={};if(Platform.useStore&&(d=e.get("zkeys")),null!=d){var g=0==d.indexOf(b+",");if(!g&&d.indexOf(","+b+",")>-1){for(var h=d.toString().split(b+","),i="",j=0;j<h.length;j++)i+=h[j];if(Platform.useStore){e.remove(b);for(var j=0;j<h.length;j++)e.get(h[j])&&e.remove(h[j]);e.set("zkeys",d)}}}c&&c(f||{},null)},this.clearFullDB=function(a){Platform.papi("model_defaultModel").clearModel();for(var b=0;b<DataStore.models.length;b++){var c=DataStore.models[b];Platform.papi("model_"+c).clearModel()}a&&a({},null)},this},exit:function(){window.close()},choseAvatar:function(a,b,c,d,e,f){Z.jqm.showFloating("settings","file")},showZAppAction:function(a,b){"contact"==a?this._showContactZApp():Z.jqm.showZApp(a)},showFloatingAction:function(a,b,c){"contact"==a?this._showContactZApp():Z.jqm.showFloating(a,b,c)},onFocusTextField:function(a,b,c){b==c&&get_zbody().$("#"+a).attr("value","")},onBlurTextField:function(a,b,c){""==b&&get_zbody().$("#"+a).attr("value",c)},_placeCalls:function(a,b,c,d,e,f,g){Platform.placeCall(a,b,c,d,e,f,g)},_placeCallsZebra:function(a,b,c,d,e,f,g){Platform.placeCall(a,b,c,d,e,f,g)},placeCall:function(a,b,c,d,e,f,g){Platform.initiateCall(a,b,c,d,e,f,g,"",null)},initiateCall:function(a,b,c,d,e,f,g,h,i){"undefined"!=typeof CallMUCMembers&&(CallMUCMembers.ignoreGMU=!1);var j=new Zebra("org.zenon.server.zebra.ZebraHandler#placeCall");if(g&&j.setZebraAttribute("username",g),CallManager.recordwb?j.setZEvent("recordwb","true"):j.setZEvent("recordwb","false"),CallManager._record?j.setZEvent("record","true"):j.setZEvent("record","false"),"NONE"==a)j.setZEvent("isP2P","false"),j.setZEvent("type","VIDEO"),j.setZEvent("destination","VIDEODIAL%23"+b),j.setZEvent("videoSize","VGA"),j.setZEvent("width","640"),j.setZEvent("height","480"),ConnectionManager._dispatchEvent("RECORDING_CALL",{type:"none"});else{if(null!=h&&""!=h)webRTC.connectWS(h),h="wrtc:"+h,j.setZEvent("isP2P","true");else{j.setZEvent("isP2P","false");var k=!0;"VOICE"==a&&(k=!1),CallManager._callType="MCU",CallManager.connectToMCU(k)}j.setZEvent("type",a),j.setZEvent("destination",a+"DIAL%23"+b);var l=176,m=144;try{l=zwrtc.in_video_width,m=zwrtc.in_video_height}catch(n){}j.setZEvent("width",l),j.setZEvent("height",m),j.setZEvent("callerVideoWidth",l),j.setZEvent("callerVideoHeight",m)}j.setZEvent("callerVideoCodecs","H264"),j.setZEvent("callerMaxDownload",""),j.setZEvent("callerP2PAddress",h),j.setZEvent("callerAudioCodecs",""),j.setZEvent("client","webrtc"),i&&j.setZEvent("reconnect",i),null==CallManager.httpLegID&&(CallManager.httpLegID=CallManager.generateHttpLegID()),j.setZEvent("http_leg_id",CallManager.httpLegID),CallManager.loadLowBrMode?j.setZEvent("bandwidthMode",CallManager.loadLowBrMode):CallManager.lowBrMode&&j.setZEvent("bandwidthMode",CallManager.lowBrMode),CallManager._arg1.length>0&&j.setZEvent("Arg1",CallManager._arg1),c&&j.setZEvent("chat_session_id",c),ConnectionManager.sendZSZebraCommand("placeCall",j)},downloadURL:function(a,b,c,d,e){var f="";if(b.indexOf("avatar_id=gallery_")>-1){var g=b,h="";if(""!=g){g=g.split("&");for(var i=0;i<g.length;i++)if(g[i].indexOf("avatar_id=gallery_")>-1){h=g[i];break}}f=parent.rootPath+"assets/images/"+h.trim().split("=")[1]+".jpg"}else f=b;c(f,200,"200 OK")},_showTab:function(a){this.log("show tab is called")},setLOGGING:function(a){},showMiniRV:function(a){Platform.log("default.js - showMiniRV called : "+a)},_hideKeyBoard:function(){},_logout:function(){ConnectionManager.logout()},_isCameraAvail:function(){return"false"},getLog:function(){var a="",b=Platform.console_buffer;for(Platform.console_buffer=new Array;b.length>0;)a+=b.shift().replace(/\]/g,")").replace(/\[/g,"(");return a},postLog:function(a){if(Platform.is_uploading)return void(Platform.autoLogDesc?Platform.autoLogDesc=Platform.autoLogDesc+"\n"+a:Platform.autoLogDesc=a);if(Platform.is_uploading=!0,CallManager._flashEnabled&&Platform.console_buffer.length>Platform.console_buffer_flash_max_length){var b="",c=Platform.console_buffer;Platform.console_buffer=new Array;for(var d=0;c.length>0;)if(b+=c.shift().replace(/\]/g,")").replace(/\[/g,"("),d++,d>=Platform.console_buffer_flash_max_length||0===c.length){var e=new Zebra("com.blackboard.saturn.zag.zebra.VideoConference#postLog");e.setZEvent("log","<![CDATA["+b+"]]>"),e.setZEvent("description","<![CDATA["+a+"]]>"),ConnectionManager.sendZebra(e),b="",d=0}}else{var e=new Zebra("com.blackboard.saturn.zag.zebra.VideoConference#postLog");e.setZEvent("log","<![CDATA["+this.getLog()+"]]>"),e.setZEvent("description","<![CDATA["+a+"]]>"),ConnectionManager.sendZebra(e)}},startLogTimer:function(){this.stopLogTimer();var a=this;this.logRollOverTimeout=setInterval(function(){a.writeToLogFile()},this.logRollOverDuration)},stopLogTimer:function(){this.logRollOverDuration&&clearInterval(this.logRollOverTimeout)},writeToLogFile:function(){blob=new Blob([this.getLog()],{type:"octet/stream"}),url=window.URL.createObjectURL(blob),this.a||(this.a=document.createElement("a"),document.body.appendChild(this.a),this.a.style="display: none"),this.a.href=url,this.a.download=ConnectionManager.userId+"_"+ConnectionManager.roomSession+"_console_"+DateTimeUtil.getNow()+".log",this.a.click(),window.URL.revokeObjectURL(url)},logsUploaded:function(){if(Platform.is_uploading=!1,Platform.autoLogDesc){var a=Platform.autoLogDesc;Platform.autoLogDesc=null,Platform.postLog(a)}},bufferLog:function(a){if(Platform.enable_console_buffer){var b=Platform.console_buffer,c=++Platform.console_buffer_lc+" : "+new Date+" : "+a+"\n";b.length>=Platform.console_buffer_max_length?(b.shift(),b.push(c),Platform.saveConsoleLogsLocally&&(Platform.writeToLogFile(),Platform.startLogTimer())):b.push(c)}},log:function(a,b){if(Platform.bufferLog(a),Platform.enable_logging){var c="on";window.DataStore&&(c=DataStore.getUserData("logging_enabled"));var d=!1;navigator.userAgent.indexOf(".NET")>-1&&(d=!0);var e=!(!window.console||!window.console.log);!e||c&&"on"!=c||(window.bbConsole?window.bbConsole.log("From Platform "+new Date+": "+a):console.log("From Platform "+new Date+": "+a))}},_setOutgoingAvatarURL:function(a){},openWebViewURL:function(a){return ConnectionManager.isDisconnected?(ConnectionManager._dispatchEvent("CAN_NOT_COMPLETE_REQUEST",{error_code_string:"no_network"}),!1):void this.openLink(a)},openLink:function(a){if(ConnectionManager.isDisconnected)return ConnectionManager._dispatchEvent("CAN_NOT_COMPLETE_REQUEST",{error_code_string:"no_network"}),!1;var b=a;"http"!=b.substr(0,4)&&(b="http://"+b),window.open(b)},fileShare:function(a,b,c,d,e,f){var g=-10;g+=10,f("done",d,e,c,"200","OK")},_showContactZApp:function(){},contactClickAction:function(a,b){if(Platform.isPod){var c=Z.zjs.ContactModel.getItem(a);if(!c)return;return IM.openSessionWithFQA(c.fqa),void IM._dispatchEvent("OPEN_CHAT_SESSION_WINDOW",{id:Z.zjs.IM.currentSession.group_id})}var d=ContactModel.getItem(a),e=!1;d&&"true"==d.isAgent&&(e=!0),e&&Platform.spm?Z.getZAppController("contact").checkIfAgentProfileLoaded(d.vid,d.fqa):Z.getZAppController("contact").openChatWindow(b)},callDisconnect:function(a){this.log("Rishabh007---> default js inside callDisconnect dispatching MCUD where errorCode="+a),ConnectionManager._dispatchEvent("MCUDISCONNECT",{reason:a})},loadLoginPage:function(){},showHideBackButton:function(a){this.log("is show for back button"+a)},loadProfile:function(a){ConnectionManager._dispatchEvent("LOAD_PROFILE",{vid:a})},changeFreeCallingMobile:function(a){
a("9811517287","OK","200OK")},getFreeCallingMobile:function(a){a("","OK","200OK")},getScreenWidth:function(){return screen.width},updateFreeCallingMobile:function(a){ConnectionManager._dispatchEvent("UPDATE_MOBILE_NUMBER",{mobile_number:a})},contactClickAction:function(a,b){"category"==PartnerConfig.getKey("default_home_page","category")&&(Z.jqm.currentConfiguredZAppTab="category"),"agents"==PartnerConfig.getKey("default_home_page","category")&&(Z.jqm.currentConfiguredZAppTab="agent"),"contact"==PartnerConfig.getKey("default_home_page","category")&&(Z.jqm.currentConfiguredZAppTab="contact");var c=ContactModel.getItem(a),d=!1;c&&"true"==c.isAgent&&(d=!0),d&&Platform.spm?Z.getZAppController("contact").checkIfAgentProfileLoaded(c.vid,c.fqa):(Z.getZAppController("contact").openChatWindowMobile(b),Platform.spm||this._showTab("chats"))},multipartFormUpload:function(a,b,c,d,e,f,g){var h="",i="";for(var j in c)h=""==h?j+"="+encodeURIComponent(c[j]):i+"&"+j+"="+encodeURIComponent(c[j]),i=h;var k;k=f&&""!=f?f:(new Date).getTime(),g&&(this._httpRequestAsyncListeners[k]=g);var h="method="+escape(a)+"?action="+escape(b)+"&params="+h+"&fileTypes="+d+"&uploadType="+e;k&&(h+="&listenerKey="+escape(k)),Platform._ListenerCallbackMultipartFormUpload("home",k,h,"200","200OK")},_ListenerCallbackMultipartFormUpload:function(a,b,c,d,e){var f=this._httpRequestAsyncListeners?this._httpRequestAsyncListeners[b]:null;f&&this._httpRequestAsyncListeners&&delete this._httpRequestAsyncListeners[b];var g,h,i={};c&&""!=c&&(g=c.split("&"));for(var j=0;j<g.length;j++)h=g[j].split("="),i[h[0]]=h[1];a?i.fileLoc=a:i={fileLoc:"/"},ConnectionManager._dispatchEvent("MULTIPART_FORM_UPLOAD_COMPLETE",{request_id:b,file_name:a,params:i,requestStatus:d,requestStatusText:e}),f&&f(a,b,i,d,e)},openSessionDesktopNotification:function(a,b){ConnectionManager._dispatchEvent("OPEN_SESSION_FOR_NOTIFICATIONS",{csi:a,id:b}),window.resizeTo(window.document.width,window.document.height),window.focus(),ConnectionManaget._dispatchEvent("HIDE_DESKTOP_NOTIFICATIONS")},zalert:function(a,b,c,d){b&&(b=b.split("<br/>").join("\n").split("<br>").join("\n")),""==Platform.default_title&&(Platform.default_title=defaultTitle||"..."),document.title=b;var e=4;c&&(e=c);var f=(new Date).getTime();Platform.init_code=f;var g={};d&&"null"!=d&&(g.chat_session_id=d.chat_session_id,g.id=d.id,g.callBackListener=function(a,b){Platform.openSessionDesktopNotification(a,b)}),znotify(a,b,g,null,null,null),setTimeout(function(){document.title="..."},300),setTimeout(function(){document.title=b},600),setTimeout(function(){document.title="..."},900),setTimeout(function(){document.title=b},1200),setTimeout(function(){Platform.init_code==f&&(document.title=Platform.default_title)},1e3*e)},zp_yt_load:function(a,b){ConnectionManager._dispatchEvent("ZP_YT_LOAD",{url:a,owner:b})},zp_yt_play:function(a,b){ConnectionManager._dispatchEvent("ZP_YT_PLAY",{url:a,offset:b})},zp_yt_stop:function(){ConnectionManager._dispatchEvent("ZP_YT_STOP",{})},createProfileClick:function(){setTimeout(function(){Z.jqm.loadTopZApp("settings","1")},5e3)},isSpmAccess:function(){var a=!1;return"undefined"!=typeof readCookie&&(a=readCookie("spm_access")),a&&"null"!=a&&"false"!=a||(a=!1),a},showHideBackButton:function(a){ConnectionManager._dispatchEvent("SHOW_HIDE_BACK_BUTTON",{isShow:a})},updateZSState:function(a){"disconnected"==a&&ConnectionManager.zsState!=a?ConnectionManager.isDisconnected=!0:ConnectionManager.isDisconnected=!1},upgradeApp:function(a){this.log("upgrade app url called**:"+a)},enableUpgrade:function(a,b){ConnectionManager._dispatchEvent("UPDATE_AVAILABLE",{major:a,minor:b})},showBGNotification:function(a){this.log("showing BG notification")},bringAppToForeground:function(){this.log("bringing app to foreground")},playIncoming:function(a){var b=a?a:5;this.log("playing sound for seconds:"+b)},enableForcedMute:function(){ConnectionManager._dispatchEvent("EnableForcedMute"),this.log("EnableForcedMute")},disableForcedMute:function(){ConnectionManager._dispatchEvent("DisableForcedMute"),this.log("DisableForcedMute")},enableForcedMuteCam:function(){ConnectionManager._dispatchEvent("EnableForcedMuteCam"),this.log("EnableForcedMuteCam")},disableForcedMuteCam:function(){ConnectionManager._dispatchEvent("DisableForcedMuteCam"),this.log("DisableForcedMuteCam")},enableForcedMuteScreenShare:function(){ConnectionManager._dispatchEvent("EnableForcedMuteScreenShare"),this.log("EnableForcedMuteScreenShare")},disableForcedMuteScreenShare:function(){ConnectionManager._dispatchEvent("DisableForcedMuteScreenShare"),this.log("DisableForcedMuteScreenShare")},getClientObjectPlaySoundFunction:function(){var a;if(webrtc_enabled)a=zwrtc.playSound;else if(isFlashClientLoaded()){var b=getClientObj();b&&(a=b.playAudioFile)}return a},getClientObjectStopSoundFunction:function(){var a;if(webrtc_enabled)a=zwrtc.stopSound;else if(isFlashClientLoaded()){var b=getClientObj();b&&(a=b.stopAudioFile)}return a},playWarning:function(a){Platform.spm||(zwrtc.playSound("/ZMobile/Apps/Saypage/assets_saypage/media/warning.mp3",!0),setTimeout(function(){zwrtc.stopSound()},1e3*a))},stopSound:function(){var a=Platform.getClientObjectStopSoundFunction();a&&(webrtc_enabled?a():getClientObj().stopAudioFile())},playReminder:function(a){Platform.spm||(zwrtc.playSound("/ZMobile/Apps/Saypage/assets_saypage/media/reminder.mp3",!0),setTimeout(function(){zwrtc.stopSound()},1e3*a))},showInCallMessage:function(a,b,c){c&&(c=1e3*c),Platform.showMessage(a,b,!1,c)},browseClick:function(){ConnectionManager._dispatchEvent("BROWSE_CLICKED")},switchToNLView:function(a){return!1},blockTabs:function(){Platform.log("block tabs called")},releaseTabs:function(){Platform.log("release tabs called")},callExecuted:function(){Platform.log("callExecuted *******"),ConnectionManager._dispatchEvent("CALL_EXECUTED")},finishedLoading:function(){Platform.log("finished zcomm noframes loading - onload***")},showWaitingIcon:function(a){},useBeepDialing:function(a,b,c){Platform.spm||(zwrtc.stopSound(),zwrtc.playSound("/ZMobile/Apps/Saypage/assets_saypage/media/beep_24.mp3",!0,5e3),Platform.showModalOrMessage(a,b,null,!1,null,null,null,!1,1e3*c,"OK",!1,null,!0,!1,!0))},playDTMF:function(a,b){var c="DMF_";Platform.dtmfTimeoutId&&clearTimeout(Platform.dtmfTimeoutId),b||(b=1e4),"#"==a?(c="DTMF_hash.mp3",zwrtc.playSound("/ZMobile/Apps/Saypage/assets_saypage/media/"+c,!0)):"*"==a?(c="DTMF_star.mp3",zwrtc.playSound("/ZMobile/Apps/Saypage/assets_saypage/media/"+c,!0)):(c="DTMF_"+a+".mp3",zwrtc.playSound("/ZMobile/Apps/Saypage/assets_saypage/media/"+c,!0)),Platform.dtmfTimeoutId=setTimeout(function(){zwrtc.stopSound()},1e3*b)},stopIncoming:function(){Platform.log("Stopping Incoming Ringing****************")},dialToRoomWithId:function(a){Platform.log("dialing to room **********************"+a);var b=EventsModel.getItem(a);Platform.log("item from event model found**"+b),b||(b=EventsAppointmentsModel.getItem(a)),Platform.log("item from schedule model found ***"+b),b&&(Platform.log("item found ***"),Platform.dialRoom(b.vid_owner,b.id,b.destination,b.medium,GeneralUtils.escapeSpecialChars(b.title),GeneralUtils.escapeSpecialChars(b.description),b.ivr_access,GeneralUtils.escapeSpecialChars(b.name_owner)))},dialRoom:function(a,b,c,d,e,f,g,h){var i=frames.mainframe;if(!i)return!1;i.open_communicator(!0);var j=!0;standard_cockpit||(isRoom101=!0,j=!1),CallMUCMembers&&(CallMUCMembers.directDialToRoom=!0);var k=function(){e&&(frames.communicator.$("#cockpit_event_title_id").text(e),frames.communicator.$("#cockpit_event_name_id").text("with "+h),g&&g.length>1?frames.communicator.$("#cockpit_event_ivr_id").text("Tel: "+g):frames.communicator.$("#cockpit_event_ivr_id").text(""),frames.communicator.$("#cockpit_event_photo_id").attr("src","/_util/get_picture.jsp?width=640&height=480&vid_host="+a+"&event_id="+b),$("#frame_header_share").attr("src","/events/inc/shareX.jsp?vid="+a+"&id="+b+"&owner="+encodeURIComponent(h)+"&title="+encodeURIComponent(e)+"&description="+encodeURIComponent(f)),showEventHeader(a)),InQueueModel.startCall(a,d,parent.parent.document.location.href+"&call_type="+d,"","",c),CallMUCMembers.inRoom=!0,InQueueModel.roomReDial=!1,frames.communicator.cockpit_init?j?goRoom101():ConnectionManager._dispatchEvent("SHOW_WHITEBOARD",!0):frames.communicator.post_init_function=function(){j?goRoom101():ConnectionManager._dispatchEvent("SHOW_WHITEBOARD",!0)}};isWebClientLoaded()?k():ConnectionManager.addListener("WEB_CLIENT_READY","platform",function(a){k()},!0)},showCallersList:function(){Platform.log("showCallersList ***")},showMessageX:function(a,b,c,d){Platform.showMessage(a,b,c,null,d)},showMessage:function(a,b,c,d,e,f){if(CallManager.zui)return void CallManager.zui.showMessage(a,b,c,e);if(Platform.isSayPageApp){var g=!1;"undefined"!=typeof readCookie&&(g=readCookie("spm_access")),g&&"null"!=g&&"false"!=g||(g=!1),g||Platform.showModalOrMessage(a,b,f,c,e,null,null,!1,d)}else f&&"undefined"!=typeof ZLocaleDialog&&(b=ZLocaleDialog.getMessage(f,b)),Z.jqm.showAlertMessage(b,d,e)},showModalOrMessage:function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){return CallManager.zui?CallManager.zui.showMessage(a,b,d,e,f,g,h,i,j,k,m,n):Z.zjs.Platform.isSayPageApp?(c&&"undefined"!=typeof ZLocaleDialog&&(a=ZLocaleDialog.getTitle(c,a),b=ZLocaleDialog.getMessage(c,b)),o?Z.zjs.showMessage(a,b,d,e,f,g,h,i,j,k,m,n):Z.zjs.showModal(a,b,d,e,f,g,h,i,j,k,l,m,n)):(c&&"undefined"!=typeof ZLocaleDialog&&(b=ZLocaleDialog.getMessage(c,b)),Z.jqm.showAlertMessage(b,i,e)),Platform.dialogId=(new Date).getTime(),Platform.dialogId},closeDialog:function(a){!a||a&&a!=Platform.dialogId||Z.zjs.hideModal()},isAudioMuted:function(){return"undefined"!=typeof webRTC?webRTC.isAudioMuted:null},isVideoMuted:function(){return"undefined"!=typeof webRTC?webRTC.isVideoMuted:null}};EventDispatcher=Class.extend({init:function(){this._eventListeners={}},_addListener:function(a,b,c,d){try{this._eventListeners[a]||(this._eventListeners[a]=[]),d&&this._removeListener(a,b);for(var e=0;e<this._eventListeners[a].length;e++)if(this._eventListeners[a][e]==[b,c])return;this._eventListeners[a].push([b,c])}catch(f){Platform.log("CAUGHT2 EXCEPTION "+f)}},_removeListener:function(a,b,c){if(this._eventListeners[a])for(var d=0;d<this._eventListeners[a].length;d++)try{if(this._eventListeners[a][d][0]==b&&(!c||this._eventListeners[a][d][1]==c))return void this._eventListeners[a].splice(d,1)}catch(e){this._eventListeners[a].splice(d,1)}},_removeAllListenersForEvent:function(a){if(this._eventListeners[a])for(var b=0;b<this._eventListeners[a].length;b++)this._eventListeners[a].splice(b,1)},_removeAllListeners:function(){this._eventListeners={}},_dispatchEvent:function(a,b){var c=this._eventListeners[a];if(c){c=c.slice();for(var d=0;d<c.length;d++)try{c[d][1].apply(c[d][0]||this,[b])}catch(e){}}}}),DataStore=EventDispatcher.extendAsSingleton({loadedCommonStore:!1,loadedUserStore:!1,modelsLoaded:0,commonStoreCache:{},userStoreCache:{},isloadedEventDispatched:!1,models:["defaultModel","contactModel","frModel","im_sessions_list","recentModel","libraryModel","recordingModel"],anchorModels:["ContactModel","RecentModel","LibraryModel","RecordingModel"],Event:{LOADED_DATA_STORE:"LOADED_DATA_STORE",CLEARED_COMMON_STORE:"CLEARED_COMMON_STORE",CLEARED_USER_STORE:"CLEARED_USER_STORE"},init:function(){this._super(),this.addListener=this._addListener,this.removeListener=this._removeListener;for(var a,b,c=this,d=function(){if(Platform.log("DS:onDataStoreLoad - "+c.loadedUserStore+" - 1"),!c.loadedUserStore){c.loadedCommonStore=!0,c.loadedUserStore=!0;var d=document.location.href.split("?")[1];if(d&&""!=d){d=d.split("&");for(var e,f=c.getCommonData("last_loginid"),g=0;g<d.length;g++)e=d[g].split("="),"common-last_loginid"!=e[0]||f&&""!=f&&f==unescape(e[1])||(c.clearCommonDataStore(),c.clearUserDataStore());for(var g=0;g<d.length;g++)e=d[g].split("="),"common-"==e[0].substring(0,7)?c.setCommonData(e[0].substring(7),unescape(e[1]),!0):c.setUserData(e[0],unescape(e[1]),!0)}Platform.log("dispatching event for DS loaded"),c._dispatchEvent(c.Event.LOADED_DATA_STORE,{commonStoreError:a,userStoreError:b})}},e=function(a){return this.callOnDataStoreLoad=function(){c.modelsLoaded==c.models.length&&d()},this.process=function(b,e){if("defaultModel"==a){var f;for(var g in b)f=""+g,c.userStoreCache[g]||(c.userStoreCache[g]=unescape(b[g]))}else{var f,h,i="",j=[];for(var g in b)if(f=""+g,"anchor"!=f){try{h=JSON.parse(unescape(b[g]))}catch(k){Platform.log("DS json parsing error for key:"+g+"  value :"+b[g])}j.push(h)}else i=b[g];var l={anchor:i,propsList:j},m=JSON.stringify(l),n="model_"+a;c.userStoreCache[n]=m}c.modelsLoaded+=1,Platform.log("DS:model loaded - "+a+" - 9"),c.modelsLoaded==c.models.length&&d()},this},f=0;f<c.models.length;f++){var g=c.models[f];Platform.papi("model_"+g).load(e(g).process)}},onReady:function(a){DataStore.loadedCommonStore&&DataStore.loadedUserStore?a():DataStore.addListener(DataStore.Event.LOADED_DATA_STORE,this,a)},getCommonData:function(a,b){return this.getUserData(a,b)},setCommonData:function(a,b,c,d){this.setUserData(a,b,c,d)},clearCommonDataStore:function(a){},getUserData:function(a,b){return this.userStoreCache[a]||b},setUserData:function(a,b,c,d){if(this.userStoreCache[a]=b,c&&"string"==typeof b){var e={};e[a]=escape(b),Platform.papi("model_defaultModel").addOrUpdateItems(e)}},clearUserDataStore:function(a){Platform.log(" clearUserDataStore  DataStore.js "),this.userStoreCache={},that=this,that.modelsLoaded=this.models.length,Platform.papi("model_defaultModel").clearModel();for(var b=0;b<this.anchorModels.length;b++){var c=this.anchorModels[b];window[c]&&(Platform.log(" Clearing anchor "+c),window[c].anchor="")}for(var b=0;b<this.models.length;b++){var c=this.models[b];Platform.papi("model_"+c).clearModel(function(b){that.modelsLoaded-=1,0==that.modelsLoaded&&(DataStore._dispatchEvent(DataStore.Event.CLEARED_USER_STORE,b),a&&a(b))})}}}),EventsManager=EventDispatcher.extendAsSingleton({init:function(){this._super(),this.addListener=this._addListener,this.removeListener=this._removeListener,this.dispatchEvent=this._dispatchEvent}}),Zebra=Class.extend({init:function(a,b,c){this.zebraAttributes={username:DataStore.getUserData("username",""),userId:ConnectionManager.userId,roomSession:ConnectionManager.roomSession,seq:ConnectionManager.userId+""+(new Date).getTime()},a&&(this.zebraAttributes.event=a),this.zebraAttributes.service=b||ConnectionManager.service||"zenon",this.zebraAttributes.partner=c||ConnectionManager.partner,this.zConfigs={},this.zEvents={}},setZebraAttribute:function(a,b){return this.zebraAttributes[a]=b||"",this},setZConfig:function(a,b,c){return this.zConfigs[a]={name:a||"",value:b||"",mode:c||""},this},setZEvent:function(a,b,c){return this.zEvents[a]={name:a||"",value:b||"",mode:c||""},this},getZebraAttribute:function(a){return this.zebraAttributes[a]},getZConfig:function(a){return this.zConfigs[a]},getZEvent:function(a){return this.zEvents[a]},getZEventValue:function(a,b){var c=this.zEvents[a]?this.zEvents[a].value:null;return c&&""!=c?c:b||""},toXML:function(){if(this.xmlString)return this.xmlString;var a="";for(var b in this.zebraAttributes)a+=" "+b+"='"+this.zebraAttributes[b]+"'";var c="";for(var d in this.zConfigs){var e=this.zConfigs[d];c+="\t\t<"+e.name+(e.mode?" mode='"+e.mode+"'>":">")+e.value+"</"+e.name+">\n"}var f="";for(var d in this.zEvents){var g=this.zEvents[d];f+="\t\t<"+g.name+(g.mode?" mode='"+g.mode+"'>":">")+g.value+"</"+g.name+">\n"}if(this.list&&this.list.items)for(var h=0;h<this.list.items.length;h++){var i=this.list.items[h],j=[];for(var k in i)j.push(k+"='"+i[k]+"'");f+="\t\t<obj "+j.join(" ")+" />\n"}return"<?xml version='1.0' encoding='UTF-8'?><zebra"+a+">\n\t<zconfig>\n"+c+"\t</zconfig>\n\t<zevent>\n"+f+"\t</zevent>\n</zebra>"}}),Zebra.parseFromStringZMobile3=function(a){if(!a||0==a.length)return null;var b;window.DOMParser?(parser=new DOMParser,b=parser.parseFromString(a,"text/xml")):(b=new ActiveXObject("Microsoft.XMLDOM"),b.async="false",b.loadXML(a));for(var c=b.getElementsByTagName("zebra"),d=b.getElementsByTagName("message"),e=[],f=0;f<c.length;f++){var g=Zebra.processZebraFromNode(c[f]);g&&e.push(g)}for(var h=[],f=0;f<d.length;f++){var i=d[f].childNodes[0].nodeName,j=d[f].childNodes[0].firstChild?d[f].childNodes[0].firstChild.nodeValue:null,k=null;j&&d[f].childNodes.length>1&&(k=d[f].childNodes[1].firstChild?d[f].childNodes[1].firstChild.nodeValue:null),k?h.push(i+"\n"+j+"\n"+k):j?h.push(i+"\n"+j):h.push(i)}return{zebras:e,commands:h}},Zebra.parseFromString=function(a){if(!a||0==a.length)return null;var b;window.DOMParser?(parser=new DOMParser,b=parser.parseFromString(a,"text/xml")):(b=new ActiveXObject("Microsoft.XMLDOM"),b.async="false",b.loadXML(a));var c=b.getElementsByTagName("zebra")[0],d=Zebra.processZebraFromNode(c);return d&&(d.xmlString=a),d},Zebra.processZebraFromNode=function(a){(new Date).getTime();if(!a||!a.getAttribute("event")||0==a.getAttribute("event").length)return null;for(var b=new Zebra(""),c=a.attributes,d=0;d<c.length;d++)b.setZebraAttribute(c[d].nodeName,c[d].nodeValue);var e=a.getElementsByTagName("zconfig")[0];if(e){e=e.childNodes;for(var d=0;d<e.length;d++)b.setZConfig(e[d].nodeName,e[d].text||e[d].textContent||"",e[d].getAttribute("mode")||"")}var f=a.getElementsByTagName("zevent");if(f[0]){var g=f[0].getAttribute("list_mode");g&&""!=g&&(b.list={mode:g,items:[]}),f=f[0].childNodes;for(var d=0;d<f.length;d++)if("obj"==f[d].nodeName){b.list&&b.list.mode&&b.list.items||(b.list={mode:"",items:[]});for(var h={},i=f[d].attributes,j=0;j<i.length;j++)h[i[j].nodeName]=i[j].text||i[j].textContent||"";b.list.items.push(h)}else{var k="";"undefined"!=typeof f[d].getAttribute&&(k=f[d].getAttribute("mode")),b.setZEvent(f[d].nodeName,f[d].text||f[d].textContent||"",k)}}return b},ConnectionManager=EventDispatcher.extendAsSingleton({build_version:"@BUILD_VERSION@",build_minor_version:"@BUILD_MINOR_VERSION@",build_major_version:"@BUILD_MAJOR_VERSION@",LOAD_CLONE_CLIENT_IN_ENDPOINT:!0,AUTOLOGIN_ON_NSDISCONNECT_EXPIRE:!1,POLL_ACTUAL_ENDPOINT:!0,WS_AUTH_ERROR:4e3,WS_EXIST:4001,WS_NOT_RESPONDING:4002,WS_RE_MAX_TRY:"WS4001",WS_RE_MAX_TO:"WS4002",WS_RE_DISABLED:"WS4003",ZEBRA_FMT:"2.0",service:"use_room_session",partner:"blackboard",CLS:document.location.href.split("/").slice(0,3).join("/"),zsPollIsScheduled:!1,stopZSPoll:!0,Brora:"/servlet/com.requestec.smg.servlets.Brora",ZebraGateway:"/servlet/com.requestec.smg.servlets.ZebraGateway",ZSServlet:"/zmobile3",isDisConnected:!1,_staticRoute:null,_ws:null,enableWS:!0,wsPossible:!1,doBlackboard:!0,avsdkServlet:"/ws/avsdk/",roomSession:"",authToken:"",userId:"",groupId:"",useRoomAndUserid:!1,zsZebraGateway:"org.zenon.server.zebra.ZebraHandler",saturnZebraGateway:"com.blackboard.saturn.zag.zebra.VideoConference",loginSuccessDispatched:!1,zebraDebugCounter:0,webRTCBrowser:null,ffDisableTechCheck:!0,ffMinVer:41,iceConnFailCount:0,iceConnFailTh:5,videoSlotsActive:0,videoSlotsActiveFF:0,libInitialized:!1,logEnabled:!1,useConnectZebra:!0,pendingMessages:[],stopCameraTrack:!0,isUsingPlugin:!1,allowMediaCall:!1,wsReconnect:!0,reconnectTriesTh:8,reconnectMaxTimeSeconds:75e3,reconnectDelay:1e4,reconnectTries:0,disconnectTime:0,lastPongTime:0,lastPongRecvdTime:0,ignoreAuthError:!1,PING_INTERVAL:15e3,Event:{LOADING_CLONE:"LOADING_CLONE",LOGIN_SUCCESS:"LOGIN_SUCCESS",WEBSOCKET_CONNECT:"WEBSOCKET_CONNECT",WEBSOCKET_CLOSED:"WEBSOCKET_CLOSED",LOGIN_FAILED:"LOGIN_FAILED",CONNECTION_LOST:"CONNECTION_LOST",CONNECTION_MADE:"CONNECTION_MADE",LOGGED_OUT:"LOGGED_OUT",ZS_STATE_CHANGED:"ZS_STATE_CHANGED",ZS_STATE_UPDATE:"ZS_STATE_UPDATE",ZEBRA:function(a){return"ZEBRA:"+a}},init:function(){"undefined"!=typeof service&&(this.service=service),"undefined"!=typeof partner&&(this.partner=partner),this._super(),this.addListener=this._addListener,this.removeListener=this._removeListener,this.removeAllListenersForEvent=this._removeAllListenersForEvent,this.zsState=null,this.doBlackboard||(this.addListener("LOGIN_SUCCESS","CONNECTION_MANAGER",function(a){var b=DataStore.getUserData("epoch_time","-1");"-1"!=b&&DateTimeUtil&&DateTimeUtil.setEpochOffset(b)},!0),this.addListener("ZEBRA:GOOLEY","CONNECTION_MANAGER",function(a){console.warn("GOT IT")},!0),this.addListener("ZEBRA:AVATAR_UPDATE","CONNECTION_MANAGER",function(a){var b=a.getZEvent("avatar_id").value,c=DataStore.getUserData("vid");DataStore.setUserData("avatar_id",b),(!b||""==b||b.indexOf("empty")>-1)&&(b="profile_empty");var d="";d=Platform.spm||Platform.isSayPageApp?ConnectionManager.getBasePictureURL()+"&pic=1&vid="+c+"&avatar_id="+c+"_"+b:ConnectionManager.getBasePictureURL()+"&email="+DataStore.getUserData("email","")+"&type=zen&avatar_id="+c+"_"+b,Platform.downloadURL("GET",d,function(a,d,e){""!=a&&(DataStore.setUserData("avatarurl",a),ConnectionManager._dispatchEvent("AVATAR_UPDATED",{vid:c,avatar_id:b,avatarurl:a}))},!0)}))},getBrowser:function(){var a,b=navigator.userAgent,c=b.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];if(/trident/i.test(c[1]))return a=/\brv[ :]+(\d+)/g.exec(b)||[],"IE "+(a[1]||"");if("Chrome"===c[1]){if(a=b.match(/\bOPR\/(\d+)/),null!=a)return["Opera",a[1]];if(a=b.match(/\bEdge\/(\d+)/),null!=a)return["Edge",a[1]];if(a=b.match(/\bEdg\/(\d+)/),null!=a)return["Edge (chromium)",a[1]]}return c=c[2]?[c[1],c[2]]:[navigator.appName,navigator.appVersion,"-?"],null!=(a=b.match(/version\/(\d+)/i))&&c.splice(1,1,a[1]),c},detectOS:function(){this._os="UNKNOWN";var a=navigator.appVersion;a&&(a.indexOf("Win")!=-1&&(this._os="WIN"),a.indexOf("Mac")!=-1&&(this._os="MAC"),navigator.appVersion.indexOf("X11")!=-1&&(this._os="UNIX"),a.indexOf("Linux")!=-1&&(this._os="LINUX"))},getMobileOS:function(){var a=navigator.userAgent||navigator.vendor;return/windows phone/i.test(a)?"Windows Phone":/android/i.test(a)?"Android":/iPad|iPhone|iPod/.test(a)&&!window.MSStream?"iOS":"unknown"},isMobile:function(){var a=navigator.userAgent||navigator.vendor;return!!/android/i.test(a)||!(!/iPad|iPhone|iPod/.test(a)||window.MSStream)},canStopCameraTrack:function(){return this.stopCameraTrack},isChrome:function(){var a=ConnectionManager.getBrowser()[0].toUpperCase();return"CHROME"===a||"EDGE (CHROMIUM)"===a},isFF:function(){return"FIREFOX"===ConnectionManager.getBrowser()[0].toUpperCase()},isOpera:function(){return"OPERA"===ConnectionManager.webRTCBrowser&&!ConnectionManager.isUsingPlugin},isSafari:function(){return"SAFARI"===ConnectionManager.webRTCBrowser&&!ConnectionManager.isUsingPlugin},isEdge:function(){return"MS-EDGE"===ConnectionManager.webRTCBrowser||"EDGE"===ConnectionManager.webRTCBrowser},getDisplayMediaSupported:function(){return"getDisplayMedia"in window.navigator},isWebRTCSupported:function(){if(ConnectionManager.isUsingPlugin)return!0;var a=navigator.userAgent;if(null!=a){var b=this.getBrowser(),c=b[0],d=b[1];if(d)try{d=parseInt(d)}catch(e){d=0}if(this.webRTCBrowserVersion=d,c)if(c=c.toLowerCase(),c.indexOf("edge")>-1);else{if(c.indexOf("chrome")>-1)return!0;if(c.indexOf("firefox")>-1&&d>=this.ffMinVer)return!0}}return!1},checkIfPluginUpdateRequired:function(){var a=AdapterJS.WebRTCPlugin.plugin.version,b=AdapterJS.WebRTCPlugin.pluginInfo.version;return!(!AdapterJS.WebRTCPlugin.pluginInfo.forceUpdate||SDPUtils2.versionCompare(a,b)!==-1)},initBB:function(a,b,c,d,e){if(ConnectionManager.doBlackboard=!0,ConnectionManager.useRoomAndUserid=!0,AVSDKErrors.init(),this.saturnURL=a,this.authToken=b,c.indexOf(".")===-1&&e>0?this.roomSession=c+"."+e:this.roomSession=c,this.userId=d,this.zsZebraGateway=this.saturnZebraGateway,DataStore.setUserData("username",d.toString(),!0),DataStore.setUserData("service","saturn",!0),window.AdapterJS=window.AdapterJS||{},AdapterJS&&AdapterJS.WebRTCPlugin&&AdapterJS.WebRTCPlugin.plugin){var f=this;return void AdapterJS.webRTCReady(function(a){f.log("AdapterJS.webRTCReady: isUsingPlugin = "+a),ConnectionManager.isUsingPlugin=a,AdapterJS.WebRTCPlugin.setLogLevel&&AdapterJS.WebRTCPlugin.setLogLevel("VERBOSE"),a?f.checkIfPluginUpdateRequired()?(AdapterJS.TEXT.PLUGIN.REQUIRE_INSTALLATION="This website requires you to update the "+AdapterJS.WebRTCPlugin.pluginInfo.companyName+" WebRTC Plugin to work on this browser.",AdapterJS.TEXT.PLUGIN.BUTTON="Update Now",AdapterJS.WebRTCPlugin.pluginNeededButNotInstalledCbPriv()):(f.webRTCBrowser="TEMASYS_PLUGIN",f.webRTCBrowserVersion=AdapterJS.WebRTCPlugin.plugin.version):f.initFlash(),f.detectOS(),f.autoLogin()})}if(null!==CallManager.rtcBrowsers){if(CallManager._flashEnabled)if(CallManager.forceWebRTC){var g=this.getBrowser(),h=g[0],i=g[1];if(i)try{i=parseInt(i)}catch(j){i=0}this.webRTCBrowserVersion=i,h?this.webRTCBrowser=h.toUpperCase():this.webRTCBrowser="UNKNOWN"}else this.initFlash();else this.isChrome()&&this.webRTCBrowserVersion>=50&&(ssController.systemAudioEnabled=!0);this.detectOS()}else if(!CallManager._flashEnabled){var k=navigator.userAgent;if(null!=k){var g=this.getBrowser(),h=g[0],i=g[1];if(i)try{i=parseInt(i)}catch(j){i=0}this.webRTCBrowserVersion=i,CallManager.forceWebRTC?h?this.webRTCBrowser=h.toUpperCase():this.webRTCBrowser="UNKNOWN":h?(h=h.toLowerCase(),h.indexOf("edge")>-1?this.initFlash():h.indexOf("chrome")>-1?(this.webRTCBrowser="CHROME",i>=50&&(ssController.systemAudioEnabled=!0)):CallManager.enableFFRTC&&h.indexOf("firefox")>-1?i>=this.ffMinVer?this.webRTCBrowser="FIREFOX":(ConnectionManager._dispatchEvent("WEBRTC_DISABLED",{reason:"FF_VERSION_ERROR",ver:i,minVer:this.ffMinVer}),this.initFlash()):this.initFlash()):k.indexOf("Chrome")!=-1||k.indexOf("chromeframe")!=-1?this.webRTCBrowser="CHROME":CallManager.enableFFRTC?this.webRTCBrowser="FIREFOX":this.initFlash(),this.detectOS()}}this.autoLogin()},initFlash:function(){CallManager._flashEnabled=!0,Platform.console_buffer_max_length=3900,swfobject.checkVersion()},inCall:function(){var a=!1;return"undefined"!=typeof getClientObj&&"function"==typeof getClientObj&&getClientObj()&&getClientObj().getState&&"connected"==getClientObj().getState()&&(a=!0),Platform.isSayPageApp&&("undefined"!=typeof MyLiveModel&&MyLiveModel.items.length>0||a)||"busy"==ConnectionManager.zsState},getPartnerLogo:function(a){return unescape(this.CLS||"")+"/servlet/com.requestec.smg.servlets.Avatar?command=get_partner_logo&service="+this.service+"&partner="+a},getBasePictureURL:function(){return Platform.spm||Platform.isSayPageApp||Platform.mobileWeb?unescape(this.CLS||"")+"/servlet/com.requestec.smg.servlets.Avatar?command=get_picture&service="+this.service+"&partner="+this.partner+"&height="+(Platform.isSayPageApp||Platform.getScreenWidth()>600?240:120)+"&width="+(Platform.isSayPageApp||Platform.getScreenWidth()>600?320:160)+"&cropToFit=true":unescape(this.CLS||"")+"/servlet/com.requestec.smg.servlets.Avatar?command=getAvatar&format=jpg&service="+this.service+"&username="+DataStore.getUserData("username","")+"&height="+(Platform.isSayPageApp||Platform.getScreenWidth()>600?240:120)+"&width="+(Platform.isSayPageApp||Platform.getScreenWidth()>600?320:160)+"&cropToFit=true"},getAvatarUrlByVid:function(a){var b=!1;DataStore.getUserData("vid")==a&&(b=!0);var c;if(b)c=DataStore.getUserData("avatarurl");else{var d=AgentsModel?AgentsModel.getAgent(a):null;d||(d=ContactModel?ContactModel.getContactByVid(a):null),c=d?d.avatarurl:ConnectionManager.getBasePictureURL()+"&pic=1&vid="+a}return c},isPolling:function(){return!this.stopZSPoll},isLoggedIn:function(){return this.doBlackboard?this.loginSuccessDispatched:""!=DataStore.getUserData("username","")&&""!=DataStore.getUserData("device_id","")},isConnectedToZS:function(){return"disconnected"!=ConnectionManager.zsState},register:function(a,b,c,d){var e=new Zebra("com.requestec.smg.zebra.Gateway#register").setZEvent("login_id",a).setZEvent("password",b).setZEvent("screenName",c&&""!=c?c:a).setZEvent("zebra_format",ConnectionManager.ZEBRA_FMT);Platform.httpRequest("POST",(ConnectionManager.CLS||"")+(ConnectionManager.ZebraGateway||""),ConnectionManager._loginHandler,"message="+escape(e.toXML()))},locateAndLogin:function(a,b,c,d,e){a&&""!=a&&DataStore.getCommonData("last_loginid")==a||(ConnectionManager.log(" CM locateAndLogin "+DataStore.getCommonData("last_loginid")+" "+a+" CLEAR STORES "),DataStore.clearCommonDataStore(),DataStore.clearUserDataStore()),DataStore.setCommonData("last_loginid",a,!0),DataStore.setCommonData("password",b,!0);var f=function(){d&&DataStore.setUserData("username",d,!0);var c=new Zebra("com.requestec.smg.zebra.Gateway#login");c.setZebraAttribute("partner",ConnectionManager.partner),e&&c.setZEvent("silentPair",e),c.setZEvent("login_id",a),c.setZEvent("offset_mins",DateTimeUtil.getLocalTimeZoneOffsetMinutes()),c.setZEvent("tz_name",DateTimeUtil.getLocalTimeZoneDisplayString()),c.setZEvent("password",b),c.setZEvent("zebra_format",ConnectionManager.ZEBRA_FMT),Platform.httpRequest("POST",(ConnectionManager.CLS||"")+(ConnectionManager.ZebraGateway||""),ConnectionManager._loginHandler,"message="+escape(c.toXML()))};ConnectionManager.doBlackboard||f()},autoLogin:function(){DataStore.setUserData("time_format","12"),DataStore.setUserData("date_format","mm-dd-yyyy");var a=DataStore.getUserData("username",""),b="zjsdk.username."+(ConnectionManager.service||"");return this.eraseCookie(b),this.createCookie(b,a,1),this.stopZSPoll=!1,this.log("autoLogin"),this.enableWS?this._ws?(this._ws.close(),this._ws=null):this.wsConnect():(this.zsPoll(),this._dispatchEvent(this.Event.LOGIN_SUCCESS)),!0},releaseMonaPort:function(){if(CallManager._flashEnabled&&CallManager.mcuURLUpdated&&"50000"!==flashClient._rtmfpPort){var a=new Zebra("com.blackboard.zs.zebra.ZebraHandler#releaseMonaPort");a.setZEvent("port",flashClient._rtmfpPort),this.sendZebraViaZS(a)}},stopZsPolling:function(){this.log("stopZsPolling"),this.stopZSPoll=!0,this.releaseMonaPort(),this.stopTTLTimer(),this.enableWS&&this._ws&&(this._ws.close(),this._ws=null)},logout:function(a){this.stopZsPolling(),DataStore.clearUserDataStore(function(b){ConnectionManager._disconnectZSState(a),ConnectionManager._dispatchEvent(ConnectionManager.Event.LOGGED_OUT,a)})},_loginHandler:function(a,b,c){if(200==b){this.log("Zebra parsing start time -   "+new Date);var d=Zebra.parseFromString(a);if(this.log("Zebra parsing end time -   "+new Date),d&&"0"==(d.getZebraAttribute("error_code")||"0")){var e=d.getZEvent("endpoint").value;DataStore.setUserData("time_format","12"),DataStore.setUserData("date_format","mm-dd-yyyy");for(var f in d.zEvents)if("error_message"!=f)if("endpoint"==f){var g=d.getZEventValue(f);g.indexOf(":")>-1&&(g=g.substring(0,g.indexOf(":"))),ConnectionManager.CLS.indexOf("https")>-1?DataStore.setUserData(f,"https://"+g,!0):DataStore.setUserData(f,"http://"+g,!0)}else DataStore.setUserData(f,d.getZEventValue(f),!0);var h=ConnectionManager.getBasePictureURL();h+=Platform.spm||Platform.isSayPageApp||Platform.mobileWeb?"&pic=1&vid="+DataStore.getUserData("vid")+"&avatar_id="+DataStore.getUserData("vid")+"_"+DataStore.getUserData("avatar_id").replace("/","_"):"&avatar_id="+DataStore.getUserData("avatar_id","").replace("/","_")+"&type=zen",DataStore.getUserData("avatar_id","").indexOf("gallery_")>-1&&(parent.rootPath||(parent.rootPath="/"),h=parent.rootPath+"assets/images/"+DataStore.getUserData("avatar_id","")+".jpg"),DataStore.setUserData("avatarurl",h,!0);var i=DataStore.getUserData("username",""),j="zjsdk.username."+(ConnectionManager.service||"");if(ConnectionManager.eraseCookie(j),ConnectionManager.createCookie(j,i,1),Platform.isSayPageApp||!ConnectionManager.LOAD_CLONE_CLIENT_IN_ENDPOINT||e==ConnectionManager.CLS)ConnectionManager.autoLogin();else{ConnectionManager._dispatchEvent(ConnectionManager.Event.LOADING_CLONE);var k=[];for(var f in DataStore.userStoreCache)k.push(f+"="+escape(DataStore.userStoreCache[f]));for(var f in DataStore.commonStoreCache)k.push("common-"+f+"="+escape(DataStore.commonStoreCache[f]));document.location.href="http://"+e+"/"+document.location.href.split("?")[0].split("/").slice(3).join("/")+"?"+k.join("&")}}else d?ConnectionManager._dispatchEvent(ConnectionManager.Event.LOGIN_FAILED,{errorType:"ZEBRA",
errorCode:d.getZebraAttribute("error_code"),errorMessage:d.getZEventValue("error_message","")}):ConnectionManager._dispatchEvent(ConnectionManager.Event.LOGIN_FAILED,{errorType:"ZEBRA",errorCode:"",errorMessage:"No Zebra received in response!"})}else ConnectionManager._dispatchEvent(ConnectionManager.Event.LOGIN_FAILED,{errorType:"HTTP",errorCode:b,errorMessage:c})},_updateZSState:function(a,b){if(ConnectionManager._dispatchEvent(ConnectionManager.Event.ZS_STATE_UPDATE,{state:a}),ConnectionManager.zsState!=a){if(ConnectionManager.allowMediaCall){var c=ConnectionManager.zsState;null===c&&"busy"===a&&this.initRedialTimer()}ConnectionManager.zsState=a,"disconnected"==a?ConnectionManager.isDisconnected=!0:ConnectionManager.isDisconnected=!1,ConnectionManager._dispatchEvent(ConnectionManager.Event.ZS_STATE_CHANGED,{oldState:c,state:a}),"disconnected"==a?ConnectionManager._dispatchEvent(ConnectionManager.Event.CONNECTION_LOST,b||""):"disconnected"==c&&ConnectionManager._dispatchEvent(ConnectionManager.Event.CONNECTION_MADE)}},_disconnectZSState:function(a){this._updateZSState("disconnected",a)},doZebraDebug:function(){var a=DateTimeUtil.getNow();(null==ConnectionManager.zebraDebugTs||a-ConnectionManager.zebraDebugTs>=6e4)&&(this.log("DEBUG_ZEBRA count/min="+ConnectionManager.zebraDebugCounter),ConnectionManager.zebraDebugTs=a,ConnectionManager.zebraDebugCounter=0)},processZSHTTPMessage:function(a,b){switch(a){case"ZEBRA":ConnectionManager.doZebraDebug(),ConnectionManager.zebraDebugCounter++;var c=Zebra.parseFromString(b);c&&ConnectionManager._dispatchEvent(ConnectionManager.Event.ZEBRA(c.getZebraAttribute("event")),c);break;case"NSDISCONNECT":switch(b){case"EXPIRED":ConnectionManager.AUTOLOGIN_ON_NSDISCONNECT_EXPIRE?ConnectionManager._disconnectZSState("Session expired."):ConnectionManager.logout("Session expired.");break;case"DIFFERENT_SESSION_MULTIPLE_CONNECTION":ConnectionManager.logout(Z.zjs.ZLocale.getString("alert_loggedin_some_where_else","You have logged in somewhere else."));break;case"DIFFERENT_PROTOCOL_MULTIPLE_CONNECTION":ConnectionManager.logout(Z.zjs.ZLocale.getString("alert_loggedin_some_where_else","You have logged in somewhere else."));break;default:ConnectionManager.logout(b)}break;case"ZENONREDIRECT":break;case"DISCONNECT":Platform.callDisconnect(b.split("\n")[1]);break;case"ZENONWAKEFAIL":ConnectionManager._dispatchEvent("ZENONWAKEFAIL");break;case"SHOWMESSAGE":break;case"TEXTMESSAGE":b=b.split(":");b.shift();message=b.join(":");break;case"TXTC:CLEAR":}},processZSResponse:function(a){if(a&&""!=a&&(a=a.replace(/^[\s]+/,"").replace(/[\s]+$/,""),""!=a)){var b=a.split("\n"),c=b.shift();if(a.indexOf("HTTP_MESSAGES")>-1){for(var d="",e=0;e<b.length;e++)d+=b[e];var f=Zebra.parseFromStringZMobile3(d),g=f.zebras;if(g&&g.length>0)for(;g.length>0;){var h=g.shift();ConnectionManager._dispatchEvent(ConnectionManager.Event.ZEBRA(h.getZebraAttribute("event")),h)}var i=f.commands;if(i&&i.length>0)for(;i.length>0;){var j=i.shift().split("\n");j.length>2?ConnectionManager.processZSHTTPMessage(j[0],j[1]+"\n"+j[2]):j.length>1?ConnectionManager.processZSHTTPMessage(j[0],j[1]):ConnectionManager.processZSHTTPMessage(j[0],j[0])}return void ConnectionManager._updateZSState(c)}switch(b.shift()){case"EMPTY":break;case"HTTP_MESSAGE":if(b.length>0){var k,l=b.shift();k=2==b.length&&b[0]==b[1]?b[0]:b.join("\n"),ConnectionManager.processZSHTTPMessage(l,k)}}ConnectionManager._updateZSState(c)}},isZebraWSConnected:function(){return!(!ConnectionManager._ws||1!==ConnectionManager._ws.readyState)},getServerURL:function(){var a=document.URL;return a.indexOf("://")>-1&&(a=a.substring(0,a.indexOf("/",a.indexOf("://")+3))),a},wsConnect:function(){if(!this.stopZSPoll)if("undefined"!=typeof WebSocket){var a="ws";ConnectionManager.CLS.indexOf("https")>-1&&(a="wss");var b="";if(this.doBlackboard){var c=DataStore.getUserData("session_id",""),d=(new Date).getTime();b=this.saturnURL+"?sessionId="+c+"&auth="+this.authToken+"&roomSession="+this.roomSession+"&userId="+this.userId+"&creationTime="+d,this._staticRoute&&(b=b+"&staticRoute="+this._staticRoute),b=b+"&origin="+this.getServerURL()+"&saturn="+ConnectionManager.saturnURL}else b=a+"://"+this.getIP(this.getZS())+this.ZSServlet+"/";this.log("wsURL:"+b),this._ws=new WebSocket(b),this._ws.onopen=this._onWSOpen.bind(this),this._ws.onmessage=this._onWSMessage.bind(this),this._ws.onclose=this._onWSClose.bind(this),this._ws.onerror=this._onWSError.bind(this)}else this.log("switching to long polling"),this.zsPoll()},sendTelemetryMsg:function(a){var b=AVSDKErrors.getReason(a);console.error("sendWSReconnectionTelemetry:error_code="+a+" reason="+b),TelemetryZebraMsgs.sendTelemetryDisconnect(b),ConnectionManager._dispatchEvent("REDIALLING_CaLL",{error:a,reason:AVSDKErrors.getReason(a)}),CallManager.uploadConsoleLogs(b)},isSpecialUser:function(a){return isNaN(a)},initRedialTimer:function(){return ConnectionManager.isSpecialUser(ConnectionManager.userId)?void console.error("Ignore redial request, special user: "+ConnectionManager.userId):void setTimeout(function(){"waiting"!==ConnectionManager.zsState&&CallManager.isMediaConnected()||(CallManager._establishMonitorId=null,CallManager.redialNow(AVSDKErrors.WS_CLOSE_ERROR))},3e3)},_onWSOpen:function(){this.log("ConnManager:_onWSOpen"),this.wsPossible=!0,this._dispatchEvent(this.Event.WEBSOCKET_CONNECT),this.resetAutoReconnect();var a=!1;this.libInitialized&&(a=!0),this.loginSuccessDispatched||(this.libInitialized=this.loginSuccessDispatched=!0,this._dispatchEvent(this.Event.LOGIN_SUCCESS)),this.startTTLTimer(),this.sendWSJSonMessage({type:"register"}),Platform.is_uploading=!1,a&&(this.sendTelemetryMsg(AVSDKErrors.WS_CLOSE_ERROR),this.initRedialTimer()),this.sendWSJSonMessage({type:"register"})},_onWSMessage:function(a){var b=a.data;if(this.log("ConnManager:_onWSMessage:"+b),0==b.indexOf("JSON")){var c=b.split("\n"),d=(c.shift(),JSON.parse(c.shift()));"PONG"===d.type&&(this.enablePingPong=!0,this.lastPongTime=d.server_time,this.lastPongRecvdTime=DateTimeUtil.getNow())}else this.processZSResponse(b)},resetAutoReconnect:function(){this.disconnectTime=0,this.reconnectTries=0},handleWSClosing:function(){if(null!=this._ws)if(this._ws.onopen=null,this._ws.onmessage=null,this._ws.onclose=null,this._ws.onerror=null,this._ws=null,this.stopTTLTimer(),this.loginSuccessDispatched=!1,this.wsPossible){if(!this.stopZSPoll){if(!this.wsReconnect)return this.stopZSPoll=!0,void ConnectionManager._dispatchEvent("ZEBRA_WS_RE_FAILED",{error:this.WS_RE_DISABLED,reason:"Zebra reconnect disabled"});var a=DateTimeUtil.getNow();if(0===this.disconnectTime&&(this.disconnectTime=a),this.reconnectTries>this.reconnectTriesTh)return this.stopZSPoll=!0,console.log("Auto-reconnect disallowed due to too many retries: "+this.reconnectTries+" max: "+this.reconnectTriesTh),void ConnectionManager._dispatchEvent("ZEBRA_WS_RE_FAILED",{error:this.WS_RE_MAX_TRY,reason:"Zebra reconnect disallowed due to too many retries"});var b=a-this.disconnectTime;if(b>this.reconnectMaxTimeSeconds)return this.stopZSPoll=!0,console.log("Auto-reconnect disallowed due to too much time: "+b+"ms max: "+this.reconnectMaxTimeSeconds+" ms"),void ConnectionManager._dispatchEvent("ZEBRA_WS_RE_FAILED",{error:this.WS_RE_MAX_TO,reason:"Zebra reconnect disallowed due to too much time"});++this.reconnectTries,1===this.reconnectTries?setTimeout(this.wsConnect.bind(this),1500):setTimeout(this.wsConnect.bind(this),this.reconnectDelay)}}else this.stopZSPoll||(this.log("switching to long polling"),this.zsPoll())},_onWSError:function(a){TelemetryZebraMsgs.sendTelemetryDisconnect("WS_ERROR"),this.log("ConnManager:_onWSError:"+a),this.handleWSClosing()},_onWSClose:function(a){this.log("ConnManager:_onWSClose: code = "+a.code+" reason = "+a.reason),this._dispatchEvent(this.Event.WEBSOCKET_CLOSED,{error:a.code,reason:a.reason}),a.code===this.WS_AUTH_ERROR?(console.error("Authentication Error in Zebra WebSocket: code = "+a.code+" reason = "+a.reason),this.stopZSPoll=!0,this._dispatchEvent("WS_AUTH_ERROR",{error:"WS"+a.code,reason:a.reason})):this.handleWSClosing()},startTTLTimer:function(){this.stopTTLTimer();var a=this;this.ttlTimer=setInterval(function(){var b=ConnectionManager.userId+""+DateTimeUtil.getNow();a.sendWSJSonMessage({type:"PING",PING_SEQ:b,server_time:ConnectionManager.lastPongTime}),a.enablePingPong&&(a.pendingPong=!0,setTimeout(function(){var b=DateTimeUtil.getNow();if(a.lastPongRecvdTime>0){var c=b-a.lastPongRecvdTime;c>=2*a.PING_INTERVAL&&(console.error("Not getting PONG for "+c+"ms, re-establish Zebra WebSocket"),a._ws&&a._ws.close())}},5e3))},a.PING_INTERVAL)},stopTTLTimer:function(){this.ttlTimer&&clearInterval(this.ttlTimer)},sendWSJSonMessage:function(a){var b=a||{};this.doBlackboard?(b.userId=ConnectionManager.userId,b.roomSession=ConnectionManager.roomSession,b.sessionID=DataStore.getUserData("session_id","")):(b.username=DataStore.getUserData("username",""),b.service=ConnectionManager.service||"saypage",b.sessionID=DataStore.getUserData("session_id","")),this.dispatchPendingMsg(),this.sendWSMessage(JSON.stringify(b))},dispatchPendingMsg:function(){for(;ConnectionManager.pendingMessages.length>0&&1==ConnectionManager._ws.readyState;){var a=ConnectionManager.pendingMessages.shift();a&&(this.log("Sending pending message : msg = "+a),this.sendWSMessage(a))}},sendLogsToSaturn:function(a){if(a){var b={};b.userId=ConnectionManager.userId,b.roomSession=ConnectionManager.roomSession,b.sessionID=DataStore.getUserData("session_id",""),b.type="zsMessage",b.command="RTC_LOG",b.contents=rtcSFU.getUserName()+" "+a,this._ws&&1==this._ws.readyState&&this._ws.send(JSON.stringify(b))}},sendWSMessage:function(a){this._ws?1==this._ws.readyState?(this._ws.send(a),this.log("wsMessageSent:"+this._ws.bufferedAmount)):this._ws.readyState>1?(this.log("ConnManager:websocket is closing or closed:"+this.stopZSPoll),this.handleWSClosing()):(this.log("Unable to send message to Saturn as zebra websocket is down: this._ws.readyState="+this._ws.readyState),this.pendingMessages.push(a)):(this.log("ConnManager:websocket is not connected"),this.handleWSClosing())},zsPoll:function(){ConnectionManager.zsPollIsScheduled=!1;var a="";this.oldZS&&(a="zenonserver="+this.oldZS,"busy"==ConnectionManager.zsState&&(a+="&nextState=CALL"),this.oldZS=null),ConnectionManager.sendZSCommand("getData",a,this,function(a,b,c){if(!ConnectionManager.stopZSPoll&&!ConnectionManager.zsPollIsScheduled)return a&&a.indexOf("DUPLICATE_SESSION_THREAD")>-1?void this.log("DUPLICATE_SESSION_THREAD exit"):void(200==b?(setTimeout(function(){ConnectionManager.processZSResponse(a)},50),ConnectionManager.zsPollIsScheduled=!0,ConnectionManager.zsPoll()):(ConnectionManager._disconnectZSState("HTTP ERROR "+b+" ("+c+")"),setTimeout(ConnectionManager.zsPoll,1500),ConnectionManager.zsPollIsScheduled=!0))})},sendZebra:function(a,b,c,d,e){if(a){if(!ConnectionManager.isLoggedIn())return ConnectionManager.addListener("LOGIN_SUCCESS",this,function(){a.getZebraAttribute("username");a.setZebraAttribute("username",DataStore.getUserData("username","")),ConnectionManager.sendZebra(a,b,c,d)}),this.log(" !!!!! QUEUE ZEBRA !!!!! AS NOT LOGGED IN !!!! "+a.toXML()),void(c&&c.apply(b,[null,-10,"Client not logged in."]));if(this.enableWS&&!this.wsPossible)return ConnectionManager.addListener("WEBSOCKET_CONNECT",this,function(){a.getZebraAttribute("username");a.setZebraAttribute("username",DataStore.getUserData("username","")),ConnectionManager.sendZebra(a,b,c,d)}),this.log(" !!!!! QUEUE ZEBRA !!!!! AS NOT WEBSOCKET_CONNECT IN !!!! "+a.toXML()),void(c&&c.apply(b,[null,-10,"Client not logged in."]));if(e&&e.fireNoSend&&ConnectionManager.isDisconnected)return ConnectionManager._dispatchEvent("CAN_NOT_COMPLETE_REQUEST",{error_code_string:"no_network"}),!1;(new Date).getTime();return"com.requestec.smg.apps.zcontact.bookable.BookableZebra#getEvents"==a.getZebraAttribute("event")&&this.log("Time after sending HTTP message getEvents request : "),this.wsPossible?void this.sendWSJSonMessage({type:"zsMessage",command:"zebra",contents:a.toXML()}):void Platform.httpRequest("POST",ConnectionManager.CLS+(ConnectionManager.ZebraGateway||""),function(d,e,f){var g=200==e&&d&&""!=d?Zebra.parseFromString(d):null;(new Date).getTime();this.log("zebra.getZebraAttribute('event')"+a.getZebraAttribute("event")),"com.requestec.smg.apps.zcontact.bookable.BookableZebra#getEvents:response"==a.getZebraAttribute("event")&&this.log("Time after receiving HTTP Mmessage response : "),c&&c.apply(b,[g,e,f]),g&&ConnectionManager._dispatchEvent(ConnectionManager.Event.ZEBRA(g.getZebraAttribute("event")),g)},"message="+encodeURIComponent(a.toXML()),d)}},sendNonBBZebra:function(a,b,c,d,e){this.doBlackboard||ConnectionManager.sendZebra(a,b,c,d,e)},sendZebraToZC:function(a){var b=getClientObj();b&&b.processZebra(a.toXML())},getZS:function(){return ConnectionManager.POLL_ACTUAL_ENDPOINT?DataStore.getUserData("endpoint",""):ConnectionManager.CLS},getIP:function(a){return a&&(a=a.replace("http://",""),a=a.replace("https://",""),a=a.replace(":80","")),a},updateZS:function(a){var b=ConnectionManager.POLL_ACTUAL_ENDPOINT?DataStore.getUserData("endpoint",null):ConnectionManager.CLS,c=this.getIP(b);a&&ConnectionManager.POLL_ACTUAL_ENDPOINT&&c!=a&&(a.indexOf("http")==-1&&(a=ConnectionManager.CLS.indexOf("https")>-1?"https://"+a:"http://"+a),this.log("Redirecting to new ZS:"+a+" oldZS:"+c),this.oldZS=c,this.sendZSCommand("unregister","reason=SR"),DataStore.setUserData("endpoint",a,!0),a&&TelemetryZebraMsgs.pushMcu(a),CallManager.zsRedirected=!0)},sendZSCommand:function(a,b,c,d,e){if(a&&""!=a)return ConnectionManager.isLoggedIn()?this.wsPossible?void this.sendWSJSonMessage({type:a,params:b}):void Platform.httpRequest("POST",(ConnectionManager.POLL_ACTUAL_ENDPOINT?DataStore.getUserData("endpoint",""):ConnectionManager.CLS)+(ConnectionManager.ZSServlet||""),function(a,b,e){d&&d.apply(c,[a,b,e])},"comm="+a+"&username="+DataStore.getUserData("username","")+"&service="+(ConnectionManager.service||"")+"&sessionid="+DataStore.getUserData("session_id","")+"&random="+Math.floor(1e9*Math.random())+"&"+(b||""),e):void(d&&d.apply(c,[null,-10,"Client not logged in."]))},sendZSZebraCommand:function(a,b,c,d,e){if(a&&""!=a){if(!ConnectionManager.isLoggedIn())return void(d&&d.apply(c,[null,-10,"Client not logged in."]));var f=DataStore.getUserData("session_id","");if(b.zebraAttributes.username!=DataStore.getUserData("username","")&&(f=""),this.wsPossible){if("placeCall"==a&&this.doBlackboard&&(a="zsMessage",b))if(b.setZebraAttribute("event","com.blackboard.saturn.zag.zebra.VideoConference#ClientToMCUConnect"),this.useConnectZebra){ConnectionManager.isEdge()||(CallManager.usingCallID=CallManager.generateCallID(),b.setZEvent("call_id",CallManager.usingCallID)),CallManager.httpLegID&&b.setZEvent("http_leg_id",CallManager.httpLegID),this.webRTCBrowser&&(this.isOpera()||ConnectionManager.isUsingPlugin?b.setZEvent("browser","CHROME"):b.setZEvent("browser",this.webRTCBrowser)),null!=this.webRTCBrowserVersion&&b.setZEvent("browser_ver",this.webRTCBrowserVersion);var g=this.getSdpSemantics();null!=g&&b.setZEvent("sdpSemantics",g),this.videoSlotsActiveFF>0&&"FIREFOX"===this.webRTCBrowser?b.setZEvent("VideoSFUActive",this.videoSlotsActiveFF):this.videoSlotsActive>0&&b.setZEvent("VideoSFUActive",this.videoSlotsActive),CallManager.shadowCallID&&b.setZEvent("endShadowCallID",CallManager.shadowCallID)}else CallManager.usingCallID=null;return void this.sendWSJSonMessage({type:a,command:"zebra",contents:b.toXML()})}Platform.httpRequest("POST",(window.zcallerHostname||DataStore.getUserData("endpoint","")||ConnectionManager.CLS)+(ConnectionManager.ZSServlet||""),function(a,b,e){d&&d.apply(c,[a,b,e])},"comm="+a+"&command=zebra&username="+(b.zebraAttributes.username||DataStore.getUserData("username",""))+"&service="+(ConnectionManager.service||"")+"&sessionid="+f+"&contents="+escape(b.toXML()),e)}},createCookie:function(a,b,c){if(c){var d=new Date;d.setTime(d.getTime()+24*c*60*60*1e3);var e="; expires="+d.toGMTString()}else var e="";document.cookie=a+"="+b+e+"; path=/"},readCookie:function(a){for(var b=a+"=",c=document.cookie.split(";"),d=0;d<c.length;d++){for(var e=c[d];" "==e.charAt(0);)e=e.substring(1,e.length);if(0==e.indexOf(b))return e.substring(b.length,e.length)}return null},eraseCookie:function(a){this.createCookie(a,"",-1)},sendZebraToZS:function(a,b,c,d){return ConnectionManager.sendZSZebraCommand("zsMessage",a,b,c,d)},sendZebraToMCU:function(a,b,c,d){return a&&a.setZebraAttribute("userId",rtcSFU.getUserName()),ConnectionManager.sendZSZebraCommand("sendMessageToMCU",a,b,c,d)},sendZebraViaZS:function(a){if(a){a.setZEvent("userId",rtcSFU.getUserName()),a.setZEvent("roomSession",ConnectionManager.roomSession);var b="https://"+ConnectionManager.getZS()+"/zmobile2/";Platform.httpRequest("POST",b,function(a,b,c){if(200!==b)rtcSFU.sendZebraToZS=!1;else if(a){var d=Zebra.parseFromString(a);d&&ConnectionManager._dispatchEvent(ConnectionManager.Event.ZEBRA(d.getZebraAttribute("event")),d)}},"&command=zebra&contents="+encodeURIComponent(a.toXML()),!0)}},usesUnifiedPlan:function(){return RTCRtpTransceiver.prototype.hasOwnProperty("currentDirection")},getSdpSemantics:function(){return this.isSafari()?this.usesUnifiedPlan()?"unified-plan":"plan-b":rtcSFU.sdpSemantics},logoutAllOtherDevices:function(){var a=new Zebra("com.requestec.smg.zebra.Gateway#logoutAllOtherDevices",this.service);ConnectionManager.sendZebra(a)},log:function(a){(this.logEnabled||Platform.debugLogEnabled)&&Platform.log("ConnectionManager:"+a)}}),CallManager=EventDispatcher.extendAsSingleton({AUTO_ANSWER:!0,ZUID:1,CALL_HANDLING:!1,CAM_MIC:"cammic",MIC:"mic",VOICE:"VOICE",VIDEO:"VIDEO",W2SPort:"10060",_callToken:null,_ss_window:null,_type:"VIDEO",_destination:null,_mcuCall:!1,_record:!1,_initCallInner:null,_initCallInnerSetTime:null,_initCallInnerTimeout:6e4,_establishMonitorId:null,_showLVDelayId:null,_establishMonitorTimeout:6e4,_showLVDelayIdTimeout:1300,_keepConnected:null,_sendPhoneParam:!0,_videoMuted:!1,_playMedia:!1,_selfVisible:!0,_bridgeMedia:!1,_selfX:-1,_selfY:-1,_selfWidth:-1,_selfHeight:-1,_selfXCache:-1,_selfYCache:-1,_selfWidthCache:-1,_selfHeightCache:-1,_videoWidth:-1,_videoHeight:-1,_hangUpIfNoSR:!1,_hangUpIfNoSRTS:1e4,_flashEnabled:!1,_establish:!1,_srCommandID:-1,recordwb:!0,zui:null,_arg1:"",_disableSS:!1,_sharingScreen:!1,compositePaused:!1,enableLVOverlay:!0,DtlsSrtpKeyAgreement:!0,_topX:6,_audioMuted:!1,_videoMuted:!1,_mutedByMAPT:!1,_callType:"P2P",_useNewSSExt:!1,limitRTCBwd:!0,_bigscreenFS:!1,_enableSSZapp:!1,_recordP2P:!1,_p2pRecordingLive:!1,zsRedirected:!1,micActivityEnabled:!1,_lowbr:!1,mcuURLUpdated:!1,connectResponseRecvd:!1,_pendingMCUCall:!1,fpVersion:17,lowBrMode:"BandNormal",upLowBrMode:"BandNormal",self_lowbr_mode:null,upLowVideoTh:250,upLowAudioOnlyTh:128,downLowAudioOnlyTh:128,UP_CONG_MODE_WARN:"warn",UP_CONG_MODE_CAM_OFF:"camera_off",UP_CONG_MODE_SCREEN_OFF:"screen_off",_pendingRedial:!1,_redialWaitTS:1e3,_redialCounter:0,redialOnFFTC:!0,recordUsingSS:!1,allowTelemetryConnect:!0,logEnabled:!1,autoUpLog:!1,inAudioCheck:!0,redialCheck:!0,audioMixMCU:!1,vadValue:0,switchingRoom:!1,httpLegID:null,lastCamEnabledState:null,checkCamEnabledState:!1,lastMicEnabledState:null,checkMicEnabledState:!0,disableDisconnect:!0,shadowCallID:null,outAudioCheck:!0,outVideoCheck:!0,volumeLevel:100,forceWebRTC:!1,usingCallID:null,checkMcuMicState:!0,selfAppshareBR:"normal",mediaErrorCounter:0,mediaErrorTh:4,enableWaitingState:!1,lastNoOutVideoTS:0,lastNoOutAudioTS:0,Event:{INCOMING_CALL:"INCOMING_CALL",CONNECTED:"CONNECTED",CONNECTING:"CONNECTING",INIT:"INIT",FAILED:"FAILED",ENDED:"ENDED",RINGING:"RINGING",SET_LV:"SET_LV",HIDE_LV:"HIDE_LV",TIME_ELAPSED:"TIME_ELAPSED",RECONNECTING:"RECONNECTING",RECONNECTED:"RECONNECTED",ZEBRA:function(a){return"ZEBRA:"+a}},init:function(){this._super(),this.addListener=this._addListener,this.removeListener=this._removeListener,this.removeAllListenersForEvent=this._removeAllListenersForEvent,ConnectionManager.addListener("ZEBRA:IncomingCall",this,this.incomingCall),ConnectionManager.addListener("ZEBRA:SERVER_REDIRECT",this,this.serverRedirect),ConnectionManager.addListener("MCUDISCONNECT",this,this.mcuDisconnect),ConnectionManager.addListener("ZENONWAKEFAIL",this,this.disconnectCall),ConnectionManager.addListener("ZWRTC_SIP_CALL_FAILED",this,this.endCall),ConnectionManager.addListener("ZWRTC_SIP_CALL_TERMINATED",this,this.endCall),ConnectionManager.addListener("FLASH_CALL_TERMINATED",this,this.endCall),ConnectionManager.addListener("ZWRTC_P2P_ESTABLISHED",this,this.p2pEstablished),ConnectionManager.addListener("ZWRTC_CALL_ESTABLISHED",this,this.callEstablished),ConnectionManager.addListener("RECORDING_CALL",this,this.recordingCall),ConnectionManager.addListener("ZWRTC_P2P_FAILED",this,this.p2pFailed),ConnectionManager.addListener("ZWRTC_SET_WEBCAM_ACTIVE",this,this.setWebCamActive),ConnectionManager.addListener("ZWRTC_VIDEO_VIEW_ONLY",this,this.videoViewOnly),ConnectionManager.addListener("SHARE_SCREEN_START",this,this.shareScreenStart),ConnectionManager.addListener("SHARE_SCREEN_STOP",this,this.shareScreenStop),ConnectionManager.addListener("ZEBRA:SHARE_SCREEN_STOPPED",this,this.shareScreenStopped),ConnectionManager.addListener("ZEBRA:SCREENSHARE_END",this,this.terminateSS),ConnectionManager.addListener("SHARE_SCREEN_STOPPED",this,this.shareScreenStopped),ConnectionManager.addListener(ConnectionManager.Event.ZS_STATE_CHANGED,this,this.checkCall),ConnectionManager.addListener("ZEBRA:MULTI_ALTERNATIVE_STREAM",this,this.mapt),ConnectionManager.addListener("ZEBRA:ZWRTC_ZS_SCREEN_ON_MESSAGE",this,this.zsScreenOnMessage),ConnectionManager.addListener("ZEBRA:ZWRTC_ZS_SCREEN_ON_OPEN",this,this.zsScreenOnOpen),ConnectionManager.addListener("ZEBRA:ZWRTC_ZS_SCREEN_ON_CLOSE",this,this.zsScreenOnClose),ConnectionManager.addListener("ZEBRA:com.blackboard.saturn.zag.zebra.VideoConference#ClientToMCUConnect:response",this,this.clientToMCUResponse),ConnectionManager.addListener("ZEBRA:com.blackboard.saturn.zag.zebra.VideoConference#postLog:response",this,this.postLogResponse),ConnectionManager.addListener("ZEBRA:REDIAL_MCU_CALL",this,this.redialMcuCall),ConnectionManager.addListener("ZEBRA:TxBitRateIndication",this,this.txBitRateIndication),ConnectionManager.addListener("ZEBRA:RxBitRateIndication",this,this.rxBitRateIndication),ConnectionManager.addListener("ZEBRA:UploadConsoleLogs",this,this.uploadConsoleLogsZebra),ConnectionManager.addListener("ZEBRA:MediaNotification",this,this.mediaNotification),ConnectionManager.addListener("ZEBRA:MCU_NOT_AVAILABLE",this,this.mcuNotAvailable),ConnectionManager.addListener("ZEBRA:MCU_AVAILABLE_NOW",this,this.mcuAvailableNow),this.addListener(this.Event.CONNECTING,this,this.mapt),this.addListener(this.Event.CONNECTED,this,this.callConnected),this.addListener(this.Event.RECONNECTING,this,this.mapt),this.addListener(this.Event.RECONNECTED,this,this.mapt)},generateHttpLegID:function(){return null==this.httpSeq&&(this.httpSeq=0),this.httpSeq++,this.httpSeq},postLogResponse:function(){Platform.logsUploaded()},updateLVOverlay:function(a){a!=this.enableLVOverlay&&(this.enableLVOverlay=a,CallManager._dispatchEvent(CallManager.Event.SET_LV))},handleNoAudioOut:function(){if(this.outAudioCheck){this.outAudioCheck=!1;var a="MCU not receiving any audio packets",b=DateTimeUtil.getNow();if(this.lastNoOutAudioTS>0){var c=b-this.lastNoOutAudioTS;c>3e4&&"redial"===this.outAudioCheckMode&&(this.outAudioCheckMode=null)}this.lastNoOutAudioTS=b,"error"===this.outAudioCheckMode||("redial"===this.outAudioCheckMode?(ConnectionManager._dispatchEvent("NO_AUDIO_OUT",{state:"error"}),this.outAudioCheckMode="error",this.uploadConsoleLogs(a)):(ConnectionManager._dispatchEvent("NO_AUDIO_OUT",{state:"redial"}),this.outAudioCheckMode="redial",this.uploadConsoleLogs(a),CallManager._flashEnabled?flashClient.redialCall(AVSDKErrors.NO_AUDIO_OUT):this.redialCallWithError(AVSDKErrors.NO_AUDIO_OUT,a)))}},handleNoVideoOut:function(){if(this.outVideoCheck){this.outVideoCheck=!1;var a=DateTimeUtil.getNow();if(this.lastNoOutVideoTS>0){var b=a-this.lastNoOutVideoTS;b>3e4&&"redial"===this.outVideoCheckMode&&(this.outVideoCheckMode=null)}this.lastNoOutVideoTS=a;var c="MCU not receiving any video packets";"error"===this.outVideoCheckMode||("redial"===this.outVideoCheckMode?(ConnectionManager._dispatchEvent("NO_VIDEO_OUT",{state:"error"}),this.outVideoCheckMode="error",this.uploadConsoleLogs(c)):(ConnectionManager._dispatchEvent("NO_VIDEO_OUT",{state:"redial"}),this.outVideoCheckMode="redial",this.uploadConsoleLogs(c),this._flashEnabled?flashClient.redialCall(AVSDKErrors.NO_VIDEO_OUT):this.redialCallWithError(AVSDKErrors.NO_VIDEO_OUT,c)))}},mediaNotification:function(a){var b=this.getZEvent(a,"event");"NoAudioPackets"===b?TechCheck.isAudioMuted?this.log("Audio is muted, ignoring mediaNotification Zebra = "+a.toXML()):this.handleNoAudioOut():"NoVideoPackets"===b&&(TechCheck.isVideoMuted?this.log("Video is muted, ignoring mediaNotification Zebra = "+a.toXML()):this.handleNoVideoOut())},uploadConsoleLogsZebra:function(a){this.postLogs(this.getZEvent(a,"reason"))},uploadConsoleLogs:function(a){CallManager.autoUpLog&&this.postLogs(a)},postLogs:function(a){null==a&&(a="Logs uploaded on Saturn request."),Platform.postLog(a)},clientToMCUResponse:function(a){var b=parseInt(a.getZebraAttribute("error_code"));if(isNaN(b)&&(b=0),0===b){!TechCheck.isVideoMuted&&TechCheck.isAudioMuted&&rtcSFU.sendVadZebra(0,0);var c=this.getZEvent(a,"mcu"),d=this.getZEvent(a,"turnConfig"),e=this.getZEvent(a,"sdp");if(c){var f=c.split(":")[0];DataStore.setUserData("endpoint",f,!0),TelemetryZebraMsgs.pushMcu(f),this.mcuURLUpdated=!0}e&&(this.connectResponseZebra=a),this.connectResponseRecvd=!0,d&&(zwrtc.stunserver_config=rtcSFU.stunConfig=JSON.parse(d),DataStore.setUserData("stun_turn",rtcSFU.stunConfig)),this.log("clientToMCUResponse:_pendingMCUCall="+this._pendingMCUCall),this._pendingMCUCall&&this.connectToMCU(this._pendingVideoCall)}else if(b<0){var g=this.getZEvent(a,"error_message"),h="Redialling call due to, error_message:"+g;if(b<=-777e3){if(this.mediaErrorCounter>=this.mediaErrorTh)return void CallManager.mediaConnectionFailed("ZMEDIA_ERROR",b);this.mediaErrorCounter++,this.log(h),CallManager.redialCallWithError(AVSDKErrors.ZMEDIA_ERROR,h)}else h+=" response from MCU: "+this.getZEvent(a,"response"),this.log(h),CallManager.redialCallWithError(AVSDKErrors.ERR_IN_MCU_RESP,h)}else{var i="Error response received in CONNECT command: ";try{i+=this.getZEvent(a,"error_message")}catch(j){}console.error(i),7!==b&&5!==b||CallManager.mediaConnectionFailed("ZMEDIA_ERROR","C"+b)}},zsScreenOnMessage:function(a){this._disableSS||this.useNewSSExt()||($("#SP_SS_EXT_DIV")[0].innerHTML=a.toXML(),this.dispatchMessageToExtension("EXT_ZS_ON_MESSAGE"))},zsScreenOnOpen:function(a){this._disableSS||this.useNewSSExt()||($("#SP_SS_EXT_DIV")[0].innerHTML=a.toXML(),this.dispatchMessageToExtension("EXT_ZS_ON_OPEN"),this.screenCallEstablished())},zsScreenOnClose:function(a){this._disableSS||this.useNewSSExt()||($("#SP_SS_EXT_DIV")[0].innerHTML=a.toXML(),this.dispatchMessageToExtension("EXT_ZS_ON_CLOSE"),this.screenCallTerminated())},screenCallEstablished:function(){this._sharingScreen=!0,CallManager._enableSSZapp||(CallManager._videoMuted=TechCheck.isVideoMuted,TechCheck.isVideoMuted||webRTC.toggleVideoMute()),CallManager.desktopStream&&this.terminateOldAppSharePC(),ConnectionManager._dispatchEvent("SCREEN_SHARE_STARTED",{msg:""}),ssController.desktopStream&&rtcSFU.desktopStream&&rtcSFU.desktopStream.localStream&&rtcSFU.desktopStream.localStream!==ssController.desktopStream&&rtcSFU.desktopStream.updateDesktopStream(ssController.desktopStream)},screenCallTerminated:function(){this._sharingScreen=!1,ConnectionManager._dispatchEvent("ZEBRA:SHARE_SCREEN_STOPPED")},getSSUserID:function(a,b){try{var c=this.getZEvent(a,"screenshare_userId",null);if(null==c)for(var d=0;d<=b;d++){var e=this.getZEvent(a,"screenshare_"+d,"false");if("true"==e){var c=this.getZEvent(a,"userId_"+d,"");if(c)break}}return c&&c.indexOf(rtcSFU._userRoomMcuDel)>-1&&(c=c.slice(rtcSFU._userRoomMcuPrefix.length,c.indexOf(rtcSFU._userRoomMcuDel))),c}catch(f){}return null},terminateOldPC:function(){(CallManager.peerConnection||CallManager.ortcMedia)&&(CallManager.eventsDisabled&&(CallManager.eventsDisabled=!1,ConnectionManager._dispatchEvent("SESSION_MIGRATION_END",{mcu:ConnectionManager.getZS()})),ssController.incomingRemoteSSStream=null,ssController.userId=null,rtcSFU.rvSFUArray={},rtcSFU.maptParser(rtcSFU._lastMAPTZebra),rtcSFU.rvCompositeHigh&&rtcSFU.rvCompositeHigh.checkIfAllStreamsPresent(),setTimeout(function(){CallManager.ortcMedia&&(CallManager.ortcMedia.closeConnection(),CallManager.ortcMedia=null),CallManager.peerConnection&&(CallManager.peerConnection.close(),CallManager.peerConnection=null),rtcSFU.stopStreamTracks(CallManager.oldLocalStream),CallManager.oldLocalStream=null},1e3),CallManager.sendClearOldMediaZebra())},sendClearOldMediaZebra:function(){setTimeout(function(){var a=new Zebra("com.blackboard.saturn.zag.zebra.VideoConference#clearOldMediaSession");ConnectionManager.sendWSJSonMessage({type:"zsMessage",command:"zebra",contents:a.toXML()})},5e3)},terminateOldAppSharePC:function(){CallManager.desktopPeerConnection&&(rtcSFU.desktopStream&&rtcSFU.desktopStream.isPCConnected()?(CallManager.desktopPeerConnection.close(),CallManager.desktopPeerConnection=null,CallManager.sendClearOldMediaZebra()):setTimeout(CallManager.terminateOldAppSharePC,1e3))},callConnected:function(){this.mapt(),CallManager._ssDetected?setTimeout(function(){CallManager.terminateOldPC()},2e3):CallManager.terminateOldPC(),CallManager.desktopStream&&(ssController.gotStream(CallManager.desktopStream),CallManager.desktopStream=null)},mapt:function(a){if(ConnectionManager.isSpecialUser(ConnectionManager.userId))return void console.error("Ignoring MAPT for special user: "+ConnectionManager.userId);var b=!1;a&&"undefined"!=typeof a.getZEvent&&(b=!0);var c=!1;if(b){if(this.log("CallManager MAPT:"+a.toXML()),a.getZebraAttribute("username")!=DataStore.getUserData("username",""))return void this.log("Ignore MAPT, as it is for diff user e.g.screenshare zapp flash swf");var d=null,e=parseInt(a.getZEvent("queue_size").value),f=!1,g=a.getZebraAttribute("groupId");if(null!=g&&ConnectionManager.groupId!=g&&(ConnectionManager.groupId=g,f=!0),!zwrtc.isP2P()&&(d=this.getSSUserID(a,e),null==d||ConnectionManager.isSpecialUser(d)||d==ConnectionManager.userId||d==ssController.userId||(this._ssDetected=!0,this.selfAppshareBR="normal",ssController.userId=d,ConnectionManager._dispatchEvent("ZSCREENSHARE_RECEIVER_START",{extraChannels:!0,userId:d})),this._ssDetected))if(null==d)ConnectionManager._dispatchEvent("ZSCREENSHARE_RECEIVER_STOP",{userId:ssController.userId}),ssController.userId=null,this._ssDetected=!1;else if(f)try{screenShareViewer.mnUpdated()}catch(h){}a.getZEvent("view_mode")&&"media"==a.getZEvent("view_mode").value?CallManager._playMedia=!0:CallManager._playMedia=!1;var i=!1;a.getZEvent("selfVisible")&&a.getZEvent("selfVisible").value&&"true"==a.getZEvent("selfVisible").value?(CallManager._selfVisible||(i=!0),CallManager._selfVisible=!0):CallManager._selfVisible&&(i=!0,CallManager._selfVisible=!1),i&&(rtcSFU.audioToggled(),rtcSFU.videoToggled()),a.getZEvent("selfX")&&a.getZEvent("selfX").value&&parseInt(a.getZEvent("selfX").value)>=0?(CallManager._selfX==parseInt(a.getZEvent("selfX").value)&&parseInt(a.getZEvent("selfY").value)==parseInt(a.getZEvent("selfY").value)&&CallManager._selfWidth==a.getZEvent("selfWidth").value&&CallManager._selfHeight==parseInt(a.getZEvent("selfHeight").value)||(c=!0),CallManager._selfXCache=parseInt(a.getZEvent("selfX").value),CallManager._selfYCache=parseInt(a.getZEvent("selfY").value),CallManager._selfWidthCache=parseInt(a.getZEvent("selfWidth").value),CallManager._selfHeightCache=parseInt(a.getZEvent("selfHeight").value)):(CallManager._selfXCache=-1,CallManager._selfYCache=-1,
CallManager._selfWidthCache=-1,CallManager._selfHeightCache=-1),a.getZEvent("videoWidth")&&a.getZEvent("videoWidth").value&&parseInt(a.getZEvent("videoWidth").value)>0&&(CallManager._videoWidth=parseInt(a.getZEvent("videoWidth").value),CallManager._videoHeight=parseInt(a.getZEvent("videoHeight").value))}if(CallManager._videoWidth<1&&(CallManager._videoWidth=zwrtc.cam_width,CallManager._videoHeight=zwrtc.cam_height),zwrtc._video&&zwrtc.isConnected()&&zwrtc.isMCU()?(CallManager._selfX=CallManager._selfXCache,CallManager._selfY=CallManager._selfYCache,CallManager._selfWidth=CallManager._selfWidthCache,CallManager._selfHeight=CallManager._selfHeightCache):(CallManager._selfX=-1,CallManager._selfY=-1,CallManager._selfWidth=-1,CallManager._selfHeight=-1),CallManager.compositePaused&&(c=!1),c){CallManager._showLVDelayId=DateTimeUtil.getNow();var j=CallManager._showLVDelayId;setTimeout(function(){j==CallManager._showLVDelayId&&CallManager._dispatchEvent(CallManager.Event.SET_LV)},CallManager._showLVDelayIdTimeout),CallManager._dispatchEvent(CallManager.Event.HIDE_LV)}else CallManager._dispatchEvent(CallManager.Event.SET_LV);ConnectionManager._dispatchEvent("UPDATE_RV")},startScreenShare:function(a){if($("#SP_SS_EXT_DIV").length>0)this.dispatchMessageToExtension("EXT_START_SCREEN_SHARE");else{null==a&&(a=DataStore.getUserData("username",""));var b=this.getServerIP()+":"+DataStore.getUserData("mcu_sip_port",""),c="https://"+window.location.host+"/user/portal/share.jsp?session=SHADOW_SCREEN_"+a+"&port="+CallManager.W2SPort+"&mcu="+b;this._ss_window=window.open(c,"tr","directories=no,titlebar=no,toolbar=no,location=no,status=no,menubar=no,scrollbars=no,resizable=no,left=60,top=60,width=450,height=200"),this.screenCallEstablished()}},switchViewOnly:function(){ConnectionManager._dispatchEvent("SWITCH_VIEW_ONLY",{msg:""})},initScreenShare:function(a){a&&(ssController.chromeExtensionId=a,ssController.initInlineInstalls())},shareScreen:function(){this.useNewSSExt()?ssController.startScreenShare():$("#SP_SS_EXT_DIV").length<1?CallManager.ssExtInstalled?ssController.displaySSRefreshMessage():ssController.installExt(null):this.shareScreenStart()},shareScreenStart:function(a){this.shareScreenStop(),this.startScreenShare(null)},isSharingScreen:function(){return!!this._sharingScreen||null!=this._ss_window},shareScreenStop:function(a){this.isSharingScreen()&&(this.useNewSSExt()?ConnectionManager.doBlackboard||ssController.stopScreenShare():$("#SP_SS_EXT_DIV").length>0&&this.dispatchMessageToExtension("EXT_STOP_SCREEN_SHARE"),this._ss_window&&(this._ss_window.close(),this._ss_window=null))},terminateSS:function(a){this.log("CallManager:terminate ss recvd from MCU"),this.shareScreenStop(),this.shareScreenStopped(),this._sharingScreen=!1},shareScreenStopped:function(a){showMessage(Z.zjs.ZLocale.getString("zjs_alert_screen_share_ended","Screen Share Ended"),"",!1,null,null,null,!0,1500),CallManager._enableSSZapp||CallManager._videoMuted||(TechCheck.isVideoMuted&&webRTC.toggleVideoMute(),CallManager._videoMuted=!1)},setWebCamActive:function(a){this.log("CallManager setWebCamActive:"+a.isVideoMuted);var b=!a.isVideoMuted;if((!this.checkCamEnabledState||b)&&b!==this.lastCamEnabledState){this.checkCamEnabledState=!1,this.lastCamEnabledState=b;var c=new Zebra("ClientToZMCUUserProps");c.setZEvent("camEnabled",b.toString()),c.setZebraAttribute("userId",rtcSFU.getUserName()),ConnectionManager.sendZebraToMCU(c)}},videoViewOnly:function(){if(ConnectionManager.doBlackboard)CallManager.sendClientToSaturnUserProps();else{var a=new Zebra("com.requestec.smg.apps.ZenDevice#setCam");a.setZEvent("cam","viewonly"),ConnectionManager.sendZebra(a)}},sendClientToSaturnUserProps:function(){var a=new Zebra("com.blackboard.saturn.zag.zebra.VideoConference#ClientToSaturnUserProps"),b=!0,c=!0,d=!0,e=!0,f=0,g=0,h=!1;"PHONE"==zwrtc.audioSourceID&&(b=!1),"NONE"==zwrtc.videoSourceID&&(d=!1),CallManager.telephonyActive&&(b=!0),e=!!d&&!TechCheck.isVideoMuted,b?(c=!TechCheck.isAudioMuted,c&&rtcSFU.sendVadZebra(1,1)):c=!1;var i=!1;b===this.lastMicPresent&&c===this.lastMicEnabled&&d===this.lastCamPresent&&e===this.lastCamEnabled&&f===this.lastUploadLimit&&g===this.lastDownLimit&&h===this.lastIsWBSharing||(i=!0),i&&(this.lastMicPresent=b,this.lastMicEnabled=c,this.lastCamPresent=d,this.lastCamEnabled=e,this.lastUploadLimit=f,this.lastDownLimit=g,this.lastIsWBSharing=h,a.setZEvent("micPresent",b.toString()),a.setZEvent("micEnabled",c.toString()),a.setZEvent("camPresent",d.toString()),a.setZEvent("camEnabled",e.toString()),a.setZEvent("uploadLimit",f.toString()),a.setZEvent("downLimit",g.toString()),a.setZEvent("isWBSharing",h.toString()),a.setZEvent("bbProxyURL",ConnectionManager.bbProxyURL),ConnectionManager.sendZebra(a))},sendSRStatusResponse:function(a){this.log("CallManager sendSRStatusResponse:Sending SERVER_REDIRECT_STATUS:"+a+" to mcu");var b=new Zebra("SERVER_REDIRECT_STATUS");b.setZEvent("status",a),b.setZEvent("command_id",this._srCommandID),ConnectionManager.sendZebraToMCU(b),this.log("_srCommandID:"+this._srCommandID)},p2pEstablished:function(){this._srCommandID!=-1&&(this.sendSRStatusResponse("OK"),CallManager._dispatchEvent(CallManager.Event.RECONNECTED,{type:"p2p"}),CallManager._mcuCall=!1),CallManager._dispatchEvent(CallManager.Event.CONNECTED,{type:"p2p"}),this.log("CallManager p2pEstablished"),this.sendPlaceCall(!0),this.callEstablished(),this._audioRecordingCallEnabled&&this.initiateAudioRecordingCall()},p2pFailed:function(){if(this.log("CallManager p2pFailed"),this._srCommandID!=-1&&zwrtc.isMCU())this.log("CallManager p2pFailed: but mcu call already going on so donot place new call:"+this._srCommandID),this._srCommandID=-1;else{var a=!0;"VOICE"==CallManager._type&&(a=!1),this.connectToMCU(a),this.sendPlaceCall(!1)}},getZEvent:function(a,b){var c=null;try{c=a.getZEvent(b).value}catch(d){}return c},initiateAudioRecordingCall:function(){this.log("initiateAudioRecordingCall"),CallManager._recordP2PAudio&&ConnectionManager._dispatchEvent("INIT_AUDIO_RECORDING_CALL")},isMediaConnected:function(){return CallManager._flashEnabled?flashClient.isConnected():rtcSFU.isMediaConnected()},serverRedirect:function(a){if(CallManager.CALL_HANDLING&&!CallManager._flashEnabled){if(ConnectionManager.isSpecialUser(ConnectionManager.userId))return void console.error("Ignoring SR for special user: "+ConnectionManager.userId);this.log("CallManager serverRedirect"),a&&this.log("CallManager serverRedirect:"+a.toXML());var b=!0;if("true"==this.getZEvent(a,"mcu")){var c=!1;if(null!=this.getZEvent(a,"queue_size")&&(c=!0),this._audioRecordingCallEnabled=!1,"true"==this.getZEvent(a,"audioRecording")&&(CallManager._recordP2PAudio?(this._audioRecordingCallEnabled=!0,ConnectionManager._dispatchEvent("MUTE_MIC_TILL_RECORDING_STARTS")):this._audioRecordingCallEnabled=!1),this._srCommandID=-1,this._callType="MCU",ConnectionManager._dispatchEvent("MCU_SR_RECVD",{msg:"Connecting to mcu"}),CallManager._hangUpIfNoSR=!1,!zwrtc.isP2P()&&zwrtc.isMCU())return this.log("CallManager, already connected to MCU, so ignoring sr"),void(c&&ConnectionManager._dispatchEvent("ZEBRA:MULTI_ALTERNATIVE_STREAM",a));if(this._audioRecordingCallEnabled)return this.initiateAudioRecordingCall(),void(c&&ConnectionManager._dispatchEvent("ZEBRA:MULTI_ALTERNATIVE_STREAM",a));if(zwrtc.hangup(!0),CallManager._mcuCall=!1,CallManager._dispatchEvent(CallManager.Event.CONNECTING,{type:"mcu"}),c&&ConnectionManager._dispatchEvent("ZEBRA:MULTI_ALTERNATIVE_STREAM",a),"VOICE"==CallManager._type&&(b=!1),this.connectToMCU(b),null!=this.getZEvent(a,"queue_size")&&zwrtc._enableSFU)return void this.log("CallManager, SRMAPT detected, so ignoring it")}else{CallManager._mcuCall=!1;var d=this.getZEvent(a,"type"),e=this.getZEvent(a,"connectmode"),f=this.getZEvent(a,"destination"),g=this.getZEvent(a,"isP2P"),h=this.getZEvent(a,"zenonserver"),i=this.getZEvent(a,"callerP2PAddress"),j=this.getZEvent(a,"command_id");if(this._audioRecordingCallEnabled=!1,j){if(d=CallManager._type,"true"==this.getZEvent(a,"audioRecording")){if(!CallManager._recordP2PAudio)return void this.sendSRStatusResponse("FAIL");this._audioRecordingCallEnabled=!0,ConnectionManager._dispatchEvent("MUTE_MIC_TILL_RECORDING_STARTS")}if(this._srCommandID!=-1)return this.log("CallManager, Already have SR with command id:"+this._srCommandID+" so ignoring new SR for:"+j),this._srCommandID=j,void(this._audioRecordingCallEnabled&&zwrtc.isP2P()&&this.initiateAudioRecordingCall());this._srCommandID=j}else this._srCommandID=-1;if(null==d&&(d=CallManager.VIDEO),d=d.replace("DIAL",""),"NONE"!=d&&"VOICE"!=d||(b=!1),CallManager._type=d,this._audioRecordingCallEnabled&&zwrtc.isP2P())this.initiateAudioRecordingCall();else if(ConnectionManager.inCall()&&(null==h||g)){this._callType="P2P",zwrtc.switchedToP2P();var k=CallManager.getWrtcAddress(i);null!=k&&zwrtc.placeP2PCall(k,b)}else if("2"==e||"0"==e){h&&ConnectionManager.updateZS(h);var l=zwrtc.getP2PAddress();f=f.replace("VS7","VS1"),f.indexOf("#")==-1&&f.indexOf("%23")==-1&&(f=f+"%23"+LineStatesModel.getNextAvailableLine()),this.log("Calling initiateCall:"+l),zwrtc.updateCallType(b),(zwrtc.isP2P()||zwrtc.isMCU())&&(zwrtc.hangup(!0),CallManager._mcuCall=!1,CallManager._dispatchEvent(CallManager.Event.CONNECTING,{type:"mcu"})),this._callType="P2P",this.initCall(d,f,"-1",!0,0,"Demo Call",null,l)}else"1"==e&&this.endCall()}}},setZUI:function(a,b,c){"true"==a.getAttribute("forceFlash")&&ConnectionManager.initFlash();var d=a.getAttribute("forceProtocol");if("RTMPT"!=d&&"RTMPS"!=d&&"RTMFP"!=d||(flashClient._forceProtocol=d),a.getAttribute("flashBgColor")&&flashClient.setBGColor(a.getAttribute("flashBgColor")),a.getAttribute("enableSFU")&&(zwrtc._enableSFU=!0),a.getAttribute("useCustomGUI")&&(zwrtc._useCustomGUI=!0),zwrtc.cam_width=640,zwrtc.cam_height=480,zwrtc.cam_fps=30,flashClient.cam_width=320,flashClient.cam_height=240,a.getAttribute("camWidth")){var e=parseInt(a.getAttribute("camWidth"));isNaN(e)||(zwrtc.cam_width=e)}if(a.getAttribute("camHeight")){var f=parseInt(a.getAttribute("camHeight"));isNaN(f)||(zwrtc.cam_height=f)}if(a.getAttribute("camFps")){var g=parseInt(a.getAttribute("camFps"));isNaN(g)||(zwrtc.cam_fps=g)}if(a.getAttribute("inVideoWidth")){var h=parseInt(a.getAttribute("inVideoWidth"));isNaN(h)||(zwrtc.in_video_width=h)}if(a.getAttribute("inVideoHeight")){var i=parseInt(a.getAttribute("inVideoHeight"));isNaN(i)||(zwrtc.in_video_height=i)}if(a.getAttribute("flashCamWidth")){var e=parseInt(a.getAttribute("flashCamWidth"));isNaN(e)||(flashClient.cam_width=e)}if(a.getAttribute("flashCamHeight")){var f=parseInt(a.getAttribute("flashCamHeight"));isNaN(f)||(flashClient.cam_height=f)}flashClient.cam_fps=zwrtc.cam_fps,flashClient.in_video_width=zwrtc.in_video_width,flashClient.in_video_height=zwrtc.in_video_height,a.getAttribute("showTimer")?(flashClient.showCallTimer(!0),flashClient.setTimerOnRV(!0)):flashClient.showCallTimer(!1),a.getAttribute("showControls")&&flashClient.showToolBar(),CallManager.zui=a,CallManager.zinit(a.getLV(),a.getRV(),a.getAudio(),b,c,$("#sp_flash_container"),"sp_flash")},getRemoteStreamFromId:function(a){if(rtcSFU._sfuStreams[a])return rtcSFU._sfuStreams[a];if(ConnectionManager.userId==a)return rtcSFU.rvCompositeHigh?rtcSFU.rvCompositeHigh.remoteStream:zwrtc.getLocalStream();for(var b in rtcSFU.rvSFUArray)if(rtcSFU.rvSFUArray[b]&&rtcSFU.rvSFUArray[b]._userId==a)return rtcSFU.rvSFUArray[b].remoteStream;return null},onStatusMsg:function(a){flashClient.onStatusMsg(a)},zinit:function(a,b,c,d,e,f,g){CallManager.CALL_HANDLING=!0,ConnectionManager.isLoggedIn()?CallManager.checkTechRequired(a,b,c,d,e,f,g):ConnectionManager.addListener("LOGIN_SUCCESS",this,function(){CallManager.checkTechRequired(a,b,c,d,e,f,g)})},checkTechRequired:function(a,b,c,d,e,f,g){CallManager.zui&&1==CallManager.zui.getAttribute("showTechCheck")?(wrtcSetting._spkDetectionCheck=!0,wrtcSetting._bwDetection=!0,zwrtc.showTechCheck=!0,wrtcSetting._repositionLoader=!1,$("#zwrtc_video_local").hide(),$("#zwrtc_video_remote").hide(),$("#zwrtc_av").height(0),$(CallManager.zui.getAttribute("uiParent")+"_inner_title").hide(),wrtcSetting.init(),$("#camCombo").change(camMicChanged),$("#micCombo").change(camMicChanged),ConnectionManager.addListener("WRTC_SETTING_DEVICE_SELECTED",this,function(){CallManager._flashEnabled||(CallManager.zui.startRV(),$("#zwrtc_av").css("height","90%")),$(CallManager.zui.getAttribute("uiParent")+"_inner_title").show(),CallManager.zinitInner(a,b,c,d,e,f,g)})):CallManager.zinitInner(a,b,c,d,e,f,g)},zinitInner:function(a,b,c,d,e,f,g){if(CallManager._flashEnabled)flashClient.init(f,flashClient,!1);else{e&&(zwrtc.viewOnly=!0);var h=DataStore.getUserData("username","");if(h&&h.indexOf("SHADOW_")==-1)try{h=zwrtc.screen?"SHADOW_SCREEN_"+h:"SHADOW_"+h}catch(i){}var j=DataStore.getUserData("stun_turn","[{ url: 'stun:stun.l.google.com:19302'}]");zwrtc.init(h,null,null,a,b,c,null,!0,"both",d,j,"")}},placeCall:function(a,b,c,d){if(CallManager._flashEnabled)flashClient.placeCall(a,b);else if(b&&b.indexOf("zs_room_")>-1){var e=!0;"VOICE"==a&&(e=!1),zwrtc.placeP2PCall(b,e,!0)}else CallManager.initCall(a,b,"-1",!0,0,c,null,zwrtc.getP2PAddress(),d)},redialCallWithError:function(a,b){null==b&&(b=AVSDKErrors.getReason(a)),this.log("redialCallWithError:error_code="+a+" reason="+b),TelemetryZebraMsgs.sendTelemetryDisconnect(b),ConnectionManager._dispatchEvent("REDIALLING_CaLL",{error:a,reason:AVSDKErrors.getReason(a)}),CallManager.uploadConsoleLogs(b),rtcStats.saveOldStats(a,b),this.redialCall("Code: "+a+" Message: "+b)},redialCall:function(a){if(this._pendingRedial)return void this.log("not redialling as a redial is already pending");var b=DateTimeUtil.getNow(),c=b-this._lastRedialTS;this._redialCounter<2?this._redialWaitTS=1e3:this._redialCounter<4?this._redialWaitTS=2e3:this._redialWaitTS=3e3,this.log("redial attempt:"+this._redialCounter+" diff:"+c+" _redialWaitTS:"+this._redialWaitTS),c>this._redialWaitTS?this.redialNow(a):(this._pendingRedial=!0,setTimeout(function(){CallManager.redialNow(a),CallManager._pendingRedial=!1},this._redialWaitTS-c)),this._redialCounter++,this.redialCheck&&this._redialCounter>5&&(this.redialCheck=!1,CallManager.uploadConsoleLogs("Too Many Redials"))},redialNow:function(a){var b=DateTimeUtil.getNow(),c=b-this._lastRedialTS;if(this.log("Redialling call now: time diff:"+c+" redialWaitTS:"+this._redialWaitTS),this._lastRedialTS=b,ConnectionManager._dispatchEvent("ZWRTC_PLACING_CALL_STEPS",{msg:" ESTABLISH MONITOR ALARM"}),CallManager.sendEndCall(a),CallManager._flashEnabled)flashClient.placeCall(CallManager._type,CallManager._destination);else{DataStore.setUserData("endpoint",null,!0),CallManager.mcuURLUpdated=!1,CallManager.connectResponseRecvd=!1,zwrtc.hangup(),ConnectionManager.zsState="waiting";var d=CallManager;CallManager.initCall(d._type,d._destination,d._chat_session_id,d._showVS,d._itemId,d._displayName,d._alternative_username,d._p2pAddress,d._keepConnected,a)}},initCall:function(a,b,c,d,e,f,g,h,i,j){if(CallManager.mediaFailed&&CallManager.mediaFailed.name){var k="Ignoring place call as media connection with MCU is failed due to "+CallManager.mediaFailed.name;return CallManager.log(k),void console.error(k)}return ConnectionManager.isSpecialUser(ConnectionManager.userId)?void console.error("Ignoring initCall for special user: "+ConnectionManager.userId):this.mediaRedialDisabled?void console.error("Ignoring initCall as waiting for new Media Capacity"):(CallManager._initCallInner=function(){h=null,CallManager._type=a,CallManager._destination=b,CallManager.chat_session_id=c,CallManager.showVS=d,CallManager.itemId=e,CallManager.displayName=f,CallManager.alternative_username=g,CallManager.p2pAddress=h,CallManager.keepConnected=i,CallManager._mcuCall=!1,CallManager._establishMonitorId=DateTimeUtil.getNow();var k=CallManager._establishMonitorId;CallManager._destination&&CallManager._destination.indexOf("@vidiconf.com")>-1&&setTimeout(function(){if(k==CallManager._establishMonitorId){var a="CallManager CallManager._establishMonitorId starting Call again";this.log(a),CallManager.redialCall(a)}},CallManager._establishMonitorTimeout),b&&b.indexOf("#")==-1&&b.indexOf("%23")==-1&&(b=b+"%23"+LineStatesModel.getNextAvailableLine()),CallManager.resetFlags(),Platform.initiateCall(a,b,c,d,e,f,g,h,j),ConnectionManager._dispatchEvent("PLACECALL_ZEBRA_SENT",{msg:"inner"})},CallManager._initCallInnerSetTime=(new Date).getTime(),CallManager.checkCall(),CallManager._keepConnected=null,void(i&&(CallManager._keepConnected=function(){this.log("CallManager CallManager._keepConnected starting Call again"),ConnectionManager._dispatchEvent("ZWRTC_PLACING_CALL_STEPS",{msg:" KEEP CONNECTED MONITOR ALARM"}),zwrtc.hangup(),CallManager.initCall(a,b,c,d,e,f,g,h,i,j)})))},resetFlags:function(){this.checkCamEnabledState=!1,this.lastCamEnabledState=null,this.lastMicEnabledState=null,this.lastMicEnabled=!1,this.lastCamEnabled=!1},checkCall:function(){return this.log("checkCall:"+ConnectionManager.zsState+" "+CallManager.zsRedirected),ConnectionManager.isSpecialUser(ConnectionManager.userId)?void console.error("Ignoring checkCall for special user: "+ConnectionManager.userId):void("waiting"==ConnectionManager.zsState||CallManager.zsRedirected?(CallManager.zsRedirected=!1,null!=CallManager._initCallInner?((new Date).getTime()-CallManager._initCallInnerSetTime<CallManager._initCallInnerTimeout?CallManager._initCallInner():this.log("CallManager checkCall timed out"),CallManager._initCallInner=null):CallManager._keepConnected&&null==CallManager._establishMonitorId&&(this.log("CallManager call keep connected"),CallManager._keepConnected())):"disconnected"==ConnectionManager.zsState&&null==CallManager._initCallInner&&null==CallManager._keepConnected&&(zwrtc.isP2P()||zwrtc.isMCU())&&this.endCall())},cancelCall:function(){this.log("CallManager CallManager.cancelCall"),CallManager._establishMonitorId=null,CallManager._keepConnected=null,CallManager._establish=!1,this._audioRecordingCallEnabled=!1,CallManager._recordP2P&&!CallManager.muteP2PAudioFromStartTillRecording&&(CallManager._recordP2P=!1)},isEstablished:function(){return CallManager._establish},useNewSSExt:function(){return!(!this._useNewSSExt||!(zwrtc.isP2P()||zwrtc._enableSFU||zwrtc._disableSML))},callEstablished:function(){if(this.log("CallManager CallManager._establishMonitorId callEstablished"),CallManager._establishMonitorId=null,CallManager._establish=!0,CallManager._redialCounter=0,CallManager.mediaErrorCounter=0,CallManager.setWebCamActive({isVideoMuted:TechCheck.isVideoMuted}),CallManager.sendClientToSaturnUserProps(),!this.useNewSSExt()&&$("#SP_SS_EXT_DIV").length>0){var a=DataStore.getUserData("username",""),b=DataStore.getUserData("stun_turn","{'username': '', 'password': '', 'uris': ['stun:stun.l.google.com:19302']}"),c=this.getServerIP(),d=c+":"+DataStore.getUserData("mcu_sip_port",""),e=CallManager.W2SPort,f={};f.username=a,f.zsip=c,f.zsport=e,f.mcuIPPort=d,f.stunserver_config=JSON.parse(b),f.service=ConnectionManager.service,f.sessionid=DataStore.getUserData("session_id",""),f.endPoint=this.getEndPoint()+(ConnectionManager.ZSServlet||""),f.maxWidth=ssController.maxWidth,f.maxHeight=ssController.maxHeight,f.maxFPS=ssController.fps,f.minFPS=ssController.fps,f.DtlsSrtpKeyAgreement=this.DtlsSrtpKeyAgreement,$("#SP_SS_EXT_DIV")[0].innerHTML=JSON.stringify(f),this.dispatchMessageToExtension("EXT_CALL_ESTABLISHED")}},dispatchMessageToExtension:function(a){if(!this._disableSS){var b=document.createEvent("Event");b.initEvent(a,!0,!0),window.dispatchEvent(b)}},recordingCall:function(){this.callEstablished()},mcuDisconnect:function(a){this.disconnectCall()},disconnectCall:function(){CallManager.CALL_HANDLING&&(CallManager._mutedByMAPT=!1,CallManager._mcuCall=!1,CallManager._callToken=null,CallManager._hangUpIfNoSR=!1,CallManager._type=CallManager.VIDEO,this.log("CallManager disconnectCall"),zwrtc.hangup(),CallManager.cancelCall(),CallManager._dispatchEvent(CallManager.Event.ENDED),CallManager.shareScreenStop(),!this.useNewSSExt()&&$("#SP_SS_EXT_DIV").length>0&&this.dispatchMessageToExtension("EXT_CALL_TERMINATED"))},connectToMCU:function(a){if(CallManager._mcuCall)return void this.log("CallManager connectToMCU, ignoring as mcu call already going on");if(!this.connectResponseRecvd)return this._pendingMCUCall=!0,void(this._pendingVideoCall=a);this._pendingMCUCall=!1,CallManager._mcuCall=!0;var b="rtcshadow_size_"+zwrtc.cam_width+"_"+zwrtc.cam_height;a||(b="rtcshadowaudio");try{zwrtc.screen&&(b="rtcshadowscreen")}catch(c){}this.debugLog("sip:"+b+"@"+this.getServerIP()+":"+DataStore.getUserData("mcu_sip_port","")),zwrtc.placeCall(a,"sip:"+b+"@"+this.getServerIP()+":"+DataStore.getUserData("mcu_sip_port",""),1,this.getServerIP())},getEndPoint:function(){return window.zcallerHostname||DataStore.getUserData("endpoint","")||ConnectionManager.CLS},getServerIP:function(){var a=CallManager.getEndPoint();return a&&(a=a.replace("http://",""),a=a.replace("https://",""),a=a.split(":")[0]),"localhost"},hangUpLine:function(a){var b=new Zebra("CALL_CONTROL");b.setZEvent("action","HANGUP"),b.setZEvent("line_number",a),ConnectionManager.sendZebraToMCU(b)},onUnload:function(){if(CallManager.CALL_HANDLING)return this.log("CallManager onUnload"),CallManager.clearCall(),ConnectionManager.wsPossible?void ConnectionManager.sendWSJSonMessage({type:"unregister"}):void Platform.httpRequest("POST",CallManager.getEndPoint()+(ConnectionManager.ZSServlet||""),null,"comm=unregister&username="+DataStore.getUserData("username","")+"&service="+(ConnectionManager.service||""),!1)},clearCall:function(){CallManager.cancelCall(),CallManager._dispatchEvent(CallManager.Event.ENDED),ConnectionManager._dispatchEvent("MCUDISCONNECT",{reason:"0"})},sendEndCall:function(a){if(ConnectionManager.wsPossible){if(!CallManager.disableDisconnect)if(ConnectionManager.doBlackboard){var b=new Zebra("com.blackboard.saturn.zag.zebra.VideoConference#ClientToMCUDisconnect");a&&b.setZEvent("error_msg",a),CallManager.httpLegID&&b.setZEvent("http_leg_id",CallManager.httpLegID),ConnectionManager.sendZSZebraCommand("zsMessage",b)}else ConnectionManager.sendWSJSonMessage({type:"endcall"});return void CallManager._dispatchEvent(CallManager.Event.ENDED)}Platform.httpRequest("POST",CallManager.getEndPoint()+(ConnectionManager.ZSServlet||""),null,"comm=endcall&username="+DataStore.getUserData("username","")+"&service="+(ConnectionManager.service||""),null)},endCall:function(){CallManager.CALL_HANDLING&&(this.log("CallManager endCall"),CallManager.clearCall(),CallManager.sendEndCall("CallManager endCall"))},mcuNotAvailable:function(){this.enableWaitingState?(this.mediaRedialDisabled=!0,ConnectionManager.allowMediaCall&&ZVideoViewController.dispatchWaitingState()):this.redialMcuCall()},mcuAvailableNow:function(){this.mediaRedialDisabled=!1,this.redialMcuCall()},redialMcuCall:function(a){if(ConnectionManager.isSpecialUser(ConnectionManager.userId))return void console.error("Ignoring redialMcuCall for special user: "+ConnectionManager.userId);if(this.mediaRedialDisabled)return void console.error("Ignoring redialMcuCall as waiting for new Media Capacity");this.log("CallManager: redialMcuCall: terminate current call & redial it"),CallManager.allowTelemetryConnect=!0;var b=this.getZEvent(a,"new_session",null);if(b)ConnectionManager.roomSession=b,this.mediaFailed&&this.mediaFailed.name?this.mediaConnectionFailed(this.mediaFailed.name,this.mediaFailed.data):(CallManager.redialNow("Switching between Breakout Rooms"),ConnectionManager._dispatchEvent("REDIALLING_FOR_BOR"));else if(CallManager.seamlessMigration){if(rtcSFU.rvCompositeHigh)if(rtcSFU.rvCompositeHigh.isPCConnected()){CallManager.eventsDisabled=!0,ConnectionManager._dispatchEvent("SESSION_MIGRATION_START",{mcu:ConnectionManager.getZS()});var c=rtcSFU.rvCompositeHigh.peerConnection;rtcSFU.rvCompositeHigh.peerConnection=null,CallManager.peerConnection=c,webRTC.localStream!==rtcSFU._localStream&&(CallManager.oldLocalStream=rtcSFU._localStream,rtcSFU._localStream=null),c.onicecandidate=null,c.ontrack=null,c.onremovestream=null,c.oniceconnectionstatechange=null,c.onnegotiationneeded=null}else if(rtcSFU.rvCompositeHigh.ortcMedia){CallManager.eventsDisabled=!0,ConnectionManager._dispatchEvent("SESSION_MIGRATION_START",{mcu:ConnectionManager.getZS()});var d=rtcSFU.rvCompositeHigh.ortcMedia;rtcSFU.rvCompositeHigh.ortcMedia=null,CallManager.ortcMedia=d,d.unregister()}if(rtcSFU.desktopStream&&rtcSFU.desktopStream.isPCConnected()){var e=rtcSFU.desktopStream.peerConnection;CallManager.desktopPeerConnection=e,CallManager.desktopStream=ssController.desktopStream,rtcSFU.desktopStream.peerConnection=null,rtcSFU.desktopStream=null,ssController.desktopStream=null,e.onicecandidate=null,e.ontrack=null,e.onremovestream=null,e.oniceconnectionstatechange=null,e.onnegotiationneeded=null}CallManager.redialCallWithError(AVSDKErrors.SATURN_REDIAL)}else CallManager.redialCallWithError(AVSDKErrors.SATURN_REDIAL)},mediaConnectionFailed:function(a,b){this.mediaFailed={name:a,data:b},"ZMEDIA_ERROR"===a?ZVideoViewController.zmediaError(b):ConnectionManager._dispatchEvent(a,b)},rxBitRateIndication:function(a){if(this.log("CallManager: rxBitRateIndication"),a){this.log("CallManager: rxBitRateIndication:"+a.toXML());var b=this.getZEvent(a,"bandwidthMode","BandNormal");if(!CallManager._flashEnabled){if("ultraLow"===this.selfAppshareBR||"BandUltraLowAppShare"!==b&&"BandUltraLowAppShareAndAudio"!==b?"ultraLow"===this.selfAppshareBR&&(this.selfAppshareBR="normal",this._ssDetected&&ConnectionManager._dispatchEvent("RECEIVE_APPSHARE_NORMAL")):(this.selfAppshareBR="ultraLow",ConnectionManager._dispatchEvent("RECEIVE_APPSHARE_ULTRA_LOW")),CallManager.dynamicBwdEnabled&&"BandLowAudioOnly"===b||"BandUltraLowAudioOnly"===b)return CallManager.dynamicBwdEnabled=!0,rtcSFU.checkMcuVideo=!0,void("BandLowAudioOnly"!==this.selfLowBR&&(this.selfLowBR="BandLowAudioOnly",ConnectionManager._dispatchEvent("RECEIVE_AUDIO_ONLY",{mode:"dynamic"})));if(CallManager.dynamicBwdEnabled&&"BandLowAudioOnly"!==this.selfLowBR)return void this.log("Ignoring zebra as dynamic bandwidth is enabled");if("BandLowAudioOnly"!==b){var c=BandwidthModes.modes;if(c.camera.indexOf(b)>-1||c.appshare.indexOf(b)>-1||c.whiteboard.indexOf(b)>-1)return CallManager.dynamicBwdEnabled=!0,rtcSFU.checkMcuVideo=!0,this.log("Dynamic Bwd enabled"),void("BandLowAudioOnly"===this.selfLowBR&&(this.selfLowBR="normal",ConnectionManager._dispatchEvent("RECEIVE_NORMAL"),this._ssDetected&&ConnectionManager._dispatchEvent("ZSCREENSHARE_RECEIVER_START",{extraChannels:!0,userId:ssController.userId})));this.log("UNKNOWN bandwidth mode received: mode = "+b)}}CallManager.self_lowbr_mode!=b&&(CallManager.self_lowbr_mode=b,CallManager._flashEnabled?flashClient.handleMAPT(flashClient._lastMAPTZebra):rtcSFU.maptParser(rtcSFU._lastMAPTZebra))}},txBitRateIndication:function(a){if(this.log("CallManager: txBitRateIndication"),a){this.log("CallManager: txBitRateIndication:"+a.toXML());var b=this.getZEvent(a,"mode",null),c=!0;if(b===this.UP_CONG_MODE_WARN?"BandLowWithVideo"===CallManager.upLowBrMode||TechCheck.isVideoMuted||(CallManager.upLowBrMode="BandLowWithVideo",ConnectionManager._dispatchEvent("SEND_LOW_QUALITY")):b===this.UP_CONG_MODE_CAM_OFF?(c=!1,"BandLowAudioOnly"===CallManager.upLowBrMode||TechCheck.isVideoMuted||(CallManager.upLowBrMode="BandLowAudioOnly",ConnectionManager._dispatchEvent("SEND_VIDEO_ABORTED"))):b==this.UP_CONG_MODE_SCREEN_OFF&&rtcSFU.desktopStream&&(c=!1,ConnectionManager._dispatchEvent("SEND_APPSHARE_ABORTED")),CallManager._flashEnabled&&c){var d=parseInt(this.getZEvent(a,"target_bit_rate",null));isNaN(d)||flashClient.updateUploadBR(d)}}},sendBandwidthModeZebra:function(a,b,c,d){if("BandNormal"===a||"BandLowWithVideo"===a||"BandLowAudioOnly"===a||BandwidthModes.modes.appshare.indexOf(a)>-1||BandwidthModes.modes.whiteboard.indexOf(a)>-1||BandwidthModes.modes.camera.indexOf(a)>-1){var e=new Zebra("ClientToZMCUUserProps");e.setZEvent("bandwidthMode",a),null==b&&(b=0),e.setZEvent("download",String(b)),null==c&&(c=0),e.setZEvent("avgSrtt",String(c)),null==d&&(d=0),e.setZEvent("srtt",String(d)),e.setZebraAttribute("userId",rtcSFU.getUserName()),ConnectionManager.sendZSCommand("sendMessageToMCU","command=zebra&contents="+escape(e.toXML())),this.log("sendBandwidthModeZebra: zebra = "+e.toXML())}else this.log("sendBandwidthModeZebra: unknown bandwidthMode = "+a)},incomingCall:function(a){if(CallManager.CALL_HANDLING){this.log("CallManager incomingCall");var b=a.getZEvent("callToken").value,c=a.getZEvent("caller").value,d=a.getZEvent("callerAudioCodecs").value,e=a.getZEvent("callerMaxDownload").value,f=a.getZEvent("callerP2PAddress").value,g=a.getZEvent("callerVBSession").value,h=a.getZEvent("callerVideoCodecs").value,i=a.getZEvent("callerVideoHeight").value,j=a.getZEvent("callerVideoWidth").value,k=a.getZEvent("chat_session_id").value,l=a.getZEvent("contactaddress").value,m=a.getZEvent("contactid").value,n=a.getZEvent("contactname").value,o=a.getZEvent("contacttype").value,p=a.getZEvent("type").value,q=a.getZEvent("zenonserver").value;CallManager._dispatchEvent(CallManager.Event.INCOMING_CALL),this.AUTO_ANSWER?CallManager.acceptCall(b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q):ConnectionManager.Platform.isSayPageApp?showMessage("Incoming Call","Call from "+c,!0,null,"Answer",function(){CallManager.acceptCall(b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q)},!1,null,"Ignore"):Z.jqm.showNJQMChoiceDialog("Accept call from "+c,function(){CallManager.acceptCall(b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q)},6e4)}},getWrtcAddress:function(a){if(a)for(var b=a.split(","),c=0;c<b.length;c++){var d=b[c].split(":");if("wrtc"==d[0])return d[1]}return null},acceptCall:function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){if(ConnectionManager.wsPossible)return void ConnectionManager.sendWSJSonMessage({type:"zsmessage",value:"ACCEPT%23"+LineStatesModel.getNextAvailableLine()});if(Platform.httpRequest("POST",CallManager.getEndPoint()+(ConnectionManager.ZSServlet||""),null,"comm=zsmessage&command=ZENONWAKERESPONSE&value=ACCEPT%23"+LineStatesModel.getNextAvailableLine()+"&username="+DataStore.getUserData("username","")+"&service="+(ConnectionManager.service||""),null),zwrtc.stopSound(),!ConnectionManager.inCall()){var q=CallManager.getWrtcAddress(e);CallManager._callToken=a,CallManager._type=o;var r=!0;"VOICE"==o&&(r=!1),CallManager._flashEnabled?ConnectionManager._dispatchEvent("FLASH_INIT_INCOMING_CALL",{callerP2PAddress:e,type:o,zenonserver:p,callToken:a}):null==q||zwrtc.viewOnly?(this.connectToMCU(r),this.sendPlaceCall(!1)):(CallManager._mcuCall=!1,zwrtc.placeP2PCall(q,r))}},sendPlaceCall:function(a){if(this.log("CallManager sendPlaceCall:"+CallManager._callToken+" p2p:"+a),null!=CallManager._callToken){var b=new Zebra("org.zenon.server.zebra.ZebraHandler#placeCall");b.setZEvent("callToken",CallManager._callToken),b.setZEvent("avfrw","false"),b.setZEvent("isP2P",a);var c=176,d=144;try{c=zwrtc.in_video_width,d=zwrtc.in_video_height}catch(e){}b.setZEvent("width",c),b.setZEvent("height",d),b.setZEvent("client","webrtc"),CallManager.loadLowBrMode?b.setZEvent("bandwidthMode",CallManager.loadLowBrMode):CallManager.lowBrMode&&b.setZEvent("bandwidthMode",CallManager.lowBrMode),ConnectionManager.sendZSZebraCommand("placeCall",b),CallManager._callToken=null}},sendInitialVad:function(){this.checkMicEnabledState=!1,this.lastMicEnabledState=null;var a=TechCheck.isAudioMuted?0:1;rtcSFU.sendVadZebra(a,a)},randomString:function(a){for(var b="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",c="",d=0;d<a;d++){var e=Math.round(Math.random()*(b.length-1));c+=b[e]}return c},generateCallID:function(){var a=""+(new Date).getTime(),b=Math.ceil(a.length/3);return this.randomString(8)+"-"+a.substring(0,b)+"-"+a.substring(b,2*b)+"-"+a.substring(2*b)+"-"+this.randomString(12)},log:function(a){(this.logEnabled||Platform.debugLogEnabled)&&Platform.log("CallManager: "+a)},debugLog:function(a){Platform.debugLogEnabled&&Platform.log("CallManager:"+a)}}),Model=EventDispatcher.extend({anchor:"",
items:null,itemsCache:null,views:null,isLoading:!0,minPersistPeriodMillis:0,lastPersistTime:0,persistenceSchedule:null,persistenceRetrieved:!1,modelChanged:!0,isPolled:!1,isUserRequest:!0,timeOutIdA:[],searchTimeoutPeriod:1e4,isConnectionMade:!1,logging:!1,refTime:0,myLog:"Logs:-",isAllFiltered:!0,seqNumber:0,log:function(a){},getMyLog:function(){var a=this.myLog,b=this.refTime;this.refTime=(new Date).getTime();var c=this.refTime-b;return this.myLog="["+c+"]Logs:-",a},init:function(a,b,c,d){this._super(),this.items=[],this.views=[],this.itemsCache={},this.lastParsingTime=0,this.isLoading=!0,this.lastParsingTime=0,this.isParsing=!1,this.minPersistPeriodMillis=isNaN(d)?Model.DEFAULT_MIN_PERSIST_GAP:d,this.addListener=this._addListener,this.removeListener=this._removeListener,this.removeAllListeners=this._removeAllListeners,this.removeAllListenersForEvent=this._removeAllListenersForEvent,this.fmt10PropNames=b,this.persistenceRetrieved=!1,this.persistName=c||"",""==this.persistName&&(this.persistenceRetrieved=!0);var e=this;""!=this.persistName&&(DataStore.addListener(DataStore.Event.LOADED_DATA_STORE,this,function(a){a.userStoreError||e.restorePersistence(!0)}),DataStore&&DataStore.loadedUserStore&&this.restorePersistence(!1)),a&&""!=a&&ConnectionManager.addListener("ZEBRA:"+a,this,this.modelZebraHandler),ConnectionManager.addListener(ConnectionManager.Event.LOGGED_OUT,this,function(){this.clearModel(!0)})},addConnectionMadeListener:function(){var a=this;ConnectionManager.addListener(ConnectionManager.Event.CONNECTION_MADE,this,function(b){a.isConnectionMade=!0,a.persistenceRetrieved&&!ConnectionManager.doBlackboard&&a.requestRefreshModel()})},timeoutSearch:function(){if(0!=this.timeOutIdA.length){for(;this.timeOutIdA.length>0;){var a=this.timeOutIdA.pop();clearTimeout(a)}this.isLoading=!1,this._dispatchEvent(Model.Event.SEARCH_TIMEOUT)}},searchCompleted:function(){if(0!=this.timeOutIdA.length)for(;this.timeOutIdA.length>0;){var a=this.timeOutIdA.pop();clearTimeout(a)}},addTimeoutSearch:function(){this.searchCompleted();var a=this,b=setTimeout(function(){a.timeoutSearch()},this.searchTimeoutPeriod);this.timeOutIdA.push(b),this._dispatchEvent(Model.Event.SEARCH_REQUESTED)},itemsView:function(a,b){var c=this,d=c.items.slice();return d.__sort=d.sort,d.__push=d.push,d.__splice=d.splice,d.filter=function(a){if(a!=d.filterFunction){try{d.__splice(0,d.length);for(var b=0;b<c.items.length;++b)a&&1!=a(c.items[b])||d.__push(c.items[b]);d.sortFunction&&d.__sort(d.sortFunction)}catch(e){return Platform.log("exception occured in filter"+e),void(this.views=[])}d.filterFunction=a}},d.sort=function(a){if(a!=d.sortFunction){try{if(a)d.__sort(a);else{d.__splice(0,d.length);for(var b=0;b<c.items.length;++b)d.filterFunction&&1!=d.filterFunction(c.items[b])||d.__push(c.items[b])}}catch(e){return Platform.log("exception occured in sorting"+e),void(this.views=[])}d.sortFunction=a}},d.refresh=function(a,b,e){if(e||a!=d.filterFunction||b!=d.sortFunction){try{d.splice(0,d.length);for(var f=0;f<c.items.length;++f)a&&1!=a(c.items[f])||d.__push(c.items[f]);b&&d.__sort(b)}catch(g){Platform.log("exception occured in refresh"+g),this.views=[]}d.filterFunction=a,d.sortFunction=b}},d.insertPosition=function(a){try{if(d.filterFunction&&!d.filterFunction(a))return null}catch(b){return Platform.log("exception in insert position - filter"+b),this.views=[],null}try{if(d.sortFunction){var e;for(e=0;e<d.length;++e){if(d[e]==a)return 0-e-10;if(d.sortFunction(a,d[e])<=0)return e}return e}}catch(b){return Platform.log("exception happen in insert position - sorting"+b),this.views=[],null}for(var e=0,f=0;f<c.items.length;++f){if(c.items[f]==a)return e;d[e]==c.items[f]&&++e}return null},d.destroy=function(){d.__splice(0,d.length),d.filter=d.sort=d.refresh=d.insertPosition=d.push=d.destroy=function(){throw"This model view has been destroyed!"};for(var a=0;a<c.views.length;++a)if(d==c.views[a])return c.views.splice(a,1)},d.refresh(a,b),c.views.push(d),d},toPersistObject:function(){return{anchor:this.anchor,propsList:this.items}},fromPersistObject:function(a){this.anchor=a.anchor,this.updateItems("update",a.propsList,!1)},persistKey:function(){return"model_"+this.persistName},persistNow:function(){if(""!=this.persistName&&!this.persistenceSchedule){var a=this,b=function(){ContactModel&&(0==ContactModel.refTime&&(ContactModel.refTime=(new Date).getTime()),ContactModel.logging=!0,ContactModel.log(a.persistName+" - persistNow start")),DataStore.setUserData(a.persistKey(),JSON.stringify(a.toPersistObject()),!0),delete DataStore.userStoreCache[a.persistKey()],a.persistenceSchedule=null,a.lastPersistTime=(new Date).getTime(),ContactModel&&(0==ContactModel.refTime&&(ContactModel.refTime=(new Date).getTime()),ContactModel.logging=!0,ContactModel.log(a.persistName+" - persistNow end"))},c=(new Date).getTime()-this.lastPersistTime;this.lastPersistTime>0&&this.minPersistPeriodMillis>c?this.persistenceSchedule=setTimeout(b,this.minPersistPeriodMillis-c):b()}},restorePersistence:function(a){var b=DataStore.getUserData(this.persistKey(),"");try{do{if(""==b)break;this.clearModel(!1),this.fromPersistObject(JSON.parse(unescape(b))),delete DataStore.userStoreCache[this.persistKey()]}while(!1)}catch(c){}this.persistenceRetrieved=!0,this.isConnectionMade&&!ConnectionManager.doBlackboard&&this.requestRefreshModel()},requestRefreshModel:function(){},modelZebraHandler:function(a,b){},modelZebraHandlerInner:function(a,b){this.logging&&this.log("modelZebraHandler start");var c=this,d=function(){c.isLoading&&(c.isLoading=!1),c._dispatchEvent(Model.Event.MODEL_ZEBRA_PARSED,a),c._dispatchEvent(Model.Event.ZEBRA_PARSING_COMPLETE,a),b&&b(a),c.isParsing=!1,c.searchCompleted()};if(!a)return d();if("0"!=(a.getZebraAttribute("error_code")||"0"))return this._dispatchEvent(Model.Event.MODEL_ZEBRA_ERROR,{errorCode:a.getZebraAttribute("error_code"),errorMessage:a.getZEventValue("error_message","")}),d();if(a.getZebraAttribute("seq")&&""!=a.getZebraAttribute("seq")&&parseInt(a.getZebraAttribute("seq"))){if(!(parseInt(a.getZebraAttribute("seq"))>this.seqNumber))return d();this.seqNumber=parseInt(a.getZebraAttribute("seq"))}else var e=a.getZebraAttribute("fmt");var f,g;if(e&&""!=e&&"1.0"!=e){if("2.0"==e){if(!a.list)return d();f=a.list.mode,"insert"!=f&&"delete"!=f&&(f="update"),g=a.list.items}}else{var h=a.getZEvent("item_keys");if(!h)return d(),void this._dispatchEvent(Model.Event.MODEL_LOADED);f=h.mode,"insert"!=f&&"delete"!=f&&(f="update");var i=h.value.split(",");if(g=[],this.fmt10PropNames)for(var j,k,l,m=0;m<i.length;m++)if(i[m]&&""!=i[m]){k=i[m],j={id:k};for(var n=0;n<this.fmt10PropNames.length;n++)l=a.getZEvent(this.fmt10PropNames[n]+"_"+k),l&&(j[this.fmt10PropNames[n]]=l.value);g.push(j)}}this.logging&&this.log("parsing end");var o=""!=this.persistName;this.updateItems(f,g,o),this.anchor=a.getZebraAttribute("anchor")||this.anchor,d(),!this.isAllFiltered||"insert"!=f&&"delete"!=f||this._dispatchEvent(Model.Event.MODEL_LOADED),o&&Platform.papi(this.persistKey()).addOrUpdateItems({anchor:this.anchor}),this.logging&&this.log("modelZebraHandler end")},checkIfModelChanged:function(a,b){if(!a)return!0;for(var c in b){var d="["+a[c]+"]",e="["+b[c]+"]";if(d!=e)return Platform.log("mismatch prop is : first"+d+" second "+e),!0}return!1},updateItems:function(a,b,c){if(a){this.isLoading&&(this.isLoading=!1);var d={};if(this.modelChanged=!0,b&&0!=b.length||this._dispatchEvent(Model.Event.MODEL_LOADED),this.isPolled&&(this.modelChanged=!1,"update"==a&&b&&b.length!=this.items.length&&(this.modelChanged=!0),b&&!this.modelChanged&&("update"==a||"insert"==a)))for(var e={},f=0;f<b.length;f++)if(b[f].id){for(var g in b[f])e[g]=b[f][g];var h=this.itemsCache[b[f].id],i=this.propsToItem(e);if(this.modelChanged=this.checkIfModelChanged(h,i),e={},this.modelChanged)break}if("update"==a){if(this.logging&&this.log("update start"),!this.modelChanged)return;if(this.clearModel(!b||0==b.length,c),b&&b.length>0){for(var f=0;f<b.length;f++)b[f].id&&(this.createOrUpdateItem(b[f],!1,c),this._dispatchEvent(Model.Event.MODEL_ADD,b[f]));for(var f=0;f<this.items.length;f++)if(c){var j=this.items[f],k=JSON.stringify(j),l=""+this.items[f].id;d[l]=escape(k)}c&&Platform.papi(this.persistKey()).addOrUpdateItems(d,null),this._dispatchEvent(Model.Event.MODEL_RELOAD),this._dispatchEvent(Model.Event.MODEL_CHANGE)}this.logging&&this.log("update end")}else if("insert"==a){if(!this.modelChanged)return;for(var f=0;f<b.length;f++)if(b[f].id)try{this.createOrUpdateItem(b[f],!0,c)}catch(m){"undefined"!=typeof console&&console.log(m.stack)}if(c)for(var f=0;f<b.length;f++)if(b[f].id){var j=this.getItem(b[f].id),k=JSON.stringify(j),l=""+b[f].id;d[l]=escape(k)}c&&Platform.papi(this.persistKey()).addOrUpdateItems(d,null)}else if("delete"==a)for(var f=0;f<b.length;f++)b[f].id&&(this.removeItem(b[f].id),c&&Platform.papi(this.persistKey()).deleteRow(b[f].id))}},clearModel:function(a,b){this.items=[],this.itemsCache={};for(var c,d=0;d<this.views.length;++d)c=this.views[d],c.__splice(0,c.length);a&&(this._dispatchEvent(Model.Event.MODEL_CLEAR),this._dispatchEvent(Model.Event.MODEL_CHANGE)),b&&Platform.papi(this.persistKey()).clearModel()},createOrUpdateItem:function(a,b,c){this.isLoading&&(this.isLoading=!1);var d=this.itemsCache[a.id];if(d){for(var e in a)d[e]=a[e];this.propsToItem(d);for(var f,g=function(a){var b=!!a.filterFunction&&!a.filterFunction(d);b||(this.isAllFiltered=!1);for(var c=!1,e=!1,f=0;f<a.length;++f)try{if(a[f]==d){if(b||c)return void a.__splice(f,1);if(!a.sortFunction||!(f>0&&a.sortFunction(a[f-1],d)>0||f<a.length-1&&a.sortFunction(d,a[f+1])>0))return;a.__splice(f,1),--f,e=!0}else if(!c&&a.sortFunction&&a.sortFunction(d,a[f])<=0){if(a.__splice(f,0,d),e)return;++f,c=!0}}catch(g){return Platform.log("CAUGHT "+g),!0}b||c||a.push(d)},h=[],i=0;i<this.views.length;++i)if(f=this.views[i],f.sortFunction||f.filterFunction){var j=g(f);j&&h.push(f)}for(var f,i=0;i<h.length;++i)Platform.log(" DESTROY VIEW WHICH IS NOT LONGER VALID"),f=h[i],f.destroy();return void(b&&(this._dispatchEvent(Model.Event.MODEL_UPDATE,d),this._dispatchEvent(Model.Event.MODEL_CHANGE)))}d=this.propsToItem(a),this.items.push(d),this.itemsCache[d.id]=d;for(var k,l,m=0;m<this.views.length;++m)k=this.views[m],l=k.insertPosition(d),null!=l&&(this.isAllFiltered=!1),l>=0&&k.__splice(l,0,d);b&&(this._dispatchEvent(Model.Event.MODEL_ADD,d),this._dispatchEvent(Model.Event.MODEL_CHANGE))},removeItem:function(a,b){for(var c,d=this.itemsCache[a],e=0;e<this.views.length;++e){c=this.views[e];for(var f=0;f<c.length;++f)if(c[f].id==a){c.__splice(f,1);break}}for(var e=0;e<this.items.length;++e)if(this.items[e].id==a){this.items.splice(e,1),this._dispatchEvent(Model.Event.MODEL_REMOVE,d),this._dispatchEvent(Model.Event.MODEL_CHANGE);break}return delete this.itemsCache[a],b&&Platform.papi(this.persistKey()).deleteRow(a),d},getItem:function(a){var b=this.itemsCache[a];if(!b)for(var c=0;c<this.items.length;c++)if(this.items[c].id==a){b=this.items[c];break}return b},propsToItem:function(a){return a}}),Model.zebraPool=[],Model.dispatchZebraRequest=function(){if(0!=Model.zebraPool.length){var a=Model.zebraPool,b=a.shift();if(b&&b.zebra){var c=b.that;if(!c)return;var d=(new Date).getTime();!c.lastParsingTime||!c.isParsing||c.isParsing&&d-c.lastParsingTime>2e3?(c.lastParsingTime=d,c.isParsing=!0,setTimeout(function(){c.modelZebraHandlerInner(b.zebra,b.finishFunction),Model.dispatchZebraRequest()},10)):(a.unshift(b),setTimeout(function(){Model.dispatchZebraRequest()},100))}}},Model.Event={MODEL_CHANGE:"MODEL_CHANGE",MODEL_ADD:"MODEL_ADD",MODEL_UPDATE:"MODEL_UPDATE",MODEL_REMOVE:"MODEL_REMOVE",MODEL_RELOAD:"MODEL_RELOAD",MODEL_CLEAR:"MODEL_CLEAR",MODEL_ZEBRA_PARSED:"MODEL_ZEBRA_PARSED",MODEL_ZEBRA_ERROR:"MODEL_ZEBRA_ERROR",MODEL_PERSISTED:"MODEL_PERSISTED",MODEL_LOADED:"MODEL_LOADED",SEARCH_REQUESTED:"SEARCH_REQUESTED",SEARCH_TIMEOUT:"SEARCH_TIMEOUT",ZEBRA_PARSING_COMPLETE:"ZEBRA_PARSING_COMPLETE"},Model.DEFAULT_MIN_PERSIST_GAP=2e4,AccountModel=Model.extendAsSingleton({init:function(){this._super("GATEWAYS_UPDATE",["type","label","address","name","state","statusMessage","feature","oAuthURL","fbLogoutURL","fbReloginURL"]),ConnectionManager.addListener("ZEBRA:GATEWAY_APP_INVITE",this,this.sendGatewayAppInvite)},propsToItem:function(a){if(a.type||(a.type=a.id),a.isAlwaysAvailable=!1,a.isRegistered=a.address&&""!=a.address,a.isAvailable=a.isRegistered||a.isAlwaysAvailable,a.isSignedIn="waiting"==a.state||"busy"==a.state||"connected"==a.state||"away"==a.state||a.isAlwaysAvailable,a.stateIsError="error"==a.state||"[error]"==a.state.substring(0,7),a.stateDescription=a.stateIsError?a.state.substring(7)||a.statusMessage:"",a.stateIsError)for(var b=ContactModel.items.slice(),c=0;c<b.length;++c)b[c].type==a.type&&(b[c].state="disconnected",ContactModel.createOrUpdateItem(b[c],!0));return a.stateImage=a.type,"tel"==a.type?a.stateImage+=".png":"waiting"==a.state?a.stateImage+="_online.png":"disconnected"==a.state?a.stateImage+="_offline.png":"connected"==a.state||"busy"==a.state?a.stateImage+="_busy.png":"away"==a.state?a.stateImage+="_away.png":"broadcasting"==a.state?a.stateImage+="_broadcasting.png":a.stateImage+="_offline.png","tel"!=a.type&&"sip"!=a.type&&"zen"!=a.type||(a.feature.search("video")==-1&&(a.feature="video,"+a.feature),a.feature.search("voice")==-1&&(a.feature="voice,"+a.feature)),a.hasFeature=function(a){return this.feature&&""!=this.feature&&this.feature.search(a)!=-1},a},requestAddOrModifyAccount:function(a,b,c,d){if(a&&""!=a&&(b!=AccountModel.getItem(a)||""!=(c||"")||d)){var e=new Zebra("com.requestec.smg.apps.xmpp.ZXMLGateway#addOrModifyGateway");if(e.setZEvent("type",a),b&&e.setZEvent("username",b),c&&e.setZEvent("password",c),d)for(var f in item)e.setZEvent(param[0],param[1]);ConnectionManager.sendZebra(e)}},requestRemoveAccount:function(a){if(a&&""!=a){var b=new Zebra("com.requestec.smg.apps.xmpp.ZXMLGateway#removeGateway");b.setZEvent("type",a),ConnectionManager.sendZebra(b)}},requestAccountChangeState:function(a,b,c){if(a&&""!=a&&b&&""!=b){var d=this.getItem(a);if(d){d.isSignedIn||this.createOrUpdateItem({id:a,state:"SIGNING_IN"},!0);var e=new Zebra("com.requestec.smg.apps.xmpp.ZXMLGateway#gatewayChangeState");e.setZEvent("type",a),e.setZEvent("state",b),c&&e.setZEvent("statusMessage",c),ConnectionManager.sendZebra(e)}}},requestAllAccountChangeState:function(a){if(a&&""!=a){var b=new Zebra("com.requestec.smg.apps.xmpp.ZXMLGateway#manualStateOverride");b.setZEvent("state",a),ConnectionManager.sendZebra(b)}},typeHasFeature:function(a,b){if(!a||""==a||!b||""==b)return!1;var c=this.getItem(a);return!!c&&c.hasFeature(b)},sendGatewayAppInvite:function(a){var b=a.getZEvent("user_id").value,c=a.getZEvent("message").value;Facebook.sendRequestToRecipients(b,c)}}),ContactModel=Model.extendAsSingleton({isModelRequested:!0,init:function(){this.tempContacts={},this.tempContactsA=[],this.invites=[],this._super("CONTACTS_UPDATE",["name","address","type","state","statusmessage","statusm","group","avatar","isAgent","vid","name_display","description","minidescription","categories","contactable_video","contactable_voice","contactable_im","contactable_free_meeting_room","cost_minute_im","cost_minute_voice","cost_minute_video","country_code","gender","rating","name_url","extension","aux_profile_message","is_charging","languages","languages_display","country_name","hospital_number","nhs_number","mobile_number","appointment_only"],"contactModel");ConnectionManager.addListener("ZEBRA:CONTACT_PROP_UPDATE",this,this.modelZebraHandler),ConnectionManager.addListener("ZEBRA:com.requestec.smg.apps.zcontact.ZBillingEngine#canCallStart:response",this,function(a){this.checkingCallStatus=!1,this._dispatchEvent(this.Event.CALL_STATUS_UPDATE,a)}),this.addConnectionMadeListener()},Event:{CALL_STATUS_UPDATE:"CALL_STATUS_UPDATE"},updateTempContactSateImage:function(a){var b=this.getContactWithFQA(a.fqa,!0);return b.stateImage=a.type,"tel"==a.type?b.stateImage+=".png":"waiting"==a.state?b.stateImage+="_online.png":"disconnected"==a.state?b.stateImage+="_offline.png":"connected"==a.state||"busy"==b.state?a.stateImage+="_busy.png":"away"==a.state?b.stateImage+="_away.png":"broadcasting"==a.state?b.stateImage+="_broadcasting.png":"appointment"==a.state?a.stateImage+="_appointment.png":b.stateImage+="_offline.png",b},propsToItem:function(a){if(a.name&&""!=a.name||(a.name=a.address),a.statusmessage=a.statusmessage||"",a.stateImage=a.type,"tel"==a.type?a.stateImage+=".png":"waiting"==a.state?a.stateImage+="_online.png":"disconnected"==a.state?a.stateImage+="_offline.png":"connected"==a.state||"busy"==a.state?a.stateImage+="_busy.png":"away"==a.state?a.stateImage+="_away.png":"broadcasting"==a.state?a.stateImage+="_broadcasting.png":"appointment"==a.state?a.stateImage+="_appointment.png":a.stateImage+="_offline.png",a.hasOwnProperty("avatar")&&(a.avatarid=a.avatar,delete a.avatar),(Platform.spm||Platform.isSayPageApp)&&a.avatarIdChanged){var b=this.itemsCache[a.id];b&&(!b||b.avatarid&&""!=b.avatarid)||a.avatarid&&""!=a.avatarid||(a.vid&&""!=a.vid?a.avatarid=a.vid:a.avatarid=DataStore.getUserData("vid"))}var c=this.itemsCache[a.id];if(Platform.spm||Platform.isSayPageApp?(a.aux_profile_message?a.statusmessage_description=a.aux_profile_message:a.statusmessage_description="","true"==a.contactable_video?a.has_cam=!0:a.has_cam=!1,"false"==a.is_charging&&""!=a.statusmessage_description&&(a.statusmessage_description="FREE Call. "+a.statusmessage_description)):a.statusmessage_description=a.statusmessage?a.statusmessage:"",a.statusmessage_description||(a.statusmessage_description=""),(Platform.spm||Platform.isSayPageApp)&&a.avatarIdChanged){var c=this.itemsCache[a.id];c||(c=a),a.avatarid.indexOf("empty")>-1&&(a.avatarid="profile_empty"),c||(c=a),a.avatarurl=ConnectionManager.getBasePictureURL()+"&pic=1&vid="+c.vid+"&avatar_id="+c.vid+"_"+a.avatarid}else a.avatarIdChanged&&(a.avatarid&&a.avatarid.indexOf("gallery_")>-1?a.avatarurl=parent.rootPath+"assets/images/"+a.avatarid+".jpg":a.avatarurl=""==a.avatarid?"":ConnectionManager.getBasePictureURL()+"&avatar_id="+a.avatarid+"&email="+a.address+"&type="+a.type);return a.fqa=a.type+":"+a.address,a.supportsFeature=function(a){if(AccountModel.isLoading)return!0;var b=AccountModel.getItem(this.type);return b&&b.hasFeature(a)},a.supportsMultipleIMSessions="zen"==a.type||a.supportsFeature("multipleIM"),a},clearModel:function(a){this._super(a),this.tempContacts={}},createOrUpdateItem:function(a,b,c){var d=this.itemsCache[a.id];a.avatarid=a.avatarid||a.avatar||a.avatar_id;var e=!1;if(!d||"null"==d||a.avatarid&&""!=a.avatarid&&"null"!=a.avatarid||(a.avatarid=d.avatarid,a.vid=d.vid),d&&"null"!=d||a.avatarid&&""!=a.avatarid&&"null"!=a.avatarid||!a.vid||""==a.vid||"null"==a.vid||(a.avatarid=a.vid),d&&"null"!=d&&d.avatarid==a.avatarid||(e=!0),a.avatarIdChanged=e,c||(a.avatarIdChanged=!1),this._super(a,b),a.avatarIdChanged&&(Platform.spm||Platform.isSayPageApp)){var f=this.getItem(a.id),g=f.avatarurl;if(!g)return;if(g.indexOf(":")>-1){var h=g.split(":",1)[0];if(h=h?h.toLowerCase():null,"http"!=h&&"https"!=h)return}var i=this;setTimeout(function(){Platform.downloadURL("GET",g,function(b,c,d){if(b!=g&&""!=b){f.avatarurl=b;var e=JSON.stringify(f),h=""+a.id,j={};j[h]=escape(e),Platform.papi(i.persistKey()).addOrUpdateItems(j,null),i._dispatchEvent(Model.Event.MODEL_UPDATE,f),i._dispatchEvent(Model.Event.MODEL_CHANGE)}})},200)}else{var j=this.itemsCache[a.id].fqa;if(this.tempContacts[j]&&delete this.tempContacts[j],a.avatarIdChanged){d=this.itemsCache[a.id];var g=d.avatarurl,h=g.split(":",1)[0];if(h=h?h.toLowerCase():null,"http"!=h&&"https"!=h)return;if(g.indexOf("avatar_id=gallery_")>-1){var k="",l=g,m="";if(""!=l){l=l.split("&");for(var n=0;n<l.length;n++)if(l[n].indexOf("avatar_id=gallery_")>-1){m=l[n];break}}k=parent.rootPath+"assets/images/"+m.trim().split("=")[1]+".jpg",d.avatarurl=k}else{var i=this;setTimeout(function(){Platform.downloadURL("GET",g,function(b,c,e){if(b!=g&&""!=b){d.avatarurl=b;var f=JSON.stringify(d),h=""+a.id,j={};j[h]=escape(f),Platform.papi(i.persistKey()).addOrUpdateItems(j,null),i._dispatchEvent(Model.Event.MODEL_UPDATE,d),i._dispatchEvent(Model.Event.MODEL_CHANGE)}})},200)}}}var o=this.itemsCache[a.id],p=this.getTempContact(o.fqa);if(p)for(var q in o)p[q]=o[q]},getTempContact:function(a){for(var b,c=0;c<this.tempContactsA.length;c++)if(this.tempContactsA[c].fqa==a){b=this.tempContactsA[c];break}return b},getContactWithFQA:function(a,b,c,d){if(!a||a.indexOf(":")==-1)return null;for(var e=0;e<this.items.length;e++)if(this.items[e].type+":"+this.items[e].address==a)return this.items[e];if(b){if(this.getTempContact(a)){var f=this.getTempContact(a);if(d)for(var g in d)"vid"==g?"-1"!=f[g]&&f[g]&&"null"!=f[g]&&"undefined"!=f[g]||(f[g]=d[g]):f[g]=d[g];c&&"undefined"!=c&"null"!=c&&""!=c&&c!=f.address&&(f.name=c)}else{var h=a.split(":")[0],i=a.substring(h.length+1),j=c?c:i,k=d&&d.vid?d.vid:"-1",l={};if(d)for(var g in d)l[g]=d[g];l.name=j,l.address=i,l.type=h,l.fqa=a,l.vid=k,l.statusmessage="",l.group="",d&&d.id?l.id=d.id:l.id="",d&&d.state&&(l.state=d.state),l.avatarIdChanged=!0,this.tempContactsA.push(this.propsToItem(l));var f=this.getTempContact(a);if(d)for(var g in d)"vid"==g?"-1"!=f[g]&&f[g]&&"null"!=f[g]&&"undefined"!=f[g]||(f[g]=d[g]):f[g]=d[g]}return this.getTempContact(a)}return null},requestRefreshModel:function(){var a=new Zebra("com.requestec.smg.apps.Vidiconf#contactsGet");a.setZebraAttribute("anchor",this.anchor),Platform.log(" ContactModel requestRefreshModel anchor "+this.anchor),ConnectionManager.sendZebra(a)},requestAddContact:function(a,b,c,d){if(b&&""!=b&&c&&""!=c){a||(a="");var e=new Zebra("com.requestec.smg.apps.xmpp.ZXMLGateway#addOrUpdateContact");e.setZEvent("name",a),e.setZEvent("type",b),e.setZEvent("address",c),d&&e.setZEvent("group",d),ConnectionManager.sendZebra(e)}},requestEditContact:function(a,b,c,d){if(a&&""!=a){var e=this.getItem(a);if(e.name!=b||e.address!=c||e.group!=d){var f=new Zebra("com.requestec.smg.apps.Vidiconf#contactEdit");f.setZEvent("contact_id",a),b&&f.setZEvent("name",b),c&&f.setZEvent("address",c),d&&f.setZEvent("group",d),ConnectionManager.sendZebra(f)}}},requestRemoveContact:function(a,b,c,d){if(a&&""!=a){var e=new Zebra("com.requestec.smg.apps.xmpp.ZXMLGateway#removeContact");e.setZEvent("contact_id",a),b&&e.setZEvent("type",b),c&&e.setZEvent("address",c),d&&e.setZEvent("group",d),ConnectionManager.sendZebra(e)}},getContactByVid:function(a){var b,c;return c=this.items.filter(function(b){return a==b.vid}),c.length>0&&(b=c[0]),b&&"CONTACT_REMOTE_DELETED"==b.statusm&&(b=null),b},checkCall:function(a,b){if(!this.checkingCallStatus){this.checkingCallStatus=!0,setTimeout(function(){ContactModel.checkingCallStatus=!1},2e3);var c=new Zebra("com.requestec.smg.apps.zcontact.ZBillingEngine#canCallStart");c.setZEvent("vid",a),b&&c.setZEvent("type",b),ConnectionManager.sendZebra(c,null,null,null,{fireNoSend:!0})}}}),LibraryModel=Model.extendAsSingleton({isModelRequested:!0,script_path:"",isConnectionMade:!1,isContentLibraryProcessed:!1,uploadURL:"",init:function(){this._super("LIBRARY_UPDATE",["name","folder","series","owner","autoload","description","ftype","path","updated","duration","pageCount","totalPages","pageList","pageTypeList","sourceType","styleSheet","upload_uid","cookieUrl","cookieValues"],"libraryModel"),ConnectionManager.addListener("ZEBRA:com.blackboard.saturn.zag.zebra.Whiteboard#libraryGet:response",this,this.modelZebraHandler),ConnectionManager.addListener("ZEBRA:LIBRARY_UPLOAD_URL",this,function(a){a.getZEvent("whiteboardUploadPath")&&a.getZEvent("whiteboardUploadPath").value&&a.getZEvent("whiteboardUploadPath").value.length>0&&(LibraryModel.uploadURL=a.getZEvent("whiteboardUploadPath").value,ConnectionManager.bbProxyURL&&(LibraryModel.uploadURL=ConnectionManager.bbProxyURL+LibraryModel.uploadURL))});this.addConnectionMadeListener(),this.addListener("ZEBRA_PARSING_COMPLETE",this,function(a){LibraryModel.items.sort(function(a,b){var c=DateTimeUtil.getDateObjFromDateString(a.updated),d=DateTimeUtil.getDateObjFromDateString(b.updated);return d.getTime()-c.getTime()})})},getFQA:function(){return IM.currentSession?IM.currentSession.contacts[0].fqa:""},getType:function(){return IM.currentSession?IM.currentSession.contacts[0].type:""},modelZebraHandler:function(a){this._super(a);try{this.isContentLibraryProcessed||"true"!==a.getZEvent("contentLibraryProcessed").value||(this.isContentLibraryProcessed=!0,ConnectionManager._dispatchEvent("ZEBRA:LIBRARY_CONTENT_COMPLETE"))}catch(b){}this._dispatchEvent(Model.Event.MODEL_UPDATE)},requestRefreshModel:function(){var a=new Zebra("com.blackboard.saturn.zag.zebra.Whiteboard#libraryGet");a.setZebraAttribute("anchor",this.anchor),"undefined"!=typeof na_chat_session_id&&a.setZEvent("chat_session_id","NA:"+na_chat_session_id),ConnectionManager.sendZebra(a)},requestRemoveLibrary:function(a){if(a&&""!=a){var b=new Zebra("com.blackboard.saturn.zag.zebra.Whiteboard#libraryDelete");b.setZEvent("id",a),ConnectionManager.sendZebra(b)}},requestRemoveAll:function(){ConnectionManager.sendZebra(new Zebra("com.blackboard.saturn.zag.zebra.Whiteboard#libraryDeleteAll"))},propsToItem:function(a){return a.updated&&(a.updated=DateTimeUtil.convertStringFromGMTString(a.updated)),a.pageList?a.pageList=JSON.parse(a.pageList):a.pageList=[],a.pageTypeList?a.pageTypeList=JSON.parse(a.pageTypeList):a.pageTypeList=[],a.cookieValues?a.cookieValues=JSON.parse(a.cookieValues):a.cookieValues={},a}}),RecordingModel=Model.extendAsSingleton({isModelRequested:!0,isConnectionMade:!1,init:function(){this._super("RECORDINGS_UPDATE",["emailList","filename","thumbnail","timestamp","duration","label"],"recordingModel"),ConnectionManager.addListener("ZEBRA:com.requestec.smg.zebra.MyRecordings#recordingsGet:response",this,this.modelZebraHandler);this.addConnectionMadeListener()},requestRefreshModel:function(){var a=new Zebra("com.requestec.smg.zebra.MyRecordings#recordingsGet");a.setZebraAttribute("anchor",this.anchor),ConnectionManager.sendZebra(a)},requestRemoveRecording:function(a){if(a&&""!=a){var b=new Zebra("com.requestec.smg.zebra.MyRecordings#recordingDelete");b.setZEvent("uid",a),ConnectionManager.sendZebra(b)}},propsToItem:function(a){return a.timestamp=DateTimeUtil.convertStringFromGMTString(a.timestamp),a},requestRemoveAll:function(){ConnectionManager.sendZebra(new Zebra("com.requestec.smg.zebra.MyRecordings#recordingDeleteAll"))},sendRecording:function(a){var b=RecordingModel.getItem(a);if(b&&b.filename&&""!=b.filename&&IM.isCallMUC()){var c=CallMUCMembers.callRoomId,d=new Zebra("com.requestec.smg.zebra.MyRecordings#recordingSend");d.setZEvent("path","<![CDATA["+b.filename+"]]>"),d.setZEvent("name",b.emailList);var e=DateTimeUtil.getDurationInSecondFromString(b.duration);d.setZEvent("chat_session_id",c),d.setZEvent("duration",e),ConnectionManager.sendZebra(d)}}}),LineStatesModel=Model.extendAsSingleton({isModelRequested:!0,isConnectionMade:!1,init:function(){this._super("multi_line_states",["L","info","vid","type","dir"]),this.addListener(Model.Event.MODEL_CHANGE,this,this.mls_updated)},requestRefreshModel:function(){},getFirstConnectedLine:function(){if(0==this.items.length)return null;var a=this.items.filter(function(a){return"2"==a.L});return 0==a.length?(a=this.items.filter(function(a){return"4"==a.L}),0==a.length?null:a[0].vid):a[0].vid},isContactInCall:function(a){if(0==this.items.length)return!1;var b=!1,c=LineStatesModel?LineStatesModel.findLine(a):0;if(0!=c){var d=LineStatesModel.getItem(c);"2"!=d.L&&"4"!=d.L||(b=!0)}return b},mls_updated:function(){var a=LineStatesModel.items[0].L,b=LineStatesModel.items[0].info,c=LineStatesModel.items[1].info;"2"!=b&&"2"!=c||(a="LINE_RINGING",CallManager._dispatchEvent(CallManager.Event.RINGING)),"4"==b||"4"==c?a="LINE_CONNECTED":"0"==a&&(a="LINE_ENDED"),this._dispatchEvent(a)},findLine:function(a){if(this.items&&this.items.length>0)for(var b=0;b<this.items.length;b++)if(this.items[b].vid==a)return this.items[b].id;return 0},hasActiveLine:function(){for(var a=0;a<this.items.length;a++)if(2==this.items[a].L)return!0;return!1},getNextAvailableLine:function(){for(var a=0;a<this.items.length;a++)if(0==this.items[""+a].L)return a+1;return this.items.length+1},areLinesActive:function(){for(var a=0;a<this.items.length;a++)if(0!=this.items[a].L)return"true";return"false"},mayXfer:function(){for(var a=0,b=0,c=0;c<this.items.length;c++)2==this.items[c].L&&"in"==this.items[c].dir&&a++;for(var c=0;c<this.items.length;c++)2==this.items[c].L&&"out"==this.items[c].dir&&b++;return 1==a&&1==b},sourceXfer:function(){for(var a=0;a<this.items.length;a++)if(2==this.items[a].L&&"in"==this.items[a].dir)return this.items[a].id;return-1},targetXfer:function(){for(var a=this.items.length-1;a>=0;a--)if(2==this.items[a].L&&"out"==this.items[a].dir)return this.items[a].id;return-1},halt_p2p:function(a){var b=new Zebra("CALL_CONTROL");a&&b.setZebraAttribute("username",a),b.setZEvent("action","HALT_P2P"),b.setZEvent("self","true"),ConnectionManager.sendZebraToMCU(b)},sendDTMF:function(a){var b=new Zebra("CALL_CONTROL");b.setZEvent("action","KEYBOARD"),b.setZEvent("input",a),ConnectionManager.sendZebraToMCU(b)},xfer:function(a){var b=new Zebra("CALL_CONTROL");a&&b.setZebraAttribute("username",a),b.setZEvent("action","ATTXFER"),b.setZEvent("line_number_source",LineStatesModel.sourceXfer()),b.setZEvent("line_number_target",LineStatesModel.targetXfer()),ConnectionManager.sendZebraToMCU(b)}}),FriendRequestModel=Model.extendAsSingleton({init:function(){this.isLoading=!1,this._super("com.requestec.smg.apps.xmpp.ZXMLGateway#getFriendRequest:response",["name","type","address","message","status"],"frModel");this.addConnectionMadeListener(),ConnectionManager.addListener("ZEBRA:com.requestec.smg.apps.xmpp.ZXMLGateway#setFriendRequestState:response",this,this.frResponseResultHandler),ConnectionManager.addListener("ZEBRA:FRIEND_UPDATE",this,this.modelZebraHandler),this.isLoading=!1},STATE:{ACCEPTED:"ACCEPTED",DENIED:"DENIED"},Event:{FR_RESPOND_ERROR:"FR_RESPOND_ERROR"},requestRefreshModel:function(){var a=new Zebra("com.requestec.smg.apps.xmpp.ZXMLGateway#getFriendRequest");ConnectionManager.sendZebra(a)},respondToFriendRequest:function(a,b,c){var d=new Zebra("com.requestec.smg.apps.xmpp.ZXMLGateway#setFriendRequestState");d.setZEvent("id",a),d.setZEvent("state",b),d.setZEvent("type",c),ConnectionManager.sendZebra(d)},frResponseResultHandler:function(a){if(!a.getZebraAttribute("error_code")||!a.getZebraAttribute("error_code").value||""==a.getZebraAttribute("error_code").value||"0"!=a.getZebraAttribute("error_code").value)return void this._dispatchEvent(this.Event.FR_RESPOND_ERROR,{id:a.getZebraAttribute("id"),errorMessage:"could not complete the request - "+a.getZEvent("message")})}});var IM=Model.extendAsSingleton({currentSession:null,lastClosedMUC:null,requestLiveMesages:!1,g_event:new Array,self_confQPos:0,self_handUp:"false",self_yes:"false",self_no:"false",forceUnread:!1,isRequestingMOM:!1,requestingZebra:"",firstDVSessionRequested:!1,init:function(){this._super(),this.persistName="im_sessions_list",DataStore.addListener(DataStore.Event.LOADED_DATA_STORE,this,function(a){a.userStoreError||this.restorePersistence(!0)}),DataStore.loadedUserStore&&this.restorePersistence(!0),ConnectionManager.addListener("ZEBRA:com.requestec.smg.apps.xmpp.ZXMLGateway#sendChatMessage:response",this,this.updateMessageAnchor),ConnectionManager.addListener("ZEBRA:SESSION_STATE_UPDATE",this,this.getChatSessionHandler),ConnectionManager.addListener("ZEBRA:MESSAGE_UPDATE",this,this.messageUpdateHandler),ConnectionManager.addListener(ConnectionManager.Event.LOGGED_OUT,this,this.clearModel),ConnectionManager.addListener("ZEBRA:CONTACTS_UPDATE",this,this.requestOpenSession),ConnectionManager.addListener("ZEBRA:com.requestec.smg.apps.xmpp.ZXMLGateway#getChatSessions:response",this,this.getChatSessionHandler),ConnectionManager.addListener("ZEBRA:com.requestec.smg.apps.xmpp.ZXMLGateway#getMessage:response",this,this.getMessageHandler),ConnectionManager.addListener("ZEBRA:com.requestec.smg.apps.xmpp.ZXMLGateway#getMessage:response",this,this.momMessageHandler),
ConnectionManager.addListener("ZEBRA:com.requestec.smg.apps.xmpp.ZXMLGateway#setChatSessionState:response",this,this.modelZebraHandler),ConnectionManager.addListener("ZEBRA:MESSAGE_UPDATE",this,this.getMessageHandler),ConnectionManager.addListener("ZEBRA:GC_MEMBERS_UPDATE",this,this.gcMembersUpdateHandler),ConnectionManager.addListener(ConnectionManager.Event.ZS_STATE_CHANGED,this,function(a){a.state.indexOf("disconnected")>-1&&(IM.requestLiveMesages=!1)})},Event:{NEW_MESSAGE_OPEN:"NEW_MESSAGE_OPEN",NEW_MESSAGE_CLOSED:"NEW_MESSAGE_CLOSED",INBOUND_MESSAGE:"INBOUND_MESSAGE",MEMBERS_ADDED:"MEMBERS_ADDED",MEMBERS_REMOVED:"MEMBERS_REMOVED",MEMBERS_COUNT_CHANGED:"MEMBERS_COUNT_CHANGED",SESSION_ADDED:"SESSION_ADDED",SESSION_REMOVED:"SESSION_REMOVED",SESSIONS_COUNT_CHANGED:"SESSIONS_COUNT_CHANGED",CURRENT_SESSION_CHANGED:"CURRENT_SESSION_CHANGED",UNREAD_MESSAGES_CHANGED:"UNREAD_MESSAGES_CHANGED",VIEW_CHANGED:"VIEW_CHANGED",CHAT_SESSIONS_RETRIEVED:"CHAT_SESSIONS_RETRIEVED",CHAT_SESSIONS_HIDE:"CHAT_SESSIONS_HIDE",SESSION_CLOSED:"SESSION_CLOSED",NO_MORE_OLD_MESSAGE:"NO_MORE_OLD_MESSAGE",MESSAGE_DELETE:"MESSAGE_DELETE",HISTORY_SESSION_OPENED:"HISTORY_SESSION_OPENED",NEW_MESSAGE_OPEN_INSERT:"NEW_MESSAGE_OPEN_INSERT"},changeMessageState:function(a,b){var c=new Zebra("com.requestec.smg.apps.xmpp.ZXMLGateway#setMessageState");if(null!=a&&""!=a&&c.setZEvent("message_id",a),null!=b&&""!=b&&c.setZEvent("group_id",b),c.setZEvent("state","0"),(!b||b&&b.indexOf("call_")<0)&&ConnectionManager.sendZebra(c),b){var d=this._getSessionWithGroupId(b);if(d){var e=d.messages.filter(function(a){return"1"==a.state});if(e.length>0){for(var f=0;f<e.length;f++)e[f].state="0";var g=JSON.stringify(d),h=d.id,i={};i[h]=escape(g),Platform.papi(this.persistKey()).addOrUpdateItems(i)}d.unreadMessages=0}}},momMessageHandler:function(a){var b=a.getZebraAttribute("fmt"),c=!0,d=null;b&&""!=b&&"1.0"!=b?"2.0"==b&&(d=a.list.items,0==d.length&&(c=!1)):(d=a.getZEvent("item_keys").value,""!=d&&0!=d.split(",").length||(c=!1)),!c&&this.requestLiveMesages},getChatSessionHandler:function(a){Platform.log("chat sessions zebra:"+a.toXML()),this.firstDVSessionRequested&&(this.fmt10PropNames=["group_id","members","chat_state","hasUnread","names","vids"],""!=a.getZebraAttribute("anchor")&&DataStore.setUserData("im_session_anchor",a.getZebraAttribute("anchor"),!0),this.modelZebraHandler(a),this.requestLiveMesages?this._dispatchEvent(this.Event.CHAT_HISTORY_RETRIEVED,null):(this.requestLiveMesages=!0,this.items.length>0&&this.requestLiveChatMessages()))},getMessageHandler:function(a){Platform.log("getMessage response: "+a.toXML());var b=function(){thisModel.isLoading&&(thisModel.isLoading=!1),thisModel._dispatchEvent(Model.Event.MODEL_ZEBRA_PARSED,a)};this.fmt10PropNames=["vid","group_id","direction","other_party_address","other_party_type","message","names","vids","state","updated","group_id","isCloseChat","vid_from","name_from"],""!=a.getZebraAttribute("anchor")&&DataStore.setUserData("im_message_anchor",a.getZebraAttribute("anchor"),!0);var c="",d=a.getZebraAttribute("fmt");if(d&&""!=d&&"1.0"!=d){if("2.0"==d){if(!a.list)return b();c=a.list.mode}}else{var e=a.getZEvent("item_keys");if(!e)return b();c=e.mode}"insert"!=c&&"delete"!=c&&(c="insert"),this.modelZebraHandler(a,c),this.isRequestingMOM=!1},updateMessageAnchor:function(a){""!=a.getZebraAttribute("anchor")&&DataStore.setUserData("im_message_anchor",a.getZebraAttribute("anchor"),!0);var b=a.getZEvent("chat_session_id").value,c=null;b&&""!=b&&(c=this._getSessionWithGroupId(b))},requestOpenSession:function(){this.getDVSessions()},requestLiveChatMessages:function(){this.getDVMessages()},getDVSessions:function(){var a=new Zebra("com.requestec.smg.apps.xmpp.ZXMLGateway#getChatSessions");DataStore.getUserData("vid"),ConnectionManager.service;a.setZEvent("select","group_id,members,chat_state,vids,names"),DataStore.getUserData("im_session_anchor")&&""!=DataStore.getUserData("im_session_anchor")&&a.setZebraAttribute("anchor",DataStore.getUserData("im_session_anchor")),this.firstDVSessionRequested=!0,ConnectionManager.sendZebra(a)},getDVMessages:function(){var a=new Zebra("com.requestec.smg.apps.xmpp.ZXMLGateway#getMessage");DataStore.getUserData("vid"),ConnectionManager.service;DataStore.getUserData("im_message_anchor")&&""!=DataStore.getUserData("im_message_anchor")&&a.setZebraAttribute("anchor",DataStore.getUserData("im_message_anchor")),a.setZEvent("select","vid,direction,other_party_address,other_party_type,state,message,updated,group_id,isCloseChat,vid_from,name_from,name"),a.setZEvent("orderby","updated asc"),ConnectionManager.sendZebra(a),Platform.log("DV request getMessage zebra"+a.toXML())},getChatSessions:function(a,b,c){var d=new Zebra("com.requestec.smg.apps.xmpp.ZXMLGateway#getChatSessions"),e=c?c:DataStore.getUserData("vid"),f=a?"chat_state = '"+a+"'":"",g=b?"limit = '"+b+"'":"",h=ConnectionManager.service,i="";i=a?"vid ="+e+" and service = '"+h+"' and "+f:"vid ="+e+" and service = '"+h+"'",d.setZEvent("select","group_id,members,chat_state,vids,names"),d.setZEvent("where",i),b&&d.setZEvent("limit",g),ConnectionManager.sendZebra(d)},getMessagesInSession:function(a,b,c,d,e){var f=this._getSessionWithGroupId(a),g="updated desc";e&&(g="updated "+e);var h="";h=a==b?"group_id='"+a+"' and group_type='CONF'":"group_type='IM' and other_party_address='"+b.split(":")[1]+"' and other_party_type='"+b.split(":")[0]+"'";var i=new Zebra("com.requestec.smg.apps.xmpp.ZXMLGateway#getMessage"),j=d?d:DataStore.getUserData("vid"),k=ConnectionManager.service,l="vid ="+j+" AND service = '"+k+"' and state != 3 and "+h;i.setZEvent("select","vid,direction,other_party_address,other_party_type,state,message,updated,group_id,isCloseChat,name,name_from,vid_from"),i.setZEvent("where",l),c&&i.setZEvent("limit",f.historyIndex+","+c),i.setZEvent("orderby",g),i.setZEvent("group_id",a),a==b&&i.setZEvent("groupby","message_id, direction, vid"),this.isRequestingMOM&&this.requestingZebra.toXML()==i.toXML()||(this.isRequestingMOM=!0,this.requestingZebra=i,this.addTimeoutSearch(),ConnectionManager.sendZebra(i),setTimeout(function(){IM.isRequestingMOM=!1,IM.requestingZebra=""},1e4),Platform.log("getMessage request zebra is:"+i.toXML()))},filterChatFromLiveOrQueue:function(a){return!0},getOpenSessionCount:function(){return this.items.filter(function(a){return"open"==a.chat_state&&IM.filterChatFromLiveOrQueue(a)}).length},getClosedSessionCount:function(){return this.items.filter(function(a){return"closed"==a.chat_state}).length},deleteHistory:function(a,b){var c,d=this._getSessionWithGroupId(a);c=d.stored_session?d.group_id+","+d.stored_session:d.group_id;var e=new Zebra("com.requestec.smg.apps.xmpp.ZXMLGateway#setChatSessionState");e.setZEvent("group_id",c),e.setZEvent("chat_state","hidden"),d.chat_rollup_id!=d.group_id&&e.setZEvent("fqa",d.chat_rollup_id),ConnectionManager.sendZebra(e),Platform.log("CLOSECONF deleteHistory "+e.toXML()),Platform.papi(this.persistKey()).deleteRow(d.id),this.removeItem(d.group_id,d),this.currentSession=null},deleteAllHistory:function(){var a=this.items.filter(function(a){return"closed"==a.chat_state}),b=new Zebra("com.requestec.smg.apps.xmpp.ZXMLGateway#setAllChatSessionState");b.setZEvent("chat_state","hidden"),ConnectionManager.sendZebra(b),Platform.log("CLOSECONF deleteAllHistory "+b.toXML());for(var c=0;c<a.length;c++)this.removeItem(a[c].group_id,a[c]),Platform.papi(this.persistKey()).deleteRow(a[c].id);this.currentSession=null,this._dispatchEvent(this.Event.SESSIONS_COUNT_CHANGED,{open:this.getOpenSessionCount(),closed:this.getClosedSessionCount()})},stringToDate:function(a){var b=a.split(" "),c=b[0],d=b[1],e=c.split("-"),f=d.split(":"),g=new Date(e[0],e[1]-1,e[2],f[0],f[1],f[2]);return g},WithContact:function(a,b){b=b||"";var c=ContactModel.getItem(a);return c?this.openSessionWithFQA(c.fqa,b):(this._setNewCurrentSession(null,b),null)},checkIfCurrentSessionLeak:function(){this.currentSession&&!this._getSessionWithGroupId(this.currentSession.group_id)&&(this.currentSession=null)},hasRoom:function(){var a=this.items.filter(function(a){return a.group_id.indexOf("call_room")>-1});return a.length>0},inRoom:function(){return this.checkIfCurrentSessionLeak(),!(!this.currentSession||0!=this.currentSession.group_id.indexOf("call_room"))},isCallMUC:function(){this.checkIfCurrentSessionLeak();var a=this.currentSession;return!(!a||0!=a.group_id.indexOf("call_"))},inRoomEvent:function(){return!(!this.currentSession||0!=this.currentSession.group_id.indexOf("call_room"))},inDAEvent:function(){return!(!this.currentSession||0!=this.currentSession.group_id.indexOf("call_")||0==this.currentSession.group_id.indexOf("call_room"))},setUnreadCount:function(a,b){var c=a?a:this.currentSession;c&&(b?a.numUnreadMessages=b:a.numUnreadMessages=0,this.changeMessageState(null,c.group_id))},clearUnreadCount:function(a){var b=a?a:this.currentSession;b&&(b.numUnreadMessages=0,this.changeMessageState(null,b.group_id),this.dispatchUnreadCountChanged(b))},dispatchUnreadCountChanged:function(a){var b=a?a:this.currentSession;b&&this._dispatchEvent(this.Event.UNREAD_MESSAGES_CHANGED,{session:b,change:-1*b.numUnreadMessages})},updateSessionId:function(a,b){var c=this.getItem(a);return c?(c.group_id=b,this._dispatchEvent(Model.Event.MODEL_UPDATE,c),c):null},printStack:function(){},openSessionWithFQA:function(a,b,c,d,e){Platform.log("open session with FQA called:"+a),this.printStack();for(var f,g,h=0;h<this.items.length;h++)if(this.items[h].chat_rollup_id==a){g=this.items[h];break}ContactModel.getContactWithFQA(a,!0,d,{vid:e}).supportsMultipleIMSessions||(f=g),f=g;var i=f&&"closed"==f.chat_state&&!c;f&&"closed"==f.chat_state&&(f.historyIndex=0,f.group_id=(new Date).getTime()+Math.floor(500*Math.random())+"0");var j=!1;return f&&(j=!0),f?(this._setNewCurrentSession(f,b,c),Platform.log("XFERLOG openSessionWithFQA using existing session")):(f=this._createAndAddNewSession(!0,a,null,b,d,e),Platform.log("XFERLOG openSessionWithFQA creating new session")),c?f.chat_state="closed":f.chat_state="open",i&&"open"==f.chat_state&&this._dispatchEvent(this.Event.SESSIONS_COUNT_CHANGED,{open:this.getOpenSessionCount(),closed:this.getClosedSessionCount()}),i&&this._dispatchEvent(this.Event.HISTORY_SESSION_OPENED),f},openSession:function(a,b){Platform.log("open session called:"+a),this.printStack();var c=this._getSessionWithGroupId(a);if(!c)return null;var d=c.chat_rollup_id==c.group_id,e=c;e&&"closed"==e.chat_state&&(e.historyIndex=0),e&&"open"==e.chat_state&&(e.historyIndex=e.messages.length);var f=e&&"closed"==e.chat_state;return e&&(d&&f?this._setNewCurrentSession(e,b,!0):this._setNewCurrentSession(e,b)),e.chat_rollup_id!=e.group_id&&e&&"closed"==e.chat_state&&(e.chat_state="open",this._dispatchEvent(this.Event.SESSIONS_COUNT_CHANGED,{open:this.getOpenSessionCount(),closed:this.getClosedSessionCount()}),f&&this._dispatchEvent(this.Event.HISTORY_SESSION_OPENED)),e},hideCurrentSession:function(a){this._setNewCurrentSession(null,a)},closeAllSessions:function(){var a=this.items.filter(function(a){return"open"==a.chat_state}),b=new Zebra("com.requestec.smg.apps.xmpp.ZXMLGateway#setAllChatSessionState");b.setZEvent("chat_state","closed");var c;ConnectionManager.sendZebra(b);for(var d={},e=0;e<a.length;e++){c=a[e],c.chat_state="closed",c.historyIndex=0;var f=0;f=c.numUnreadMessages,c.numUnreadMessages=0,c.last_update_time=(new Date).getTime(),c.messages=[];var g=JSON.stringify(c),h=c.id;d[h]=escape(g),f>0&&this._dispatchEvent(this.Event.UNREAD_MESSAGES_CHANGED,{session:c,change:-1*f}),this._dispatchEvent(Model.Event.MODEL_UPDATE,c)}this.currentSession=null,this._dispatchEvent(this.Event.SESSIONS_COUNT_CHANGED,{open:this.getOpenSessionCount(),closed:this.getClosedSessionCount()}),Platform.papi(this.persistKey()).addOrUpdateItems(d)},closeSession:function(a){return Platform.log("TOMCONF closeSession sessionId "+a),this._closeAndRemoveSession(a)},closeSessionWithFQA:function(a){for(var b=0;b<this.items.length;b++)this.items[b].members==a&&this._closeAndRemoveSession(this.items[b].group_id)},closeSessionAllMUC:function(){for(var a=0;a<this.items.length;a++)Platform.log("CLOSECONF closeSessionAllMUC "+this.items[a].group_id+" "+this.items[a].chat_rollup_id+" "+this.items[a].members.indexOf(",")),(this.items[a].group_id==this.items[a].chat_rollup_id||this.items[a].members.indexOf(",")>-1)&&this._closeAndRemoveSession(this.items[a].group_id);this._dispatchEvent(this.Event.UNREAD_MESSAGES_CHANGED)},deleteSessionAllMUC:function(a){for(var b=0;b<this.items.length;b++)Platform.log("CLOSECONF deleteSessionAllMUC "+this.items[b].group_id+" "+this.items[b].chat_rollup_id+" "+this.items[b].members.indexOf(",")),(this.items[b].group_id==this.items[b].chat_rollup_id||this.items[b].members.indexOf(",")>-1)&&(this.items[b].openned_in_call||this.items[b].group_id==a)&&this.deleteHistory(this.items[b].group_id,this.items[b].chat_rollup_id)},closeCurrentSession:function(){return this._closeAndRemoveSession(this.currentSession.group_id)},postMessage:function(a,b,c,d){if(!this.currentSession)return"Could not post message as no session is currently open.";var e=!1;if("closed"==this.currentSession.chat_state&&(e=!0,this.currentSession.chat_state="open"),this.currentSession&&(!this.currentSession.contacts||0==this.currentSession.contacts.length))return"There are no members in this session";var f=new Zebra("com.requestec.smg.apps.xmpp.ZXMLGateway#sendChatMessage");f.setZEvent("chat_session_id",this.currentSession.group_id),f.setZEvent("to",this.currentSession.contacts[0].fqa),f.setZEvent("type",this.currentSession.contacts[0].type),f.setZEvent("message","<![CDATA["+a+"]]>");var g=ConnectionManager.sendZebra(f,null,null,null,{fireNoSend:!0});if(Platform.log("send message zebra success"+g),"undefined"==typeof g||0!=g){this._addMessageToSession(this.currentSession,a,null,null,null,null,c,d);return e&&(this._dispatchEvent(Model.Event.MODEL_CHANGE),this._dispatchEvent(Model.Event.MODEL_UPDATE,this.currentSession),this._dispatchEvent(this.Event.SESSIONS_COUNT_CHANGED,{open:this.getOpenSessionCount(),closed:this.getClosedSessionCount()}),this._dispatchEvent(this.Event.HISTORY_SESSION_OPENED)),null}},postMessageInSession:function(a,b,c,d,e){if(!ConnectionManager.isConnectedToZS())return"No network connectivity. Cannot send message";if("closed"==a.chat_state&&(a.chat_state="open",this._dispatchEvent(this.Event.SESSIONS_COUNT_CHANGED,{open:this.getOpenSessionCount(),closed:this.getClosedSessionCount()})),!c||0==c){var f=new Zebra("com.requestec.smg.apps.xmpp.ZXMLGateway#sendChatMessage");f.setZEvent("chat_session_id",a.group_id),f.setZEvent("to",a.contacts[0].fqa),f.setZEvent("type",a.contacts[0].type),f.setZEvent("message","<![CDATA["+b+"]]>");var g=ConnectionManager.sendZebra(f,null,null,null,{fireNoSend:!0});if(Platform.log("send message zebra success"+g),"undefined"!=typeof g&&0==g)return}this._addMessageToSession(a,b,null,null,null,null,d,e);return null},addContactsToCurrentSession:function(){if(this.currentSession&&0!=arguments.length){for(var a,b=[],c=[],d=[],e=[],f=0;f<arguments.length;f++)a=ContactModel.getItem(arguments[f]),a&&!this.currentSession.hasMember(a.fqa)&&(this.currentSession.contacts.push(a),this.currentSession.members=this.currentSession.members+","+a.fqa,b.push(a.id),c.push(a.fqa),d.push(a),e.push(a.name));if(Platform.log("BENCONF addContactsToCurrentSession 3a addedIds.length "+b.length),0!=b.length){var g=new Zebra("com.requestec.smg.apps.xmpp.ZXMLGateway#addToChat");if(g.setZEvent("chat_session_id",this.currentSession.group_id),g.setZEvent("added_ids",b.toString()),g.setZEvent("existing_id",this.currentSession.contacts[0].id),Platform.log("XFERLOG sending ZXMLGateway#addToChat zebra: chat_session_id = "+this.currentSession.group_id+", added_ids = "+b.toString()+", existing_id = "+this.currentSession.contacts[0].id),this.currentSession.isConf||(this.currentSession.isConf=!0,this.currentSession.chat_rollup_id=this.currentSession.group_id),Platform.log("BENCONF addContactsToCurrentSession 4 "+g.toXML()),ConnectionManager.sendZebra(g),"saypage"==!ConnectionManager.service){var h=this._addMessageToSession(this.currentSession,"You have added "+(Platform.isSayPageApp?e.join(", "):c.join(", "))+" to the conversation.",null,"NOTIFICATION_ADD");this._dispatchEvent(this.Event.NEW_MESSAGE_OPEN,{obj:h,session:this.currentSession})}this._dispatchEvent(this.Event.MEMBERS_ADDED,{session:this.currentSession,members:d}),this._dispatchEvent(this.Event.MEMBERS_COUNT_CHANGED,this.currentSession)}}},gcMembersUpdateHandler:function(a){if(a.getZEvent("chat_session_id")&&a.getZEvent("chat_session_id").value&&""!=a.getZEvent("chat_session_id").value&&a.getZEvent("members")&&a.getZEvent("members").value&&""!=a.getZEvent("members").value){Platform.log("XFERLOG: GCMU received chat_session_id = "+a.getZEvent("chat_session_id").value+", members = "+a.getZEvent("members").value+", mode = "+a.getZEvent("members").mode);var b,c=a.getZEvent("chat_session_id").value,d=a.getZEvent("members").value,e="",f="";a.getZEvent("from")&&a.getZEvent("from").value?b=a.getZEvent("from").value:d&&d.split(",")[0]&&""!=d.split(",")[0]&&(b=d.split(",")[0]);var g=ContactModel.getContactWithFQA(b);if(g)e=g.name,f=g.vid;else{var h,i;a.getZEvent("vids")&&a.getZEvent("vids").value&&""!=a.getZEvent("vids").value&&(h=a.getZEvent("vids").value.split(",")),a.getZEvent("name")&&a.getZEvent("name").value&&""!=a.getZEvent("name").value&&(i=a.getZEvent("name").value.split(","));var j=d.split(",");if(i&&i.length==j.length||h&&h.length==j.length)for(var k=0;k<j.length;k++)if(j[k]==b){i&&i.length==j.length&&(e=i[k]),h&&h.length==j.length&&(f=h[k]);break}}var l=d.replace(","+b,"").replace(b+",","").replace(b,""),m="";if(a.getZEvent("name")&&a.getZEvent("name").value&&""!=a.getZEvent("name").value)for(var n=a.getZEvent("name").value.split(","),k=(d.split(","),0);k<n.length;k++)m+=n[k],k!=n.length-1&&(m+=",");var o;a.getZEvent("handUp")&&a.getZEvent("handUp").value&&""!=a.getZEvent("handUp").value&&(o=a.getZEvent("handUp").value.split(","));var p;a.getZEvent("yes")&&a.getZEvent("yes").value&&""!=a.getZEvent("yes").value&&(p=a.getZEvent("yes").value.split(","));var q;a.getZEvent("no")&&a.getZEvent("no").value&&""!=a.getZEvent("no").value&&(q=a.getZEvent("no").value.split(","));var r;a.getZEvent("confQPos")&&a.getZEvent("confQPos").value&&""!=a.getZEvent("confQPos").value&&(r=a.getZEvent("confQPos").value.split(","));var s;a.getZEvent("micStatus")&&a.getZEvent("micStatus").value&&""!=a.getZEvent("micStatus").value&&(s=a.getZEvent("micStatus").value.split(","));var t;a.getZEvent("mcuStats")&&a.getZEvent("mcuStats").value&&""!=a.getZEvent("mcuStats").value&&(t=a.getZEvent("mcuStats").value.split(","));var u;a.getZEvent("camStatus")&&a.getZEvent("camStatus").value&&""!=a.getZEvent("camStatus").value&&(u=a.getZEvent("camStatus").value.split(","));var v;a.getZEvent("screenshareList")&&a.getZEvent("screenshareList").value&&""!=a.getZEvent("screenshareList").value&&(v=a.getZEvent("screenshareList").value.split(","));var w;a.getZEvent("wbList")&&a.getZEvent("wbList").value&&""!=a.getZEvent("wbList").value&&(w=a.getZEvent("wbList").value.split(","));var x;a.getZEvent("imList")&&a.getZEvent("imList").value&&""!=a.getZEvent("imList").value&&(x=a.getZEvent("imList").value.split(","));var y;a.getZEvent("moderators")&&a.getZEvent("moderators").value&&""!=a.getZEvent("moderators").value&&(y=a.getZEvent("moderators").value.split(","));var z;a.getZEvent("name")&&a.getZEvent("name").value&&""!=a.getZEvent("name").value&&(z=a.getZEvent("name").value.split(",")),a.getZEvent("self_confQPos")&&a.getZEvent("self_confQPos").value&&""!=a.getZEvent("self_confQPos").value&&(IM.self_confQPos=a.getZEvent("self_confQPos").value),a.getZEvent("self_yes")&&a.getZEvent("self_yes").value&&""!=a.getZEvent("self_yes").value&&(IM.self_yes=a.getZEvent("self_yes").value),a.getZEvent("self_no")&&a.getZEvent("self_no").value&&""!=a.getZEvent("self_no").value&&(IM.self_no=a.getZEvent("self_no").value),a.getZEvent("self_handUp")&&a.getZEvent("self_handUp").value&&""!=a.getZEvent("self_handUp").value&&(IM.self_handUp=a.getZEvent("self_handUp").value),null!=IM.g_event&&"update"!=a.getZEvent("members").mode||(IM.g_event=new Array);for(var k=0;k<d.split(",").length;k++){var A=new Array;A.handUp=o?o[k]:"",A.yes=p?p[k]:"",A.no=q?q[k]:"",A.confQPos=r?r[k]:"",A.micStatus=s?s[k]:"",A.camStatus=u?u[k]:"",A.screenshareList=v?v[k]:"",A.moderators=y?y[k]:"",A.wbList=w?w[k]:"",A.imList=x?x[k]:"",A.mcuStats=t?t[k]:"",A.realName=z?z[k]:"";var B=d.split(",")[k];IM.g_event&&(IM.g_event[B]=A)}var C=this._getSessionWithGroupId(c);if(C&&"closed"==C.chat_state){if("delete"==a.getZEvent("members").mode||!a.getZEvent("from")||!a.getZEvent("from").value||0==a.getZEvent("from").value.length)return;"open"==C.chat_state,this._dispatchEvent(Model.Event.MODEL_UPDATE,C)}var D="";if(a.getZEvent("vids")&&a.getZEvent("vids").value&&""!=a.getZEvent("vids").value&&(D=a.getZEvent("vids").value),!C){if("delete"==a.getZEvent("members").mode||!a.getZEvent("from")||!a.getZEvent("from").value||0==a.getZEvent("from").value.length)return;C=this._createAndAddNewSession(!1,b,c,null,e,f)}var E,F=a.getZEvent("event_title")?a.getZEvent("event_title").value:"";""!=F&&(C.event_title=F);var G=m.split(",");switch(a.getZEvent("members").mode){case"insert":this._addMembersToSession(C,d.split(","),G,D.split(",")),l&&""!=l&&(Platform.isSayPageApp||Platform.spm||(E=this._addMessageToSession(C,ContactModel.getContactWithFQA(b,!0).name+" has added <b>"+l.replace(/:/g,": ")+"</b> to the conversation.",b,"NOTIFICATION_ADDED")));break;case"delete":this._removeMembersFromSession(C,d.split(","));for(var H=!0,I=d.split(","),k=0;k<I.length;k++)if(C.hasMember(I[k])){var J=ContactModel.getContactWithFQA(I[k],!0).name,K=ContactModel.getContactWithFQA(I[k],!0).fqa;l.indexOf(J)>-1&&(l=l.replace(","+J,"").replace(J+",","").replace(J,"")),l.indexOf(K)>-1&&(l=l.replace(","+K,"").replace(K+",","").replace(K,""))}H=!ConnectionManager.inCall(),H&&l&&""!=l&&(E=this._addMessageToSession(C,"<b>"+m+(l.indexOf(",")>-1?"</b> have":"</b> has")+" left"+(Platform.isSayPageApp?".####NOTIFICATION":" the conversation.####NOTIFICATION"),b,"NOTIFICATION_LEFT",null,null,null,"in"));break;default:this._addMembersToSession(C,d.split(","),G,D.split(",")),Platform.isSayPageApp||Platform.spm||!l||""==l||(E=this._addMessageToSession(C,"You have been invited to a conference by "+ContactModel.getContactWithFQA(b,!0).name,b,"NOTIFICATION_INVITED"))}if(Platform.isSayPageApp||Platform.spm||!E||(C.isInBackground&&this._dispatchEvent(this.Event.UNREAD_MESSAGES_CHANGED,{session:C,change:1}),this._dispatchEvent(Model.Event.MODEL_ADD,C),this._dispatchEvent(Model.Event.MODEL_CHANGE),this._dispatchEvent(this.Event.NEW_MESSAGE_OPEN,{obj:E,session:C})),a.getZEvent("from")&&a.getZEvent("from").value&&a.getZEvent("from").value.length>0&&this._dispatchEvent("OPEN_MUC_SESSION",a),MyLiveModel.items.length>0&&this._dispatchEvent("update_call_rows"),("busy"==ConnectionManager.zsState||Platform.isSayPageApp&&MyLiveModel.items.length>0)&&(C.openned_in_call=!0),0==C.group_id.indexOf("call_")&&("update"==a.getZEvent("members").mode||""==a.getZEvent("members").mode)){var L=a.getZEvent("wbCsi")?a.getZEvent("wbCsi").value:"";this._dispatchEvent("CALL_SESSION_UPDATE",{session:C,wbCSI:L})}}},numUnreadMessages:function(){for(var a=0,b=0;b<this.items.length;b++){var c=this.items[b].messages.filter(function(a){return"1"==a.state}).length,d=this.items[b].numUnreadMessages;toAdd=d>c?c:d,a+=toAdd}return a},checkIfOne2OneSession:function(a,b){var c=this._getSessionWithGroupId(a);return c||(c=this.getItem(b)),!!c&&(1==c.contacts.length||!c.isConf)},createMUCSession:function(a,b,c,d){var e=null,f=ContactModel.getItem(a);f||(f=ContactModel.getContactWithFQA(b));var g=ContactModel.getItem(c);g||(g=ContactModel.getContactWithFQA(d,!0));var h="call_"+(new Date).getTime()+Math.floor(500*Math.random())+"0";e=this._createAndAddNewSession(!0,f.fqa,h,null,null,null,null,!0),Platform.log("new session is");for(var i in e)Platform.log("key is:"+i+" value is ***"+e[i]);this.addContactsToCurrentSession(g.id),e.currentCallSession=!0;var j=new Zebra("GCM_CSI_UPDATE",ConnectionManager.service);return j.setZEvent("chat_session_id",IM.currentSession.group_id),ConnectionManager.sendZebraToZC(j),e},getCurrentCallSession:function(){var a=this.items.filter(function(a){return a.group_id.indexOf("call_")>-1});if(0==a.length)return null;for(var b=0;b<a.length;b++)if(0==a[b].group_id.indexOf("call_room")&&(a[b].currentCallSession=!0),a[b].currentCallSession)return a[b];return null},clearAllMUCSessions:function(){var a=this.items.filter(function(a){return a.group_id.indexOf("call_")>-1});if(a.length>0)for(var b,c=0;c<a.length;c++)b=a[c],IM.closeSession(b.group_id),IM.deleteHistory(b.group_id,b.chat_rollup_id);IM.closeSessionAllMUC(),IM.deleteSessionAllMUC()},_createAndAddNewSession:function(a,b,c,d,e,f,g,h){var i={id:c&&""!=c?c:(new Date).getTime()+Math.floor(500*Math.random())+"0",group_id:c&&""!=c?c:(new Date).getTime()+Math.floor(500*Math.random())+"0",chat_rollup_id:c&&""!=c?c:b,isInBackground:!a,historyIndex:0,members:b,names:e,vids:f,isConf:b.indexOf(",")>-1,isClosed:!1,numUnreadMessages:0,unsentMessage:"",chat_state:"open",messages:[],forceNewSession:h};b.split(",");this.createOrUpdateItem(i,!0),c&&(i.group_id=c,i.messages.length>0&&this._dispatchEvent(this.Event.UNREAD_MESSAGES_CHANGED,{session:item,change:-1*i.messages.length}),i.messages=[]),a&&this._setNewCurrentSession(i,d),this._dispatchEvent(this.Event.SESSION_ADDED,i),this._dispatchEvent(this.Event.SESSIONS_COUNT_CHANGED);var j=JSON.stringify(i),k=i.id,l={};return l[k]=escape(j),g||Platform.papi(this.persistKey()).addOrUpdateItems(l),i},_setNewCurrentSession:function(a,b,c){if(this.currentSession!=a){if(b=b||"",this.currentSession&&(b!=this.currentSession.unsentMessage&&(this.currentSession.unsentMessage=b),this.currentSession.isInBackground=!0),this.currentSession=a,a){var d=a.numUnreadMessages;a.isInBackground=!1,a.isClosed&&!a.isConf&&(a.isClosed=!1),"closed"!=a.chat_state||c||(a.chat_state="open",this._dispatchEvent(this.Event.SESSIONS_COUNT_CHANGED,{open:this.getOpenSessionCount(),closed:this.getClosedSessionCount()})),d>0&&(this.changeMessageState(null,a.group_id),this._dispatchEvent(this.Event.UNREAD_MESSAGES_CHANGED,{session:a,change:-1*d}))}this._dispatchEvent(this.Event.CURRENT_SESSION_CHANGED,a)}},_addMembersToSession:function(a,b,c,d){for(var e,f=[],g=[],h=0;h<b.length;h++)if(b[h]&&""!=b[h]&&!a.hasMember(b[h])){a.isConf=!0,a.chat_rollup_id=a.group_id;var i="";null!=c&&c[h]&&""!=c[h]?(i=d&&d[h]?d[h]:"-1",e=ContactModel.getContactWithFQA(b[h],!0,c[h],{vid:i})):(i=d&&d[h]?d[h]:"-1",e=ContactModel.getContactWithFQA(b[h],!0,b[h],{vid:i})),a.contacts.push(e),a.members=a.members+","+b[h],f.push(b[h]),g.push(e)}return this._dispatchEvent(this.Event.MEMBERS_ADDED,{session:a,members:g}),this._dispatchEvent(this.Event.MEMBERS_COUNT_CHANGED,a),f},_removeMembersFromSession:function(a,b){for(var c,d=[],e=[],f=0;f<b.length;f++)if(!(a.contacts.length<=1&&a.group_id.indexOf("call_room")<0)&&(a.contacts.length<=1&&0==a.group_id.indexOf("call_room")&&(a.members=a.members+",zen:hidden@saypage.com",a.contacts.push(ContactModel.getContactWithFQA("zen:hidden@saypage.com",!0))),c=a.hasMember(b[f]))){for(var g=ContactModel.getContactWithFQA(b[f],!0),h=0;h<a.contacts.length;h++)if(a.contacts[h].fqa==g.fqa){a.contacts.splice(h,1),a.members=a.members.replace(","+g.fqa,"").replace(g.fqa+",","").replace(g.fqa,""),0==a.members.indexOf(",")&&(a.members=a.members.substr(1,a.members.length-1)),a.members.lastIndexOf(",")==a.members.length-1&&(a.members=a.members.substr(0,a.members.length-2));break}e.push(c),d.push(b[f])}return this._dispatchEvent(this.Event.MEMBERS_REMOVED,{session:a,members:e}),this._dispatchEvent(this.Event.MEMBERS_COUNT_CHANGED,a),this._dispatchEvent(Model.Event.MODEL_UPDATE,a),d},_addMessageToSession:function(a,b,c,d,e,f,g,h){var i=new Date(e);i.getTime()>0||(i=new Date);var j=DateTimeUtil.getStringFromDateObj(i),k=(DateTimeUtil.convertStringToGMTString(j),a.contacts[0].fqa.split(":")),l={direction:h&&"null"!=h?h:"out",isPosted:!0,message:b,isClosed:"false",state:1,from:c,id:g&&"null"!=g?g:i.getTime(),fromName:function(){return this.fromFQA?ContactModel.getContactWithFQA(c,!0).name:null},dateMillis:i.getTime(),updated:j,other_party_address:c?c.split(":")[1]:k[1],other_party_type:c?c.split(":")[0]:k[0],vid:DataStore.getUserData("vid"),group_id:a.group_id,timeIST:!0};this.createOrUpdateItem(l,!0);var m=JSON.stringify(a),n=a.id,o={};return o[n]=escape(m),f||Platform.papi(this.persistKey()).addOrUpdateItems(o),l},_closeAndRemoveAllSessions:function(){for(var a=0;a<this.items;a++)this._closeAndRemoveSession(this.items.group_id)},_getSessionWithGroupId:function(a){for(var b=null,c=0;c<this.items.length;c++)if(this.items[c].group_id==a){b=this.items[c];break}return b},_closeAndRemoveSession:function(a,b){var c=!0;b&&(c=!1),Platform.log("TOMCONF _closeAndRemoveSession sessionId "+a);var d=this._getSessionWithGroupId(a);if(!d)return!1;var e=d;e.numUnreadMessages=0;var f=e.numUnreadMessages,g=new Zebra("com.requestec.smg.apps.xmpp.ZXMLGateway#setChatSessionState");if(g.setZEvent("group_id",e.group_id),g.setZEvent("chat_state","closed"),e.chat_rollup_id!=e.group_id&&g.setZEvent("fqa",e.chat_rollup_id),ConnectionManager.sendZebra(g),Platform.log("CLOSECONF _closeAndRemoveSession "+g.toXML()),e.chat_state="closed",e.last_update_time=(new Date).getTime(),e.messages=[],e.historyIndex=0,e==this.currentSession&&this._setNewCurrentSession(null),f>0&&this._dispatchEvent(this.Event.UNREAD_MESSAGES_CHANGED,{session:e,change:-1*f}),c){this._dispatchEvent(Model.Event.MODEL_UPDATE,e),this._dispatchEvent(this.Event.SESSIONS_COUNT_CHANGED,{open:this.getOpenSessionCount(),closed:this.getClosedSessionCount()}),this._dispatchEvent(this.Event.SESSION_CLOSED,e);var h=JSON.stringify(e),i=e.id,j={};j[i]=escape(h),Platform.papi(this.persistKey()).addOrUpdateItems(j)}return!0},getSessionWithRollUpId:function(a){for(var b="",c=0;c<this.items.length;c++)if(this.items[c].chat_rollup_id==a){b=this.items[c];break}return b},getItemWithRollUpId:function(a){for(var b="",c=0;c<this.items.length;c++)if(this.items[c].chat_rollup_id==a){b=this.items[c].id;break}return b},getSessionForPropListObject:function(a){var b;if(a.vid){var c=this.getItemWithRollUpId(a.group_id);""==c&&(c=this.getItemWithRollUpId(a.other_party_type+":"+a.other_party_address)),""!=c&&(b=this.getItem(c))}else if(b=this._getSessionWithGroupId(a.group_id),!b){var c=this.getItemWithRollUpId(a.members);""!=c&&(b=this.getItem(c))}return b},createOrUpdateItem:function(a,b){this.isLoading&&(this.isLoading=!1);var c=(a.group_id,this.getItemWithRollUpId(a.group_id),a.vid,this.itemsCache[this.getItemWithRollUpId(a.group_id)],this.getItemWithRollUpId(a.other_party_type+":"+a.other_party_address),this.itemsCache[this.getItemWithRollUpId(a.other_party_type+":"+a.other_party_address)],(a.vid?this.itemsCache[this.getItemWithRollUpId(a.group_id)]:null)||this.itemsCache[this.getItemWithRollUpId(a.other_party_type+":"+a.other_party_address)]),d=a.vid?null:this.itemsCache[this.getItemWithRollUpId(a.group_id)]||this._getSessionWithGroupId(a.group_id)||(a.chat_rollup_id!=a.group_id?this.itemsCache[this.getItemWithRollUpId(a.members)]:null),e="",f="";if(a.forceNewSession&&(d=null),a.vid&&!c){var g={group_id:a.group_id,id:a.id,members:a.other_party_type+":"+a.other_party_address,chat_state:"open",vids:a.vid_from,names:a.name_from};this.createOrUpdateItem(g),c=(a.vid?this.itemsCache[this.getItemWithRollUpId(a.group_id)]:null)||this.itemsCache[this.getItemWithRollUpId(a.other_party_type+":"+a.other_party_address)]}if(c){var h=!1;if("closed"==c.chat_state&&(a.vid&&(!a.isCloseChat||a.isCloseChat&&"true"!=a.isCloseChat)||"open"==a.chat_state)&&(h=!0),c.group_id!=a.group_id&&(a.vid&&(!a.isCloseChat||a.isCloseChat&&"true"!=a.isCloseChat)||"open"==a.chat_state)){var i=c.numUnreadMessages,j=c==this.currentSession;
"open"==c.chat_state&&this._closeAndRemoveSession(c.group_id,!0),c.chat_state="open",this._dispatchEvent(this.Event.SESSIONS_COUNT_CHANGED,{open:this.getOpenSessionCount(),closed:this.getClosedSessionCount()}),c.group_id=a.group_id,c.numUnreadMessages=i,j&&(this.currentSession=c)}return this.propsToItem(a),this._dispatchEvent(Model.Event.MODEL_UPDATE,c),this._dispatchEvent(Model.Event.MODEL_CHANGE),this._dispatchEvent(Model.Event.VIEW_CHANGED,null),void(h&&this._dispatchEvent(this.Event.HISTORY_SESSION_OPENED,{session:c}))}if(d){e=d.id,f=d.chat_state;var k=d.group_id;d.stored_session?d.stored_session=d.stored_session+","+a.group_id:d.stored_session=a.group_id;for(var l in a)d[l]=a[l];d.id=e,d.chat_state="open"==f&&a.group_id!=k?f:a.chat_state,"open"==f&&a.group_id==k&&"closed"==a.chat_state&&(this.currentSession==d&&(this.currentSession=null),this._dispatchEvent(this.Event.SESSION_CLOSED,d),this._dispatchEvent(this.Event.SESSIONS_COUNT_CHANGED,{open:this.getOpenSessionCount(),closed:this.getClosedSessionCount()})),"closed"==f&&"open"==a.chat_state&&this._dispatchEvent(this.Event.SESSIONS_COUNT_CHANGED,{open:this.getOpenSessionCount(),closed:this.getClosedSessionCount()}),this.propsToItem(d);for(var m,n=function(a){for(var b=!!a.filterFunction&&!a.filterFunction(d),c=!1,e=!1,f=0;f<a.length;++f)if(a[f]==d){if(b||c)return void a.__splice(f,1);if(!a.sortFunction||!(f>0&&a.sortFunction(a[f-1],d)>0||f<a.length-1&&a.sortFunction(d,a[f+1])>0))return;a.__splice(f,1),--f,e=!0}else if(!c&&a.sortFunction&&a.sortFunction(d,a[f])<=0){if(a.__splice(f,0,d),e)return;++f,c=!0}b||c||a.push(d)},o=0;o<this.views.length;++o)m=this.views[o],(m.sortFunction||m.filterFunction)&&n(m)}else{d=this.propsToItem(a),"closed"==d.chat_state&&(d.last_update_time=(new Date).getTime()),this.items.push(d),this.itemsCache[d.id]=d;for(var p,q,r=0;r<this.views.length;++r)p=this.views[r],q=p.insertPosition(d),q>=0&&p.__splice(q,0,d);b&&(this._dispatchEvent(Model.Event.MODEL_ADD,d),this._dispatchEvent(Model.Event.MODEL_CHANGE)),this._dispatchEvent(this.Event.SESSIONS_COUNT_CHANGED)}},checkIfMessageAlreadyPresent:function(a,b){if(!a)return!1;for(var c=b.messages,d=!1,e=0;e<c.length;e++)if(c[e].id==a){d=!0;break}return d},changeDateToIST:function(a){var b=6e4*(new Date).getTimezoneOffset(),c=new Date(this.stringToDate(a).getTime()-b).getTime(),d=new Date(c);d.getTime()>0||(d=new Date);var e=d.getHours();e<10&&(e="0"+e);var f=d.getMinutes();f<10&&(f="0"+f);var g=d.getSeconds();g<10&&(g="0"+g);var h=parseInt(d.getMonth()+1),i=d.getFullYear(),j=d.getDate();return j<10&&(j="0"+j),i+"-"+h+"-"+j+" "+e+":"+f+":"+g},isNewer:function(a,b){var c=b.messages[0],d=b.messages[b.messages.length-1];if(!c||"null"==c)return!0;var e=new Date(a.updated.split("-").join("/")).getTime();t3=new Date(d.updated.split("-").join("/")).getTime();var f=new Date(c.updated.split("-").join("/")).getTime();return e>=f||e>t3||"1"==a.state},insertMessage:function(a,b){for(var c=a.messages,d=0,e=b.updated_millis,f=!1,g=0;g<c.length;g++){var h=c[g].updated_millis;if(e>=h){d=g,f=!0;break}}return f||(d=c.length),c.splice(d,0,b),0==d?-1:a.historyIndex>d||d<c.length?0:1},propsToItem:function(a){if(a.vid){if(a.milliSecInUpdated=0,a.updated.lastIndexOf(".")>-1){var b=a.updated.lastIndexOf(".")>-1?a.updated.lastIndexOf("."):-1;b>0?a.milliSecInUpdated=DateTimeUtil.parseInt(a.updated.substr(b+1,a.updated.length)):a.milliSecInUpdated=0}a.vid_from&&""!=a.vid_from&&"null"!=a.vid_from&&(a.vids=a.vid_from),a.name_from&&""!=a.name_from&&"null"!=a.name_from&&(a.names=a.name_from),a.updated=a.timeIST?a.updated:DateTimeUtil.convertStringFromGMTString(a.updated,!0),a.updated_millis=DateTimeUtil.getMillisFromDateString(a.updated),a.updated_millis=a.updated_millis+a.milliSecInUpdated,Platform.log("for updated value: "+a.updated+" ,millis are : "+a.updated_millis+" and message is: "+a.message);var c=ContactModel.getContactWithFQA(a.other_party_type+":"+a.other_party_address,!0,a.name,{vid:a.vids});"in"==a.direction?a.from=c.name?c.name:c.FQA:a.from=DataStore.getUserData("screen_name","");var d=this._getSessionWithGroupId(a.group_id);d||(d=this.getSessionWithRollUpId(a.other_party_type+":"+a.other_party_address)),d.messages||(d.messages=[]);var e;a.dateMillis=DateTimeUtil.getMillisFromDateString(a.updated),d&&(d.historyIndex?d.historyIndex++:d.historyIndex=1),a.isCloseChat&&"true"!=!a.isCloseChat||this.checkIfMessageAlreadyPresent(a.id,d)||(e=this.insertMessage(d,a)),a.isCloseChat&&"true"!=!a.isCloseChat||(d.chat_state="open"),"open"!=d.chat_state||a.isCloseChat&&"true"!=!a.isCloseChat?this.currentSession&&this._dispatchEvent(this.Event.NEW_MESSAGE_CLOSED,{obj:a,session:d,index:"null"}):("1"==a.state&&(d.numUnreadMessages+=1,this._dispatchEvent(this.Event.UNREAD_MESSAGES_CHANGED,{session:d,change:1})),e==-1?this._dispatchEvent(this.Event.NEW_MESSAGE_OPEN,{obj:a,session:d,index:"0"}):1==e?this._dispatchEvent(this.Event.NEW_MESSAGE_OPEN,{obj:a,session:d,index:"null"}):this._dispatchEvent(this.Event.NEW_MESSAGE_OPEN_INSERT,{obj:a,session:d,index:"-1"}))}else{a.hasMember=function(a){for(var b,c=0;c<this.contacts.length;c++)if(this.contacts[c].fqa==a){b=this.contacts[c];break}return b};var f=a.members;try{f=f.trim()}catch(g){}if(f.indexOf(",")>-1||a.chat_rollup_id&&(!a.chat_rollup_id||a.chat_rollup_id==a.group_id))a.isConf=!0,a.chat_rollup_id=a.group_id,a.isClosed="open"!=a.chat_state;else{var h=this.getItemWithRollUpId(a.members);""==h?(a.chat_rollup_id=a.members,a.isClosed="open"!=a.chat_state):a.forceNewSession||(a.id=h),a.isConf=!1}a.contacts=[];var i=a.members.split(",");""!=a.names&&a.names||(a.names=a.members);for(var j=a.names.split(","),k=a.vids?a.vids.split(","):[],l=0;l<i.length;l++){var m=j[l].indexOf(":")>-1?j[l].split(":")[1]:j[l],n=k[l]?k[l]:"-1";a.contacts.push(ContactModel.getContactWithFQA(i[l],!0,m,{vid:n}))}a.historyIndex||(a.historyIndex=0),a.numUnreadMessages||(a.numUnreadMessages=0),a.messages||(a.messages=[]),a.isInBackground||(a.isInBackground=!0)}return a},modelZebraHandler:function(a,b){var c=this,d=function(){c.isLoading&&(c.isLoading=!1),c._dispatchEvent(Model.Event.MODEL_ZEBRA_PARSED,a)};if(!a)return d();if("0"!=(a.getZebraAttribute("error_code")||"0"))return this._dispatchEvent(Model.Event.MODEL_ZEBRA_ERROR,{errorCode:a.getZebraAttribute("error_code"),errorMessage:a.getZEventValue("error_message","")}),d();var e,f,g=a.getZebraAttribute("fmt");if(g&&""!=g&&"1.0"!=g){if("2.0"==g){if(!a.list)return d();e=a.list.mode,"insert"!=e&&"delete"!=e&&(e="update"),f=a.list.items}}else{var h=a.getZEvent("item_keys");if(!h)return this._dispatchEvent(Model.Event.MODEL_LOADED),d();e=h.mode,"insert"!=e&&"delete"!=e&&(e="update");var i=h.value.split(",");if(f=[],this.fmt10PropNames)for(var j,k,l,m=0;m<i.length;m++)if(i[m]&&""!=i[m]){k=i[m],j={id:k};for(var n=0;n<this.fmt10PropNames.length;n++)l=a.getZEvent(this.fmt10PropNames[n]+"_"+k),l&&(j[this.fmt10PropNames[n]]=l.value);f.push(j)}}b&&(e=b),this.updateItems(e,f,!0),this.anchor=a.getZebraAttribute("anchor")||this.anchor,d(),Platform.papi(this.persistKey()).addOrUpdateItems({anchor:this.anchor})},updateItems:function(a,b,c){if(a){this.isLoading&&(this.isLoading=!1),b&&0!=b.length||this._dispatchEvent(Model.Event.MODEL_LOADED);var d={};if("update"==a){if(this.clearModel(!b||0==b.length),b&&b.length>0){for(var e=0;e<b.length;e++)if(this.createOrUpdateItem(b[e],!1),c){var f=this.getSessionForPropListObject(b[e]),g=JSON.stringify(f),h=f.id;d[h]=escape(g)}c&&Platform.papi(this.persistKey()).addOrUpdateItems(d),this._dispatchEvent(Model.Event.MODEL_RELOAD),this._dispatchEvent(Model.Event.MODEL_CHANGE)}}else{if(!b||0==b.length)return;if("insert"==a){for(var e=0;e<b.length;e++)if(this.createOrUpdateItem(b[e],!0),c){var f=this.getSessionForPropListObject(b[e]),g=JSON.stringify(f),h=f.id;d[h]=escape(g)}var i=(b[0].vid?this.itemsCache[this.getItemWithRollUpId(b[0].group_id)]:null)||this.itemsCache[this.getItemWithRollUpId(b[0].other_party_type+":"+b[0].other_party_address)],j=i.id;i.messages.legnth>0&&i.messages.sort(function(a,b){return b.updated_millis-a.updated_millis});for(var e=1;e<b.length;e++)i=(b[0].vid?this.itemsCache[this.getItemWithRollUpId(b[0].group_id)]:null)||this.itemsCache[this.getItemWithRollUpId(b[0].other_party_type+":"+b[0].other_party_address)],i.id!=j&&(i.messages.legnth>0&&i.messages.sort(function(a,b){return b.updated_millis-a.updated_millis}),j=i.id);c&&Platform.papi(this.persistKey()).addOrUpdateItems(d)}else if("delete"==a)for(var e=0;e<b.length;e++)if(this.removeItem(b[e].group_id,b[e]),c)if(null!=b[e].vid){var k=this.itemsCache[b[e].id],h=(JSON.stringify(k),b[e].id);Platform.papi(this.persistKey()).addOrUpdateItems(d)}else Platform.papi(this.persistKey()).deleteRow(b[e].id)}!c&&this.items.length>0&&this._dispatchEvent(this.Event.UNREAD_MESSAGES_CHANGED,{session:this.items[0],change:1})}},getItemFromCacheWithGroupId:function(a){var b=null;for(k in this.itemsCache)if(this.itemsCache[k].group_id==a){b=this.itemsCache[k];break}return b},removeItemFromCache:function(a){for(k in this.itemsCache)if(this.itemsCache[k].group_id==a){delete this.itemsCache[k];break}},removeMessageFromSession:function(a,b){for(var c=0;c<a.messages.length;c++)if(a.messages[c].id==b){a.messages.splice(c,1),this._dispatchEvent(this.Event.MESSAGE_DELETE,{id:b});break}},removeItem:function(a,b){var c=this.getItemFromCacheWithGroupId(a);if(null==b.vid){for(var d,e=0;e<this.views.length;++e){d=this.views[e];for(var f=0;f<d.length;++f)if(d[f].group_id==a){d.__splice(f,1);break}}for(var e=0;e<this.items.length;++e)if(this.items[e].group_id==a){this.items.splice(e,1),this.currentSession&&this.currentSession.group_id==a&&(this.currentSession=null),this._dispatchEvent(Model.Event.MODEL_REMOVE,c),this._dispatchEvent(Model.Event.MODEL_CHANGE);break}this.removeItemFromCache(a),this._dispatchEvent(this.Event.SESSIONS_COUNT_CHANGED,{open:this.getOpenSessionCount(),closed:this.getClosedSessionCount()})}else this.removeMessageFromSession(c,b.id);return c},addPodListeners:function(){IM.addedPodListeners||(IM.addedPodListeners=!0,IM.addListener("MUC_CALL_ENDED","podChatController"+Z.listener_scope,function(a){0!=MyLiveModel.items.length||ConnectionManager.inCall()||(IM.clearAllMUCSessions(),IM._dispatchEvent("CLEAR_ON_CALL_END"))},!0),ConnectionManager.addListener("LOAD_DEFAULT_CHAT_PAGE","podChatController"+Z.listener_scope,function(a){var b=IM.getCurrentCallSession();b?(IM.currentSession.group_id!=b.group_id&&IM.openSession(b.group_id),IM._dispatchEvent("OPEN_CHAT_SESSION_WINDOW",{id:b.group_id})):IM.currentSession?IM._dispatchEvent("OPEN_CHAT_SESSION_WINDOW",{id:IM.currentSession.group_id}):IM._dispatchEvent("OPEN_EMPTY")},!0),ConnectionManager.addListener("OPEN_CALL_ROOM_GROUP_CHAT","podChatController"+Z.listener_scope,function(a){var b=IM._getSessionWithGroupId(CallMUCMembers.callRoomId);if(b){var c=IM.openSession(b.group_id);IM._dispatchEvent("OPEN_CHAT_SESSION_WINDOW",{id:c.group_id})}},!0),IM.addListener(IM.Event.SESSION_CLOSED,"podChatController"+Z.listener_scope,function(a){IM.currentSession||IM._dispatchEvent("OPEN_EMPTY")},!0),IM.addListener("DELETE_ALL_HISTORY","podChatController"+Z.listener_scope,function(a){IM.currentSession||IM._dispatchEvent("OPEN_EMPTY")},!0),IM.addListener("DELETE_HISTORY","podChatController"+Z.listener_scope,function(a){IM.currentSession||IM._dispatchEvent("DELETE_ALL_HISTORY")},!0),IM.addListener(IM.Event.CURRENT_SESSION_CHANGED,"podChatController"+Z.listener_scope,function(a){IM._dispatchEvent("OPEN_CHAT_SESSION_WINDOW",{id:a.group_id})},!0),EventsModel.addListener("AUTO_DIAL_EVENT","c2cDailLoadCall",function(a){IM.hasDialedC2C||(IM.hasDialedC2C=!0,setTimeout(function(){IM.hasDialedC2C=!1},2e3),IM.c2cDailLoad(a.id,a.canAutoDial))},!0),ConnectionManager.addListener("LOAD_PROFILE","IM_C2C",function(a){var b=a.vid.trim().indexOf("event");if(0==b)return void EventsModel._dispatchEvent("AUTO_DIAL_EVENT",{id:a.vid.substr(5,a.vid.length-1),canAutoDial:!0})},!0))},c2cDailLoadCallback:function(a){a.id==IM.c2cEventId&&(EventsModel.removeListener(Model.Event.MODEL_UPDATE,"c2cDailLoadCall",IM.c2cDailLoadCallback),EventsModel.removeListener(Model.Event.MODEL_ADD,"c2cDailLoadCall",IM.c2cDailLoadCallback),IM.canAutoDial&&(IM.canAutoDial=!1,IM.dialC2CForEvent(a.id,!0)))},c2cDailLoad:function(a,b){if(a&&"null"!=a&&""!=a){var c=EventsModel.getItem(a);b?IM.canAutoDial=!0:IM.canAutoDial=!1,IM.c2cEventId=a,c&&"null"!=c&&""!=c?IM.dialC2CForEvent(a,!0):(EventsModel.addListener(Model.Event.MODEL_UPDATE,"c2cDailLoadCall",IM.c2cDailLoadCallback,!0),EventsModel.addListener(Model.Event.MODEL_ADD,"c2cDailLoadCall",IM.c2cDailLoadCallback,!0),EventsModel.loadEvents(null,null,null,null,null,null,null,null,null,a))}},dialC2CForEvent:function(a,b){if(b){var c;if(c=EventsModel.getItem(a),c&&""!=c||(c=EvetsAppointmentsModel.getItem(a)),!c||""==c||"true"!=c.is_autodial)return;var d="",e=new Date;d=DateTimeUtil.getDateObjFromDateString(c.datetime_delayed_start);var f="";f=DateTimeUtil.getDateObjFromDateString(c.datetime_delayed_end);var g=e.getTime()>d.getTime()&&e.getTime()<f.getTime();if(c.destination&&""!==c.destination&&g){if(ConnectionManager.zsState.indexOf("busy")>-1)return Z.jqm.showErrorMessage("Already in a call.",3e3),!1;if(ConnectionManager.isDisconnected)return ConnectionManager._dispatchEvent("CAN_NOT_COMPLETE_REQUEST",{error_code_string:"no_network"}),!1;EventsModel.roomDialId=c.id_bookable,Platform._placeCalls(c.medium,c.destination,"",!0,"",c.title)}}}});IMSessionsModel=Model.extendAsSingleton({init:function(){this._super(),this.isLoading=!1,IM.addListener(IM.Event.SESSION_REMOVED,this,function(a){this.removeSession(a)}),IM.addListener(IM.Event.SESSION_ADDED,this,function(a){this.addSession(a)}),IM.addListener(IM.Event.NEW_MESSAGE,this,function(a){this.updateMessage(a)})},addSession:function(a){this.createOrUpdateItem(a,!0)},updateMessage:function(a){a.session.messages.push(a),this._dispatchEvent(Model.Event.MODEL_UPDATE,a.session)},removeSession:function(a){this.removeItem(a.id)}});var GeneralUtils={zwin:top,getURLParameter:function(a){var b=decodeURI((RegExp(a+"=(.+?)(&|$)").exec(location.search)||[,null])[1]);return"null"==b?null:b},formatNumber:function(a,b){var c=b?b:2;return parseFloat(a).toFixed(c)},isInt:function(a){return"number"==typeof a&&parseFloat(a)==parseInt(a,10)&&!isNaN(a)},removeSpecialChars:function(a){if("undefined"==typeof a)return"";var b=a.replace(/[`~!@#$%^&*()|+\=?;,<>\{\}\[\]\\]/gi,"");return b},toTitleCase:function(a){return a.replace(/\w\S*/g,function(a){return a.charAt(0).toUpperCase()+a.substr(1).toLowerCase()})},windowHeight:function(){var a=460;return document.body&&document.body.offsetWidth&&(a=document.body.offsetHeight),"CSS1Compat"==document.compatMode&&document.documentElement&&document.documentElement.offsetWidth&&(a=document.documentElement.offsetHeight),window.innerWidth&&window.innerHeight&&(a=window.innerHeight),a},windowWidth:function(){var a=630;return document.body&&document.body.offsetWidth&&(a=document.body.offsetWidth),"CSS1Compat"==document.compatMode&&document.documentElement&&document.documentElement.offsetWidth&&(a=document.documentElement.offsetWidth),window.innerWidth&&window.innerHeight&&(a=window.innerWidth),a},isSuperWide:function(){var a=this.windowWidth();return a>1599},isMembersWide:function(){var a=this.windowWidth();return a>1299},isSkinny:function(){var a=!1;this.windowWidth();return a},hasSpecialChars:function(a){if("undefined"==typeof a)return"";var b=a.replace(/[`~!@#$%^&*()|+\=?;,<>\{\}\[\]\\]/gi,"");return b!=a},escapeSpecialChars:function(a){if("undefined"==typeof a)return"";var b=a.replace(/[`~!@#$%^&*()|]/gi,"\\$&");return b=b.replace(/[`"']/gi,"\\'")},urlEncode:function(a){return encodeURIComponent(a).replace("'","%27")},displayImageToCenterbyPageId:function(a,b,c,d){var e=b,f=c,g=d?d:"ui-li-thumb";$("#"+a+" img."+g).each(function(a,b){var c=b.width,d=b.height,g=(e-c)/2,h=(f-d)/2;g<0&&h<0||$(this).attr("style","margin-left:"+g+"px; margin-top: "+h+"px;")})},centerAllImageFromCurrentPage:function(a){var b,c=(Z.jqm.dynamicPage.isFromPool(),a?a:"ui-li-thumb");if(Z.jqm.dynamicPage.$el&&Z.jqm.dynamicPage.$el.length>0)return b=Z.jqm.dynamicPage.$el[0].id,void GeneralUtils.displayImageToCenterbyPageId(b,80,60,c);var d=(Z.jqm.lastZAppTab.zapp,Z.jqm.lastZAppTab.tab),e=isNaN(parseInt(d));e||(d=d&&!isNaN(d)?d:1);var f=e?d:"body"+d;b="zapp-+"+f,GeneralUtils.displayImageToCenterbyPageId(b,80,60,c)},get_zjs:function(){return top},get_zbody:function(){return document.zbody?document.zbody:window},dummy:function(){},validateInputString:function(a,b,c,d){var e="",f="Invalid Input",g=!0,h=d?d:64;return""==a.trim()?(g=!1,e=Z.zjs.ZLocale.getString("input_message_empty","Input can not be empty")):a.length>h&&!b?(g=!1,e=Z.zjs.ZLocale.getString("input_length_exceeds","Input too long. Maximux "+h+" chars are allowed")):c||(g=/^[a-zA-Z0-9!"#$%&'()*+\-,.\/:;<\=>?@\[\]\\^_\}\{~\s]+$/.test(a),g||(e=Z.zjs.ZLocale.getString("invalid_input_chars","Invalid Characters."))),g?g:(Platform.showMessage(f,e,!1,3e3),g)},getValidatedInputString:function(a,b,c,d){var e="",f=d?d:64;return""==a.trim()?a.trim():(e=b&&a.length>f?a.substr(0,64):a,c&&(e=e.replace(/[^a-zA-Z0-9!"#$%&'()*+\-,.\/:;<\=>?@\[\]\\^_\}\{~\s]/g,"")),e)}},DateTimeUtil={epochOffset:0,addProtoToDate:function(){Date.prototype.stdTimezoneOffset=function(){var a=new Date(this.getFullYear(),0,1),b=new Date(this.getFullYear(),6,1);return Math.max(a.getTimezoneOffset(),b.getTimezoneOffset())},Date.prototype.dst=function(){return this.getTimezoneOffset()<this.stdTimezoneOffset()}},convertDateToGMTDate:function(a){var b=6e4*(new Date).getTimezoneOffset(),c=new Date(a.getTime()+b);return c},convertDateFromGMTDate:function(a){var b=6e4*(new Date).getTimezoneOffset(),c=new Date(a.getTime()-b);return c},getOffset:function(a){var b,c=new Date,d=c.getTimezoneOffset(),e=this.stringToDate(a);return b=e.dst()&&c.dst()||!e.dst()&&!c.dst()?d:e.dst()&&!c.dst()?d-60:d+60,6e4*b},convertStringFromGMTString:function(a,b){var c=this.getOffset(a),d=new Date(this.stringToDate(a).getTime()-c).getTime();b&&(d+=this.epochOffset);var e=new Date(d);e.getTime()>0||(e=new Date);var f=e.getHours();f<10&&0!=(""+f).indexOf("0")&&(f="0"+f);var g=e.getMinutes();g<10&&0!=(""+g).indexOf("0")&&(g="0"+g);var h=e.getSeconds();h<10&&0!=(""+h).indexOf("0")&&(h="0"+h),"0"==g&&(g="00"),"0"==h&&(h="00"),"0"==f&&(f="00");var i=this.parseInt(e.getMonth()+1);i<10&&0!=(""+i).indexOf("0")&&(i="0"+i);var j=e.getFullYear(),k=e.getDate();return k<10&&0!=(""+k).indexOf("0")&&(k="0"+k),j+"-"+i+"-"+k+" "+f+":"+g+":"+h},convertStringToGMTString:function(a){var b=new Date,c=(b.getTimezoneOffset(),this.stringToDate(a),this.getOffset(a)),d=new Date(this.stringToDate(a).getTime()+c).getTime(),e=new Date(d);e.getTime()>0||(e=new Date);var f=e.getHours();f<10&&0!=(""+f).indexOf("0")&&(f="0"+f);var g=e.getMinutes();g<10&&0!=(""+g).indexOf("0")&&(g="0"+g);var h=e.getSeconds();h<10&&0!=(""+h).indexOf("0")&&(h="0"+h),"0"==g&&(g="00"),"0"==h&&(h="00"),"0"==f&&(f="00");var i=this.parseInt(e.getMonth()+1);i<10&&0!=(""+i).indexOf("0")&&(i="0"+i);var j=e.getFullYear(),b=e.getDate();return b<10&&0!=(""+b).indexOf("0")&&(b="0"+b),j+"-"+i+"-"+b+" "+f+":"+g+":"+h},stringToDate:function(a){var b=a.split(" "),c=b[0],d=b[1],e=c.indexOf("-")>-1?c.split("-"):c.split("/"),f=d.split(":"),g=new Date(e[0],e[1]-1,e[2],f[0],f[1],f[2]);return g},getStringFromDateObj:function(a){var b=a.getSeconds();b<10&&(b="0"+b);var c=a.getMinutes();c<10&&(c="0"+c);var d=a.getHours();d<10&&(d="0"+d);var e=a.getDate();e<10&&(e="0"+e);var f=a.getMonth();return f++,f<10&&(f="0"+f),a.getFullYear()+"-"+f+"-"+e+" "+d+":"+c+":"+b},getStringFromDateTimeString:function(a,b,c){return a+" "+b+(c?":00":"")},getDateObjFromDateTimeString:function(a,b){for(var c=a,d=b,e=c.indexOf("-")>-1?c.split("-"):c.split("/"),f=d.split(":"),g=0;g<e.length;g++)"0"==e[g].indexOf("0")&&(e[g]=e[g].substr(1,e[g].length-1));for(var g=0;g<f.length;g++)"0"==f[g].indexOf("0")&&(f[g]=f[g].substr(1,f[g].length-1));var h=new Date(this.parseInt(e[0]),this.parseInt(e[1])-1,this.parseInt(e[2]),this.parseInt(f[0]),this.parseInt(f[1]),0);return h},getDateObjFromDateString:function(a){var b=a.split(" "),c=b[0],d="";d=b.length>1?b[1]:" 00:00";for(var e=c.indexOf("-")>-1?c.split("-"):c.split("/"),f=d.split(":"),g=0;g<e.length;g++)"0"==e[g].indexOf("0")&&(e[g]=e[g].substr(1,e[g].length-1));for(var g=0;g<f.length;g++)"0"==f[g].indexOf("0")&&(f[g]=f[g].substr(1,f[g].length-1));var h=new Date(this.parseInt(e[0]),this.parseInt(e[1])-1,this.parseInt(e[2]),this.parseInt(f[0]),this.parseInt(f[1]),0);return h},getMillisFromDateString:function(a){var b=a.split(" "),c=b[0],d="";d=b.length>1?b[1]:"00:00:00";for(var e=c.indexOf("-")>-1?c.split("-"):c.split("/"),f=d.split(":"),g=0;g<e.length;g++)"0"==e[g].indexOf("0")&&(e[g]=e[g].substr(1,e[g].length-1));for(var g=0;g<f.length;g++)"0"==f[g].indexOf("0")&&(f[g]=f[g].substr(1,f[g].length-1));var h=new Date(this.parseInt(e[0]),this.parseInt(e[1])-1,this.parseInt(e[2]),this.parseInt(f[0]),this.parseInt(f[1]),this.parseInt(f[2]));return h.getTime()},getDateObjFromTimeString:function(a){for(var b=a.split(":"),c=0;c<b.length;c++)"0"==b[c].indexOf("0")&&(b[c]=b[c].substr(1,b[c].length-1));var d=new Date(this.parseInt(b[0]),this.parseInt(b[1]),0);return d},getFormatedDateStringFromString:function(a){var b="";a.indexOf(" ")>-1&&(b=a.split(" ")[1],a=a.split(" ")[0]),a=a.split("-").join("/");var c=new Date(a),d={0:"Sun",1:"Mon",2:"Tue",3:"Wed",4:"Thu",5:"Fri",6:"Sat"},e={1:"Jan",2:"Feb",3:"March",4:"April",5:"May",6:"Jun",7:"July",8:"Aug",9:"Sep",10:"Oct",11:"Nov",12:"Dec"};return d[c.getDay()]+" "+e[c.getMonth()+1]+" "+c.getDate()+", "+c.getFullYear()+" "+this.formatTimeFromString(b,"hh:mm:ss TT")},getLocalTimeZoneString:function(){var a=new Date,b=a.toString();return b.substr(b.indexOf("(")+1,b.length-2).replace(")","")},getLocalTimeZoneDisplay:function(){var a=(new Date).getTimezoneOffset()*-1/60;return a<0?"GMT "+a:"GMT +"+a},getLocalTimeZoneDisplayString:function(){var a=(new Date).toTimeString(),b=a.indexOf("("),c=a.indexOf(")");return b!=-1&&c!=-1?a.substr(b+1,c-b-1):DateTimeUtil.getLocalTimeZoneDisplay()},getLocalTimeZoneOffsetMinutes:function(){return(new Date).getTimezoneOffset()*-1},getFormatedDuration:function(a,b){var c,d=a.getTime()-b.getTime(),e=Math.floor(d/1e3/60/60/24);d-=1e3*e*60*60*24;var f=Math.floor(d/1e3/60/60);d-=1e3*f*60*60;var g=Math.floor(d/1e3/60);d-=1e3*g*60;var h=Math.floor(d/1e3);c=e+"day/s "+(e<2?f+"hr/s "+g+"min/s "+h+" second/s ":"");var i=this.stringCheck(e,"day"),j=this.stringCheck(f,"hr"),k=this.stringCheck(g,"min");return e>=2&&(j="",k=""),1==e&&""!=j&&(k=""),i+j+k},getFormatedDurationFromMins:function(a){var b,c=60*this.parseInt(a)*1e3,d=Math.floor(c/1e3/60/60/24);c-=1e3*d*60*60*24;var e=Math.floor(c/1e3/60/60);c-=1e3*e*60*60;var f=Math.floor(c/1e3/60);c-=1e3*f*60;var g=Math.floor(c/1e3);b=d+"day/s "+(d<2?e+"hr/s "+f+"min/s "+g+" second/s ":"");var h=this.stringCheck(d,"day"),i=this.stringCheck(e,"hr"),j=this.stringCheck(f,"min");return d>=2&&(i="",j=""),1==d&&""!=i&&(j=""),h+i+j},getFormatedDurationFromMillis:function(a){var b,c=this.parseInt(a),d=Math.floor(c/1e3/60/60/24);c-=1e3*d*60*60*24;var e=Math.floor(c/1e3/60/60);c-=1e3*e*60*60;var f=Math.floor(c/1e3/60);c-=1e3*f*60;var g=Math.floor(c/1e3);b=d+"day/s "+(d<2?e+"hr/s "+f+"min/s "+g+" second/s ":"");var h=this.stringCheck(d,"day"),i=this.stringCheck(e,"hr"),j=this.stringCheck(f,"min"),k=this.stringCheck(g,"second");return d>=2&&(i="",j=""),1==d&&""!=i&&(j=""),h+i+j+k},getFormatedDurationFromMillisAsString:function(a){var b=this.parseInt(a),c=Math.floor(b/1e3/60/60);b-=1e3*c*60*60;var d=Math.floor(b/1e3/60);b-=1e3*d*60;var e=Math.floor(b/1e3),f="";return m="",s="",f=c<10?"0"+c:""+c,f+=":",d<10?m="0"+d:m=""+d,m+=":",e<10?s="0"+e:s=""+e,f+m+s},getDurationInSecondFromString:function(a){var b=a.split(":"),c=0;return c=60*this.parseInt(b[0])*60+60*this.parseInt(b[1])+this.parseInt(b[2])},stringCheck:function(a,b){var c=this.parseInt(a);return b=c>1?c+" "+Z.zjs.ZLocale.getString("zjs_"+b+"s",b+"s")+" ":1==c?c+" "+Z.zjs.ZLocale.getString("zjs_"+b,b)+" ":""},formatDateTime:function(a,b){if(a instanceof Date){var c=new Array(Z.zjs.ZLocale.getString("zjs_jan","Jan"),Z.zjs.ZLocale.getString("zjs_feb","Feb"),Z.zjs.ZLocale.getString("zjs_mar","Mar"),Z.zjs.ZLocale.getString("zjs_apr","Apr"),Z.zjs.ZLocale.getString("zjs_may","May"),Z.zjs.ZLocale.getString("zjs_jun","Jun"),Z.zjs.ZLocale.getString("zjs_jul","Jul"),Z.zjs.ZLocale.getString("zjs_aug","Aug"),Z.zjs.ZLocale.getString("zjs_sep","Sep"),Z.zjs.ZLocale.getString("zjs_oct","Oct"),Z.zjs.ZLocale.getString("zjs_nov","Nov"),Z.zjs.ZLocale.getString("zjs_dec","Dec")),d=a.getFullYear(),e=a.getMonth(),f=c[e],g=a.getDate(),h=g<10?"0"+g:g,i=a.getHours(),j=i<10?"0"+i:i,k=a.getMinutes(),l=k<10?"0"+k:k,m=a.getSeconds(),n=m<10?"0"+m:m,o=i>11?"PM":"AM";return j>12&&(j-=12),j<10&&(0==j?j="00":(""+j).indexOf("0")==-1&&(j="0"+j)),b=b.replace(/yyyy/i,d),b=b.replace(/mmm/i,f),b=b.replace(/dd/i,h),b=b.replace(/hh/i,j),b=b.replace(/mm/i,l),b=b.replace(/ss/i,n),b=b.replace(/TT/i,o)}return""},formatDate:function(a,b){if(a instanceof Date){var c=new Array("Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"),d=a.getFullYear(),e=a.getMonth(),f=c[e],g=a.getDate(),h=g<10?"0"+g:g;return b=b.replace(/yyyy/i,d),b=b.replace(/mmm/i,f),b=b.replace(/dd/i,h)}return""},formatTime:function(a,b){var c=!1;if(c="undefined"!=typeof PartnerConfig&&PartnerConfig.getKey("use_12Hour_format",!0),a instanceof Date){var d,e=a.getHours(),f=e>11?"PM":"AM";e>12&&(e-=12),d=e<10&&"AM"==f&&!c?"0"+e:e,0==e&&c&&(d="12");var g=a.getMinutes(),h=g<10?"0"+g:g,i=a.getSeconds(),j=i<10?"0"+i:i;return b=b.replace(/hh/i,d),b=b.replace(/mm/i,h),b=b.replace(/ss/i,j),b=b.replace(/TT/i,f)}return""},formatTimeFromString:function(a,b){if("undefined"==typeof PartnerConfig||!PartnerConfig.getKey("use_12Hour_format",!0))return a;a.trim().indexOf(" ")>-1&&(a=a.split(" ")[0]);var c,d=a.split(":"),e=this.parseInt(d[0]),f=e>11?"PM":"AM";e>12&&(e-=12),c=e,0==e&&(c="12");var g=this.parseInt(d[1]),h=g<10?"0"+g:g,i=this.parseInt(d[2]),j=i<10?"0"+i:i;return b=b.replace(/hh/i,c),b=b.replace(/mm/i,h),b=b.replace(/ss/i,j),b=b.replace(/TT/i,f)},getTimeFromFormattedString:function(a,b){if(!("undefined"!=typeof PartnerConfig&&PartnerConfig.getKey("use_12Hour_format",!0)||b))return a;var c=a.split(" ");if(c.length<2)return a;var d=c[1],e=c[0],f=e.split(":");if("am"==d.toLowerCase()){var g=this.parseInt(f[0]);if(g<12)return e;for(var h="00",i=1;i<f.length;i++)h=h+":"+f[i];return Platform.log("returning value"+h),h}var g=this.parseInt(f[0]);return 12!=g?(g+=12,f[0]=g,f.join(":")):e},matchDate:function(a,b,c){var d=this.parseInt(c[2])-1,e=this.parseInt(c[3]),f=c[1];return a&&"Invalid Date"!=a?!(a.getMonth()!=d&&a.getMonth()!=d+1||a.getDate()!=e&&a.getDate()!=e-1&&a.getDate()!=e+1||a.getFullYear()!=f):!(!b||"Invalid Date"==b)&&!(b.getMonth()!=d&&b.getMonth()!=d+1||b.getDate()!=e&&b.getDate()!=e-1&&b.getDate()!=e+1||b.getFullYear()!=f)},isValidDate:function(a,b){var c="";b&&""!=b?"yyyy-mm-dd"==b||"YYYY-MM-DD"==b?c="^([0-9]{4})-([0-9]{2})-([0-9]{2})$":"YYYY/MM/DD"==b||"yyyy/mm/dd"==b?c="^([0-9]{4})/([0-9]{2})/([0-9]{2})$":"dd-mm-yyyy"==b||"DD-MM-YYYY"==b?c="^([0-9]{2})-([0-9]{2})-([0-9]{4})$":"DD/MM/YYYY"!=b&&"dd/mm/yyyy"!=b||(c="^([0-9]{2})/([0-9]{2})/([0-9]{4})$"):c="^([0-9]{4})-([0-9]{2})-([0-9]{2})$";var d=new RegExp(c);a=a.trim();var e=d.exec(a);if(!e)return!1;var f=new Date(e[0].split("-").join("/")),g=new Date(e[0]),h=this.matchDate(f,g,e);return h},setEpochOffset:function(a){var b=(new Date).getTime(),c=1e3*a;this.epochOffset=b-c},getNow:function(){var a=(new Date).getTime(),b=a-this.epochOffset;return b},parseInt:function(a){if(0==b||"0"==b)return parseInt(b);for(var b=(a+"").trim();0==b.indexOf("0");)b=b.substr(1,b.length-1);return a&&""!=a&&""==b&&(b="0"),parseInt(b)}};DateTimeUtil.addProtoToDate();var PartnerConfig={getKey:function(a,b,c){var c=c?c:ConnectionManager.partner;c=c.replace("-","_");var d=window[c+"_config"],e=d?d[a]:null;return"undefined"!=typeof e&&null!=e||(e=b),e}},home_config={partner:"home",partnerPaymentPreference:"PostPay",zapps:["event","schedule","appointment_book","profile"],enableEarnings:!1,enableRecording:!0,enableCharging:!1,enableSNGIcons:!1,enableCreateSaypage:!0,use_configured_search:!0,browse_text:"Search",priceDisplay:"min",appointment_cutoff_time_mins:20,end_appointment_on_callend:!0,show_participants_in_muc:!1,callersqueues:!0,showOfflineCallRoomOwner:!1,slot_mins:15,max_slots_allowed:8,appointment_slot_text:"Appointment slots are 15 mins, but you can select consecutive slots if you would like to book a longer appointment.",appointment_slot_error_text:"Only continuous slots can be selected with a maximum of 2 hours",use_slots_mins_from_settings:!0,enableSelfAppointment:!0,wb_share_supported_formats:"all",show_noThanks_button:!0,enabledAllBilling:!1,enableSelfAppointmentWithAgents:!0,join_event_string:"Join Meeting",display_string_event:"Meeting",profile_events_title:"Meetings",event_string:"Meeting",has_hard_stop:!1,folder_create_only_private:!1,folder_create_allow_public:!0,folder_create_allow_agents:!0,folder_create_allow_users:!0,folder_create_enable_event_access:!0},oliver_config={appointment_cutoff_time_mins:60},CareView_config={enableCreateSaypage:!0},thethinktank_config={requireHashtag:!0,enableCharging:!1},motoring_config={requireHashtag:!0,enableCharging:!1},photography_config={requireHashtag:!0,enableCharging:!1},friendconnections_config={requireHashtag:!0,enableCharging:!1},apptest_config={requireHashtag:!0,enableCharging:!1},kuvu_config={partner:"kuvu",priceDisplay:"hour",enableCreateSaypage:!1},byttuition_config={partner:"byttuition",priceDisplay:"hour",event_not_found:"No Seminars Planned",enableCreateSaypage:!1},psychictoday_config={partner:"psychictoday",partnerPaymentPreference:"PrePay",enableRecording:!1,enableCharging:!1,enableLibrary:!1,enableCreateSaypage:!1,settings_alert_me_user:!1,allowTopUp:!0,enableAppointments:!1,agents_ordering:"HOLD_TIME",allowReceptionCall:!0,reception_address:"Receptionists@category.vidiconf.com#123",showAddToMUC:!1,default_home_page:"agents",show_cat_bar:!0,showAccountDetails:!1,disableForumButton:!0,showHolidays:!1,show_settings_on_call_end:!0,has_no_appointment_page:!0,hasVoiceOnlyAppt:!0,ignoreConfirmApptCancelByAgent:!0,hasRoomView:!1},nightdoctor_config={partner:"nightdoctor",hideAgentsSearch:!0,profile_vid:"1004",profile_id:"saypage1004"},nhft_config={partner:"nhft",default_home_page:"agents",partner_name_for_user_appointment_list:"Patients",partner_name_for_host_appointment_list:"Staff"},iConsult_config={partner:"iConsult",hideAgentsSearch:!0,profile_vid:"10649",profile_id:"saypage10649"},nhs_config={partner:"nhs",enterProfileLink:"Enter Clinician Code",enterProfileLinkDesk:"If you have been provided with the ID of an NHS staff member who does not appear in your list of connections but you would like to add them, please enter the ID here to retrieve their profile page. You will find a button on their profile page to add them to your connections.",agentLeaveNotes:!1,settings_contact_details:!1,userAddToCall:!1,userCancelAppointment:!1,enableRecording:!1,enableCreateSaypage:!1,disableUserAppointment:!0,disableForumButton:!0,disableUserAddPerson:!0,disableSignUp:!0,hideShare:!0,is_search_home:!0,hideCatsOrAgents:!0,forceUserToHaveBooking:!0,showSMSReminders:!0,showReviews:!1,showWall:!1,enableCharging:!1,langOnEvents:!1,catOnEvents:!1,showAccountDetails:!1,search_strip_class:"search_strip_nhs",default_home_page_index:"3",browse_text:"Search",default_home_page:"contact",end_appointment_on_callend:!1,offerAppointmentBookerOptionToGetConfirmation:!0,callersqueues:!0,createInstantEventTitle:"Instant Meeting",createPublicEventTitle:"Public Meeting",createPrivateEventTitle:"Private Meeting",has_call_share_screen:!1,enableSelfAppointmentWithAgents:!0,has_hard_stop:!1,appointment_cutoff_time_mins:5,partner_name_for_user_appointment_list:"Patients",
partner_name_for_host_appointment_list:"Staff"},cerner_config={agentLeaveNotes:!1,settings_contact_details:!1,userAddToCall:!1,userCancelAppointment:!1,enableRecording:!1,enableCreateSaypage:!1,disableUserAppointment:!0,disableForumButton:!0,disableUserAddPerson:!0,disableSignUp:!0,hideShare:!0,is_search_home:!0,hideCatsOrAgents:!0,forceUserToHaveBooking:!0,showSMSReminders:!0,showReviews:!1,showWall:!1,enableCharging:!1,langOnEvents:!1,catOnEvents:!1,showAccountDetails:!1,search_strip_class:"search_strip_nhs",default_home_page_index:"3",browse_text:"Search",default_home_page:"contact",end_appointment_on_callend:!1,offerAppointmentBookerOptionToGetConfirmation:!0,partner_name_for_user_appointment_list:"Patients",partner_name_for_host_appointment_list:"Staff"},nhft1_config={partner:"nhft1",agentLeaveNotes:!1,userAddToCall:!1,userCancelAppointment:!1,enableRecording:!1,enableCreateSaypage:!1,disableUserAppointment:!0,disableForumButton:!0,disableUserAddPerson:!0,disableSignUp:!0,hideShare:!0,is_search_home:!0,hideCatsOrAgents:!0,enableCharging:!1,langOnEvents:!1,catOnEvents:!1,showAccountDetails:!1,showReviews:!1,showWall:!1,forceUserToHaveBooking:!0,has_call_share_screen:!1,offerAppointmentBookerOptionToGetConfirmation:!0,has_hard_stop:!1,partner_name_for_user_appointment_list:"Patients",partner_name_for_host_appointment_list:"Staff"},nhft2_config={partner:"nhft2",agentLeaveNotes:!1,userAddToCall:!1,userCancelAppointment:!1,enableRecording:!1,enableCreateSaypage:!1,disableUserAppointment:!0,disableForumButton:!0,disableUserAddPerson:!0,disableSignUp:!0,hideShare:!0,is_search_home:!0,hideCatsOrAgents:!0,enableCharging:!1,langOnEvents:!1,catOnEvents:!1,showAccountDetails:!1,showReviews:!1,showWall:!1,forceUserToHaveBooking:!0,has_call_share_screen:!1,offerAppointmentBookerOptionToGetConfirmation:!0,has_hard_stop:!1,partner_name_for_user_appointment_list:"Patients",partner_name_for_host_appointment_list:"Staff"},nhft3_config={partner:"nhft3",agentLeaveNotes:!1,userAddToCall:!1,userCancelAppointment:!1,enableRecording:!1,enableCreateSaypage:!1,disableUserAppointment:!0,disableForumButton:!0,disableUserAddPerson:!0,disableSignUp:!0,hideShare:!0,is_search_home:!0,hideCatsOrAgents:!0,enableCharging:!1,langOnEvents:!1,catOnEvents:!1,showAccountDetails:!1,showReviews:!1,showWall:!1,has_call_share_screen:!1,forceUserToHaveBooking:!0,offerAppointmentBookerOptionToGetConfirmation:!0,has_hard_stop:!1,partner_name_for_user_appointment_list:"Patients",partner_name_for_host_appointment_list:"Staff"},nhft4_config={partner:"nhft4",agentLeaveNotes:!1,userAddToCall:!1,userCancelAppointment:!1,enableRecording:!1,enableCreateSaypage:!1,disableUserAppointment:!0,disableForumButton:!0,disableUserAddPerson:!0,disableSignUp:!0,hideShare:!0,is_search_home:!0,hideCatsOrAgents:!0,enableCharging:!1,langOnEvents:!1,catOnEvents:!1,showAccountDetails:!1,showReviews:!1,showWall:!1,has_call_share_screen:!1,forceUserToHaveBooking:!0,offerAppointmentBookerOptionToGetConfirmation:!0,has_hard_stop:!1,partner_name_for_user_appointment_list:"Patients",partner_name_for_host_appointment_list:"Staff"},nhft5_config={partner:"nhft5",agentLeaveNotes:!1,userAddToCall:!1,userCancelAppointment:!1,enableRecording:!1,enableCreateSaypage:!1,disableUserAppointment:!0,disableForumButton:!0,disableUserAddPerson:!0,disableSignUp:!0,hideShare:!0,is_search_home:!0,hideCatsOrAgents:!0,enableCharging:!1,langOnEvents:!1,catOnEvents:!1,showAccountDetails:!1,showReviews:!1,showWall:!1,has_call_share_screen:!1,forceUserToHaveBooking:!0,offerAppointmentBookerOptionToGetConfirmation:!0,has_hard_stop:!1,partner_name_for_user_appointment_list:"Patients",partner_name_for_host_appointment_list:"Staff"},nhft6_config={partner:"nhft6",agentLeaveNotes:!1,userAddToCall:!1,userCancelAppointment:!1,enableRecording:!1,enableCreateSaypage:!1,disableUserAppointment:!0,disableForumButton:!0,disableUserAddPerson:!0,disableSignUp:!0,hideShare:!0,is_search_home:!0,hideCatsOrAgents:!0,enableCharging:!1,langOnEvents:!1,catOnEvents:!1,showAccountDetails:!1,showReviews:!1,showWall:!1,has_call_share_screen:!1,forceUserToHaveBooking:!0,offerAppointmentBookerOptionToGetConfirmation:!0,has_hard_stop:!1,partner_name_for_user_appointment_list:"Patients",partner_name_for_host_appointment_list:"Staff"},nhft7_config={partner:"nhft7",agentLeaveNotes:!1,userAddToCall:!1,userCancelAppointment:!1,enableRecording:!1,enableCreateSaypage:!1,disableUserAppointment:!0,disableForumButton:!0,disableUserAddPerson:!0,disableSignUp:!0,hideShare:!0,is_search_home:!0,hideCatsOrAgents:!0,enableCharging:!1,langOnEvents:!1,catOnEvents:!1,showAccountDetails:!1,showReviews:!1,showWall:!1,has_call_share_screen:!1,forceUserToHaveBooking:!0,offerAppointmentBookerOptionToGetConfirmation:!0,has_hard_stop:!1,partner_name_for_user_appointment_list:"Patients",partner_name_for_host_appointment_list:"Staff"},telemedicine_config={partner:"telemedicine",enableCharging:!1},ntw1_config={partner:"ntw1",agentLeaveNotes:!1,userAddToCall:!1,userCancelAppointment:!1,enableRecording:!1,enableCreateSaypage:!1,disableUserAppointment:!0,disableForumButton:!0,disableUserAddPerson:!0,disableSignUp:!0,hideShare:!0,is_search_home:!0,hideCatsOrAgents:!0,enableCharging:!1,langOnEvents:!1,catOnEvents:!1,showAccountDetails:!1,showReviews:!1,showWall:!1,forceUserToHaveBooking:!0,offerAppointmentBookerOptionToGetConfirmation:!0},cloudroom_config={enterProfileLinkDesk:"Search for other CloudRoom users here. For easy access to your contacts in future add them to your Connections",enableCharging:!1,default_home_page_index:"3",enableSNGIcons:!1,browse_text:"Search",vanity_url:"cloudroom.me",enableCreateSaypage:!1,hideCatsOrAgents:!0,is_search_home:!0,enabledAllBilling:!1,slot_mins:30,max_slots_allowed:2,appointment_slot_text:"Appointment slots are 30 mins, but you can select consecutive slots if you would like to book a longer appointment.",use_slots_mins_from_settings:!1,appointment_slot_error_text:"Only continuous slots can be selected with a maximum of 1 hour",enableSelfAppointment:!1},medtronic_config={partner:"medtronic",whiteboard_force_fg:!0,enableCharging:!1,enableInstantEvent:!0,enableMeetingRoom:!1,enableLiveEvent:!1,displayEventSelectionOption:!1,displayEventTitle:!0,displayEventDescription:!1,displayEventStartTime:!1,catOnEvents:!1,displayEventMedium:!1,displayEventLanguage:!1,slot_mins:60,max_slots_allowed:1,appointment_slot_text:"Session slots are 60 mins.",use_slots_mins_from_settings:!1,appointment_slot_error_text:"Only one slot can be selected at time",enableAllEventInEventOverview:!1,showEventParticipantsToUsers:!1,showPhoneNumberOnBookAppointment:!0,showCommTypeConsecutiveWeekOnBookAppointment:!1,sendHangupPressedOnCallEnd:!0,confirmEventCancel:!0,is_search_home:!0,hideCatsOrAgents:!0,default_home_page_index:"3",browse_text:"Search",default_home_page:"contact",enableSNGIcons:!1,library_has_link:!0,iichatSurveyLink:"http://ec2-54-202-95-203.us-west-2.compute.amazonaws.com/530gtraining-survey",forceUserToHaveBooking:!0},ef_config={whiteboard_force_fg:!0,moderator_always_outline:!0,wb_room_fs_start_hidden:!0,has_call_share_screen:!1,conf_controls_in_page:!1,users_may_control_page:!1,add_to_muc:!1,allow_private_chat:!0,private_chat_row:!0,ignore_load_queue:!0,ignore_load_queue_event:"LAUNCH_WB_FOR_CALL_ROOM",ignore_inbox_empty_message:!0,ignore_wb_text:!0,left_frame_default_zapp:"viewer",WB_FS_HAS_SAVE:!1,left_frame_default_zapp_tab:"4",request_schedule_on_connection_made:!1,show_unread_on_connections_row:!0},henryford_config={partner:"henryford",enableCharging:!1,enableInstantEvent:!0,enableMeetingRoom:!1,enableLiveEvent:!1,displayEventSelectionOption:!1,displayEventTitle:!0,displayEventDescription:!1,displayEventStartTime:!1,catOnEvents:!1,displayEventMedium:!1,displayEventLanguage:!1,slot_mins:60,max_slots_allowed:1,appointment_slot_text:"Session slots are 60 mins.",use_slots_mins_from_settings:!1,appointment_slot_error_text:"Only one slot can be selected at time",enableAllEventInEventOverview:!1,showEventParticipantsToUsers:!1,showPhoneNumberOnBookAppointment:!0,showCommTypeConsecutiveWeekOnBookAppointment:!1,sendHangupPressedOnCallEnd:!0,confirmEventCancel:!0,is_search_home:!0,hideCatsOrAgents:!0,default_home_page_index:"3",browse_text:"Search",default_home_page:"contact",enableSNGIcons:!1,vanity_url:"henryford.saypage.com",library_has_link:!0,forceUserToHaveBooking:!0},sssft1_config={enableSelfAppointmentWithAgents:!0},virgincare_config={displayTextFree:"",show_noThanks_button:!0,has_call_share_screen:!1,enableInstantEvent:!1,enableLiveEvent:!1,library_has_link:!0,displayEventPermissions:!0,createFolderHasAcess:!0,enableSelfAppointmentWithAgents:!0},ver2_config={partner:"home",partnerPaymentPreference:"PostPay",zapps:["event","schedule","appointment_book","profile"],enableEarnings:!0,enableRecording:!0,enableCharging:!0,enableSNGIcons:!1,enableCreateSaypage:!0,use_configured_search:!0,browse_text:"Search",priceDisplay:"min",appointment_cutoff_time_mins:20,end_appointment_on_callend:!0,show_participants_in_muc:!1,callersqueues:!0,showOfflineCallRoomOwner:!1,slot_mins:15,max_slots_allowed:8,appointment_slot_text:"Appointment slots are 15 mins, but you can select consecutive slots if you would like to book a longer appointment.",appointment_slot_error_text:"Only continuous slots can be selected with a maximum of 2 hours",use_slots_mins_from_settings:!0,enableSelfAppointment:!0,wb_share_supported_formats:"all",show_noThanks_button:!0},wewewew_config={partner:"home",partnerPaymentPreference:"PostPay",zapps:["event","schedule","appointment_book","profile"],enableEarnings:!0,enableRecording:!0,enableCharging:!0,enableSNGIcons:!1,enableCreateSaypage:!0,use_configured_search:!0,browse_text:"Search",priceDisplay:"min",appointment_cutoff_time_mins:20,end_appointment_on_callend:!0,show_participants_in_muc:!1,callersqueues:!0,showOfflineCallRoomOwner:!1,slot_mins:15,max_slots_allowed:8,appointment_slot_text:"Appointment slots are 15 mins, but you can select consecutive slots if you would like to book a longer appointment.",appointment_slot_error_text:"Only continuous slots can be selected with a maximum of 2 hours",use_slots_mins_from_settings:!0,enableSelfAppointment:!0,wb_share_supported_formats:"all",show_noThanks_button:!0},bluebridge_config={partner:"home",partnerPaymentPreference:"PostPay",zapps:["event","schedule","appointment_book","profile"],enableEarnings:!0,enableRecording:!0,enableCharging:!0,enableSNGIcons:!1,enableCreateSaypage:!0,use_configured_search:!0,browse_text:"Search",priceDisplay:"min",appointment_cutoff_time_mins:20,end_appointment_on_callend:!0,show_participants_in_muc:!1,callersqueues:!0,showOfflineCallRoomOwner:!1,slot_mins:15,max_slots_allowed:8,appointment_slot_text:"Appointment slots are 15 mins, but you can select consecutive slots if you would like to book a longer appointment.",appointment_slot_error_text:"Only continuous slots can be selected with a maximum of 2 hours",use_slots_mins_from_settings:!0,enableSelfAppointment:!0,wb_share_supported_formats:"all",show_noThanks_button:!0},investglass_config={partner:"home",partnerPaymentPreference:"PostPay",zapps:["event","schedule","appointment_book","profile"],enableEarnings:!0,enableRecording:!0,enableCharging:!0,enableSNGIcons:!1,enableCreateSaypage:!0,use_configured_search:!0,browse_text:"Search",priceDisplay:"min",appointment_cutoff_time_mins:20,end_appointment_on_callend:!0,show_participants_in_muc:!1,callersqueues:!0,showOfflineCallRoomOwner:!1,slot_mins:15,max_slots_allowed:8,appointment_slot_text:"Appointment slots are 15 mins, but you can select consecutive slots if you would like to book a longer appointment.",appointment_slot_error_text:"Only continuous slots can be selected with a maximum of 2 hours",use_slots_mins_from_settings:!0,enableSelfAppointment:!0,wb_share_supported_formats:"all",show_noThanks_button:!0},alliants_config={partner:"home",partnerPaymentPreference:"PostPay",zapps:["event","schedule","appointment_book","profile"],enableEarnings:!0,enableRecording:!0,enableCharging:!0,enableSNGIcons:!1,enableCreateSaypage:!0,use_configured_search:!0,browse_text:"Search",priceDisplay:"min",appointment_cutoff_time_mins:20,end_appointment_on_callend:!0,show_participants_in_muc:!1,callersqueues:!0,showOfflineCallRoomOwner:!1,slot_mins:15,max_slots_allowed:8,appointment_slot_text:"Appointment slots are 15 mins, but you can select consecutive slots if you would like to book a longer appointment.",appointment_slot_error_text:"Only continuous slots can be selected with a maximum of 2 hours",use_slots_mins_from_settings:!0,enableSelfAppointment:!0,wb_share_supported_formats:"all",show_noThanks_button:!0},vtcsecure_config={partner:"home",partnerPaymentPreference:"PostPay",zapps:["event","schedule","appointment_book","profile"],enableEarnings:!0,enableRecording:!0,enableCharging:!0,enableSNGIcons:!1,enableCreateSaypage:!0,use_configured_search:!0,browse_text:"Search",priceDisplay:"min",appointment_cutoff_time_mins:20,end_appointment_on_callend:!0,show_participants_in_muc:!1,callersqueues:!0,showOfflineCallRoomOwner:!1,slot_mins:15,max_slots_allowed:8,appointment_slot_text:"Appointment slots are 15 mins, but you can select consecutive slots if you would like to book a longer appointment.",appointment_slot_error_text:"Only continuous slots can be selected with a maximum of 2 hours",use_slots_mins_from_settings:!0,enableSelfAppointment:!0,wb_share_supported_formats:"all",show_noThanks_button:!0},genesys_config={partner:"home",partnerPaymentPreference:"PostPay",zapps:["event","schedule","appointment_book","profile"],enableEarnings:!0,enableRecording:!0,enableCharging:!0,enableSNGIcons:!1,enableCreateSaypage:!0,use_configured_search:!0,browse_text:"Search",priceDisplay:"min",appointment_cutoff_time_mins:20,end_appointment_on_callend:!0,show_participants_in_muc:!1,callersqueues:!0,showOfflineCallRoomOwner:!1,slot_mins:15,max_slots_allowed:8,appointment_slot_text:"Appointment slots are 15 mins, but you can select consecutive slots if you would like to book a longer appointment.",appointment_slot_error_text:"Only continuous slots can be selected with a maximum of 2 hours",use_slots_mins_from_settings:!0,enableSelfAppointment:!0,wb_share_supported_formats:"all",show_noThanks_button:!0,enableSelfAppointmentWithAgents:!0},genesys_usa_config={partner:"home",partnerPaymentPreference:"PostPay",zapps:["event","schedule","appointment_book","profile"],enableEarnings:!0,enableRecording:!0,enableCharging:!0,enableSNGIcons:!1,enableCreateSaypage:!0,use_configured_search:!0,browse_text:"Search",priceDisplay:"min",appointment_cutoff_time_mins:20,end_appointment_on_callend:!0,show_participants_in_muc:!1,callersqueues:!0,showOfflineCallRoomOwner:!1,slot_mins:15,max_slots_allowed:8,appointment_slot_text:"Appointment slots are 15 mins, but you can select consecutive slots if you would like to book a longer appointment.",appointment_slot_error_text:"Only continuous slots can be selected with a maximum of 2 hours",use_slots_mins_from_settings:!0,enableSelfAppointment:!0,wb_share_supported_formats:"all",show_noThanks_button:!0},tcqtriangle_config={partner:"home",partnerPaymentPreference:"PostPay",zapps:["event","schedule","appointment_book","profile"],enableEarnings:!0,enableRecording:!0,enableCharging:!0,enableSNGIcons:!1,enableCreateSaypage:!0,use_configured_search:!0,browse_text:"Search",priceDisplay:"min",appointment_cutoff_time_mins:20,end_appointment_on_callend:!0,show_participants_in_muc:!1,callersqueues:!0,showOfflineCallRoomOwner:!1,slot_mins:15,max_slots_allowed:8,appointment_slot_text:"Appointment slots are 15 mins, but you can select consecutive slots if you would like to book a longer appointment.",appointment_slot_error_text:"Only continuous slots can be selected with a maximum of 2 hours",use_slots_mins_from_settings:!0,enableSelfAppointment:!0,wb_share_supported_formats:"all",show_noThanks_button:!0},freshfields_config={partner:"home",partnerPaymentPreference:"PostPay",zapps:["event","schedule","appointment_book","profile"],enableEarnings:!0,enableRecording:!0,enableCharging:!0,enableSNGIcons:!1,enableCreateSaypage:!0,use_configured_search:!0,browse_text:"Search",priceDisplay:"min",appointment_cutoff_time_mins:20,end_appointment_on_callend:!0,show_participants_in_muc:!1,callersqueues:!0,showOfflineCallRoomOwner:!1,slot_mins:15,max_slots_allowed:8,appointment_slot_text:"Appointment slots are 15 mins, but you can select consecutive slots if you would like to book a longer appointment.",appointment_slot_error_text:"Only continuous slots can be selected with a maximum of 2 hours",use_slots_mins_from_settings:!0,enableSelfAppointment:!0,wb_share_supported_formats:"all",show_noThanks_button:!0},vodafone_config={partner:"home",partnerPaymentPreference:"PostPay",zapps:["event","schedule","appointment_book","profile"],enableEarnings:!0,enableRecording:!0,enableCharging:!0,enableSNGIcons:!1,enableCreateSaypage:!0,use_configured_search:!0,browse_text:"Search",priceDisplay:"min",appointment_cutoff_time_mins:20,end_appointment_on_callend:!0,show_participants_in_muc:!1,callersqueues:!0,showOfflineCallRoomOwner:!1,slot_mins:15,max_slots_allowed:8,appointment_slot_text:"Appointment slots are 15 mins, but you can select consecutive slots if you would like to book a longer appointment.",appointment_slot_error_text:"Only continuous slots can be selected with a maximum of 2 hours",use_slots_mins_from_settings:!0,enableSelfAppointment:!0,wb_share_supported_formats:"all",show_noThanks_button:!0},orange_config={partner:"home",partnerPaymentPreference:"PostPay",zapps:["event","schedule","appointment_book","profile"],enableEarnings:!0,enableRecording:!0,enableCharging:!0,enableSNGIcons:!1,enableCreateSaypage:!0,use_configured_search:!0,browse_text:"Search",priceDisplay:"min",appointment_cutoff_time_mins:20,end_appointment_on_callend:!0,show_participants_in_muc:!1,callersqueues:!0,showOfflineCallRoomOwner:!1,slot_mins:15,max_slots_allowed:8,appointment_slot_text:"Appointment slots are 15 mins, but you can select consecutive slots if you would like to book a longer appointment.",appointment_slot_error_text:"Only continuous slots can be selected with a maximum of 2 hours",use_slots_mins_from_settings:!0,enableSelfAppointment:!0,wb_share_supported_formats:"all",show_noThanks_button:!0},ing_config={partner:"home",partnerPaymentPreference:"PostPay",zapps:["event","schedule","appointment_book","profile"],enableEarnings:!0,enableRecording:!0,enableCharging:!0,enableSNGIcons:!1,enableCreateSaypage:!0,use_configured_search:!0,browse_text:"Search",priceDisplay:"min",appointment_cutoff_time_mins:20,end_appointment_on_callend:!0,show_participants_in_muc:!1,callersqueues:!0,showOfflineCallRoomOwner:!1,slot_mins:15,max_slots_allowed:8,appointment_slot_text:"Appointment slots are 15 mins, but you can select consecutive slots if you would like to book a longer appointment.",appointment_slot_error_text:"Only continuous slots can be selected with a maximum of 2 hours",use_slots_mins_from_settings:!0,enableSelfAppointment:!0,wb_share_supported_formats:"all",show_noThanks_button:!0},intercall_usa_config={partner:"home",partnerPaymentPreference:"PostPay",zapps:["event","schedule","appointment_book","profile"],enableEarnings:!0,enableRecording:!0,enableCharging:!0,enableSNGIcons:!1,enableCreateSaypage:!0,use_configured_search:!0,browse_text:"Search",priceDisplay:"min",appointment_cutoff_time_mins:20,end_appointment_on_callend:!0,show_participants_in_muc:!1,callersqueues:!0,showOfflineCallRoomOwner:!1,slot_mins:15,max_slots_allowed:8,appointment_slot_text:"Appointment slots are 15 mins, but you can select consecutive slots if you would like to book a longer appointment.",appointment_slot_error_text:"Only continuous slots can be selected with a maximum of 2 hours",use_slots_mins_from_settings:!0,enableSelfAppointment:!0,wb_share_supported_formats:"all",show_noThanks_button:!0},nerdforum_config={partner:"home",partnerPaymentPreference:"PostPay",zapps:["event","schedule","appointment_book","profile"],enableEarnings:!0,enableRecording:!0,enableCharging:!0,enableSNGIcons:!1,enableCreateSaypage:!0,use_configured_search:!0,browse_text:"Search",priceDisplay:"min",appointment_cutoff_time_mins:20,end_appointment_on_callend:!0,show_participants_in_muc:!1,callersqueues:!0,showOfflineCallRoomOwner:!1,slot_mins:15,max_slots_allowed:8,appointment_slot_text:"Appointment slots are 15 mins, but you can select consecutive slots if you would like to book a longer appointment.",appointment_slot_error_text:"Only continuous slots can be selected with a maximum of 2 hours",use_slots_mins_from_settings:!0,enableSelfAppointment:!0,wb_share_supported_formats:"all",show_noThanks_button:!0},bloggeek_config={partner:"home",partnerPaymentPreference:"PostPay",zapps:["event","schedule","appointment_book","profile"],enableEarnings:!0,enableRecording:!0,enableCharging:!0,enableSNGIcons:!1,enableCreateSaypage:!0,use_configured_search:!0,browse_text:"Search",priceDisplay:"min",appointment_cutoff_time_mins:20,end_appointment_on_callend:!0,show_participants_in_muc:!1,callersqueues:!0,showOfflineCallRoomOwner:!1,slot_mins:15,max_slots_allowed:8,appointment_slot_text:"Appointment slots are 15 mins, but you can select consecutive slots if you would like to book a longer appointment.",appointment_slot_error_text:"Only continuous slots can be selected with a maximum of 2 hours",use_slots_mins_from_settings:!0,enableSelfAppointment:!0,wb_share_supported_formats:"all",show_noThanks_button:!0},acision_config={partner:"home",partnerPaymentPreference:"PostPay",zapps:["event","schedule","appointment_book","profile"],enableEarnings:!0,enableRecording:!0,enableCharging:!0,enableSNGIcons:!1,enableCreateSaypage:!0,use_configured_search:!0,browse_text:"Search",priceDisplay:"min",appointment_cutoff_time_mins:20,end_appointment_on_callend:!0,show_participants_in_muc:!1,callersqueues:!0,showOfflineCallRoomOwner:!1,slot_mins:15,max_slots_allowed:8,appointment_slot_text:"Appointment slots are 15 mins, but you can select consecutive slots if you would like to book a longer appointment.",appointment_slot_error_text:"Only continuous slots can be selected with a maximum of 2 hours",use_slots_mins_from_settings:!0,enableSelfAppointment:!0,wb_share_supported_formats:"all",show_noThanks_button:!0},dimensiondata_config={partner:"home",partnerPaymentPreference:"PostPay",zapps:["event","schedule","appointment_book","profile"],enableEarnings:!0,enableRecording:!0,enableCharging:!0,enableSNGIcons:!1,enableCreateSaypage:!0,use_configured_search:!0,browse_text:"Search",priceDisplay:"min",appointment_cutoff_time_mins:20,end_appointment_on_callend:!0,show_participants_in_muc:!1,callersqueues:!0,showOfflineCallRoomOwner:!1,slot_mins:15,max_slots_allowed:8,appointment_slot_text:"Appointment slots are 15 mins, but you can select consecutive slots if you would like to book a longer appointment.",appointment_slot_error_text:"Only continuous slots can be selected with a maximum of 2 hours",use_slots_mins_from_settings:!0,enableSelfAppointment:!0,wb_share_supported_formats:"all",show_noThanks_button:!0},cooler_config={partner:"home",partnerPaymentPreference:"PostPay",zapps:["event","schedule","appointment_book","profile"],enableEarnings:!0,enableRecording:!0,enableCharging:!0,enableSNGIcons:!1,enableCreateSaypage:!0,use_configured_search:!0,browse_text:"Search",priceDisplay:"min",appointment_cutoff_time_mins:20,end_appointment_on_callend:!0,show_participants_in_muc:!1,callersqueues:!0,showOfflineCallRoomOwner:!1,slot_mins:15,max_slots_allowed:8,appointment_slot_text:"Appointment slots are 15 mins, but you can select consecutive slots if you would like to book a longer appointment.",appointment_slot_error_text:"Only continuous slots can be selected with a maximum of 2 hours",use_slots_mins_from_settings:!0,enableSelfAppointment:!0,wb_share_supported_formats:"all",show_noThanks_button:!0},swedbank_config={library_add_file_label:"Add Document To Library",library_show_top_level:!0,library_block_upload_to_root:!0,users_may_point:!0,showAddToMUC:!1,alert_no_manual_promote:!1,rv_warn_when_alone:!0,user_hide_upload:!0,ignore_load_queue_event:"left_frame_open_library_tab_2",schedule_go_to_meeting:!0},myvirtualexam_config={enableSelfAppointmentWithAgents:!0,enableRecording:!1},docobo_config={partner:"nhs",enterProfileLink:"Enter Clinician Code",enterProfileLinkDesk:"If you have been provided with the ID of an NHS staff member who does not appear in your list of connections but you would like to add them, please enter the ID here to retrieve their profile page. You will find a button on their profile page to add them to your connections.",agentLeaveNotes:!1,settings_contact_details:!1,userAddToCall:!1,userCancelAppointment:!1,enableRecording:!1,enableCreateSaypage:!1,disableUserAppointment:!0,disableForumButton:!0,disableUserAddPerson:!0,disableSignUp:!0,hideShare:!0,is_search_home:!0,hideCatsOrAgents:!0,forceUserToHaveBooking:!0,showSMSReminders:!0,showReviews:!1,showWall:!1,enableCharging:!1,langOnEvents:!1,catOnEvents:!1,showAccountDetails:!1,search_strip_class:"search_strip_nhs",default_home_page_index:"3",browse_text:"Search",default_home_page:"contact",end_appointment_on_callend:!1,offerAppointmentBookerOptionToGetConfirmation:!0,callersqueues:!0,createInstantEventTitle:"Instant Meeting",createPublicEventTitle:"Public Meeting",createPrivateEventTitle:"Private Meeting",has_call_share_screen:!1,enableSelfAppointmentWithAgents:!0},goinstant_config={partner:"home",partnerPaymentPreference:"PostPay",zapps:["event","schedule","appointment_book","profile"],enableEarnings:!0,enableRecording:!0,enableCharging:!0,enableSNGIcons:!1,enableCreateSaypage:!0,use_configured_search:!0,browse_text:"Search",priceDisplay:"min",appointment_cutoff_time_mins:20,end_appointment_on_callend:!0,show_participants_in_muc:!1,callersqueues:!0,showOfflineCallRoomOwner:!1,slot_mins:15,max_slots_allowed:8,appointment_slot_text:"Appointment slots are 15 mins, but you can select consecutive slots if you would like to book a longer appointment.",appointment_slot_error_text:"Only continuous slots can be selected with a maximum of 2 hours",use_slots_mins_from_settings:!0,enableSelfAppointment:!0,wb_share_supported_formats:"all",show_noThanks_button:!0},jobmatch_config={partner:"home",partnerPaymentPreference:"PostPay",zapps:["event","schedule","appointment_book","profile"],enableEarnings:!0,enableRecording:!0,enableCharging:!0,enableSNGIcons:!1,enableCreateSaypage:!0,use_configured_search:!0,browse_text:"Search",priceDisplay:"min",appointment_cutoff_time_mins:20,end_appointment_on_callend:!0,show_participants_in_muc:!1,callersqueues:!0,showOfflineCallRoomOwner:!1,slot_mins:15,max_slots_allowed:8,appointment_slot_text:"Appointment slots are 15 mins, but you can select consecutive slots if you would like to book a longer appointment.",appointment_slot_error_text:"Only continuous slots can be selected with a maximum of 2 hours",use_slots_mins_from_settings:!0,enableSelfAppointment:!0,wb_share_supported_formats:"all",show_noThanks_button:!0},livingitup_config={partner:"home",partnerPaymentPreference:"PostPay",zapps:["event","schedule","appointment_book","profile"],enableEarnings:!0,enableRecording:!0,enableCharging:!0,enableSNGIcons:!1,enableCreateSaypage:!0,use_configured_search:!0,browse_text:"Search",priceDisplay:"min",appointment_cutoff_time_mins:20,end_appointment_on_callend:!0,show_participants_in_muc:!1,callersqueues:!0,showOfflineCallRoomOwner:!1,slot_mins:15,max_slots_allowed:8,appointment_slot_text:"Appointment slots are 15 mins, but you can select consecutive slots if you would like to book a longer appointment.",appointment_slot_error_text:"Only continuous slots can be selected with a maximum of 2 hours",use_slots_mins_from_settings:!0,enableSelfAppointment:!0,wb_share_supported_formats:"all",show_noThanks_button:!0},pa4aday_config={requireHashtag:!0,enableCharging:!1},teammanila_config={requireHashtag:!0,enableCharging:!1},playmyway_config={requireHashtag:!0,enableCharging:!1},dream_config={requireHashtag:!0,enableCharging:!1},retainerexample_config={requireHashtag:!0,enableCharging:!1},customexample_config={requireHashtag:!0,enableCharging:!1},camference_config={partner:"home",partnerPaymentPreference:"PostPay",zapps:["event","schedule","appointment_book","profile"],enableEarnings:!1,enableRecording:!0,enableCharging:!1,enableSNGIcons:!1,enableCreateSaypage:!0,use_configured_search:!0,browse_text:"Search",priceDisplay:"min",appointment_cutoff_time_mins:20,end_appointment_on_callend:!0,show_participants_in_muc:!1,callersqueues:!0,showOfflineCallRoomOwner:!1,slot_mins:15,max_slots_allowed:8,appointment_slot_text:"Appointment slots are 15 mins, but you can select consecutive slots if you would like to book a longer appointment.",appointment_slot_error_text:"Only continuous slots can be selected with a maximum of 2 hours",use_slots_mins_from_settings:!0,enableSelfAppointment:!0,wb_share_supported_formats:"all",show_noThanks_button:!0,enabledAllBilling:!1,enableSelfAppointmentWithAgents:!0,join_event_string:"Join Meeting",display_string_event:"Meeting",profile_events_title:"Meetings",event_string:"Meeting",has_hard_stop:!1},testskjangir122_config={partner:"home",partnerPaymentPreference:"PostPay",zapps:["event","schedule","appointment_book","profile"],enableEarnings:!0,enableRecording:!0,enableCharging:!0,enableSNGIcons:!1,enableCreateSaypage:!0,use_configured_search:!0,browse_text:"Search",priceDisplay:"min",appointment_cutoff_time_mins:20,end_appointment_on_callend:!0,show_participants_in_muc:!1,callersqueues:!0,showOfflineCallRoomOwner:!1,slot_mins:15,max_slots_allowed:8,appointment_slot_text:"Appointment slots are 15 mins, but you can select consecutive slots if you would like to book a longer appointment.",appointment_slot_error_text:"Only continuous slots can be selected with a maximum of 2 hours",use_slots_mins_from_settings:!0,enableSelfAppointment:!0,wb_share_supported_formats:"all",show_noThanks_button:!0},cellcom_config={partner:"home",partnerPaymentPreference:"PostPay",zapps:["event","schedule","appointment_book","profile"],enableEarnings:!1,enableRecording:!0,enableCharging:!1,enableSNGIcons:!1,enableCreateSaypage:!0,use_configured_search:!0,browse_text:"Search",priceDisplay:"min",appointment_cutoff_time_mins:20,end_appointment_on_callend:!0,show_participants_in_muc:!1,callersqueues:!0,showOfflineCallRoomOwner:!1,slot_mins:15,max_slots_allowed:8,appointment_slot_text:"Appointment slots are 15 mins, but you can select consecutive slots if you would like to book a longer appointment.",appointment_slot_error_text:"Only continuous slots can be selected with a maximum of 2 hours",use_slots_mins_from_settings:!0,enableSelfAppointment:!0,wb_share_supported_formats:"all",show_noThanks_button:!0,enabledAllBilling:!1,enableSelfAppointmentWithAgents:!0,join_event_string:"Join Meeting",display_string_event:"Meeting",profile_events_title:"Meetings",event_string:"Meeting",has_hard_stop:!1},testjan_config={partner:"home",partnerPaymentPreference:"PostPay",zapps:["event","schedule","appointment_book","profile"],enableEarnings:!1,enableRecording:!0,enableCharging:!1,enableSNGIcons:!1,enableCreateSaypage:!0,use_configured_search:!0,browse_text:"Search",priceDisplay:"min",appointment_cutoff_time_mins:20,end_appointment_on_callend:!0,show_participants_in_muc:!1,callersqueues:!0,showOfflineCallRoomOwner:!1,slot_mins:15,max_slots_allowed:8,appointment_slot_text:"Appointment slots are 15 mins, but you can select consecutive slots if you would like to book a longer appointment.",appointment_slot_error_text:"Only continuous slots can be selected with a maximum of 2 hours",use_slots_mins_from_settings:!0,enableSelfAppointment:!0,wb_share_supported_formats:"all",show_noThanks_button:!0,enabledAllBilling:!1,enableSelfAppointmentWithAgents:!0,join_event_string:"Join Meeting",display_string_event:"Meeting",profile_events_title:"Meetings",event_string:"Meeting",
has_hard_stop:!1},ukita_config={partner:"home",partnerPaymentPreference:"PostPay",zapps:["event","schedule","appointment_book","profile"],enableEarnings:!1,enableRecording:!0,enableCharging:!1,enableSNGIcons:!1,enableCreateSaypage:!0,use_configured_search:!0,browse_text:"Search",priceDisplay:"min",appointment_cutoff_time_mins:20,end_appointment_on_callend:!0,show_participants_in_muc:!1,callersqueues:!0,showOfflineCallRoomOwner:!1,slot_mins:15,max_slots_allowed:8,appointment_slot_text:"Appointment slots are 15 mins, but you can select consecutive slots if you would like to book a longer appointment.",appointment_slot_error_text:"Only continuous slots can be selected with a maximum of 2 hours",use_slots_mins_from_settings:!0,enableSelfAppointment:!0,wb_share_supported_formats:"all",show_noThanks_button:!0,enabledAllBilling:!1,enableSelfAppointmentWithAgents:!0,join_event_string:"Join Meeting",display_string_event:"Meeting",profile_events_title:"Meetings",event_string:"Meeting",has_hard_stop:!1},ZLocale={uploadAction:"/servlet/com.requestec.smg.servlets.FileTransfer",supportedFormatsForLibraryUploads:".png, .jpg, .mov",lang_state_name:{waiting:"available",busy:"busy",away:"away",disconnected:"Offline",away:"away"},lang_state_name_saypage:{waiting:"Online",broadcasting:"Broadcasting",busy:"Busy",away:"Away",disconnected:"Offline"},lang_state_name_p2d:{waiting:"Online",disconnected:"Offline",appointment:"Appointment"},lang_state_name_voixio:{waiting:"Online",busy:"Busy",away:"Away",disconnected:"Offline"},lang_state_image_saypage:{waiting:"zen_online.png",busy:"zen_busy.png",away:"zen_away.png",disconnected:"zen_offline.png",appointment:"zen_appointment.png",broadcasting:"zen_broadcasting.png"},state_display:function(a){return 0==ConnectionManager.partner.indexOf("psychictoday")?ZLocale.lang_state_name_p2d[a]?ZLocale.lang_state_name_p2d[a]:a:ZLocale.lang_state_name[a]?ZLocale.lang_state_name[a]:a},getString:function(a,b,c,d){var e=c?c:UserModel&&""!=UserModel.locale?UserModel.locale:""!=DataStore.getUserData("locale")?DataStore.getUserData("locale"):"default";if("default"==e||"undefined"==e||null==e||"null"==e||""==e){var f=Z.zjs.ZLocale.getCookie("locale."+ConnectionManager.service);null!=f&&""!=f&&"null"!=f&&"undefined"!=f&&(e=f,Z.zjs.UserModel.set_locale(e))}if("undefined"!=e&&null!=e&&"null"!=e&&""!=e||(e="default"),"test"==e)return a;var d=d?d:ConnectionManager.partner,g=Z.zjs,h=g[d+"_"+e+"_message"],i=h?h[a]:null;return i||(h=g[d+"_default_message"],i=h&&h[a]?h[a]:null),i||(h=g["home_"+e+"_message"],i=h&&h[a]?h[a]:null),i||(h=g.home_default_message,i=h&&h[a]?h[a]:b?b:a),i},getCookie:function(a){for(var b=a+"=",c=document.cookie.split(";"),d=0;d<c.length;d++){for(var e=c[d];" "==e.charAt(0);)e=e.substring(1);if(e.indexOf(b)!=-1)return e.substring(b.length,e.length)}return""}},home_default_message={comments_title:"Wall",host_title:"Hosts",host_not_found:"Coming soon",all_host_button_text:"All Profiles",settings_balance_lable:"Balance",settings_topUp_lable:"Top Up",settings_additional_details:"Additional Details",profile_videoCall_tab_text:"Video Call",profile_voiceCall_tab_text:"Voice Call",settings_create_saypage_label:"Create Profile",event_not_found:"No Meetings Available",new_version_minor_string:"Update App Now",new_version_major_string:"Upgrade App Now",no_network:"Please check your connection.",no_network_title:"No Internet",browse_text:"Search",join_event_string:"Join Meeting",event_string:"Meeting",connection_small:"contact",connection_cap:"Contact",onnections_small:"contacts",connections_cap:"Contacts",remove_user_from_bridge:"Do you want to remove this Participant from call?",display_string_event:"Meeting",profile_events_title:"Meetings"},kuvu_default_message={comments_title:"Wall",host_title:"Tutors",host_not_found:"Coming soon",all_host_button_text:"All Tutors",settings_balance_lable:"Balance",settings_topUp_lable:"Top Up",settings_additional_details:"Additional Details",profile_videoCall_tab_text:"Video Call",profile_voiceCall_tab_text:"Voice Call",settings_create_saypage_label:"Become a Tutor",event_not_found:"No Seminars Available",profile_events_title:"Seminars"},home_pt_BR_message={comments_title:"Comments-pt_BR"},psychictoday_default_message={comments_title:"Testimonials",host_title:"Readers",host_not_found:"No Readers found",all_host_button_text:"All Readers",settings_balance_lable:"Credit",settings_topUp_lable:"Add Funds",settings_additional_details:"Additional Details",profile_videoCall_tab_text:"Live Video Chat",profile_voiceCall_tab_text:"Live Voice Chat",settings_create_saypage_label:"Become Psychic"},psychictoday_pt_BR_message={comments_title:"Testimonials-pt_BR"},byttuition_default_message={event_not_found:"No Seminars Available"},medtronic_default_message={appointment_label:"Session",no_appointment_label:"No Sessions",appointment_booking_confirm_message:"The session can been seen in your Schedule. You will receive session confirmation and reminders via email. You are now free to leave this session.",holiday_booking_heading:"Availabillity Blocked",holiday_booking_message:"Your availability has been blocked"},cloudroom_default_message={profile_events_title:"Rooms",join_event_string:"Enter Room",event_string:"Room"},talkpoint_default_message={sharing_library_error_message:"This option is only available when connected.",remove_user_from_bridge:"Do you want to remove this Participant from Bridge?",input_length_exceeds:"Input too long. Maximux 64 chars are allowed",invalid_input_chars:"Invalid Characters. Must be english characters only"},henryford_default_message={appointment_label:"Session",no_appointment_label:"No Sessions",appointment_booking_confirm_message:"The session can been seen in your Schedule. You will receive session confirmation and reminders via email. You are now free to leave this session."},ZLocaleDialog={getTitle:function(a,b,c,d){a="title_"+a;var e=c?c:UserModel&&""!=UserModel.locale?UserModel.locale:""!=DataStore.getUserData("locale")?DataStore.getUserData("locale"):"default",d=d?d:ConnectionManager.partner,f=Z.zjs,g=f[d+"_"+e+"_dialog_message"],h=g?g[a]:null;return h||(g=f[d+"_dialog_default_message"],h=g&&g[a]?g[a]:null),h||(g=f["home_"+e+"_dialog_message"],h=g&&g[a]?g[a]:null),h||(g=f.home_default_dialog_message,h=g&&g[a]?g[a]:b?b:a),h},getMessage:function(a,b,c,d){a="message_"+a;var e=c?c:UserModel&&""!=UserModel.locale?UserModel.locale:""!=DataStore.getUserData("locale")?DataStore.getUserData("locale"):"default",d=d?d:ConnectionManager.partner,f=Z.zjs,g=f[d+"_"+e+"_dialog_message"],h=g?g[a]:null;return h||(g=f[d+"_default_dialog_message"],h=g&&g[a]?g[a]:null),h||(g=f["home_"+e+"_dialog_message"],h=g&&g[a]?g[a]:null),h||(g=f.home_default_dialog_message,h=g&&g[a]?g[a]:b?b:a),h}},home_default_dialog_message={title_error_121:"error121_title",message_error_121:"errer121 message"},home_pt_BR_dialog_message={title_error_121:"pt_br error121_title",message_error_121:"pt_br errer121 message"};(function(){window.zapps&&0!=window.zapps.length||(window.zapps=[])})()!=-1&&(window.Z=function(){var zappFW={};zappFW.retryCount=0,zappFW.zjs=window,zappFW.ie8=navigator.userAgent.indexOf("MSIE 8")>-1,zappFW.tryAgainStr="<br><a class='general_button' onclick='Z.jqm.retry();return false;'>Try Again</a><br>",zappFW.showDetails="<br><a class='general_button show_details_button' onclick='Z.jqm.showDetails(); return false;'>Show Details</a><br>",zappFW.showDetailsWithReload="<br><a class='general_button show_details_button' onclick='Z.jqm.showDetailsWithReload();return false;'>Show Details</a><br>",zappFW.hideDetails="<br><a onclick='Z.jqm.hideDetails(); return false;'class='general_button hide_details_button' >Hide Details</a><br>",zappFW.errorImg="<img class='error_triangle' src='./assets/images/error_triangle.png'/><br>",zappFW.zapps=zapps.slice();try{zappFW.zjs=window,zappFW.randomStr=zappFW.zjs.isSayPageApp?"?v=3.3":""}catch(e){try{zappFW.zjs=top,zappFW.randomStr=zappFW.zjs.isSayPageApp?"?v=3.3":""}catch(e){zappFW.zjs=parent,zappFW.randomStr=zappFW.zjs.isSayPageApp?"?v=3.3":""}}window.zapps_path?zappFW.rootPath=window.zapps_path:(zappFW.rootPath=window.rootPath||"/"+window.location.href.split("?")[0].split("/").slice(3,-1).join("/"),"/"!=zappFW.rootPath.substr(-1)&&(zappFW.rootPath+="/")),zappFW.getZBody=function(){return document.zbody?document.zbody:window.zbody?window.zbody:window},zappFW.getZAppController=function(a){return window[a+"Controller"]};for(var i=0;i<zappFW.zapps.length;i++)document.write("<script type='text/javascript' src='"+zappFW.rootPath+"zapps/"+zappFW.zapps[i]+"/controller.js"+zappFW.randomStr+"'></script>");return"undefined"!=typeof loader_id&&""!=loader_id?zappFW.listener_scope=loader_id:"undefined"!=typeof zappFW.zapps&&zappFW.zapps.length>0?zappFW.listener_scope=zappFW.zapps[0]:zappFW.listener_scope="listener_scope_default",zappFW.cache={SIZE:-1,fetch:function(a,b){var c=zappFW.cache[a]&&zappFW.cache[a][b]?zappFW.cache[a][b]:null;return c&&(c.fetchCount=c.fetchCount||0,c.fetchCount++),c},add:function(a,b,c,d){200!=d&&(c="");var e=function(a){if(!(a<=0)){var b,c,d=[];for(b in zappFW.cache)for(c in zappFW.cache[b])d.push(zappFW.cache[b][c]);if(0!=d.length){d.sort(function(a,b){return(b.fetchCount||0)-(a.fetchCount||0)||a.template.length-b.template.length});for(var e,f=0;d.length>0&&a>f;)e=d.pop(),zappFW.cache.remove(e.zapp,e.action),f+=e.template.length}}},f=zappFW.cache.fetch(a,b);f?(f.template=c,f.status=d):(zappFW.cache.SIZE>0&&e(c.length),zappFW.cache[a]=zappFW.cache[a]||{},zappFW.cache[a][b]={zapp:a,action:b,template:c,status:d})},remove:function(a,b){var c=zappFW.cache[a]&&zappFW.cache[a][b]?zappFW.cache[a][b]:null;if(c){delete zappFW.cache[a][b];for(var d in zappFW.cache[a])return c;return delete zappFW.cache[a],c}}},zappFW.evaluateTemplate=function(___template,params){var enclosures=[];___template.replace(/<%(={0,1})\s*([\S\s]*?)\s*%>/g,function(a,b,c,d){return enclosures.push({type:b,data:c,start:d,end:d+a.length,match:a}),""});for(var ___templateScript=['var ___response = "";'],begIndex=0,i=0;i<enclosures.length;i++)enclosures[i].start>begIndex&&___templateScript.push('___response += "'+___template.substring(begIndex,enclosures[i].start).replace(/"/g,'\\"').replace(/[\r\n]/g,"\\n")+'";'),"="==enclosures[i].type?___templateScript.push("___response += "+enclosures[i].data+"\n"):___templateScript.push(" "+enclosures[i].data+"\n"),begIndex=enclosures[i].end;return begIndex<___template.length&&___templateScript.push('___response += "'+___template.substring(begIndex).replace(/"/g,'\\"').replace(/[\r\n]/g,"\\n")+'";'),___templateScript.push("___response;"),enclosures=begIndex=i=void 0,eval(___templateScript.join(""))},zappFW.ACTION_RESPONSE={AJAX_ERROR:-1,OK:0,REDIRECT_INVALID:1,TEMPLATE_NOT_FOUND:2,TEMPLATE_AND_CONTROL_NOT_FOUND:3,TEMPLATE_SCRIPT_ERROR:4},zappFW.performAction=function(a,b,c,d,e,f,g){if(!a)throw"Could not perform action on undefined ZApp!";if(!b)throw"Could not perform undefined Action on "+a+" ZApp!";var h=zappFW.getZAppController(a);if(d=d||{},h&&h[b+"_redirect"]){var i=h[b+"_redirect"](d);return void(i&&i.action?zappFW.performAction(i.zapp||a,i.action,c,d,e,f,g):e("<div class='error_template_top'>"+zappFW.errorImg+"<h2> A problem has occured.</h2>"+zappFW.tryAgainStr+zappFW.showDetails+"<div class='error_template_details' style='display: none';><div class='white_box'> <h3>Redirect function "+b+"_redirect() in '"+a+"' ZApp did not return a valid redirect Object.</h3><h3>"+b+"_redirect() in "+zappFW.rootPath+"zapps/"+a+"/controller.js should mention the target ZApp Action by returning their identifiers in an Object with 'zapp' (optional) and 'action' properties.</h3></div><br>"+zappFW.hideDetails+"</div></div>",zappFW.ACTION_RESPONSE.REDIRECT_INVALID,a,b))}var j=zappFW.rootPath,k=j+"zapps/"+a+"/"+b+".zat"+zappFW.randomStr,l=function(c,i,j){if(200==i)try{g||(c=zappFW.evaluateTemplate(c,d)),e(c,zappFW.ACTION_RESPONSE.OK,a,b)}catch(l){e("<div class='error_template_top'>"+zappFW.errorImg+"<h2>A problem has occured.</h2>"+zappFW.tryAgainStr+zappFW.showDetails+"<div class='error_template_details' style='display: none';><div class='white_box'><h3>TEMPLATE EXCEPTION - "+l.toString()+"</h3><h3>"+k+"</h3></div><br>"+zappFW.hideDetails+"</div></div>",zappFW.ACTION_RESPONSE.TEMPLATE_SCRIPT_ERROR,a,b)}else h&&h[b]?(404!=i&&"404"!=i||Z.jqm.addConnectionMadeListener(),e("<div class='error_template_top'>"+zappFW.errorImg+(404==i||"404"==i?"<h2>Unable to load page, please check your internet connection</h2>":"<h2>A problem has occurred.</h2>"+zappFW.tryAgainStr)+zappFW.showDetailsWithReload+"<div class='error_template_details' style='display: none';><div class='white_box' ><h3>Template not found (HTTP Error "+i+" ), calling Control for action '"+b+"' in '"+a+"' ZApp.</h3><h3>To change this view, add "+k+" and/or modify view in Control function "+b+"() in "+zappFW.rootPath+"zapps/"+a+"/controller.js</h3><h3>To redirect instead, remove "+b+"() add use "+b+"_redirect()</h3></div><br>"+zappFW.hideDetails+"</div></div>",zappFW.ACTION_RESPONSE.TEMPLATE_NOT_FOUND,a,b)):(404!=i&&"404"!=i||Z.jqm.addConnectionMadeListener(),e("<div class='error_template_top'>"+zappFW.errorImg+(404==i||"404"==i?"<h2>Unable to load page, please check your internet connection</h2>":"<h2>A problem has occurred.</h2>"+zappFW.tryAgainStr)+zappFW.showDetailsWithReload+"<div class='error_template_details' style='display: none';><div class='white_box' ><h3>Neither template (HTTP Error "+i+" ) nor Control was found for action '"+b+"' in '"+a+"' ZApp.</h3><h3>Add "+k+" and/or Control function "+b+"() in "+zappFW.rootPath+"zapps/"+a+"/controller.js</h3><h3>To redirect instead, add "+b+"_redirect() in the above controller.js</h3></div><br>"+zappFW.hideDetails+"</div></div>",zappFW.ACTION_RESPONSE.TEMPLATE_AND_CONTROL_NOT_FOUND,a,b));j||h&&h[b]&&"function"==typeof h[b]&&(f?h[b].apply(h,[d]):setTimeout(function(){h[b].apply(h,[d])},50))},m=zappFW.cache.fetch(a,b);if(m)l(m.template,m.status,c);else{var n;if(window.XMLHttpRequest){n=new XMLHttpRequest;try{n.overrideMimeType("text/xml")}catch(o){}}else if(window.ActiveXObject)try{n=new ActiveXObject("Msxml2.XMLHTTP")}catch(o){try{n=new ActiveXObject("Microsoft.XMLHTTP")}catch(p){}}if(!n)return void e("<div class='error_template_top'>"+zappFW.errorImg+"<h1>A problem has occurred.</h1>"+zappFW.tryAgainStr+zappFW.showDetails+"<div class='error_template_details' style='display: none';><div class='white_box' ><h3>Unexpected AJAX Error while fetching template for action '"+b+"' in '"+a+"' ZApp!</h3><h3>Could not obtain a proper AJAX Request Object for your browser.</h3><h3>Template: "+k+"</h3></div><br>"+zappFW.hideDetails+"</div></div>",zappFW.ACTION_RESPONSE.AJAX_ERROR,a,b);var q="404";n.onreadystatechange=function(){if("error"!=q&&(2!=n.readyState&&3!=n.readyState||(q="200"),4==n.readyState)){if(q=n.status>0?n.status:q,n.responseText&&""!=n.responseText&&0==n.status&&(q="200"),(500==q||"500"==q)&&zappFW.retryCount<3)return zappFW.retryCount++,void setTimeout(function(){Z.jqm.retry()},100);"200"!=q&&200!=q||zappFW.cache.add(a,b,n.responseText,q),zappFW.retryCount=0,l(n.responseText,q,c)}};try{n.open("GET",k,!0),n.send()}catch(o){q="error",e("<div class='error_template_top'>"+zappFW.errorImg+"<h1>A problem has occurred.</h1>"+zappFW.tryAgainStr+zappFW.showDetails+"<div class='error_template_details' style='display: none';><div class='white_box' ><h3>Unexpected AJAX Error while fetching template for action '"+b+"' in '"+a+"' ZApp!</h3><h3>"+o.toString()+"</h3><h3>Template: "+k+"</h3></div><br>"+zappFW.hideDetails+"</div></div>",zappFW.ACTION_RESPONSE.AJAX_ERROR,a,b)}}},zappFW}());var wsServer={_wsCreationTime:0,_eventSubscribed:!1,connect:function(a,b,c){if(webRTC.log("_connect:"+webRTC._initiated+" "+ConnectionManager.zsState),webRTC._initiated)if(this._roomID=a,this.nextAction=b,zwrtc._disableWS)void 0==this._roomID&&(this._roomID=wsServer._getRoomID()),this._roomID=a,this._wsCreationTime=DateTimeUtil.getNow(),"waiting"==ConnectionManager.zsState||"busy"==ConnectionManager.zsState?(ConnectionManager._dispatchEvent("ZWRTC_P2P_OPEN",{msg:"Create websocket session",creationTime:wsServer._wsCreationTime,roomID:this._roomID}),webRTC.log("P2P:ZWRTC_P2P_OPEN zebra sent")):wsServer.stateCheckTimer=setInterval(function(){"waiting"!=ConnectionManager.zsState&&"busy"!=ConnectionManager.zsState||(wsServer.stateCheckTimer&&clearInterval(wsServer.stateCheckTimer),ConnectionManager._dispatchEvent("ZWRTC_P2P_OPEN",{msg:"Create websocket session",creationTime:wsServer._wsCreationTime,roomID:this._roomID}),webRTC.log("P2P:ZWRTC_P2P_OPEN zebra sent"))},500),this._eventSubscribed?webRTC.log("P2P:Events already subscribed, donot subscribe again"):(this._eventSubscribed=!0,webRTC.log("P2P:Subscribing to events"),ConnectionManager.addListener("ZWRTC_P2P_ON_OPEN",this,function(a){webRTC.log("P2P:ZWRTC_P2P_ON_OPEN"),wsServer._onopen(),0==webRTC.wrtcPeerArray.length&&CallManager._dispatchEvent(CallManager.Event.CONNECTED,{type:"p2p"})}),ConnectionManager.addListener("ZWRTC_P2P_ON_MESSAGE",this,function(a){webRTC.log("P2P:ZWRTC_P2P_ON_MESSAGE"),a.zebra?webRTC.processSignalingZebra(a.zebra):wsServer._onmessage(a)}),ConnectionManager.addListener("ZWRTC_P2P_ON_CLOSE",this,function(a){webRTC.log("P2P:ZWRTC_P2P_ON_CLOSE"),webRTC.stop(),wsServer._onclose()}));else{var d=document.location.protocol,e=document.location.hostname;c&&(e=c),webRTC.log("protocol"+d+" "+this.nextAction),webRTC.log("hostname"+e);var f="ws://";"https:"==d&&(f="wss://");var g=f+e+"/webrtc/";webRTC.log(g);try{this._ws?(webRTC.log("this._ws.connecting:"+this._ws.connecting),webRTC.log("this._ws.connected:"+this._ws.connected),this._onopen()):(this._ws=new WebSocket(g),this._ws.onopen=this._onopen,this._ws.onmessage=this._onmessage,this._ws.onclose=this._onclose)}catch(h){webRTC.log(h)}}},_getRoomID:function(){if(void 0==this._roomID){var a=DataStore.getUserData("username","");a?ConnectionManager.doBlackboard?this._roomID=a:this._roomID=a+ConnectionManager.service:this._roomID=Math.floor(1e10*Math.random()+1)}return this._roomID},_sendRoomID:function(a){void 0==a&&(a=wsServer._getRoomID()),this._roomID=a,wsServer._send("ROOM:"+this._roomID),webRTC.log("wsServer._send('ROOM:'"+this._roomID+")")},_onopen:function(){webRTC.log("_onOpen"+wsServer.nextAction),wsServer._sendRoomID(),"DO_OFFER"==wsServer.nextAction&&webRTC.doOffer()},_send:function(a,b){zwrtc._disableWS?ConnectionManager._dispatchEvent("ZWRTC_P2P_SEND",{data:b,creationTime:this._wsCreationTime,roomID:this._roomID,subID:a}):this._ws&&this._ws.send("SUBID:"+a+":SUBID"+b)},_onmessage:function(a){webRTC.log("_onMessage:"+a+" "+a.data+" "+a.subID),webRTC.processSignalingMessage(a.subID,a.data)},_onclose:function(a){this._ws=null},send:function(a,b){null!=b&&b.length>0&&wsServer._send(a,b)},close:function(){webRTC.log("this._ws.close()"),zwrtc._disableWS?ConnectionManager._dispatchEvent("ZWRTC_P2P_CLOSE",{msg:"Close websocket session",creationTime:this._wsCreationTime,roomID:this._roomID}):this._ws&&this._ws.close(),this._ws=null,this._roomID=null}},webRTC={MSG_TYPE_OFFER:"offer",MSG_TYPE_ANSWER:"answer",MSG_TYPE_CANDIDATE:"candidate",MSG_TYPE_BYE:"bye",MSG_TYPE_P2P_FAILED:"p2p_failed",MSG_TYPE_PVE:"PEER_VIDEO_ENABLED",MSG_TYPE_PVD:"PEER_VIDEO_DISABLED",MSG_TYPE_RENEGOTIATE:"RENEGOTIATE_OFFER",MSG_TYPE_INIT_AUDIO_RECORDING:"INIT_AUDIO_RECORDING",wrtcPeerArray:[],rvArr:[],stunserver_config:{iceServers:[]},mediaConstraintsAV:{mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0},optional:[{VoiceActivityDetection:!1}]},mediaConstraintsA:{mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!1},optional:[{VoiceActivityDetection:!1}]},sdpConstraintsAV:{optional:[],mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0,MozDontOfferDataChannel:!0}},sdpConstraintsA:{optional:[{VoiceActivityDetection:!1}],mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!1,MozDontOfferDataChannel:!0}},bandwidth:{audio:80,video:700},framerate:{minptime:10,maxptime:60},localVideo:null,localStream:null,mediaSource:null,localVideoStream:null,host:null,_callType:null,resolConstraint:null,isVideoMuted:!1,isAudioMuted:!1,isVideoDisabled:!1,isAudioDisabled:!1,isSSDisabled:!1,autoCall:!1,firstMediaAccess:!0,nextState:null,webrtcDetectedBrowser:null,_chrome:!1,accessingMediaStreams:!1,_callGoingOn:!1,_mediaAccessGranted:!1,failoverToFlash:!0,_hangupByPeer:!1,disableWebrtcTickleIce:!1,batchCandidates:!0,batchCandidateLimit:4,_initiated:!1,plThreshold:100,initWebRTC:function(a,b,c,d,e,f){this._initiated=!0,this.localVideo=b,this.host=f,this.autoCall=d,this.rvArr=c,this.resolConstraint=e,zwrtc._disableWS?ConnectionManager._dispatchEvent("ZWRTC_P2P_INITIALIZED",{msg_string:"ZWRTC p2p lib initialized"}):this.connectWS(a),webRTC.localStream||zwrtc.viewOnly?this.onUserMediaSuccess(webRTC.localStream):this.accessMedia(e),ConnectionManager.addListener("ZWRTC_P2P_RENEGOTIATE",this,function(a){a&&a.rstream&&(webRTC.localStream=a.rstream,webRTC.renegotiate())}),ConnectionManager.addListener("SS_STREAM_ACCESSED",this,this.placeSSCall),ConnectionManager.addListener("SS_STREAM_CLOSED",this,this.endSSCall),ConnectionManager.addListener("INIT_AUDIO_RECORDING_CALL",this,this.audioRecordingInitiated),ConnectionManager.addListener("PEER_INITIATED_AUDIO_RECORDING",this,this.peerInitiatedAudioRecording),ConnectionManager.addListener("MCU_AUDIO_RECORDING_STARTED",this,this.audioRecordingStarted),ConnectionManager.addListener("MCU_AUDIO_RECORDING_STOPPED",this,this.audioRecordingStoped),ConnectionManager.addListener("MUTE_MIC_TILL_RECORDING_STARTS",this,this.peerInitiatedAudioRecording)},peerInitiatedAudioRecording:function(a){CallManager._recordP2PAudio&&(CallManager._recordP2P=!0),webRTC.doMuteTillRecording()},audioRecordingStarted:function(a){CallManager._p2pRecordingLive=!0,this.doUnMute()},audioRecordingStoped:function(a){CallManager._p2pRecordingLive=!1,this.doMuteTillRecording()},audioRecordingInitiated:function(a){this.peerInitiatedAudioRecording();for(var b=0;b<this.wrtcPeerArray.length;b++){var c=this.wrtcPeerArray[b];c&&c.audioRecordingInitiated()}},placeSSCall:function(a){for(var b=!1,c=0;c<this.wrtcPeerArray.length;c++){var d=this.wrtcPeerArray[c];d&&(b=!0,d.placeSSCall())}b&&ConnectionManager._dispatchEvent("REMOTE_STREAM_ATTACHED_SCREEN")},endSSCall:function(){for(var a=0;a<this.wrtcPeerArray.length;a++){var b=this.wrtcPeerArray[a];b&&b.endSSCall()}},terminateConf:function(){this.wrtcPeerArray.length>1&&(Platform.showMessageX("Warning","Terminating conference due to network issues",!0),CallManager.endCall())},startBitrateInfo:function(){if(!this.brInfoRunning){this.brInfoRunning=!0;var a=this;this.brInfoTimer=setInterval(function(){for(var b=0,c=0,d=0,e=0,f="",g=0;g<a.wrtcPeerArray.length;g++){var h=a.wrtcPeerArray[g];h&&(f+=g+":Recv BR:"+h.recvdBitrate+"Kbps<br>",f+=g+":Sent BR:"+h.sentBitrate+"Kbps<br>",h.peerConnection&&(f+=g+":ICE:"+h.peerConnection.iceConnectionState+"<br>"),b+=h.plps,c+=h.prps,d+=h.recvdBitrate,e+=h.sentBitrate)}var i=0;if(c>0&&(i=Math.round(b/c*100),i>=a.plThreshold&&a.terminateConf()),webRTC.localVideo){f+="Total PLoss:"+b+"/s<br>Total PRecvd:"+c+"/s<br>%PLoss    :"+i+"%<br>",f+="Total Recv BR:"+d+"Kbps<br>Total Send BR:"+e+"Kbps<br>",f+="PL Threshold:"+a.plThreshold+"%";var j=$("#"+webRTC.localVideo.id);!zwrtc.tooltipInit&&j.length>0&&(zwrtc.tooltipInit=!0,j.tooltip({content:f,track:!0}),j.attr("title",f),j.mouseover(function(){webRTC.updateTL=!0}),j.mouseout(function(){webRTC.updateTL=!1})),webRTC.updateTL&&j.tooltip("option","content",f)}})}},resize:function(){for(var a=0;a<this.wrtcPeerArray.length;a++){var b=this.wrtcPeerArray[a];b&&b.resize()}},generateCoordinates:function(){var a=zwrtc.cam_width,b=zwrtc.cam_height,c=a-4,d=b,e=1.5,f=1,g=this.wrtcPeerArray.length,h=0,i=3;g<2||(g>=3?(c=Math.floor(a/3-4),h=Math.floor((a-3*c)/2)-2):(c=Math.floor((a-6)/2.1),h=a-2*c-4)),d=Math.round(b/a*c);for(var j=0;j<this.wrtcPeerArray.length;j++){var k=this.wrtcPeerArray[j];if(k){var l=this.rvArr?this.rvArr[0]:null;k.setRV(e,f,c,d,a,b,l)}var m=j+1;m%3==0?(e=1.5,f=f+d+i):e=e+c+h}},createMediaSource:function(){this.audioContext=new AudioContext,this.mediaSource=this.audioContext.createBufferSource(),this.mediaSource.loop=!0,this.remoteDestination=this.audioContext.createMediaStreamDestination(),this.mediaSource.connect(this.remoteDestination)},connectWS:function(a,b,c){this._callType=c,wsServer.connect(a,b,this.host)},extractSdp:function(a,b){var c=a.match(b);return c&&2==c.length?c[1]:null},removeOpusStereo:function(a){if(a=webRTC.setBandwidth(a),zwrtc.maxaveragebitrate>0){a.indexOf("stereo=0")!=-1&&(a=a.replace("stereo=0","stereo=1")),a.indexOf("sprop-stereo=0")!=-1&&(a=a.replace("sprop-stereo=0","sprop-stereo=1"));for(var b=a.split("\r\n"),c=0;c<b.length;c++)if(b[c].search("opus/48000")!==-1){var d=this.extractSdp(b[c],/:(\d+) opus\/48000/i);break}for(var c=0;c<b.length;c++)if(b[c].search("a=fmtp")!==-1){var e=this.extractSdp(b[c],/a=fmtp:(\d+)/);if(e===d){var f=c;break}}if(null===f)return a;b[f]=b[f].concat(" maxaveragebitrate="+zwrtc.maxaveragebitrate),a=b.join("\r\n")}return a},setLV:function(a){this.localVideo=a},accessMedia:function(a){this.resolConstraint=a,null==this.localStream&&this.doGetUserMedia()},getRoomID:function(){return wsServer._getRoomID()},getRemoteStream:function(){for(i=0;i<this.wrtcPeerArray.length;i++){var a=this.wrtcPeerArray[i];if(a.remoteStream)return a.remoteStream}},renegotiate:function(){for(i=0;i<this.wrtcPeerArray.length;i++){var a=this.wrtcPeerArray[i];a&&a.processOffer()}},setBandwidth:function(a){if(navigator.mozGetUserMedia)return a;var b=webRTC.bandwidth;b=b||{},a=a.replace(/b=AS([^\r\n]+\r\n)/g,"");var c=a.indexOf("m=video");if(c!=-1){var d=a.indexOf("\r\nc=",c),e=a.substr(0,d+2),f=a.substr(d+2);a=e+"b=AS:"+(b.video||2048)+"\r\n"+f,a=a.replace(/a=rtpmap:100 VP8\/90000\r\n/g,"a=rtpmap:100 VP8/90000\r\na=fmtp:100 x-google-max-bitrate="+(b.video||2048)+"; x-google-max-quantization=40\r\n")}return a},setFramerate:function(a){return a},accessVideoOnlyMedia:function(a){a&&(a.audio=!1),webRTC.log('Requested access to local media with mediaConstraints:\n  "'+JSON.stringify(a)+'"'),CallManager._flashEnabled||navigator.mediaDevices.getUserMedia(a).then(this.onWebCamSuccess)["catch"](this.onWebCamError)},onWebCamSuccess:function(a){webRTC.localVideoStream=a;try{webRTC.peerConnection&&zwrtc.p2p2mcu&&webRTC.peerConnection.addStream(webRTC.localStream)}catch(b){}ConnectionManager._dispatchEvent("ZWRTC_WEBCAM_ACCESS_GRANTED",{stream:a}),webRTC.log("ZWRTC_WEBCAM_ACCESS_GRANTED")},onWebCamError:function(a){webRTC.log("Failed to get access to local web cam. Error code was "+a.code),webRTC.localVideoStream=null},doGetUserMedia:function(){try{if(!this.accessingMediaStreams){this.accessingMediaStreams=!0;var a={};this._mediaAccessGranted=!1,this.resolConstraint?(ConnectionManager._dispatchEvent("ZWRTC_ACCESSING_MEDIA",{msg_string:'Requested access to local media with mediaConstraints:\n  "'+JSON.stringify(this.resolConstraint)+'"'}),CallManager._flashEnabled||navigator.mediaDevices.getUserMedia(this.resolConstraint).then(this.onUserMediaSuccess)["catch"](this.onUserMediaError),webRTC.log('Requested access to local media with mediaConstraints:\n  "'+JSON.stringify(this.resolConstraint)+'"')):(ConnectionManager._dispatchEvent("ZWRTC_ACCESSING_MEDIA",{msg_string:'Requested access to local media with mediaConstraints:\n  "'+JSON.stringify(a)+'"'}),CallManager._flashEnabled||navigator.mediaDevices.getUserMedia({audio:!0,video:a}).then(this.onUserMediaSuccess)["catch"](this.onUserMediaError),webRTC.log('Requested access to local media with mediaConstraints:\n  "'+JSON.stringify(a)+'"')),this.firstMediaAccess?(this.firstMediaAccess=!1,showAllowGuide()):(showAllowGuide(),showRememberGuide())}}catch(b){webRTC.log("getUserMedia failed with exception: "+b.message)}},isP2PEstablished:function(){for(i=0;i<webRTC.wrtcPeerArray.length;i++){var a=webRTC.wrtcPeerArray[i];if(a&&a.isP2PEstablished())return!0}return!1},checkP2PEstablished:function(){for(i=0;i<webRTC.wrtcPeerArray.length;i++){var a=webRTC.wrtcPeerArray[i];a&&a.checkP2PEstablished()}},onUserMediaSuccess:function(a){webRTC.accessingMediaStreams=!1,webRTC._mediaAccessGranted=!0,webRTC.localStream=a,hideAllowGuide();try{for(i=0;i<webRTC.wrtcPeerArray.length;i++){var b=webRTC.wrtcPeerArray[i];b&&b.onUserMediaSuccess()}var c=webRTC.localStream.getVideoTracks(),d=webRTC.localStream.getAudioTracks();c.length>0&&webRTC.log("Using Video device: "+c[0].label),d.length>0&&webRTC.log("Using Audio device: "+d[0].label)}catch(e){webRTC.log("Error: "+e)}webRTC.log("this.nextState:"+webRTC.nextState),"OFFER"==webRTC.nextState&&webRTC.processOffer();try{webRTC.peerConnection&&(zwrtc.p2p2mcu?webRTC.localVideoStream&&webRTC.peerConnection.addStream(webRTC.localVideoStream):webRTC.peerConnection.addStream(webRTC.localStream))}catch(e){}webRTC.getLowResolCam()},getLowResolCam:function(){if(rtcSFU._useSimulcast&&!CallManager._flashEnabled){var a=wrtcSetting.getMediaConstraints(160,90,160,90,zwrtc.cam_fps,zwrtc.cam_fps_min,zwrtc.videoSourceID,zwrtc.audioSourceID);if(a&&a.video&&a.video.mandatory)return a.audio=!1,void navigator.mediaDevices.getUserMedia(a).then(this.onLowResolMediaSuccess.bind(this))["catch"](this.onLowResolMediaError.bind(this))}ConnectionManager._dispatchEvent("ZWRTC_MEDIA_ACCESS_GRANTED",{stream:webRTC.localStream})},onLowResolMediaSuccess:function(a){rtcSFU.setLowResolStream(a),ConnectionManager._dispatchEvent("ZWRTC_MEDIA_ACCESS_GRANTED",{stream:webRTC.localStream})},onLowResolMediaError:function(a){ConnectionManager._dispatchEvent("ZWRTC_MEDIA_ACCESS_GRANTED",{stream:null})},onUserMediaError:function(a){webRTC._mediaAccessGranted=!0,webRTC.accessingMediaStreams=!1,webRTC.log("Failed to get access to local media. Error code was "+a.code),webRTC.localStream=null,mediaAccessFailed(),ConnectionManager._dispatchEvent("ZWRTC_MEDIA_ACCESS_FAILED",{msg_string:"Failed to get access to local media. Error code was "+a.code})},getZEvent:function(a,b){var c=null;try{c=a.getZEvent(b).value}catch(d){}return c},processSignalingZebra:function(a){if(a){var b=this.getZEvent(a,"type");if("NEW_SUBSCRIBER"==b){var c=this.getZEvent(a,"subID"),d=this.getZEvent(a,"userId");webRTC.log("New connection subscribed to room with sub id:"+c),this.checkAndCreate(c,d)}else if("SUBSCRIBER_LIST"==b){var e=parseInt(this.getZEvent(a,"count")),f=!1;for(i=0;i<e;i++){var g=null,d=null;try{g=this.getZEvent(a,"sub_"+i),d=this.getZEvent(a,"userId_"+i)}catch(h){}g&&(f=!0,this.checkAndCreate(g,d))}f&&this.autoCall?this.doOffer():zwrtc._disableWS||ConnectionManager._dispatchEvent("ZWRTC_P2P_INITIALIZED",{msg_string:"ZWRTC p2p lib initialized"}),webRTC.startP2PTTLTimer()}else if("DATA"==b){var c=this.getZEvent(a,"subID"),j=this.getZEvent(a,"data");j=j.replace("<![CDATA[","").replace("]]>","");var k=window.atob(j).replace(/\s/g,""),l=window.atob(k),m=this.getPeerObject(c);m&&m.processSignalingMessage(l)}else{var j=this.getZEvent(a,"data");j?(j=j.replace("<![CDATA[","").replace("]]>",""),this.processSignalingMessage(null,j)):webRTC.log("Unknown Type:"+b)}}},processSignalingMessage:function(a,b){if(a){var c=window.atob(b).replace(/\s/g,""),d=window.atob(c),e=this.getPeerObject(a);e&&e.processSignalingMessage(d)}else{var f=b.indexOf("SUBID:");if(0==f){var g=b.indexOf(":SUBID"),h=b.substring(6,g),j=b.substring(6+g),c=window.atob(j).replace(/\s/g,""),d=window.atob(c),e=this.getPeerObject(h);e&&e.processSignalingMessage(d)}else{var j=JSON.parse(b);if(webRTC.log("processSignalingMessage:"+j.type+" msg:"+j),"ROOM_FULL"==j.type)Platform.showMessageX("Room Full","Room limit reached, please try again after some time.",!0),CallManager.endCall();else if("NEW_SUBSCRIBER"==j.type)webRTC.log("New connection subscribed to room with sub id:"+j.subid+" "+j.userId),this.checkAndCreate(j.subid,j.userId);else if("SUBSCRIBER_LIST"==j.type){var k=parseInt(j.count);for(i=0;i<k;i++)this.checkAndCreate(j["sub_"+i],j["userId_"+i]);0!=k&&this.autoCall?this.doOffer():zwrtc._disableWS||ConnectionManager._dispatchEvent("ZWRTC_P2P_INITIALIZED",{
msg_string:"ZWRTC p2p lib initialized"}),webRTC.startP2PTTLTimer()}else j.type==webRTC.MSG_TYPE_PVE?ConnectionManager._dispatchEvent("ZWRTC_PEER_VIDEO_ENABLED",{msg_string:"ZWRTC peer enabled his video"}):j.type==webRTC.MSG_TYPE_PVD?ConnectionManager._dispatchEvent("ZWRTC_PEER_VIDEO_DISABLED",{avatarUrl:j.avatarUrl,msg_string:"ZWRTC peer disabled his video"}):j.type==webRTC.MSG_TYPE_BYE?this._hangupByPeer=!0:"SUBSCRIBER_REMOVED"==j.type&&(rtcSFU._sfuStreams[this.userId]&&delete rtcSFU._sfuStreams[this.userId],webRTC.log("Connection unsubscribed to room with sub id:"+j.subid+" "+this._hangupByPeer),ConnectionManager._dispatchEvent("ZWRTC_REMOVE_RV_STREAM",{id:j.subid,userId:this.userId}),this.subscriberRemoved(j.subid))}}},subscriberRemoved:function(a){webRTC.log("subscriberRemoved:"+a);var b,c=!1;for(i=0;i<this.wrtcPeerArray.length;i++)if(b=this.wrtcPeerArray[i],b.subid==a){if(b.clearRV(),this.wrtcPeerArray.splice(i,1),b.peerConnection)try{b.peerConnection.close()}catch(d){}b.peerConnection=null,c=!0;break}if(webRTC.log("subscriberRemoved:"+a+" removed:"+c),c)if(0!=this.wrtcPeerArray.length||this._hangupByPeer){for(i=0;i<this.wrtcPeerArray.length;i++){var e=this.wrtcPeerArray[i];webRTC.log(i+" sub id:"+e.subid);var f=this.rvArr?this.rvArr[i+1]:null;if(f){e.updateRV(f[0]);try{f.show(),show_comp(f)}catch(d){}}}this.resetRV(++i),b&&delete b,b=null,this.generateCoordinates()}else ConnectionManager._dispatchEvent("ZWRTC_P2P_ENDED",{msg_string:"ZWRTC p2p peer closed the call"}),CallManager._dispatchEvent(CallManager.Event.CONNECTED,{type:"p2p"}),this.resetRV(0),webRTC.stop(),CallManager._srCommandID=-1,"undefined"!=typeof CallMUCMembers&&CallMUCMembers.inRoom?(webRTC.log("subscriberRemoved:connectToMCU"),CallManager.connectToMCU("VIDEO"==CallManager._type)):(webRTC.log("subscriberRemoved:endCall"),CallManager.endCall())},resetRV:function(a){if(this.rvArr)for(;a<this.rvArr.length;a++){var b=this.rvArr?this.rvArr[a]:null;if(b)try{0!=a&&(b[0].pause(),b[0].src=null,b.parent().hide()),b.hide(),hide_comp(b)}catch(c){}}},placeCall:function(a){wsServer.connect(a,"OFFER",this.host)},doOffer:function(){this.localStream||zwrtc.viewOnly?(webRTC.log("doOffer:1"),this.processOffer()):(this.nextState="OFFER",this.doGetUserMedia())},processOffer:function(){for(this._hangupByPeer=!1,i=0;i<this.wrtcPeerArray.length;i++){var a=this.wrtcPeerArray[i];null==a.peerConnection&&a.doOffer()}},getPeerObject:function(a){for(i=0;i<this.wrtcPeerArray.length;i++){var b=this.wrtcPeerArray[i];if(b.subid==a)return b}return null},checkAndCreate:function(a,b){var c=!1;for(i=0;i<this.wrtcPeerArray.length;i++){var d=this.wrtcPeerArray[i];if(d.subid==a){c=!0;break}}if(!c){var e=null;this.rvArr&&this.rvArr.length>=this.wrtcPeerArray.length+1&&(e=this.rvArr[this.wrtcPeerArray.length+1][0]);var d=new WRTCPeer(a,e);d.userId=b,this.wrtcPeerArray.push(d),webRTC.log("Created new peer object with sub id:"+a),this.generateCoordinates()}webRTC.log("this.wrtcPeerArray:"+this.wrtcPeerArray.length),this.startBitrateInfo()},startP2PTimeout:function(){webRTC.failoverToFlash=!0,setTimeout(function(){webRTC.failoverToFlash&&(webRTC.failoverToFlash=!1,webRTC.failP2P())},1e4)},startP2PTTLTimer:function(){webRTC.stopP2PTTLTimer(),webRTC.ttlTimer=setInterval(function(){webRTC.sendMessage({type:"TTL"})},15e3)},stopP2PTTLTimer:function(){clearInterval(webRTC.ttlTimer)},failP2P:function(){webRTC.sendMessage({type:webRTC.MSG_TYPE_P2P_FAILED}),webRTC.stop()},sendMessage:function(a){var b=JSON.stringify(a);webRTC.log("C->S: "+b),wsServer.send(null,b)},sendMessageToID:function(a,b){var c=JSON.stringify(b);webRTC.log(a+":C->S: "+c);var d=window.btoa(window.btoa(c));wsServer.send(a,d)},onRemoteHangup:function(){webRTC.stop()},onHangup:function(){this.sendMessage({type:"bye"}),webRTC.stop()},doFullscreen:function(a){webRTC.log("doFullscreen:"+a),a.requestFullscreen?(webRTC.log("doFullscreen:requestFullscreen"),a.requestFullscreen()):a.mozRequestFullScreen?(webRTC.log("doFullscreen:mozRequestFullScreen"),a.mozRequestFullScreen()):a.webkitRequestFullScreen&&(webRTC.log("doFullscreen:webkitRequestFullScreen"),a.webkitRequestFullScreen())},cancelFullscreen:function(){document.exitFullscreen?(webRTC.log("document.exitFullscreen()"),top.document.exitFullscreen()):document.mozCancelFullScreen?(top.document.mozCancelFullScreen(),webRTC.log("document.mozCancelFullScreen()")):document.webkitCancelFullScreen&&(top.document.webkitCancelFullScreen(),webRTC.log("document.webkitCancelFullScreen()"))},stop:function(){webRTC.log("STOP"),this._callGoingOn=!1,this.remoteStream=null,webRTC.stopP2PTTLTimer(),wsServer.close(),this.brInfoRunning=!1,this.brInfoTimer&&clearInterval(this.brInfoTimer),this.peerConnection&&this.peerConnection.close(),this.peerConnection=null;try{zwrtc.isConnected()&&zwrtc.isMCU()||wrtcShowWFC()}catch(a){}if(this.wrtcPeerArray)for(;this.wrtcPeerArray.length>0;){var b=this.wrtcPeerArray.shift();b.clearRV(),b.peerConnection&&b.peerConnection.close(),b.peerConnection=null,b.debugInfoTimer&&clearInterval(b.debugInfoTimer),b.debugInfoTimer=null,b&&delete b,b=null}if(this.rvArr&&!zwrtc.isMCU())for(var c=0;c<this.rvArr.length;c++){var d=this.rvArr[c];if(d){d[0].pause(),d[0].src=null;try{if(c>0){var e=d.parent();e.hide()}d.hide(),hide_comp(d)}catch(a){}}}},releaseMedia:function(){this.localStream&&this.localStream.stop(),this.localStream=null;try{wrtcShowUserAvatar()}catch(a){}},switchToWaitMode:function(){try{this.localStream?webRTC.isVideoMuted&&webRTC.toggleVideoMute():wrtcShowUserAvatar(),wrtcShowWFC()}catch(a){}},muteVideoTrack:function(){var a=this.localStream.getVideoTracks();if(null==a)return webRTC.log("No local video available."),!1;for(i=0;i<a.length;i++)a[i].enabled=!1},sendToAllPeers:function(a){for(var b=0;b<this.wrtcPeerArray.length;b++){var c=this.wrtcPeerArray[b];c&&webRTC.sendMessageToID(c.subid,a)}},disableVideo:function(){if(this.localStream){var a=this.localStream.getVideoTracks();if(zwrtc.p2p2mcu&&this.localVideoStream&&(a=this.localVideoStream.getVideoTracks()),null==a)return void webRTC.log("No local video available.");for(ssController._desktopStream||this.sendToAllPeers({type:this.MSG_TYPE_PVD,avatarUrl:DataStore.getUserData("avatarurl")}),i=0;i<a.length;i++)a[i].enabled=!1;this.isVideoMuted=!0,ConnectionManager._dispatchEvent("ZWRTC_SET_WEBCAM_ACTIVE",{isVideoMuted:!0,msg_string:"ZWRTC Outgoing video toggled"}),webRTC.log("Video muted.");try{wrtcShowUserAvatar()}catch(b){}}else CallManager._flashEnabled&&!zwrtc.viewOnly?(this.isVideoMuted=!0,ConnectionManager._dispatchEvent("FLASH_MUTE_CAM",{mute:this.isVideoMuted,msg:""})):this.isVideoMuted=!0},enableVideo:function(){if(this.localStream){var a=this.localStream.getVideoTracks();if(null==a)return void webRTC.log("No local video available.");if(a.length>0){for(i=0;i<a.length;i++)a[i].enabled=!0;this.isVideoMuted=!1}else this.isVideoMuted=!0;ConnectionManager._dispatchEvent("ZWRTC_SET_WEBCAM_ACTIVE",{isVideoMuted:!1,msg_string:"ZWRTC Outgoing video toggled"}),webRTC.log("Video unmuted.");try{wrtcShowLocalVideo()}catch(b){}this.sendToAllPeers({type:this.MSG_TYPE_PVE})}else CallManager._flashEnabled&&!zwrtc.viewOnly?(this.isVideoMuted=!1,ConnectionManager._dispatchEvent("FLASH_MUTE_CAM",{mute:this.isVideoMuted,msg:""})):this.isVideoMuted=!0},toggleVideoMute:function(a){if(CallManager._mutedByMAPT&&this.isVideoMuted)return void showMessage("Camera Disabled","Your camera has been stopped. Please press Raise Hand to attract attention.");var b={};if(this.isVideoMuted?this.enableVideo():this.disableVideo(),b.isVideoMuted=this.isVideoMuted,!a){var c="/servlet/com.requestec.smg.servlets.Avatar?command=get_picture&service=saypage&partner=home&height=240&width=320&cropToFit=true&pic=1&vid=";try{c=Z.zjs.DataStore.getUserData("avatarurl")}catch(d){}ConnectionManager._dispatchEvent("ZWRTC_VIDEO_MUTE_TOGGLED",{msg_string:"ZWRTC outgoing video muted",mute:b.isVideoMuted,url:c})}CallManager.setWebCamActive(b)},doMuteTillRecording:function(){CallManager._flashEnabled||!CallManager._recordP2P||CallManager._p2pRecordingLive||this.isAudioMuted||(CallManager._audioMuted=webRTC.isAudioMuted,this.toggleAudioMute(),Z.zjs.$("#rvDisplay").text("Connecting..."),Z.zjs.$("#rvDisplay").show())},doUnMute:function(){("P2P"!=CallManager._callType||CallManager._recordP2P&&CallManager._p2pRecordingLive)&&CallManager._audioMuted!=webRTC.isAudioMuted&&"Connecting..."==Z.zjs.$("#rvDisplay").text()&&(Z.zjs.$("#rvDisplay").text(""),Z.zjs.$("#rvDisplay").hide(),this.toggleAudioMute())},p2pMuteEnabled:function(){return!(CallManager._flashEnabled||!CallManager._recordP2P||CallManager._p2pRecordingLive||"P2P"!=CallManager._callType)},toggleAudioMute:function(a){if(CallManager._mutedByMAPT&&this.isAudioMuted)return void showMessage(Z.zjs.ZLocale.getString("zjs_alert_title_mic_disabled","Microphone Disabled"),Z.zjs.ZLocale.getString("zjs_alert_text_mic_disabled","Your mic has been muted by the host. Please press Raise Hand to attract attention."));if(this.p2pMuteEnabled()&&this.isAudioMuted)return void(this.isP2PEstablished()&&showMessage(Z.zjs.ZLocale.getString("zjs_alert_title_call_recording","Call Recording"),Z.zjs.ZLocale.getString("zjs_alert_text_call_recording","Connecting..."),!1,null,null,null,null,null,Z.zjs.ZLocale.getString("zjs_button_continue","Continue")));if(this.localStream){var b=this.localStream.getAudioTracks();if(null==b||0===b.length)return webRTC.log("No local audio available."),void(this.isAudioMuted=!0);var c=this.isAudioMuted;for(i=0;i<b.length;i++)b[i].enabled=c;if(this.isAudioMuted=!this.isAudioMuted,webRTC.localAudioStream){var d=webRTC.localAudioStream.getAudioTracks();for(i=0;i<d.length;i++)d[i].enabled=c}a||ConnectionManager._dispatchEvent("ZWRTC_AUDIO_MUTE_TOGGLED",{msg_string:"ZWRTC outgoing audio muted",mute:this.isAudioMuted})}else CallManager._flashEnabled&&!zwrtc.viewOnly?(this.isAudioMuted=!this.isAudioMuted,ConnectionManager._dispatchEvent("FLASH_MUTE_MIC",{mute:this.isAudioMuted,msg:""})):this.isAudioMuted=!0,a||ConnectionManager._dispatchEvent("ZWRTC_AUDIO_MUTE_TOGGLED",{msg_string:"ZWRTC outgoing audio muted",mute:this.isAudioMuted})},waitForRemoteVideo:function(){var a=webRTC.remoteStream.getVideoTracks();0==a.length||void 0==webRTC.remoteVideo||webRTC.remoteVideo.currentTime>0?webrtcP2PEstablished():setTimeout(webRTC.waitForRemoteVideo,100)},preferAudioCodec:function(a,b){var c=b.split("/");if(2!=c.length)return webRTC.log("Invalid codec setting: "+b),a;for(var d=c[0],e=c[1],f=a.split("\r\n"),g=0;g<f.length;g++)if(f[g].search("m=audio")!==-1){var h=g;break}if(null===h)return a;for(var g=0;g<f.length;g++)if(f[g].search(d+"/"+e)!==-1){var i=new RegExp(":(\\d+) "+d+"\\/"+e,"i"),j=this.extractSdp(f[g],i);j&&(f[h]=this.setDefaultCodec(f[h],j));break}return f=this.removeCN(f,h),a=f.join("\r\n")},preferOpus:function(a){for(var b=a.split("\r\n"),c=0;c<b.length;c++)if(b[c].search("m=audio")!==-1){var d=c;break}if(null===d)return a;for(var c=0;c<b.length;c++)if(b[c].search("opus/48000")!==-1){var e=this.extractSdp(b[c],/:(\d+) opus\/48000/i);e&&(b[d]=this.setDefaultCodec(b[d],e));break}return b=this.removeCN(b,d),a=b.join("\r\n")},extractSdp:function(a,b){var c=a.match(b);return c&&2==c.length?c[1]:null},setDefaultCodec:function(a,b){for(var c=a.split(" "),d=new Array,e=0,f=0;f<c.length;f++)3===e&&(d[e++]=b),c[f]!==b&&(d[e++]=c[f]);return d.join(" ")},removeCN:function(a,b){for(var c=a[b].split(" "),d=a.length-1;d>=0;d--){var e=this.extractSdp(a[d],/a=rtpmap:(\d+) CN\/\d+/i);if(e){var f=c.indexOf(e);f!==-1&&c.splice(f,1),a.splice(d,1)}}return a[b]=c.join(" "),a},log:function(a){}};window.onbeforeunload=function(){webRTC.sendMessage({type:"bye"}),webRTC.stop(),setTimeout(function(){},100)};var zwrtc={initCalled:!1,initialized:!1,_readyDispatched:!1,cam_width:320,cam_height:240,cam_fps:30,cam_fps_min:10,in_video_width:640,in_video_height:480,screen:!1,from:null,host:null,autocall:!1,wrtc2sip_port:null,viewVideoLocal:null,roomID:null,rvArr:null,audio_remote:null,pendingUpdate:!1,p2pInitialized:!1,mediaAccessGranted:!1,initMode:"both",_loop:!1,_video:!0,_destination:null,failoverToMCU:!1,_confirmAV:"cammic",baseTimer:0,baseTimerTS:0,durationTimer:null,finalTime:0,sipStunConfig:[],pcConfig:{iceServers:[]},w2sFailoverDone:!1,viewOnly:!1,p2p2mcu:!1,switched2p2p:!1,zsProxy:!0,allowCallRetry:!0,mp3user:!1,connectTimeout:5,audioTimeout:10,audioTimeoutMax:20,remoteMediaAttachTimeout:4,mcuRecvdAudio:!1,mcuRecvdVideo:!1,mcuRecvdConnection:!1,remoteStreamAttached:!1,headlessChromeXID:-1,callInitiated:!1,callEstablished:!1,reconnectCounter:0,lastInitCallTS:0,lastMCUAudioPacketCount:0,lastMCUVideoPacketCount:0,lastMCURedial:0,startStatsDebugTimeout:15e3,lastMCUAudioPacketChangeTime:0,lastMCUVideoPacketChangeTime:0,lastMCURedialMinRepeat:12e4,_callConnected:!1,micEnabled:!0,_disableWS:!0,_enableAllIceCandidate:!1,webrtcCheck:!1,peerVideoEnabled:!0,_enableSFU:!1,_disableSML:!0,_hideLvOnMute:!0,init:function(a,b,c,d,e,f,g,h,j,k,l,m){switch(this.from=a,this.host=b,this.wrtc2sip_port=c,this.viewVideoLocal=d,this.rvArr=e,this.audio_remote=f,this.roomID=g,this.autocall=h,zwrtc.getSMLObj()&&(zwrtc.getSMLObj().disableWS=this._disableWS,this._enableAllIceCandidate&&(zwrtc.getSMLObj().iceState="enabled")),l&&(this.stunserver_config=l,this.generateStun(l)),k){case"mic":case"cammic":this._confirmAV=k}if("p2p"==j||"mcu"==j?this.initMode=j:this.initMode="both",this.initCalled)return zwrtc.initialized&&zwrtc.checkSipInitialized(),void(webRTC.localStream&&webRTC.attachMediaStream(webRTC.localVideo,webRTC.localStream));if(this.initCalled=!0,ConnectionManager.addListener("ZWRTC_SIP_INITIALIZED",this,function(a){zwrtc_mcupc.log("ZWRTC_SIP_INITIALIZED:"+a.msg_string),zwrtc.initialized=!0,zwrtc.checkSipInitialized()}),ConnectionManager.addListener("ZWRTC_SIP_STACK_STARTED",this,function(a){var b=a.msg_string+" "+zwrtc.viewOnly+" "+zwrtc.initMode+" "+zwrtc.mediaAccessGranted+" "+zwrtc_mcupc._destination+" "+zwrtc._destination;zwrtc_mcupc.log("ZWRTC_SIP_STACK_STARTED:"+b),zwrtc_mcupc.log("ZWRTC_W2S_CONNECT"),ConnectionManager._dispatchEvent("ZWRTC_W2S_CONNECT",{msg:b}),zwrtc.initialized=!0,zwrtc.pendingUpdate=!1,zwrtc.viewOnly&&zwrtc.getSMLObj()&&null==zwrtc.getSMLObj().o_stream&&(zwrtc.mediaAccessGranted=!0,zwrtc.getSMLObj().o_stream="VIEWONLY");var c=zwrtc._destination;zwrtc_mcupc._destination&&(c=zwrtc_mcupc._destination),null!=c?zwrtc.placeCall(this._video,c,this._callid,this.host):ConnectionManager._dispatchEvent("ZWRTC_PLACING_CALL_STEPS",{msg:"W2S_CONNECT no destination"})}),ConnectionManager.addListener("ZWRTC_SIP_STACK_FAILED",this,function(a){zwrtc_mcupc.log("ZWRTC_SIP_STACK_FAILED:"+a.msg_string),zwrtc.checkReconnect()?zwrtc_mcupc.reInitStack(!1):!zwrtc.w2sFailoverDone&&m?(zwrtc_mcupc.log("WRTC_SIP_FAILOVER"),zwrtc_mcupc.reInitStack(!1),zwrtc.w2sFailoverDone=!0):null!=zwrtc._destination&&ConnectionManager._dispatchEvent("ZWRTC_SIP_CALL_FAILED",{msg_string:"Failed to place call to MCU",destination:zwrtc._destination})}),ConnectionManager.addListener("ZWRTC_SIP_STACK_STOPPED",this,function(a){if(zwrtc_mcupc.log("ZWRTC_SIP_STACK_STOPPED:"+a.msg_string),zwrtc.initialized=!1,zwrtc.checkReconnect())zwrtc_mcupc.log("Reinitiaizing stack"),zwrtc_mcupc.reInitStack(!1);else if(zwrtc.pendingUpdate)zwrtc.pendingUpdate=!1,zwrtc_mcupc.reInitStack(!1);else{var b=!1;this.callInitiated&&(b=!0),zwrtc.hangup(b),zwrtc.stateUpdated({state:ConnectionManager.zsState})}}),ConnectionManager.addListener("ZWRTC_P2P_INITIALIZED",this,function(a){zwrtc_mcupc.log("ZWRTC_P2P_INITIALIZED:"+a.msg_string),zwrtc.p2pInitialized=!0,"p2p"==zwrtc.initMode&&zwrtc.mediaAccessGranted?zwrtc.dispatchReady():zwrtc.initialized&&zwrtc.mediaAccessGranted&&zwrtc.dispatchReady()}),ConnectionManager.addListener("ZWRTC_SIP_CALL_TERMINATED",this,function(a){zwrtc_mcupc.log("ZWRTC_SIP_CALL_TERMINATED:"+a.msg_string+" "+zwrtc.pendingRedial),zwrtc.checkReconnect()?(zwrtc_mcupc.log("Redialing call"),zwrtc_mcupc.redial(2)):zwrtc.callInitiated&&ConnectionManager._dispatchEvent("ZWRTC_CALL_TERMINATED",{msg_string:""})}),ConnectionManager.addListener("ZWRTC_MEDIA_ACCESS_GRANTED",this,function(a){zwrtc_mcupc.log("ZWRTC_MEDIA_ACCESS_GRANTED"),a.stream&&zwrtc.getSMLObj()&&(zwrtc.getSMLObj().o_stream=a.stream),zwrtc_mcupc._pendingRedial?zwrtc_mcupc.redial(3):zwrtc.mediaAccessGranted||("p2p"==zwrtc.initMode&&zwrtc.p2pInitialized?zwrtc.dispatchReady():"mcu"==zwrtc.initMode&&zwrtc.initialized?zwrtc.dispatchReady():zwrtc.p2pInitialized&&zwrtc.initialized&&zwrtc.dispatchReady()),zwrtc.mediaAccessGranted=!0}),ConnectionManager.addListener("ZWRTC_ACCESSING_MEDIA",this,function(a){zwrtc_mcupc.log("ZWRTC_ACCESSING_MEDIA:"+a.msg_string)}),ConnectionManager.addListener("ZWRTC_MEDIA_ACCESS_FAILED",this,function(a){zwrtc_mcupc.log("ZWRTC_MEDIA_ACCESS_FAILED:"+a.msg_string)}),ConnectionManager.addListener("ZWRTC_WEBCAM_ACCESS_GRANTED",this,function(a){zwrtc_mcupc.log("ZWRTC_WEBCAM_ACCESS_GRANTED:"),this.placeCall(zwrtc._video,zwrtc_mcupc._destination)}),ConnectionManager.addListener("ZWRTC_REMOTE_STREAM_ATTACHED",this,function(a){if(zwrtc_mcupc.log("ZWRTC_REMOTE_STREAM_ATTACHED:failoverToMCU:"+zwrtc.failoverToMCU+" "+((new Date).getTime()-zwrtc_mcupc.audioLossDuration)),zwrtc.remoteStreamAttached||zwrtc_mcupc.checkMediaRecvd(),zwrtc.remoteStreamAttached=!0,zwrtc.failoverToMCU){var b=webRTC.getRemoteStream();if(zwrtc.p2p2mcu){if(b){try{var c=b.getAudioTracks();for(i=0;i<c.length;i++)b.removeTrack(c[i]),webRTC.log("audio track "+i+" removed from stream")}catch(d){}zwrtc.getSMLObj()&&(zwrtc.getSMLObj().o_stream=b),webRTC.attachMediaStream(zwrtc.viewVideoLocal,b)}else zwrtc.viewOnly&&zwrtc.getSMLObj()&&null==zwrtc.getSMLObj().o_stream&&(zwrtc.getSMLObj().o_stream="VIEWONLY");webRTC.attachMediaStream(zwrtc.rvArr[0][0],null),null!=zwrtc.mcudestination&&zwrtc.placeCall(!0,zwrtc.mcudestination,this._callid,this.host)}}else zwrtc.p2p2mcu?zwrtc.headlessChromeXID==-1&&zwrtc.getSMLObj()&&zwrtc.getSMLObj().o_remote_stream&&(webRTC.log("Need renegotiation"),webRTC.localStream=zwrtc.getSMLObj().o_remote_stream,webRTC.renegotiate()):"force"!=zwrtc.proxyCam&&"only"!=zwrtc.proxyCam||(webRTC.log("ZWRTC_PL_PROXY_CAM is force calling switch p2p2mcu"),zwrtc.switchP2P2Mcu());if(zwrtc.failoverToMCU=!1,"mic"!=zwrtc._confirmAV&&zwrtc._video)try{zwrtc.peerVideoEnabled&&wrtcShowRemoteVideo()}catch(d){}else{zwrtc.disableVideo();try{audioCallEstablished()}catch(d){}}if(!(zwrtc.baseTimerTS>0)){var e=(new Date).getTime();zwrtc.baseTimer=0,zwrtc.baseTimerTS=e,zwrtc.startDurationTimer()}}),zwrtc._enableSFU||zwrtc._disableSML||(ConnectionManager.addListener("ZEBRA:SHADOW_CONNECT",this,this.shadowConnectRecvd),ConnectionManager.addListener("ZEBRA:SHADOW_AUDIO_STARTED",this,this.shadowAudioStartedRecvd),ConnectionManager.addListener("ZEBRA:SHADOW_VIDEO_STARTED",this,this.videoStartedRecvd)),ConnectionManager.addListener("ZEBRA:SHADOW_VIDEO_STOPPED",this,this.videoStopedRecvd),ConnectionManager.addListener("ZWRTC_P2P_ANSWERED",this,this.p2pCallAnswered),ConnectionManager.addListener("ZS_STATE_UPDATE",this,this.stateUpdated),ConnectionManager.addListener("SWITCH_VIEW_ONLY",this,this.switchViewOnly),ConnectionManager.addListener("ZWRTC_WS_OPEN",this,this.onWSOpen),ConnectionManager.addListener("ZWRTC_WS_CLOSE",this,this.onWSClose),ConnectionManager.addListener("ZWRTC_WS_SEND",this,this.onWSSend),ConnectionManager.addListener("ZEBRA:ZWRTC_ZS_ON_OPEN",this,this.zsOnOpen),ConnectionManager.addListener("ZEBRA:ZWRTC_ZS_ON_MESSAGE",this,this.zsOnMessage),ConnectionManager.addListener("ZEBRA:ZWRTC_ZS_ON_CLOSE",this,this.zsOnClose),ConnectionManager.addListener("ZWRTC_P2P_OPEN",this,this.onP2POpen),ConnectionManager.addListener("ZWRTC_P2P_CLOSE",this,this.onP2PClose),ConnectionManager.addListener("ZWRTC_P2P_SEND",this,this.onP2PSend),ConnectionManager.addListener("ZEBRA:ZWRTC_P2P_ON_OPEN",this,this.p2pOnOpen),ConnectionManager.addListener("ZEBRA:ZWRTC_P2P_ON_MESSAGE",this,this.p2pOnMessage),ConnectionManager.addListener("ZEBRA:ZWRTC_P2P_ON_CLOSE",this,this.p2pOnClose),ConnectionManager.addListener("ZWRTC_P2P_ESTABLISHED",this,this.p2pEstablished),ConnectionManager.addListener("ZEBRA:SHOWMESSAGE3",this,function(a){var b=parseInt(a.getZEvent("messageid").value);switch(b){case 0:case 30:zwrtc.stopSound();break;case 6:case 7:break;case 8:case 9:zwrtc.playSound("/clients/Z3x/web/shared/assets/media/callringing.mp3",!0)}}),zwrtc._enableSFU||zwrtc._disableSML){var n=null,o=null;zwrtc.rvArr&&(n=zwrtc.rvArr[0],o=zwrtc.rvArr.slice(1)),rtcSFU.init(n,o),zwrtc.initialized=!0}"p2p"==j?webRTC.initWebRTC(this.roomID,d,e,this.autocall,this.generateConstraint(this.sipStunConfig),zwrtc.host):"mcu"==j?(webRTC.setLV(d),webRTC.localStream?this.onUserMediaSuccess(webRTC.localStream):webRTC.accessMedia(this.generateConstraint(this.sipStunConfig)),zwrtc_mcupc.initSDK()):(webRTC.initWebRTC(this.roomID,d,e,this.autocall,this.generateConstraint(this.sipStunConfig),zwrtc.host),zwrtc_mcupc.initSDK())},getSMLObj:function(){if("undefined"!=typeof tmedia_session_jsep01)return tmedia_session_jsep01},checkSipInitialized:function(){"mcu"==zwrtc.initMode&&(zwrtc.mediaAccessGranted||zwrtc.viewOnly)?zwrtc.dispatchReady():zwrtc.p2pInitialized&&(zwrtc.mediaAccessGranted||zwrtc.viewOnly)&&zwrtc.dispatchReady()},resize:function(){rtcSFU.resize(),webRTC.resize()},onP2POpen:function(a){},onP2PClose:function(a){},onP2PSend:function(a){},p2pOnOpen:function(a){},p2pOnMessage:function(a){},checkVideoDisabled:function(){this.isUsingNoCam()&&webRTC.disableVideo()},p2pEstablished:function(a){this._callConnected=!0;var b="Voice ";zwrtc._video&&(b="Video "),b+="(P2P) call in progress",ConnectionManager._dispatchEvent("WRTC_DISPLAY_MSG",{msg:b}),zwrtc.p2pIceCheckTimer&&clearInterval(zwrtc.p2pIceCheckTimer),zwrtc.startDurationTimer(),this.checkVideoDisabled()},p2pOnClose:function(a){zwrtc_mcupc.log("p2pOnClose"),ConnectionManager._dispatchEvent("ZWRTC_P2P_ON_CLOSE",{reason:"",creationTime:""})},onWSOpen:function(a){var b=new Zebra(ConnectionManager.zsZebraGateway+"#createWsSession");b.setZEvent("creationTime",a.creationTime),ConnectionManager.sendZSZebraCommand("zsMessage",b)},onWSClose:function(a){var b=new Zebra(ConnectionManager.zsZebraGateway+"#closeWsSession");b.setZEvent("creationTime",a.creationTime),ConnectionManager.sendZSZebraCommand("zsMessage",b)},onWSSend:function(a){if(a.data){var b=new Zebra(ConnectionManager.zsZebraGateway+"#sendMessageToWS"),c=window.btoa(window.btoa(a.data));b.setZEvent("data","<![CDATA["+c+"]]>"),b.setZEvent("creationTime",a.creationTime),ConnectionManager.sendZSZebraCommand("zsMessage",b)}},zsOnOpen:function(a){var b=a.getZEvent("data").value,c=a.getZEvent("creationTime").value;zwrtc_mcupc.log("zsOnOpen:"+b),ConnectionManager._dispatchEvent("ZWRTC_WS_ZS_ONOPEN",{msg:"",creationTime:c})},zsOnMessage:function(a){try{var b=a.getZEvent("creationTime").value,c=a.getZEvent("data").value;c=c.replace("<![CDATA[","").replace("]]>","");var d=window.atob(c).replace(/\s/g,""),e=window.atob(d);ConnectionManager._dispatchEvent("ZWRTC_WS_ZS_ONMESSAGE",{data:e,creationTime:b})}catch(f){zwrtc_mcupc.log("zsOnMessage:"+f)}},zsOnClose:function(a){var b=a.getZEvent("creationTime").value,c=a.getZEvent("data").value;zwrtc_mcupc.log("zsOnClose:"+c),ConnectionManager._dispatchEvent("ZWRTC_WS_ZS_ONCLOSE",{reason:c,creationTime:b})},dispatchEventReady:function(a){"disconnected"!=a||zwrtc.screen?(zwrtc_mcupc.log("ZWRTC_READY"),this._readyDispatched||ConnectionManager._dispatchEvent("ZWRTC_READY",{msg_string:"Ready to place call"}),this._readyDispatched=!0):zwrtc._pendingReady=!0},dispatchReady:function(){this.dispatchEventReady(ConnectionManager.zsState)},shadowConnectRecvd:function(a){zwrtc.mcuRecvdConnection=!0;var b=a.getZEvent("shadow_from").value;if(zwrtc.from==b)zwrtc_mcupc.shadowConnected();else if(CallManager._ss_window)try{CallManager._ss_window.zwrtc.shadowConnectRecvd(a)}catch(c){zwrtc_mcupc.log("SHADOW_AUDIO_STARTED:error calling CallManager._ss_window.zwrtc.shadowConnectRecvd")}zwrtc_mcupc.log("SHADOW_CONNECT:zwrtc.from:"+zwrtc.from+" shadow_from:"+b)},videoStopedRecvd:function(a){var b=a.getZEvent("shadow_from").value,c="SHADOW_SCREEN_"+DataStore.getUserData("username","");c==b&&CallManager._ssDetected&&(CallManager.shareScreenStop(),Platform.showMessageX("Screen Sharing Problem","We have encountered a screen sharing issue. Please try again",!0))},videoStartedRecvd:function(a){var b=a.getZEvent("shadow_from").value;zwrtc.mcuRecvdVideo||zwrtc.from!=b||(zwrtc.mcuRecvdVideo=!0,zwrtc.remoteStreamAttached&&zwrtc_mcupc.checkMediaRecvd())},shadowAudioStartedRecvd:function(a){var b=a.getZEvent("shadow_from").value;if(zwrtc.mcuRecvdAudio||zwrtc.from!=b){if(CallManager._ss_window)try{CallManager._ss_window.zwrtc.shadowAudioStartedRecvd(a)}catch(c){zwrtc_mcupc.log("SHADOW_AUDIO_STARTED:error calling CallManager._ss_window.zwrtc.shadowAudioStartedRecvd")}}else zwrtc.mcuRecvdAudio=!0,zwrtc.remoteStreamAttached&&zwrtc_mcupc.checkMediaRecvd();zwrtc_mcupc.log("SHADOW_AUDIO_STARTED:zwrtc.from:"+zwrtc.from+" shadow_from:"+b)},callInitRequired:function(){if(zwrtc.callInitiated){zwrtc_mcupc.log("stateUpdated:poll state waiting, initiate call");var a=(new Date).getTime();0==this.lastInitCallTS?this.lastInitCallTS=a:a-this.lastInitCallTS>5e3&&(this.lastInitCallTS=a),this.lastInitCallTS==a&&CallManager.initCall(CallManager._type,CallManager._destination,"-1",!0,0,"Demo Call",null,null)}},stateUpdated:function(a){zwrtc._pendingReady&&"disconnected"!=a.state&&(zwrtc._pendingReady=!1,zwrtc.dispatchEventReady(a.state)),!zwrtc.callInitiated||zwrtc._enableSFU||zwrtc._disableSML||"busy"==a.state&&null==zwrtc_mcupc.oSipStack&&zwrtc.callEstablished&&(zwrtc_mcupc.log("stateUpdated:poll state BUSY and stack not initialized, so calling reInitStack"),zwrtc_mcupc.reInitStack(!1))},isUsingPhone:function(){return"PHONE"==this.audioSourceID},isUsingNoCam:function(){return"NONE"==zwrtc.videoSourceID},p2pCallAnswered:function(){zwrtc_mcupc.log("p2pCallAnswered"),zwrtc.proxy||zwrtc.startP2PTimeout(!1)},checkReconnect:function(){if(zwrtc.callInitiated)if(zwrtc.mp3user){if(!zwrtc.mcuRecvdAudio)return!0}else{if(!zwrtc.mcuRecvdConnection)return!0;if(!zwrtc.screen)if(webRTC.isAudioMuted){if(!zwrtc.mcuRecvdVideo)return!0}else if(!zwrtc.mcuRecvdVideo&&!zwrtc.mcuRecvdAudio)return!0}return!1},createIceServer:function(a,b,c,d){var e=null;if(d){var f=a.split(":");if(0===f[0].indexOf("stun"))e={url:a};else if(0===f[0].indexOf("turn")){var g=a.split("turn:");e={url:"turn:"+b+"@"+g[1],credential:c}}}else if(navigator.mozGetUserMedia){var h=parseInt(navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]),f=a.split(":");if(0===f[0].indexOf("stun"))e={url:a};else if(0===f[0].indexOf("turn")&&(a.indexOf("transport=udp")!==-1||a.indexOf("?transport")===-1)){var i=a.split("?");e={url:i[0],credential:c,username:b}}}else{var h=parseInt(navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./)[2]),f=a.split(":");if(0===f[0].indexOf("stun"))e={url:a};else if(0===f[0].indexOf("turn"))if(h<28){var g=a.split("turn:");e={url:"turn:"+b+"@"+g[1],credential:c}}else e={url:a,credential:c,username:b}}return e},generateStun:function(a){if(a&&a.uris)for(this.pcConfig={iceServers:[]},this.sipStunConfig=[],i=0;i<a.uris.length;i++){var b=this.createIceServer(a.uris[i],a.username,a.password,!1);null!==b&&this.pcConfig.iceServers.push(b);var c=this.createIceServer(a.uris[i],a.username,a.password,!0);null!==c&&this.sipStunConfig.push(c)}},startDurationTimer:function(){zwrtc.stopDurationTimer(),zwrtc_mcupc.callGoingOn&&(zwrtc.durationTimer=setInterval(function(){var a=(new Date).getTime(),b=0;zwrtc.baseTimerTS>0&&(b=Math.floor((a-zwrtc.baseTimerTS)/1e3));var c=b+zwrtc.baseTimer;if(0!=zwrtc.finalTime&&zwrtc.finalTime<c)return zwrtc.finalTime=0,void zwrtc.stopDurationTimer();try{c>=0&&CallManager._dispatchEvent(CallManager.Event.TIME_ELAPSED,{time:zwrtc.convertToHhMmSsFormat(c)})}catch(d){}},1e3))},stopDurationTimer:function(){clearInterval(zwrtc.durationTimer),setTimeout(function(){try{CallManager._dispatchEvent(CallManager.Event.TIME_ELAPSED,{time:""})}catch(a){}},1e3)},convertToHhMmSsFormat:function(a){var b=Math.floor(a/3600),c=Math.floor((a-3600*b)/60),d=Math.floor(a-(3600*b+60*c)),e="";return b&&(e=b<10?"0"+b+":":b+":"),e+=c<10?"0"+c+":":c+":",e+=d<10?"0"+d:d},update:function(a,b,c){this.from=a,this.host=b,this.wrtc2sip_port=c,this.pendingUpdate=!0,ConnectionManager._dispatchEvent("ZWRTC_PLACING_CALL_STEPS",{msg:"inside update  "+this.from+" "+this.host+" "+this.wrtc2sip_port}),zwrtc_mcupc.reInitStack(!0)},updateCallType:function(a){this._video=a},disableVideo:function(){webRTC.disableVideo()},startP2PTimeout:function(a){zwrtc.peerVideoEnabled=!0,a?zwrtc.failoverToMCU=!1:zwrtc.failoverToMCU=!0,zwrtc_mcupc.log("P2P timeout started");var b=0;zwrtc.p2pIceCheckTimer=setInterval(function(){if(webRTC.checkP2PEstablished(),zwrtc.failoverToMCU){if(b<=5&&!zwrtc.viewOnly);else if(zwrtc.p2pIceCheckTimer&&clearInterval(zwrtc.p2pIceCheckTimer),zwrtc.isMCU()&&zwrtc.getSMLObj()&&zwrtc.getSMLObj().o_remote_stream){zwrtc.rvArr[0][0]&&webRTC.attachMediaStream(zwrtc.rvArr[0][0],zwrtc.getSMLObj().o_remote_stream);try{setLV(CallManager._selfX,CallManager._selfY,CallManager._selfWidth,CallManager._selfHeight,CallManager._videoWidth,CallManager._videoHeight),hideConnecting()}catch(a){}CallManager._dispatchEvent(CallManager.Event.RECONNECTED,{type:"mcu"})}else zwrtc.failoverToMCU&&(zwrtc.failoverToMCU=!1,webRTC.failP2P(),ConnectionManager._dispatchEvent("ZWRTC_P2P_FAILED",{msg_string:"ZWRTC P2P timeout occur doing failover to MCU"}));b++}else zwrtc.p2pIceCheckTimer&&clearInterval(zwrtc.p2pIceCheckTimer)},2e3)},dispatchVoiceCallPlaced:function(){ConnectionManager._dispatchEvent("ZWRTC_VOICECALL_PLACED",{msg:""})},dispatchCallPlaced:function(){ConnectionManager._dispatchEvent("ZWRTC_PLACING_CALL",{msg:""})},placeP2PCall:function(a,b,c){this.isMCU()?CallManager._dispatchEvent(CallManager.Event.RECONNECTING,{type:"p2p"}):(this._callConnected=!1,CallManager._dispatchEvent(CallManager.Event.CONNECTING,{type:"p2p"})),this.dispatchCallPlaced(),this._video=b,webRTC.placeCall(a),this._video||this.dispatchVoiceCallPlaced(),zwrtc.viewOnly?(zwrtc.failoverToMCU=!0,this.p2p2mcu&&this.startP2PTimeout()):this.startP2PTimeout(c),zwrtc_mcupc.log("P2P call placed to "+a)},switchP2P2Mcu:function(){!this.switched2p2p&&("false"!=zwrtc.proxyCam||zwrtc.screen&&"false"!=zwrtc.proxySS)?(this.switched2p2p=!0,this.p2p2mcu=!0,webRTC.localVideoStream?this.placeCall(this._video,zwrtc_mcupc._destination):webRTC.accessVideoOnlyMedia(zwrtc.generateConstraint(zwrtc.sipStunConfig))):zwrtc_mcupc.log("switchP2P2Mcu switched2p2p:"+this.switched2p2p+" zwrtc.proxyCam:"+zwrtc.proxyCam)},getZS:function(){var a=null;return a=ConnectionManager.getZS?ConnectionManager.getZS():"http://"+window.location.host},placeProxyCall:function(){if(zwrtc.proxy&&!zwrtc.screen){zwrtc.screen=!0;var a=this;webRTC.getUserMedia(this.generateConstraint(this.sipStunConfig),function(b){webRTC.localMediaStream=webRTC.localStream,webRTC.localStream=b;var c=DataStore.getUserData("username",""),d="zs_room_"+c;a.placeP2PCall(d,videoCall),zwrtc.failoverToMCU=!1;var e="%26",f=(DataStore.getUserData("mcu_sip_port",""),"https://"+window.location.host+"/user/demo/w.jsp?proxy=ss"+e+"viewonly=true"+e+"destination="+d+e+"username="+c),g=a.getZS()+"/zscrape/zscrape.jsp?url=%22"+f+"%22&dest=p2p2mcu&dump=false";Platform.httpRequest("GET",g,a.headlessChromeResponse,null,null)},function(a){})}},addVideoTracks:function(){if(navigator.mozGetUserMedia||zwrtc.viewOnly||"mic"==zwrtc._confirmAV)return!0;if(webRTC.localStream){var a=webRTC.localStream.getVideoTracks();if(0==a.length){if(navigator.mozGetUserMedia){webRTC.log("addVideoTracks:moz detected"),webRTC.localStream.stop(),webRTC.localStream=null;var b={};return b.audio=!0,b.video=!0,webRTC.accessMedia(b),!1}if(null!=this._videoTracks)for(i=0;i<this._videoTracks.length;i++){try{webRTC.localStream.addTrack(this._videoTracks[i])}catch(c){}webRTC.log("video track "+i+" added to stream")}}webRTC.localVideo&&webRTC.attachMediaStream(webRTC.localVideo,webRTC.localStream);
}return!0},removeVideoTracks:function(){if(navigator.mozGetUserMedia||this.viewOnly)return!0;if(!webRTC.localStream){var a={};return a.audio=!0,a.video=!1,webRTC.accessMedia(a),!1}var b=webRTC.localStream.getVideoTracks();if(0!=b.length){if(navigator.mozGetUserMedia){webRTC.localStream.stop(),webRTC.localStream=null;var a={};return a.audio=!0,a.video=!1,webRTC.accessMedia(a),!1}for(this._videoTracks=b,i=0;i<b.length;i++)webRTC.localStream.removeTrack(b[i]),webRTC.log("video track "+i+" removed from stream")}return!0},placeCall:function(a,b,c,d){if(this.isMCU()&&this.hangup(),this.isP2P()||(this._callConnected=!1),zwrtc_mcupc.log("placeCall:"+a+","+b+","+c+","+d),this.callInitiated=!0,null==zwrtc_mcupc.oSipStack&&(this.initialized=!1),!this.switched2p2p&&(zwrtc.screen&&"force"==zwrtc.proxySS||"direct"==zwrtc.proxyCam)&&(this.switched2p2p=!0,this.p2p2mcu=!0),this._video=a,this.p2p2mcu&&!zwrtc.viewOnly){webRTC.localVideoStream&&webRTC.muteVideoTrack();try{setLV(CallManager._selfX,CallManager._selfY,CallManager._selfWidth,CallManager._selfHeight)}catch(e){}var f=zwrtc.getP2PAddress(),g="&",h=DataStore.getUserData("username","");this.screen?h=this.from:this.switched2p2p&&(h="VIDEO_"+h);var i="https://"+window.location.host+"/user/demo/w.jsp?p2p2mcu=true"+g+"viewonly=true"+g+"destination="+b+g+"p2pAddress="+f+g+"username="+h;this.placeP2PCall(f,a),zwrtc.failoverToMCU=!1;var j=null;j=zwrtc.useZSOpenURL?this.getZS()+"/webrtc/?command=OPEN_URL&url="+i:this.getZS()+"/zscrape/zscrape.jsp?url=%22"+i+"%22&dest=p2p2mcu&dump=false",zwrtc_mcupc.log("headlessURL:"+j),Platform.httpRequest("GET",j,this.headlessChromeResponse,null,null)}else{if(a){if(!this.addVideoTracks())return zwrtc_mcupc.log("Unable to add tracks, using recapture method, delaying call"),void(zwrtc_mcupc._pendingRedial=!0)}else if(!this.removeVideoTracks())return zwrtc_mcupc.log("Unable to remove tracks, using recapture method, delaying call"),void(zwrtc_mcupc._pendingRedial=!0);if(zwrtc._enableSFU||zwrtc._disableSML)return void rtcSFU.placeCall(DataStore.getUserData("username",""),d,b,!a,webRTC.localStream,this.viewVideoLocal);zwrtc_mcupc.oSipStack&&this.initialized&&(zwrtc.w2sFailoverDone||null==d||this.host==d)?(zwrtc_mcupc.log("stack initialized to correct host, so place call"),this.dispatchCallPlaced(),ConnectionManager._dispatchEvent("ZWRTC_PLACING_CALL_STEPS",{msg:"dial now"}),zwrtc.getSMLObj()&&(zwrtc.getSMLObj().o_media_constraints={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0},optional:[{DtlsSrtpKeyAgreement:CallManager.DtlsSrtpKeyAgreement}]}),zwrtc_mcupc.placeCall(a,b,this.viewVideoLocal,this.rvArr[0][0],this.audio_remote),this._video||this.dispatchVoiceCallPlaced()):(zwrtc_mcupc.log("stack not initialized or initialized to incorrect host, so initialize again:"+zwrtc_mcupc.oSipStack+" "+this.initialized+" "+this.host+" "+d),this.host!=d&&(this.initialized=!1),this._destination=b,this._callid=c,this.update(this.from,d,this.wrtc2sip_port))}},headlessChromeResponse:function(a,b,c){if(zwrtc_mcupc.log("headlessChromeResponse:"+a+","+b+","+c),a){var d=parseInt(a.trim());isNaN(d)||(zwrtc.headlessChromeXID=d)}},redial:function(a){zwrtc_mcupc.redial(a)},setResolution:function(a,b,c,d){this.cam_width=a,this.cam_height=b,this.cam_fps=c,this.screen=d},generateConstraint:function(a){var b={};if(zwrtc.audioSourceID?(b.audio={mandatory:{},optional:[]},b.audio.optional[0]={sourceId:zwrtc.audioSourceID},zwrtc.micEnabled=!0):("cam"!=this._confirmAV?b.audio=!0:b.audio=!1,zwrtc.micEnabled=!0),navigator.mozGetUserMedia||(b.data=!1),"cammic"==this._confirmAV||"cam"==this._confirmAV||this.screen)if(ConnectionManager.isEdge()){b.video={};var c=navigator.mediaDevices.getSupportedConstraints();b.video.width=this.cam_width,b.video.height=this.cam_height,c.facingMode&&(b.video.facingMode="user"),c.deviceId&&zwrtc.videoSourceID&&(b.video.deviceId=zwrtc.videoSourceID),c.frameRate&&(b.video.frameRate=this.cam_fps)}else if(ConnectionManager.isFF())b.video={},b.video.width={min:this.cam_width,ideal:this.cam_width,max:this.cam_width},b.video.height={min:this.cam_height,ideal:this.cam_height,max:480},zwrtc.videoSourceID&&(b.video.deviceId={exact:zwrtc.videoSourceID});else if(this.screen){b.video={mandatory:{},optional:[]};var d=2e3,e=screen.width,f=screen.height;e>d&&(f=Math.round(d*screen.height/screen.width),e=d),b.video.mandatory.chromeMediaSource="screen",b.video.mandatory.maxWidth=e,b.video.mandatory.maxHeight=f,b.video.mandatory.minFrameRate=this.cam_fps_min,b.video.mandatory.maxFrameRate=this.cam_fps,b.audio=!1}else b.video={},zwrtc.videoSourceID&&(b.video.deviceId={exact:zwrtc.videoSourceID}),b.video.width={exact:this.cam_width},b.video.height={exact:this.cam_height},ConnectionManager.webRTCBrowserVersion>=52?b.video.frameRate={max:this.cam_fps,min:this.cam_fps_min}:b.video.frameRate=this.cam_fps;else b.video=!1;return zwrtc.viewOnly&&(b.audio=!1,b.video=!1),this.log("Camera constraints are "+JSON.stringify(b)),this.log("stunserver_config:"+JSON.stringify(a)),navigator.mozGetUserMedia?zwrtc_mcupc.setResolutionConstraint(b,zwrtc.pcConfig):zwrtc_mcupc.setResolutionConstraint(b,a),webRTC.stunserver_config=zwrtc.pcConfig,b},setViewOnly:function(a){zwrtc.viewOnly||(zwrtc.viewOnly=a)},switchViewOnly:function(a){"PHONE"==zwrtc.audioSourceID&&(zwrtc.audioSourceID=null),this.setViewOnly(!0),webRTC.toggleAudioMute(),webRTC.disableVideo(),webRTC.localStream&&webRTC.localStream.stop(),webRTC.localStream=null,ConnectionManager._dispatchEvent("ZWRTC_VIDEO_MUTE_TOGGLED",{msg_string:"ZWRTC outgoing video muted",mute:!0}),ConnectionManager._dispatchEvent("ZWRTC_VIDEO_VIEW_ONLY",{msg_string:"ZWRTC outgoing video view only",mute:!0})},requestFullScreen:function(a){this.log("requestFullScreen:"+a),webRTC.doFullscreen(a)},cancelFullscreen:function(){webRTC.cancelFullscreen()},getResolution:function(){return this.viewVideoLocal?this.viewVideoLocal.videoWidth+"x"+this.viewVideoLocal.videoHeight:""},getP2PAddress:function(){return this.viewOnly?null:webRTC.getRoomID()},toggleVideoMute:function(){webRTC.toggleVideoMute()},toggleAudioMute:function(){webRTC.toggleAudioMute()},toggleSpkMute:function(){zwrtc_mcupc.toggleSpkMute()},getMediaElement:function(){return document.getElementById("toneAudioPlayer")},playSound:function(a,b,c){if(CallManager._flashEnabled)flashClient.playSound(a,b,c);else{var d=zwrtc.getMediaElement();d&&a&&(d.addEventListener("ended",zwrtc.soundComplete,!1),d.src=a,zwrtc._loop=b,zwrtc._loopGap=c,d.play())}},stopSound:function(){if(CallManager._flashEnabled)flashClient.stopSound();else{var a=zwrtc.getMediaElement();a&&(a.pause(),a.src="")}},soundComplete:function(){var a=this;zwrtc._loop&&(zwrtc._loopGap?setTimeout(function(){a.play()},parseInt(zwrtc._loopGap)):this.play())},getLocalStream:function(){return webRTC.localStream},stopStreamTracks:function(a){if(a){Platform.log("Stopping stream tracks : "+a.id);var b,c=!1,d=a.getAudioTracks(),e=a.getVideoTracks();for(b=0;b<d.length;b++)d[b].stop?(Platform.log("stoping audio track "+b),d[b].stop()):c=!0;for(b=0;b<e.length;b++)e[b].stop?(Platform.log("stoping video track "+b),e[b].stop()):c=!0;a.stop&&a.stop()}},getRemoteStream:function(){if(this.isP2P)webRTC.remoteStream;else if(this.isMCU)return zwrtc.getSMLObj()?zwrtc.getSMLObj().o_remote_stream:null;return null},isMcuIceConnected:function(){if(zwrtc.getSMLObj()){var a=zwrtc.getSMLObj().o_pc;if(a&&"connected"==a.iceConnectionState)return!0}return!1},isConnected:function(){return CallManager._flashEnabled?flashClient.isConnected():this._callConnected},isP2P:function(){return CallManager._flashEnabled?flashClient.isP2P():webRTC.isP2PEstablished()},isMCU:function(){return CallManager._flashEnabled?flashClient.isMCU():this.callEstablished},switchedToP2P:function(){this.callEstablished=!1,this._destination=null,this.callInitiated=!1,this.reconnectCounter=0,zwrtc._enableSFU||zwrtc._disableSML?rtcSFU.hangup():zwrtc_mcupc.hangup()},hangup:function(a){this._callConnected=!1,webRTC.onHangup(),zwrtc._enableSFU||zwrtc._disableSML?rtcSFU.hangup():zwrtc_mcupc.hangup(),navigator.webkitGetUserMedia&&this.addVideoTracks(),a||(this._destination=null,this.callInitiated=!1,ConnectionManager._dispatchEvent("ZWRTC_DISPLAY_MSG",{msg:"Call Ended"}),ConnectionManager._dispatchEvent("ZWRTC_CALL_ENDED",{msg:"Call Ended"}),zwrtc_mcupc.log("ZWRTC_CALL_TERMINATED"),zwrtc.reconnectCounter=0,zwrtc.callEstablished=!1,zwrtc.baseTimerTS=0),"cammic"!=zwrtc._confirmAV||zwrtc._video&&!this.p2p2mcu||(zwrtc._video=!0,webRTC.enableVideo()),zwrtc.peerAvatar=null,this.switched2p2p=!1,this.p2p2mcu=!1,zwrtc.finalTime=0,zwrtc.remoteStreamAttached=!1,zwrtc.stopDurationTimer(),this.closeHeadlessChrome()},unload:function(){zwrtc_mcupc.stopStack(),this.closeHeadlessChrome()},closeHeadlessChrome:function(){if(zwrtc.headlessChromeXID!=-1){var a=this.getZS()+"/zscrape/zscrape_end.jsp?xid="+zwrtc.headlessChromeXID;Platform.httpRequest("GET",a,null,null,null),zwrtc_mcupc.log("headlessURL:"+a)}zwrtc.headlessChromeXID=-1},log:function(a){zwrtc_mcupc.log(a)}},zwrtc_mcupc={oSipStack:null,oSipSessionCall:null,from:null,callGoingOn:!1,_pendingRedial:!1,_destination:null,_videoTracks:null,bitrateCheckTimer:null,bitrateCheckTimerDebug:null,connHealthCheckTimer:null,connCounter:0,audioCheckCounter:0,audioLossDuration:0,initSDK:function(a,b,c){zwrtc._enableSFU&&zwrtc._disableSML||SIPml.init(this.postInit)},postInit:function(){ConnectionManager._dispatchEvent("ZWRTC_SIP_INITIALIZED",{msg_string:"Ready to Start SIP Stack"})},setResolutionConstraint:function(a,b){zwrtc.getSMLObj()&&(zwrtc.getSMLObj().media_constraints=a,zwrtc.getSMLObj().o_iceServers=b)},reInitStack:function(a){if(zwrtc_mcupc.log("reInitStack"),zwrtc_mcupc.stopConnCheckTimer("INIT_STACK"),zwrtc.initialized&&"busy"!=ConnectionManager.zsState)return ConnectionManager._dispatchEvent("ZWRTC_PLACING_CALL_STEPS",{msg:"reInitStack  CANCEL "+zwrtc.initialized+" "+ConnectionManager.zsState}),zwrtc_mcupc.log("no call going on via zs, so donot reinitstack"),void zwrtc.stateUpdated({state:ConnectionManager.zsState});if(a?CallManager._dispatchEvent(CallManager.Event.INIT):zwrtc_mcupc.dispatchRedialEvent("Reinit Stack"),zwrtc._enableSFU||zwrtc._disableSML)return zwrtc.initialized=!0,void ConnectionManager._dispatchEvent("ZWRTC_SIP_STACK_STARTED",{msg_string:"Ready to place call to MCU"});if(null!=zwrtc_mcupc.oSipStack){zwrtc_mcupc.log("this.oSipStack!=null, stopping stack");var b=zwrtc_mcupc.oSipStack;zwrtc_mcupc.oSipSessionCall;try{b&&b.stop()}catch(c){zwrtc_mcupc.log("Error in stoping stack")}}zwrtc_mcupc.oSipStack=null,zwrtc_mcupc.oSipSessionCall=null,zwrtc_mcupc.log("new SIPml.Stack:"+zwrtc_mcupc.oSipStack+" "+zwrtc_mcupc.oSipSessionCall),null==zwrtc_mcupc.oSipStack&&(zwrtc_mcupc.oSipSessionCall=null,zwrtc.initialized=!1,zwrtc_mcupc.startStack(zwrtc.from,zwrtc.host,zwrtc.wrtc2sip_port))},startStack:function(a,b,c){zwrtc_mcupc.log("Inside startStack:from:"+a+" host:"+b+" port:"+c);var d=null,e="",f=null;if(zwrtc.mcuRecvdConnection=!1,zwrtc.mcuRecvdAudio=!1,zwrtc.mcuRecvdVideo=!1,ConnectionManager.getZS&&(f=ConnectionManager.getZS()),f)f.indexOf("https://")!=-1?(d="wss://",e=zwrtc.zsProxy?"/webrtc2sipssl/":":10062"):(d="ws://",e=zwrtc.zsProxy?"/webrtc2sip/":":10060");else{var g=document.location.protocol;d="ws://",e=zwrtc.zsProxy?"/webrtc2sip/":":10060","https:"==g&&(d="wss://",e=zwrtc.zsProxy?"/webrtc2sipssl/":":10062")}ConnectionManager._dispatchEvent("ZWRTC_DISPLAY_MSG",{msg:"Initializing..."});var h=d+b+e;zwrtc_mcupc.log("new SIPml.Stack");try{this.oSipStack=new SIPml.Stack({realm:b,impi:a,impu:"sip:"+a+"@"+b,password:a,display_name:a,websocket_proxy_url:h,outbound_proxy_url:null,ice_servers:null,enable_rtcweb_breaker:"true",events_listener:{events:"*",listener:this.onSipEventStack},enable_early_ims:"true",enable_media_stream_cache:"false",bandwidth:null,video_size:null,sip_headers:[{name:"User-Agent",value:"IM-client/OMA1.0 sipML5-v1.2013.08.10B"},{name:"Organization",value:"Zenon Telecom"}]})}catch(i){ConnectionManager._dispatchEvent("ZWRTC_PLACING_CALL_STEPS",{msg:"in start stack fail to call new "+i})}0!=this.oSipStack.start()&&(ConnectionManager._dispatchEvent("ZWRTC_PLACING_CALL_STEPS",{msg:"in start stack fail to start"}),ConnectionManager._dispatchEvent("ZWRTC_SIP_STACK_INIT_FAILED",{error_code_string:"Failed to start the SIP stack"}))},onSipEventStack:function(a){if(this!=zwrtc_mcupc.oSipStack)return zwrtc_mcupc.log("Ignoring ==stack event = "+a.type),void ConnectionManager._dispatchEvent("ZWRTC_PLACING_CALL_STEPS",{msg:" Ignoring "+a.type});switch(zwrtc_mcupc.log("==stack event = "+a.type),a.type){case"starting":break;case"started":!zwrtc.zsProxy&&zwrtc.getSMLObj()&&(zwrtc.getSMLObj().ttl_o_self=null),ConnectionManager._dispatchEvent("ZWRTC_SIP_STACK_STARTED",{msg_string:"Ready to place call to MCU"});break;case"m_permission_requested":break;case"m_permission_accepted":break;case"failed_to_start":ConnectionManager._dispatchEvent("ZWRTC_SIP_STACK_FAILED",{msg_string:"Failed to start sip stack"});break;case"stopped":zwrtc_mcupc.oSipStack=null,ConnectionManager._dispatchEvent("ZWRTC_SIP_STACK_STOPPED",{msg_string:"sip stack stopped"})}},onSipEventSession:function(a){if(a.session!=zwrtc_mcupc.oSipSessionCall)return zwrtc_mcupc.log("Ignoring ==session event = "+a.type),void ConnectionManager._dispatchEvent("ZWRTC_PLACING_CALL_STEPS",{msg:" Ignoring 2 "+a.type});switch(zwrtc_mcupc.log("==session event = "+a.type),a.type){case"i_ao_request":if(a.session==zwrtc_mcupc.oSipSessionCall){var b=a.getSipResponseCode();180!=b&&183!=b||ConnectionManager._dispatchEvent("ZWRTC_SIP_CALL_RINGING",{msg_string:"Remote ringing..."})}break;case"m_early_media":a.session==zwrtc_mcupc.oSipSessionCall&&ConnectionManager._dispatchEvent("ZWRTC_SIP_CALL_MEDIA_STARTED",{msg_string:"Early media started..."});break;case"terminated":a.session==zwrtc_mcupc.oSipSessionCall&&(zwrtc_mcupc.callGoingOn=!1,zwrtc_mcupc._pendingRedial?(zwrtc_mcupc._pendingRedial=!1,zwrtc_mcupc.placeCall(zwrtc._video,zwrtc_mcupc._destination,zwrtc.viewVideoLocal,zwrtc.rvArr[0][0],zwrtc.audio_remote)):(ConnectionManager._dispatchEvent("ZWRTC_SIP_CALL_TERMINATED",{msg_string:a.description}),ConnectionManager._dispatchEvent("ZWRTC_DISPLAY_MSG",{msg:"Call Terminated"})))}},startRecording:function(a){var b=DataStore.getUserData("username","");zwrtc.rndUser&&(b=zwrtc.rndUser);var c=null;c=ConnectionManager.getZS?ConnectionManager.getZS():"http://"+window.location.host,CallManager.orgDestination&&(a="VIDEODIAL%23"+CallManager.orgDestination);var d=c+"/webrtc/?command=startMcuStreamRecording&username="+b+"&service="+top.ConnectionManager.service+"&sessionid="+DataStore.getUserData("session_id","")+"&destination="+a;zwrtc_mcupc.log("startRecording:"+d),Platform.httpRequest("GET",d,null,null,null)},stopRecording:function(){var a=DataStore.getUserData("username",""),b=a;zwrtc.rndUser&&(a=zwrtc.rndUser);var c=null;c=ConnectionManager.getZS?ConnectionManager.getZS():"http://"+window.location.host;var d=c+"/webrtc/?command=stopMcuStreamRecording&username="+a+"&service="+top.ConnectionManager.service+"&sessionid="+DataStore.getUserData("session_id","")+"&orgusername="+b;zwrtc_mcupc.log("stopRecording:"+d),Platform.httpRequest("GET",d,null,null,null)},placeCall:function(a,b,c,d,e){if(zwrtc.mcuRecvdConnection=!1,zwrtc.mcuRecvdAudio=!1,zwrtc.mcuRecvdVideo=!1,zwrtc_mcupc.log(b),this._destination=b,zwrtc.lastMCUVideoPacketCount=-1,zwrtc.lastMCUAudioPacketCount=-1,webRTC.localVideo&&CallManager.updateOutgoingResol(webRTC.localVideo.videoWidth,webRTC.localVideo.videoHeight),"only"==zwrtc.proxyCam&&(a=!1),zwrtc._enableSFU||zwrtc._disableSML)return void rtcSFU.placeCall(DataStore.getUserData("username",""),zwrtc.host,b,!a,webRTC.localStream,c);zwrtc_mcupc.startConnCheckTimer(),zwrtc_mcupc.startStatsDebug();var f={audio_remote:e,video_local:c,video_remote:d,events_listener:{events:"*",listener:this.onSipEventSession},sip_caps:[{name:"+g.oma.sip-im"},{name:"+sip.ice"},{name:"language",value:'"en,fr"'}]};if(webRTC.localStream&&zwrtc.getSMLObj()&&(zwrtc.getSMLObj().o_stream=webRTC.localStream),zwrtc_mcupc.log("this.oSipStack:"+this.oSipStack+" this.oSipSessionCall:"+this.oSipSessionCall+" destination:"+b+" zwrtc_mcupc.callGoingOn:"+zwrtc_mcupc.callGoingOn),this.oSipStack&&!this.oSipSessionCall&&!tsk_string_is_null_or_empty(b)){if(zwrtc.failoverToMCU=!1,this.oSipSessionCall=this.oSipStack.newSession("call-audiovideo",f),0!=this.oSipSessionCall.call(b))return zwrtc_mcupc.log("Unable to place call to W2S"),zwrtc_mcupc.callGoingOn=!1,this.oSipSessionCall=null,zwrtc_mcupc.log("Failed to make call"),void(zwrtc.checkReconnect()?(zwrtc.initialized=!1,this.oSipStack&&(this.oSipStack.stop(),this.oSipStack=null),zwrtc_mcupc.reInitStack(!1)):(ConnectionManager._dispatchEvent("ZWRTC_SIP_CALL_FAILED",{msg_string:"Failed to place call to MCU",destination:b}),ConnectionManager._dispatchEvent("ZWRTC_DISPLAY_MSG",{msg:"Failed to place call to MCU"})));zwrtc_mcupc.log("Call placed to W2S"),zwrtc_mcupc.callGoingOn=!0,zwrtc.isP2P()||(zwrtc._callConnected=!1),ConnectionManager._dispatchEvent("ZWRTC_DISPLAY_MSG",{msg:"Connecting..."}),CallManager._dispatchEvent(CallManager.Event.CONNECTING,{type:"mcu"})}},checkMediaRecvd:function(){if(webRTC.isAudioMuted||!zwrtc.micEnabled||zwrtc.isUsingPhone()){if(zwrtc.mcuRecvdVideo||zwrtc.mcuRecvdAudio)return zwrtc_mcupc.audioStarted(),!0}else if(zwrtc.mcuRecvdVideo||zwrtc.mcuRecvdAudio)return zwrtc_mcupc.audioStarted(),!0;return!1},shadowConnected:function(){zwrtc_mcupc.log("shadowConnected recvd from MCU"),zwrtc.mp3user?(zwrtc_mcupc.connCounter=0,zwrtc_mcupc.audioLossDuration=(new Date).getTime()):zwrtc.viewOnly||zwrtc.screen?(zwrtc_mcupc.log("shadowConnected, calling audioStarted as one of the following is true,zwrtc.viewOnly || zwrtc.screen || webRTC.isAudioMuted || zwrtc.mcuRecvdAudio || not zwrtc.micEnabled "+zwrtc.micEnabled+" "+zwrtc.viewOnly+" "+zwrtc.screen+" "+webRTC.isAudioMuted+" "+zwrtc.mcuRecvdAudio),zwrtc_mcupc.audioStarted()):this.checkMediaRecvd()},audioStarted:function(){if(!zwrtc_mcupc.callGoingOn&&zwrtc.isP2P())return void zwrtc_mcupc.log("audioStarted recvd from MCU, no call going on or p2p engaged, so ignoring:"+zwrtc.isP2P());zwrtc._callConnected=!0,zwrtc.callEstablished=!0,zwrtc_mcupc.log("audioStarted recvd from MCU, stopping reconnect timer"),zwrtc_mcupc.stopConnCheckTimer("CONNECTED"),zwrtc_mcupc.log("ZWRTC_CALL_ESTABLISHED"),CallManager._dispatchEvent(CallManager.Event.CONNECTED,{type:"mcu"}),ConnectionManager._dispatchEvent("ZWRTC_CALL_ESTABLISHED",{msg_string:""});var a="Voice ";zwrtc._video&&(a="Video "),a+="call in progress",ConnectionManager._dispatchEvent("ZWRTC_DISPLAY_MSG",{msg:a}),zwrtc.startDurationTimer(),zwrtc.checkVideoDisabled(),zwrtc.placeProxyCall()},startConnCheckTimer:function(){var a="startConnCheckTimer:connHealthCheckTimer:"+this.connHealthCheckTimer+" allowCallRetry:"+zwrtc.allowCallRetry+" p2p2mcu:"+zwrtc.p2p2mcu;if(zwrtc_mcupc.log(a),!this.connHealthCheckTimer&&zwrtc.allowCallRetry&&!zwrtc.p2p2mcu){var b=0,c=0,d=0;zwrtc_mcupc.audioLossDuration=0;var e=0;zwrtc.mcuRecvdAudio=!1,zwrtc.mcuRecvdVideo=!1,zwrtc.mcuRecvdConnection=!1,zwrtc.remoteStreamAttached=!1,ConnectionManager._dispatchEvent("ZWRTC_MONITOR_START",{msg:a}),this.connHealthCheckTimer=setInterval(function(){if(zwrtc_mcupc.log(" CHECK "+zwrtc_mcupc.oSipStack+" "+zwrtc_mcupc.callGoingOn+" "+zwrtc_mcupc.connCounter),zwrtc_mcupc.oSipStack&&zwrtc_mcupc.callGoingOn){if(zwrtc_mcupc.oSipSessionCall&&zwrtc_mcupc.callGoingOn&&zwrtc.getSMLObj()){var a=zwrtc.getSMLObj().o_pc;a&&a.getRemoteStreams()[0]?a.getStats?a.getStats(function(f){for(var g=f.result(),h=!1,i=0;i<g.length;++i){var j=g[i];if((!j.local||j.local===j)&&"ssrc"==j.type&&j.stat("googJitterReceived")){var k=j.stat("googTrackId"),l=(parseInt(j.stat("packetsLost")),parseInt(j.stat("packetsReceived")),parseInt(j.stat("audioOutputLevel"))),m=parseInt(j.stat("bytesReceived"));if("zenon@audio"==k){if(h=!0,c>0){var n=Math.round(8*(m-b)/(j.timestamp-c));d=n}c=j.timestamp,b=m,zwrtc_mcupc.log("Audio Bitrate Recvd:"+d+"kbps audioOutputLevel:"+l+"iceConnectionState:"+a.iceConnectionState+" iceGatheringState:"+a.iceGatheringState);var o=(new Date).getTime();if(!zwrtc.isUsingPhone()&&d<10&&l<5)zwrtc_mcupc.checkRedial("bitrate and output level too low");else if(0==e)e=o;else if(o-e>5e3){if(zwrtc_mcupc.log("Audio worked fine for 5sec, so closing timer"),ConnectionManager._dispatchEvent("ZWRTC_MCU_AUDIO_RECEIVED",{msg_string:""}),zwrtc_mcupc.log("ZWRTC_MCU_AUDIO_RECEIVED"),zwrtc_mcupc.checkMediaRecvd())return;zwrtc_mcupc.checkRedial("Audio Recvd from MCU but check Audio zebra from MCU")}}}}h||zwrtc_mcupc.checkRedial("not found zenon@audio googTrackId")}):zwrtc_mcupc.checkRedial("stats not available"):zwrtc_mcupc.checkRedial("remote stream not available")}}else zwrtc_mcupc.connCounter++,zwrtc_mcupc.log("Stack not initialized or call not placed:"+zwrtc_mcupc.connCounter),zwrtc_mcupc.connCounter>zwrtc.connectTimeout&&(zwrtc_mcupc.log("Stack not started till "+zwrtc.connectTimeout+"sec, reinitialize stack"),zwrtc_mcupc.connCounter=0,zwrtc_mcupc.reInitStack(!1))},1e3)}},startStatsDebug:function(){zwrtc.getSMLObj()&&(this.bitrateCheckTimerDebug&&clearInterval(this.bitrateCheckTimerDebug),this.bitrateCheckTimerDebug=setInterval(function(){var a=zwrtc.getSMLObj().o_pc;a&&a.getRemoteStreams()[0]&&a.getStats&&a.getStats(function(a){for(var b=a.result(),c=0;c<b.length;c++){var d=b[c];if(!d.local||d.local===d){if("ssrc"==d.type&&d.stat("googTrackId").indexOf("video")>-1){var e=DateTimeUtil.getNow(),f=1e3;CallManager._ssDetected&&(f=6e3),zwrtc.isMCU()&&d.stat("bytesReceived")==zwrtc.lastMCUVideoPacketCount&&e-zwrtc.lastMCUVideoPacketChangeTime>zwrtc.startStatsDebugTimeout+f&&e-zwrtc.lastMCUAudioPacketChangeTime<zwrtc.startStatsDebugTimeout+f&&e-zwrtc.lastMCURedial>zwrtc.lastMCURedialMinRepeat&&(zwrtc.redial(4),zwrtc.lastMCURedial=e),zwrtc.lastMCUVideoPacketCount!=d.stat("bytesReceived")&&(zwrtc.lastMCUVideoPacketChangeTime=DateTimeUtil.getNow(),zwrtc.lastMCUVideoPacketCount=d.stat("bytesReceived"))}"ssrc"==d.type&&d.stat("googTrackId").indexOf("audio")>-1&&(d.stat("bytesReceived")!=zwrtc.lastMCUAudioPacketCount&&(zwrtc.lastMCUAudioPacketChangeTime=DateTimeUtil.getNow()),zwrtc.lastMCUAudioPacketCount=d.stat("bytesReceived"))}}})},zwrtc.startStatsDebugTimeout))},dispatchRedialEvent:function(a){zwrtc_mcupc.log("ZWRTC_RECONNECT:"+a),ConnectionManager._dispatchEvent("ZWRTC_RECONNECT",{msg:a})},checkRedial:function(a){zwrtc_mcupc.log("checkRedial:"+a);var b=(new Date).getTime();if(zwrtc.checkReconnect())if(0==zwrtc_mcupc.audioLossDuration)zwrtc_mcupc.audioLossDuration=b;else{var c=1e3*zwrtc.audioTimeout;if(0!=zwrtc.reconnectCounter||zwrtc.remoteStreamAttached||(c=1e3*zwrtc.remoteMediaAttachTimeout),zwrtc_mcupc.log("timeout:"+c+" zwrtc.remoteStreamAttached:"+zwrtc.remoteStreamAttached+" c:"+zwrtc.reconnectCounter),b-zwrtc_mcupc.audioLossDuration>c)return void zwrtc_mcupc.stopConnCheckTimer("REDIAL")}else zwrtc_mcupc.log("checkRedial:reconnect not required")},stopConnCheckTimer:function(a){zwrtc_mcupc.log("stopConnCheckTimer"+zwrtc_mcupc.connCounter+" "+a),zwrtc_mcupc.connCounter=0,zwrtc_mcupc.connHealthCheckTimer&&(clearInterval(zwrtc_mcupc.connHealthCheckTimer),"REDIAL"==a?(zwrtc_mcupc.audioLossDuration=0,zwrtc_mcupc.audioCheckCounter++,zwrtc_mcupc.redial(5)):"CONNECTED"==a?zwrtc_mcupc.audioCheckCounter=0:"INIT_STACK"==a||(a="HANGUP"),ConnectionManager._dispatchEvent("ZWRTC_MONITOR_STOP",{msg:a})),zwrtc_mcupc.connHealthCheckTimer=null},stopBitrateCheckTimer:function(){zwrtc_mcupc.bitrateCheckTimer&&clearInterval(zwrtc_mcupc.bitrateCheckTimer)},startIceStateCheckTimer:function(){zwrtc.getSMLObj()&&(this.bitrateCheckTimer=setInterval(function(){var a=zwrtc.getSMLObj().o_pc;a&&zwrtc_mcupc.log("startIceStateCheckTimer:iceConnectionState:"+a.iceConnectionState+" iceGatheringState:"+a.iceGatheringState)},1e3))},startBitrateCheckTimer:function(){zwrtc_mcupc.log("startBitrateCheckTimer");var a=0,b=0,c=0,d=0;zwrtc.getSMLObj()&&(this.bitrateCheckTimer=setInterval(function(){var e=zwrtc.getSMLObj().o_pc;e&&e.getRemoteStreams()[0]&&e.getStats&&e.getStats(function(e){for(var f=e.result(),g=0;g<f.length;++g){var h=f[g];if((!h.local||h.local===h)&&"ssrc"==h.type&&h.stat("googFrameHeightReceived")){var i=parseInt(h.stat("bytesReceived"));if(b>0){var j=Math.round(8*(i-a)/(h.timestamp-b));c=j}b=h.timestamp,a=i;var k=parseInt(h.stat("packetsLost")),l=parseInt(h.stat("packetsReceived")),m=h.stat("googTrackId");if("zenon@video"==m&&k>l&&c>0){var n=(new Date).getTime();if(0==d)d=n;else if(n-d>5e3)return d=0,zwrtc_mcupc.log("packetsLost:"+k+" > packetsReceived:"+l+" for more then 5sec, redialling as audio only"),zwrtc_mcupc.stopBitrateCheckTimer(),zwrtc._video=!1,void zwrtc_mcupc.redial(1);zwrtc_mcupc.log("packetsLost:"+k+" > packetsReceived:"+l+" , switch to audio only call")}else d=0,zwrtc_mcupc.log("packetsLost:"+k+" < packetsReceived:"+l+" , normal call going on")}}})},1e3))},redial:function(a){this.log("Mcu Call going on "+zwrtc_mcupc.callGoingOn+" "+a),zwrtc.reconnectCounter=zwrtc.reconnectCounter+1,zwrtc.audioTimeout<zwrtc.audioTimeoutMax&&(zwrtc.audioTimeout=zwrtc.audioTimeoutMax),zwrtc.mcuRecvdConnection=!1,zwrtc.mcuRecvdAudio=!1,zwrtc.mcuRecvdVideo=!1,zwrtc.remoteStreamAttached=!1,ConnectionManager._dispatchEvent("ZWRTC_REDIAL",{msg:" caller "+a}),this.callGoingOn?(this._pendingRedial=!0,this.hangup(),zwrtc_mcupc.reInitStack(!1)):(zwrtc_mcupc.dispatchRedialEvent("Redialling"),this.placeCall(zwrtc._video,this._destination,zwrtc.viewVideoLocal,zwrtc.rvArr[0][0],zwrtc.audio_remote))},toggleSpkMute:function(){if(zwrtc.getSMLObj()&&zwrtc.getSMLObj().o_remote_stream){this.log("Found remote stream");var a=zwrtc.getSMLObj().o_remote_stream.getAudioTracks();if(0===a.length)return void this.log("No remote audio available.");for(i=0;i<a.length;i++)a[i].enabled?(this.log("Muting audio track "+i),a[i].enabled=!1):(this.log("UnMuting audio track "+i),a[i].enabled=!0)}},hangup:function(){this.log("hangup:"+this._pendingRedial),zwrtc_mcupc.callGoingOn=!1;var a=this.oSipStack,b=this.oSipSessionCall;this.oSipStack=null,this.oSipSessionCall=null;try{if(b)try{b.hangup({events_listener:{events:"*",listener:this.onSipEventSession}})}catch(c){}try{zwrtc.getSMLObj()&&zwrtc.getSMLObj().o_pc&&zwrtc.getSMLObj().o_pc.close()}catch(c){}a&&a.stop()}catch(c){zwrtc_mcupc.log("Error in stoping stack")}this._pendingRedial||(zwrtc_mcupc.audioCheckCounter=0),navigator.webkitGetUserMedia&&this.addVideoTracks(),zwrtc_mcupc.stopBitrateCheckTimer(),zwrtc_mcupc.stopConnCheckTimer(null)},stopStack:function(){this.hangup(),this.oSipStack&&(this.oSipStack.stop(),this.oSipStack=null)},log:function(a){}},swfobject=function(){function a(){if(!S){try{var a=L.getElementsByTagName("body")[0].appendChild(r("span"));a.parentNode.removeChild(a)}catch(b){return}S=!0;for(var c=O.length,d=0;d<c;d++)O[d]()}}function b(a){S?a():O[O.length]=a}function c(a){if(typeof K.addEventListener!=D)K.addEventListener("load",a,!1);else if(typeof L.addEventListener!=D)L.addEventListener("load",a,!1);else if(typeof K.attachEvent!=D)s(K,"onload",a);else if("function"==typeof K.onload){var b=K.onload;K.onload=function(){b(),a()}}else K.onload=a}function d(){}function e(){N?f():g()}function f(){var a=L.getElementsByTagName("body")[0],b=r(E);b.setAttribute("type",H);var c=a.appendChild(b);if(c){var d=0;!function(){if(typeof c.GetVariable!=D){var e=c.GetVariable("$version");e&&(e=e.split(" ")[1].split(","),V.pv=[parseInt(e[0],10),parseInt(e[1],10),parseInt(e[2],10)])}else if(d<10)return d++,void setTimeout(arguments.callee,10);a.removeChild(b),c=null,g()}()}else g()}function g(){var a=P.length;if(a>0)for(var b=0;b<a;b++){var c=P[b].id,d=P[b].callbackFn,e={success:!1,id:c};if(V.pv[0]>0){var f=q(c);if(f)if(!t(P[b].swfVersion)||V.wk&&V.wk<312)if(P[b].expressInstall&&i()){var g={};g.data=P[b].expressInstall,g.width=f.getAttribute("width")||"0",g.height=f.getAttribute("height")||"0",f.getAttribute("class")&&(g.styleclass=f.getAttribute("class")),f.getAttribute("align")&&(g.align=f.getAttribute("align"));for(var l={},m=f.getElementsByTagName("param"),n=m.length,o=0;o<n;o++)"movie"!=m[o].getAttribute("name").toLowerCase()&&(l[m[o].getAttribute("name")]=m[o].getAttribute("value"));j(g,l,c,d)}else k(f),d&&d(e);else v(c,!0),d&&(e.success=!0,e.ref=h(c),d(e))}else if(v(c,!0),d){var p=h(c);p&&typeof p.SetVariable!=D&&(e.success=!0,e.ref=p),d(e)}}}function h(a){var b=null,c=q(a);if(c&&"OBJECT"==c.nodeName)if(typeof c.SetVariable!=D)b=c;else{var d=c.getElementsByTagName(E)[0];d&&(b=d)}return b}function i(){return!T&&t("6.0.65")&&(V.win||V.mac)&&!(V.wk&&V.wk<312)}function j(a,b,c,d){T=!0,z=d||null,A={success:!1,id:c};var e=q(c);if(e){"OBJECT"==e.nodeName?(x=l(e),y=null):(x=e,y=c),a.id=I,(typeof a.width==D||!/%$/.test(a.width)&&parseInt(a.width,10)<310)&&(a.width="310"),(typeof a.height==D||!/%$/.test(a.height)&&parseInt(a.height,10)<137)&&(a.height="137"),L.title=L.title.slice(0,47)+" - Flash Player Installation";var f=V.ie&&V.win?"ActiveX":"PlugIn",g="MMredirectURL="+encodeURI(window.location).toString().replace(/&/g,"%26")+"&MMplayerType="+f+"&MMdoctitle="+L.title;if(typeof b.flashvars!=D?b.flashvars+="&"+g:b.flashvars=g,V.ie&&V.win&&4!=e.readyState){var h=r("div");c+="SWFObjectNew",h.setAttribute("id",c),e.parentNode.insertBefore(h,e),e.style.display="none",function(){4==e.readyState?e.parentNode.removeChild(e):setTimeout(arguments.callee,10)}()}m(a,b,c)}}function k(a){if(V.ie&&V.win&&4!=a.readyState){var b=r("div");a.parentNode.insertBefore(b,a),b.parentNode.replaceChild(l(a),b),a.style.display="none",function(){4==a.readyState?a.parentNode.removeChild(a):setTimeout(arguments.callee,10)}()}else a.parentNode.replaceChild(l(a),a)}function l(a){var b=r("div");if(V.win&&V.ie)b.innerHTML=a.innerHTML;else{var c=a.getElementsByTagName(E)[0];if(c){var d=c.childNodes;if(d)for(var e=d.length,f=0;f<e;f++)1==d[f].nodeType&&"PARAM"==d[f].nodeName||8==d[f].nodeType||b.appendChild(d[f].cloneNode(!0))}}return b}function m(a,b,c){var d,e=q(c);if(V.wk&&V.wk<312)return d;if(e)if(typeof a.id==D&&(a.id=c),V.ie&&V.win){var f="";for(var g in a)a[g]!=Object.prototype[g]&&("data"==g.toLowerCase()?b.movie=a[g]:"styleclass"==g.toLowerCase()?f+=' class="'+a[g]+'"':"classid"!=g.toLowerCase()&&(f+=" "+g+'="'+a[g]+'"'));var h="";for(var i in b)b[i]!=Object.prototype[i]&&(h+='<param name="'+i+'" value="'+b[i]+'" />');e.outerHTML='<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"'+f+">"+h+"</object>",Q[Q.length]=a.id,d=q(a.id)}else{var j=r(E);j.setAttribute("type",H);for(var k in a)a[k]!=Object.prototype[k]&&("styleclass"==k.toLowerCase()?j.setAttribute("class",a[k]):"classid"!=k.toLowerCase()&&j.setAttribute(k,a[k]));for(var l in b)b[l]!=Object.prototype[l]&&"movie"!=l.toLowerCase()&&n(j,l,b[l]);e.parentNode.replaceChild(j,e),d=j}return d}function n(a,b,c){var d=r("param");d.setAttribute("name",b),d.setAttribute("value",c),a.appendChild(d)}function o(a){var b=q(a);b&&"OBJECT"==b.nodeName&&(V.ie&&V.win?(b.style.display="none",function(){4==b.readyState?p(a):setTimeout(arguments.callee,10)}()):b.parentNode.removeChild(b))}function p(a){var b=q(a);if(b){for(var c in b)"function"==typeof b[c]&&(b[c]=null);b.parentNode.removeChild(b)}}function q(a){var b=null;try{b=L.getElementById(a)}catch(c){}return b}function r(a){return L.createElement(a)}function s(a,b,c){a.attachEvent(b,c),R[R.length]=[a,b,c]}function t(a){var b=V.pv,c=a.split(".");return c[0]=parseInt(c[0],10),c[1]=parseInt(c[1],10)||0,c[2]=parseInt(c[2],10)||0,b[0]>c[0]||b[0]==c[0]&&b[1]>c[1]||b[0]==c[0]&&b[1]==c[1]&&b[2]>=c[2]}function u(a,b,c,d){if(!V.ie||!V.mac){var e=L.getElementsByTagName("head")[0];if(e){var f=c&&"string"==typeof c?c:"screen";if(d&&(B=null,C=null),!B||C!=f){var g=r("style");g.setAttribute("type","text/css"),g.setAttribute("media",f),B=e.appendChild(g),V.ie&&V.win&&typeof L.styleSheets!=D&&L.styleSheets.length>0&&(B=L.styleSheets[L.styleSheets.length-1]),C=f}V.ie&&V.win?B&&typeof B.addRule==E&&B.addRule(a,b):B&&typeof L.createTextNode!=D&&B.appendChild(L.createTextNode(a+" {"+b+"}"));
}}}function v(a,b){if(U){var c=b?"visible":"hidden";S&&q(a)?q(a).style.visibility=c:u("#"+a,"visibility:"+c)}}function w(a){var b=/[\\\"<>\.;]/,c=null!=b.exec(a);return c&&typeof encodeURIComponent!=D?encodeURIComponent(a):a}var x,y,z,A,B,C,D="undefined",E="object",F="Shockwave Flash",G="ShockwaveFlash.ShockwaveFlash",H="application/x-shockwave-flash",I="SWFObjectExprInst",J="onreadystatechange",K=window,L=document,M=navigator,N=!1,O=[d],P=[],Q=[],R=[],S=!1,T=!1,U=!0,V=function(){var a=typeof L.getElementById!=D&&typeof L.getElementsByTagName!=D&&typeof L.createElement!=D,b=M.userAgent.toLowerCase(),c=M.platform.toLowerCase(),d=c?/win/.test(c):/win/.test(b),e=c?/mac/.test(c):/mac/.test(b),f=!!/webkit/.test(b)&&parseFloat(b.replace(/^.*webkit\/(\d+(\.\d+)?).*$/,"$1")),g=!1,h=[0,0,0],i=null;if(typeof M.plugins!=D&&typeof M.plugins[F]==E)i=M.plugins[F].description,!i||typeof M.mimeTypes!=D&&M.mimeTypes[H]&&!M.mimeTypes[H].enabledPlugin||(N=!0,g=!1,i=i.replace(/^.*\s+(\S+\s+\S+$)/,"$1"),h[0]=parseInt(i.replace(/^(.*)\..*$/,"$1"),10),h[1]=parseInt(i.replace(/^.*\.(.*)\s.*$/,"$1"),10),h[2]=/[a-zA-Z]/.test(i)?parseInt(i.replace(/^.*[a-zA-Z]+(.*)$/,"$1"),10):0);else if(typeof K.ActiveXObject!=D)try{var j=new ActiveXObject(G);j&&(i=j.GetVariable("$version"),i&&(g=!0,i=i.split(" ")[1].split(","),h=[parseInt(i[0],10),parseInt(i[1],10),parseInt(i[2],10)]))}catch(k){}return{w3:a,pv:h,wk:f,ie:g,win:d,mac:e}}();(function(){V.w3&&((typeof L.readyState!=D&&"complete"==L.readyState||typeof L.readyState==D&&(L.getElementsByTagName("body")[0]||L.body))&&a(),S||(typeof L.addEventListener!=D&&L.addEventListener("DOMContentLoaded",a,!1),V.ie&&V.win&&(L.attachEvent(J,function(){"complete"==L.readyState&&(L.detachEvent(J,arguments.callee),a())}),K==top&&!function(){if(!S){try{L.documentElement.doScroll("left")}catch(b){return void setTimeout(arguments.callee,0)}a()}}()),V.wk&&!function(){if(!S)return/loaded|complete/.test(L.readyState)?void a():void setTimeout(arguments.callee,0)}(),c(a)))})(),function(){V.ie&&V.win&&window.attachEvent("onunload",function(){for(var a=R.length,b=0;b<a;b++)R[b][0].detachEvent(R[b][1],R[b][2]);for(var c=Q.length,d=0;d<c;d++)o(Q[d]);for(var e in V)V[e]=null;V=null;for(var f in swfobject)swfobject[f]=null;swfobject=null})}();return{registerObject:function(a,b,c,d){if(V.w3&&a&&b){var e={};e.id=a,e.swfVersion=b,e.expressInstall=c,e.callbackFn=d,P[P.length]=e,v(a,!1)}else d&&d({success:!1,id:a})},getObjectById:function(a){if(V.w3)return h(a)},embedSWF:function(a,c,d,e,f,g,h,k,l,n){var o={success:!1,id:c};V.w3&&!(V.wk&&V.wk<312)&&a&&c&&d&&e&&f?(v(c,!1),b(function(){d+="",e+="";var b={};if(l&&typeof l===E)for(var p in l)b[p]=l[p];b.data=a,b.width=d,b.height=e;var q={};if(k&&typeof k===E)for(var r in k)q[r]=k[r];if(h&&typeof h===E)for(var s in h)typeof q.flashvars!=D?q.flashvars+="&"+s+"="+h[s]:q.flashvars=s+"="+h[s];if(t(f)){var u=m(b,q,c);b.id==c&&v(c,!0),o.success=!0,o.ref=u}else{if(g&&i())return b.data=g,void j(b,q,c,n);v(c,!0)}n&&n(o)})):n&&n(o)},switchOffAutoHideShow:function(){U=!1},ua:V,getFlashPlayerVersion:function(){return{major:V.pv[0],minor:V.pv[1],release:V.pv[2]}},hasFlashPlayerVersion:t,createSWF:function(a,b,c){return V.w3?m(a,b,c):void 0},checkVersion:function(){return V.w3?e():void 0},showExpressInstall:function(a,b,c,d){V.w3&&i()&&j(a,b,c,d)},removeSWF:function(a){V.w3&&o(a)},createCSS:function(a,b,c,d){V.w3&&u(a,b,c,d)},addDomLoadEvent:b,addLoadEvent:c,getQueryParamValue:function(a){var b=L.location.search||L.location.hash;if(b){if(/\?/.test(b)&&(b=b.split("?")[1]),null==a)return w(b);for(var c=b.split("&"),d=0;d<c.length;d++)if(c[d].substring(0,c[d].indexOf("="))==a)return w(c[d].substring(c[d].indexOf("=")+1))}return""},expressInstallCallback:function(){if(T){var a=q(I);a&&x&&(a.parentNode.replaceChild(x,a),y&&(v(y,!0),V.ie&&V.win&&(x.style.display="block")),z&&z(A)),T=!1}}}}(),wrtcSetting={audioSource:[],videoSource:[],phoneList:[],noVideo:"None (Audio Only)",stringNVSS:"No Video Source Selected",stringVSSF:"Failed To Access Video Source",stringVSD:"Video Source Disabled",stringRVP:"Refresh Video Preview",stringPMA:"Preview My Audio",stringRL:"Refresh Lists",stringHDL:"Hold down to listen",stringCamera:"Camera",stringMic:"Microphone",stringAudio:"Audio",stringVideo:"Video",stringBwLow:"Your system check passed, but we detected a slow connection which will affect the quality of your calls.",stringUDPFW:"Your system check passed, but we detected a strict firewall in place which will affect the quality of your calls. You may wish to discuss opening port 14049 for UDP with your network administrator",stringTechPass:"Your system will provide a good online meeting experience",stringCamHelp:"Please make sure you have checked all available webcams in the drop down and that there is at least one webcam available on your computer. If you see your webcam listed but do not see yourself here please make sure your webcam is not being used by another application e.g. Skype.",stringErrNoCamMic:"We could not detect a working webcam or mic on your computer. You can still proceed but will need to use your telephone to connect and won't be seen by other call and meeting participants.",stringNoWorkingCam:"Although we can detect a webcam on your machine, we can't get a video stream from it. In order to continue you will need to check that your cam is not being used elsewhere (you will need to free it from the other browser or application and refresh the page), or select None (Audio only) from the drop down",stringErrNoCam:"We could not detect a working webcam on your computer. You can still proceed but won't be seen by other call and meeting participants.",stringErrNoMic:"We could not detect a working microphone on your computer. You can still proceed but will need to use your telephone to connect. You will then be able to use your telephone for the audio part of your meeting. Your screen will be used to view other participants and share files and messages.<br><br>If you want to try plugging in a microphone you will need to refresh the page for it to be picked up.",localStream:null,deviceListPopulated:!1,cam_disabled:!1,mic_disabled:!1,camcaptureLV:null,ratio:1.333,twoDCtx:null,camcap2DCanvas:null,CONTINUE:"continue",CONTINUE_VOICE:"continuewithvoice",CONTINUE_VIEW:"continuewithview",settingState:"continue",tpDialog:!1,mediaDenied:!1,usingPhone:!1,usingNoCam:!1,_pendingSelectDevice:!1,_pendingAccessMedia:!1,_micOnly:!1,_showListenBtn:!1,_rtcCheckPassed:!1,_spkDetectionCheck:!1,_bwDetection:!1,_bwDetectionInProgress:!1,_state:null,_kspeedValue:0,_kspeedValueMax:100,_kspeedValueInc:1,_kspeedWaitLarge:100,_kspeedWaitSmall:15,_kMicValue:0,_kMicChanged:0,_kMicContinueDisabled:!0,_kMicMoving:!1,_kspeedWait:100,_kspeedColor:"#999",_kspeedNumberColor:"#aaa",_kMicUpdated:0,_kMicUpdatedMinDelta:30,_techCheckAddr:"TC1",_kspeedStart:1,_repositionLoader:!0,_cookieRTCCheck:"techcheck.webrtccheck",_cookieBwdCheck:"techcheck.bwdcheck",_cookieSpkCheck:"techcheck.spkcheck",_cookieMicCheck:"techcheck.miccheck",_cookieCamCheck:"techcheck.camcheck",_cookieTechCheck:"techcheck.devices",_cookieRead:!1,_cookieTestPassed:!1,_showViewOnly:!1,_rtcSipObj:null,_assetPath:"/user",_httpsCheckDone:!1,ignoreSummary:!0,localeUpdated:!1,init:function(){if(this.loadLocale(),navigator.userAgent.indexOf("MSIE 8")>-1&&(this._kspeedValueInc=4,this._kspeedWaitLarge=400,this._kspeedWaitSmall=60,this._kMicUpdatedMinDelta=300,this._kspeedStart=6e3),$("#zcdiv").hasClass("front_client")||$("#zcdiv").addClass("front_client"),!this._cookieRead){if(this._cookieRead=!0,this._spkDetectionCheck&&(zwrtc.webrtcCheck=!0),!CallManager._flashEnabled&&zwrtc.webrtcCheck){var a=ConnectionManager.readCookie(this.getCookieName(this._cookieRTCCheck));this.log("RTCCheck cookie:"+a),"pass"==a?zwrtc.webrtcCheck=!1:"fail"==a&&(CallManager._flashEnabled=!0)}var b=ConnectionManager.readCookie(this.getCookieName(this._cookieTechCheck));if(this.log("Device cookie:"+b),null!=b&&"fail"!=b){var c=JSON.parse(b);c.audioSourceID&&c.videoSourceID&&(zwrtc.audioSourceID=c.audioSourceID,zwrtc.videoSourceID=c.videoSourceID,this._cookieTestPassed=!0)}}zwrtc._useCustomGUI&&(this._assetPath="user"),$("#cam_pic").hide(),this.callZInit&&(this._bwDetection=!1,this._spkDetectionCheck=!1,zwrtc.webrtcCheck=!1),this._bwDetection?(this.hideAllowPic(),this.doBandwidthTest()):zwrtc.webrtcCheck&&!CallManager._flashEnabled?(this.hideAllowPic(),this.doWebRTCConnectionTest()):this.checkSetting()},getString:function(a,b){return Z.zjs.ZLocale&&Z.zjs.ZLocale.getString?Z.zjs.ZLocale.getString(a,b):b},loadLocale:function(){this.localeUpdated||(this.localeUpdated=!0,this.stringCamera=this.getString("webcam_camera_select",this.stringCamera),this.stringMic=this.getString("microphone_select",this.stringMic),this.stringCamHelp=this.getString("webcam_check_help_message",this.stringCamHelp),this.stringBwLow=this.getString("alert_system_check_slow_connection",this.stringBwLow),this.stringUDPFW=this.getString("alert_system_check_firewall",this.stringUDPFW),this.stringNVSS=this.getString("zjs_no_video_src_selected",this.stringNVSS),this.noVideo=this.getString("zjs_none_audio_only",this.noVideo))},hideAllowPic:function(){$("#allow_pic").removeClass("ainit"),$("#allow_pic").hide()},showAllowPic:function(){(navigator.mozGetUserMedia||"http:"==window.location.protocol)&&($("#allow_pic").addClass("ainit"),setTimeout(function(){$("#allow_pic").hasClass("ainit")&&($("#allow_pic").show(),$("#webrtc_warn_txt").show())},4e3))},getCookieName:function(a){var b=a+"."+DataStore.getUserData("remote_ip","")+"."+ConnectionManager.service;return CallManager._flashEnabled&&(b+=".flash"),b},resetTechCookie:function(){ConnectionManager.createCookie(this.getCookieName(this._cookieBwdCheck),"fail",1),ConnectionManager.createCookie(this.getCookieName(this._cookieRTCCheck),"null",1),ConnectionManager.createCookie(this.getCookieName(this._cookieTechCheck),"fail",1),this._cookieRead=!1,this._cookieTestPassed=!1,this._bwDetection=!0,this._micTestDone=!1},doBandwidthTest:function(){var a=ConnectionManager.readCookie(wrtcSetting.getCookieName(wrtcSetting._cookieBwdCheck));if(a&&"fail"!=a){var b=JSON.parse(a);flashClient._bwdDone=!0,b.up?flashClient._userUp=b.up:flashClient._userUp=0,b.down?flashClient._userDown=b.down:flashClient._userDown=0,b.cup&&(flashClient._calculatedUp=b.cup),b.cdown&&(flashClient._calculatedDown=b.cdown),wrtcSetting._bwDetection=!1,wrtcSetting.bwdDone(!0)}else ConnectionManager.addListener("ZWRTC_BW_DETECTION_DONE",wrtcSetting,wrtcSetting.bandwidthDetected),ConnectionManager.addListener("ZWRTC_BW_DETECTION_STARTED",wrtcSetting,function(){wrtcSetting._kspeedValueInc=1}),$("#wrtc_bwd_test_title").show(),$("#wrtc_bwd_test").show(),$("#flash_allow_deny_span").hide(),$("#flash_allow_deny_loading").hide(),setTimeout(function(){wrtcSetting._kspeedValueInc=.3,wrtcSetting.showRTCCheckSym("kspeed"),wrtcSetting._bwDetectionInProgress=!0,flashClient.startBandwidthDetection()},wrtcSetting._kspeedStart)},bandwidthDetected:function(a){ConnectionManager.removeListener("ZWRTC_BW_DETECTION_DONE",this,this.bandwidthDetected),this._bwDetectionInProgress=!1,this._bwDetection=!1;var b=1;this._kspeedValue<wrtcSetting._kspeedValueMax&&(this._kspeedWait=wrtcSetting._kspeedWaitSmall,b=1e3+(wrtcSetting._kspeedValueMax-this._kspeedValue)*this._kspeedWait),setTimeout(function(){wrtcSetting.bandwidthDetectedComplete(a)},b)},bandwidthDetectedComplete:function(a){$("#flash_allow_deny_loading").hide(),$("#flash_allow_deny_span").hide(),$("#kspeed_div").hide(),$("#wbwdtest_btn").show(),$("#wbwdtestagain_btn").show();a&&a.flash?a.up<180||a.down<180?($("#img_tech_result").attr("src",this._assetPath+"/images/wrtc_set_cross.png"),$(".webrtc_tech_result").text(this.getString("title_test_failed","Test Failed")),$("#wbwdtest_btn").hide(),$("#wbwdtestagain_btn").show(),$("#bwdResultInfo").html(this.getString("tech_check_fail_message","Your connection is currently too slow.<br>Please try plugging in an internet cable<br>or getting closer to the router if using WiFi.")+"<br><b>"+this.getString("up_speed_text","Up Speed")+":</b> "+a.up+"kbps &nbsp;&nbsp; <b>"+this.getString("down_speed_text","Down Speed")+":</b> "+a.down+"kbps")):a.proto&&"UDP"==a.proto?a.up<300||a.down<300?($(".webrtc_tech_result").text("Warning"),$("#img_tech_result").attr("src",this._assetPath+"/images/wrtc_set_warn.png"),$("#wbwdtest_btn").show(),$("#wbwdtestagain_btn").show(),$("#bwdResultInfo").html("Your connection is currently very slow.<br>Please try plugging in an internet cable<br>or getting closer to the router if using WiFi.<br><b>Up Speed:</b> "+a.up+"kbps &nbsp;&nbsp; <b>Down Speed:</b> "+a.down+"kbps")):wrtcSetting.ignoreSummary?this.bwdDone():($("#img_tech_result").attr("src",this._assetPath+"/images/wrtc_set_yes.png"),$(".webrtc_tech_result").text("Test Passed"),$("#wbwdtest_btn").show(),$("#wbwdtestagain_btn").show(),$("#bwdResultInfo").html("Please keep as close as possible to the router if using WiFi<br><b>Up Speed:</b> "+a.up+"kbps &nbsp;&nbsp; <b>Down Speed:</b>"+a.down+"kbps")):($("#img_tech_result").attr("src",this._assetPath+"/images/wrtc_set_warn.png"),$(".webrtc_tech_result").text("Warning"),$("#wbwdtest_btn").show(),$("#wbwdtestagain_btn").show(),$("#bwdResultInfo").html("You appear to be behind a strict firewall.<br>Although your calls should still connect, please get<br>as close as possible to the router if using WiFi.<br><b>Up Speed:</b> "+a.up+"kbps &nbsp;&nbsp; <b>Down Speed:</b> "+a.down+"kbps")):($("#bwdResultInfo")[0].innerHTML="Unable to proceed without Adobe Flash",CallManager._flashEnabled?($("#img_tech_result").attr("src",this._assetPath+"/images/wrtc_set_cross.png"),$(".webrtc_tech_result").text("Test Failed"),$("#bwdResultInfo")[0].innerHTML=$("#bwdResultInfo")[0].innerHTML+"<br><br><a href='http://get.adobe.com/flashplayer/' target='_blank'>Please install Adobe Flash</a>",$("#wbwdtest_btn").hide(),$("#wbwdtestagain_btn").hide()):this.bwdDone()),$("#img_tech_result").show(),$("#bwdResultInfo").show(),$("#bwdResultTitle").show(),$("#bwdResultDiv").show()},performBwTest:function(){$("#wbwdtest_btn").hide(),$("#wbwdtestagain_btn").hide(),$("#bwdResultInfo").hide(),$("#bwdResultTitle").hide(),this.doBandwidthTest()},bwdDone:function(a){if(!a&&flashClient._bwdDone){var b=!1;if(CallManager._flashEnabled?flashClient._userUp>300&&flashClient._userDown>300&&(b=!0):flashClient._userUp>180&&flashClient._userDown>180&&(b=!0),b){var c={up:flashClient._userUp,down:flashClient._userDown,cup:flashClient._calculatedUp,cdown:flashClient._calculatedDown};this.log("Dumping BwdCheck Cookie:"+c),ConnectionManager.createCookie(this.getCookieName(this._cookieBwdCheck),JSON.stringify(c),1)}}$("#wrtc_bwd_test_title").hide(),$("#wrtc_bwd_test").hide(),this.showRTCCheckSym(),this.init()},getSipDestination:function(a){var b=CallManager.getServerIP()+":"+DataStore.getUserData("mcu_sip_port","");return"sip:"+a+"@"+b},placeTechCheckCall:function(a){this.hangupRTCCall(),this._rtcSipObj=new rtcMedia,this._rtcSipObj._viewOnly=!0,this._rtcSipObj.initSDK("","",zwrtc.stunserver_config,!1,"TECH_CHECK");var b=CallManager.getServerIP(),c=DataStore.getUserData("username","");a||(this._rtcSipObj.addAudioTrack=!0),rtcSFU._useMcuZebra?this._rtcSipObj.placeCall(c,b,this._techCheckAddr,!0,a):this._rtcSipObj.placeCall(c,b,this.getSipDestination(this._techCheckAddr),!0,a)},doWebRTCConnectionTest:function(){this.showRTCCheckSym(),this._rtcCheckPassed=!1,ConnectionManager.addListener("ZWRTC_REMOTE_STREAM_ATTACHED",this,this.rtcCheckDone);var a=this,b=setInterval(function(){null!=ConnectionManager.zsState&&"disconnected"!=ConnectionManager.zsState&&(b&&clearInterval(b),a.placeTechCheckCall(),setTimeout(function(){a.checkCallConnected(!0)},15e3))},1e3)},checkCallConnected:function(a){if(!this._rtcCheckPassed){var b=null;this._rtcSipObj&&(b=this._rtcSipObj.peerConnection),!b||"connected"!=b.iceConnectionState&&"completed"!=b.iceConnectionState?a&&!CallManager._flashEnabled&&(this.testCallIceCheck&&clearInterval(this.testCallIceCheck),this.log("RTC Check failed, dumping false to cookieRTCCheck"),ConnectionManager.createCookie(this.getCookieName(this._cookieRTCCheck+"_time"),(new Date).toLocaleString(),1),ConnectionManager.createCookie(this.getCookieName(this._cookieRTCCheck),"fail",1),CallManager._flashEnabled=!0,this.hangupRTCCall(),this.checkSetting()):(this.testCallIceCheck&&clearInterval(this.testCallIceCheck),this._rtcCheckPassed=!0,this.checkSetting())}},rtcCheckDone:function(){ConnectionManager.removeListener("ZWRTC_REMOTE_STREAM_ATTACHED",this,this.rtcCheckDone);var a=this;this.testCallIceCheck=setInterval(function(){a.checkCallConnected(!1)},1e3)},kspeed_update:function(){setTimeout(function(){$("#kspeed").val(wrtcSetting._kspeedValue+=wrtcSetting._kspeedValueInc).trigger("change"),wrtcSetting._kspeedValue<wrtcSetting._kspeedValueMax&&wrtcSetting.kspeed_update()},wrtcSetting._kspeedWait)},showRTCCheckSym:function(a){if($("#webrtc_warn_txt").hide(),a&&"kspeed"==a)$("#kspeed").knob({fgColor:wrtcSetting._kspeedColor,inputColor:wrtcSetting._kspeedNumberColor,readOnly:!0,width:150,min:0,draw:function(){$(this.i).val(this.cv+"%")},max:100}),wrtcSetting._kspeedValue=0,wrtcSetting._kspeedWait=wrtcSetting._kspeedWaitLarge,wrtcSetting.kspeed_update(),CallManager.zui||($("#kspeed_div").css("top","37px"),$("#kspeed_div").css("left","173px")),$("#kspeed_div").show();else{if($("#flash_allow_deny_loading").hasClass("custom")&&(this._repositionLoader=!1),this._repositionLoader){var b=($("#zcdiv").height()-$("#flash_allow_deny_loading").height())/2;$("#flash_allow_deny_loading").css("top",b+"px"),$("#flash_allow_deny_loading").css("left","222px")}$("#flash_allow_deny_loading").show(),$("#flash_allow_deny_span").show()}},hideRTCCheckSym:function(){$("#flash_allow_deny_loading").hasClass("custom")&&(this._repositionLoader=!1),this._repositionLoader&&($("#flash_allow_deny_loading").css("top",""),$("#flash_allow_deny_loading").css("left","")),$("#flash_allow_deny_loading").hide(),$("#flash_allow_deny_span").hide(),$("#kspeed_div").hide()},checkSetting:function(){if(zwrtc.viewOnly=!1,CallManager._flashEnabled?flashClient.init($("#sp_flash_container"),"sp_flash",!0):(ConnectionManager._dispatchEvent("CONTINUE_AS_WEBRTC",{msg:""}),ConnectionManager.createCookie(this.getCookieName(this._cookieRTCCheck),"pass",1)),zwrtc.showTechCheck)this.initSetting();else try{initWebRTCSDK()}catch(a){}},initSetting:function(){ConnectionManager.addListener("ZWRTC_MEDIA_ACCESS_ABORTED",this,this.mediaAborted),ConnectionManager.addListener("SETTING_DEVICELIST_POPULATED",this,devicePopulated),ConnectionManager.addListener("SETTING_DISPLAY_FP_ALLOW_DENY",this,this.displayFPAllowDeny),ConnectionManager.addListener("ZEBRA:TECHCHECK_STATS",this,this.techCheckStatus),CallManager._flashEnabled||ConnectionManager.addListener("SETTING_SHOW_DEVICE_LIST",this,this.displayDeviceList),this._spkDetectionCheck?this._cookieTestPassed?(CallManager._flashEnabled&&ConnectionManager._dispatchEvent("ZWRTC_SETTING_SPK_TEST_DONE"),this.speakerTestPassed(!0)):CallManager._flashEnabled?(ConnectionManager.addListener("FLASH_SPK_TEST_CALL_PLACED",this,this.speakerDetection),ConnectionManager._dispatchEvent("ZWRTC_SETTING_DO_SPK_TEST")):this._rtcCheckPassed?this.speakerDetection():(ConnectionManager.addListener("ZWRTC_REMOTE_STREAM_ATTACHED",this,this.speakerDetection),this.placeTechCheckCall(),this.showRTCCheckSym()):this.displaySettingDialog()},moveKmic:function(){wrtcSetting._kMicMoving=!0,setTimeout(function(){$("#kmic").val()!=wrtcSetting._kMicValue&&wrtcSetting.setKmic(parseInt($("#kmic").val())+(parseInt($("#kmic").val())>wrtcSetting._kMicValue?-1:1)),$("#kmic").val()!=wrtcSetting._kMicValue?wrtcSetting.moveKmic():wrtcSetting._kMicMoving=!1},parseInt($("#kmic").val())>wrtcSetting._kMicValue?30:15)},setKmic:function(a){if(!(Z.zjs.DateTimeUtil.getNow()-wrtcSetting._kMicUpdated<wrtcSetting._kMicUpdatedMinDelta)){wrtcSetting._kMicUpdated=Z.zjs.DateTimeUtil.getNow(),$("#kmic").val(a).trigger("change");var b="#9dd53a";a>95&&(b="red"),$("#kmic").trigger("configure",{fgColor:b})}},techCheckStatus:function(a){var b=a.getZEvent("vad").value,c=0;Z.zjs.DateTimeUtil.getNow()-wrtcSetting._kMicChanged<3e3?c=0:b<8e3?c=15*(b/8e3):b<35e4?(c=15+85*((b-8e3)/35e4),$("#wmictestcont_btn").removeClass("disabled"),$("#img_tech_mic").show(),wrtcSetting._kMicContinueDisabled=!1):c=95,!wrtcSetting._kMicContinueDisabled&&c<20&&(c=5)},muteSpk:function(){CallManager._flashEnabled?flashClient.muteSpkAudio(!0):$("#settingLocalVideo")[0].muted=!0},unmuteSpk:function(){CallManager._flashEnabled?flashClient.muteSpkAudio(!1):$("#settingLocalVideo")[0].muted=!1},speakerDetection:function(){CallManager._flashEnabled?ConnectionManager.removeListener("FLASH_SPK_TEST_CALL_PLACED",this,this.speakerDetection):ConnectionManager.removeListener("ZWRTC_REMOTE_STREAM_ATTACHED",this,this.speakerDetection),this.hideRTCCheckSym(),$("#wrtc_cam_title").hide(),$("#wrtc_spk_test_title").show(),$("#webrtc_setting").hide(),$("#wrtc_spk_test").show(),this.hideAllowPic(),this._rtcSipObj&&this._rtcSipObj.attachMediaStream($("#settingLocalVideo")[0],this._rtcSipObj.remoteStream)},testSpeaker:function(){try{Z.zjs.LineStatesModel.sendDTMF("1")}catch(a){}this.unmuteSpk(),$("#wrtc_spk_testing").show(),$("#wspktest_btn").hide(),$("#wspktesting_btn").show()},showMicTestDialog:function(){if(this.showRTCCheckSym(),this._state="MIC_TEST_INIT",this._cookieTestPassed){if(CallManager._flashEnabled){$("#sp_flash_container").addClass("pushed"),$("#sp_flash_container").width(1),$("#sp_flash_container").height(1),ConnectionManager.removeListener("FLASH_SHOW_MIC_TEST",this,this.showMicTestDialog);var a=zwrtc.videoSourceID,b=zwrtc.audioSourceID;zwrtc.micEnabled||(b=-1),(this.cam_disabled||this.usingNoCam)&&(a=-1),ConnectionManager._dispatchEvent("SETTING_DEVICES_CHANGED",{audioSourceID:b,videoSourceID:a})}this.micTestPassed(!0)}else CallManager._flashEnabled?($("#sp_flash_container").addClass("pushed"),$("#sp_flash_container").width(1),$("#sp_flash_container").height(1),ConnectionManager.removeListener("FLASH_SHOW_MIC_TEST",this,this.showMicTestDialog),this.updatedMicCall()):this.readDeviceList()},speakerTestPassed:function(a){a||ConnectionManager.createCookie(this.getCookieName(this._cookieSpkCheck),"pass",1),this.muteSpk();try{Z.zjs.LineStatesModel.sendDTMF("1")}catch(b){}$("#wrtc_spk_testing").hide(),$("#wspktesting_btn").hide(),$("#wrtc_spk_test").hide(),$("#wrtc_spk_test_title").hide(),$("#webrtc_warn_txt").hide(),ConnectionManager.addListener("mic_activity",this,this.onMicActivity),$("#micOnlyCombo").on("change",this.micChanged),CallManager._flashEnabled?(ConnectionManager._dispatchEvent("HANGUP_TC_CALL",{msg:""}),ConnectionManager.addListener("FLASH_SHOW_MIC_TEST",this,this.showMicTestDialog),this.displayFPAllowDeny()):this.showMicTestDialog()},enableAudioTrack:function(a,b){if(a){var c=a.getAudioTracks();for(i=0;i<c.length;i++)c[i]&&(c[i].enabled=b)}},startMicActivityCheck:function(){return this.initiateMicActivity(this.localStream,"mic_activity")},useP2PMicActivity:function(){var a=ConnectionManager.webRTCBrowserVersion;return ConnectionManager.isFF()&&a>=60||ConnectionManager.isChrome()&&a>=75||ConnectionManager.isSafari()},initiateMicActivity:function(a,b){if(CallManager._flashEnabled)return this.stopMicActivityCheck(),flashClient.startMicSampling(b);if(a)try{if(null==this.audioContext)if("undefined"!=typeof AudioContext)this.audioContext=new AudioContext;else{if("undefined"==typeof webkitAudioContext)return;this.audioContext=new webkitAudioContext}if(this.audioContext){this.stopMicActivityCheck(),this.useP2PMicActivity()&&P2PMicActivity.connect(a,b),this.microphone=this.audioContext.createMediaStreamSource(a),this.microphoneStream=a;return this.enableAudioTrack(a,!0),null==this.javascriptNode&&(this.audioContext.createJavaScriptNode?this.javascriptNode=this.audioContext.createJavaScriptNode(2048,1,1):this.audioContext.createScriptProcessor&&(this.javascriptNode=this.audioContext.createScriptProcessor(2048,1,1)),this.microphone.connect(this.javascriptNode),this.javascriptNode.connect(this.audioContext.destination),this.javascriptNode.onaudioprocess=function(a){const c=a.inputBuffer.getChannelData(0);for(var d=0,e=0;e<c.length;++e)d+=c[e]*c[e];var f=Math.round(Math.sqrt(d/c.length)*rtcSFU.rmsToVadMul);f>255&&(f=255),rtcSFU.onaudioprocess(f);var g={max:f,min:1,from:"rtc"};ConnectionManager.userId&&(g.userId=ConnectionManager.userId),ConnectionManager._dispatchEvent(b,g)}),!0}return!1}catch(c){}return!1},disconnectWebAudioNodes:function(){null!=this.microphone&&(this.microphone.disconnect(this.javascriptNode),delete this.microphone),null!=this.javascriptNode&&(this.javascriptNode.disconnect(this.audioContext.destination),this.javascriptNode=null)},stopMicActivityCheck:function(){this.useP2PMicActivity()&&P2PMicActivity.hangup(),CallManager._flashEnabled&&flashClient.stopMicSampling(),this.disconnectWebAudioNodes()},onMicActivity:function(a){if(a){var b=a.max;a.min;"rtc"==a.from?wrtcSetting._kMicValue=100*(b-30)/256:wrtcSetting._kMicValue=100*b,wrtcSetting._kMicValue=Math.ceil(wrtcSetting._kMicValue/5),wrtcSetting._kMicValue=5*wrtcSetting._kMicValue,wrtcSetting.setKmic(parseInt(wrtcSetting._kMicValue)),wrtcSetting._kMicValue>2&&($("#wmictestcont_btn").removeClass("disabled"),$("#img_tech_mic").show(),wrtcSetting._kMicContinueDisabled=!1)}},accessMicMedia:function(a){try{a&&a.stop()}catch(b){}if(!this._httpsCheckDone&&(this._httpsCheckDone=!0,"https:"==window.location.protocol)){var c={};return c.video=!0,c.audio=!0,void getUserMedia(c,this.accessMicMedia.bind(this),this.accessMicMedia.bind(this))}var c={};c.video=!1,navigator.mozGetUserMedia&&null!=zwrtc.audioSourceID?c.audio=!0:(c.data=!1,c.audio={mandatory:{},optional:[]},c.audio.optional[0]={sourceId:zwrtc.audioSourceID}),CallManager._flashEnabled||(this.showAllowPic(),getUserMedia(c,this.onMicMediaSuccess.bind(this),this.onMicMediaFailed.bind(this)),this.dispatchAccessingHwd())},onMicMediaSuccess:function(a){this.dispatchAccessingHwdDone(),this.hideAllowPic(),wrtcSetting.localStream=a,ConnectionManager.addListener("ZWRTC_REMOTE_STREAM_ATTACHED",this,this.updatedMicCall),this.placeTechCheckCall(a)},onMicMediaFailed:function(a){$("#flash_allow_deny_loading").hide(),this.hideAllowPic(),this.dispatchAccessingHwdDone(),wrtcSetting.localStream=null,this.hangupRTCCall(),this.updatedMicCall()},updatedMicCall:function(){return this._micTestDone?void this.hangupRTCCall():($("#micOnlyCombo")[0].disabled=!1,$("#mic_act_label").css("opacity",1),!CallManager._flashEnabled&&this._rtcSipObj&&this._rtcSipObj.remoteStream&&this._rtcSipObj.attachMediaStream($("#settingLocalVideo")[0],this._rtcSipObj.remoteStream),this.muteSpk(),ConnectionManager.removeListener("ZWRTC_REMOTE_STREAM_ATTACHED",this,this.updatedMicCall),this.hideRTCCheckSym(),this.startMicActivityCheck(),$("#wrtc_mic_test_title").show(),$("#wrtc_mic_test").show(),$("#kmic").knob({fgColor:"#66CC66",displayInput:!1,readOnly:!0,angleOffset:-125,angleArc:250,width:100,height:80,min:0,max:100}),this.showMicSelection(),void $("#webrtc_warn_txt").hide())},micTestFailed:function(){this._micTestDone=!0,$("#wrtc_mic_test_title").hide(),$("#wrtc_mic_test").hide(),this.hangupRTCCall(),zwrtc.audioSourceID="PHONE",this.displaySettingDialog()},showMicHelp:function(){$("#wrtc_mic_call_div").hide(),$("#wrtc_mic_testing").show(),showMicSelection()},showMicSelection:function(){if(CallManager._flashEnabled){var a=$("#spFPLClient")[0].getDeviceList(!0);if(a){var b=wrtcSetting.audioSource,c=wrtcSetting.videoSource;b.length=0,c.length=0;for(var d=0;d!=a.length;++d){var e=a[d];if(wrtcSetting.log(e.kind+" "+e.label+" "+e.id),"audio"===e.kind){var f=e.label||"microphone "+b.length;b[b.length]={id:e.id,label:f}}else if("video"===e.kind){var f=e.label||"camera "+c.length;c[c.length]={id:e.id,label:f}}}}}this.updateMicCombo()},updateMicCombo:function(){$("#micOnlyCombo option").remove();for(var a=wrtcSetting.audioSource,b=0;b<a.length;b++){var c=a[b];c.id==zwrtc.audioSourceID?$("#micOnlyCombo").append($("<option selected></option>").attr("value",c.id).text(c.label)):$("#micOnlyCombo").append($("<option ></option>").attr("value",c.id).text(c.label))}$("#micOnlyCombo").append($("<option ></option>").attr("value","PHONE").text(this.getString("zjs_telephone","Telephone"))),0==a.length?($("#wmictestcont_btn").removeClass("disabled"),zwrtc.audioSourceID="PHONE",$("#mic_act").hide(),$("#nomic").show()):null==zwrtc.audioSourceID&&(zwrtc.audioSourceID=a[0].id)},micChanged:function(){if($("#wmictestcont_btn").addClass("disabled"),$("#img_tech_mic").hide(),wrtcSetting._kMicContinueDisabled=!0,wrtcSetting._kMicChanged=Z.zjs.DateTimeUtil.getNow(),wrtcSetting.setKmic(0),wrtcSetting.log("Selected Microphone:"+$("#micOnlyCombo option:selected").text()),zwrtc.audioSourceID=$("#micOnlyCombo option:selected").val(),"PHONE"==zwrtc.audioSourceID)$("#wmictestcont_btn").removeClass("disabled"),$("#mic_act").hide(),$("#nomic").show();else if(CallManager._flashEnabled){$("#mic_act").show(),$("#nomic").hide();var a=zwrtc.videoSourceID,b=zwrtc.audioSourceID;zwrtc.micEnabled||(b=-1),(wrtcSetting.cam_disabled||wrtcSetting.usingNoCam)&&(a=-1),ConnectionManager._dispatchEvent("SETTING_DEVICES_CHANGED",{audioSourceID:b,videoSourceID:a})}else $("#mic_act").show(),$("#nomic").hide(),$("#micOnlyCombo")[0].disabled=!0,$("#mic_act_label").css("opacity",0),wrtcSetting.accessMicMedia()},micTestPassed:function(a){return this._micTestDone=!0,!a&&(null!=zwrtc.audioSourceID&&"PHONE"!=zwrtc.audioSourceID&&ConnectionManager.createCookie(this.getCookieName(this._cookieMicCheck),zwrtc.audioSourceID,1),this.stopMicActivityCheck(),$("#wmictestcont_btn").hasClass("disabled"))?($("#micOnlyCombo")[0].disabled=!1,void Platform.showMessageX("Microphone Check","You cannot be heard. Please speak into your microphone.",!0)):($("#wrtc_mic_test_title").hide(),$("#wrtc_mic_test").hide(),this.hangupRTCCall(),void this.displaySettingDialog())},noWorkingCam:function(){wrtcSetting.displayLVMsg(!0,wrtcSetting.stringVSSF),CallManager._flashEnabled&&$("#sp_flash_container").addClass("pushed"),Platform.showMessageX(this.getString("title_webcam_check","Webcam Check"),this.stringNoWorkingCam,!1,function(){$("#sp_flash_container").removeClass("pushed")})},camHelp:function(){Platform.showMessageX(this.getString("title_webcam_check","Webcam Check"),this.stringCamHelp,!1,function(){$("#sp_flash_container").removeClass("pushed")})},hangupRTCCall:function(){this._rtcSipObj&&(this._rtcSipObj.hangup(),zwrtc.hangup()),this._rtcSipObj=null},displaySettingDialog:function(){if(this.hideRTCCheckSym(),this.unmuteSpk(),$("#webrtc_warn_txt").hide(),$("#camCombo").change(camMicChanged),this.hangupRTCCall(),this._spkDetectionCheck){if(this.showRTCCheckSym(),this._cookieTestPassed)return this.deviceListPopulated=!1,this._state=null,$("#tc_btn").show(),$("#micCombo").change(camMicChanged),CallManager._flashEnabled&&!this.callZInit?flashClient.displaySettingDialog():this.accessMedia(zwrtc.videoSourceID,zwrtc.audioSourceID),void(this._showViewOnly&&$("#cview_link").show());$("#wrtc_cam_title").text(this.getString("title_webcam_check","Webcam Check")),$("#asComboTd").hide(),$("#cav_btn").html(this.getString("webcam_button_yes","Yes")),$("#cam_act_label").show(),$("#cavhelp_btn").show(),this._camCheckEnabled=!0}else $("#micCombo").change(camMicChanged),$("#cav_btn").html(this.getString("techcheck_continue_button_name","Continue")),this._showViewOnly&&$("#cview_link").show();CallManager._flashEnabled&&!this.callZInit?flashClient.displaySettingDialog():(ConnectionManager._dispatchEvent("SETTING_INITIALIZE"),this._spkDetectionCheck&&this.deviceListPopulated&&wrtcSetting.videoSource&&0==wrtcSetting.videoSource.length?(this.deviceListPopulated=!1,this.mediaAborted()):(this.deviceListPopulated=!1,this._state=null,this.accessMedia(zwrtc.videoSourceID,zwrtc.audioSourceID)))},displayDeviceList:function(){for(var a=wrtcSetting.audioSource,b=wrtcSetting.videoSource,c="Camera",d="Microphone",e=0;e<a.length;e++){
var f=a[e];f.id==zwrtc.audioSourceID&&(d=f.label)}wrtcSetting.usingPhone&&(d=this.getString("zjs_telephone","Telephone"));for(var e=0;e<b.length;e++){var f=b[e];f.id==zwrtc.videoSourceID&&(c=f.label)}wrtcSetting.usingNoCam&&(c=wrtcSetting.noVideo),$("#dw_devicelist_container")[0].innerHTML="<br><span>&nbsp;<b>Video:</b></span><input type='text' style='width:70%;margin-left:10px;' id='dw_cam_txt' value='"+c+"' disabled><br><br><span>&nbsp;<b>Audio:</b></span><input type='text' style='width:70%;margin-left:10px;' value='"+d+"' id='dw_mic_txt' disabled>"},getZoomFactor:function(){try{if(1!=DetectZoom.ratios().zoom)return 100*DetectZoom.ratios().zoom}catch(a){return 100}return"undefined"!=typeof screen&&"undefined"!=typeof screen.deviceXDPI&&"undefined"!=typeof screen.systemXDPI&&screen.deviceXDPI!=screen.systemXDPI?screen.deviceXDPI/screen.systemXDPI*100:Math.round(window.outerWidth/window.innerWidth*100)},toggleVideoMute:function(){this.tpDialog?wrtcSetting.usingNoCam||webRTC.toggleVideoMute():webRTC.toggleVideoMute()},toggleAudioMute:function(){this.tpDialog?this.usingPhone||webRTC.toggleAudioMute():webRTC.toggleAudioMute()},dispatchAccessingHwd:function(){ConnectionManager._dispatchEvent("SETTING_ACCESSING_DEVICES")},dispatchAccessingHwdDone:function(){ConnectionManager._dispatchEvent("SETTING_ACCESSING_DEVICES_DONE")},displayFPAllowDeny:function(a){this.dispatchAccessingHwd();var b=216,c=138,d=this.getZoomFactor();(isNaN(d)||d>=100&&d<=105)&&(d=100),a&&a.stageSmall&&(d-=10);var e=100/d;if(!$("#flash_allow_deny_loading").hasClass("custom")){var f=($("#zcdiv").height()-$("#flash_allow_deny_loading").height())/2,g=($("#zcdiv").width()-$("#flash_allow_deny_loading").width())/2;$("#flash_allow_deny_loading").css("top",f+"px"),$("#flash_allow_deny_loading").css("left",g+"px")}if($("#flash_allow_deny_loading").show(),d>70){if(d<100){b*=e,c*=e;var h=$("#zcdiv").width(),i=$("#zcdiv").height(),j=(h-b)/2,k=50;d<=80&&(k=(i-c)/2);var l=95,m=64;d>80&&(l=120,m=44);var n=i-m;$(".flash_allow_deny").width(b),$(".flash_allow_deny").height(c),$(".flash_allow_deny").css("top",k+"px"),$(".flash_allow_deny").css("left",j+"px"),$(".flash_save_btn_container").css("top",n+"px"),$(".flash_save_btn_container").height(m),$("#flash_save_btn").css("width",l+"px")}d>80?($("#webrtc_warn_txt").removeClass("webrtc_warn_spacer"),$("#webrtc_warn_txt").addClass("webrtc_warn_spacer_flash"),$("#webrtc_warn_txt").show(),flashClient.showAllowArrow()):($("#webrtc_warn_txt")[0].innerHTML="",$("#webrtc_warn_txt").hide()),$("#flash_save_btn_cont").show(),ConnectionManager._dispatchEvent("INIT_ALLOW_DENY",{msg:""}),$("#sp_flash_container").show()}else $("#webrtc_warn_txt")[0].innerHTML="Please Increase your browser zoom & refresh",$("#webrtc_warn_txt").show(),$("#sp_flash_container").hide();$("#resizeme").hide(),$("#webrtc_main").show(),$("#webRTCControls").hide()},mediaAborted:function(){this.mediaDenied=!0,devicePopulated()},isMicDisabled:function(){return!!this.mic_disabled},muteCamera:function(a){var b=null;if(this.localStream&&(b=this.localStream.getVideoTracks()),null==b)return this.log("No local video available."),!1;for(i=0;i<b.length;i++)b[i].enabled=!a},muteMicrophone:function(a){var b=null;if(this.localStream&&(b=this.localStream.getAudioTracks()),null==b)return this.log("No local audio available."),!1;for(i=0;i<b.length;i++)b[i].enabled=!a},getMediaConstraints:function(a,b,c,d,e,f,g,h){var i={};if("PHONE"===h?(this.usingPhone=!0,ConnectionManager._dispatchEvent("SETTING_PHONE_SELECTED",null)):this.usingPhone=!1,"NONE"===g?this.usingNoCam=!0:this.usingNoCam=!1,this.cam_disabled&&this.isMicDisabled())return void ConnectionManager._dispatchEvent("WRTC_SETTING_MEDIA_ACCESS_DISABLED",{msg_string:"Ready to display setting dialog"});var j=ConnectionManager.readCookie("confirmAV");if("msg"===j?(this.mic_disabled=!0,this.cam_disabled=!0):"mic"===j&&(this.cam_disabled=!0),this.isMicDisabled()||0==this.audioSource.length&&null==this.localStream&&"PHONE"==h)i.audio=!1,zwrtc.micEnabled=!1;else if(ConnectionManager.isFF())i.audio={},zwrtc.audioSourceID?i.audio.deviceId={exact:zwrtc.audioSourceID}:i.audio=!0,zwrtc.micEnabled=!0;else if(ConnectionManager.isEdge()){i.audio={};var k=navigator.mediaDevices.getSupportedConstraints();k.deviceId&&zwrtc.audioSourceID?i.audio.deviceId=zwrtc.audioSourceID:i.audio=!0,zwrtc.micEnabled=!0}else ConnectionManager.isSafari()?(i.audio={},zwrtc.audioSourceID?i.audio.deviceId={exact:zwrtc.audioSourceID}:i.audio=!0,zwrtc.micEnabled=!0):(i.audio={mandatory:{},optional:[]},i.audio.optional[0]={sourceId:zwrtc.audioSourceID},ConnectionManager.isUsingPlugin&&(i.audio.optional[1]={echoCancellation:!0}),zwrtc.micEnabled=!0);if(this.cam_disabled||this.usingNoCam)i.video=!1;else if(ConnectionManager.isFF())i.video={},i.video.width={min:c,ideal:a,max:a},i.video.height={min:d,ideal:b,max:480},zwrtc.videoSourceID&&(i.video.deviceId={exact:zwrtc.videoSourceID});else if(ConnectionManager.isEdge()){i.video={};var k=navigator.mediaDevices.getSupportedConstraints();i.video.width=a,i.video.height=b,k.facingMode&&(i.video.facingMode="user"),k.deviceId&&zwrtc.videoSourceID&&(i.video.deviceId=zwrtc.videoSourceID),k.frameRate&&(i.video.frameRate=e)}else i.data=!1,i.video={},ConnectionManager.isUsingPlugin?(i.video.width={exact:640},i.video.height={exact:480},zwrtc.videoSourceID&&(i.video.deviceId={exact:zwrtc.videoSourceID})):ConnectionManager.isSafari()?(i.video.width=a,i.video.height=480,zwrtc.videoSourceID&&(i.video.deviceId={exact:zwrtc.videoSourceID})):(zwrtc.videoSourceID&&(i.video.deviceId={exact:zwrtc.videoSourceID}),i.video.width={exact:a},i.video.height={exact:b},ConnectionManager.webRTCBrowserVersion>=52?i.video.frameRate={max:e,min:f}:i.video.frameRate=e);return i},accessMedia:function(a,b){var c=this.getMediaConstraints(zwrtc.cam_width,zwrtc.cam_height,zwrtc.cam_width,zwrtc.cam_height,zwrtc.cam_fps,zwrtc.cam_fps_min,a,b);if(this.log("Camera constraints are "+JSON.stringify(c)),CallManager._flashEnabled){var d=zwrtc.videoSourceID,e=zwrtc.audioSourceID;zwrtc.micEnabled||(e=-1),(this.cam_disabled||this.usingNoCam)&&(d=-1),ConnectionManager._dispatchEvent("SETTING_DEVICES_CHANGED",{audioSourceID:e,videoSourceID:d}),this._pendingSelectDevice?(this.selectDevice(),$("#sp_flash_container").removeClass("pushed")):ConnectionManager._dispatchEvent("WRTC_SETTING_MEDIA_ACCESS_GRANTED",{msg_string:"Ready to display setting dialog"})}else this.showAllowPic(),!c||c.video||c.audio?(getUserMedia(c,this.onUserMediaSuccess.bind(this),this.onUserMediaError.bind(this)),this._pendingAccessMedia=!0,this.dispatchAccessingHwd()):this.onUserMediaError({code:""})},onUserMediaSuccess:function(a){this.hideAllowPic(),this.dispatchAccessingHwdDone(),wrtcSetting.localStream=a,wrtcSetting.localStream&&attachMediaStream($("#settingLocalVideo")[0],wrtcSetting.localStream),setTimeout(function(){var a=$("#settingLocalVideo")[0].videoWidth,b=$("#settingLocalVideo")[0].videoHeight;0==a&&0==b||a==zwrtc.cam_width&&b==zwrtc.cam_height||640==zwrtc.cam_width&&480==zwrtc.cam_height?(wrtcSetting._pendingAccessMedia=!1,wrtcSetting._pendingSelectDevice?wrtcSetting.selectDevice():(wrtcSetting._spkDetectionCheck&&!wrtcSetting._cookieTestPassed&&"NONE"!=zwrtc.videoSourceID&&($("#cav_btn").html(wrtcSetting.getString("webcam_button_yes","Yes")),$("#cam_act_label").show()),wrtcSetting.deviceListPopulated?ConnectionManager._dispatchEvent("WRTC_SETTING_MEDIA_ACCESS_GRANTED",{msg_string:"Ready to display setting dialog"}):wrtcSetting.readDeviceList())):(zwrtc.cam_width=640,zwrtc.cam_height=480,zwrtc.in_video_width=640,zwrtc.in_video_height=480,wrtcSetting.accessMedia(zwrtc.videoSourceID,zwrtc.audioSourceID))},500)},onUserMediaError:function(a){return this.triedSecondTime?(wrtcSetting._pendingAccessMedia=!1,this.hideAllowPic(),this.dispatchAccessingHwdDone(),wrtcSetting.localStream=null,void(this._spkDetectionCheck&&!this._cookieTestPassed?this.deviceListPopulated?ConnectionManager._dispatchEvent("WRTC_SETTING_MEDIA_ACCESS_GRANTED",{msg_string:"Ready to display setting dialog"}):this.readDeviceList():(wrtcSetting._pendingAccessMedia=!1,ConnectionManager._dispatchEvent("ZWRTC_MEDIA_ACCESS_FAILED",{msg_string:"Failed to get access to local media. Error code was "+a.code})))):(this.triedSecondTime=!0,void this.accessMedia(zwrtc.videoSourceID,zwrtc.audioSourceID))},readDeviceList:function(){navigator.mozGetUserMedia?this.devicesAvailable(null):MediaStreamTrack.getSources(this.devicesAvailable.bind(this))},devicesAvailable:function(a){wrtcSetting.deviceListPopulated=!0;var b=wrtcSetting.audioSource,c=wrtcSetting.videoSource;if(b.length=0,c.length=0,navigator.mozGetUserMedia)c[c.length]={id:"FF_CAMERA",label:"camera"},b[b.length]={id:"FF_MICROPHONE",label:"microphone"};else for(var d=0;d!=a.length;++d){var e=a[d];if(this.log(e.kind+" "+e.label+" "+e.id),"audio"===e.kind){null==zwrtc.audioSourceID&&(zwrtc.audioSourceID=e.id);var f=e.label||"microphone "+b.length;b[b.length]={id:e.id,label:f}}else if("video"===e.kind){var f=e.label||"camera "+c.length;c[c.length]={id:e.id,label:f}}}"MIC_TEST_INIT"==this._state?(this._state=null,this.accessMicMedia()):ConnectionManager._dispatchEvent("WRTC_SETTING_DEVICELIST_POPULATED",{msg_string:"Ready to display setting dialog"})},webcamCaptureVisible:function(a){null==this.twoDCtx&&(this.camcap2DCanvas=$("#camcap2DCanvas")[0],this.twoDCtx=this.camcap2DCanvas.getContext("2d")),this.camcaptureLV=a,attachMediaStream(this.camcaptureLV,wrtcSetting.localStream)},getLowResolCam:function(){if(rtcSFU._useSimulcast&&!CallManager._flashEnabled){var a=this.getMediaConstraints(160,120,160,120,zwrtc.cam_fps,zwrtc.cam_fps_min,zwrtc.videoSourceID,zwrtc.audioSourceID);if(a&&a.video&&a.video.mandatory)return a.audio=!1,void getUserMedia(a,this.onLowResolMediaSuccess.bind(this),this.onLowResolMediaError.bind(this))}this.continueWithSelectedDevice()},onLowResolMediaSuccess:function(a){rtcSFU.setLowResolStream(a),this.continueWithSelectedDevice()},onLowResolMediaError:function(a){this.continueWithSelectedDevice()},continueWithSelectedDevice:function(){this._pendingSelectDevice=!1,$("#zcdiv").removeClass("floating_client_tech_check"),"NONE"==zwrtc.videoSourceID&&"PHONE"==zwrtc.audioSourceID&&(this.settingState=this.CONTINUE_VIEW);var a=new Zebra("com.requestec.smg.zebra.Gateway#storeTechCheck");if("NONE"==zwrtc.videoSourceID)a.setZEvent("cam","false"),a.setZEvent("cam_label","NONE");else{a.setZEvent("cam","true");var b="NONE",c=this.videoSource;CallManager._flashEnabled&&(c=flashSetting.videoSource);for(var d=0;d<c.length;d++)if(c[d].id==zwrtc.videoSourceID){b=c[d].label;break}a.setZEvent("cam_label",b)}if("PHONE"==zwrtc.audioSourceID)a.setZEvent("mic","false"),a.setZEvent("mic_label","PHONE");else{a.setZEvent("mic","true");var b="PHONE",e=this.audioSource;CallManager._flashEnabled&&(e=flashSetting.audioSource);for(var d=0;d<e.length;d++)if(e[d].id==zwrtc.audioSourceID){b=e[d].label;break}a.setZEvent("mic_label",b)}a.setZEvent("upload_speed",flashClient._calculatedUp),a.setZEvent("download_speed",flashClient._calculatedDown),CallManager._flashEnabled?a.setZEvent("flash","true"):a.setZEvent("flash","false"),ConnectionManager.sendZebra(a),webRTC.localStream=this.localStream,this.settingState==this.CONTINUE?continueAsVideo():this.settingState==this.CONTINUE_VOICE?continueAsVoice():this.settingState==this.CONTINUE_VIEW&&continueAsViewOnly(),ConnectionManager._dispatchEvent("WRTC_SETTING_DEVICE_SELECTED",{msg:""})},showTechSummary:function(a){var b="",c="System Check Passed",d=!1,e=!1,f=!1;if(zwrtc.isUsingNoCam()&&zwrtc.isUsingPhone())d=!0,b=this.stringErrNoCamMic;else if(zwrtc.isUsingNoCam())d=!0,b=this.stringErrNoCam;else if(zwrtc.isUsingPhone())d=!0,b=this.stringErrNoMic;else if(flashClient._bwdDone){var b=this.stringTechPass;if("RTMFP"!=flashClient._protocol)c=this.getString("alert_system_check_warning","System Check Warning"),f=!0,b=this.stringUDPFW;else if(flashClient._userDown<300||flashClient._userUp<300)c=this.getString("alert_system_check_warning","System Check Warning"),b=this.stringBwLow,f=!0;else if(e=!0,wrtcSetting.ignoreSummary)return void this.getLowResolCam()}d&&(c="System Check Failed");try{var g=this;Platform.showMessageX(c,b,d,function(){$("#messageOverlay").removeClass("green"),$("#messageOverlay").removeClass("orange"),$("#sp_flash_container").removeClass("pushed"),a?window.location.href=a:g.getLowResolCam()}),CallManager._flashEnabled&&$("#sp_flash_container").addClass("pushed"),e?CallManager.zui?zui.getMessageOverlay().addClass("green"):$("#messageOverlay").addClass("green"):f&&(CallManager.zui?zui.getMessageOverlay().addClass("orange"):$("#messageOverlay").addClass("orange"))}catch(h){}},saveDeviceCookie:function(){if(null!=zwrtc.audioSourceID&&"PHONE"!=zwrtc.audioSourceID&&null!=zwrtc.videoSourceID&&"NONE"!=zwrtc.videoSourceID){var a={audioSourceID:zwrtc.audioSourceID,videoSourceID:zwrtc.videoSourceID};ConnectionManager.createCookie(this.getCookieName(this._cookieTechCheck),JSON.stringify(a),1)}},doTechCheck:function(){this.resetTechCookie(),$("#tc_btn").hide(),$("#zcdiv").removeClass("floating_client_tech_check"),$("#zcdiv").addClass("floating_client_allow"),$("#webrtc_setting").hide(),$("#wrtc_cam_title").hide(),CallManager._flashEnabled?($("#sp_flash_container").addClass("pushed"),window.location.href="/tc.jsp"):this.init()},selectDevice:function(a){if(!$("#cav_btn").hasClass("disabled")){if(this._pendingAccessMedia){if("NONE"==zwrtc.videoSourceID&&"PHONE"==zwrtc.audioSourceID)return void(this._camCheckEnabled&&flashClient._bwdDone?this.showTechSummary(a):this.getLowResolCam());wrtcSetting.accessMedia(zwrtc.videoSourceID,zwrtc.audioSourceID),this._pendingSelectDevice=!0}else this._camCheckEnabled&&flashClient._bwdDone?(this.saveDeviceCookie(),this.showTechSummary(a)):this.getLowResolCam();null!=zwrtc.videoSourceID&&"NONE"!=zwrtc.videoSourceID&&ConnectionManager.createCookie(this.getCookieName(this._cookieCamCheck),zwrtc.videoSourceID,1)}},captureImage:function(){if(CallManager._flashEnabled)$("#camcap_prev_box").hide(),ConnectionManager._dispatchEvent("FLASH_SETTING_CAPTURE_IMAGE",{msg:""});else{$("#camcaptureLV").hide();var a=zwrtc.cam_width,b=zwrtc.cam_height,c=480,d=640;isNaN($("#camcaptureLV")[0].videoWidth)||(a=$("#camcaptureLV")[0].videoWidth),isNaN($("#camcaptureLV")[0].videoHeight)||(b=$("#camcaptureLV")[0].videoHeight);Math.round($("#camcaptureLV").height()*a/b);d>c?c=Math.round(d*b/a):d=Math.round(b*a/b);var e=Math.round((640-d)/2),f=Math.round((480-c)/2);this.twoDCtx.drawImage(this.camcaptureLV,e,f,d,c),$("#camcap_prev_box")[0].src=this.camcap2DCanvas.toDataURL("image/jpeg"),$("#camcap_prev_box").show()}imageCaptured()},saveImage:function(){$("#capture_save_btn").hasClass("disabled")||($("#capture_save_btn").addClass("disabled"),$("#capture_tryagain_btn").addClass("disabled"),CallManager._flashEnabled?($("#camcap_prev_box").hide(),ConnectionManager._dispatchEvent("FLASH_SETTING_ENCODE_IMAGE",{msg:""})):this.uploadImage(wrtcSetting.dataURItoBlob($("#camcap_prev_box")[0].src)))},uploadImage:function(a){var b=new FormData;b.append("name","Filedata"),b.append("pic","1"),b.append("filename","webcampic.jpg"),b.append("isActualPic","false"),b.append("Content-Type","image/jpeg"),b.append("Filedata",a);var c=$.ajax({url:"/settings/actions/4.jsp",type:"POST",data:b,processData:!1,contentType:!1,xhr:function(){var a=$.ajaxSettings.xhr();return a&&a.upload.addEventListener("progress",function(a){progress=Math.round(100*a.loaded/a.total);var b=1e4;progress>99&&(b=2e3),top.showProgress(progress.toString()+this.getString("file_upload_progress_txt","% Complete"),"","",function(){c.abort(),ConnectionManager._dispatchEvent("webcam_upload_done",null)},b,this.getString("file_upload_btn_cancel","Cancel"))},!1),a},success:function(a){wrtcSetting.log("File Uploaded:"+a);var b=a.indexOf("PIC=");if(b!=-1){var c=a.indexOf("ARG2=",b);if(c!=-1){var d=a.substring(b+4,c).trim(),e=a.substring(c+5,a.length).trim();wrtcSetting.log("PIC:"+d),wrtcSetting.log("ARG2:"+e),ConnectionManager._dispatchEvent("webcam_upload_done",{PIC:d,ARG2:e})}}}})},dataURItoBlob:function(a){var b;b=a.split(",")[0].indexOf("base64")>=0?atob(a.split(",")[1]):unescape(a.split(",")[1]);for(var c=a.split(",")[0].split(":")[1].split(";")[0],d=new ArrayBuffer(b.length),e=new Uint8Array(d),f=0;f<b.length;f++)e[f]=b.charCodeAt(f);var g=new DataView(d),h=new Blob([g],{type:c});return h},setTpLayout:function(a){this.tpDialog||(this.tpDialog=a),wrtcSetting.refreshingDevice=this.tpDialog,updateCSS()},displayLVMsg:function(a,b){a?($("#settingAvatarDiv").hide(),$("#settingLV").hide(),$("#setting_no_lv_txt")[0].innerHTML=b,$("#setting_no_lv").show()):($("#setting_no_lv").hide(),$("#settingAvatarDiv").show(),$("#settingLV").show())},selectViewOnly:function(){try{zwrtc.viewOnly&&($("#micToggleButtonOn").removeClass("muted"),$("#micToggleButtonOn").addClass("disabled"),$("#camToggleButtonOn").removeClass("muted"),$("#camToggleButtonOn").addClass("disabled"),$("#screenShareButton").addClass("disabled"),$(".self_cam_mic_control").hide(),$(".self_view_only_control").show())}catch(a){}this.settingState=this.CONTINUE_VIEW,wrtcSetting.selectDevice(),CallManager.switchViewOnly()},log:function(a){}};ConnectionManager.addListener("WRTC_SETTING_DEVICELIST_POPULATED",this,devicePopulated),ConnectionManager.addListener("WRTC_SETTING_MEDIA_ACCESS_GRANTED",this,function(a){attachMediaToSetting(),updateCSS()}),ConnectionManager.addListener("WRTC_SETTING_MEDIA_ACCESS_DISABLED",this,function(a){attachMediaToSetting(),updateCSS()}),ConnectionManager.addListener("ZWRTC_AUDIO_MUTE_TOGGLED","SETAV",updateCSS),ConnectionManager.addListener("ZWRTC_SET_WEBCAM_ACTIVE","SETAV",updateCSS),ConnectionManager.addListener("ZWRTC_VIDEO_MUTE_TOGGLED","SETAV",updateCSS),ConnectionManager.addListener("SECOND_STAGE",this,function(a){wrtcSetting.setTpLayout(!0)}),ConnectionManager.addListener("wrtc_select_device",this,function(a){wrtcSetting.selectDevice()}),ConnectionManager.addListener("MINI_PROFILE_LOADED",this,function(a){webRTC.isVideoMuted||wrtcSetting.usingNoCam?ConnectionManager._dispatchEvent("SETTING_WEBCAM_DISABLED",null):ConnectionManager._dispatchEvent("SETTING_WEBCAM_ENABLED",null)}),ConnectionManager.addListener("open_avatar_upload_from_cam",this,function(a){$("#webrtc_setting").hide(),$("#webrtc_camcapture").show(),$("#wrtc_cam_title").show(),CallManager._flashEnabled?($("#sp_flash_container").removeClass("flash_tp_Setting"),$("#sp_flash_container").addClass("flash_cam_cap_lv"),$("#camcaptureLV").hide(),$("#camcap_prev_box").hide(),$("#capture_main").css("height","150px")):(wrtcSetting.webcamCaptureVisible($("#camcaptureLV")[0]),$("#camcaptureLV").addClass("wrtc_cam_cap_lv"),$("#camcap_prev_box").addClass("wrtc_cam_cap_lv"),$("#camcap2DCanvas").addClass("wrtc_cam_cap_lv"),$("#capture_main").css("height",parseInt($("#camcaptureLV").css("height"),10)+40+"px"))}),ConnectionManager.addListener("webcam_upload_done",this,function(a){$("#capture_tryagain_btn").removeClass("disabled"),$("#capture_save_btn").removeClass("disabled"),$("#webrtc_setting").show(),$("#webrtc_camcapture").hide(),CallManager._flashEnabled?($("#sp_flash_container").addClass("flash_tp_Setting"),$("#sp_flash_container").removeClass("flash_cam_cap_lv")):wrtcSetting.camcaptureLV.pause(),tryAgainCapture(),navigator.mozGetUserMedia&&reattachMediaStream($("#camcaptureLV")[0],$("#settingLocalVideo")[0])});var flashClient={flashEmbeded:!1,flashBwdEmbeded:!1,_type:"VIDEO",_destination:null,_callToken:null,_inCall:!1,_fullscreen:!1,_protocol:"RTMFP",_rtmfpPort:"50000",_defaultRtmfpPort:"50000",_rtmpPort:"80",_forceProtocol:null,_failOverPriority:"rtmps",_failoverStartPort:"rtmps",_resizable:!1,_videoDisabled:!1,_privacyDialog:!1,_minBwd:200,_maxBwd:500,_bwdDone:!1,_userUp:0,_userDown:0,_calculatedUp:0,_calculatedDown:0,_bwdDuration:5,_bwdSwfInitialized:!1,_bwRunning:!1,_enableLVHide:!1,_initSwfRecvd:!1,_initAllowDenyRcvd:!1,_accessGranted:!1,_accessDenied:!1,_settingDialog:!1,_flashVideoDiv:null,_flashClient:"sp_flash",_bgColor:"#FFFFFF",_stageBGColor:"0xFFFFFF",_timerOnRV:!1,_showToolBar:!1,_show_call_timer:!0,_canSendResizeRV:!1,cam_width:320,cam_height:240,in_video_width:640,in_video_height:360,ssWidth:1280,ssHeight:720,cam_fps:20,cam_kfi:80,_ratio:1.33333,_state:null,_eventInitiated:!1,_displayFSBtn:!0,_flashRecvdInitAllowDeny:!1,command_id:-1,_asm:2.55,inLowBrMode:null,_spkVolume:-1,cdreliable:!0,monitorZCDStreams:!1,bufferTime:.005,bufferTimeMax:.25,forcedBR:-1,forcedQuality:-1,tabIndex:-1,srttMlt:2.5,enableBufferTime:!1,useSepAudioStream:!1,unbuffered:!1,redialOnFirstDrop:!1,firstStepTh:10,firstStepSapLen:12,secondStepTh:26,secondStepSapLen:28,avfrwErrorTS:-1,init:function(a,b,c){this._flashVideoDiv=a,this.__flashClient=b,this._settingDialog=c,CallManager._flashEnabled&&(this._forceProtocol&&(this._protocol=this._forceProtocol),this.initEventListeners(),this._settingDialog||(this._eventInitiated&&this._accessGranted?(this._resizable=!0,ConnectionManager._dispatchEvent("ZWRTC_MEDIA_ACCESS_GRANTED",{msg:""}),ConnectionManager._dispatchEvent("ZWRTC_READY",{msg:""}),this.showLV()):!ConnectionManager.doBlackboard&&this.embedFlash()&&this.initAllowDeny()))},showToolBar:function(){this._showToolBar=!0},setTimerOnRV:function(a){a&&(this._timerOnRV=a)},showCallTimer:function(a){this._show_call_timer=a},setBGColor:function(a){a&&(this._bgColor=a)},getFlashObject:function(){return $("#spFPLClient")[0]},onStatusMsg:function(a){try{a&&"SPK_TEST"!=this._state&&"SPK_TEST_DONE"!=this._state?$("#spFPLClient")[0].onStatusMsg(a):$("#spFPLClient")[0].onStatusMsg("")}catch(b){}},initEventListeners:function(){this._eventInitiated||(this._eventInitiated=!0,ConnectionManager.addListener("SETTING_INITIALIZE",this,this.initializeSetting),ConnectionManager.addListener("WRTC_SETTING_DEVICE_SELECTED",this,this.deviceSelected),ConnectionManager.addListener("ZEBRA:SERVER_REDIRECT",this,this.serverRedirect),ConnectionManager.addListener("ZEBRA:ALTERNATIVE_STREAM2",this,this.alternateStreamTwo),ConnectionManager.addListener("ZEBRA:MULTI_ALTERNATIVE_STREAM",this,this.handleMAPT),ConnectionManager.addListener("FULLSCREEN_STATE_CHANGED",this,this.fullscreenStateChanged),ConnectionManager.addListener("FLASH_MUTE_MIC",this,this.flashMuteMic),ConnectionManager.addListener("FLASH_MUTE_CAM",this,this.flashMuteCam),ConnectionManager.addListener("SWITCH_VIEW_ONLY",this,this.switchToViewOnly),ConnectionManager.addListener("MCUDISCONNECT",this,this.mcuDisconnect),ConnectionManager.addListener("FLASH_INIT_INCOMING_CALL",this,this.initiateCallPostAccept),ConnectionManager.addListener("RESET_LV",this,this.zcdivResized),ConnectionManager.addListener("FLASH_SET_LV",this,this.setLV),ConnectionManager.addListener("FLASH_SHOW_LV",this,this.displayLV),ConnectionManager.addListener("FLASH_SETTING_CAPTURE_IMAGE",this,this.captureImage),ConnectionManager.addListener("FLASH_SETTING_CAPTURE_AGAIN",this,this.captureAgain),ConnectionManager.addListener("FLASH_SETTING_ENCODE_IMAGE",this,this.encodeCapturedImage),ConnectionManager.addListener("FLASH_SETTING_REFRESH_DEVICE_LIST",this,this.refreshDevices),ConnectionManager.addListener("INIT_ALLOW_DENY",this,this.callInitAllowDenyLater),ConnectionManager.addListener("ZEBRA:SHOWMESSAGE3",this,this.showMessageThree),ConnectionManager.addListener("ZWRTC_SETTING_DO_SPK_TEST",this,this.doSpkTest),ConnectionManager.addListener("ZWRTC_SETTING_SPK_TEST_DONE",this,this.spkTestDone),ConnectionManager.addListener("HANGUP_TC_CALL",this,this.hangupTestCall),ConnectionManager.addListener("ZEBRA:SFUChannels",this,rtcSFU.handleSfuChannel),ConnectionManager.addListener("ZEBRA:GET_STATE_FROM_MCU:response",this,rtcSFU.gotStateFromMCU),ConnectionManager.addListener("ZEBRA:SHADOW_CONNECT",this,this.shadowConnectRecvd),ConnectionManager.addListener("ZEBRA:com.blackboard.saturn.zag.zebra.VideoConference#ClientToMCUConnect:response",this,this.connectResponse))},initiAdditionalEvents:function(){ConnectionManager.addListener("RESET_LV",this,function(a){this.updateLV(CallManager._selfX,CallManager._selfY,CallManager._selfWidth,CallManager._selfHeight,CallManager._videoWidth,CallManager._videoHeight)}),CallManager.addListener(CallManager.Event.SET_LV,this,function(){this.updateLV(CallManager._selfX,CallManager._selfY,CallManager._selfWidth,CallManager._selfHeight,CallManager._videoWidth,CallManager._videoHeight)}),ConnectionManager.addListener("UPDATE_RV",this,function(){this.updateLV(CallManager._selfX,CallManager._selfY,CallManager._selfWidth,CallManager._selfHeight,CallManager._videoWidth,CallManager._videoHeight)}),CallManager.addListener(CallManager.Event.HIDE_LV,this,function(){this.updateLVVisibility(!1)}),ConnectionManager.addListener("ZEBRA:MN_URL",this,function(a){var b=null,c=null;try{b=a.getZEvent("mcu").value,c=a.getZEvent("monaPort").value}catch(d){}if(b){DataStore.setUserData("endpoint",b.split(":")[0],!0),c?flashClient._rtmfpPort=c:flashClient._rtmfpPort=flashClient._defaultRtmfpPort,flashClient.initiateCall(flashClient._type,flashClient._destination,flashClient.proto);try{CallManager._ssDetected&&screenShareViewer.mnUpdated()}catch(d){}}else setTimeout(function(){flashClient.placeCall(flashClient._type,flashClient._destination,flashClient.proto)},1e3)})},updateLV:function(a,b,c,d,e,f){return"VOICE"==CallManager._type||Z.zjs.CallManager._bigscreenFS&&a<0||CallMUCMembers.inRoom&&ConnectionManager.inCall()&&zwrtc.isMCU()&&a<0&&!CallManager._selfVisible&&CallManager._bridgeMedia?void CallManager._dispatchEvent(CallManager.Event.HIDE_LV):(this.setLV({lx:a,ly:b,lw:c,lh:d,vw:e,vh:f,play:CallManager._playMedia}),void(CallManager._playMedia?this.updateLVVisibility(!1):this.updateLVVisibility(!0)))},updateLVVisibility:function(a){a&&webRTC.isVideoMuted&&zwrtc._hideLvOnMute&&(a=!1),this.displayLV({hideLV:!a})},callInitAllowDenyLater:function(a){setTimeout(function(){flashClient.initAllowDeny()},100)},initAllowDeny:function(a){if(!zwrtc.viewOnly&&(this.log("initAllowDeny:"+this._initSwfRecvd+":"+this._flashRecvdInitAllowDeny),this._initAllowDenyRcvd=!0,this._initSwfRecvd&&!this._flashRecvdInitAllowDeny)){$("#sp_flash_container").removeClass("pushed"),this.log("calling fp initAllowDeny");var b=this;setTimeout(function(){b.initAllowDeny()},1e3);try{$("#spFPLClient")[0].initAllowDeny()}catch(c){this.log("Error in calling initAllowDeny")}}},doInit:function(){ConnectionManager.doBlackboard||this.flashEmbeded||!this.embedFlash()||(flashSetting.init(),$("#webrtc_main").show())},spkTestDone:function(){this._state="SPK_TEST_DONE",this.doInit()},doSpkTest:function(){this.log("Do Speaker Test"),this._state="SPK_TEST",this.doInit()},displaySettingDialog:function(){this._type="VIDEO",CallManager.endCall(),$("#sp_flash_container").removeClass("pushed"),this.flashEmbeded?($("#spFPLClient")[0]&&$("#spFPLClient")[0].showClient(),this.loadDevices()):this.initializeSetting()},muteSpkAudio:function(a){try{$("#spFPLClient")[0]&&$("#spFPLClient")[0].muteSpkAudio(a)}catch(b){}},showMessageThree:function(a){a&&this.log("showMessageThree:"+a.toXML());var b=parseInt(a.getZEvent("messageid").value);switch(b){case 0:case 30:this.stopSound();break;case 6:case 7:break;case 8:case 9:this.playSound("/clients/Z3x/web/shared/assets/media/callringing.mp3",!0)}},handleMAPT:function(a){if(a){if(a.getZebraAttribute("username")!=DataStore.getUserData("username",""))return void this.log("Ignore MAPT, as it is for diff user e.g.screenshare zapp flash swf");this._lastMAPTZebra=a;var b,c=this.in_video_width,d=this.in_video_height,e=!1,f=new Object,g=!1,h=this.getZEvent(a,"self_lowbr_mode",CallManager.self_lowbr_mode);null!=h&&CallManager.lowBrMode!=h&&("BandLowWithVideo"===h?(CallManager.lowBrMode=h,ConnectionManager._dispatchEvent("RECEIVE_SINGLE_STREAM"),$("#spFPRVClient")[0].updateConfig({firstStepDownDone:"true"}),this.redialOnFirstDrop&&this.playLastRVSR()):"BandLowAudioOnly"===h&&(CallManager.lowBrMode=h,ConnectionManager._dispatchEvent("RECEIVE_AUDIO_ONLY"),this.playLastRVSR()));var j=parseInt(this.getZEvent(a,"queue_size",0));for(f.userId=null,i=0;i<j;i++){var b=this.getZEvent(a,"screenshare_"+i,"false"),k=this.getZEvent(a,"userId_"+i,""),l=this.getZEvent(a,"camEnabled_"+i,"on");this.getZEvent(a,"micEnabled_"+i,"on");("BandLowAudioOnly"===CallManager.lowBrMode||CallManager._ssDetected&&"BandLowWithVideo"===CallManager.lowBrMode)&&(l="off");var m=this.getZEvent(a,"sfu_max_channels",null);k.indexOf(rtcSFU._userRoomMcuDel)>-1&&(k=k.slice(rtcSFU._userRoomMcuPrefix.length,k.indexOf(rtcSFU._userRoomMcuDel))),m&&(rtcSFU.SFU_MAX_LEN=parseInt(m)),this.log("ss:"+b),this.log("userId:"+k),this.log("camEnabled:"+l),this.log("SFU_MAX_LEN:"+rtcSFU.SFU_MAX_LEN),f.position||(f.position=[]),i<rtcSFU.SFU_MAX_LEN&&f.position.push(k);var n=this.getZEvent(a,"lowbr_mode_"+i,null);"BandLowWithVideo"==n?(f.BandLowWithVideo||(f.BandLowWithVideo=[]),f.BandLowWithVideo.push(k)):"BandLowAudioOnly"==n&&(f.BandLowAudioOnly||(f.BandLowAudioOnly=[]),f.BandLowAudioOnly.push(k)),null==f.userId&&k!=ConnectionManager.userId&&(f.userId=k,f.id=""),f.max=rtcSFU.SFU_MAX_LEN,k&&k!=ConnectionManager.userId&&("off"==l?ConnectionManager._dispatchEvent("ZWRTC_RV_MUTED",{avatarUrl:"",id:"",userId:k}):(g=!0,ConnectionManager._dispatchEvent("ZWRTC_RV_UNMUTED",{id:"",userId:k}))),"true"==b&&(e=!0)}ConnectionManager._dispatchEvent("ZWRTC_FOCUS_RV",f),e||"Screenshare"==this.getZEvent(a,"view_name",null)&&(e=!0);try{stream_width_r=a.getZEvent("videoWidth").value,stream_height_r=a.getZEvent("videoHeight").value}catch(o){Platform.log("videoWidth x videoHeight not available in MAPT, try f_width x f_height");try{stream_width_r=a.getZEvent("f_width").value,stream_height_r=a.getZEvent("f_height").value}catch(p){Platform.log("f_width x f_height not available in MAPT, defaulting to 640x360"),stream_width_r=640,stream_height_r=360}}isNaN(stream_width_r)||(c=parseInt(stream_width_r)),isNaN(stream_height_r)||(d=parseInt(stream_height_r));try{$("#spFPLClient")[0].resizeRV(this.cam_width,this.cam_height)}catch(q){}try{$("#spFPRVClient")[0].resizeRV(c,d)}catch(q){}if(g?this.enableStreamMonitor(!0):$("#spFPRVClient")[0].updateConfig({monitorZCDStreams:"false"}),e&&"BandLowAudioOnly"!=CallManager.lowBrMode){var r,s;try{r=a.getZEvent("s_width").value,s=a.getZEvent("s_height").value}catch(o){try{r=a.getZEvent("fs_width").value,s=a.getZEvent("fs_height").value}catch(o){}}var t=!1;if(!isNaN(r)){var u=parseInt(r);u!=this.ssWidth&&(t=!0),this.ssWidth=u}if(!isNaN(s)){var v=parseInt(s);v!=this.ssHeight&&(t=!0),this.ssHeight=v}t&&ConnectionManager._dispatchEvent("APP_SHARE_RESOL_UPDATED",{width:this.ssWidth,height:this.ssHeight});try{$("#spFPSSClient").length>0&&$("#spFPSSClient")[0].resizeRV(this.ssWidth,this.ssHeight)}catch(q){}this._canSendResizeRV=!0}else this._canSendResizeRV&&(this._canSendResizeRV=!1)}},stopSound:function(){try{$("#spFPLClient")[0].stopSound()}catch(a){}},playSound:function(a,b,c){void 0==c&&(c=0),void 0==b&&(b=!1);try{$("#spFPLClient")[0].playSound(a,b,c)}catch(d){}},scanHwd:function(){try{$("#spFPLClient")[0].scanHwd()}catch(a){}},encodeCapturedImage:function(){try{$("#spFPLClient")[0].encodeImage()}catch(a){}},captureAgain:function(){try{$("#spFPLClient")[0].captureAgain()}catch(a){}},captureImage:function(){try{$("#spFPLClient")[0].captureImage()}catch(a){}},showAllowArrow:function(a){if(!this._accessDenied){var b=!1;"REM"==a?(b=!0,$("#webrtc_warn_txt")[0].innerHTML='Now click "Remember", then "Close"'):"SAVE"==a?$("#webrtc_warn_txt")[0].innerHTML='To save your settings click "Allow"':$("#webrtc_warn_txt")[0].innerHTML=Z.zjs.ZLocale.getString("allow_cam_mic_message","Please press the Allow button to start your camera and microphone"),$("#flash_save_btn_cont").hide();var c=wrtcSetting.getZoomFactor();(isNaN(c)||c>=100&&c<=105)&&(c=100),c>=95?(b?$("#flash_allow_deny_img").css("top","30px"):$("#flash_allow_deny_img").css("top","50px"),$("#flash_allow_deny_img").css("left","50px"),$("#flash_allow_deny_img").show()):c>=80?(b?$("#flash_allow_deny_img").css("top","40px"):$("#flash_allow_deny_img").css("top","60px"),
$("#flash_allow_deny_img").css("left","40px"),$("#flash_allow_deny_img").show()):($("#flash_allow_deny_img").hide(),$("#webrtc_warn_txt").hide())}},displayPrivacy:function(){$("#flash_save_btn_cont").hide(),this._privacyDialog||(this._privacyDialog=!0,this.showAllowArrow("SAVE"))},refreshDevices:function(){this.loadDevices(!0)},loadDevices:function(a){if($("#webrtc_warn_txt").hide(),$("#flash_allow_deny_img").hide(),this._flashVideoDiv&&(this._flashVideoDiv.removeClass("flash_allow_deny"),this._flashVideoDiv.css("width",""),this._flashVideoDiv.css("height",""),this._flashVideoDiv.css("top",""),this._flashVideoDiv.css("left","")),"SPK_TEST"==this._state||"SPK_TEST_DONE"==this._state)this._state=null,ConnectionManager._dispatchEvent("FLASH_SHOW_MIC_TEST");else try{flashSetting.devicesAvailable($("#spFPLClient")[0].getDeviceList(!1))}catch(b){this.log("loadDevices:Error in calling getDeviceList")}},accessGranted:function(a){if(!this._accessGranted)if(this._accessGranted=!0,ConnectionManager._dispatchEvent("SETTING_ACCESSING_DEVICES_DONE"),"true"==a)if($("#flash_save_btn_cont").hide(),this._privacyDialog){try{$("#spFPLClient")[0].displayPrivacy()}catch(b){}this.showAllowArrow("REM")}else this._settingDialog?this.loadDevices(!1):(this._resizable=!0,ConnectionManager._dispatchEvent("ZWRTC_MEDIA_ACCESS_GRANTED",{msg:""}),ConnectionManager._dispatchEvent("ZWRTC_READY",{msg:""}),this.deviceSelected());else $("#flash_allow_deny_img").hide(),$("#flash_save_btn_cont").hide(),$("#webrtc_warn_txt").hide(),"SPK_TEST"==this._state||"SPK_TEST_DONE"==this._state?this.loadDevices(!1):this._settingDialog?(this._accessDenied=!0,flashSetting.devicesAvailable(null),this._flashVideoDiv&&this._flashVideoDiv.css("opacity","0")):(this._resizable=!0,ConnectionManager._dispatchEvent("ZWRTC_MEDIA_ACCESS_GRANTED",{msg:""}),ConnectionManager._dispatchEvent("ZWRTC_READY",{msg:""}),this.showLV())},hangupTestCall:function(){this._callEstablished=!1,this._avfrwConnected=!1;try{$("#spFPLClient")[0].hangup()}catch(a){}this._lastSR=null},mcuDisconnect:function(a){return Platform.log("fc:MCUD:"+a.reason+" "+this._callEstablished),this._avfrwConnected=!1,this._callEstablished&&7==parseInt(a.reason)?(Platform.log("Recvd 7, need redial:"+this._callSR),this._lastSR=null,void this.placeCall(this._type||"VIDEO",this._destination,this._protocol)):(this.disconnectCall(),void CallManager.disconnectCall())},disconnectCall:function(){Platform.log("fc:disconnectCall"),this.command_id=-1,this._lastSR=null,this.p2pEstablished=!1,this._doingSR=!1,this._streamPlayed=!1,this._callEstablished=!1,this._avfrwConnected=!1,this.inRoom=!1,this._lastRVSR=null;try{$("#spFPLClient")[0].hangup(),wrtcShowWFC(),this.showLV(),this.showVideoInWFC()}catch(a){}},switchToViewOnly:function(){try{$("#spFPLClient")[0].freeMic(),$("#spFPLClient")[0].freeCam()}catch(a){}zwrtc.switchViewOnly()},displayLV:function(a){if(flashClient._resizable){this.log("JS:displayLV:"+a.hideLV);try{a&&a.hideLV||zwrtc.isUsingNoCam()?$("#spFPLClient")[0].showLV(!1):$("#spFPLClient")[0].showLV(!0)}catch(b){}}},setLV:function(a){if(flashClient._resizable){this.log("JS:setLV:"+this._enableLVHide+" lx:"+a.lx+" ly:"+a.ly+" lw:"+a.lw+" lh:"+a.lh+" vw:"+a.vw+" vh:"+a.vh);try{this._enableLVHide?a.lx!=-1||a.ly!=-1||zwrtc.isUsingNoCam()?$("#spFPLClient")[0].showLV(!1):$("#spFPLClient")[0].showLV(!0):(a.vw?a.rv_width=a.vw:a.rv_width=this.in_video_width,a.vh?a.rv_height=a.vh:a.rv_height=this.in_video_height,$("#spFPLClient")[0].setLV(a))}catch(b){}}},isP2P:function(){try{if($("#spFPLClient")[0])return $("#spFPLClient")[0].isP2P()}catch(a){}return!1},isMCU:function(){try{if($("#spFPLClient")[0])return $("#spFPLClient")[0].isMCU()}catch(a){}return!1},isConnected:function(){try{if($("#spFPLClient")[0])return $("#spFPLClient")[0].isConnected()}catch(a){}return!1},zcdivResized:function(){flashClient._resizable&&(flashClient._inCall?(this._fullscreen?($("#spFPLClient").css("width",screen.width),$("#spFPLClient").css("height",screen.height),this._flashVideoDiv&&(this._flashVideoDiv.css("width",screen.width+"px"),this._flashVideoDiv.css("height",screen.height+"px"))):($("#spFPLClient").css("width",$("#rvContainer").css("width")),$("#spFPLClient").css("height",$("#rvContainer").css("height")),this._flashVideoDiv&&(this._flashVideoDiv.css("width",$("#rvContainer").css("width")),this._flashVideoDiv.css("height",$("#rvContainer").css("height")))),this._flashVideoDiv&&this._flashVideoDiv.css("bottom","0px")):($("#spFPLClient").css("width",$("#lvContainer").css("width")),$("#spFPLClient").css("height",$("#lvContainer").css("height")),this._flashVideoDiv&&(this._flashVideoDiv.css("width",$("#lvContainer").css("width")),this._flashVideoDiv.css("height",$("#lvContainer").css("height")),this._flashVideoDiv.css("bottom",parseInt($("#lvContainer").css("bottom"))+2+"px"))))},flashMuteMic:function(a){a.mute&&(rtcSFU.sendVadZebra(0,0),this.sendSilenceActivity());try{$("#spFPLClient")[0].muteMic(a.mute)}catch(b){this.log("flashMuteMic: error in calling muteMic")}},sendSilenceActivity:function(){var a=new Object;a.max=0,a.min=0,ConnectionManager.userId&&(a.userId=ConnectionManager.userId);var b="MIC_ACTIVITY";this._micSamplingEventName&&(b=this._micSamplingEventName),ConnectionManager._dispatchEvent(b,a)},flashMuteCam:function(a){try{$("#spFPLClient")[0].muteCam(a.mute,DataStore.getUserData("avatarurl"))}catch(b){}!a.mute&&CallManager._flashCamUpdated&&(CallManager._flashCamUpdated=!1,CallManager.endCall())},fullscreenStateChanged:function(a){a.fullscreen?(this._fullscreen=!0,this._flashVideoDiv&&(this._flashVideoDiv.removeClass("flash_room_rvinlv"),this._flashVideoDiv.removeClass("flash_room_rvinlv_tp"),this._flashVideoDiv.removeClass("flash_room")),this._inCall?this._flashVideoDiv&&this._flashVideoDiv.addClass("flash_room_fs"):this._flashVideoDiv&&this._flashVideoDiv.addClass("flash_room_fs_rvinlv"),$("#lvContainer").css("right","28px")):(this._fullscreen=!1,this._flashVideoDiv&&(this._flashVideoDiv.addClass("flash_room"),this._flashVideoDiv.removeClass("flash_room_fs"),this._flashVideoDiv.removeClass("flash_room_fs_rvinlv")),this._inCall?this.showVideoInCall():this.showVideoInWFC(),$("#lvContainer").css("right","10px"));try{$("#spFPLClient")[0].toggleFS(this._fullscreen)}catch(b){}this.zcdivResized()},startMicSampling:function(a){this._micSamplingEventName=a;try{$("#spFPLClient")[0].startVadSampling()}catch(b){}return!0},stopMicSampling:function(){try{$("#spFPLClient")[0].stopMicSampling()}catch(a){}},dispatchSpkTestCall:function(){setTimeout(function(){ConnectionManager._dispatchEvent("FLASH_SPK_TEST_CALL_PLACED")},2e3)},handleAVFRWError:function(){this.redialCall(AVSDKErrors.FLASH_SOCKET_ERROR)},redialCall:function(a){this.disconnectCall();var b=(new Date).getTime(),c=2e3;this.avfrwErrorTS>0&&b-this.avfrwErrorTS<6e3&&(c=6e3,this.log("Increasing delay to stop infinite redial loop")),this.avfrwErrorTS=b,setTimeout(function(){CallManager.switchingRoom?(CallManager.switchingRoom=!1,CallManager.redialCall("Switching between Breakout Rooms")):CallManager.redialCallWithError(a)},c)},updateUploadBR:function(a){if(!isNaN(a)){this.log("updateUploadBR:"+a+"bps");try{$("#spFPLClient")[0].updateUploadBR(a)}catch(b){}}},onInvoke:function(a,b){switch(a){case"sendPlaceCall":b&&this.sendPlaceCall(b),"SPK_TEST"==this._state&&this._streamPlayed?(this.dispatchSpkTestCall(),this.muteSpkAudio(!0)):this._callEstablished=!0;break;case"sendRestZebra":b&&this.sendRestZebra(b);break;case"sendAVFRWConnect":b&&this.sendAVFRWConnect(b),"SPK_TEST"==this._state&&this._streamPlayed?(this.dispatchSpkTestCall(),this.muteSpkAudio(!0)):this._callEstablished=!0;break;case"avfrwError":this.handleAVFRWError();break;case"peerVideoToggle":break;case"privacyDialogClose":this.loadDevices(!1);break;case"privacyDialogVisible":this.showAllowArrow("REM");break;case"defaultDevicesSet":$("#flash_allow_deny_loading").hide();break;case"muteMicrophone":zwrtc.toggleAudioMute();break;case"muteCamera":zwrtc.toggleVideoMute();break;case"hangupCall":CallManager.endCall();break;case"establishingP2P":this._lastSR="P2P";break;case"placingCall":this.showVideoInCall(),wrtcShowRemoteVideo(),showRV(),CallManager._dispatchEvent(CallManager.Event.CONNECTING,{type:"mcu"});break;case"streamPlayStart":"SPK_TEST"==this._state&&this._callEstablished?(this.dispatchSpkTestCall(),this.muteSpkAudio(!0)):this._streamPlayed=!0;break;case"serverRedirectStatus":if(b){this.command_id=-1;var c=new Zebra("SERVER_REDIRECT_STATUS");c.setZEvent("status","OK"),c.setZEvent("command_id",b),ConnectionManager.sendZebraToMCU(c),this.log("SERVER_REDIRECT_STATUS:_srCommandID:"+b)}break;case"onMicSample":b&&(void 0==this._micSamplingEventName&&(this._micSamplingEventName="mic_activity"),ConnectionManager._dispatchEvent(this._micSamplingEventName,{max:b.max,min:b.min,from:"flash"}));break;case"mouseOverRV":ConnectionManager._dispatchEvent("FLASH_RV_MOUSE_OVER",{msg:""});break;case"mouseOutRV":ConnectionManager._dispatchEvent("FLASH_RV_MOUSE_OUT",{msg:""});break;case"jpegUploadProgress":if(b){var d=Math.round(100*b.bytesLoaded/b.bytesTotal),e=1e4;d>99&&(e=2e3,d=100),top.showProgress(d.toString()+Z.zjs.ZLocale.getString("file_upload_progress_txt","% Complete"),"","",function(){$("#spFPLClient")[0].cancelPhotoUpload(),ConnectionManager._dispatchEvent("webcam_upload_done",null)},e,Z.zjs.ZLocale.getString("file_upload_btn_cancel","Cancel"))}break;case"jpegUploaded":b&&(this.log("jpegUploaded:"+b.pic),this.log("jpegUploaded:"+b.arg2),ConnectionManager._dispatchEvent("webcam_upload_done",{PIC:b.pic,ARG2:b.arg2}));break;case"encodedImage":if(b){var f="data:image/jpeg;base64,"+b;this.log("BASE64 Encoded Image:"+f),wrtcSetting.uploadImage(wrtcSetting.dataURItoBlob(f))}break;case"stageSmall":ConnectionManager._dispatchEvent("SETTING_DISPLAY_FP_ALLOW_DENY",{msg:"",stageSmall:!0});break;case"swfInitialized":ConnectionManager._dispatchEvent("LV_SWF_LOADED"),this.log("swfInitialized"),this._initSwfRecvd=!0;var g=this;$("#spFPLClient")[0].tabIndex=this.tabIndex,setTimeout(function(){if(ConnectionManager.doBlackboard)zwrtc.viewOnly?ConnectionManager._dispatchEvent("ZWRTC_READY",{msg:""}):g.initAllowDeny(null);else if("SPK_TEST"==g._state)$("#sp_flash_container").removeClass("pushed"),$("#spFPLClient")[0].hideClient(),g.placeCall("VOICE","TC1"),$("#sp_flash_container").addClass("pushed");else if(g._initAllowDenyRcvd){g.log("Calling fp initAllowDeny()"),$("#sp_flash_container").removeClass("pushed");try{$("#spFPLClient")[0].initAllowDeny()}catch(a){}ConnectionManager._dispatchEvent("SHOWING_FP_ALLOW_DENY")}},100);break;case"bandwidth_swf_loaded":this._bwdSwfInitialized||(this._bwdSwfInitialized=!0,this.startBandwidthDetection());break;case"callEstablished":try{this.inRoom&&(Z.zjs.CallMUCMembers.inRoom=this.inRoom),this.inRoom=!1,$("#rvCard")[0].style.webkitTransform="rotateY(0deg)"}catch(h){}ConnectionManager.doBlackboard&&(CallManager.setWebCamActive({isVideoMuted:!0}),setTimeout(function(){CallManager.setWebCamActive({isVideoMuted:webRTC.isVideoMuted})},1e3));break;case"p2pCallEstablished":this._lastSR="P2P",this.inRoom&&(Z.zjs.CallMUCMembers.inRoom=this.inRoom),this.inRoom=!1,CallManager._dispatchEvent(CallManager.Event.CONNECTED,{type:"mcu"}),this.p2pEstablished=!0;break;case"remoteVideoRecvd":this._callEstablished&&(CallManager._redialCounter=0,ConnectionManager._dispatchEvent("FLASH_CALL_ESTABLISHED",{msg:""}),CallManager._dispatchEvent(CallManager.Event.CONNECTED,{type:"mcu",conn_type:"FLASH_LV"}));break;case"bandwidth_started":ConnectionManager._dispatchEvent("ZWRTC_BW_DETECTION_STARTED");break;case"userBandwidth":var i="UDP";if(b){var j=this._calculatedUp=b.up;i=b.proto,j=j<this._minBwd?this._minBwd:j>this._maxBwd?this._maxBwd:.8*j,this._userUp=j}this._forceProtocol?this._protocol=this._forceProtocol:"UDP"==i?this._protocol="RTMFP":this._protocol=this._failoverStartPort,this._bwdDone=!0;case"zcBwdFailed":case"zcBwdDone":var i="UDP";if(b){var j=this._calculatedUp=b.up;i=b.proto,j=j<this._minBwd?this._minBwd:j>this._maxBwd?this._maxBwd:.8*j,this._userUp=j}this._forceProtocol?this._protocol=this._forceProtocol:"UDP"==i?this._protocol="RTMFP":this._protocol=this._failoverStartPort,this._bwdDone=!0,flashClient.initiateCall(flashClient._type,flashClient._destination,this._protocol);break;case"bandwidth_failed":case"bandwidth_detected":var i="UDP";if(b){var k=this._calculatedDown=b.down,j=this._calculatedUp=b.up;i=b.proto,j=j<this._minBwd?this._minBwd:j>this._maxBwd?this._maxBwd:.8*j,this._userUp=j,k<this._minBwd?k=this._minBwd:k>this._maxBwd&&(k=this._maxBwd),this._userDown=k,this._forceProtocol?this._protocol=this._forceProtocol:"UDP"==i?this._protocol="RTMFP":this._protocol=this._failoverStartPort,ConnectionManager._dispatchEvent("ZWRTC_BW_DETECTION_DONE",{up:b.up,down:b.down,proto:i,flash:!0})}else this._forceProtocol?this._protocol=this._forceProtocol:this._protocol="RTMFP",this._userUp=this._minBwd,this._userDown=this._minBwd,ConnectionManager._dispatchEvent("ZWRTC_BW_DETECTION_DONE",{up:0,down:0,proto:"",flash:!0});this._bwdDone=!0,$("#spBwdClient").hide(),this._bwRunning=!1;break;case"recvdInitAllowDeny":this._flashRecvdInitAllowDeny=!0;break;case"MIC_ACTIVITY":if(b){ConnectionManager.userId&&(b.userId=ConnectionManager.userId);var l="MIC_ACTIVITY";this._micSamplingEventName&&(l=this._micSamplingEventName),ConnectionManager._dispatchEvent(l,b)}break;case"sendVadZebra":if(b)if(rtcSFU.forceVadDuration>0&&!webRTC.isAudioMuted){var m=(new Date).getTime();m-rtcSFU.lastActivityZebraTs>=rtcSFU.forceVadDuration&&rtcSFU.sendVadZebra(String(b.silence),String(b.isSpeaking))}else webRTC.isAudioMuted&&(this.log("got Vad but mic is muted"+b.silence+" "+b.isSpeaking),b.silence=b.isSpeaking=0,this.sendSilenceActivity()),rtcSFU.sendVadZebra(String(b.silence),String(b.isSpeaking));break;case"micNotWorking":ConnectionManager._dispatchEvent("MIC_NOT_WORKING");break;case"micWorking":ConnectionManager._dispatchEvent("MIC_WORKING");break;case"changeUserStateToAway":ConnectionManager._dispatchEvent("CHANGE_USERSTATE_TO_AWAY");break;case"showUserStateToolTip":ConnectionManager._dispatchEvent("CHANGE_USERSTATE_SHOW_TOOLTIP");break;case"hideUserStateToolTip":ConnectionManager._dispatchEvent("CHANGE_USERSTATE_HIDE_TOOLTIP");break;case"onLog":b&&this.log(b)}},callFPBwd:function(){if(!this._bwRunning){this._bwRunning=!0;var a=null;ConnectionManager.getZS&&(a=ConnectionManager.getZS()),null!=a&&0!=a.length||(a=window.location.host),$("#spBwdClient")[0].doBandwidthDetect(a,this._bwdDuration)}},startBandwidthDetection:function(){var a=swfobject.getFlashPlayerVersion();if(null==a||a.major<CallManager.fpVersion)return void ConnectionManager._dispatchEvent("ZWRTC_BW_DETECTION_DONE",{flash:!1});if(this.embedBwdSwf(),$("#spBwdClient").show(),$("#spBwdClient").css("top","0px"),$("#spBwdClient").css("position","absolute"),this._bwdSwfInitialized){var b=this;setTimeout(function(){b.callFPBwd()},1e3)}},alternateStreamTwo:function(a){this.log("CallManager serverRedirect");try{var b={};b.audio_stream=a.getZEvent("audio_stream").value,b.audio_stream_id=a.getZEvent("audio_stream_id").value,b.event=a.getZEvent("event").value,b.video_stream=a.getZEvent("video_stream").value,b.video_stream_id=a.getZEvent("video_stream_id").value;try{$("#spFPLClient")[0].alternateStreamTwo(b)}catch(c){}}catch(c){}},sendRestZebra:function(a){var b=new Zebra("AVFW_FEED");b.setZEvent("event",callObj.event),b.setZEvent("video",callObj.video),b.setZEvent("audio",callObj.audio),ConnectionManager.sendZebraToMCU(b)},sendAVFRWConnect:function(a){this._avfrwConnected=!0;var b="command=startAV";a.zsPublishID?b=b+"&zsPublishID="+a.zsPublishID:a.zcdPublishID&&(b=b+"&zcdPublishID="+a.zcdPublishID),a.rtmfpPort&&(b=b+"&rtmfpPort="+a.rtmfpPort,this._rtmfpPort=a.rtmfpPort),ConnectionManager.sendZSCommand("sendMessageToMCU",b),a.zsPublishID?this._forceProtocol?this.playStream(this._forceProtocol,a.zsPublishID):this.playStream("RTMPS",a.zsPublishID):a.zcdPublishID&&this.playStream("RTMFP",a.zcdPublishID),this.dispatchConnectedState()},playStream:function(a,b){var c={};ConnectionManager.getZS?c.zenonserver=ConnectionManager.getZS():c.zenonserver=window.location.host,this._protocol=c.protocol=a,c.streamName=b,this._lastRVSR=c,this._rvEmbedded&&this.playLastRVSR(),webRTC.isAudioMuted&&webRTC.isVideoMuted||rtcSFU.sendVadZebra(0,0)},playLastRVSR:function(){this._lastRVSR&&($("#spFPRVClient")[0].updateConfig({rtmfpPort:this._rtmfpPort,defaultRtmfpPort:this._defaultRtmfpPort}),$("#spFPRVClient")[0].playStream(this._lastRVSR),this.enableStreamMonitor(!1),CallManager._dispatchEvent(CallManager.Event.CONNECTING,{type:"mcu",conn_type:"FLASH_RV"}),this.setSpkVolume(this._spkVolume))},enableRightMouseClick:function(){$("#spFPRVClient")[0].enableRightMouseClick()},enableStreamMonitor:function(a){a?"BandLowAudioOnly"===CallManager.lowBrMode||"BandLowWithVideo"===CallManager.lowBrMode&&CallManager._ssDetected||$("#spFPRVClient")[0].enableStreamMonitor():("BandLowAudioOnly"===CallManager.lowBrMode||"BandLowWithVideo"===CallManager.lowBrMode&&CallManager._ssDetected)&&$("#spFPRVClient")[0].updateConfig({monitorZCDStreams:"false"})},sendPlaceCall:function(a){this._lastSR=null;var b=new Zebra("org.zenon.server.zebra.ZebraHandler#placeCall");b.setZEvent("isP2P",a.isP2P),b.setZEvent("width",this.in_video_width),b.setZEvent("height",this.in_video_height),b.setZEvent("videoCodec",a.videoCodec),b.setZEvent("inVideoCodec",a.videoCodec),b.setZEvent("audioCodec",a.audioCodec),b.setZEvent("inAudioCodec",a.audioCodec),b.setZEvent("resolution",a.resolution),b.setZEvent("client","flash"),this._callToken?b.setZEvent("callToken",this._callToken):b.setZEvent("destination",this._destination),b.setZEvent("type",this._type),a.zcdPublishID?(b.setZEvent("zcdPublishID",a.zcdPublishID),a.rtmfpPort&&(b.setZEvent("rtmfpPort",a.rtmfpPort),this._rtmfpPort=a.rtmfpPort),this.playStream("RTMFP",a.zcdPublishID),this.dispatchConnectedState()):a.zsPublishID&&(b.setZEvent("zsPublishID",a.zsPublishID),this._forceProtocol?this.playStream(this._forceProtocol,a.zsPublishID):this.playStream("RTMPS",a.zsPublishID),this.dispatchConnectedState()),a.cdconnection&&b.setZEvent("cdconnection",a.cdconnection),a.callerP2PAddress&&b.setZEvent("callerP2PAddress",a.callerP2PAddress),a.avfrw&&b.setZEvent("avfrw",a.avfrw),CallManager.loadLowBrMode?b.setZEvent("bandwidthMode",CallManager.loadLowBrMode):CallManager.lowBrMode&&b.setZEvent("bandwidthMode",CallManager.lowBrMode),ConnectionManager.sendZSZebraCommand("placeCall",b)},shadowConnectRecvd:function(){flashClient.dispatchConnectedState()},dispatchConnectedState:function(){CallManager.setWebCamActive({isVideoMuted:webRTC.isVideoMuted}),CallManager._dispatchEvent(CallManager.Event.CONNECTED,{type:"mcu",conn_type:"FLASH_LV"}),webRTC.isAudioMuted||rtcSFU.sendVadZebra(1,1)},initiateCallPostAccept:function(a){this._destination=null,a&&(a.zenonserver||(ConnectionManager.getZS?a.zenonserver=ConnectionManager.getZS():a.zenonserver=window.location.host),a.callToken&&(this._callToken=a.callToken),a.protocol=this._protocol,a.width=this.cam_width,a.height=this.cam_height,a.inVideoWidth=this.in_video_width,a.inVideoHeight=this.in_video_height,a.fps=this.cam_fps,a.kfi=this.cam_kfi,a.username=DataStore.getUserData("username",""),a.service=ConnectionManager.service,a.rtmfpPort=this._rtmfpPort,a.defaultRtmfpPort=this._defaultRtmfpPort,this._bwdDone?a._userUp=this._userUp:a._userUp=this._minBwd,this.sendSR(a))},sendSR:function(a){if(a){a.useRoomAndUserid=ConnectionManager.useRoomAndUserid,a.userId=ConnectionManager.userId,a.roomSession=ConnectionManager.roomSession,a.ignoreMute=!0,a.viewOnly=zwrtc.viewOnly;try{$("#spFPLClient")[0].parseSR(a)}catch(b){}}ConnectionManager._dispatchEvent("FLASH_PLACING_CALL",{msg:""}),CallManager._dispatchEvent(CallManager.Event.CONNECTING,{type:"mcu"})},placeCall:function(a,b,c){ConnectionManager.doBlackboard?(this._type=a,this._destination=b,this._proto=c,CallManager._dispatchEvent(CallManager.Event.CONNECTING,{type:"mcu",conn_type:"FLASH_LV"}),ConnectionManager.sendWSJSonMessage({type:"zsMessage",command:"GET_MCU_URL"})):this.initiateCall(a,b,c)},initiateCall:function(a,b,c){this.showLV(),this._type=a.replace("DIAL",""),null==b&&(b="VS4"),b.indexOf("#")==-1&&b.indexOf("%23")==-1&&(b=b+"%23"+LineStatesModel.getNextAvailableLine()),this._destination=b;var d={};d.type=a,d.connectmode="2",d.destination=b,d.isP2P="false",ConnectionManager.getZS?d.zenonserver=ConnectionManager.getZS():d.zenonserver=window.location.host,c?d.protocol=c:d.protocol=this._protocol,d.width=this.cam_width,d.height=this.cam_height,d.inVideoWidth=this.in_video_width,d.inVideoHeight=this.in_video_height,d.fps=this.cam_fps,d.kfi=this.cam_kfi,d.username=DataStore.getUserData("username",""),d.service=ConnectionManager.service,d.rtmfpPort=this._rtmfpPort,d.defaultRtmfpPort=this._defaultRtmfpPort,this._bwdDone?d._userUp=this._userUp:d._userUp=this._minBwd,this.sendSR(d)},getZEvent:function(a,b,c){try{return a.getZEvent(b).value}catch(d){}return c},connectResponse:function(a){if(a){var b="true"===this.getZEvent(a,"micOn",!1);CallManager.initialMicUnmuted=b,CallManager.checkMcuMicState&&CallManager._flashEnabled&&(CallManager.checkMcuMicState=!1,CallManager.initialMicUnmuted?ZVideoViewController.toggleMic({mute:!1,device:"phone"}):CallManager.sendInitialVad())}},serverRedirect:function(a){if(CallManager.CALL_HANDLING){var b=this.getZEvent(a,"command_id");if(null!=b){if(this.log("this.command_id:"+this.command_id+" command_id:"+b),this.command_id!=-1)return void(this.command_id=b);this.command_id=b}if(this._callEstablished&&a){var c=this.getZEvent(a,"mcu");if("true"!=c&&this.command_id==-1){this._doingSR=!0,CallManager.sendEndCall("SERVER_REDIRECT");var d=this;setTimeout(function(){d.processServerRedirect(a)},1e3)}else this.processServerRedirect(a)}else this.processServerRedirect(a)}},processServerRedirect:function(a){if(CallManager.CALL_HANDLING){this.log("fc:CallManager serverRedirect"),a&&Platform.log("fc:serverRedirect:"+a.toXML());var b={};this._callToken=null,this._doingSR=!1;var c=this.getZEvent(a,"mcu");if("true"==c){if("MCU"==this._lastSR)return void this.log("Duplicate SR, ignoring...");if(null!=this.getZEvent(a,"queue_size")&&ConnectionManager._dispatchEvent("ZEBRA:MULTI_ALTERNATIVE_STREAM",a),b.mcu="true","VOICE"==CallManager._type?b.type="VOICE":b.type="VIDEO",this._lastSR="MCU",this.p2pEstablished){this.log("fcsr:this.p2pEstablished:"+this._avfrwConnected),this.p2pEstablished=!1,this._lastSR=null;try{$("#spFPLClient")[0].hangup()}catch(d){}if(this._avfrwConnected)return void(this._avfrwConnected=!1)}}else{this._lastSR="P2P";var e=this.getZEvent(a,"type"),f=this.getZEvent(a,"connectmode"),g=this.getZEvent(a,"destination"),h=this.getZEvent(a,"isP2P"),i=this.getZEvent(a,"zenonserver"),j=this.getZEvent(a,"callerP2PAddress"),k=this.getZEvent(a,"command_id"),l=!0;e&&(e=e.replace("DIAL",""),"NONE"!=e&&"VOICE"!=e||(l=!1)),g&&(g.indexOf("#")==-1&&g.indexOf("%23")==-1&&(g=g+"%23"+LineStatesModel.getNextAvailableLine()),this._destination=g,h="true"),this._type=e,b.callerP2PAddress=j,b.command_id=k,b.type=e,b.connectmode=f,b.destination=g,b.isP2P=h,i?(b.zenonserver=i,ConnectionManager.updateZS(i)):ConnectionManager.getZS?b.zenonserver=ConnectionManager.getZS():b.zenonserver=window.location.host,b.protocol=this._protocol}if(b.width=this.cam_width,b.height=this.cam_height,b.inVideoWidth=this.in_video_width,b.inVideoHeight=this.in_video_height,b.fps=this.cam_fps,b.kfi=this.cam_kfi,b.username=DataStore.getUserData("username",""),b.service=ConnectionManager.service,this._bwdDone?b._userUp=this._userUp:b._userUp=this._minBwd,this._callEstablished&&this.command_id==-1&&"true"!=b.mcu){this._doingSR=!0,this._callEstablished=!1;try{$("#spFPLClient")[0].hangup()}catch(d){}}this.sendSR(b)}},deviceSelected:function(){this._flashVideoDiv&&(this._flashVideoDiv.removeClass("flash_tp_Setting"),this._flashVideoDiv.removeClass("flash_cam_cap_lv"),this._flashVideoDiv.removeClass("fp_setting_lv"),this._flashVideoDiv.removeClass("fp_setting_lv_tp"),this._flashVideoDiv.removeClass("flash_allow_deny"),this._flashVideoDiv.removeClass("rtcsettinglv")),$("#webRTCControls").show(),$("#resizeme").show(),this._resizable=!0,this._settingDialog=!1,flashSetting.removeListeners(),this.captureAgain(),this.showLV(),this.showVideoInWFC(),flashClient._bwdDone||this.startBandwidthDetection();try{this._showToolBar&&$("#spFPLClient")[0].showToolbar(!0),mediaAccessGranted()}catch(a){}},callEnded:function(a){this._doingSR||(ConnectionManager._dispatchEvent("FLASH_CALL_TERMINATED",{msg:""}),wrtcShowWFC(),this.showLV(),this.showVideoInWFC()),this._doingSR=!1},showLV:function(){try{$("#spFPLClient")[0].showCamInRV()}catch(a){}},showRV:function(){try{$("#spFPLClient")[0].showCamInLV()}catch(a){}this._flashVideoDiv&&(this._flashVideoDiv.addClass("flash_room"),this._flashVideoDiv.removeClass("rvContainerRoom1"))},showFlashClient:function(){var a=!1;try{a=wrtcSetting.usingNoCam}catch(b){}this._flashVideoDiv&&this._flashVideoDiv.css("opacity","1")},showVideoInWFC:function(){this._inCall=!1,(zwrtc.isUsingNoCam()||zwrtc.viewOnly)&&$("#sp_flash_container").addClass("pushed");try{$("#spFPLClient")[0].showFSBtn(!1)}catch(a){}$("#wrtc_fs_btn").hide(),$("#zc_toggle").hide(),zwrtc.callEstablished=!1,this._videoDisabled&&(this._videoDisabled=!1,webRTC.enableVideo()),this.showFlashClient(),this._flashVideoDiv&&(this._flashVideoDiv.removeClass("flash_room"),this._flashVideoDiv.removeClass("rvContainerRoom1"),this._flashVideoDiv.addClass("lvContainerRoom1"),wrtcSetting.tpDialog?this._flashVideoDiv.addClass("flash_room_rvinlv_tp"):this._flashVideoDiv.addClass("flash_room_rvinlv")),this.zcdivResized(),ConnectionManager._dispatchEvent("FLASH_STATE_WFC",{msg:""}),this.checkVideoMuted()},showVideoInCall:function(){if(this._inCall=!0,(zwrtc.isUsingNoCam()||zwrtc.viewOnly)&&$("#sp_flash_container").removeClass("pushed"),!this._settingDialog&&"SPK_TEST"!=this._state&&"SPK_TEST_DONE"!=this._state&&!this._showToolBar)try{$("#spFPLClient")[0].showFSBtn(this._displayFSBtn)}catch(a){}if($("#wrtc_fs_btn").hide(),zwrtc.callEstablished=!0,"VOICE"==this._type)try{if("SPK_TEST"==this._state);else{this._videoDisabled=!0,zwrtc.disableVideo(),audioCallEstablished(),ConnectionManager._dispatchEvent("ZWRTC_VOICECALL_PLACED",{msg:""});var b="/header/img/webrtc/audiocall.png";frames.communicator&&frames.communicator.$&&frames.communicator.$("#cockpit_event_photo_id").length>0&&(b=frames.communicator.$("#cockpit_event_photo_id")[0].src),$("#spFPLClient")[0].audioCallEstablished(b)}}catch(a){}this.showFlashClient(),this._flashVideoDiv&&(this._flashVideoDiv.removeClass("lvContainerRoom1"),this._flashVideoDiv.removeClass("flash_room_rvinlv"),this._flashVideoDiv.removeClass("flash_room_rvinlv_tp"),this._flashVideoDiv.addClass("flash_room")),this.zcdivResized(),this.checkVideoMuted()},checkVideoMuted:function(){try{var a={};"VOICE"==this._type?a.mute=!0:a.mute=webRTC.isVideoMuted,zwrtc.isUsingNoCam()&&(a.mute=!0,$("#spFPLClient")[0].showLV(!1)),this.flashMuteCam(a),a.mute=webRTC.isAudioMuted,this.flashMuteMic(a)}catch(b){}},embedFlash:function(a,b,c){if(!this.flashEmbeded){if(this.fpVersion=fpVersion=swfobject.getFlashPlayerVersion(),null==fpVersion||fpVersion.major<CallManager.fpVersion){try{var d="<br>Unable to proceed without Adobe Flash<br><br><a href='http://get.adobe.com/flashplayer/' target='_blank'>Please install Adobe Flash</a>";null==fpVersion||fpVersion.major<1?CallManager.mediaConnectionFailed("FLASH_ERROR",{msg:d,error:"install"}):CallManager.mediaConnectionFailed("FLASH_ERROR",{msg:d,error:"old"}),$("#wrtc_bwd_test").show(),$("#bwdResultDiv").show(),$("#img_tech_result").show(),$("#img_tech_result").attr("src",""),$(".webrtc_tech_result").text(""),$("#bwdResultInfo").length>0?$("#bwdResultInfo").html(d):$("#zwrtc_av").html(d),$("#wbwdtest_btn").hide(),$("#wbwdtestagain_btn").hide()}catch(e){}return!1}this.flashEmbeded=!0;var f=CallManager.fpVersion+".0.0",g="/user/swf/playerProductInstall.swf";zwrtc._useCustomGUI&&(g="user/swf/playerProductInstall.swf");var h={};h.enableLogging="true",h.logLevel="4",h.failOverPriority=this._failOverPriority,h.timerOnRV=this._timerOnRV,h.stageBGColor=this._stageBGColor,h.rtmfpPort=this._rtmfpPort,h.rtmpPort=this._rtmpPort,h.srttMlt=this.srttMlt,h.firstStepTh=this.firstStepTh,h.firstStepSapLen=this.firstStepSapLen,h.secondStepTh=this.secondStepTh,h.secondStepSapLen=this.secondStepSapLen,"talkpoint"==ConnectionManager.partner&&(h.showTPFsIcn=!0),h._show_call_timer=this._show_call_timer,c&&(h.streamMode=c),zwrtc.viewOnly&&(h.viewOnly="true"),this.cdreliable?h.cdreliable="true":h.cdreliable="false",this.monitorZCDStreams?h.monitorZCDStreams="true":h.monitorZCDStreams="false",h.audioSampleMultiplier=this._asm,this._ratio=this.cam_width/this.cam_height,h.ratio=this._ratio,this.forcedBR>-1&&(h.forcedBR=this.forcedBR),this.forcedQuality>-1&&(h.forcedQuality=this.forcedQuality),h.useSepAudioStream=this.useSepAudioStream,h.unbuffered=this.unbuffered;var i={};i.quality="high",i.bgcolor=this._bgColor,i.allowscriptaccess="always",i.allowfullscreen="true",i.FullScreenOnSelection="false";var j=navigator.appVersion;j&&j.indexOf("Windows")!=-1&&j.indexOf("Chrome")==-1&&j.indexOf("Safari")!=-1?i.wmode="opaque":i.wmode="window";var k={};k.id="spFPLClient",k.name="spFPLClient",k.align="center";var l="/user/swf/zc.swf";zwrtc._useCustomGUI&&(l="user/swf/zc.swf"),a&&(this._flashClient=a),b&&(l=b),swfobject.embedSWF(l,this._flashClient,"100%","100%",f,g,h,i,k)}return this._flashVideoDiv&&this._flashVideoDiv.show(),!0},embedBwdSwf:function(){if(!this.flashBwdEmbeded){this.flashBwdEmbeded=!0;var a=CallManager.fpVersion+".0.0",b="/user/swf/playerProductInstall.swf";zwrtc._useCustomGUI&&(b="user/swf/playerProductInstall.swf");var c={},d={};d.quality="high",d.bgcolor="#FFFFFF",d.allowscriptaccess="always",d.allowfullscreen="true",d.FullScreenOnSelection="false",d.wmode="opaque";var e={};e.id="spBwdClient",e.name="spBwdClient",e.align="center";var f="/user/swf/bwd.swf";zwrtc._useCustomGUI&&(f="user/swf/bwd.swf"),swfobject.embedSWF(f,"sp_flash_bwd","1","1",a,b,c,d,e)}},initializeSetting:function(){this.log("initializeSetting"),(ConnectionManager.doBlackboard||this.flashEmbeded||this.embedFlash())&&(ConnectionManager._dispatchEvent("SETTING_DISPLAY_FP_ALLOW_DENY",{msg:""}),flashSetting.init())},isCamAvailable:function(){var a=null;try{a=$("#spFPLClient")[0].getDeviceList(!1)}catch(b){}if(a)for(var c=0;c!=a.length;++c){var d=a[c];if("video"===d.kind)return!0}return!1},isMicAvailable:function(){var a=null;try{a=$("#spFPLClient")[0].getDeviceList(!1)}catch(b){}if(a)for(var c=0;c!=a.length;++c){var d=a[c];if("audio"===d.kind)return!0}return!1},initFlashRVEvents:function(){},sendLowBrZebra:function(a){var b="BandLowWithVideo";if(a){if("UP"==a.dir)return;if(this.lastLowBrZebraSent&&"BandLowWithVideo"===this.inLowBrMode){var c=(new Date).getTime();c-this.lastLowBrZebraSent>=5e3&&(b="BandLowAudioOnly")}}this.sendBandwidthModeZebra(a,b)},sendBandwidthModeZebra:function(a,b){if(this.inLowBrMode===b||"BandLowAudioOnly"===this.inLowBrMode)return void this.log("Ignoring sendBandwidthModeZebra:"+this.inLowBrMode);this.inLowBrMode=b,this.lastLowBrZebraSent=(new Date).getTime();var c=0,d=0,e=0;a&&(null!=a.kbPerSec&&(c=a.kbPerSec),null!=a.avgSrtt&&(d=a.avgSrtt),null!=a.srtt&&(e=a.srtt)),CallManager.sendBandwidthModeZebra(b,c,d,e)},setSpkVolume:function(a){!isNaN(a)&&a>-1&&(this._spkVolume=a,$("#spFPRVClient")[0].setSpkVolume(this._spkVolume))},onRVInvoke:function(a,b){switch(this.log("RV:onRVInvoke:"+a+" "+b),a){case"swfInitialized":$("#spFPRVClient")[0].tabIndex=this.tabIndex,this.playLastRVSR(),this._rvEmbedded=!0;break;case"avfrwError":break;case"switchToLowBR":this.sendLowBrZebra(b);case"remoteVideoRecvd":CallManager._dispatchEvent(CallManager.Event.CONNECTED,{type:"mcu",conn_type:"FLASH_RV"}),rtcSFU.audioVideoReceived(),webRTC.isAudioMuted||rtcSFU.sendVadZebra(1,1)}},embedFlashRV:function(a,b){var c=swfobject.getFlashPlayerVersion();
if(null==c||c.major<CallManager.fpVersion)return!1;var d=CallManager.fpVersion+".0.0",e="user/swf/playerProductInstall.swf",f={};f.enableLogging="true",f.logLevel="4",f.timerOnRV=!1,f._show_call_timer=!1,f.jsCallBack="onRVInvoke",f.streamMode="PLAY",f.service="saturn",f.viewOnly="true",f.stageBGColor=this._stageBGColor,f.rtmfpPort=this._rtmfpPort,f.srttMlt=this.srttMlt,this.cdreliable?f.cdreliable="true":f.cdreliable="false",this.monitorZCDStreams?f.monitorZCDStreams="true":f.monitorZCDStreams="false",this.enableBufferTime&&(f.bufferTime=this.bufferTime,f.bufferTimeMax=this.bufferTimeMax),f.useSepAudioStream=this.useSepAudioStream,f.unbuffered=this.unbuffered,f.firstStepTh=this.firstStepTh,f.firstStepSapLen=this.firstStepSapLen,f.secondStepTh=this.secondStepTh,f.secondStepSapLen=this.secondStepSapLen;var g={};g.quality="high",g.bgcolor=this._bgColor,g.allowscriptaccess="sameDomain",g.allowfullscreen="true",g.FullScreenOnSelection="false",g.wmode="transparent";var h={};h.id="spFPRVClient",h.name="spFPRVClient",h.align="center";var i="user/swf/zc.swf";return b&&(i=b),swfobject.embedSWF(i,a,"100%","100%",d,e,f,g,h),!0},log:function(a){Platform.log(a)}},flashSetting={audioSource:[],videoSource:[],deviceListPopulated:!1,initialized:!1,_disableInCallDeviceSelection:!0,init:function(){this.initialized||(this.initialized=!0,ConnectionManager.addListener("SETTING_DEVICES_CHANGED",this,this.devicesChanged),ConnectionManager.addListener("SETTING_LISTEN_MIC",this,this.listenMicPressed),ConnectionManager.addListener("SETTING_WEBCAM_DISABLED",this,this.webcamDisabled),ConnectionManager.addListener("SETTING_WEBCAM_ENABLED",this,this.webcamEnabled),ConnectionManager.addListener("SETTING_SHOW_DEVICE_LIST",this,this.getDeviceList),ConnectionManager.addListener("SETTING_UPDATE_DEVICE",this,this.updateDevice))},updateDevice:function(){log("Selected Camera:"+$("#dw_cam_combo option:selected").text()),log("Selected Microphone:"+$("#dw_mic_combo option:selected").text()),log("Selected Camera source id:"+$("#dw_cam_combo option:selected").val()),log("Selected Microphone source id:"+$("#dw_mic_combo option:selected").val());var a=$("#dw_mic_combo option:selected").val(),b=$("#dw_cam_combo option:selected").val();"PHONE"!=a&&$("#spFPLClient")[0].setMicrophone(parseInt(a)),"NONE"!=b&&$("#spFPLClient")[0].setCamera(parseInt(b))},getDeviceList:function(){var a=null;try{a=$("#spFPLClient")[0].getDeviceList(!1)}catch(b){}if(a){var c=this.audioSource,d=this.videoSource;c.length=0,d.length=0;for(var e=0;e!=a.length;++e){var f=a[e];wrtcSetting.log(f.kind+" "+f.label+" "+f.id);var g=!1;if("true"==f.selected&&(g=!0),"audio"===f.kind){var h=f.label||"microphone "+c.length;c[c.length]={id:f.id,label:h,selected:g}}else if("video"===f.kind){var h=f.label||"camera "+d.length;d[d.length]={id:f.id,label:h,selected:g}}}}this.displayDeviceList()},displayDeviceList:function(){$("#dw_cam_combo option").remove(),$("#dw_mic_combo option").remove();var a=this.audioSource,b=this.videoSource;if(this._disableInCallDeviceSelection){for(var c="Camera",d="Microphone",e=0;e<a.length;e++){var f=a[e];f.id==zwrtc.audioSourceID&&(d=f.label)}wrtcSetting.usingPhone&&(d=Z.zjs.ZLocale.getString("zjs_telephone","Telephone"));for(var e=0;e<b.length;e++){var f=b[e];f.id==zwrtc.videoSourceID&&(c=f.label)}wrtcSetting.usingNoCam&&(c=wrtcSetting.noVideo),$("#dw_devicelist_container")[0].innerHTML="<br><span>&nbsp;<b>Video:</b></span><input type='text' style='width:70%;margin-left:10px;' id='dw_cam_txt' value='"+c+"' disabled><br><br><span>&nbsp;<b>Audio:</b></span><input type='text' style='width:70%;margin-left:10px;' value='"+d+"' id='dw_mic_txt' disabled>"}else{for(var e=0;e<a.length;e++){var f=a[e];f.selected?$("#dw_mic_combo").append($("<option selected='selected'></option>").attr("value",f.id).text(f.label)):$("#dw_mic_combo").append($("<option></option>").attr("value",f.id).text(f.label))}wrtcSetting.usingPhone&&$("#dw_mic_combo").append($("<option selected='selected'></option>").attr("value","PHONE").text(Z.zjs.ZLocale.getString("zjs_telephone","Telephone")));for(var e=0;e<b.length;e++){var f=b[e];f.selected?$("#dw_cam_combo").append($("<option selected='selected'></option>").attr("value",f.id).text(f.label)):$("#dw_cam_combo").append($("<option></option>").attr("value",f.id).text(f.label))}wrtcSetting.usingNoCam&&$("#dw_cam_combo").append($("<option selected='selected'></option>").attr("value","NONE").text(wrtcSetting.noVideo))}},removeListeners:function(){ConnectionManager.removeListener("SETTING_DEVICES_CHANGED",this,this.devicesChanged),ConnectionManager.removeListener("SETTING_LISTEN_MIC",this,this.listenMicPressed),ConnectionManager.removeListener("SETTING_WEBCAM_DISABLED",this,this.webcamDisabled),ConnectionManager.removeListener("SETTING_WEBCAM_ENABLED",this,this.webcamEnabled),this.webcamEnabled()},webcamDisabled:function(a){flashClient._flashVideoDiv.addClass("fp_setting_pushed")},webcamEnabled:function(a){flashClient._flashVideoDiv.removeClass("fp_setting_pushed")},listenMicPressed:function(a){if(a&&a.mode&&$("#spFPLClient")[0])try{$("#spFPLClient")[0].listenButtonPressed(a.mode)}catch(b){}},devicesChanged:function(a){try{var b=a.audioSourceID,c=a.videoSourceID;$("#spFPLClient")[0].setMicrophone(parseInt(b)),$("#spFPLClient")[0].setCamera(parseInt(c))}catch(d){}},devicesAvailable:function(a){if(a){this.deviceListPopulated=!0;var b=this.audioSource,c=this.videoSource;b.length=0,c.length=0;for(var d=0;d!=a.length;++d){var e=a[d],f=!1;if(e.selected&&(f=!0),wrtcSetting.log(e.kind+" "+e.label+" "+e.id),"audio"===e.kind){var g=e.label||"microphone "+b.length;b[b.length]={id:e.id,label:g,selected:f}}else if("video"===e.kind){var g=e.label||"camera "+c.length;c[c.length]={id:e.id,label:g,selected:f}}}}ConnectionManager._dispatchEvent("SETTING_DEVICELIST_POPULATED",{audioSource:this.audioSource,videoSource:this.videoSource,mode:"FLASH"});try{$("#spFPLClient")[0].showCamInRV()}catch(h){}}},ORTCUtils={getRTCRtpParameters:function(a,b,c){if(this.debugLog("getRTCRtpParameters sendCapabilities:="+a+" receiveCapabilities:="+b),!a||!b||!c)return this.debugLog("One of sendCapabilities || receiveCapabilities || remoteSender is null"),null;this.debugLog("Local send Capabilities:"+JSON.stringify(a)),this.debugLog("Remote receive Capabilities:"+JSON.stringify(b));var d=this.getCommonCodec(a.codecs,b.codecs);if(!d)return this.debugLog("No common send & receive codecs found"),null;var e=Math.round(Math.random()*Math.pow(2,32)),f="cname_for_"+e,g=1,h=20,i=!0;c&&c.encodings&&c.encodings.length>0&&(g=c.encodings[0].ssrc,h=c.encodings[0].maxFramerate,i=c.rtcp.compound);var j=[d],k=null,l=this.getRtxCodec(b.codecs,d);return l&&(k={ssrc:Math.round(Math.random()*Math.pow(2,32))},j.push(l)),this.RTCRtpParameters(j,this.getCommonHdrExt(a.headerExtensions,b.headerExtensions),[this.RTCRtpEncodingParameters(e,d.payloadType,h,k)],this.RTCRtcpParameters(g,f,i))},RTCRtpParameters:function(a,b,c,d,e){return{codecs:a,headerExtensions:b,encodings:c,rtcp:d,muxId:e}},RTCRtcpParameters:function(a,b,c,d){return{ssrc:a,cname:b,compound:void 0===c||c,mux:void 0===d||d}},RTCRtpEncodingParameters:function(a,b,c,d,e,f){return{ssrc:a,codecPayloadType:b,maxFramerate:c||20,rtx:d,fec:e,active:f||!0}},getCommonFeedback:function(a,b){for(var c=[],d=0;d<a.length;++d)for(var e=0;e<b.length;++e)if(a[d].type===b[e].type&&a[d].parameter===b[e].parameter){c.push(a[d]);break}return c},getCommonCodec:function(a,b){for(var c=0;c<b.length;c++)for(var d=b[c],e=0;e<a.length;e++){var f=a[e];if(f.kind===d.kind&&f.name.toUpperCase()===d.name.toUpperCase()&&"RTX"!==f.name.toUpperCase()&&f.clockRate===d.clockRate&&f.numChannels===d.numChannels)return{name:f.name,payloadType:d.preferredPayloadType,clockRate:d.clockRate,numChannels:d.numChannels,maxptime:d.maxptime,ptime:d.ptime,rtcpFeedback:this.getCommonFeedback(f.rtcpFeedback,d.rtcpFeedback),parameters:d.parameters}}return null},getRtxCodec:function(a,b){for(var c=0;c<a.length;c++){var d=a[c];if("RTX"===d.name.toUpperCase()&&d.parameters.apt==b.payloadType)return{name:d.name,payloadType:d.preferredPayloadType,clockRate:b.clockRate,rtcpFeedback:[],parameters:{apt:b.payloadType}}}return this.debugLog("Could not find matching RTX pt",b.payloadType),null},getCommonHdrExt:function(a,b){for(var c=[],d=0;d<b.length;d++)for(var e=b[d],f=0;f<a.length;f++){var g=a[f];if(g.kind===e.kind&&g.uri===e.uri){c.push({uri:e.uri,id:e.preferredId,encrypt:e.preferredEncrypt});break}}return c},debugLog:function(a){(this.logEnabled||Platform.debugLogEnabled)&&Platform.log("ORTCUtils:"+this._sfuType+" "+a)}},rtcSFU={rvCompositeHigh:null,rvCompositeLow:null,desktopStream:null,desktopStreamLow:null,_rvAudioRecordingCall:null,rvSFUArray:{},sfuVidReference:{},mssrcStreams:{},mssrcVidReference:{},_sfuStreams:{},_localView:null,_eventsInitialized:!1,_sfuRVArray:null,_mainRV:null,SFU_MAX_LEN:4,SFU_MAX_VIDEO_LEN:4,_username:null,_host:null,_destination:null,_localView:null,_localStream:null,_audioStream:null,_lowResolStream:null,_voice:!1,screenCallBwLimit:1200,screenCallBwLowLimit:400,_compositeBw:350,_compositeBwDrop0:350,_compositeBwDrop1:300,_compositeBwDrop2:300,_sfuBw:800,_bwMargin:150,_sfuThreshold:100,_callGoingOn:!1,CONST_STRING_HIGH:"HIGH",CONST_STRING_LOW:"LOW",CONST_STRING_AUDIO_RECORD:"AUDIO_RECORDING",CONST_STRING_SCREEN:"SCREEN",CONST_STRING_SCREEN_LOW:"SCREEN_LOW",CONST_STRING_RVSH:"SHADOW_",CONST_STRING_RVCH:"SHADOW_RV_C_High_",CONST_STRING_RVCL:"SHADOW_RV_C_Low_",CONST_STRING_RVSFU:"SHADOW_RV_SFU_",CONST_STRING_RVSS:"SHADOW_SCREEN_",CONST_STRING_RVSSL:"SHADOW_SCREEN_LOW_",_debug:!1,_debugConnCount:0,_useProxy:!1,_queueSize:0,_lastPLTS:-1,_plThDuration:3e3,playMedia:!1,_useSimulcast:!1,_useScreenSimulcast:!1,_useMcuZebra:!1,_useMcuOffer:!1,_confQueueSize:0,_publishingSS:!1,_enableIceRenegotiation:!1,_rvStreamAttached:!1,_enableLocalCandidates:!1,enableVAD:!0,resetSFUConnection:!1,_useRoomAndUserid:!0,_userRoomMcuDel:"_SAT_",_userRoomMcuPrefix:"VB",renegotiateCamOnMute:!1,checkForMedia:!0,forceVadDuration:0,vadMultiplier:1,sendZebraToZS:!1,enableAudioNack:!1,reconnectHappen:"false",enableHangConst:!1,lastActivityZebraTs:0,ffOutMediaCheckTh:5e3,topSfuSlot:"0",mutedVadSent:!1,onAudioProcessWorking:!1,micLevelPermutation:[0,1,2,3,4,4,5,5,5,5,6,6,6,6,6,7,7,7,7,8,8,8,9,9,9,9,9,9,9,9,9,9,9],iceTransportPolicy:null,turnProtocol:null,logEnabled:!1,remotePeerSpeaking:!1,useIceCandTo:!0,iceDisconnectCount:0,checkMcuVideo:!1,noVideoTh:1500,noVideoAvatarTh:5e3,rmsToVadMul:5e3,iceGatheringTO:5e3,sdpSemantics:null,edgeSupportsSingleTurn:!0,audioSamplesArr:[],micActivityPeriod:2e3,audioSampleSize:400,maxPeakTh:100,silenceOffeset:50,iceTransportPolicies:{ALL:"all",RELAY:"relay"},iceCandTypes:{ALL:"all",TURN:"udp_tcp_tls",TURN_TCP_TLS:"tcp_tls",TURN_TLS:"tls"},enableIceCandRestriction:!1,iceRestrictionTH:15e3,iceCandType:"",init:function(a,b){this._mainRV=a,this._sfuRVArray=b,this.initEventListener(),zwrtc._enableSFU?this._compositeBw=this._compositeBwDrop0:this._compositeBw=webRTC.bandwidth.video||700},initEventListener:function(){if(!this._eventsInitialized){this._eventsInitialized=!0,this.iceCandType=this.iceCandTypes.ALL,ConnectionManager.addListener("ZWRTC_REMOTE_STREAM_ATTACHED",this,this.mcuStreamAttached),ConnectionManager.addListener("ZWRTC_CALL_ESTABLISHED",this,this.callEstablished),ConnectionManager.addListener("ZEBRA:MULTI_ALTERNATIVE_STREAM",this,this.maptParser),ConnectionManager.addListener("ZEBRA:SFUChannels",this,this.handleSfuChannel),ConnectionManager.addListener("ZWRTC_MEDIA_LEG_CLOSED",this,this.mediaLegClosed),ConnectionManager.addListener("REMOTE_STREAM_ATTACHED_0",this,this.sfuZeroConnected),ConnectionManager.addListener("SS_STREAM_ACCESSED",this,this.placeSSCall),ConnectionManager.addListener("SS_STREAM_CLOSED",this,this.endSSCall),ConnectionManager.addListener("ZEBRA:GET_STATE_FROM_MCU:response",this,this.gotStateFromMCU);var a=this;ConnectionManager.addListener("ZWRTC_P2P_ESTABLISHED",null,function(b){a._useProxy&&null==a.rvCompositeHigh&&(b&&b.rstream&&(a._localStream=b.rstream),a._callGoingOn=!0,a.createMediaConnection(a.CONST_STRING_HIGH))}),window.onbeforeunload=function(){this.rvCompositeHigh&&this.rvCompositeHigh.closePC(this.rvCompositeHigh.peerConnection)}}},nextIceCandType:function(){switch(this.iceCandType){case this.iceCandTypes.ALL:if(this.iceGatheringTO=1e4,ConnectionManager.isFF())return void(this.iceCandType=this.iceCandTypes.TURN_TLS);this.iceCandType=this.iceCandTypes.TURN;break;case this.iceCandTypes.TURN:this.iceCandType=this.iceCandTypes.TURN_TCP_TLS;break;case this.iceCandTypes.TURN_TCP_TLS:this.iceCandType=this.iceCandTypes.TURN_TLS}},checkStateAndReconnect:function(a,b){this.log("checkStateAndReconnect: "+a+" zsState:"+ConnectionManager.zsState),"busy"==ConnectionManager.zsState&&(b&&(a=b+"_"+a),this.createMediaConnection(a))},isMediaConnected:function(){return!!this.rvCompositeHigh&&this.rvCompositeHigh.isMediaConnected()},mediaLegClosed:function(a){if(a&&null!=a.sfuType){var b=a.sfuType,c=a.sfu_media,d=a.error_msg;if(this.log("Media connection closed for "+b+" callGoingOn:"+this._callGoingOn),this._callGoingOn)if(b==this.CONST_STRING_HIGH){this.rvCompositeHigh=null,this._rvStreamAttached=!1,this.log("mediaLegClosed:connectToMCU");var e=null;this.desktopStream&&(e=this.desktopStream.getIceState()),"connected"===e||"completed"===e?this.createMediaConnection(this.CONST_STRING_HIGH):CallManager.redialCall(d)}else if(b==this.CONST_STRING_LOW)this.rvCompositeLow=null,this.checkStateAndReconnect(b,c);else if(b==this.CONST_STRING_AUDIO_RECORD);else if(b==this.CONST_STRING_SCREEN)this.desktopStream=null,this._publishingSS=!1,ConnectionManager._dispatchEvent("SCREEN_SHARE_RECONNECTING"),this.placeSSCall();else{var f=b;if(!this._sfuRestricted){var g=this.rvSFUArray[f];delete this.rvSFUArray[f],this.checkStateAndReconnect(f,c);var h=this.rvSFUArray[f];g&&(h._userId=g._userId,h.sfu_media=c,h._muted=g._muted),this.log("sfuObj._userId"+h._userId)}}}},updateProxy:function(a,b,c){this._useProxy=!0,this._username=a,this._voice=!1,this._host=b,c=DataStore.getUserData("mcu_sip_port",c),this._destination="sip:rtcshadowscreen@"+this._host,c&&c.length>0&&(this._destination=this._destination+":"+c)},p2pEstablished:function(a){this._useProxy&&null==this.rvCompositeHigh&&(a&&a.rstream&&(this._localStream=a.rstream),this._callGoingOn=!0,this.createMediaConnection(this.CONST_STRING_HIGH))},mcuStreamAttached:function(){},callEstablished:function(a){this.checkComposite(!1),this._pendingNegotiation&&this.rvCompositeHigh&&this.rvCompositeHigh._callEstablished?(this._pendingNegotiation=!1,this.rvCompositeHigh.hangup(!0,"callEstablished: redialling due to _pendingNegotiation")):this.establishSSIfPossible(),this._lastMAPTZebra&&(this.debugLog("Process Last MAPT again"),this.maptParser(this._lastMAPTZebra))},establishSSIfPossible:function(){this.isStreamActive(ssController.desktopStream)&&this.placeSSCall()},getZEvent:function(a,b,c){try{return a.getZEvent(b).value}catch(d){}return c},freeDevices:function(){this.stopStreamTracks(this._audioStream),this.stopStreamTracks(this._localStream)},sortNumber:function(a,b){return a-b},updateMicSourceId:function(){if(null!=zwrtc.audioSourceID)this.lastMicSourceId=zwrtc.audioSourceID;else{var a=webRTC.localStream;null!=a&&a.getAudioTracks().length>0&&(this.lastMicLabel=a.getAudioTracks()[0].id)}},startMicMuteTest:function(){var a=!1;if(null!=zwrtc.audioSourceID)this.lastMicSourceId!=zwrtc.audioSourceID&&(a=!0);else{var b=webRTC.localStream;null!=b&&(0==b.getAudioTracks().length?"NONE"!=this.lastMicLabel&&("NONE"==this.lastMicLabel,this.dispatchMicNotWorking()):b.id!=this.lastMicLabel&&(a=!0))}a&&(this.debugLog("starting mic mute test"),this.micMuteTestStartTS=0,this.doMicMuteTest=!0)},dispatchMicNotWorking:function(){this.log("dispatch event mic not working"),this.updateMicSourceId(),ConnectionManager._dispatchEvent("MIC_NOT_WORKING"),CallManager.uploadConsoleLogs("Mic not working i.e. no activity detected")},dispatchMicWorking:function(){this.debugLog("dispatch event mic working"),this.updateMicSourceId(),ConnectionManager._dispatchEvent("MIC_WORKING"),rtcSFU.rvCompositeHigh&&(rtcSFU.rvCompositeHigh.micWorking=!0,rtcSFU.rvCompositeHigh.deviceToggled())},vadGenerated:function(a){var b=DateTimeUtil.getNow();if(b-ConnectionManager.zebraDebugTs>=6e4&&ConnectionManager.doZebraDebug(),TechCheck.isAudioMuted)return void(this.mutedVadSent||(this.mutedVadSent=!0,this.sendVadZebra(0,0)));if(this.mutedVadSent=!1,ConnectionManager.isUsingPlugin||(a>200?(this.audioExceeds++,this.audioExceeds<this.isSpeaking&&(a=190)):this.audioExceeds=0),this.doMicMuteTest&&(a>0?(this.dispatchMicWorking(),this.doMicMuteTest=!1):0==this.micMuteTestStartTS?this.micMuteTestStartTS=b:b-this.micMuteTestStartTS>=5e3&&(this.dispatchMicNotWorking(),this.doMicMuteTest=!1)),this.audioSamplesArr&&this.enableVAD&&"busy"==ConnectionManager.zsState){if(this.audioSamplesArr.length>=this.audioSampleSize){var c=this.audioSamplesArr.shift();if(this.sortedAudioSamplesArr){var d=this.sortedAudioSamplesArr.indexOf(c);d!=-1&&this.sortedAudioSamplesArr.splice(d,1)}}a<this.maxPeakTh?0==this.lastActivityBelowTh?this.lastActivityBelowTh=b:b-this.lastActivityBelowTh>=this.micActivityPeriod&&(a=0):this.lastActivityBelowTh=0,this.audioSamplesArr.push(a),null==this.sortedAudioSamplesArr?this.sortedAudioSamplesArr=this.audioSamplesArr.slice(0):this.sortedAudioSamplesArr.push(a),this.sortedAudioSamplesArr.sort(this.sortNumber);var e=3*this.sortedAudioSamplesArr[Math.floor(this.sortedAudioSamplesArr.length/2)]/2;this.forceVadDuration>0?b-this.lastActivityZebraTs>=this.forceVadDuration&&this.sendVadZebra(e,a):b-this.lastActivityZebraTs>=this.micActivityPeriod?this.sendVadZebra(e,a):this.audioExceeds>=this.isSpeaking&&this.audioExceedsAtLastSend<this.isSpeaking&&this.sendVadZebra(e,a);var f=e+this.silenceOffeset;a>f?(this.userSpeaking||(this.userSpeaking=!0),this.lastSilencectivity=0):this.userSpeaking&&f<this.maxPeakTh&&(0==this.lastSilencectivity?this.lastSilencectivity=b:b-this.lastSilencectivity>=3e3&&(this.userSpeaking=!1))}if(CallManager.micActivityEnabled){var g={max:a,min:0,from:"rtc"};ConnectionManager.userId&&(g.userId=ConnectionManager.userId),ConnectionManager._dispatchEvent("MIC_ACTIVITY",g)}},onaudioprocess:function(a){var b=this.getAudioInputLevel(),c=Math.max(a,b);rtcSFU.enableVadDebug&&console.log("MaxVad from sample:"+a+" audioInputLevel:"+b+" vadToUse:"+c),this.vadGenerated(c)},getAudioInputLevel:function(){return ConnectionManager.isUsingPlugin?this.getMicAudioLevel(P2PMicActivity.audioInputLevel):this.rvCompositeHigh&&this.rvCompositeHigh.connDebug&&null!=this.rvCompositeHigh.connDebug.audioInputLevel?this.getMicAudioLevel(this.rvCompositeHigh.connDebug.audioInputLevel):-1},startMicStatsCheck:function(){if(!this.onAudioProcessWorking){var a=this;this.micStatsCheckIntv&&clearInterval(this.micStatsCheckIntv);var b=ConnectionManager.isUsingPlugin?200:500;this.micStatsCheckIntv=setInterval(function(){a.onAudioProcessWorking?a.stopMicStatsCheck():a.vadGenerated(a.getAudioInputLevel())},b)}},stopMicStatsCheck:function(){this.micStatsCheckIntv&&clearInterval(this.micStatsCheckIntv),this.micStatsCheckIntv=null},stopMicActivity:function(a){CallManager.micActivityEnabled&&!a},gotStateFromMCU:function(a){if(a){var b=this.getZEvent(a,"STATE","BUSY");if(this.log("gotStateFromMCU:"+b+" callConnected:"+zwrtc.isConnected()),"BUSY"!=b&&zwrtc.isConnected()){this.stopStatePollIntv();var c="Looks like MCU was restarted and doesn't have call info, so redial call";this.log(c),CallManager.redialCall(c)}}},sendVadZebra:function(a,b,c){if(!this.disableVAD){if(null==c){if(CallManager.telephonyActive)return;this.forceVadDuration>2e4&&!TechCheck.isAudioMuted?b=Math.floor(20*Math.random())+200:this.forceVadDuration==-1?b=a=0:b<1&&!TechCheck.isAudioMuted&&(b=1),CallManager.micNotWorking&&b>1&&ConnectionManager._dispatchEvent("MIC_START_WORKING"),this.lastActivityZebraTs=(new Date).getTime(),this.lastAudioPeakValue=b,this.audioExceedsAtLastSend=this.audioExceeds,0==b&&0==a&&(this.lastActivityZebraTs=0)}var d=b>0;if(!d){if(CallManager.checkMicEnabledState)return;if(d===CallManager.lastMicEnabledState)return}CallManager.checkMicEnabledState=!1,CallManager.lastMicEnabledState=d;var e=null;CallManager.vadValue=b*=this.vadMultiplier,e=new Zebra("ClientToZMCUUserProps"),e.setZEvent("isSpeaking",String(b)),e.setZEvent("silence",String(a)),e.setZebraAttribute("userId",this.getUserName()),ConnectionManager.sendZebraToMCU(e),null==this.VadZebraMap?this.VadZebraMap=[]:(this.VadZebraMap.push(b+":"+a),(this.VadZebraMap.length>=5||0===b)&&(this.log("VadDetails: "+JSON.stringify(this.VadZebraMap)),this.VadZebraMap.length=0)),e&&this.debugLog("sendVadZebra:"+e.toXML())}},placeCall:function(a,b,c,d,e,f){if(this._callGoingOn&&(this.rvCompositeHigh||this.rvCompositeLow)&&this.hangup(!1,"rtcSFU: placeCall: hangup old call"),this._username=a,this._host=b,this._destination=c,this._localView=f,this.iceDisconnectCount=0,e&&(this._localStream=e),this._voice=d,webRTC.doUnMute(),this._debug){var g=CallManager._videoWidth,h=CallManager._videoHeight,i=g,j=h,k=0,l=0;2==this._debugConnCount?(i=g/2,j=h/2):this._debugConnCount>=3&&(i=g/3,j=h/3);var m=0,n=this,o=setInterval(function(){if(m<n._debugConnCount){var a=n.getSFUConnection(m);n.log("SFU indx:"+m),n.log("posHeight:"+j),n.log("posWidth:"+i),n.log("posX:"+k),n.log("posY:"+l),a&&(a._muted=!1,a.loadAvatar("123"),a.setRV(k,l,i,j,CallManager._videoWidth,CallManager._videoHeight,n._mainRV));var b=m+1;b%3==0?(k=0,l+=j):k+=i,m++}else clearInterval(o)},2e3)}else this._callGoingOn=!0,this.createMediaConnection(this.CONST_STRING_HIGH)},hangup:function(){this.log("rtcSFU:hangup"),this._queueSize=0,this._publishingSS=!1,this._callGoingOn=!1,this._pendingComposite=!1,this._pendingNegotiation=!1,this._lastPLTS=-1,this._rvStreamAttached=!1,this.topSfuSlot="0",rtcSFU.connDebug={},this.enableVAD&&this.stopMicActivity(),this._mainRV&&this._mainRV.hide(),this.rvCompositeHigh&&this.rvCompositeHigh.hangup(!1,"rtcSFU: hangup composite high"),this.rvCompositeLow&&this.rvCompositeLow.hangup(!1,"rtcSFU: hangup composite low"),this._rvAudioRecordingCall&&this._rvAudioRecordingCall.hangup(!1,"rtcSFU: hangup audio recording call");for(var a in this.rvSFUArray){var b=this.rvSFUArray[a];delete this.rvSFUArray[a],b&&(b.setRV(-1,-1,-1,-1,-1,-1),b.hangup(!1,"rtcSFU: hangup sfuMediaConn"))}this.rvCompositeHigh=null,this.rvCompositeLow=null,this.rvSFUArray={},this._sfuRestricted=!1,zwrtc._enableSFU?this._compositeBw=this._compositeBwDrop0:this._compositeBw=webRTC.bandwidth.video||700},fullScreenStatus:function(){return document.fullscreen||document.mozFullScreen||document.webkitIsFullScreen},resize:function(){if(!zwrtc._useCustomGUI){var a=null,b=this._mainRV;this._sfuRVArray&&this._sfuRVArray.length>1&&this._sfuRVArray[0]&&(b=this._sfuRVArray[0].parent()),b&&(a=b.parent(),a&&(this.fullScreenStatus()?a.hasClass("fs_mode")||a.addClass("fs_mode"):a.removeClass("fs_mode")));for(var c in this.rvSFUArray){var d=this.rvSFUArray[c];d&&d.resize()}this.checkComposite()}},attachLowBRStream:function(a){this.rvCompositeHigh.remoteStream=a,this._rvStreamAttached=!0;var b="audiovideo";"BandLowAudioOnly"==CallManager.lowBrMode&&(b="audio"),ConnectionManager._dispatchEvent("ZWRTC_ATTACH_RV_STREAM",{stream:this.rvCompositeHigh.remoteStream,id:this.rvCompositeHigh._objID,mode:b,composite:"true",userId:this.rvCompositeHigh._userId})},handleLowBrMode:function(a){if(this._callGoingOn)if(CallManager.compositePaused)this._rvStreamAttached&&(this._rvStreamAttached=!1,ConnectionManager._dispatchEvent("ZWRTC_REMOVE_RV_STREAM",{id:this.rvCompositeHigh._objID,userId:this.rvCompositeHigh._userId}));else{var b=null;this.mssrcVidReference&&this.mssrcVidReference[0]&&this.mssrcVidReference[0].stream&&(b=rtcSFU.mssrcVidReference[0].stream);var c=parseInt(this.getZEvent(a,"queue_size",-1)),d=!1,e=!1,f=!1,g=!1;if(!isNaN(c)&&c>0){for(var h=new Object,i=0;i<=c;i++){var j=this.getZEvent(a,"userId_"+i,null);if(j){j.indexOf(this._userRoomMcuDel)>-1&&(j=j.slice(this._userRoomMcuPrefix.length,j.indexOf(this._userRoomMcuDel))),!d&&b&&"true"===this.getZEvent(a,"screenshare_"+i,"false")&&(d=!0,ssController.incomingRemoteSSStream===b&&ssController.userId===j||(this.log("this.gettingScreenShareMedia: dispatching ZSCREENSHARE_RECEIVER_START"),ssController.incomingRemoteSSStream=b,this.dispatchScreenReceiverStart(j))),"on"===this.getZEvent(a,"micEnabled_"+i,"on")&&(f=!0),j===this.rvCompositeHigh._userId&&(e=this.getZEvent(a,"camEnabled_"+i,"on"),g=this.getZEvent(a,"micEnabled_"+i,"on")),h.position||(h.position=[]),i<rtcSFU.SFU_MAX_LEN&&h.position.push(j);var k=this.getZEvent(a,"lowbr_mode_"+i,null);"BandLowWithVideo"==k?(h.BandLowWithVideo||(h.BandLowWithVideo=[]),h.BandLowWithVideo.push(j)):"BandLowAudioOnly"==k&&(h.BandLowAudioOnly||(h.BandLowAudioOnly=[]),h.BandLowAudioOnly.push(j))}}null==h.userId&&null!=h.position&&(h.userId=h.position[0]),this.topSfuSlot="0",h.max=1,ConnectionManager._dispatchEvent("ZWRTC_FOCUS_RV",h)}this.remotePeerSpeaking=f;var l=this.getZEvent(a,"screenshare_userId",null);if(l){var j=l;j.indexOf(this._userRoomMcuDel)>-1&&(j=j.slice(this._userRoomMcuPrefix.length,j.indexOf(this._userRoomMcuDel))),!d&&b&&(d=!0,ssController.incomingRemoteSSStream===b&&ssController.userId===j||(this.log("this.gettingScreenShareMedia: dispatching ZSCREENSHARE_RECEIVER_START"),ssController.incomingRemoteSSStream=b,this.dispatchScreenReceiverStart(j)))}this.rvCompositeHigh._userId&&(d?(this.rvCompositeHigh.remoteStream&&"BandLowAudioOnly"!==CallManager.lowBrMode&&(this._rvStreamAttached=!1,ConnectionManager._dispatchEvent("ZWRTC_REMOVE_RV_STREAM",{id:this.rvCompositeHigh._objID,userId:this.rvCompositeHigh._userId}),this.rvCompositeHigh.remoteStream=null),this.rvCompositeHigh.updateCamMicState("off",g,!0)):b&&(this._rvStreamAttached&&b===this.rvCompositeHigh.remoteStream||this.attachLowBRStream(b),"BandLowAudioOnly"===CallManager.lowBrMode&&(e="off"),this.rvCompositeHigh.updateCamMicState(e,g,!0)));var m=[];m.push(this.rvCompositeHigh._userId),this.removeSFUObject(m)}},isStreamActive:function(a){if(a){var b=a.getVideoTracks()[0];return b&&"live"===b.readyState}return!1},dispatchScreenReceiverStart:function(a){if(a&&ConnectionManager.isSpecialUser(a)){var b=ssController.desktopStream?ssController.desktopStream:CallManager.desktopStream;if(this.isStreamActive(b))return;a=ssController.userId}ssController.userId=a,ConnectionManager._dispatchEvent("ZSCREENSHARE_RECEIVER_START",{userId:a,extraChannels:!0})},checkComposite:function(){ConnectionManager.doBlackboard?this._callGoingOn&&(CallManager.compositePaused?this._rvStreamAttached&&(this._rvStreamAttached=!1,ConnectionManager._dispatchEvent("ZWRTC_REMOVE_RV_STREAM",{id:this.rvCompositeHigh._objID,userId:this.rvCompositeHigh._userId})):!this._rvStreamAttached&&this.mssrcVidReference&&this.mssrcVidReference[0]&&this.mssrcVidReference[0].stream&&(this.rvCompositeHigh.remoteStream=rtcSFU.mssrcVidReference[0].stream,this._rvStreamAttached=!0,ConnectionManager._dispatchEvent("ZWRTC_ATTACH_RV_STREAM",{stream:this.rvCompositeHigh.remoteStream,id:this.rvCompositeHigh._objID,mode:"audiovideo",composite:"true",userId:this.rvCompositeHigh._userId}))):CallManager.compositePaused||"VOICE"==CallManager._type?(this._mainRV&&this._mainRV.hide(),zwrtc._useCustomGUI&&this.rvCompositeHigh&&this._rvStreamAttached&&(this._rvStreamAttached=!1,ConnectionManager._dispatchEvent("ZWRTC_REMOVE_RV_STREAM",{id:this.rvCompositeHigh._objID,userId:ConnectionManager.userId})),CallManager.updateLVOverlay(!0)):this._callGoingOn&&this._mainRV&&(this._mainRV.show(),zwrtc._useCustomGUI&&this.rvCompositeHigh&&(this.playMedia?(this._rvStreamAttached=!0,ConnectionManager._dispatchEvent("ZWRTC_ATTACH_RV_STREAM",{stream:this.rvCompositeHigh.remoteStream,id:this.rvCompositeHigh._objID,userId:ConnectionManager.userId})):this._rvStreamAttached&&(this._rvStreamAttached=!1,ConnectionManager._dispatchEvent("ZWRTC_REMOVE_RV_STREAM",{id:this.rvCompositeHigh._objID,userId:ConnectionManager.userId}))))},setLowResolStream:function(a){a!=this._lowResolStream&&(this.stopStreamTracks(this._lowResolStream),this._lowResolStream=a)},updateStream:function(a,b){a&&(this._localStream=a),this.rvCompositeHigh&&this.rvCompositeHigh.updateStream(a,b)},getLowResolStream:function(){return this._lowResolStream},redial:function(){this._lowResolStream&&(this.rvCompositeHigh.localStream=this._lowResolStream),this.rvCompositeHigh._callEstablished?(this._pendingNegotiation=!1,this.rvCompositeHigh.hangup(!0,"rtcSFU: redial")):this._pendingNegotiation=!0},checkBitrateNegotiation:function(a){a>3?this._compositeBw=this._compositeBwDrop2:this._compositeBw=this._compositeBwDrop0},sfuZeroConnected:function(a){this._pendingComposite&&(this._pendingComposite=!1,CallManager.connectToMCU(!this._voice))},generateParams:function(){this._username=DataStore.getUserData("username",""),this._host=CallManager.getServerIP();var a="rtcshadowaudio";zwrtc.screen?a="rtcshadowscreen":this._voice||(a="rtcshadow_size_"+zwrtc.cam_width+"_"+zwrtc.cam_height);var b=DataStore.getUserData("mcu_sip_port","");this._destination="sip:"+a+"@"+this._host,b&&b.length>0&&(this._destination=this._destination+":"+b)},handleSfuChannel:function(a){if(rtcSFU.log("handleSfuChannel"),a){rtcSFU.log("handleSfuChannel:"+a.toXML());var b=rtcSFU.getZEvent(a,"sfu_max_channels",null);b&&(rtcSFU.SFU_MAX_LEN=parseInt(b));var c=rtcSFU.getZEvent(a,"sfu_max_video_active",null);if(c)rtcSFU.SFU_MAX_VIDEO_LEN=parseInt(c);else{var d=rtcSFU.getZEvent(a,"sfu_max_video",null);d?rtcSFU.SFU_MAX_VIDEO_LEN=parseInt(d):rtcSFU.SFU_MAX_VIDEO_LEN=rtcSFU.SFU_MAX_LEN}"true"===rtcSFU.getZEvent(a,"mix_mode","false")?CallManager.audioMixMCU=!0:CallManager.audioMixMCU=!1}},checkIfRemoteMicUnmuted:function(){var a=!1;for(var b in this.mssrcVidReference){var c=rtcSFU.mssrcVidReference[b];if(c&&"on"===c.micEnabled){a=!0;break}}this.remotePeerSpeaking=a},maptParser:function(a){if(this._lastMAPTZebra=a,!zwrtc._enableSFU)return void this.log("rtcSFU:Ignore MAPT as sfu is disabled");if(a&&a.getZebraAttribute("username")!=DataStore.getUserData("username",""))return void this.log("Ignore MAPT, as it is for diff user e.g.screenshare zapp flash swf");var b=parseInt(this.getZEvent(a,"queue_size",-1)),c=this.getZEvent(a,"mcu","false"),d=this.getZEvent(a,"sfu_capable","false"),e=this.getZEvent(a,"composite_paused",null),f=this.getZEvent(a,"view_mode",null),g=this.getZEvent(a,"sfu_max_channels",null);g&&(this.SFU_MAX_LEN=parseInt(g));var h=this.getZEvent(a,"sfu_max_video",null);h&&(this.SFU_MAX_VIDEO_LEN=parseInt(h)),this.playMedia=!1,"media"==f&&(this.playMedia=!0),"VOICE"==CallManager._type?this._voice=!0:this._voice=!1;var i=this.getZEvent(a,"self_lowbr_mode",CallManager.self_lowbr_mode);if(null!=i&&CallManager.lowBrMode!=i&&("BandLowWithVideo"==i?(CallManager.lowBrMode=i,ConnectionManager._dispatchEvent("RECEIVE_SINGLE_STREAM"),this._rvStreamAttached=!1):"BandLowAudioOnly"==i&&(CallManager.lowBrMode=i,ConnectionManager._dispatchEvent("RECEIVE_AUDIO_ONLY"),this._rvStreamAttached=!1)),e=null==e?"BandNormal"===CallManager.lowBrMode:"true"===e,e&&!this._sfuRestricted)CallManager.compositePaused=!0;else{CallManager.compositePaused=!1;var j=this.getZEvent(a,"userId_0","");j.indexOf(this._userRoomMcuDel)>-1&&(j=j.slice(this._userRoomMcuPrefix.length,j.indexOf(this._userRoomMcuDel))),j&&""!==j&&(this.rvCompositeHigh._userId?this.rvCompositeHigh._userId!=j&&(this._rvStreamAttached=!1,ConnectionManager._dispatchEvent("ZWRTC_REMOVE_RV_STREAM",{id:this.rvCompositeHigh._objID,userId:this.rvCompositeHigh._userId})):this._rvStreamAttached=!1,this.rvCompositeHigh._userId=j)}this._queueSize=b;var k=!1;if("true"==c&&b!=-1){if(k=!0,CallManager._srCommandID=-1,CallManager._callType="MCU","false"==d||this.playMedia||!zwrtc._enableSFU)return void(zwrtc.isMCU()&&!zwrtc.isP2P()||CallManager.connectToMCU(!this._voice));this._pendingComposite=!0,this._callGoingOn=!0,this._sfuRestricted=!1,this.generateParams();
}if(!this._callGoingOn||this._sfuRestricted||CallManager._srCommandID!=-1||"P2P"==CallManager._callType)return this.log("No call going on or sfuRestricted, so Ignoring recvd MAPT:srCommandID:"+CallManager._srCommandID+" "+CallManager._callType+" "+this._useMcuOffer+"\n"+a.toXML()),this.checkComposite(),void(k&&this.handleSrMapt());if("BandNormal"!=CallManager.lowBrMode)return this.handleLowBrMode(a),void(k&&this.handleSrMapt());var l=[],m=[],n=!1,o=null,p=null,q=null;if("true"==d&&!this.playMedia&&b!=-1){this._confQueueSize=b,this.establishSSIfPossible();var r=new Object,s=-1,t=this.getZEvent(a,"extra_channels",null),u=!1;t&&t.indexOf("screenshare")!=-1&&(u=!0,s=parseInt(this.getZEvent(a,"sfu_screenshare",null)),q=this.getZEvent(a,"screenshare_userId",null),q&&(q=q.slice(this._userRoomMcuPrefix.length,q.indexOf(this._userRoomMcuDel))));for(var v=0;v<=b;v++){var w=this.getZEvent(a,"sfu_"+v,null),j=this.getZEvent(a,"userId_"+v,""),x=this.getZEvent(a,"camEnabled_"+v,"on"),y=this.getZEvent(a,"micEnabled_"+v,"on"),z=this.getZEvent(a,"screenshare_"+v,"false"),A=this.getZEvent(a,"sfu_media_"+v,null);j.indexOf(this._userRoomMcuDel)>-1&&(j=j.slice(this._userRoomMcuPrefix.length,j.indexOf(this._userRoomMcuDel)));var B=w,C=null;if(this.debugLog("SFU indx:"+B),this.debugLog("userId:"+j),this.debugLog("screenshare:"+z),this.debugLog("sfu_media:"+A),"true"==z&&(j!==ConnectionManager.userId||u?null==q&&(q=j):q=j,q&&ConnectionManager.isSpecialUser(q)&&!u&&(null===B||isNaN(B)||(s=B))),A||(A="audiovideo"),C=this.getSFUConnection(B,A)){if(this._useMcuOffer||s!=-1&&s==B&&(C.screenShareMedia||I.gettingScreenShareMedia(),s=-1),null!=j&&null!=C._userId&&C._userId!=j)if(this.debugLog("Mismatch in userId detected:old userId:"+C._userId+" new userId:"+j),this.resetSFUConnection&&!this._useMcuOffer){C.setRV(-1,-1,-1,-1,-1,-1,this._mainRV);var D="Closing SFU connection with index:"+B;this.debugLog(D),C.hangup(!1,D),delete this.rvSFUArray[B],this.debugLog("Creating new SFU connection for :"+B),C=this.getSFUConnection(B,A)}else m.indexOf(C._userId)==-1&&C.dispatchRemoveEvent(),rtcSFU._sfuStreams[C._userId]&&delete rtcSFU._sfuStreams[C._userId],C._userId=j,C.sfu_media=A,C.position=v,C.dispatchRemoveEvent(),C.dispatchAttachEvent(),rtcSFU._sfuStreams[j]=C.remoteStream;m.push(j),C._userId=j,C.loadAvatar(j),C.position=v,C.updateMediaType(A),C.updateCamMicState(x,y,!0),r["userId_"+v]=j,r.position||(r.position=[]),r.position.push(j);var E=this.getZEvent(a,"lowbr_mode_"+v,null);if("BandLowWithVideo"==E?(r.BandLowWithVideo||(r.BandLowWithVideo=[]),r.BandLowWithVideo.push(j)):"BandLowAudioOnly"==E&&(r.BandLowAudioOnly||(r.BandLowAudioOnly=[]),r.BandLowAudioOnly.push(j)),l.push(B),0==v&&(o=C._objID,p=C._userId,this.topSfuSlot=B),this._useMcuOffer){var F=rtcSFU.mssrcVidReference[B];F&&(F.micEnabled=y,F.camEnabled=x,this.isStreamActive(F.stream)&&(C.remoteStream&&C.remoteStream.id==F.stream.id||(C.remoteStream=null,C.dispatchRemoveEvent(),C._remoteStreamAttached=!1,C.handleRemoteStream(F.stream,C.sfu_media))))}}}if(o&&(r.id=o,r.userId=p),r.max=this.SFU_MAX_VIDEO_LEN,ConnectionManager._dispatchEvent("ZWRTC_FOCUS_RV",r),s!=-1)if(this._useMcuOffer){var G=rtcSFU.rvSFUArray[s];if(G&&G._sfuType==s){this.debugLog("delete sfu object @ "+s);var H=rtcSFU.rvSFUArray[s];H&&m.indexOf(H._userId)==-1&&H.hangup(),delete rtcSFU.rvSFUArray[s]}var F=this.mssrcVidReference[s];F&&this.isStreamActive(F.stream)&&(ssController.incomingRemoteSSStream&&ssController.incomingRemoteSSStream!=F.stream&&(ConnectionManager._dispatchEvent("ZSCREENSHARE_RECEIVER_STOP",{userId:ssController.userId}),ssController.incomingRemoteSSStream=null),null!=ssController.incomingRemoteSSStream&&ssController.userId==q||(this.debugLog("opening screen share sfu for mssrc:old:"+ssController.userId+" new:"+q),ssController.incomingRemoteSSStream=F.stream,this.dispatchScreenReceiverStart(q)))}else{var I=this.getSFUConnection(s);this.debugLog("Screen Share SFU indx:"+s+" ssUserId:"+q),I&&(l.push(s),CallManager._enableSSZapp&&(q&&(I._userId=q),I.gettingScreenShareMedia()))}else this._useMcuOffer&&ssController.incomingRemoteSSStream&&(this.debugLog("remote user stopped screen share:"+ssController.userId),ssController.incomingRemoteSSStream=null,ConnectionManager._dispatchEvent("ZSCREENSHARE_RECEIVER_STOP",{userId:ssController.userId}),ssController.userId=null);var J=(new Date).getTime();(null==ssController.desktopStream||ssController.streamStartTS>0&&J-ssController.streamStartTS>1e4)&&null!=q&&ConnectionManager.userId!=q&&q!=ssController.userId&&this.dispatchScreenReceiverStart(q)}if(this._useMcuOffer)this.removeSFUObject(m,l);else{for(var K=[],L=0;L<this.SFU_MAX_LEN;L++)K[L]=L;this.debugLog("sfuUserIdPresent:"+m);for(var M=$.grep(K,function(a){return $.inArray(a,l)==-1}),N=0;N<M.length;N++){var O=M[N],P=this.rvSFUArray[O];P&&(n=!1,m.indexOf(P._userId)>-1&&(this.debugLog("sfuMediaConn._userId:"+P._userId),P._userId=null),P.setRV(-1,-1,-1,-1,-1,-1,this._mainRV),this.debugLog("Closing SFU connection with index:"+O),this.playMedia||b==-1||(P.hangup(),delete this.rvSFUArray[O]))}}m=null,this.checkComposite(),this.checkIfRemoteMicUnmuted(),k&&this.handleSrMapt()},removeSFUObject:function(a,b){for(var c in this.rvSFUArray){var d=rtcSFU.mssrcVidReference[c],e=this.rvSFUArray[c];e&&(a.indexOf(e._userId)==-1?(d&&(d.micEnabled="off"),e.setRV(-1,-1,-1,-1,-1,-1,this._mainRV),this.debugLog("===Closing SFU connection with userId:"+e._userId),e.hangup(),delete this.rvSFUArray[c]):b&&b.indexOf(c)==-1?(d&&(d.micEnabled="off"),this.debugLog("deleting sfu object for "+c+" with user Id:"+e._userId),delete this.rvSFUArray[c]):this.debugLog("not removing index:"+c+" userId:"+e._userId))}},handleSrMapt:function(){zwrtc.isMCU()&&!zwrtc.isP2P()||(this._pendingComposite=!1,CallManager.connectToMCU(!this._voice))},getSFUConnection:function(a,b){var c=null;return this._sfuRestricted||null==a||(c=this.rvSFUArray[a],null==c&&(this.debugLog("Create new SFU Connection"),b&&(a=b+"_"+a),c=this.createMediaConnection(a))),c},placeSSCall:function(a){if(zwrtc.isP2P()||this._publishingSS)console.log("Ignoring placeSSCall: publishingSS = "+this._publishingSS);else if(this._useScreenSimulcast&&this._useMcuOffer)this.rvCompositeHigh&&(this._publishingSS=!0,this.rvCompositeHigh.placeSSCall());else{if(this.rvCompositeHigh&&this.rvCompositeHigh.ortcMedia)return this._publishingSS=!0,this.rvCompositeHigh.ortcMedia.addDesktopStream(),void CallManager.screenCallEstablished();this.desktopStream&&(ConnectionManager._dispatchEvent("SCREEN_SHARE_RECONNECTING"),this.endSSCall()),this._publishingSS=!0,this.createMediaConnection(this.CONST_STRING_SCREEN),this._useSimulcast&&this.createMediaConnection(this.CONST_STRING_SCREEN_LOW),CallManager._dispatchEvent(CallManager.Event.CONNECTING,{conn_type:"RTC_SS"})}},endSSCall:function(){return this._publishingSS=!1,this.rvCompositeHigh&&this.rvCompositeHigh.ortcMedia?(this.rvCompositeHigh.ortcMedia.removeDesktopStream(),void CallManager.screenCallTerminated()):(this.desktopStream&&this.desktopStream.hangup(),this.desktopStreamLow&&this.desktopStreamLow.hangup(),this.desktopStream=null,this.desktopStreamLow=null,void(this._useScreenSimulcast&&this._useMcuOffer&&this.rvCompositeHigh&&this.rvCompositeHigh.endSSCall()))},getUserName:function(){return this._useRoomAndUserid?this._userRoomMcuPrefix+ConnectionManager.userId+this._userRoomMcuDel+ConnectionManager.roomSession:this._username},createMediaConnection:function(a){var b=new rtcMedia;b._enableLocalCandidates=this._enableLocalCandidates;var c,d=this._compositeBw,e=null,f="",g=null,h=null;if(this._mainRV&&(h=this._mainRV[0]),a==this.CONST_STRING_HIGH)this._rvAudioRecordingCall&&this._rvAudioRecordingCall.hangup(),this._rvAudioRecordingCall=null,f=zwrtc._enableSFU?this._useProxy?this.CONST_STRING_RVSS+this.getUserName():this.CONST_STRING_RVCH+this.getUserName():this.CONST_STRING_RVSH+this.getUserName(),b.localStream=g=this._localStream,c=this._destination,b.initSDK(this._localView,h,this.stunConfig,!1,this.CONST_STRING_HIGH),b._useProxy=this._useProxy,this.rvCompositeHigh=b,this._pendingComposite=!1;else if(a==this.CONST_STRING_LOW)f=this.CONST_STRING_RVCL+this.getUserName(),b.localStream=g=this._localStream,c=this._destination,b.initSDK(this._localView,h,this.stunConfig,!1,this.CONST_STRING_LOW),this.rvCompositeLow=b;else if(a==this.CONST_STRING_SCREEN){d=this.screenCallBwLimit,this._username=DataStore.getUserData("username",""),this._host=CallManager.getServerIP(),f=this.CONST_STRING_RVSS+this.getUserName(),b.localStream=ssController.desktopStream,b._videoOnly=!0,b.initSDK(null,null,this.stunConfig,!1,this.CONST_STRING_SCREEN),this.desktopStream=b;var i=DataStore.getUserData("mcu_sip_port","");c="sip:rtcshadowscreen@"+this._host,i&&i.length>0&&(c=c+":"+i)}else if(a==this.CONST_STRING_SCREEN_LOW){d=this.screenCallBwLowLimit,this._username=DataStore.getUserData("username",""),this._host=CallManager.getServerIP(),f=this.CONST_STRING_RVSSL+this.getUserName(),b.localStream=ssController.desktopStreamLow,b._videoOnly=!0,b.initSDK(null,null,this.stunConfig,!1,this.CONST_STRING_SCREEN_LOW),this.desktopStreamLow=b;var i=DataStore.getUserData("mcu_sip_port","");c="sip:rtcshadowscreenlow@"+this._host,i&&i.length>0&&(c=c+":"+i)}else if(a==this.CONST_STRING_AUDIO_RECORD){this._username=DataStore.getUserData("username",""),this._host=CallManager.getServerIP(),f=this.CONST_STRING_RVCH+this.getUserName(),b.localStream=g=this._audioStream,this._voice=!0,b.initSDK(null,null,this.stunConfig,!1,this.CONST_STRING_AUDIO_RECORD);var i=DataStore.getUserData("mcu_sip_port","");c="sip:rtcshadowaudio@"+this._host+":"+DataStore.getUserData("mcu_sip_port",""),i&&i.length>0&&(c=c+":"+i),this._rvAudioRecordingCall=b,this._rvAudioRecordingCall.sdpConstraints.mandatory.OfferToReceiveVideo=!1}else{var j="audiovideo";if(a&&(a+="",a.indexOf("_")>-1)){var k=a.split("_");"audio"!=k[0]&&"video"!=k[0]&&"audiovideo"!=k[0]||(a=k[1],j=k[0])}if(d=this._sfuBw,this._debug||this._useProxy?(f=this.getUserName()+"_"+Math.floor(1e3*Math.random()+1),c="sip:54321@"+this._host+":1950"):(f=this.CONST_STRING_RVSFU+a+"_"+this.getUserName(),c=this._destination),b._viewOnly=!0,this.rvSFUArray[a]=b,b.initSDK(null,e,this.stunConfig,!1,a),this._useMcuOffer)return b;if(this.startSFUInfo(),"audio"==j)return b.placeCall(f,this._host,c,!0,null),b}return b._debug=this._debug,b.bandwidth={audio:80,video:d},b.placeCall(f,this._host,c,this._voice,g),b},startSFUInfo:function(){if(!this.sfuInfoRunning){this.sfuInfoRunning=!0;var a=this;this.sfuInfoTimer=setInterval(function(){var b=0,c=0,d=0,e="";for(var f in a.rvSFUArray){var g=a.rvSFUArray[f];g&&(e+=f+":Recv BR:"+g.recvdBitrate+"Kbps<br>",g.peerConnection&&(e+=f+":ICE:"+g.peerConnection.iceConnectionState+"<br>"),b+=g.plps,c+=g.prps,d+=g.recvdBitrate)}var h=0;if(c>0)if(h=Math.round(b/c*100),h>a._sfuThreshold/2&&a.log("CV_CHECK:total PL Rate:"+h+" _sfuThreshold:"+a._sfuThreshold),h>=a._sfuThreshold){var i=DateTimeUtil.getNow();if(a._lastPLTS!=-1){var j=i-a._lastPLTS;j>=a._plThDuration&&a.switchToComposite(h,i-a._lastPLTS)}else a._lastPLTS=i}else a._lastPLTS=-1;if(webRTC.localVideo){e+="Total PLoss:"+b+"/s<br>Total PRecvd:"+c+"/s<br>%PLoss    :"+h+"%<br>",e+="Total Recv BR:"+d+"Kbps<br>",e+="PL Threshold:"+a._sfuThreshold+"%";var k=$("#"+webRTC.localVideo.id);zwrtc.tooltipInit||(zwrtc.tooltipInit=!0,k.tooltip({content:e,track:!0}),k.attr("title",e),k.mouseover(function(){webRTC.updateTL=!0}),k.mouseout(function(){webRTC.updateTL=!1})),webRTC.updateTL&&k.tooltip("option","content",e)}if(a._debug)try{$("#totalpls").text(b),$("#totalprs").text(c),$("#totalplrate").text(h)}catch(l){}})}},switchToComposite:function(a,b){this.log("switchToComposite:%PL:"+a+"% TH:"+this._sfuThreshold+" duration:"+b),this._sfuRestricted=!0,zwrtc._useCustomGUI=!1,this.sfuInfoTimer&&clearInterval(this.sfuInfoTimer),this.sfuInfoRunning=!1;for(var c in this.rvSFUArray){var d=this.rvSFUArray[c];d&&(d.setRV(-1,-1,-1,-1,-1,-1),d.hangup())}this.rvSFUArray={},ConnectionManager._dispatchEvent("ZWRTC_SFU_DISABLED",{pl:a,th:this._sfuThreshold});try{this._mainRV&&this._mainRV.show(),zwrtc._useCustomGUI&&this.rvCompositeHigh?(this._rvStreamAttached=!0,ConnectionManager._dispatchEvent("ZWRTC_ATTACH_RV_STREAM",{stream:this.rvCompositeHigh.remoteStream,id:this.rvCompositeHigh._objID,userId:ConnectionManager.userId})):this.rvCompositeHigh.attachRV()}catch(e){}},audioVideoReceived:function(){this.log("audioVideoReceived"),rtcSFU.successURL&&(window.location=rtcSFU.successURL)},stopStreamTracks:function(a){if(a){var b=this;a.getVideoTracks&&a.getVideoTracks().forEach(function(c){c&&"ended"!==c.readyState&&(c.stop(),b.log("stopStreamTracks: streamId = "+a.id+", videoTrackId = "+c.id+", readyState = "+c.readyState))}),a.getAudioTracks&&a.getAudioTracks().forEach(function(c){c&&"ended"!==c.readyState&&(c.stop(),b.log("stopStreamTracks: streamId = "+a.id+", audioTrackId = "+c.id+", readyState = "+c.readyState))}),a.stop&&a.stop()}},getMicAudioLevel:function(a){var b=Math.round(a/1e3);0==b&&(b=1);var c=ConnectionManager.isUsingPlugin?35:28.33,d=Math.round(this.micLevelPermutation[b]*c);return isNaN(d)&&(d=-1),d>255&&(d=255),d},fixStatsType:function(a){return{inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[a.type]||a.type},handleInboundStats:function(a,b,c){if(a&&b){var d=0;if(null==rtcSFU.connDebug&&(rtcSFU.connDebug={}),null==rtcSFU.connDebug[a]&&(rtcSFU.connDebug[a]={}),"inbound-rtp"===this.fixStatsType(b)&&!b.isRemote){rtcSFU.connDebug[a][b.id]=b;var e=parseInt(b.packetsReceived);!isNaN(e)&&e>0&&(d+=e,rtcSFU.connDebug[a].packetsReceived=d,rtcSFU.connDebug[a].receivedBitrate=c)}}},getDownBitrate:function(){var a=0;for(var b in rtcSFU.connDebug)isNaN(rtcSFU.connDebug[b].receivedBitrate)||(a+=rtcSFU.connDebug[b].receivedBitrate);return a},log:function(a){(this.logEnabled||Platform.debugLogEnabled)&&Platform.log("rtcSFU:"+a)},debugLog:function(a){Platform.debugLogEnabled&&Platform.log("rtcSFU:"+a)}},ssController={chromeExtensionId:"fokafakmaggdbfimadekgoamkmakgfii",minChromeExtVersion:"1.0",screenType:["screen","window"],maxWidth:0,maxHeight:0,maxLowWidth:640,maxLowHeight:480,minFps:0,maxFps:25,desktopStream:null,desktopStreamLow:null,incomingRemoteSSStream:null,SS_STREAM_ACCESSED:"SS_STREAM_ACCESSED",SS_STREAM_CLOSED:"SS_STREAM_CLOSED",streamStartTS:0,extInstalled:!1,mozMediaSource:"window",mozXPIWin:"desktop_sharing-windows.xpi",mozXPIMac:"desktop_sharing-mac.xpi",mozXPILin:"desktop_sharing-linux.xpi",fakeAppshareStream:!1,systemAudioEnabled:!1,appShareAudio:!1,appShareTabs:!1,displayMediaEnabled:!1,appshareConfig:{},initInlineInstalls:function(){ConnectionManager.addListener("REMOTE_STREAM_ATTACHED_SCREEN",this,this.remoteStreamAttached.bind(this))},getSSInstallURL:function(){return"chrome.webstore.install(ssController.getWebStoreInstallUrl(),ssController.displaySSRefreshMessage,ssController.ssInstallError);return false;"},updateConfig:function(a){if(a){this.appshareConfig=a,a.min_fps&&(this.minFps=a.min_fps),a.max_fps&&(this.maxFps=a.max_fps);var b=parseInt(a.max_width,10);isNaN(b)||(this.maxWidth=b);var c=parseInt(a.max_height,10);isNaN(c)||(this.maxHeight=c),a.extId&&this.updateExtensionID(a.extId),this.appShareAudio=a.audio===!0,this.appShareTabs=a.tab===!0}},updateExtensionID:function(a){ConnectionManager.isFF()?(window.addEventListener("message",function(a){try{if(a.data){var b=JSON.parse(a.data);"BBEXT_VERSION"===b.comm&&null!=b.ver&&(ssController.extInstalled=!0)}}catch(c){}},!1),window.postMessage("GET_BBEXT_VERSION","*")):a&&(ssController.chromeExtensionId=a,$("link[rel=chrome-webstore-item]").attr("href",this.getWebStoreInstallUrl()),this.checkChromeExtInstalled())},checkChromeExtInstalled:function(){if(ConnectionManager.isChrome()){var a=this;this.checkExtInstalled(function(b){a.extInstalled=b})}},isDesktopSharingEnabled:function(){try{var a=navigator.userAgent.toLowerCase(),b=parseInt(a.match(/chrome\/(\d+)\./)[1],10);return b>=34}catch(c){}return!1},displaySSRefreshMessage:function(){this.extInstalled=!0,ConnectionManager._dispatchEvent("SS_FRESH_INSTALL")},ssInstallError:function(a){ConnectionManager._dispatchEvent("SS_INSTALL_ERROR",{msg:a})},getWebStoreInstallUrl:function(){return"https://chrome.google.com/webstore/detail/"+this.chromeExtensionId},getSSStream:function(){return this.desktopStream?this.desktopStream:this.incomingRemoteSSStream},installExt:function(a){if("object"==typeof chrome)if(ConnectionManager.isFF()){var b=null;switch(ConnectionManager._os){case"MAC":b=this.mozXPIMac;break;case"UNIX":case"LINUX":b=this.mozXPILin;break;case"WIN":b=this.mozXPIWin}if(ConnectionManager.contextPath&&b){var c={"BB Desktop Sharing":ConnectionManager.contextPath+"ext/"+b};this.log("xpi:"+ConnectionManager.contextPath+"ext/"+b),InstallTrigger.install(c)}}else{var d=this;chrome.webstore.install(this.getWebStoreInstallUrl(),function(a){d.displaySSRefreshMessage()},function(b){a&&a(b)})}},getStreamFromExt:function(a,b){var c=this,d={command:"GET_STREAM_ID",screenType:this.screenType};Z&&Z.zjs&&(d.origin=Z.zjs.location.origin),"object"==typeof chrome&&"object"==typeof chrome.runtime&&"function"==typeof chrome.runtime.sendMessage&&chrome.runtime.sendMessage(this.chromeExtensionId,d,function(d){return d?(c.log("Response from extension: "+d),void(d.streamId?a(d.streamId):b("Extension failed to get the stream"))):void b(chrome.runtime.lastError)})},getScreenFromExt:function(a,b){var c=this;this.checkExtInstalled(function(d){d?(c.extInstalled=!0,c.getStreamFromExt(a,b)):(c.extInstalled=!1,b())})},checkExtInstalled:function(a){if("object"!=typeof chrome||"object"!=typeof chrome.runtime||"function"!=typeof chrome.runtime.sendMessage)a(!1);else{var b=this,c={command:"GET_EXT_VERSION"};chrome.runtime.sendMessage(this.chromeExtensionId,c,function(c){if(c&&c.version){var d=c.version;b.log("Extension version is: "+d);var e=b.isUpdateRequired(b.minChromeExtVersion,d);a(!e)}else b.log("Extension not installed?: "+chrome.runtime.lastError),a(!1)})}},isUpdateRequired:function(a,b){try{for(var c=a.split("."),d=b.split("."),e=Math.max(c.length,d.length),f=0;f<e;f++){var g=0,h=0;if(f<c.length&&(g=parseInt(c[f])),f<d.length&&(h=parseInt(d[f])),isNaN(g)||isNaN(h))return!0;if(g!==h)return g>h}return!1}catch(i){return this.log("Failed to parse extension version"+i),!0}},accessDesktopStream:function(a){this.streamID=a;var b=screen.width,c=screen.height;this.maxHeight>0&&this.maxWidth>0&&(b=this.maxWidth,c=this.maxHeight);var d={video:{}};this.systemAudioEnabled&&this.appShareAudio?(d.audio={},d.audio.mandatory={chromeMediaSource:"desktop",chromeMediaSourceId:a}):d.audio=!1,d.video.mandatory={chromeMediaSource:"desktop",chromeMediaSourceId:a,maxWidth:b,maxHeight:c,minFrameRate:this.minFps,maxFrameRate:this._maxFps},this.systemAudioEnabled&&this.appShareAudio?navigator.webkitGetUserMedia(d,this.gotStream.bind(this),this.getUserMediaError.bind(this)):navigator.mediaDevices.getUserMedia(d).then(this.gotStream.bind(this))["catch"](this.getUserMediaError.bind(this))},accessLowResolDesktopStream:function(a){var b=screen.width,c=screen.height;c>this.maxLowHeight&&(c=this.maxLowHeight,b=Math.round(this.maxLowHeight*screen.width/screen.height)),b>this.maxLowWidth&&(c=Math.round(this.maxLowWidth*c/b),b=this.maxLowWidth);var d={audio:!1,video:{}};d.video.mandatory={chromeMediaSource:"desktop",chromeMediaSourceId:a,maxWidth:b,maxHeight:c,minFrameRate:this.minFps,maxFrameRate:this._maxFps},navigator.mediaDevices.getUserMedia(d).then(this.gotLowStream.bind(this))["catch"](this.getUserMediaError.bind(this))},gotStream:function(a){if(a&&this.log("gotStream: stream: "+a.id),this.streamStartTS=(new Date).getTime(),CallManager.recordUsingSS)return void ConnectionManager._dispatchEvent("GOT_SS_STREAM",{stream:a});if(this.desktopStream!==a){this.desktopStream&&this.toggleStreamListener(this.desktopStream,!1);var b=this.desktopStream;rtcSFU.desktopStream&&rtcSFU.desktopStream.isPCConnected()?rtcSFU.desktopStream.updateDesktopStream(a):this.desktopStream?this.desktopStream=a:(this.desktopStream=a,ConnectionManager._dispatchEvent("SS_STREAM_ACCESSED",{stream:this.desktopStream}),this.log("gotStream: dispatched SS_STREAM_ACCESSED")),this.toggleStreamListener(a,!0),rtcSFU.stopStreamTracks(b)}},toggleStreamListener:function(a,b){if(a)if(b){a.addEventListener("ended",this.desktopSOTClosed);var c=a.getTracks()[0];c&&(c.onended=this.desktopSOTClosed.bind(this))}else{a.removeEventListener("ended",this.desktopSOTClosed);var c=a.getTracks()[0];c&&(c.onended=null)}},desktopSOTClosed:function(a){ssController.log("desktopSOTClosed:Screen share stream / track ended, so terminating screen share"),ssController.stopScreenShare()},getUserMediaError:function(a){this.log("Unable to access SS stream"+a.code+" systemAudioEnabled="+this.systemAudioEnabled),this.systemAudioEnabled=!1,this.desktopStream&&rtcSFU._useScreenSimulcast&&ConnectionManager._dispatchEvent("SS_STREAM_ACCESSED",{stream:this.desktopStream})},startCameraShare:function(a){this.gotStream(a)},startScreenShare:function(a){if(this.fakeAppshareStream){var b=wrtcSetting.getMediaConstraints(zwrtc.cam_width,zwrtc.cam_height,zwrtc.cam_width,zwrtc.cam_height,zwrtc.cam_fps,zwrtc.cam_fps_min);b.audio=!1,ConnectionManager.isFF()?navigator.mediaDevices.getUserMedia(b).then(this.onSSMediaSuccess.bind(this))["catch"](this.onSSMediaError.bind(this)):navigator.mediaDevices.getUserMedia(b).then(this.gotStream.bind(this))["catch"](this.getUserMediaError.bind(this))}else if(ConnectionManager.isEdge()&&ConnectionManager.getDisplayMediaSupported()){this.desktopStream&&(this.toggleStreamListener(this.desktopStream,!1),rtcSFU.stopStreamTracks(this.desktopStream),this.desktopStream=null,rtcSFU._publishingSS=!1);var b={video:!0,audio:!1};this.appShareAudio&&(b.audio=!0),navigator.getDisplayMedia(b).then(this.gotStream.bind(this))["catch"](this.onMediaError.bind(this))}else if(ssController.displayMediaEnabled){var b={video:!0,audio:!1};this.appShareAudio&&(b.audio=!0),navigator.mediaDevices.getDisplayMedia(b).then(this.mediaDisplayGotStream.bind(this))["catch"](this.onMediaError.bind(this))}else this.initiateAppshare(a)},limitResolution:function(a){var b=a.getVideoTracks()[0];if(ssController.maxWidth>0&&ssController.maxHeight>0&&b&&b.getSettings){var c=b.getSettings();this.log(JSON.stringify(c));var d=null;if(c.width>ssController.maxWidth||c.height>ssController.maxHeight)if(c.width>c.height){var e=c.height/c.width*ssController.maxWidth;if(e>ssController.maxHeight){this.log("new height("+e+") > max height("+ssController.maxHeight+"), recalculate");var f=c.width/c.height*ssController.maxHeight;d={width:f,height:ssController.maxHeight}}else d={width:ssController.maxWidth,height:e}}else{var f=c.width/c.height*ssController.maxHeight;if(f>ssController.maxWidth){this.log("new width("+f+") > max width("+ssController.maxWidth+"), recalculate");var e=c.height/c.width*ssController.maxWidth;d={width:ssController.maxWidth,height:e}}else d={width:f,height:ssController.maxHeight}}d&&(this.log(JSON.stringify(d)),b.applyConstraints(d))}this.gotStream(a)},mediaDisplayGotStream:function(a){a&&setTimeout(function(){ssController.limitResolution(a)},1e3)},initiateAppshare:function(a){if("screen"===a||"window"===a?(this.mozMediaSource=a,this.screenType=[a]):(this.mozMediaSource="window",this.screenType=["screen","window","tab"]),"CHROME"===ConnectionManager.webRTCBrowser&&(this.appShareTabs&&this.screenType.indexOf("window")>-1&&this.screenType.push("tab"),this.systemAudioEnabled&&this.appShareAudio&&this.screenType.push("audio")),ConnectionManager.isUsingPlugin){var b={};b.audio=!1,b.video={},b.video.mediaSource=this.mozMediaSource,navigator.getUserMedia(b,this.gotStream.bind(this),this.getUserMediaError.bind(this))}else if(ConnectionManager.isFF()){var c=screen.width,d=screen.height;this.maxHeight>0&&this.maxWidth>0&&(c=this.maxWidth,d=this.maxHeight);var b={};b.video={},b.video.mozMediaSource=this.mozMediaSource,b.video.mediaSource=this.mozMediaSource,"window"!==this.mozMediaSource&&(b.video.width={max:c},b.video.height={max:d}),this.log("constraints:"+JSON.stringify(b)),navigator.mediaDevices.getUserMedia(b).then(this.onSSMediaSuccess.bind(this))["catch"](this.onSSMediaError.bind(this))}else{var e=this;this.getScreenFromExt(function(a){e.accessDesktopStream(a)},function(a){e.log("Error in capturing:"+a+" proto:"+Z.zjs.location.protocol),e.extInstalled?"http:"==Z.zjs.location.protocol&&ConnectionManager._dispatchEvent("SS_ERROR",{msg:"HTTP error"}):ConnectionManager._dispatchEvent("SS_ERROR",{msg:"Extension missing"})})}},onSSMediaSuccess:function(a){this.extInstalled=!0,a.addEventListener("inactive",this.desktopStreamClosed),this.gotStream(a)},onSSMediaError:function(a){this.log("onSSMediaError: Error in capturing:"+a),ConnectionManager._dispatchEvent("SS_ERROR",{msg:"Mozilla ss error"})},onMediaError:function(a){this.log("onMediaError: Error in capturing:"+a);var b="onMediaError: Error in capturing:";a.name&&(b=b+" "+a.name),this.log(b)},stopScreenShare:function(){this.streamStartTS=0,this.log("stopScreenShare: terminating ss"),ConnectionManager._dispatchEvent("SS_STREAM_CLOSED"),this.desktopStream&&(rtcSFU.stopStreamTracks(this.desktopStream),CallManager.screenCallTerminated()),this.desktopStream=null,this.desktopStreamLow&&rtcSFU.stopStreamTracks(this.desktopStreamLow),this.desktopStreamLow=null,CallManager._dispatchEvent(CallManager.Event.ENDED,{conn_type:"RTC_SS"}),this.incomingRemoteSSStream&&ssController.incomingRemoteSSStream.active&&ConnectionManager._dispatchEvent("ZSCREENSHARE_RECEIVER_START",{userId:ssController.userId,extraChannels:!0})},remoteStreamAttached:function(){CallManager.screenCallEstablished()},log:function(a){Platform.log(a)}};ZWhiteboardController=EventDispatcher.extendAsSingleton({Event:{VIEWER_UPDATE:"VIEWER_UPDATE",POINTER_MODE:"POINTER_MODE",DRAWING_MODE:"DRAWING_MODE",DRAWING_COLOR:"DRAWING_COLOR",CLEAR_WHITEBOARD:"CLEAR_WHITEBOARD",CLEAR_ANNOTATIONS:"CLEAR_ANNOTATIONS",SET_POINTER_MODE:"SET_POINTER_MODE",SET_DRAWING_MODE:"SET_DRAWING_MODE",SET_DRAWING_COLOR:"SET_DRAWING_COLOR"},init:function(){this._super(),this.addListener=this._addListener,this.removeListener=this._removeListener,this.removeAllListenersForEvent=this._removeAllListenersForEvent,this.initSDKEventListeners()},initSDK:function(){},initSDKEventListeners:function(){},setPointerMode:function(){ZWhiteboardController._dispatchEvent(ZWhiteboardController.Event.SET_POINTER_MODE)},setDrawingMode:function(a){ZWhiteboardController._dispatchEvent(ZWhiteboardController.Event.SET_DRAWING_MODE,{mode:a})},setDrawingColor:function(a){ZWhiteboardController._dispatchEvent(ZWhiteboardController.Event.SET_DRAWING_COLOR,{color:a})},clearAnnotations:function(){ZWhiteboardController._dispatchEvent(ZWhiteboardController.Event.CLEAR_ANNOTATIONS)},clearWhiteboard:function(){ZWhiteboardController._dispatchEvent(ZWhiteboardController.Event.CLEAR_WHITEBOARD)}}),ZContentLibraryController=EventDispatcher.extendAsSingleton({initialized:!1,isContentLibraryProcessed:!1,Event:{LIBRARY_CO_COMPLETE:"LIBRARY_CONTENT_COMPLETE",LIBRARY_ADD:"LIBRARY_ADD",LIBRARY_READY:"LIBRARY_READY",LIBRARY_UPLOAD_STATUS:"LIBRARY_UPLOAD_STATUS",LIBRARY_REMOVE:"LIBRARY_REMOVE",LIBRARY_CLEAR:"LIBRARY_CLEAR"},init:function(){this.initialized||(this.initialized=!0,this._super(),this.addListener=this._addListener,this.removeListener=this._removeListener,this.removeAllListenersForEvent=this._removeAllListenersForEvent,this.initSDKEventListeners())},initSDK:function(){},initSDKEventListeners:function(){LibraryModel.addListener(Model.Event.MODEL_UPDATE,"ZContentLibraryController",function(a){ZContentLibraryController._dispatchEvent(ZContentLibraryController.Event.LIBRARY_READY)},!0),LibraryModel.addListener(Model.Event.MODEL_REMOVE,"ZContentLibraryController",function(a){ZContentLibraryController._dispatchEvent(ZContentLibraryController.Event.LIBRARY_REMOVE,{itemId:a.id})},!0),LibraryModel.addListener(Model.Event.MODEL_ADD,"ZContentLibraryController",function(a){ZContentLibraryController._dispatchEvent(ZContentLibraryController.Event.LIBRARY_ADD,{itemId:a.id})},!0),LibraryModel.addListener(Model.Event.MODEL_CLEAR,"ZContentLibraryController",function(a){ZContentLibraryController._dispatchEvent(ZContentLibraryController.Event.LIBRARY_CLEAR)},!0),ConnectionManager.addListener("ZEBRA:LIBRARY_CONTENT_COMPLETE",this,function(a){this.isContentLibraryProcessed||(this.isContentLibraryProcessed=!0,ZContentLibraryController._dispatchEvent(ZContentLibraryController.Event.LIBRARY_CO_COMPLETE))}),ConnectionManager.addListener("ZEBRA:LIBRARY_UPLOAD_STATUS",this,function(a){var b=a.getZEvent("uid").value,c=a.getZEvent("status_description").value,d=a.getZEvent("status_code").value;ZContentLibraryController._dispatchEvent(this.Event.LIBRARY_UPLOAD_STATUS,{itemId:b,status_description:c,status_code:d})})},loadLibrary:function(a){var b=new Zebra("com.blackboard.saturn.zag.zebra.Whiteboard#libraryGet");b.setZEvent("room_session_id",ConnectionManager.roomSession),b.setZEvent("script_path",LibraryModel.script_path),b.setZEvent("saturn_url",ConnectionManager.saturnURL),b.setZEvent("content_prefix",ConnectionManager.bbProxyURL),b.setZEvent("server_url",ConnectionManager.getServerURL()),b.setZEvent("script_path",a),ConnectionManager.sendZebra(b)},getLibraryItems:function(){return LibraryModel.items},getUploadURL:function(){return LibraryModel.uploadURL},getItem:function(a){return LibraryModel.getItem(a)},removeItem:function(a){return LibraryModel.requestRemoveLibrary(a)},displaySlide:function(a,b){var c=new Zebra("com.blackboard.saturn.zag.zebra.Whiteboard#librarySend");c.setZEvent("uid",a),b&&c.setZEvent("sub_slide",b),ConnectionManager.sendZebra(c)}});var TechCheck={Event:{DEVICE_LIST_CHANGED:"DEVICE_LIST_CHANGED",MIC_LIST_UPDATED:"MIC_LIST_UPDATED",CAM_LIST_UPDATED:"CAM_LIST_UPDATED",ALLOW_DENY_VISIBLE:"ALLOW_DENY_VISIBLE",LOCAL_VIDEO_UPDATED:"LOCAL_VIDEO_UPDATED",MEDIA_ACCESS_GRANTED:"MEDIA_ACCESS_GRANTED",MEDIA_ACCESS_FAILED:"MEDIA_ACCESS_FAILED",TECH_CHECK_DONE:"TECH_CHECK_DONE",DEVICE_LIST_AVAILABLE:"DEVICE_LIST_AVAILABLE",MEDIA_TRACK_ENDED:"MEDIA_TRACK_ENDED"},audioSource:[],audioStreams:{},videoSource:[],videoStreams:{},audioOutSource:[],httpsCheckDone:!1,lowResolStream:null,accessingHwd:!1,mediaAccessGranted:!1,mediaAccessFailed:!1,initialState:"INIT",callRenegotiation:!1,initialized:!1,initialVadSent:!1,deviceListAvailable:!1,cookieTechCheckRTC:"techcheck.devices.rtc",cookieTechCheckFlash:"techcheck.devices.flash",cookieCheckDone:!1,lastSelectedMicId:null,lastSelectedCamId:null,pendingRenegotiate:!1,useStreamTrackStop:!0,logEnabled:!1,cammicCheckFailed:!1,isAudioMuted:!1,isVideoMuted:!1,micSettings:{audio:{echoCancellation:!0}},cameraSettings:{video:{aspectRatio:1.77777,width:{max:640,min:640},height:{max:360,min:360}}},init:function(){this.initialized||(this.initialized=!0,ConnectionManager.addListener(TechCheck.Event.TECH_MIC_ACTIVITY,this,function(a){ZVideoViewController._dispatchEvent(TechCheck.Event.TECH_MIC_ACTIVITY,a)}),ConnectionManager.addListener("ZWRTC_REMOTE_STREAM_ATTACHED",this,function(a){this.callConnected()}),ConnectionManager.addListener("CAM_MIC_ALLOWED",this,function(a){this.accessingHwd=!1,zwrtc.viewOnly=!1,"true"==a.value?this.dispatchMediaAccessGranted():(this.mediaAccessFailed=!0,ZVideoViewController._dispatchEvent(this.Event.MEDIA_ACCESS_FAILED))}))},callConnected:function(){if(this.pendingRenegotiate){this.pendingRenegotiate=!1;var a=this;setTimeout(function(){a.setStream(),zwrtc.isMCU()&&rtcSFU.rvCompositeHigh?(a.callRenegotiation=!0,rtcSFU.updateStream(webRTC.localStream,a.lowResolStream)):CallManager.redialCall()},1e3)}else this.callRenegotiation&&(this.callRenegotiation=!1,this.dispatchTechCheckDone())},getCameraConfig:function(a,b){var c=parseInt(a);return isNaN(c)?b:c},setMicSettings:function(a){var b=navigator.mediaDevices.getSupportedConstraints();b.echoCancellation?a&&a.echoCancellation===!1&&(this.micSettings.audio.echoCancellation=!1):delete this.micSettings.audio.echoCancellation;
},parseCameraSettings:function(a){if(a){var b=this.getCameraConfig(a.max_width,640),c=this.getCameraConfig(a.min_width,640),d=this.getCameraConfig(a.ideal_width,640),e=this.getCameraConfig(a.max_height,360),f=this.getCameraConfig(a.min_height,360),g=this.getCameraConfig(a.ideal_height,360),h=this.getCameraConfig(a.max_fps,40),i=this.getCameraConfig(a.min_fps,0);this.cameraSettings.video={aspectRatio:1.7777777777777777},this.cameraSettings.video.width={min:c,ideal:d,max:b},this.cameraSettings.video.height={min:f,ideal:g,max:e},ConnectionManager.isChrome()&&(this.cameraSettings.video.frameRate={min:i,ideal:h,max:h})}},cameraToggled:function(){if(ZVideoViewController.isCamMuted()&&ConnectionManager.canStopCameraTrack()){this.releaseCameraStreams();var a=rtcSFU.rvCompositeHigh;a&&a.ortcMedia&&a.ortcMedia.videoSender&&(a.ortcMedia.videoSender.stop(),this.log("Stop video sender in Edge, else camera light will not stop"))}},showMicSelection:function(){this.initialState="TECH_CHECK",this.mediaAccessGranted?this.readDeviceList(!1,!0):this.accessMicMedia()},showCamSelection:function(){this.stopMicActivityCheck(),this.isAudioMuted||wrtcSetting.initiateMicActivity(zwrtc.getLocalStream(),TechCheck.Event.MIC_ACTIVITY),this.videoSource&&0==this.videoSource.length?ZVideoViewController._dispatchEvent(this.Event.CAM_LIST_UPDATED,{list:null,stream:null}):this.accessMedia(zwrtc.videoSourceID,zwrtc.audioSourceID)},readDeviceList:function(a,b){if(!this.mediaAccessGranted&&a)return this.deviceListAvailable=!1,void this.accessMicMedia();if(navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices){var c=this;navigator.mediaDevices.enumerateDevices().then(function(a){c.devicesAvailable(a,!0,b)})["catch"](function(a){c.log(a.name+": "+a.message),c.devicesAvailable(null,!1,b)})}else this.devicesAvailable(null,!1,b)},checkIfDeviceListSame:function(a,b){this.cookieCheckDone=!0;var c,d=this.cookieTechCheckRTC;if(c="undefined"!=typeof localStorage?localStorage.getItem(d):ConnectionManager.readCookie(d),null!=c){if(c=JSON.parse(c),!c.audioSource)return!1;if(c.audioSource=JSON.parse(c.audioSource),c.audioSource.length!==this.audioSource.length)return!1;if(!c.videoSource)return!1;if(c.videoSource=JSON.parse(c.videoSource),c.videoSource.length!==this.videoSource.length)return!1;if(a)for(var e=0;e<c.audioSource.length;e++){for(var f=!1,g=c.audioSource[e].id,h=0;h<a.length;h++){var i=a[h];if(g===i){f=!0;break}}if(!f)return!1}if(!b)return!1;for(var j=0;j<c.videoSource.length;j++){for(var f=!1,g=c.videoSource[j].id,h=0;h<b.length;h++){var i=b[h];if(g===i){f=!0;break}}if(!f)return!1}c.audioSourceID&&(zwrtc.audioSourceID=c.audioSourceID),c.videoSourceID&&(TechCheck.userFacingCamId&&!c.userFacingCamId?zwrtc.videoSourceID=TechCheck.userFacingCamId:(zwrtc.videoSourceID=c.videoSourceID,c.userFacingCamId&&(TechCheck.userFacingCamId=c.userFacingCamId)))}return!0},devicesAvailable:function(a,b,c){var d=this.audioSource,e=this.audioOutSource,f=this.videoSource;d.length=0,e.length=0,f.length=0;var g=[],h=[],i="id",j="audio",k="video";b&&(i="deviceId",j="audioinput",k="videoinput");for(var l=!1,m=0;m!=a.length;++m){var n=a[m];if(this.log(n.kind+" "+n.label+" "+n[i]),n.kind===j){var o=!1;zwrtc.audioSourceID?o=zwrtc.audioSourceID===n[i]:n[i]&&(zwrtc.audioSourceID=n[i],l=!0,o=!0),g.push(n[i]);var p=n.label||"Microphone "+d.length;d[d.length]={id:n[i],label:p,selected:o}}else if("audiooutput"===n.kind){var p=n.label||"Speaker "+e.length;e[e.length]={id:n[i],label:p}}else if(n.kind===k){var o=!1;zwrtc.videoSourceID?o=zwrtc.videoSourceID===n[i]:n[i]&&(TechCheck.userFacingCamId?zwrtc.videoSourceID=this.userFacingCamId:zwrtc.videoSourceID=n[i],l=!0,o=!0),h.push(n[i]);var p="Camera "+f.length;n.label&&(this.cameraNamesAvailable=!0,p=n.label),f[f.length]={id:n[i],label:p,selected:o}}}this.cookieCheckDone||this.checkIfDeviceListSame(g,h)||(ZVideoViewController._dispatchEvent(this.Event.DEVICE_LIST_CHANGED),this.log("DEVICE_LIST_CHANGED")),c?this.deviceListAvailable||l?this.accessMicMedia():this.updateMicCombo():this.updateCamCombo(),this.deviceListAvailable=!0,ZVideoViewController._dispatchEvent(this.Event.DEVICE_LIST_AVAILABLE)},isDeviceListAvailable:function(){return this.deviceListAvailable},isDevicesPresent:function(){return TechCheck.audioSource&&TechCheck.audioSource.length>0||TechCheck.videoSource&&TechCheck.videoSource.length>0},isDeviceListUpdated:function(){return!this.checkIfDeviceListSame(TechCheck.audioSource,TechCheck.videoSource)},updateMicCombo:function(){for(var a=0;a<this.audioSource.length;a++){var b=this.audioSource[a];b.id==zwrtc.audioSourceID?b.selected=!0:b.selected=!1}ZVideoViewController._dispatchEvent(this.Event.MIC_LIST_UPDATED,{list:this.audioSource})},switchViewOnly:function(a){if(CallManager._flashEnabled){var b=flashClient.getFlashObject();b&&b.updateConfig({viewOnly:"false",clientState:a}),zwrtc.viewOnly&&CallManager._flashEnabled&&(this.mediaAccessGranted||this.mediaAccessFailed||this.dispatchAccessingHwd(),b&&b.initAllowDeny())}else zwrtc.viewOnly=!1},getSelectedMicName:function(){if(this.audioSource&&null!=zwrtc.audioSourceID)for(var a=0;a<this.audioSource.length;a++)if(this.audioSource[a].id==zwrtc.audioSourceID)return this.audioSource[a].label;return""},getSelectedCamName:function(){if(this.videoSource&&null!=zwrtc.videoSourceID)for(var a=0;a<this.videoSource.length;a++)if(this.videoSource[a].id==zwrtc.videoSourceID)return this.videoSource[a].label;return""},micChanged:function(a){this.switchViewOnly("MIC_CHECK"),null!=a&&(zwrtc.audioSourceID=a,this.accessMicMedia())},camChanged:function(a){if(this.switchViewOnly("CAM_CHECK"),null!=a)if(zwrtc.videoSourceID=a,CallManager._flashEnabled){var b=flashClient.getFlashObject();if(b){var c=parseInt(a);isNaN(c)&&(c=0),b.setTempCamera(c)}}else"NONE"!=zwrtc.videoSourceID&&this.accessMedia(zwrtc.videoSourceID,zwrtc.audioSourceID)},accessMicMediaError:function(a){this.log("accessMicMediaError"),this.accessMicMedia()},initDevices:function(a,b){var c={};ConnectionManager.isMobile()?c.video={facingMode:{exact:"user"}}:c.video=!0,c.audio=!0,a||(a=this.initDeviceSuccess.bind(this)),b||(b=this.initDeviceError.bind(this)),ConnectionManager.isUsingPlugin?navigator.getUserMedia(c,a,b):navigator.mediaDevices.getUserMedia(c).then(a)["catch"](b)},initDeviceSuccess:function(a){a&&(ConnectionManager.isFF()?this.ffDefaultStream=a:rtcSFU.stopStreamTracks(a))},initDeviceError:function(a){this.log("initDeviceError")},accessMicMedia:function(a){this.accessMicrophone(a,!1)},getVideoStreamSettings:function(a){if(a){var b=a.getVideoTracks()[0];if(b)return b.getSettings()}return null},checkIfFrontCam:function(a){if(ConnectionManager.isMobile()){var b=this.getVideoStreamSettings(a);b&&"user"===b.facingMode&&(this.log("Detected front facing camera:"+JSON.stringify(b)),this.userFacingCamId=b.deviceId)}},isStreamLive:function(a,b){if(!b)return!1;var c=null;return c=a?b.getAudioTracks()[0]:b.getVideoTracks()[0],c&&"live"===c.readyState},getStreamIfActive:function(a,b){if(!b)return null;var c=null;return c=a?this.audioStreams[b]:this.videoStreams[b],this.isStreamLive(a,c)?(c.getTracks().forEach(function(a){a.enabled=!0}),c):null},setActiveStream:function(a,b,c){return c||(c="NONE"),a?void(this.audioStreams[c]=b):void(this.videoStreams[c]=b)},getActiveAudioStream:function(){if(this.audioSource)for(var a=0;a<this.audioSource.length;a++){var b=this.audioSource[a];if(b.selected)return this.audioStreams[b.id]}return null},getActiveVideoStream:function(){if(this.videoSource)for(var a=0;a<this.videoSource.length;a++){var b=this.videoSource[a];if(b.selected)return this.videoStreams[b.id]}return null},accessMicrophone:function(a,b){if(this.log("accessMicMedia: zwrtc.videoSourceID = "+zwrtc.videoSourceID+" zwrtc.audioSourceID = "+zwrtc.audioSourceID),this.accessingMicrophone)return void this.log("Ignoring accessMicrophone, as already accessing microphone");if(this.accessingMicrophone=!0,!b&&(a||(a=this.getStreamIfActive(!0,zwrtc.audioSourceID)),a))return this.printStreamDetails(a),void this.onMicMediaSuccess(a);var c={};c.audio=this.micSettings.audio,zwrtc.audioSourceID&&(c.audio.deviceId={exact:zwrtc.audioSourceID}),(ConnectionManager.isFF()||"Android"===ConnectionManager.getMobileOS())&&this.releaseMicStreams(),this.log("accessMicMedia:Mic constraints are "+JSON.stringify(c)),navigator.mediaDevices.getUserMedia(c).then(this.onMicMediaSuccess.bind(this))["catch"](this.onMicMediaFailed.bind(this)),this.dispatchAccessingHwd()},dispatchAccessingHwd:function(){this.accessingHwd=!0;var a=this,b=1500;CallManager._flashEnabled&&(b=5e3),setTimeout(function(){a.accessingHwd&&(a.mediaAccessGranted=!1,ZVideoViewController._dispatchEvent(a.Event.ALLOW_DENY_VISIBLE,""))},b)},onMicMediaSuccess:function(a){this.log("onMicMediaSuccess"),this.printStreamDetails(a),this.accessingMicrophone=!1,this.setActiveStream(!0,a,zwrtc.audioSourceID),this.accessingHwd=!1,this.dispatchMediaAccessGranted(),this.startMicActivityCheck(),this.deviceListAvailable?this.updateMicCombo():this.readDeviceList(!1,!0)},dispatchMediaAccessGranted:function(){this.mediaAccessGranted||ZVideoViewController._dispatchEvent(this.Event.MEDIA_ACCESS_GRANTED,{stream:webRTC.localStream}),this.mediaAccessGranted=!0},onMicMediaFailed:function(a){this.log("onMicMediaFailed:"+a),this.accessingHwd=!1,this.accessingMicrophone=!1,"NotAllowedError"===a.name?ZVideoViewController._dispatchEvent(this.Event.MEDIA_ACCESS_FAILED,""):this.dispatchMediaAccessGranted(),this.startMicActivityCheck(),this.deviceListAvailable?this.updateMicCombo():this.readDeviceList(!1,!0)},accessMedia:function(a,b){this.log("accessMedia: videoSourceID = "+a+" audioSourceID = "+b),this.accessCamera(a)},accessCamera:function(a){if(this.log("accessCamera: videoSourceID = "+a),this.accessingCamera)return void this.log("Ignoring accessCamera, as already accessing camera");this.accessingCamera=!0,this.releaseCameraStreams();var b={};return!this.userFacingCamId&&ConnectionManager.isMobile()?b.video={facingMode:{exact:"user"}}:(b.video=this.cameraSettings.video,b.data=!1,b.audio=!1,zwrtc.videoSourceID&&(b.video.deviceId={exact:zwrtc.videoSourceID})),this.log("accessCamera: Camera constraints are "+JSON.stringify(b)),!b||b.video||b.audio?void navigator.mediaDevices.getUserMedia(b).then(this.onUserMediaSuccess.bind(this))["catch"](this.onUserMediaError.bind(this)):void this.onUserMediaError({code:""})},onUserMediaSuccess:function(a){this.log("onUserMediaSuccess"),this.printStreamDetails(a),this.accessingCamera=!1,this.checkIfFrontCam(a);var b=this.getVideoStreamSettings(a);if(b&&(this.log("onUserMediaSuccess: camera settings:"+JSON.stringify(b)),zwrtc.videoSourceID||(zwrtc.videoSourceID=b.deviceId,this.log("onUserMediaSuccess: found device ID:"+zwrtc.videoSourceID))),this.setActiveStream(!1,a,zwrtc.videoSourceID),"INIT"==this.initialState){var c=new MediaStream,d=this.getActiveAudioStream();d&&c.addTrack(d);var e=this.getActiveVideoStream();e&&c.addTrack(e),webRTC.localStream=c,this.dispatchMediaAccessGranted(),zwrtc.isMCU()?rtcSFU.updateStream(webRTC.localStream,null):ZVideoViewController.placeCall()}else this.cameraNamesAvailable?this.updateCamCombo():this.readDeviceList(!1,!1)},onUserMediaError:function(a){return this.log("onUserMediaError:"+a),this.accessingCamera=!1,a&&"OverconstrainedError"===a.name&&this.cameraSettings.video.aspectRatio?(this.cameraSettings.video={},this.log("Accessing Camera again without any constraints"),void this.accessCamera(zwrtc.videoSourceID)):void this.accessMicOnly()},accessMicOnly:function(){var a={};a.video=!1,a.audio=this.micSettings.audio,zwrtc.audioSourceID&&(a.audio.deviceId={exact:zwrtc.audioSourceID}),this.log("accessMicOnly:Mic constraints are "+JSON.stringify(a)),ConnectionManager.isUsingPlugin?navigator.getUserMedia(a,this.onUserMediaSuccess.bind(this),this.onMicOnlyFailed.bind(this)):navigator.mediaDevices.getUserMedia(a).then(this.onUserMediaSuccess.bind(this))["catch"](this.onMicOnlyFailed.bind(this))},accessCamOnly:function(){var a={};a.data=!1,a.audio=!1,a.video=this.cameraSettings.video,zwrtc.videoSourceID&&(a.video.deviceId={exact:zwrtc.videoSourceID}),this.log("accessCamOnly:Cam constraints are "+JSON.stringify(a)),ConnectionManager.isUsingPlugin?navigator.getUserMedia(a,this.onUserMediaSuccess.bind(this),this.onCamOnlyFailed.bind(this)):navigator.mediaDevices.getUserMedia(a).then(this.onUserMediaSuccess.bind(this))["catch"](this.onCamOnlyFailed.bind(this))},onMicOnlyFailed:function(a){this.log("onMicOnlyFailed:"+a),this.accessCamOnly()},onCamOnlyFailed:function(a){this.log("onCamOnlyFailed:"+a),"INIT"==this.initialState?ZVideoViewController.placeCall():this.updateCamCombo()},updateCamCombo:function(){for(var a=0;a<this.videoSource.length;a++){var b=this.videoSource[a];b.id==zwrtc.videoSourceID?b.selected=!0:b.selected=!1}ZVideoViewController._dispatchEvent(this.Event.CAM_LIST_UPDATED,{list:this.videoSource,stream:this.getActiveVideoStream()})},startMicActivityCheck:function(){var a=this.getActiveAudioStream();a?(this.printStreamDetails(a),wrtcSetting.initiateMicActivity(a,TechCheck.Event.TECH_MIC_ACTIVITY)):this.stopMicActivityCheck()},stopMicActivityCheck:function(){wrtcSetting.stopMicActivityCheck()},displayPrivacy:function(){if(CallManager._flashEnabled){var a=flashClient.getFlashObject();a&&a.displayPrivacy()}},techCheckCancel:function(){this.log("techCheckCancel");var a=this.getActiveVideoStream();this.compareTracks(a,webRTC.localStream,"video")||rtcSFU.stopStreamTracks(a)},compareTracks:function(a,b,c){if(a&&b){var d=a.getAudioTracks()[0],e=a.getVideoTracks()[0],f=b.getAudioTracks()[0],g=b.getVideoTracks()[0];return"audio"===c?null!=d&&null!=f&&d.id===f.id:"video"===c?null!=e&&null!=g&&e.id===g.id:null!=d&&null!=f&&d.id===f.id&&null!=e&&null!=g&&e.id===g.id}},clearSavedDevices:function(){var a={},b=this.cookieTechCheckRTC;CallManager._flashEnabled&&(b=this.cookieTechCheckFlash),"undefined"!=typeof localStorage?localStorage.setItem(b,JSON.stringify(a)):ConnectionManager.createCookie(b,JSON.stringify(a),1)},saveDevices:function(){if(zwrtc.audioSourceID||zwrtc.videoSourceID){var a={};a.audioSourceID=zwrtc.audioSourceID,a.videoSourceID=zwrtc.videoSourceID,a.audioSource=JSON.stringify(this.audioSource),a.videoSource=JSON.stringify(this.videoSource),this.userFacingCamId&&(a.userFacingCamId=this.userFacingCamId);var b=this.cookieTechCheckRTC;CallManager._flashEnabled&&(b=this.cookieTechCheckFlash),"undefined"!=typeof localStorage?localStorage.setItem(b,JSON.stringify(a)):ConnectionManager.createCookie(b,JSON.stringify(a),1)}},techCheckDone:function(){this.log("techCheckDone"),this.initialVadSent||(this.initialVadSent=!0,rtcSFU.sendVadZebra(0,0)),this.saveDevices(),zwrtc.isMCU()&&rtcSFU.rvCompositeHigh?(this.setStream(),this.callRenegotiation=!0,rtcSFU.updateStream(webRTC.localStream,this.lowResolStream)):ConnectionManager.allowMediaCall?this.pendingRenegotiate=!0:(this.setStream(),this.callRenegotiation=!0),zwrtc.viewOnly=!1},setStream:function(){var a=new MediaStream,b=!1,c=this.getActiveAudioStream();if(c){var d=c.getAudioTracks()[0];d&&"live"===d.readyState&&(a.addTrack(d),b=!0,d.onended=function(a){ZVideoViewController._dispatchEvent(TechCheck.Event.MEDIA_TRACK_ENDED,{kind:"audio"})})}var e=this.getActiveVideoStream();if(e){var d=e.getVideoTracks()[0];d&&"live"===d.readyState&&(a.addTrack(d),b=!0,ZVideoViewController._dispatchEvent(this.Event.LOCAL_VIDEO_UPDATED,{stream:a}))}webRTC.localStream=a,b&&(this.dispatchMediaAccessGranted(),CallManager.micActivityEnabled&&wrtcSetting.initiateMicActivity(webRTC.localStream,TechCheck.Event.MIC_ACTIVITY))},dispatchTechCheckDone:function(){ZVideoViewController._dispatchEvent(this.Event.TECH_CHECK_DONE,""),this.lastSelectedMicId==zwrtc.audioSourceID&&this.lastSelectedCamId==zwrtc.videoSourceID||TelemetryZebraMsgs.sendTelemetryDeviceUpdate(),this.lastSelectedMicId=zwrtc.audioSourceID,this.lastSelectedCamId=zwrtc.videoSourceID,TechCheck.cameraToggled(),ZVideoViewController.dispatchMicState(!0)},isCamAvailable:function(a){if(null==a&&(a=this.getActiveVideoStream()),a)for(var b=a.getVideoTracks(),c=0;c<b.length;c++){var d=b[c];if(d&&"live"===d.readyState)return!0}return!1},isMicAvailable:function(a){if(null==a&&(a=this.getActiveAudioStream()),a)for(var b=a.getAudioTracks(),c=0;c<b.length;c++){var d=b[c];if(d&&"live"===d.readyState)return!0}return!1},toggleVideoMute:function(a){if(webRTC.localStream){var b=TechCheck.isVideoMuted;webRTC.localStream.getVideoTracks().forEach(function(b){b.enabled=!a,TechCheck.isVideoMuted=a}),b!==TechCheck.isVideoMuted&&(CallManager.setWebCamActive({isVideoMuted:TechCheck.isVideoMuted}),CallManager.sendClientToSaturnUserProps(),ZVideoViewController.dispatchCamState())}},toggleAudioMute:function(a){if(webRTC.localStream){var b=TechCheck.isVideoMuted;webRTC.localStream.getAudioTracks().forEach(function(b){b.enabled=!a,TechCheck.isAudioMuted=a}),b!==TechCheck.isVideoMuted&&(CallManager.sendClientToSaturnUserProps(),ZVideoViewController.dispatchMicState())}},printStreamDetails:function(a){if(a){var b=this;a.getTracks().forEach(function(c){c&&b.log("StreamID = "+a.id+" trackId = "+c.id+" kind = "+c.kind)})}},releaseCameraStreams:function(){for(deviceId in this.videoStreams)rtcSFU.stopStreamTracks(this.videoStreams[deviceId]),this.videoStreams[deviceId]=null;this.videoStreams.length=0},releaseMicStreams:function(){for(deviceId in this.audioStreams)rtcSFU.stopStreamTracks(this.audioStreams[deviceId]),this.audioStreams[deviceId]=null;this.audioStreams.length=0},releaseDevices:function(){this.releaseCameraStreams(),this.releaseMicStreams(),rtcSFU.stopStreamTracks(webRTC.localStream),rtcSFU.stopStreamTracks(rtcSFU._localStream),rtcSFU.stopStreamTracks(ssController.desktopStream),rtcSFU.stopStreamTracks(CallManager.oldLocalStream),rtcSFU.stopStreamTracks(CallManager.desktopStream),P2PMicActivity.close(),webRTC.localStream=null,rtcSFU._localStream=null,ssController.desktopStream=null,CallManager.oldLocalStream=null,CallManager.desktopStream=null},log:function(a){(this.logEnabled||Platform.debugLogEnabled)&&Platform.log("TechCheck:"+a)}},ConferenceName={PART_CHARACTERS:"-_=+.,",NAME_CHARACTERS:"-_=+.,|#",original:null,canonical:null,init:function(a){var b=this.split(a);this.original=a,this.canonical="",null!=b[0]&&(this.canonical=this.canonicalize(b[0])+"|"),this.canonical+=this.canonicalize(b[1]),null!=b[2]&&(this.canonical+="#"+this.canonicalize(b[2]))},canonicalize:function(a){for(var b="",c=0;c<a.length;c++){var d=a.charAt(c);this.isLetterOrDigit(d)?b+=d:this.PART_CHARACTERS.indexOf(d)>=0&&(b+=d)}return b},getOriginalName:function(){return this.original},getCanonicalName:function(){return this.canonical},getDisplayName:function(){return this.split(this.original)[1]},isLetterOrDigit:function(a){return!!a&&a.match(/^[0-9a-zA-Z]+$/)},split:function(a){var b=a.indexOf("|"),c=-1,d=[];return b>=0?(d.push(a.substring(0,b)),c=a.indexOf("#",b+1)):(d.push(null),c=a.indexOf("#")),c>=0?(d.push(a.substring(b+1,c)),d.push(a.substring(c+1))):(d.push(a.substring(b+1)),d.push(null)),d}},screenShareViewer={flashEmbeded:!1,_type:"VIDEO",_destination:54321,cam_width:320,cam_height:240,in_video_width:640,in_video_height:480,cam_fps:30,_ratio:1.33333,_protocol:"RTMFP",_failOverPriority:"rtmps,rtmpt",_failoverStartPort:"rtmps",_maxBwd:500,_username:null,_useSessionId:"",_swfInit:!1,_bgColor:"#FFFFFF",_stageBGColor:"0x000000",logEnabled:!1,ssRunning:!1,embedFlash:function(a,b){this.ssRunning=!0,0==$("#spFPSSClient").length?this.embedFlashSWF(a,b):this.mnUpdated()},embedFlashSWF:function(a,b){var c=swfobject.getFlashPlayerVersion();if(null==c||c.major<CallManager.fpVersion)return!1;var d=CallManager.fpVersion+".0.0",e="user/swf/playerProductInstall.swf",f={};f.enableLogging="true",f.logLevel="4",f.timerOnRV=!1,f._show_call_timer=!1,f.jsCallBack="onSSInvoke",f.stageBGColor=this._stageBGColor,f.rtmfpPort=flashClient._rtmfpPort,f.transparent="true",f.monitorDuration="15000",CallManager.useOwnProtocolForSS||this.generateSSURL(),CallManager.appshareStream&&(f.streamMode="PLAY",f.viewOnly="true");var g={};g.quality="high",g.bgcolor=this._bgColor,g.allowscriptaccess="sameDomain",g.allowfullscreen="true",g.FullScreenOnSelection="false",g.wmode="transparent";var h={};h.id="spFPSSClient",h.name="spFPSSClient",h.align="center";var i="user/swf/zc.swf";return b&&(i=b),swfobject.embedSWF(i,a,"100%","100%",d,e,f,g,h),!0},hangup:function(){this.ssRunning=!1;try{$("#spFPSSClient")[0].hangup()}catch(a){}},generateSSURL:function(){CallManager.appshareStream="rtmps://"+ConnectionManager.getZS()+"/zslive/"+ConnectionManager.roomSession;var a=parseInt(ConnectionManager.groupId);!isNaN(a)&&a>0&&(CallManager.appshareStream=CallManager.appshareStream+"."+a),"BandLowWithVideo"===CallManager.lowBrMode&&(CallManager.appshareStream=CallManager.appshareStream+"_lowbr")},mnUpdated:function(){this.generateSSURL(),this.hangup(),this.ssRunning=!0;try{$("#spFPSSClient")[0].playRTMPUrl(CallManager.appshareStream)}catch(a){}},handleAVFRWError:function(){var a=this;setTimeout(function(){a._ssDisconnected&&flashClient._callEstablished&&a.placeCall("VIDEO","54321",flashClient._protocol),a._ssDisconnected=!1},2e3)},placeCall:function(a,b,c){this._type=a.replace("DIAL",""),b.indexOf("#")==-1&&b.indexOf("%23")==-1&&(b=b+"%23"+LineStatesModel.getNextAvailableLine()),this._destination=b,this.generateSR(this._destination,c)},generateSR:function(a,b){var c={};if(c.type=this._type,null!=a?(c.connectmode="2",c.destination=a):c.mcu="true",c.isP2P="false",ConnectionManager.getZS?c.zenonserver=ConnectionManager.getZS():c.zenonserver=window.location.host,b?c.protocol=b:c.protocol=this._protocol,c.width=this.cam_width,c.height=this.cam_height,c.inVideoWidth=this.in_video_width,c.inVideoHeight=this.in_video_height,c.fps=this.cam_fps,this._username)c.username=this._username;else{var d=Math.round(1e4*Math.random());this._useSessionId="NAFLASHSCREEN"+(d+1),this._username=c.username="NAFLASHSCREEN"+rtcSFU.getUserName()+"_"+d}c.service=ConnectionManager.service,c._userUp=this._maxBwd,this.sendSR(c)},sendSR:function(a){a&&(a.ignoreMute=!0,a.viewOnly=!0,$("#spFPSSClient")[0].parseSR(a))},onInvoke:function(a,b){switch(this.log("SS:onInVoke:"+a+" "+b+" "+this._username),a){case"swfInitialized":this._swfInit=!0,$("#spFPSSClient")[0].tabIndex=flashClient.tabIndex,CallManager._dispatchEvent(CallManager.Event.CONNECTING,{type:"mcu",conn_type:"FLASH_SS"}),CallManager.appshareStream?$("#spFPSSClient")[0].playRTMPUrl(CallManager.appshareStream):this.placeCall("VIDEO","54321",flashClient._protocol);break;case"sendPlaceCall":b&&this.sendPlaceCall(b);break;case"sendRestZebra":break;case"avfrwError":this._ssDisconnected=!0,this.handleAVFRWError();break;case"sendAVFRWConnect":b&&this.sendAVFRWConnect(b);break;case"remoteVideoRecvd":$("#spFPSSClient").length>0&&$("#spFPSSClient")[0].resizeRV(flashClient.ssWidth,flashClient.ssHeight),ZVideoViewController._dispatchEvent(ZVideoViewController.Event.FLASH_SS_MEDIA_STARTED,{width:flashClient.ssWidth,height:flashClient.ssHeight}),CallManager._dispatchEvent(CallManager.Event.CONNECTED,{type:"mcu",conn_type:"FLASH_SS"});break;case"callTerminated":CallManager._ssDetected&&(this.log("screen share leg disconnected, replaying screen share leg"),this.mnUpdated())}},sendAVFRWConnect:function(a){var b="&command=startAV";a.zsPublishID?b=b+"&zsPublishID="+a.zsPublishID:a.zcdPublishID&&(b=b+"&zcdPublishID="+a.zcdPublishID)},sendPlaceCall:function(a){var b=new Zebra("org.zenon.server.zebra.ZebraHandler#placeCall");b.setZEvent("isP2P","false"),b.setZEvent("width",this.in_video_width),b.setZEvent("height",this.in_video_height),b.setZEvent("videoCodec",a.videoCodec),b.setZEvent("inVideoCodec",a.videoCodec),b.setZEvent("audioCodec",a.audioCodec),b.setZEvent("inAudioCodec",a.audioCodec),b.setZEvent("resolution",a.resolution),b.setZEvent("channel","screenshare"),b.setZEvent("flashSsUser",this._username),b.setZEvent("client","flash"),b.setZEvent("destination",this._destination),b.setZEvent("type",this._type),a.zcdPublishID&&b.setZEvent("zcdPublishID",a.zcdPublishID),a.zsPublishID&&b.setZEvent("zsPublishID",a.zsPublishID),a.cdconnection&&b.setZEvent("cdconnection",a.cdconnection),a.avfrw&&b.setZEvent("avfrw",a.avfrw),ConnectionManager.sendZSZebraCommand("placeCall",b)},bwModeUpdated:function(){CallManager._ssDetected&&(this.log("bwModeUpdated, replaying screen share leg"),this.mnUpdated())},ssStarted:function(){var a=this;setTimeout(function(){a.ssRunning||(a.log("Screen share not running, starting again"),a.mnUpdated())},1e3)},endCall:function(){this.ssRunning=!1,this._ssDisconnected=!1,CallManager._flashEnabled&&(CallManager._dispatchEvent(CallManager.Event.ENDED,{type:"mcu",conn_type:"FLASH_SS"}),this.hangup())},log:function(a){this.logEnabled&&Platform.log(a)}},RecorderUtil={workerJS:null,workerBlobURL:null,worker:null,init:function(){null==this.workerJS&&(this.workerJS=new Blob(["var recLength = 0,recBuffersL = [],recBuffersR = [],sampleRate;this.onmessage = function(e){switch(e.data.command){case 'init':init(e.data.config);break;case 'record':record(e.data.buffer);break;case 'exportWAV':exportWAV(e.data.type);break;case 'getBuffer':getBuffer();break;case 'clear':clear();break;}};function init(config){sampleRate = config.sampleRate;}function record(inputBuffer){recBuffersL.push(inputBuffer[0]);recBuffersR.push(inputBuffer[1]);recLength += inputBuffer[0].length;}function exportWAV(type){var bufferL = mergeBuffers(recBuffersL, recLength);var bufferR = mergeBuffers(recBuffersR, recLength);var interleaved = interleave(bufferL, bufferR);var dataview = encodeWAV(interleaved);var audioBlob = new Blob([dataview], { type: type });this.postMessage(audioBlob);}function getBuffer() {var buffers = [];buffers.push( mergeBuffers(recBuffersL, recLength) );buffers.push( mergeBuffers(recBuffersR, recLength) );this.postMessage(buffers);}function clear(){recLength = 0;recBuffersL = [];recBuffersR = [];}function mergeBuffers(recBuffers, recLength){var result = new Float32Array(recLength);var offset = 0;for (var i = 0; i < recBuffers.length; i++){result.set(recBuffers[i], offset);offset += recBuffers[i].length;}return result;}function interleave(inputL, inputR){var length = inputL.length + inputR.length;var result = new Float32Array(length);var index = 0,inputIndex = 0;while (index < length){result[index++] = inputL[inputIndex];result[index++] = inputR[inputIndex];inputIndex++;}return result;}function floatTo16BitPCM(output, offset, input){for (var i = 0; i < input.length; i++, offset+=2){var s = Math.max(-1, Math.min(1, input[i]));output.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);}}function writeString(view, offset, string){for (var i = 0; i < string.length; i++){view.setUint8(offset + i, string.charCodeAt(i));}}function encodeWAV(samples){var buffer = new ArrayBuffer(44 + samples.length * 2);var view = new DataView(buffer);writeString(view, 0, 'RIFF');view.setUint32(4, 32 + samples.length * 2, true);writeString(view, 8, 'WAVE');writeString(view, 12, 'fmt ');view.setUint32(16, 16, true);view.setUint16(20, 1, true);view.setUint16(22, 2, true);view.setUint32(24, sampleRate, true);view.setUint32(28, sampleRate * 4, true);view.setUint16(32, 4, true);view.setUint16(34, 16, true);writeString(view, 36, 'data');view.setUint32(40, samples.length * 2, true);floatTo16BitPCM(view, 44, samples);return view;}"]),this.workerBlobURL=window.URL.createObjectURL(this.workerJS))},getWorkerInstance:function(){return null==this.workerJS&&this.init(),new Worker(this.workerBlobURL)},getSingletonWorkerInstance:function(){return null==this.worker&&(this.worker=this.getWorkerInstance()),this.worker},clear:function(a){a?a.postMessage({command:"clear"}):this.worker&&this.worker.postMessage({command:"clear"})},exportWAV:function(a,b,c){var d=b;if(c=c||"audio/wav",!d)throw new Error("Callback not set");a&&(a.onmessage=function(a){var b=a.data;d(b)},a.postMessage({command:"exportWAV",type:c}))},forceDownload:function(a,b){var c=(window.URL||window.webkitURL).createObjectURL(a),d=window.document.createElement("a");d.href=c,d.style="display: none",d.download=b||"output.wav",document.body.appendChild(d),d.click(),setTimeout(function(){document.body.removeChild(d),window.URL.revokeObjectURL(c)},100)},finish:function(a,b){if(null==a&&(a=this.worker),this.worker=null,a){var c=this;this.exportWAV(a,function(d){c.forceDownload(d,b),c.clear(a)})}}},Recorder=function(a,b,c){var d=c||{},e=d.bufferLen||4096;this.recording=!1,this.source=a,this.context=this.source.context,this.worker=b,this.node=(this.context.createScriptProcessor||this.context.createJavaScriptNode).call(this.context,e,2,2);var f,g=this;this.node.onaudioprocess=function(a){g.recording&&g.worker&&g.worker.postMessage({command:"record",buffer:[a.inputBuffer.getChannelData(0),a.inputBuffer.getChannelData(1)]})},this.configure=function(a){for(var b in a)a.hasOwnProperty(b)&&(d[b]=a[b])},this.record=function(){this.recording=!0},this.stop=function(){this.recording=!1},this.getBuffer=function(a){f=a||d.callback,this.worker.postMessage({command:"getBuffer"})},this.clear=function(){this.node&&this.node.disconnect(),this.source&&this.source.disconnect(),this.node=null,this.source=null},this.source.connect(this.node),this.node.connect(this.context.destination)},loadTest={redialDurationUnderLoad:0,toggleRecording:0,toggleWhiteboard:0,toggleAppshare:0,whiteboardDraw:0,pptShare:0,fakeIM:0,whiteboardLoaded:!1,noSlides:1,fileUploadDuration:0,recordAudio:!1,recordVideo:!1,recordSingleAudio:!1,recordAudioSlots:!1,audioRecordMap:{},startSS:!1,ssInitiated:!1,wavRollOverDuration:6e4,webmRollOverDuration:6e4,mediaRecorder:null,recordedBlobs:null,logEnabled:!1,init:function(){var a=ZVideoViewController,b=parseInt(a.getConfigParam("reconn",null));isNaN(b)||(this.redialDurationUnderLoad=b);var c=parseInt(a.getConfigParam("toggleRecording",null));isNaN(c)||(this.toggleRecording=c);var d=parseInt(a.getConfigParam("toggleWhiteboard",null));isNaN(d)||(this.toggleWhiteboard=d);var e=parseInt(a.getConfigParam("toggleAppshare",null));isNaN(e)||(this.toggleAppshare=e);var f=parseInt(a.getConfigParam("whiteboardDraw",null));isNaN(f)||(this.whiteboardDraw=f);var g=parseInt(a.getConfigParam("pptShare",null));isNaN(g)||(this.pptShare=g);var h=parseInt(a.getConfigParam("noSlides",null));isNaN(h)||(this.noSlides=h);var i=parseInt(a.getConfigParam("fakeIM",null));isNaN(i)||(this.fakeIM=i);var j=a.getConfigParam("successURL",null);j&&(rtcSFU.successURL=decodeURIComponent(j));var k=a.getConfigParam("e2eCheck",null);if("audio"!==k&&"video"!==k||(rtcSFU.e2eCheck=k),a.getConfigParam("postLogLoop",!1)){var l=this;setTimeout(function(){l.postLogStartLoop()},6e4)}this.recordAudio=a.getConfigParam("recordAudio",!1),this.recordVideo=a.getConfigParam("recordVideo",!1),this.recordSingleAudio=a.getConfigParam("recordSingleAudio",!1),this.recordAudioSlots=a.getConfigParam("recordAudioSlots",!1),this.startSS=a.getConfigParam("startSS",!1);var m=parseInt(a.getConfigParam("forceVadDuration",null));isNaN(m)||(m>0?rtcSFU.forceVadDuration=1e3*m:rtcSFU.forceVadDuration=m);var n=parseInt(a.getConfigParam("vadMultiplier",null));!isNaN(n)&&n>1&&(rtcSFU.vadMultiplier=n);var o=parseInt(a.getConfigParam("fileUpDuration",null));isNaN(o)||(this.fileUploadDuration=1e3*o);var p=parseInt(a.getConfigParam("wavRollOverDuration",null));isNaN(p)||(this.wavRollOverDuration=1e3*p);var q=parseInt(a.getConfigParam("webmRollOverDuration",null));isNaN(q)||(this.webmRollOverDuration=1e3*q),ConnectionManager.addListener("ZEBRA:ToggleMediaDevice",this,function(a){if(a){var b=null,c=null;try{b=a.getZEvent("mic").value}catch(d){}try{c=a.getZEvent("cam").value}catch(d){}("toggle"===c||"on"===c&&TechCheck.isVideoMuted||"off"===c&&!TechCheck.isVideoMuted)&&this.toggleVideoMute(),("toggle"===b||"on"===b&&TechCheck.isAudioMuted||"off"===b&&!TechCheck.isAudioMuted)&&this.toggleAudioMute()}}),ZVideoViewController.addListener(ZVideoViewController.Event.ATTACH_RV_STREAM,function(a){loadTest.recordAudio&&a&&a.userId&&a.stream&&loadTest.startAudioRecording(a.userId,a.stream);
}),ZVideoViewController.addListener(ZVideoViewController.Event.REMOVE_RV_STREAM,function(a){loadTest.recordAudio&&a&&a.userId&&loadTest.stopAudioRecording(a.userId)}),ConnectionManager.addListener("RECORD_STREAMS_SLOT",this,function(a){loadTest.recordVideo?loadTest.startVideoRecording():loadTest.handleRecordStreams(a)}),ConnectionManager.addListener("ZWRTC_FOCUS_RV",this,function(a){this.recordTopSlot()}),ConnectionManager.addListener("GOT_SS_STREAM",this,function(a){loadTest.recordVideo?a&&a.stream&&(webRTC.localStream=a.stream,loadTest.startVideoRecording()):ConnectionManager._dispatchEvent("GOT_SS_STREAM",a)}),ConnectionManager.addListener("ZEBRA:RECORD_MEDIA",this,function(a){if(a){var b=null,c="audio";try{c=a.getZEvent("media_type").value}catch(d){}try{b=a.getZEvent("action").value}catch(d){}if("audio"===c){var e=!0;try{"false"===a.getZEvent("single_audio").value&&(e=!1)}catch(d){}this.handleAudioRecording(b,e)}}}),ConnectionManager.addListener("ZEBRA:LOADTEST_COMMAND",this,function(a){if(a){var b=CallManager.getZEvent(a,"command");switch(b){case"RECORDING":var c=CallManager.getZEvent(a,"action");"START"===c?Module.BbClassroom.getSharedClassroom().startRecording():"STOP"===c&&Module.BbClassroom.getSharedClassroom().stopRecording();break;case"APPSHARE":var c=CallManager.getZEvent(a,"action");"START"===c?ZVideoViewController.startScreenShare():"STOP"===c&&ZVideoViewController.stopScreenShare();break;case"WHITEBOARD":var c=CallManager.getZEvent(a,"action");if("START"===c)this.switchToWhiteboard();else if("STOP"===c)this.whiteboardLoaded=!1,Module.BbClassroom.getSharedClassroom().getViewFeature().requestModeSwitch(Module.BbViewMode.Bb_VIEW_MODE_NONE);else if("DRAW"===c)this.drawOnWhiteBoard();else if("SLIDE"===c){var d=CallManager.getZEvent(a,"page");if(null!=d){var e=parseInt(d);isNaN(e)&&(e=1),ZContentLibraryController.displaySlide("100",d)}else ZContentLibraryController.displaySlide("100",1)}break;case"IM":var f=CallManager.getZEvent(a,"msg");null==f&&(f=this.getRandomIMMessage()),Module.BbClassroom.getSharedClassroom().getChatFeature().sendMessageToCurrentRoom(f,!1);break;case"UPLOAD_AVATAR":this.captureImage()}}})},handleAudioRecording:function(a,b){this.log("handleAudioRecording: action="+a+" recordSingleAudio="+b),"start"===a?(this.wavRollOverDuration=0,b?(this.recordAudioSlots&&(this.log("handleAudioRecording: action=start: stopping audioSlotRecording"),this.terminateAudioSlotRecording(),this.recordAudioSlots=!1),this.recordSingleAudio||(this.recordSingleAudio=!0,loadTest.handleRecordStreams(rtcSFU.rvCompositeHigh.getSlotData()))):(this.recordSingleAudio&&(this.log("handleAudioRecording: action=start: stopping singleAudioRecording"),this.terminateSingleAudioRecording(),this.recordSingleAudio=!1),this.recordAudioSlots||(this.recordAudioSlots=!0,loadTest.handleRecordStreams(rtcSFU.rvCompositeHigh.getSlotData())))):"stop"===a?(this.wavRollOverDuration=0,this.recordAudioSlots&&(this.log("handleAudioRecording: action=stop: stopping audioSlotRecording"),this.terminateAudioSlotRecording(),this.recordAudioSlots=!1),this.recordSingleAudio&&(this.log("handleAudioRecording: action=stop: stopping singleAudioRecording"),this.terminateSingleAudioRecording(),this.recordSingleAudio=!1,this.audioRecordMap={})):this.log("handleAudioRecording: Unknown Action = "+a)},handleRecordStreams:function(a){if((loadTest.recordAudioSlots||this.recordSingleAudio)&&a&&a.slot_map){for(var b=0;b<a.slot_map.length;b++){var c=a.slot_map[b];c&&(this.recordSingleAudio||this.stopAudioRecording(b),this.startAudioRecording(b,c))}if(this.wavRollOverDuration>0){this.wavRollOverTimeout&&clearInterval(this.wavRollOverTimeout);var d=this;this.wavRollOverTimeout=setInterval(function(){d.rollOverWav()},this.wavRollOverDuration)}}},postLogStartLoop:function(){setInterval(this.postLogLoop,5e3)},postLogLoop:function(){Platform.log(" postLogLoop "+Platform.is_uploading),Platform.is_uploading||Platform.postLog()},recordTopSlot:function(){var a=rtcSFU.topSfuSlot;if(CallManager.audioMixMCU&&(a=4),null!=this.sfuSlotRec&&this.sfuSlotRec!=a){var b=this.audioRecordMap[this.sfuSlotRec];if(b){var c=b.rec;c&&(this.log("SFU slot changed:stopping recording on "+this.sfuSlotRec+" and starting on "+a),c.stop())}}this.sfuSlotRec=a;var d=this.audioRecordMap[this.sfuSlotRec];if(d){var c=d.rec;c&&c.record()}},startAudioRecording:function(a,b){if(null!=a&&b){this.stopAudioRecording(a);var c=window.AudioContext,d=(new c).createMediaStreamSource(b),e=null;loadTest.recordSingleAudio?null==RecorderUtil.worker?(e=RecorderUtil.getSingletonWorkerInstance(),e.postMessage({command:"init",config:{sampleRate:d.context.sampleRate}})):e=RecorderUtil.worker:(e=RecorderUtil.getWorkerInstance(),e.postMessage({command:"init",config:{sampleRate:d.context.sampleRate}}));var f=new Recorder(d,e,{});loadTest.recordSingleAudio?this.recordTopSlot():f.record(),this.audioRecordMap[a]={rec:f,worker:e,source:d}}},stopAudioRecording:function(a){if(this.audioRecordMap[a]){var b=this.audioRecordMap[a];if(b){var c=b.rec,d=b.worker;c&&(c.stop(),c.clear(),loadTest.recordSingleAudio||RecorderUtil.finish(d,ConnectionManager.userId+"_"+a+"_"+ConnectionManager.roomSession+"_"+(new Date).getTime()+".wav"))}delete this.audioRecordMap[a]}},rollOverWav:function(){if(this.recordSingleAudio){if(RecorderUtil.finish(RecorderUtil.worker,ConnectionManager.userId+"_TopSlot_"+ConnectionManager.roomSession+"_"+(new Date).getTime()+".wav"),RecorderUtil.worker=null,this.audioRecordMap)for(var a in this.audioRecordMap)if(this.audioRecordMap.hasOwnProperty(a)&&this.audioRecordMap[a]){var b=this.audioRecordMap[a];if(b){var c=null;null==RecorderUtil.worker?(c=RecorderUtil.getSingletonWorkerInstance(),b.source&&c.postMessage({command:"init",config:{sampleRate:b.source.context.sampleRate}})):c=RecorderUtil.getSingletonWorkerInstance(),b.rec.worker=b.worker=c}}}else if(loadTest.recordAudioSlots&&this.audioRecordMap)for(var a in this.audioRecordMap)if(this.audioRecordMap.hasOwnProperty(a)&&this.audioRecordMap[a]){var b=this.audioRecordMap[a];if(b){RecorderUtil.finish(b.worker,ConnectionManager.userId+"_"+a+"_"+ConnectionManager.roomSession+"_"+(new Date).getTime()+".wav");var c=RecorderUtil.getWorkerInstance();b.source&&c.postMessage({command:"init",config:{sampleRate:b.source.context.sampleRate}}),b.rec.worker=b.worker=c}}},terminateSingleAudioRecording:function(){this.log("terminateSingleAudioRecording"),this.clearRollOverIntv(),loadTest.recordSingleAudio&&(RecorderUtil.finish(RecorderUtil.worker,ConnectionManager.userId+"_TopSlot_"+ConnectionManager.roomSession+"_"+(new Date).getTime()+".wav"),RecorderUtil.worker=null)},terminateAudioSlotRecording:function(){if(this.log("terminateAudioSlotRecording"),this.clearRollOverIntv(),this.audioRecordMap)for(var a in this.audioRecordMap)this.audioRecordMap.hasOwnProperty(a)&&this.stopAudioRecording(a)},clearRollOverIntv:function(){this.log("clearRollOverIntv"),this.wavRollOverTimeout&&clearInterval(this.wavRollOverTimeout)},callEnded:function(){this.log("callEnded"),this.terminateSingleAudioRecording(),this.terminateAudioSlotRecording(),this.stopVideoRecording(),this.sfuSlotRec=null,this.recordedBlobs=null},toggleVideoMute:function(){ZVideoViewController.isCamAvailable()&&!zwrtc.viewOnly?webRTC.toggleVideoMute():(this.videoToggle=!0,this.accessMedia())},toggleAudioMute:function(){ZVideoViewController.isMicAvailable()&&!zwrtc.viewOnly?webRTC.toggleAudioMute():(this.audioToggle=!0,this.accessMedia())},accessMedia:function(){if(!this.accessingMedia)if(this.accessingMedia=!0,CallManager._flashEnabled){zwrtc.viewOnly=!1;var a=flashClient.getFlashObject();a&&(a.updateConfig({viewOnly:"false",clientState:""}),flashClient._accessGranted=!0,a.initAllowDeny()),ConnectionManager.addListener("CAM_MIC_ALLOWED",this,function(a){this.videoToggle&&(this.videoToggle=!1,webRTC.toggleVideoMute()),this.audioToggle&&(this.audioToggle=!1,webRTC.toggleAudioMute());var b=flashClient.getFlashObject();b&&b.startVadSampling(),flashClient.checkVideoMuted()})}else{zwrtc.viewOnly=!1;var b=wrtcSetting.getMediaConstraints(zwrtc.cam_width,zwrtc.cam_height,zwrtc.cam_width,zwrtc.cam_height,zwrtc.cam_fps,zwrtc.cam_fps_min,zwrtc.videoSourceID,zwrtc.audioSourceID);this.log("accessMedia:Camera constraints are "+JSON.stringify(b)),!b||b.video||b.audio?navigator.mediaDevices.getUserMedia(b).then(this.onUserMediaSuccess.bind(this))["catch"](this.onUserMediaError.bind(this)):this.onUserMediaError({code:""})}},onUserMediaSuccess:function(a){this.log("onUserMediaSuccess"),TechCheck.localStream&&TechCheck.localStream!==a&&rtcSFU.stopStreamTracks(TechCheck.localStream),TechCheck.localStream=a,webRTC.localStream&&TechCheck.localStream!==webRTC.localStream&&rtcSFU.stopStreamTracks(webRTC.localStream),webRTC.localStream=TechCheck.localStream,TechCheck.dispatchMediaAccessGranted(),zwrtc.isMCU()?rtcSFU.updateStream(webRTC.localStream,null):ZVideoViewController.placeCall(),this.videoToggle&&(this.videoToggle=!1,webRTC.toggleVideoMute()),this.audioToggle&&(this.audioToggle=!1,webRTC.toggleAudioMute()),this.accessingMedia=!1},onUserMediaError:function(a){this.log("onUserMediaError"),this.accessingMedia=!1},callConnected:function(){this.redialDurationUnderLoad>0&&setTimeout(function(){window.location.reload(!1)},6e4*this.redialDurationUnderLoad),this.startRecordingTest(),this.startWhiteboardTest(),this.startAppshareTest(),this.startWhiteboardDraw(),this.startPptShare(),this.startFakeIM(),this.startContentUpload(),this.ssInitiated||!this.startSS&&!CallManager.recordUsingSS||(this.ssInitiated=!0,ZVideoViewController.startScreenShare()),loadTest.recordVideo&&loadTest.startVideoRecording()},startContentUpload:function(){if(this.fileUploadDuration>0){this.fileUploadTimeout&&clearInterval(this.fileUploadTimeout);var a=this;this.fileUploadTimeout=setInterval(function(){a.captureImage()},this.fileUploadDuration)}},startRecordingTest:function(){this.toggleRecording>0&&(this.recordingTimeout&&clearInterval(this.recordingTimeout),this.recordingTimeout=setInterval(function(){Module.BbClassroom.getSharedClassroom().stopRecording(),setTimeout(function(){Module.BbClassroom.getSharedClassroom().startRecording()},5e3)},1e3*this.toggleRecording),Module.BbClassroom.getSharedClassroom().startRecording())},startWhiteboardTest:function(){if(this.toggleWhiteboard>0){this.whiteBoardTimeout&&clearInterval(this.whiteBoardTimeout);var a=this;this.whiteBoardTimeout=setInterval(function(){if(a.whiteboardLoaded){var b=angular.element(document).injector().get("ViewModeModel");b&&(b.requestSwitchToNone(),a.whiteboardLoaded=!1)}else a.switchToWhiteboard()},1e3*(this.toggleWhiteboard+1)),setTimeout(function(){a.switchToWhiteboard()},5e3)}},switchToWhiteboard:function(){var a=angular.element(document).injector().get("WhiteboardService"),b=angular.element(document).injector().get("ViewModeModel");if(a&&b)try{a.resetWhiteboard(),b.requestSwitchToWhiteboard(),this.whiteboardLoaded=!0}catch(c){}},startAppshareTest:function(){this.toggleAppshare>0&&(this.appShareTimeout&&clearInterval(this.appShareTimeout),this.appShareTimeout=setInterval(function(){ZVideoViewController.stopScreenShare(),setTimeout(function(){ZVideoViewController.startScreenShare()},5e3)},1e3*(this.toggleAppshare+1)),ZVideoViewController.startScreenShare())},startWhiteboardDraw:function(){if(this.toggleWhiteboard>0&&this.whiteboardDraw>0){this.whiteBoardDrawTimeout&&clearInterval(this.whiteBoardDrawTimeout);var a=this;this.whiteBoardDrawTimeout=setInterval(function(){a.whiteboardLoaded&&a.drawOnWhiteBoard()},1e3*this.whiteboardDraw),a.whiteboardLoaded&&a.drawOnWhiteBoard()}},drawOnWhiteBoard:function(){var a=new Z.zjs.Zebra("com.blackboard.saturn.zag.zebra.Whiteboard#appendWhiteBoard2");a.setZEvent("action","<![CDATA[draw]]>");var b=1500*Math.random(),c=1500*Math.random(),d=1500*Math.random(),e=1500*Math.random(),f="[["+b+","+c+"],["+d+","+e+"]]",g='{"type":"Path","data_id":"57ca5623-44cb-4f87-b2dd-3bec0539b4f9","action":"draw","item":["Path",{"applyMatrix":true,"data":{"id":"57ca5623-44cb-4f87-b2dd-3bec0539b4f9"},"segments":'+f+',"strokeColor":['+Math.random()+","+Math.random()+","+Math.random()+'],"strokeWidth":4.5}]}';a.setZEvent("value","<![CDATA["+g+"]]>"),a.setZEvent("event","VIEWER_UPDATE"),a.setZEvent("sender","73"),Z.zjs.ConnectionManager.sendZebra(a)},startPptShare:function(){if(this.toggleWhiteboard>0&&this.pptShare>0){this.pptShareTimeout&&clearInterval(this.pptShareTimeout);var a=this,b=1;this.pptShareTimeout=setInterval(function(){a.whiteboardLoaded&&(ZContentLibraryController.displaySlide("100",b++),b>=a.noSlides&&(b=1))},1e3*this.pptShare),a.whiteboardLoaded&&ZContentLibraryController.displaySlide("100",1)}},startFakeIM:function(){if(this.fakeIM>0){this.fakeIMTimeout&&clearInterval(this.fakeIMTimeout);var a=this;this.fakeIMTimeout=setInterval(function(){Module.BbClassroom.getSharedClassroom().getChatFeature().sendMessageToCurrentRoom(a.getRandomIMMessage(),!1)},1e3*this.fakeIM),Module.BbClassroom.getSharedClassroom().getChatFeature().sendMessageToCurrentRoom(this.getRandomIMMessage(),!1)}},getRandomIMMessage:function(){var a=Math.random().toString(36),b=Math.random().toString(36),c=Math.random().toString(36);return a.substr(2,6)+" "+b.substr(2,6)+" "+c.substr(2,6)},dataURItoBlob:function(a){var b;b=a.split(",")[0].indexOf("base64")>=0?atob(a.split(",")[1]):unescape(a.split(",")[1]);for(var c=a.split(",")[0].split(":")[1].split(";")[0],d=new ArrayBuffer(b.length),e=new Uint8Array(d),f=0;f<b.length;f++)e[f]=b.charCodeAt(f);var g=new DataView(d),h=new Blob([g],{type:c});return h},captureImage:function(){this.canvas||(this.canvas=document.createElement("canvas"),this.canvas.id="loadTesterCanvas",this.canvas.width=640,this.canvas.height=360,this.canvasCtx=this.canvas.getContext("2d")),webRTC.localStream&&$("#my-video").find("video").length>0&&(this.canvasCtx.drawImage($("#my-video").find("video")[0],0,0),this.uploadImage(this.dataURItoBlob(this.canvas.toDataURL("image/png"))))},uploadImage:function(a){participantModel=angular.element(document).injector().get("ParticipantModel"),contentLibraryModel=angular.element(document).injector().get("ContentLibraryModel"),upload=angular.element(document).injector().get("$upload"),upload.upload({headers:{"X-BBCOLLAB-JINX-ID":participantModel.getMyParticipant().address},url:contentLibraryModel.getUploadPath(),file:a})},getMediaStream:function(){if(CallManager.recordUsingSS){if(null==this.localStream&&(this.localStream=webRTC.localStream.clone()),rtcSFU.mssrcVidReference&&rtcSFU.mssrcVidReference[0]){var a=rtcSFU.mssrcVidReference[0].stream;if(a){if(this.lastMCUStream===a)return this.localStream;if(this.localStream){var b=this.localStream.getAudioTracks();for(i=0;i<b.length;i++)this.log("remove audio track"),this.localStream.removeTrack(b[i])}this.mcuStream=this.lastMCUStream=a;var b=this.mcuStream.getAudioTracks();if(0!=b.length)for(i=0;i<b.length;i++)this.log("Adding audio track"),this.mcuStream.removeTrack(b[i]),this.localStream.addTrack(b[i])}}return this.localStream}return webRTC.localStream},startVideoRecording:function(){this.recordedBlobs&&this.stopVideoRecording();var a={mimeType:"video/webm"},b=this.getMediaStream();if(null!=b){try{this.mediaRecorder=new MediaRecorder(b,a)}catch(c){this.log("Unable to create MediaRecorder with options Object: "+c);try{a={mimeType:"video/webm,codecs=vp9"},this.mediaRecorder=new MediaRecorder(b,a)}catch(d){this.log("Unable to create MediaRecorder with options Object: "+d);try{a="video/vp8",this.mediaRecorder=new MediaRecorder(b,a)}catch(e){return this.log("MediaRecorder is not supported by this browser.\n\nTry Firefox 29 or later, or Chrome 47 or later, with Enable experimental Web Platform features enabled from chrome://flags."),void this.log("Exception while creating MediaRecorder:"+e)}}}if(this.log("Created MediaRecorder"+this.mediaRecorder+"with options"+a),this.mediaRecorder.onstop=this.handleVideoRecordingStop.bind(this),this.mediaRecorder.ondataavailable=this.handleDataAvailable.bind(this),this.recordedBlobs=[],this.mediaRecorder.start(),this.log("MediaRecorder started"+this.mediaRecorder),this.webmRollOverDuration>0){this.webmRollOverTimeout&&clearInterval(this.webmRollOverTimeout);var f=this;this.webmRollOverTimeout=setInterval(function(){f.startVideoRecording()},this.webmRollOverDuration)}}},handleDataAvailable:function(a){this.recordedBlobs&&a.data&&a.data.size>0&&this.recordedBlobs.push(a.data)},handleVideoRecordingStop:function(a){this.log("Recorder stopped: "+a)},stopVideoRecording:function(){var a=this.recordedBlobs;this.recordedBlobs=null,this.webmRollOverTimeout&&clearInterval(this.webmRollOverTimeout),this.mediaRecorder&&(this.mediaRecorder.onstop=null,this.mediaRecorder.ondataavailable=null,this.mediaRecorder.stop()),this.mediaRecorder=null,this.downloadVideoRecording(a)},downloadVideoRecording:function(a){if(a&&a.length>0){var b=ConnectionManager.userId+"_"+ConnectionManager.roomSession+"_"+(new Date).getTime()+".webm",c=new Blob(a,{type:"video/webm"}),d=window.URL.createObjectURL(c),e=document.createElement("a");e.style.display="none",e.href=d,e.download=b,document.body.appendChild(e),e.click(),setTimeout(function(){document.body.removeChild(e),window.URL.revokeObjectURL(d)},100),a=null}},log:function(a){(this.logEnabled||Platform.debugLogEnabled)&&Platform.log("loadTest:"+a)}},TelemetryZebraMsgs={reconnectReason:!1,flashStats:!1,audioStats:!1,initialDeviceUpdateSent:!1,diagnosticStatus:"",mcuList:[],diagnosticReport:{Session:{},Connection:{},Device:{}},sendTelemetryConnect:function(){if(CallManager.allowTelemetryConnect){CallManager.allowTelemetryConnect=!1;var a=this.getWebRTCConnectivity();a?this.sendTelemetryConnectZebra(a):(this.connZebraSent=!1,this.sendDelayedTelemetryConnect())}},pushMcu:function(a){a&&this.mcuList.indexOf(a)===-1&&this.mcuList.push(a)},generateTelemetryData:function(){this.diagnosticReport.Session.Id=ConnectionManager.userId;var a=ConnectionManager.roomSession.split("."),b=parseInt(a[1],10);isNaN(b)&&(b=0),this.diagnosticReport.Session.roomSession=a[0],this.diagnosticReport.Session.groupId=b,this.diagnosticReport.Connection.connectivity=rtcStats.protocol,this.diagnosticReport.Connection.mcuList=this.mcuList},getDiagnosticStatus:function(){return JSON.stringify(this.diagnosticReport)},sendDelayedTelemetryConnect:function(){var a=this.getWebRTCConnectivity();if(a)this.connZebraSent||(this.connZebraSent=!0,this.sendTelemetryConnectZebra(a));else{var b=this;setTimeout(function(){b.sendDelayedTelemetryConnect()},1e3)}},getWebRTCConnectivity:function(){return rtcStats.protocol?{connectivity:rtcStats.protocol,initialUpload:""}:null},sendTelemetryConnectZebra:function(a){var b=new Zebra(ConnectionManager.zsZebraGateway+"#TelemetryConnect");CallManager._flashEnabled?(b.setZEvent("connectivity",flashClient._protocol),b.setZEvent("initialUpload",parseInt(flashClient._userUp)),b.setZEvent("reconnect",this.reconnectReason)):(a&&(b.setZEvent("connectivity",a.connectivity),b.setZEvent("initialUpload",a.initialUpload)),b.setZEvent("reconnect",this.reconnectReason)),this.reconnectReason=null,b.setZEvent("type","camera"),this.generateTelemetryData(),ConnectionManager.sendZSZebraCommand("zsMessage",b),this.initialDeviceUpdateSent||(this.initialDeviceUpdateSent=!0,this.sendTelemetryDeviceUpdate(!0))},sendTelemetryDeviceUpdate:function(a){var b=new Zebra(ConnectionManager.zsZebraGateway+"#TelemetryDeviceUpdate"),c="N/A",d="off",e="off",f=TechCheck.getSelectedCamName(),g=TechCheck.getSelectedMicName();if(CallManager._flashEnabled&&(c=flashClient.fpVersion?flashClient.fpVersion.major+"."+flashClient.fpVersion.minor+"."+flashClient.fpVersion.release:"Not Available"),ZVideoViewController.isCamMuted()||(d="on"),ZVideoViewController.isMicMuted()||(e="on"),a||this._lastFpVersion!==c||this._lastCamera!==f||this._lastMic!==g||this._lastCamStatus!==d||this._lastMicStatus!==e){this._lastFpVersion=c,this._lastCamera=f,this._lastMic=g,this._lastCamStatus=d,this._lastMicStatus=e,b.setZEvent("fpVersion",c),b.setZEvent("camera",f),b.setZEvent("cameraStatus",d),b.setZEvent("microphone",g),b.setZEvent("microphoneStatus",e);var h=navigator.userAgent;navigator.hardwareConcurrency&&(h+=" CORES/"+navigator.hardwareConcurrency),ConnectionManager.isWebRTCSupported()&&(h+=" RTC_BROWSER/"+ConnectionManager.webRTCBrowser),b.setZEvent("browserAgent",h),this.diagnosticReport.Device.camera=f,this.diagnosticReport.Device.cameraStatus=d,this.diagnosticReport.Device.microphone=g,this.diagnosticReport.Device.microphoneStatus=e,this.diagnosticReport.Device.browserAgent=navigator.userAgent,this.diagnosticReport.Device.CORES=navigator.hardwareConcurrency,this.diagnosticReport.Device.RTC_BROWSER=ConnectionManager.webRTCBrowser,ConnectionManager.sendZSZebraCommand("zsMessage",b)}},sendTelemetryDisconnect:function(a){var b=new Zebra(ConnectionManager.zsZebraGateway+"#TelemetryDisconnect");b.setZEvent("reason",a),ConnectionManager.sendZSZebraCommand("zsMessage",b),CallManager.allowTelemetryConnect=!0,null==this.reconnectReason&&(this.reconnectReason=a)}},SDPUtils2={sdpParams:{opusStereo:null,opusFec:!0,opusDtx:null,opusMaxPbr:null,audioSendCodec:null,videoSendCodec:null,audioSendBitrate:null,videoSendBitrate:null,videoSendInitialBitrate:null,audioRecvCodec:null,videoRecvCodec:null,audioRecvBitrate:null,videoRecvBitrate:null},loadUrlParams:function(){this.sdpParams.audioSendBitrate=ZVideoViewController.getConfigParam("asbr",null),this.sdpParams.audioSendCodec=ZVideoViewController.getConfigParam("asc",null),this.sdpParams.audioRecvBitrate=ZVideoViewController.getConfigParam("arbr",null),this.sdpParams.audioRecvCodec=ZVideoViewController.getConfigParam("arc",null),this.sdpParams.opusMaxPbr=ZVideoViewController.getConfigParam("opusmaxpbr",null),this.sdpParams.opusFec=String(ZVideoViewController.getConfigParam("opusfec",null)),this.sdpParams.opusDtx=String(ZVideoViewController.getConfigParam("opusdtx",null)),this.sdpParams.opusStereo=String(ZVideoViewController.getConfigParam("stereo",null)),this.sdpParams.videoSendBitrate=ZVideoViewController.getConfigParam("vsbr",null),this.sdpParams.videoSendInitialBitrate=ZVideoViewController.getConfigParam("vsibr",null),this.sdpParams.videoSendCodec=ZVideoViewController.getConfigParam("vsc",null),this.sdpParams.videoRecvBitrate=ZVideoViewController.getConfigParam("vrbr",null),this.sdpParams.videoRecvCodec=ZVideoViewController.getConfigParam("vrc",null)},getCodecPayloadType:function(a,b){var c=this.findLine(a,"a=rtpmap",b);return c?this.getCodecPayloadTypeFromLine(a[c]):null},getCodecPayloadTypeFromLine:function(a){var b=new RegExp("a=rtpmap:(\\d+) \\w+\\/\\d+"),c=a.match(b);return c&&2===c.length?c[1]:null},parseFmtpLine:function(a){var b={},c=a.indexOf(" "),d=a.substring(c+1).split("; "),e=new RegExp("a=fmtp:(\\d+)"),f=a.match(e);if(!f||2!==f.length)return null;b.pt=f[1];for(var g={},h=0;h<d.length;++h){var i=d[h].split("=");2===i.length&&(g[i[0]]=i[1])}return b.params=g,b},writeFmtpLine:function(a){if(!a.hasOwnProperty("pt")||!a.hasOwnProperty("params"))return null;var b=a.pt,c=a.params,d=[],e=0;for(var f in c)d[e]=f+"="+c[f],++e;return 0===e?null:"a=fmtp:"+b.toString()+" "+d.join("; ")},findFmtpLine:function(a,b){var c=this.getCodecPayloadType(a,b);return c?this.findLine(a,"a=fmtp:"+c.toString()):null},findLine:function(a,b,c){return this.findLineInRange(a,0,-1,b,c)},findLineInRange:function(a,b,c,d,e){for(var f=c!==-1?c:a.length,g=b;g<f;++g)if(0===a[g].indexOf(d)&&(!e||a[g].toLowerCase().indexOf(e.toLowerCase())!==-1))return g;return null},setCodecParam:function(a,b,c,d){var e=a.split("\r\n"),f=this.findFmtpLine(e,b),g={};if(null===f){var h=this.findLine(e,"a=rtpmap",b);if(null===h)return a;var i=this.getCodecPayloadTypeFromLine(e[h]);g.pt=i.toString(),g.params={},g.params[c]=d,e.splice(h+1,0,this.writeFmtpLine(g))}else g=this.parseFmtpLine(e[f]),g.params[c]=d,e[f]=this.writeFmtpLine(g);return a=e.join("\r\n")},removeCodecParam:function(a,b,c){var d=a.split("\r\n"),e=this.findFmtpLine(d,b);if(null===e)return a;var f=this.parseFmtpLine(d[e]);delete f.params[c];var g=this.writeFmtpLine(f);return null===g?d.splice(e,1):d[e]=g,a=d.join("\r\n")},setDefaultCodec:function(a,b){var c=a.split(" "),d=c.slice(0,3);d.push(b);for(var e=3;e<c.length;e++)c[e]!==b&&d.push(c[e]);return d.join(" ")},maybePreferCodec:function(a,b,c,d){var e=b+" "+c+" codec";if(!d)return this.trace("No preference on "+e+"."),a;this.trace("Prefer "+e+": "+d);var f=a.split("\r\n"),g=this.findLine(f,"m=",b);if(null===g)return a;var h=this.getCodecPayloadType(f,d);return h&&(f[g]=this.setDefaultCodec(f[g],h)),a=f.join("\r\n")},preferBitRate:function(a,b,c){var d=a.split("\r\n"),e=this.findLine(d,"m=",c);if(null===e)return this.trace("Failed to add bandwidth line to sdp, as no m-line found"),a;var f=this.findLineInRange(d,e+1,-1,"m=");null===f&&(f=d.length);var g=this.findLineInRange(d,e+1,f,"c=");if(null===g)return this.trace("Failed to add bandwidth line to sdp, as no c-line found"),a;var h=this.findLineInRange(d,g+1,f,"b=AS");h&&d.splice(h,1);var i="b=AS:"+b;return d.splice(g+1,0,i),a=d.join("\r\n")},maybeSetOpusOptions:function(a){return"true"===this.sdpParams.opusStereo?a=this.setCodecParam(a,"opus/48000","stereo","1"):"false"===this.sdpParams.opusStereo&&(a=this.removeCodecParam(a,"opus/48000","stereo")),"true"===this.sdpParams.opusFec?a=this.setCodecParam(a,"opus/48000","useinbandfec","1"):"false"===this.sdpParams.opusFec&&(a=this.removeCodecParam(a,"opus/48000","useinbandfec")),"true"===this.sdpParams.opusDtx?a=this.setCodecParam(a,"opus/48000","usedtx","1"):"false"===this.sdpParams.opusDtx&&(a=this.removeCodecParam(a,"opus/48000","usedtx")),this.sdpParams.opusMaxPbr&&(a=this.setCodecParam(a,"opus/48000","maxplaybackrate",this.sdpParams.opusMaxPbr)),a},maybePreferAudioSendCodec:function(a){return this.sdpParams.audioSendCodec?(this.trace("Prefer audio send codec: "+this.sdpParams.audioSendCodec),this.maybePreferCodec(a,"audio","send",this.sdpParams.audioSendCodec)):a},maybePreferVideoSendCodec:function(a){return this.sdpParams.videoSendCodec?(this.trace("Prefer video send codec: "+this.sdpParams.videoSendCodec),this.maybePreferCodec(a,"video","send",this.sdpParams.videoSendCodec)):a},maybeSetAudioSendBitRate:function(a){return this.sdpParams.audioSendBitrate?(this.trace("Prefer audio send bitrate: "+this.sdpParams.audioSendBitrate),this.preferBitRate(a,this.sdpParams.audioSendBitrate,"audio")):a},maybeSetVideoSendBitRate:function(a){return this.sdpParams.videoSendBitrate?(this.trace("Prefer video send bitrate: "+this.sdpParams.videoSendBitrate),this.preferBitRate(a,this.sdpParams.videoSendBitrate,"video")):a},maybeSetVideoSendInitialBitRate:function(a){var b=this.sdpParams.videoSendInitialBitrate;if(!b)return a;var c=b,d=this.sdpParams.videoSendBitrate;d&&(b>d&&(this.trace("Clamping initial bitrate to max bitrate of "+d+" kbps."),b=d,this.sdpParams.videoSendInitialBitrate=b),c=d);var e=a.split("\r\n"),f=this.findLine(e,"m=","video");return null===f?(this.trace("Failed to find video m-line"),a):(a=this.setCodecParam(a,"VP8/90000","x-google-min-bitrate",this.sdpParams.videoSendInitialBitrate.toString()),a=this.setCodecParam(a,"VP8/90000","x-google-max-bitrate",c.toString()))},updateRemoteSDP:function(a){return a=this.maybeSetOpusOptions(a),a=this.maybePreferAudioSendCodec(a),a=this.maybePreferVideoSendCodec(a),a=this.maybeSetAudioSendBitRate(a),a=this.maybeSetVideoSendBitRate(a),a=this.maybeSetVideoSendInitialBitRate(a)},maybePreferAudioReceiveCodec:function(a){return this.sdpParams.audioRecvCodec?(this.trace("Prefer audio receive codec: "+this.sdpParams.audioRecvCodec),this.maybePreferCodec(a,"audio","receive",this.sdpParams.audioRecvCodec)):a},maybePreferVideoReceiveCodec:function(a){return this.sdpParams.videoRecvCodec?(this.trace("Prefer video receive codec: "+this.sdpParams.videoRecvCodec),this.maybePreferCodec(a,"video","receive",this.sdpParams.videoRecvCodec)):a},maybeSetAudioReceiveBitRate:function(a){return this.sdpParams.audioRecvBitrate?(this.trace("Prefer audio receive bitrate: "+this.sdpParams.audioRecvBitrate),this.preferBitRate(a,this.sdpParams.audioRecvBitrate,"audio")):a},maybeSetVideoReceiveBitRate:function(a){return this.sdpParams.videoRecvBitrate?(this.trace("Prefer video receive bitrate: "+this.sdpParams.videoRecvBitrate),this.preferBitRate(a,this.sdpParams.videoRecvBitrate,"video")):a},updateLocalSDP:function(a){return a=this.maybeSetOpusOptions(a),a=this.maybePreferAudioReceiveCodec(a),a=this.maybePreferVideoReceiveCodec(a),a=this.maybeSetAudioReceiveBitRate(a),a=this.maybeSetVideoReceiveBitRate(a)},versionCompare:function(a,b){function c(a){return/^\d+$/.test(a)}var d=!0,e=a.split("."),f=b.split(".");if(!e.every(c)||!f.every(c))return NaN;if(d){for(;e.length<f.length;)e.push("0");for(;f.length<e.length;)f.push("0")}e=e.map(Number),f=f.map(Number);for(var g=0;g<e.length;++g){if(f.length==g)return 1;if(e[g]!=f[g])return e[g]>f[g]?1:-1}return e.length!=f.length?-1:0},trace:function(a){console.log(a)}},AVSDKErrors={NO_PACKET_OUT:"-1",NO_VIDEO_OUT:"-2",NO_AUDIO_OUT:"-3",NO_PACKET_IN:"-4",NO_VIDEO_IN:"-5",NO_AUDIO_IN:"-6",NO_SS_PACKET_OUT:"-7",SDP_CREATE_ERROR:"-8",NO_MO_TIMEOUT:"-9",ICE_CLOSED:"-10",ICE_FAILED:"-11",ICE_DISCONNECTED:"-12",MO_INVALID:"-13",MA_INVALID:"-14",ME_RENEG_ERROR:"-15",NO_PC_TIMEOUT:"-16",ERR_IN_MCU_RESP:"-17",SATURN_REDIAL:"-18",MCU_DISCONNECT:"-19",STREAM_ERROR:"-20",WS_CLOSE_ERROR:"-21",FLASH_SOCKET_ERROR:"-22",NO_SHADOW_TIMEOUT:"-23",ICE_NOT_CONNECTED:"-24",NO_AUDIO_PLAYBACK:"-25",ZMEDIA_ERROR:"-26",DTLS_ERROR:"-27",errorMap:{},init:function(){this.errorMap[this.NO_PACKET_OUT]="No outgoing packet to MCU.",this.errorMap[this.NO_VIDEO_OUT]="No video packet to MCU.",this.errorMap[this.NO_AUDIO_OUT]="No audio packet to MCU.",this.errorMap[this.NO_PACKET_IN]="No incoming packet from MCU.",this.errorMap[this.NO_VIDEO_IN]="No incoming video packet from MCU.",this.errorMap[this.NO_AUDIO_IN]="No incoming audio packet from MCU.",this.errorMap[this.NO_SS_PACKET_OUT]="No screen share packet to MCU.",this.errorMap[this.SDP_CREATE_ERROR]="Failed to create session description.",this.errorMap[this.NO_MO_TIMEOUT]="Not received MEDIA_OFFER from MCU before timeout.",this.errorMap[this.ICE_CLOSED]="ICE connection with MCU closed.",this.errorMap[this.ICE_FAILED]="ICE connection with MCU failed.",this.errorMap[this.ICE_DISCONNECTED]="ICE connection with MCU disconnected.",this.errorMap[this.MO_INVALID]="Invalid MEDIA_OFFER from MCU.",this.errorMap[this.MA_INVALID]="Invalid MEDIA_ANSWER from MCU.",this.errorMap[this.ME_RENEG_ERROR]="Received MEDIA_RENEGOTIATE from MCU with error.",this.errorMap[this.NO_PC_TIMEOUT]="No PLACE_CALL_RESPONSE received from MCU before timeout.",this.errorMap[this.ERR_IN_MCU_RESP]="Error message from MCU",this.errorMap[this.SATURN_REDIAL]="Saturn requested redial by sending REDIAL_MCU_CALL",this.errorMap[this.MCU_DISCONNECT]="Disconnect initiated by MCU",this.errorMap[this.STREAM_ERROR]="Available Streams less then SFU length",this.errorMap[this.WS_CLOSE_ERROR]="Zebra websocket closed with server",this.errorMap[this.FLASH_SOCKET_ERROR]="Media socket between Mona/ZS and MCU disconnected",this.errorMap[this.NO_SHADOW_TIMEOUT]="No SHADOW message received from MCU before timeout.",this.errorMap[this.ICE_NOT_CONNECTED]="Ice connection not established with MCU",this.errorMap[this.NO_AUDIO_PLAYBACK]="MCU sending audio but browser not playing it",this.errorMap[this.DTLS_ERROR]="Error in DTLS connection with MCU",this.errorMap[this.ZMEDIA_ERROR]="Error received from ZMedia"},getReason:function(a){var b=this.errorMap[a];return b||(b="Unknown Error"),b}},BandwidthModes={modes:{appshare:["BandAppShare","BandAppShareLowCam1","BandLowAppShare","BandUltraLowAppShare","BandUltraLowAppShareAndAudio","BandUltraLowAudioOnly","BandHighAppShareLowCam1","BandHighAppShare"],whiteboard:["BandHighCam1Only","BandLowCam1","BandUltraLowCam1","BandLowAudioOnly","BandUltraLowAudioOnly"],camera:["BandHighCamAll","BandHighCam9","BandHighCam8","BandHighCam7","BandHighCam6","BandHighCam5","BandHighCam4","BandHighCam3","BandHighCam2","BandHighCam1","BandHighCam1Only","BandLowCamAll","BandLowCam9","BandLowCam8","BandLowCam7","BandLowCam6","BandLowCam5","BandLowCam4","BandLowCam3","BandLowCam2","BandLowCam1","BandUltraLowCamAll","BandUltraLowCam9","BandUltraLowCam8","BandUltraLowCam7","BandUltraLowCam6","BandUltraLowCam5","BandUltraLowCam4","BandUltraLowCam3","BandUltraLowCam2","BandUltraLowCam1","BandLowAudioOnly","BandUltraLowAudioOnly"]
}},ZVideoViewController=EventDispatcher.extendAsSingleton({Event:{VIDEO_MUTE_TOGGLED:"VIDEO_MUTE_TOGGLED",AUDIO_MUTE_TOGGLED:"AUDIO_MUTE_TOGGLED",CAMERA_DISABLED:"CAMERA_DISABLED",MICROPHONE_DISABLED:"MICROPHONE_DISABLED",MEDIA_ACCESS_GRANTED:"MEDIA_ACCESS_GRANTED",MEDIA_ACCESS_FAILED:"MEDIA_ACCESS_FAILED",ATTACH_RV_STREAM:"ZWRTC_ATTACH_RV_STREAM",REMOVE_RV_STREAM:"ZWRTC_REMOVE_RV_STREAM",FOCUS_RV:"ZWRTC_FOCUS_RV",RV_MUTED:"ZWRTC_RV_MUTED",RV_UNMUTED:"ZWRTC_RV_UNMUTED",RV_NOVIDEO:"RV_NOVIDEO",BANDWIDTH_CHANGE:"BANDWIDTH_CHANGE",MIC_ACTIVITY:"MIC_ACTIVITY",TOP_USERS_ACTIVITY:"TOP_USERS_ACTIVITY",AVSDK_READY:"AVSDK_READY",SCREENSHARE_RECEIVER_START:"SCREENSHARE_RECEIVER_START",SCREENSHARE_RECEIVER_STOP:"SCREENSHARE_RECEIVER_STOP",SCREEN_SHARE_STARTED:"SCREEN_SHARE_STARTED",SCREEN_SHARE_STOPPED:"SCREEN_SHARE_STOPPED",SCREEN_SHARE_RECONNECTING:"SCREEN_SHARE_RECONNECTING",FLASH_SS_MEDIA_STARTED:"FLASH_SS_MEDIA_STARTED",CALL_CONNECTED:"CALL_CONNECTED",CALL_ENDED:"CALL_ENDED",STATE_UPDATED:"STATE_UPDATED",SS_FRESH_INSTALL:"SS_FRESH_INSTALL",SS_INSTALL_ERROR:"SS_INSTALL_ERROR",SS_ERROR:"SS_ERROR",AVSDK_ERROR:"AVSDK_ERROR",FLASH_ERROR:"FLASH_ERROR",WEBRTC_BLOCKED:"WEBRTC_BLOCKED",FF_RTC_NOT_SUPPORTED:"FF_RTC_NOT_SUPPORTED",WS_AUTH_ERROR:"WS_AUTH_ERROR",ZEBRA_WS_RE_FAILED:"ZEBRA_WS_RE_FAILED",MIC_ERROR_SILENT:"MIC_ERROR_SILENT",MIC_START_WORKING:"MIC_START_WORKING",RECEIVE_SINGLE_STREAM:"RECEIVE_SINGLE_STREAM",RECEIVE_AUDIO_ONLY:"RECEIVE_AUDIO_ONLY",RECEIVE_NORMAL:"RECEIVE_NORMAL",RECEIVE_APPSHARE_NORMAL:"RECEIVE_APPSHARE_NORMAL",RECEIVE_APPSHARE_ULTRA_LOW:"RECEIVE_APPSHARE_ULTRA_LOW",SEND_VIDEO_ABORTED:"SEND_VIDEO_ABORTED",SEND_LOW_QUALITY:"SEND_LOW_QUALITY",SEND_APPSHARE_ABORTED:"SEND_APPSHARE_ABORTED",CHANGE_USERSTATE_TO_AWAY:"CHANGE_USERSTATE_TO_AWAY",CHANGE_USERSTATE_SHOW_TOOLTIP:"CHANGE_USERSTATE_SHOW_TOOLTIP",CHANGE_USERSTATE_HIDE_TOOLTIP:"CHANGE_USERSTATE_HIDE_TOOLTIP",APP_SHARE_RESOL_UPDATED:"APP_SHARE_RESOL_UPDATED",MEDIA_STREAMS_UPDATED:"MEDIA_STREAMS_UPDATED",REDIALLING_CaLL:"REDIALLING_CaLL",REDIALLING_FOR_BOR:"REDIALLING_FOR_BOR",LV_SWF_LOADED:"LV_SWF_LOADED",RECONNECT_COUNTDOWN:"RECONNECT_COUNTDOWN",NO_VIDEO_OUT:"NO_VIDEO_OUT",NO_AUDIO_OUT:"NO_AUDIO_OUT",NO_AUDIO_PLAYBACK:"NO_AUDIO_PLAYBACK",SESSION_MIGRATION_START:"SESSION_MIGRATION_START",SESSION_MIGRATION_END:"SESSION_MIGRATION_END",SESSION_MIGRATION_COMPLETE:"SESSION_MIGRATION_COMPLETE",ZEBRA_WS_CONNECT:"ZEBRA_WS_CONNECT",ZEBRA_WS_CLOSED:"ZEBRA_WS_CLOSED",TELEPHONY_UNMUTE_AUDIO:"TELEPHONY_UNMUTE_AUDIO",TELEPHONY_MUTE_AUDIO:"TELEPHONY_MUTE_AUDIO"},State:{WAITING:"WAITING",CONNECTING:"CONNECTING",CONNECTED:"CONNECTED",DISCONNECTED:"DISCONNECTED"},StateType:{RTC_MAIN:"RTC_MAIN",RTC_SS:"RTC_SS",FLASH_LV:"FLASH_LV",FLASH_RV:"FLASH_RV",FLASH_SS:"FLASH_SS"},CompState:{},bwdLimit:800,screenCallBwLimit:1200,muteCam:!0,muteMic:!0,deviceMode:"cammic",initDeviceState:"cammic",mcuCallInitiated:!1,mcuCallConnecting:!1,eventsInitialized:!1,loadTestMode:!1,disableVideoRendering:!1,disableAudioRendering:!1,attachEventArray:{},removeEventArray:[],delayAREvents:!1,eventTimeoutPeriod:3e3,fpVersion:17,callEstablishTimeout:0,reconnect_errorcodes:["0","7","31"],volumeSetting:!0,_lastCamState:!0,_lastMicState:!0,accessingLastUsedDevices:!1,telemetryPeriodicIntv:15e3,redialCheck:!0,logEnabled:!1,canDoZasConnection:!0,stateEventsEnabled:!1,ssReceiverStartEvt:null,mediaFailed:!1,init:function(){this._super()},dispatchReady:function(){"disconnected"==ConnectionManager.zsState?setTimeout(function(){ZVideoViewController.dispatchReady()},1e3):(this.dispatchZEvent(ZVideoViewController.Event.AVSDK_READY,null),ZVideoViewController.getConfigParam("initDevices",!1)&&TechCheck.initDevices())},initSDKEventListeners:function(){this.log("initSDKEventListeners:"+this.eventsInitialized),this.eventsInitialized||(this.eventsInitialized=!0,ConnectionManager.addListener("ZWRTC_READY",this,function(a){this.dispatchReady()}),ConnectionManager.addListener("ZWRTC_VIDEO_MUTE_TOGGLED",this,function(a){this.dispatchCamState()}),ConnectionManager.addListener("ZWRTC_AUDIO_MUTE_TOGGLED",this,function(a){this.dispatchMicState()}),ConnectionManager.addListener("ZWRTC_MEDIA_ACCESS_GRANTED",this,function(a){zwrtc.viewOnly||(this.log("ZWRTC_MEDIA_ACCESS_GRANTED"),this.dispatchZEvent(this.Event.MEDIA_ACCESS_GRANTED,a))}),ConnectionManager.addListener("ZWRTC_MEDIA_ACCESS_FAILED",this,function(a){this.log("ZWRTC_MEDIA_ACCESS_FAILED"),this.getDevices(!0)}),ConnectionManager.addListener("ZWRTC_ATTACH_RV_STREAM",this,function(a){if(!(this.disableVideoRendering||a.userId&&a.userId==ConnectionManager.userId))if(this.delayAREvents){if(a.userId){var b=this.removeEventArray.indexOf(a.userId);b>-1&&this.removeEventArray.splice(b,1),this.attachEventArray[a.userId]=a}}else{this.log("ZWRTC_ATTACH_RV_STREAM:"+a.userId+" composite:"+a.composite),(a.userId||a.composite)&&this.dispatchZEvent(this.Event.ATTACH_RV_STREAM,a),this.log("ZWRTC_ATTACH_RV_STREAM:userId:"+a.userId+" position:"+a.position+" max:"+a.max+" mode:"+a.mode);try{a.stream&&a.stream.getVideoTracks()[0]&&this.log("ZWRTC_ATTACH_RV_STREAM:userId:"+a.userId+" stream:"+a.stream.getVideoTracks()[0].id)}catch(c){}}}),ConnectionManager.addListener("ZWRTC_REMOVE_RV_STREAM",this,function(a){if(!(this.disableVideoRendering||a.userId&&a.userId==ConnectionManager.userId))if(this.delayAREvents){delete this.attachEventArray[a.userId];var b=this.removeEventArray.indexOf(a.userId);b==-1&&this.removeEventArray.push(a.userId)}else this.log("ZWRTC_REMOVE_RV_STREAM:"+a.userId),a.userId&&this.dispatchZEvent(this.Event.REMOVE_RV_STREAM,a)}),ConnectionManager.addListener("ZWRTC_FOCUS_RV",this,function(a){this.disableVideoRendering||(this.delayAREvents?this.focusEvent=a:(this.log("ZWRTC_FOCUS_RV:"+a.userId),this.dispatchZEvent(this.Event.FOCUS_RV,a)))}),ConnectionManager.addListener("ZWRTC_RV_NOVIDEO",this,function(a){this.log("ZWRTC_RV_NOVIDEO:"+a.userId),this.mediaFailed||this.dispatchZEvent(this.Event.RV_NOVIDEO,a)}),ConnectionManager.addListener("ZWRTC_RV_MUTED",this,function(a){this.log("ZWRTC_RV_MUTED:"+a.userId),this.dispatchZEvent(this.Event.RV_MUTED,a)}),ConnectionManager.addListener("ZWRTC_RV_UNMUTED",this,function(a){this.log("ZWRTC_RV_UNMUTED:"+a.userId),this.dispatchZEvent(this.Event.RV_UNMUTED,a)}),ConnectionManager.addListener("NO_AUDIO_OUT",this,function(a){this.mediaFailed||this.dispatchZEvent(this.Event.NO_AUDIO_OUT,a)}),ConnectionManager.addListener("NO_VIDEO_OUT",this,function(a){this.mediaFailed||this.dispatchZEvent(this.Event.NO_VIDEO_OUT,a)}),ConnectionManager.addListener("REDIALLING_CaLL",this,function(a){this.log("REDIALLING_CaLL: error="+a.error+" reason="+a.reason),this.dispatchZEvent(this.Event.REDIALLING_CaLL,a)}),ConnectionManager.addListener("REDIALLING_FOR_BOR",this,function(a){this.dispatchZEvent(this.Event.REDIALLING_FOR_BOR,a)}),ConnectionManager.addListener("LV_SWF_LOADED",this,function(a){this.dispatchZEvent(this.Event.LV_SWF_LOADED,a)}),ConnectionManager.addListener("NO_AUDIO_PLAYBACK",this,function(a){this.mediaFailed||this.dispatchZEvent(this.Event.NO_AUDIO_PLAYBACK,a)}),ConnectionManager.addListener("FLASH_CALL_ESTABLISHED",this,function(a){this.callConnected()}),ConnectionManager.addListener("ZWRTC_CALL_ESTABLISHED",this,function(a){this.callConnected()}),ConnectionManager.addListener("ZWRTC_P2P_ESTABLISHED",this,function(a){this.callConnected()}),CallManager.addListener(CallManager.Event.CONNECTING,this,function(a){this.dispatchStateEvent(this.State.CONNECTING,a)}),CallManager.addListener(CallManager.Event.CONNECTED,this,function(a){this.mcuCallConnecting=!1,this.dispatchStateEvent(this.State.CONNECTED,a)}),CallManager.addListener(CallManager.Event.ENDED,this,function(a){this.dispatchZEvent(this.Event.CALL_ENDED,a),!a||a.conn_type!=this.StateType.RTC_SS&&a.conn_type!=this.StateType.FLASH_SS?(this.dispatchStateEvent(this.State.CONNECTING,a),loadTest.callEnded()):this.CompState[a.conn_type]=this.State.DISCONNECTED}),ConnectionManager.addListener(this.Event.APP_SHARE_RESOL_UPDATED,this,function(a){this.dispatchZEvent(this.Event.APP_SHARE_RESOL_UPDATED,a)}),ConnectionManager.addListener(this.Event.MEDIA_STREAMS_UPDATED,this,function(a){this.disableAudioRendering||this.dispatchZEvent(this.Event.MEDIA_STREAMS_UPDATED,a)}),ConnectionManager.addListener("ZSCREENSHARE_RECEIVER_START",this,function(a){(!a||a.extraChannels&&a.userId!=ConnectionManager.userId)&&(a.userId||(a.userId=""),this.log("ZSCREENSHARE_RECEIVER_START:"+a.userId),this.dispatchZEvent(this.Event.SCREENSHARE_RECEIVER_START,a),this.ssReceiverStartEvt=a,CallManager._flashEnabled&&screenShareViewer.ssStarted())}),ConnectionManager.addListener("ZSCREENSHARE_RECEIVER_STOP",this,function(a){a.userId||(a.userId=""),this.ssReceiverStartEvt=null,this.log("ZSCREENSHARE_RECEIVER_STOP:"+a.userId),this.dispatchZEvent(this.Event.SCREENSHARE_RECEIVER_STOP,a),CallManager._flashEnabled&&screenShareViewer.endCall()}),ConnectionManager.addListener("SCREEN_SHARE_RECONNECTING",this,function(a){this.dispatchZEvent(this.Event.SCREEN_SHARE_RECONNECTING,a)}),ConnectionManager.addListener("SCREEN_SHARE_STARTED",this,function(a){this.dispatchZEvent(this.Event.SCREEN_SHARE_STARTED,a)}),ConnectionManager.addListener("ZEBRA:SHARE_SCREEN_STOPPED",this,function(a){this.dispatchZEvent(this.Event.SCREEN_SHARE_STOPPED,a)}),ConnectionManager.addListener("SESSION_MIGRATION_START",this,function(a){ZVideoViewController._dispatchEvent(this.Event.SESSION_MIGRATION_START,a)}),ConnectionManager.addListener("SESSION_MIGRATION_END",this,function(a){ZVideoViewController._dispatchEvent(this.Event.SESSION_MIGRATION_END,a)}),ConnectionManager.addListener("ZEBRA:MigrationComplete",this,function(a){ZVideoViewController._dispatchEvent(this.Event.SESSION_MIGRATION_COMPLETE,a)}),ConnectionManager.addListener("ZEBRA:RECONNECT_COUNTDOWN",this,function(a){if(!CallManager.seamlessMigration){var b="";if(a){try{b=a.getZEvent("message").value}catch(c){}this.dispatchZEvent(this.Event.RECONNECT_COUNTDOWN,{message:b})}}}),ConnectionManager.addListener("ZEBRA:ZMCUDisconnectToClient",this,function(a){var b=a.getZebraAttribute("error_code"),c="";if(a)try{c=a.getZEvent("reason").value}catch(d){try{c=a.getZEvent("error").value}catch(d){}}var e=AVSDKErrors.getReason(AVSDKErrors.MCU_DISCONNECT)+", error="+b+" reason="+c;this.redialCheck?(this.redialCheck=!1,CallManager.redialCallWithError(AVSDKErrors.MCU_DISCONNECT,e)):(TelemetryZebraMsgs.sendTelemetryDisconnect(e),CallManager.redialCall("Code: "+b+" Message: "+e))}),ConnectionManager.addListener("ICE_CONNECTION_FAILED",this,function(a){this.mediaFailed=!0;var b="WEBRTC_BLOCKED as ICE_CONNECTION_FAILED state is recvd";console.error(b),this.log(b),CallManager.autoUpLog?(ConnectionManager.addListener("ZEBRA:com.blackboard.saturn.zag.zebra.VideoConference#postLog:response",this,function(b){this.dispatchZEvent(this.Event.WEBRTC_BLOCKED,a)}),CallManager.uploadConsoleLogs(b)):this.dispatchZEvent(this.Event.WEBRTC_BLOCKED,a)}),ConnectionManager.addListener("FLASH_ERROR",this,function(a){this.mediaFailed=!0;var b="";b="install"==a.error?"Flash Player not Installed":"Flash player Old",TelemetryZebraMsgs.sendTelemetryDisconnect(b),this.dispatchZEvent(this.Event.FLASH_ERROR,a),this.dispatchStateEvent(this.State.DISCONNECTED,a)}),ConnectionManager.addListener("WS_AUTH_ERROR",this,function(a){var b="";a&&a.reason&&(b=a.reason),TelemetryZebraMsgs.sendTelemetryDisconnect(b),this.terminateZasConnection(),this.dispatchZEvent(this.Event.WS_AUTH_ERROR,a)}),ConnectionManager.addListener("ZEBRA_WS_RE_FAILED",this,function(a){this.dispatchZEvent(this.Event.ZEBRA_WS_RE_FAILED,a)}),ConnectionManager.addListener(this.Event.MIC_ACTIVITY,this,function(a){a&&(0===TechCheck.micGain?a.max=a.min=0:a.max<1&&!this.isMicMuted()&&(a.max=a.min=1)),this.dispatchZEvent(this.Event.MIC_ACTIVITY,a)}),ConnectionManager.addListener("ZWRTC_SFU_DISABLED",this,function(a){this.dispatchZEvent(this.Event.BANDWIDTH_CHANGE,a)}),ConnectionManager.addListener(ConnectionManager.Event.ZS_STATE_CHANGED,this,function(a){this.dispatchStateEvent()}),ConnectionManager.addListener(this.Event.SS_FRESH_INSTALL,this,function(a){this.dispatchZEvent(this.Event.SS_FRESH_INSTALL,a)}),ConnectionManager.addListener(this.Event.SS_ERROR,this,function(a){this.dispatchZEvent(this.Event.SS_ERROR,a)}),ConnectionManager.addListener(this.Event.SS_INSTALL_ERROR,this,function(a){this.dispatchZEvent(this.Event.SS_INSTALL_ERROR,a)}),ConnectionManager.addListener("MIC_NOT_WORKING",this,function(a){this.log("MIC_NOT_WORKING"),CallManager.micNotWorking=!0,this.dispatchZEvent(this.Event.MIC_ERROR_SILENT,a)}),ConnectionManager.addListener("MIC_START_WORKING",this,function(a){this.log("MIC_START_WORKING"),CallManager.micNotWorking=!1,this.dispatchZEvent(this.Event.MIC_START_WORKING,a)}),ConnectionManager.addListener(this.Event.RECEIVE_SINGLE_STREAM,this,function(a){this.log("LOW_BR:RECEIVE_SINGLE_STREAM"),this.dispatchZEvent(this.Event.RECEIVE_SINGLE_STREAM,a),screenShareViewer.bwModeUpdated()}),ConnectionManager.addListener(this.Event.RECEIVE_AUDIO_ONLY,this,function(a){this.log("LOW_BR:RECEIVE_AUDIO_ONLY"),this.dispatchZEvent(this.Event.RECEIVE_AUDIO_ONLY,a),screenShareViewer.endCall()}),ConnectionManager.addListener(this.Event.RECEIVE_NORMAL,this,function(a){this.dispatchZEvent(this.Event.RECEIVE_NORMAL,a)}),ConnectionManager.addListener(this.Event.RECEIVE_APPSHARE_ULTRA_LOW,this,function(a){this.log("LOW_BR:RECEIVE_APPSHARE_ULTRA_LOW"),this.dispatchZEvent(this.Event.RECEIVE_APPSHARE_ULTRA_LOW,a)}),ConnectionManager.addListener(this.Event.RECEIVE_APPSHARE_NORMAL,this,function(a){this.log("LOW_BR:RECEIVE_APPSHARE_NORMAL"),this.dispatchZEvent(this.Event.RECEIVE_APPSHARE_NORMAL,a)}),ConnectionManager.addListener(this.Event.SEND_LOW_QUALITY,this,function(a){this.log("LOW_BR:SEND_LOW_QUALITY"),this.dispatchZEvent(this.Event.SEND_LOW_QUALITY,a)}),ConnectionManager.addListener(this.Event.SEND_VIDEO_ABORTED,this,function(a){this.log("LOW_BR:SEND_VIDEO_ABORTED"),this.dispatchZEvent(this.Event.SEND_VIDEO_ABORTED,a),this.loadTestMode=!1,this.toggleCam(!0)}),ConnectionManager.addListener(this.Event.SEND_APPSHARE_ABORTED,this,function(a){this.log("LOW_BR:SEND_APPSHARE_ABORTED"),this.dispatchZEvent(this.Event.SEND_APPSHARE_ABORTED,a),this.stopScreenShare()}),ConnectionManager.addListener(this.Event.CHANGE_USERSTATE_TO_AWAY,this,function(a){this.log("CHANGE_USERSTATE_TO_AWAY"),this.dispatchZEvent(this.Event.CHANGE_USERSTATE_TO_AWAY,a)}),ConnectionManager.addListener(this.Event.CHANGE_USERSTATE_SHOW_TOOLTIP,this,function(a){this.log("CHANGE_USERSTATE_SHOW_TOOLTIP"),this.dispatchZEvent(this.Event.CHANGE_USERSTATE_SHOW_TOOLTIP,a)}),ConnectionManager.addListener(this.Event.CHANGE_USERSTATE_HIDE_TOOLTIP,this,function(a){this.log("CHANGE_USERSTATE_HIDE_TOOLTIP"),this.dispatchZEvent(this.Event.CHANGE_USERSTATE_HIDE_TOOLTIP,a)}),ConnectionManager.addListener("WEBRTC_DISABLED",this,function(a){this.mediaFailed=!0,a&&"FF_VERSION_ERROR"===a.reason&&(this.log("Switching to Flash as WebRTC in Firefox is only enabled for version > "+a.minVer+" and user's version:"+a.ver),this.dispatchZEvent(this.Event.FF_RTC_NOT_SUPPORTED,a))}),ConnectionManager.addListener("ZEBRA:TelemetryStatus",this,function(a){if(a)try{var b=a.getZEvent("status").value;b&&(TelemetryZebraMsgs.diagnosticStatus=b)}catch(c){}}),ConnectionManager.addListener("ZEBRA:SaturnToClientUserProps",this,function(a){if(a){if(!this.pendingScpZebra){var b=this;setTimeout(function(){if(b.pendingScpZebra)try{var a=b.pendingScpZebra.getZEvent("telephonyAudio").value;b.pendingScpZebra=null,"on"===a?rtcSFU.disableVAD?b.dispatchZEvent(b.Event.TELEPHONY_UNMUTE_AUDIO):webRTC.localStream?ZVideoViewController.toggleMic({mute:!1,device:"phone"}):(TechCheck.isAudioMuted=!1,b.dispatchMicState(!0)):rtcSFU.disableVAD?b.dispatchZEvent(b.Event.TELEPHONY_MUTE_AUDIO):ZVideoViewController.toggleMic({mute:!0,device:"phone"})}catch(c){}},2e3)}this.pendingScpZebra=a}}),ConnectionManager.addListener("WEBSOCKET_CONNECT",this,function(a){this.dispatchZEvent(this.Event.ZEBRA_WS_CONNECT)}),ConnectionManager.addListener("WEBSOCKET_CLOSED",this,function(a){this.dispatchZEvent(this.Event.ZEBRA_WS_CLOSED,a)}))},initSDK:function(a,b,c){this.initAVSDK({muteCam:a,muteMic:b,deviceMode:c})},setConfigParam:function(a,b){null==this._params&&(this._params={}),this._params[a]=b},getConfigParam:function(a,b){return this._params&&null!=this._params[a]?this._params[a]:null!=this.getURLParameter(a)?this.getURLParameter(a):b},initAVSDK:function(a){if(a)for(key in a)a.hasOwnProperty(key)&&this.setConfigParam(key,a[key]);var b=this.getConfigParam("muteCam",!0),c=this.getConfigParam("muteMic",!0),d=this.getConfigParam("deviceMode","viewOnly");CallManager.recordUsingSS=this.getConfigParam("recordUsingSS",!1),this.disableVideoRendering=this.getConfigParam("disableVideoRendering",!1),this.disableAudioRendering=this.getConfigParam("disableAudioRendering",!1),rtcSFU.init(null,null),rtcSFU.useIceCandTo=this.getConfigParam("useIceCandTo",!0),rtcSFU.disableVAD=this.getConfigParam("disableVAD",!1),ssController.fakeAppshareStream=this.getConfigParam("fakeAppshareStream",!1);var e=this.getConfigParam("unmuteAV",!1);e&&(this.loadTestMode=!0,d="cammic","mic"===e?(c=!1,d="mic"):"cam"===e?(b=!1,d="cam"):(b=!1,c=!1)),this.getConfigParam("viewOnly",!1)&&(d="none",this.disableVideoRendering=!0),this.getConfigParam("redialOnFFTC",!0)||(CallManager.redialOnFFTC=!1);var f=parseInt(this.getConfigParam("localLogRollOverDuration",null));!isNaN(f)&&f>0&&(Platform.saveConsoleLogsLocally=!0,Platform.logRollOverDuration=1e3*f,Platform.startLogTimer());var g=parseInt(this.getConfigParam("ffOutMediaCheckTh",null));isNaN(g)||(rtcSFU.ffOutMediaCheckTh=1e3*g);var h=parseInt(this.getConfigParam("telemetryPeriodicIntv",null));isNaN(h)||(this.telemetryPeriodicIntv=1e3*h);var i=this.getConfigParam("lowBrMode",null);"BandLowWithVideo"!==i&&"BandLowAudioOnly"!==i||(CallManager.loadLowBrMode=i);var j=parseInt(this.getConfigParam("uploadBR",null));isNaN(j)||(flashClient._bwdDone=!0,flashClient._userUp=flashClient._maxBwd=j),this.callEstablishTimeout=parseInt(this.getConfigParam("callEstablishTimeout",0)),isNaN(this.callEstablishTimeout)&&(this.callEstablishTimeout=0);var k=0;if(swfobject&&swfobject.getFlashPlayerVersion)try{k=swfobject.getFlashPlayerVersion().major}catch(l){}this.getConfigParam("forceWebRTC",!1)&&(CallManager.forceWebRTC=!0),TechCheck.parseCameraSettings(this.getConfigParam("rtcCameraSettings",{}));var m=parseInt(this.getConfigParam("zmediaRetryCount",null));isNaN(m)||(CallManager.mediaErrorTh=m);var n=parseInt(this.getConfigParam("bwd",null));isNaN(n)||(flashClient._maxBwd=n);var o=parseInt(this.getConfigParam("bufferTime",null));isNaN(o)||(flashClient.bufferTime=o/1e3);var p=parseInt(this.getConfigParam("bufferTimeMax",null));isNaN(p)||(flashClient.bufferTimeMax=p/1e3);var q=parseInt(this.getConfigParam("forcedBR",null));isNaN(q)||(flashClient.forcedBR=q);var r=parseInt(this.getConfigParam("forcedQuality",null));isNaN(r)||(flashClient.forcedQuality=r);var s=parseInt(this.getConfigParam("firstStepTh",null));isNaN(s)||(flashClient.firstStepTh=s);var t=parseInt(this.getConfigParam("firstStepSapLen",null));isNaN(t)||(flashClient.firstStepSapLen=t);var u=parseInt(this.getConfigParam("secondStepTh",null));isNaN(u)||(flashClient.secondStepTh=u);var v=parseInt(this.getConfigParam("secondStepSapLen",null));isNaN(v)||(flashClient.secondStepSapLen=v);var w=this.getConfigParam("appshareStream",null);w&&(CallManager.appshareStream=decodeURIComponent(w));var k=parseInt(this.getConfigParam("fpVersion",null));isNaN(k)||(CallManager.fpVersion=k),ConnectionManager.wsReconnect=this.getConfigParam("zebraWsReconnect",!0);var x=parseInt(this.getConfigParam("zebraWsReMaxTries",null));isNaN(x)||(ConnectionManager.reconnectTriesTh=x);var y=parseInt(this.getConfigParam("zebraWsMaxTimeSeconds",null));isNaN(y)||(ConnectionManager.reconnectMaxTimeSeconds=1e3*y);var z=parseInt(this.getConfigParam("zebraWsReDelaySeconds",null));isNaN(z)||(ConnectionManager.reconnectDelay=1e3*z),this.getConfigParam("disableBufferTime",!0)||(flashClient.enableBufferTime=!0),"enable"!=this.getConfigParam("volumeSetting","enable")&&(this.volumeSetting=!1),ConnectionManager._staticRoute=this.getConfigParam("staticRoute",null),rtcSFU.turnProtocol=this.getConfigParam("turnProtocol",null),this.getConfigParam("forceMediaOverTCP",!1)&&(rtcSFU.iceGatheringTO=1e4,ConnectionManager.isFF()?rtcSFU.iceCandType=rtcSFU.iceCandTypes.TURN_TLS:rtcSFU.iceCandType=rtcSFU.iceCandTypes.TURN_TCP_TLS,this.log("forceMediaOverTCP is true, selecting "+rtcSFU.iceCandType)),this.getConfigParam("lgTURNUrls",null)?(rtcSFU.iceTransportPolicy=this.getConfigParam("iceTransportPolicy","relay"),rtcSFU.lgTURNUrls=this.getConfigParam("lgTURNUrls",null)):rtcSFU.iceTransportPolicy=this.getConfigParam("iceTransportPolicy",null),rtcSFU.sdpSemantics=this.getConfigParam("sdpSemantics",null),rtcSFU.iceCandidatePoolSize=this.getConfigParam("iceCandidatePoolSize",null),ssController.displayMediaEnabled=this.getConfigParam("displayMediaEnabled",!1),CallManager.seamlessMigration=this.getConfigParam("seamlessMigration",!0),CallManager.enableWaitingState=this.getConfigParam("enableWaitingState",!1);var A=this.getConfigParam("ffSSType","window");if("screen"!==A&&"window"!==A||(ssController.mozMediaSource=A),this.getConfigParam("forceProtocol",null)&&(flashClient._forceProtocol=this.getConfigParam("forceProtocol",null)),Platform.enable_cls_logging=this.getConfigParam("sendJSLogsToSaturn",!1),flashClient.cdreliable=this.getConfigParam("cdreliable",!1),flashClient.redialOnFirstDrop=this.getConfigParam("redialOnFirstDrop",!1),flashClient.unbuffered=this.getConfigParam("unbuffered",!1),CallManager.rtcBrowsers=this.getConfigParam("rtcBrowsers",null),ssController.updateConfig(this.getConfigParam("appShare",{})),window.AdapterJS=window.AdapterJS||{},AdapterJS&&AdapterJS.WebRTCPlugin&&AdapterJS.WebRTCPlugin.plugin)this.log("Found plugin installed, ignoring rtcBrowsers config");else if(CallManager.rtcBrowsers){var B=this.getConfigParam("rtcEnabled",!1);if(B===!0){CallManager._flashEnabled=!1,ConnectionManager.webRTCBrowser=this.getConfigParam("rtcBrowser",""),ConnectionManager.webRTCBrowserVersion=this.getConfigParam("rtcBrowserVer","");var C=CallManager.rtcBrowsers[ConnectionManager.webRTCBrowser];TechCheck.setMicSettings(C);var D=C.video_slots_active;isNaN(D)||(ConnectionManager.videoSlotsActive=D,ConnectionManager.videoSlotsActiveFF=D);var E=C.iceRestrictionThreshold;isNaN(E)||(rtcSFU.iceRestrictionTH=1e3*E),rtcSFU.enableIceCandRestriction=C.enableIceCandRestriction}else CallManager._flashEnabled=!0;var F=this.getConfigParam("videoSlotsActiveFF",0);!isNaN(F)&&F>0&&(ConnectionManager.videoSlotsActiveFF=F);var G=this.getConfigParam("videoSlotsActive",0);!isNaN(G)&&G>0&&(ConnectionManager.videoSlotsActive=G)}else CallManager.enableFFRTC=this.getConfigParam("enableFFRTC",!1),ConnectionManager.ffMinVer=this.getConfigParam("minFFRTCVersion",41),ConnectionManager.videoSlotsActiveFF=this.getConfigParam("videoSlotsActiveFF",0),ConnectionManager.videoSlotsActive=this.getConfigParam("videoSlotsActive",0);this.getConfigParam("forceFlash",!1)&&(ConnectionManager.initFlash(),CallManager.fpVersion=12),rtcSFU.enableHangConst=this.getConfigParam("enableHangConst",!1),this.delayAREvents=this.getConfigParam("delayAREvents",!1),rtcSFU.enableAudioNack=this.getConfigParam("enableAudioNack",!1),rtcSFU._useSimulcast=this.getConfigParam("simulcast",!1),rtcSFU._useScreenSimulcast=this.getConfigParam("sssimulcast",!1),rtcSFU.renegotiateCamOnMute=this.getConfigParam("renegotiateCamOnMute",!1),flashClient.useSepAudioStream=this.getConfigParam("useSepAudioStream",!1),TelemetryZebraMsgs.audioStats=this.getConfigParam("audioStats",!1),rtcSFU.checkForMedia=this.getConfigParam("checkForMedia",!0),rtcSFU._enableIceRenegotiation=this.getConfigParam("reneg",!0),rtcSFU._useMcuOffer=this.getConfigParam("mssrc",!0),TechCheck.enableMicGain=this.getConfigParam("enableMicGain",!0),loadTest.init(),SDPUtils2.loadUrlParams(),this.initSDKEventListeners(),ConnectionManager.doBlackboard=!0,ConnectionManager.partner="home",ConnectionManager.service="saturn",CallManager._useNewSSExt=!0,zwrtc._enableSFU=!0,zwrtc._useCustomGUI=!0,rtcSFU._compositeBw=this.bwdLimit,rtcSFU._compositeBwDrop0=this.bwdLimit,rtcSFU._compositeBwDrop1=this.bwdLimit,rtcSFU._compositeBwDrop2=this.bwdLimit,rtcSFU.screenCallBwLimit=this.screenCallBwLimit,rtcSFU._useMcuZebra=!0,CallManager._enableSSZapp=!0,void 0!=b&&(this.muteCam=b),void 0!=c&&(this.muteMic=c),this.loadTestMode?(this._lastMicState=null,this._lastCamState=null):(this._lastMicState=this.muteMic,this._lastCamState=this.muteCam),this.initLogging(),ssController.initInlineInstalls(),TechCheck.init(),void 0!=d&&("cammic"==d||"mic"==d||"cam"==d?(this.deviceMode=d,this.initDeviceState=d,"mic"==d?(TechCheck.isAudioMuted=!1,TechCheck.isVideoMuted=!0):"cam"==d&&(TechCheck.isAudioMuted=!0,TechCheck.isVideoMuted=!1)):("auto"==this.deviceMode&&TechCheck.accessMedia(zwrtc.videoSourceID,zwrtc.audioSourceID),this.deviceMode="none",zwrtc.viewOnly=!0,TechCheck.isAudioMuted=!0,TechCheck.isVideoMuted=!0)),CallManager.zinit(null,null,null,this.deviceMode,!1,null,"sp_flash")},initLogging:function(){CallManager.autoUpLog=this.getConfigParam("autoUpLog",!1);var a=this.getConfigParam("logFilter","all");return null==a&&CallManager.autoUpLog&&(a="all"),"debug"===a?void(Platform.debugLogEnabled=!0):("all"===a?(Platform.debugLogEnabled=!1,a=["zv","p2pMA","callm","connm","rtcs","rtcm","lt","tech","ssv"]):null!=a?(Platform.debugLogEnabled=!1,a=a.split(",")):(Platform.debugLogEnabled=!1,a=[]),a.indexOf("zv")>-1&&(ZVideoViewController.logEnabled=!0),a.indexOf("p2pMA")>-1&&(P2PMicActivity.logEnabled=!0),a.indexOf("callm")>-1&&(CallManager.logEnabled=!0),a.indexOf("connm")>-1&&(ConnectionManager.logEnabled=!0),a.indexOf("rtcs")>-1&&(rtcSFU.logEnabled=!0),a.indexOf("rtcm")>-1&&(rtcMedia.logEnabled=!0),a.indexOf("lt")>-1&&(loadTest.logEnabled=!0),a.indexOf("tech")>-1&&(TechCheck.logEnabled=!0),void(a.indexOf("ssv")>-1&&(screenShareViewer.logEnabled=!0)))},callConnected:function(a){if(this.mcuCallConnecting=!1,this.dispatchZEvent(this.Event.CALL_CONNECTED),this.dispatchStateEvent(this.State.CONNECTED),CallManager.outVideoCheck=!0,CallManager.outAudioCheck=!0,TechCheck.callConnected(),loadTest.callConnected(),TelemetryZebraMsgs.sendTelemetryConnect(),!CallManager._flashEnabled){var b=this;setTimeout(function(){rtcSFU._useMcuOffer&&(null==rtcSFU.mssrcStreams||rtcSFU.SFU_MAX_LEN>b.getObjectLen(rtcSFU.mssrcStreams))&&(b.log("Available Streams less then SFU length, redial call"),CallManager.redialCallWithError(AVSDKErrors.STREAM_ERROR))},1e4)}CallManager.checkMcuMicState?CallManager._flashEnabled||(CallManager.checkMcuMicState=!1,CallManager.initialMicUnmuted?ZVideoViewController.toggleMic({mute:!1,device:"phone"}):CallManager.sendInitialVad()):CallManager.telephonyActive&&!this.isMicMuted()?rtcSFU.sendVadZebra(1,1):!this.isCamMuted()&&this.isMicMuted()&&rtcSFU.sendVadZebra(0,0),this.dispatchCamState(!0),this.dispatchMicState(!0),CallManager.sendClientToSaturnUserProps()},getObjectLen:function(a){var b,c=0;for(b in a)a.hasOwnProperty(b)&&c++;return c},setProxyUrl:function(a){ConnectionManager.bbProxyURL=a,ConnectionManager._dispatchEvent("BB_PROXY_URL_SET")},getConnectionState:function(){return CallManager.mediaRedialDisabled?this.State.WAITING:"busy"==ConnectionManager.zsState&&(zwrtc.isP2P()||zwrtc.isMCU())?this.State.CONNECTED:this.State.CONNECTING},checkGATurnUrl:function(a){var b=rtcSFU.lgTURNUrls;if(rtcSFU.lgTURNUrls&&rtcSFU.lgTURNUrls.length>1&&a){this.log("Before replacing TURN urls "+JSON.stringify(rtcSFU.lgTURNUrls));var c=a.substring(6,a.indexOf("-saturn")),d=b[0].substring(rtcSFU.lgTURNUrls[0].indexOf(":")+1,rtcSFU.lgTURNUrls[0].indexOf("-turn"));if(c!==d){this.log("checkGATurnUrl: saturnDomainPrefix = "+c+" turnDomainPrefix = "+d);for(var e=0;e<rtcSFU.lgTURNUrls.length;e++)rtcSFU.lgTURNUrls[e]&&(this.log("Saturn & TURN have different domain, replacing TURN domains"),rtcSFU.lgTURNUrls[e]=rtcSFU.lgTURNUrls[e].replace(d,c))}this.log("After replacing TURN urls "+JSON.stringify(rtcSFU.lgTURNUrls))}},doZasConnection:function(a,b,c,d,e){this.canDoZasConnection&&(this.canDoZasConnection=!1,this.stateEventsEnabled=!0,this.log("initBB"),ZVideoViewController.CompState={},this.checkGATurnUrl(a),ConnectionManager.initBB(a,b,c,d,e),this.delayAREvents&&this.startEventDelayTimeout())},doZasReconnect:function(a,b,c){b!=-1?b!==ConnectionManager.userId&&this.terminateZasConnection():b=ConnectionManager.userId,a!=-1?a!==ConnectionManager.roomSession&&this.terminateZasConnection():a=ConnectionManager.roomSession,this.doZasConnection(ConnectionManager.saturnURL,ConnectionManager.authToken,a,b,c)},startEventDelayTimeout:function(){this.stopEventDelayTimeout();var a=this;this.eventTimeout=setInterval(function(){var b=a.removeEventArray;a.removeEventArray=[];var c=a.attachEventArray;a.attachEventArray={};var d=a.focusEvent;if(a.focusEvent=null,b){for(var e=0;e<b.length;e++)b[e]&&this.dispatchZEvent(a.Event.REMOVE_RV_STREAM,{userId:b[e]});delete b}if(c){for(var f in c)f&&c[f]&&this.dispatchZEvent(a.Event.ATTACH_RV_STREAM,c[f]);delete c}d&&this.dispatchZEvent(a.Event.FOCUS_RV,d),b=null,c=null,d=null},this.eventTimeoutPeriod)},stopEventDelayTimeout:function(){this.eventTimeout&&clearInterval(this.eventTimeout)},zmediaError:function(a){this.mediaFailed=!0,ConnectionManager.stopZsPolling(),CallManager.terminateOldAppSharePC(),CallManager.terminateOldPC(),this._dispatchEvent(this.Event.AVSDK_ERROR,{error:a}),this.dispatchStateEvent(this.State.DISCONNECTED,{error:a})},terminateZasConnection:function(){this.canDoZasConnection=!0,this.dispatchStateEvent(this.State.DISCONNECTED),this.stateEventsEnabled=!1,this.log("terminateZasConnection"),ConnectionManager.stopZsPolling(),this.terminateMcuConnection(),this.stopEventDelayTimeout()},doMcuConnection:function(){this.log("doMcuConnection:"+this.mcuCallInitiated+" :"+this.mcuCallConnecting),ConnectionManager.allowMediaCall=!0,CallManager.mediaRedialDisabled&&(console.error("Media call not possible, waiting for additional MCU capacity"),this.dispatchWaitingState()),"busy"!==ConnectionManager.zsState||CallManager.isMediaConnected()?this.placeCall():(CallManager._establishMonitorId=null,CallManager.redialNow(AVSDKErrors.WS_CLOSE_ERROR))},placeCall:function(){this.mcuCallConnecting||(this.mcuCallInitiated=!0,this.mcuCallConnecting=!0,CallManager.placeCall("VIDEO","destination@replacebyZas","",!0))},roomChanged:function(a){if(this.log("ZV: user roomID changed: roomId="+a),ConnectionManager.roomSession.indexOf(".")===-1&&a>0){var b=ConnectionManager.roomSession;ConnectionManager.roomSession+="."+a;var c=new Zebra(ConnectionManager.zsZebraGateway+"#ClientSwitchedRoom");c.setZEvent("prevSessionID",b),c.setZEvent("groupId",a),ConnectionManager.sendZSZebraCommand("zsMessage",c),this.log("ZV: roomChanged: sent = "+c.toXML())}},terminateMcuConnection:function(){this.log("terminateMcuConnection"),this.mcuCallInitiated=!1,CallManager.endCall(),screenShareViewer.endCall(),CallManager.terminateOldAppSharePC(),CallManager.terminateOldPC()},requestQuality:function(a,b){},startCameraShare:function(a){ssController.startCameraShare(a)},startScreenShare:function(a){ssController.startScreenShare(a)},stopScreenShare:function(){CallManager.isSharingScreen()&&ssController.stopScreenShare()},getLocalStream:function(){return zwrtc.getLocalStream()},getScreenShareStream:function(){return ssController.getSSStream()},isAppshareReceiving:function(){return null!==this.ssReceiverStartEvt},getAppshareHostAddress:function(){var a=parseInt(ssController.userId,10);return isNaN(a)?null:a},getRemoteStream:function(a){return CallManager.getRemoteStreamFromId(a)},getRemoteStreams:function(){var a=[];return rtcSFU.rvCompositeHigh&&rtcSFU.rvCompositeHigh.peerConnection&&rtcSFU.rvCompositeHigh.peerConnection.getRemoteStreams()&&(a=rtcSFU.rvCompositeHigh.peerConnection.getRemoteStreams()),a},addListener:function(a,b){
this._addListener(a,"ZVideoViewController",b)},removeListener:function(a,b){this._removeListener(a,"ZVideoViewController",b)},determineMode:function(){return CallManager._flashEnabled?"flash":"webrtc"},dispatchCamState:function(a){var b=this.isCamMuted();(b!=this._lastCamState||a)&&(this._lastCamState=b,this._dispatchEvent(this.Event.VIDEO_MUTE_TOGGLED,{mute:b}),TelemetryZebraMsgs.sendTelemetryDeviceUpdate())},dispatchMicState:function(a){var b=this.isMicMuted();if(b!=this._lastMicState||a){this._lastMicState=b,this._dispatchEvent(this.Event.AUDIO_MUTE_TOGGLED,{mute:b});var c=b?0:1;rtcSFU.sendVadZebra(c,c,!0),CallManager.sendClientToSaturnUserProps();var d=this;setTimeout(function(){var a=d.isMicMuted()?0:1;d._dispatchEvent(d.Event.MIC_ACTIVITY,{max:a,min:a})},1e3),TelemetryZebraMsgs.sendTelemetryDeviceUpdate()}},toggleCam:function(a){this.handleToggleCam(a),a===!0&&TechCheck.isVideoMuted&&TechCheck.cameraToggled()},checkIfDeviceAccessGranted:function(){var a=this;this.deviceAccessGrTimeout=setInterval(function(){if(TechCheck.accessingCamera)return void console.log("checkIfDeviceAccessGranted: still accessing camera");var b=!1,c=TechCheck.getActiveVideoStream(),d=TechCheck.getActiveAudioStream();a.isCamAvailable(c)&&(a.deviceAccessGrTimeout&&(clearInterval(a.deviceAccessGrTimeout),a.deviceAccessGrTimeout=null),a.newCamMuteState===!1&&TechCheck.toggleVideoMute(!1),a.newCamMuteState=null,b=!0),a.isMicAvailable(d)&&(a.deviceAccessGrTimeout&&(clearInterval(a.deviceAccessGrTimeout),a.deviceAccessGrTimeout=null),a.newMicMuteState===!1&&TechCheck.toggleAudioMute(!1),a.newMicMuteState=null,b=!0),b&&(a.accessingLastUsedDevices=!1,TechCheck.techCheckDone())},1e3)},handleToggleCam:function(a){return this.isCamAvailable()?void(this.loadTestMode?TechCheck.isVideoMuted&&"mic"!=this.deviceMode&&TechCheck.toggleVideoMute(!1):void 0!=a&&(TechCheck.toggleVideoMute(a),this.dispatchCamState())):void(zwrtc.videoSourceID&&!a&&(this.newCamMuteState=!1,this.accessingLastUsedDevices||(this.accessingLastUsedDevices=!0,TechCheck.camChanged(zwrtc.videoSourceID),this.checkIfDeviceAccessGranted())))},toggleMic:function(a){try{if(a&&a.device){var b=a;if(a=b.mute,this.log("toggleMic called with device:"+b.device+" mute:"+b.mute),"phone"===b.device)return this.isMicAvailable()&&this.handleMicToggle(a),TechCheck.isAudioMuted=b.mute,void this.dispatchMicState(!0)}}catch(c){}this.handleMicToggle(a)},handleMicToggle:function(a){return this.isMicAvailable()?void(this.loadTestMode?TechCheck.isAudioMuted&&"cam"!=this.deviceMode&&TechCheck.toggleAudioMute(!1):void 0!=a&&(TechCheck.toggleAudioMute(a),this.dispatchMicState(!0))):zwrtc.audioSourceID&&!a?(this.newMicMuteState=!1,void(this.accessingLastUsedDevices||(this.accessingLastUsedDevices=!0,TechCheck.micChanged(zwrtc.audioSourceID),this.checkIfDeviceAccessGranted()))):(TechCheck.isAudioMuted=!0,void this.dispatchMicState(!0))},startMicActivity:function(){CallManager.micActivityEnabled=!0,wrtcSetting.initiateMicActivity(this.getLocalStream(),this.Event.MIC_ACTIVITY)},stopMicActivity:function(){CallManager.micActivityEnabled=!1,wrtcSetting.stopMicActivityCheck()},isMicMuted:function(){return TechCheck.isAudioMuted},isCamMuted:function(){return TechCheck.isVideoMuted},isCamAvailable:function(a){return TechCheck.isCamAvailable(a)},isMicAvailable:function(a){return TechCheck.isMicAvailable(a)},isAppShareAvailable:function(){return!CallManager._flashEnabled},getDevices:function(a){a?"cammic"==this.initDeviceState?(this.initDeviceState="cam",zwrtc._confirmAV="cam",webRTC.accessMedia(zwrtc.generateConstraint(zwrtc.pcConfig))):"cam"==this.initDeviceState?(this.initDeviceState="mic",zwrtc._confirmAV="mic",webRTC.accessMedia(zwrtc.generateConstraint(zwrtc.pcConfig))):this.dispatchZEvent(this.Event.MEDIA_ACCESS_FAILED,event):webRTC.accessMedia(zwrtc.generateConstraint(zwrtc.pcConfig))},updateExtensionID:function(a){ssController.updateExtensionID(a),null!==this.ssReceiverStartEvt&&(this.log("updateExtensionID: appshare already running, dispatching SCREENSHARE_RECEIVER_START event again"),this.dispatchZEvent(this.Event.SCREENSHARE_RECEIVER_START,this.ssReceiverStartEvt))},releaseDevices:function(){this.stopScreenShare(),TechCheck.releaseDevices(),this.stopMicActivity()},dispatchWaitingState:function(){var a=this;setTimeout(function(){CallManager.mediaRedialDisabled&&a.dispatchStateEvent(a.State.WAITING)},2e3)},dispatchStateEvent:function(a,b){if(!this.stateEventsEnabled)return void this.log("Not sending CONNECTION STATE:state:"+a+" as ZAS connection is terminated");a||(a=this.getConnectionState());var c=null;c=b&&b.conn_type?b.conn_type:CallManager._flashEnabled?this.StateType.FLASH_LV:this.StateType.RTC_MAIN;var d=this.CompState[c];return d==this.State.DISCONNECTED?void this.log("dispatchStateEvent: old state:"+d+" ignoring new state:"+a):void(this.State.CONNECTING===a&&(CallManager.eventsDisabled||CallManager.mediaRedialDisabled)||(this.log("dispatchStateEvent: old state:"+d+" new state:"+a),a==d&&a!==this.State.WAITING||(this.CompState[c]=d=a,this.log("CONNECTION STATE:state:"+a+" type:"+c),this._dispatchEvent(this.Event.STATE_UPDATED,{state:d,type:c}))))},embedLocalVideo:function(a,b,c){this.log("embedLocalVideo:"+a+" "+b),flashClient.initiAdditionalEvents(),flashClient._show_call_timer=!1,flashClient._timerOnRV=!1,c?(flashClient._bgColor="#"+c,flashClient._stageBGColor="0x"+c):(flashClient._bgColor="#262626",flashClient._stageBGColor="0x262626"),flashClient._displayFSBtn=!1,flashClient.embedFlash(a,b,"PUBLISH")},embedRemoteVideo:function(a,b,c){this.log("embedRemoteVideo:"+a+" "+b),flashClient.initFlashRVEvents(),c?(flashClient._bgColor="#"+c,flashClient._stageBGColor="0x"+c):(flashClient._bgColor="#262626",flashClient._stageBGColor="0x262626"),flashClient._displayFSBtn=!1,flashClient.embedFlashRV(a,b)},embedSSFlashClient:function(a,b,c){return this.log("embedSSFlashClient:"+a+" "+b),"BandLowAudioOnly"==CallManager.lowBrMode?void this.log("embedSSFlashClient: audio only mode detected, ignoring screen share request"):(c?(screenShareViewer._bgColor="#"+c,screenShareViewer._stageBGColor="0x"+c):(screenShareViewer._bgColor="#000000",screenShareViewer._stageBGColor="0x000000"),void screenShareViewer.embedFlash(a,b))},getURLParameter:function(a){var b=decodeURI((RegExp(a+"=(.+?)(&|$)").exec(location.search)||[,null])[1]);return"null"==b?null:b},isSSExtInstalled:function(){return!(!ConnectionManager.isUsingPlugin||!AdapterJS.WebRTCPlugin.plugin.isScreensharingAvailable)||ssController.extInstalled},isInlineInstallSupported:function(){return"object"==typeof chrome.webstore},installSS:function(a){ConnectionManager.contextPath=a,ssController.installExt(ssController.ssInstallError)},setMicGain:function(a){},setSpeakerVolume:function(a){if(this.volumeSetting){try{CallManager.volumeLevel=parseInt(a)}catch(b){}CallManager._flashEnabled&&flashClient.setSpkVolume(a)}},enableCircleMask:function(a){if(CallManager._flashEnabled){var b=flashClient.getFlashObject();b&&(a?b.toggleMask(!0):b.toggleMask(!1))}},getDiagnosticStatus:function(){return TelemetryZebraMsgs.getDiagnosticStatus()},getOS:function(){return ConnectionManager._os},getBrowserName:function(){return ConnectionManager.webRTCBrowser},isWebRTCSupported:function(){return ConnectionManager.isWebRTCSupported()},isTechCheckEnabled:function(){return ConnectionManager.canStopCameraTrack()},getFLashSSResolution:function(){return{width:flashClient.ssWidth,height:flashClient.ssHeight}},getVadValue:function(){return CallManager.vadValue},getMediaStreams:function(){var a={};return rtcSFU.rvCompositeHigh&&(a=rtcSFU.rvCompositeHigh.getMediaStreams()),a},redialMcuConnection:function(){CallManager.redialCall("User initiated redial")},localStreamEnded:function(){ZVideoViewController.toggleCam(!0),ZVideoViewController.toggleMic(!0),webRTC.localStream=null,webRTC.localAudioStream=null,TechCheck.localStream=null},getSessionUID:function(){return ConnectionManager.roomSession},getAudioOutputDevices:function(){return TechCheck.audioOutSource},toggleMediaRecording:function(a,b,c){"audio"===b&&loadTest.handleAudioRecording(a,c)},telephonyToggled:function(a){CallManager.telephonyActive=a},dispatchZEvent:function(a,b){CallManager.eventsDisabled||ZVideoViewController._dispatchEvent(a,b)},enableLogging:function(a){var b=!1;a?("autoupload"===a.logMode?this.setConfigParam("autoUpLog",!0):(this.setConfigParam("autoUpLog",!1),b=!0),"all"===a.logLevel?this.setConfigParam("logFilter","all"):"debug"===a.logLevel?this.setConfigParam("logFilter","debug"):this.setConfigParam("logFilter","")):(this.setConfigParam("autoUpLog",!1),this.setConfigParam("logFilter","")),this.initLogging(),Platform.enable_logging=b},getWebRTCStats:function(){var a=Object.assign({},rtcStats.impStats);return a.downBitrate=rtcSFU.getDownBitrate(),a},getOldPCRTCStats:function(){return rtcStats.oldStats?rtcStats.oldStats:this.getWebRTCStats()},log:function(a){(this.logEnabled||Platform.debugLogEnabled)&&Platform.log("ZVideoViewController: "+a)}}),P2PMicActivity={localStream:null,remoteStream:null,peerConnectionA:null,peerConnectionB:null,rtcAudioActivityTimer:null,eventName:null,timerPeriod:200,logEnabled:!1,audioInputLevel:0,offerOptions:{offerToReceiveAudio:1,offerToReceiveVideo:0},connect:function(a,b){this.eventName=b,this.localStream=a;var c=this.peerConnectionA;if(c&&("connected"==c.iceConnectionState||"completed"==c.iceConnectionState))return this.removeStream(),this.addStream(),void(null===this.rtcAudioActivityTimer&&this.startAudioActivityCheck());var d=this,e=null;this.peerConnectionA=new RTCPeerConnection(e),this.peerConnectionA.onicecandidate=function(a){d.peerConnectionA&&d.onIceCandidate(d.peerConnectionA,a)},this.peerConnectionA.onnegotiationneeded=function(a){d.doOffer()},this.peerConnectionB=new RTCPeerConnection(e),this.peerConnectionB.onicecandidate=function(a){d.peerConnectionB&&d.onIceCandidate(d.peerConnectionB,a)},this.peerConnectionA.oniceconnectionstatechange=function(a){d.peerConnectionA&&d.onIceStateChange(d.peerConnectionA,a)},this.peerConnectionB.oniceconnectionstatechange=function(a){d.peerConnectionB&&d.onIceStateChange(d.peerConnectionB,a)},this.peerConnectionB.onaddstream=this.gotRemoteStream.bind(this),this.addStream()},addStream:function(){if(this.localStream){var a=this;this.localStream.getTracks().forEach(function(b){"audio"===b.kind&&a.peerConnectionA.addTrack(b,a.localStream)})}},doOffer:function(){this.peerConnectionA&&this.peerConnectionA.createOffer(this.onCreateOfferSuccess.bind(this),this.onCreateSessionDescriptionError.bind(this),this.offerOptions)},removeStream:function(){if(this.peerConnectionA){var a=this.peerConnectionA.getSenders();if(a){var b=this;a.forEach(function(a){b.peerConnectionA.removeTrack(a)})}}},onCreateOfferSuccess:function(a){if(this.trace("Offer from peerConnectionA\n"+a.sdp),this.trace("peerConnectionA setLocalDescription start"),this.peerConnectionA&&this.peerConnectionB){var b=this;this.peerConnectionA.setLocalDescription(a,function(){b.peerConnectionA&&b.onSetLocalSuccess(b.peerConnectionA)},this.onSetSessionDescriptionError.bind(this)),this.trace("peerConnectionB setRemoteDescription start"),this.peerConnectionB.setRemoteDescription(a,function(){b.peerConnectionB&&b.onSetRemoteSuccess(b.peerConnectionB)},this.onSetSessionDescriptionError.bind(this)),this.trace("peerConnectionB createAnswer start"),this.peerConnectionB.createAnswer(this.onCreateAnswerSuccess.bind(this),this.onCreateSessionDescriptionError.bind(this))}},onCreateAnswerSuccess:function(a){if(this.trace("Answer from peerConnectionB:\n"+a.sdp),this.trace("peerConnectionB setLocalDescription start"),this.peerConnectionA&&this.peerConnectionB){var b=this;this.peerConnectionB.setLocalDescription(a,function(){b.peerConnectionB&&b.onSetLocalSuccess(b.peerConnectionB)},this.onSetSessionDescriptionError.bind(this)),this.trace("peerConnectionA setRemoteDescription start"),this.peerConnectionA.setRemoteDescription(a,function(){b.peerConnectionA&&b.onSetRemoteSuccess(b.peerConnectionA)},this.onSetSessionDescriptionError.bind(this))}},onCreateSessionDescriptionError:function(a){this.trace("Failed to create session description: "+a.toString())},onSetLocalSuccess:function(a){this.trace(this.getName(a)+" setLocalDescription complete")},onSetRemoteSuccess:function(a){this.trace(this.getName(a)+" setRemoteDescription complete")},onSetSessionDescriptionError:function(a){this.trace("Failed to set session description: "+a.toString())},onIceCandidate:function(a,b){var c=this;b.candidate&&(this.getOtherPc(a).addIceCandidate(new RTCIceCandidate(b.candidate),function(){c.onAddIceCandidateSuccess(a)},function(b){c.onAddIceCandidateError(a,b)}),this.trace(this.getName(a)+" ICE candidate: \n"+b.candidate.candidate))},onAddIceCandidateSuccess:function(a){this.trace(this.getName(a)+" addIceCandidate success")},onAddIceCandidateError:function(a,b){this.trace(this.getName(a)+" failed to add ICE Candidate: "+b.toString())},onIceStateChange:function(a,b){a&&(this.trace(this.getName(a)+" ICE state: "+a.iceConnectionState),"connected"!=a.iceConnectionState&&"completed"!=a.iceConnectionState||null===this.rtcAudioActivityTimer&&this.startAudioActivityCheck())},gotRemoteStream:function(a){this.remoteStream=a.stream,this.trace("peerConnectionB received remote stream")},getName:function(a){return a===this.peerConnectionA?"peerConnectionA":"peerConnectionB"},getOtherPc:function(a){return a===this.peerConnectionA?this.peerConnectionB:this.peerConnectionA},startAudioActivityCheck:function(){var a=this,b=this.peerConnectionB;this.rtcAudioActivityTimer=setInterval(function(){if(b&&("connected"==b.iceConnectionState||"completed"==b.iceConnectionState)){var c=b.getReceivers();for(a.audioInputLevel=0,i=0;i<c.length;i++){var d=c[i];if(d){var e=d.getSynchronizationSources()[0];if(e){var f=e.audioLevel;if(!isNaN(f)){f=Math.round(1e4*f),f>255&&(f=255),rtcSFU.onaudioprocess(f),a.audioInputLevel=f;var g={max:a.audioInputLevel,min:1,from:"rtc"};ConnectionManager.userId&&(g.userId=ConnectionManager.userId),ConnectionManager._dispatchEvent(a.eventName,g)}}}}}},this.timerPeriod)},hangup:function(){this.removeStream(),this.rtcAudioActivityTimer&&clearInterval(this.rtcAudioActivityTimer),this.audioInputLevel=0,this.localStream=null,this.rtcAudioActivityTimer=null,this.eventName=null},close:function(){this.peerConnectionA&&(this.peerConnectionA.onicecandidate=null,this.peerConnectionA.oniceconnectionstatechange=null,this.peerConnectionA.close()),this.peerConnectionB&&(this.peerConnectionB.onicecandidate=null,this.peerConnectionB.oniceconnectionstatechange=null,this.peerConnectionB.close()),this.rtcAudioActivityTimer&&clearInterval(this.rtcAudioActivityTimer),this.audioInputLevel=0,this.localStream=null,this.remoteStream=null,this.peerConnectionA=null,this.peerConnectionB=null,this.rtcAudioActivityTimer=null,this.eventName=null},trace:function(a){(this.logEnabled||Platform.debugLogEnabled)&&Platform.log("P2PMicActivity:"+a)}},rtcStats={outStats:{},inStats:{},ssrcMapping:{},enableStatsGathering:!1,protocol:null,logEnabled:!0,inDelay:1e3,outDelay:2e3,oldStats:{},impStats:{address:"0.0.0.0",audioBytesReceived:0,audioJitter:0,audioPacketsLost:0,audioPacketsReceived:0,availableIncomingBitrate:0,availableOutgoingBitrate:0,concealedSamples:0,connection:"",currentRoundTripTime:0,networkType:"",protocol:""},startRtcStatsTimer:function(){this.enableStatsGathering=!0;var a=null;rtcSFU.rvCompositeHigh&&rtcSFU.rvCompositeHigh.peerConnection&&(a=rtcSFU.rvCompositeHigh.peerConnection),a&&(this.checkSenders(a),this.checkReceivers(a))},checkSenders:function(a){var b=a.getSenders();for(i=0;i<b.length;i++){var c=b[i];c&&c.track&&"live"===c.track.readyState&&null==this.outStats[c.track.id]&&this.getOutStats(a,c.track)}},checkReceivers:function(a){var b=a.getReceivers();for(j=0;j<b.length;j++){var c=b[j];c&&c.track&&"live"===c.track.readyState&&null==this.inStats[c.track.id]&&this.getInStats(a,c.track)}},getInStats:function(a,b){if(a&&b&&this.enableStatsGathering){if("live"!==b.readyState)return delete this.inStats[b.id],void rtcStats.checkReceivers(a);this.inStats[b.id]={},a.getStats(b).then(function(c){rtcStats.parseInStats(b.id,c),rtcStats.checkConnProtocol(b.id),rtcStats.checkIncomingMedia(b.id),setTimeout(function(){rtcStats.getInStats(a,b)},rtcStats.inDelay)})}},getOutStats:function(a,b){if(a&&b&&this.enableStatsGathering){if("live"!==b.readyState)return delete this.outStats[b.id],void rtcStats.checkSenders(a);this.outStats[b.id]={},a.getStats(b).then(function(c){rtcStats.parseOutStats(b.id,c),rtcStats.checkOutgoingMedia(b.id),setTimeout(function(){rtcStats.getOutStats(a,b)},rtcStats.outDelay)})}},parseOutStats:function(a,b){if(b){var c=this;b.forEach(function(b){var d=c.outStats[a];d&&(d[b.type]||(d[b.type]={}),d[b.type][b.id]=b)})}},parseInStats:function(a,b){if(b){var c=this;b.forEach(function(b){var d=c.inStats[a];d&&(d[b.type]||(d[b.type]={}),d[b.type][b.id]=b)})}},checkIncomingMedia:function(a){if(this.inStats&&this.inStats[a]){var b=this,c=this.inStats[a]["inbound-rtp"];if(!c)return;Object.keys(c).forEach(function(d){var e,f=c[d].ssrc,g=c[d].mediaType,h=0;if(b.ssrcMapping[a]){e=b.ssrcMapping[a].msid;var j=0,k=0;b.ssrcMapping[a].bytesReceived&&(j=b.ssrcMapping[a].bytesReceived),b.ssrcMapping[a].timestamp&&(k=b.ssrcMapping[a].timestamp),j>0&&k>0&&(h=Math.round(8*(c[d].bytesReceived-j)/(c[d].timestamp-k)),h>0&&b.log("STREAM_INFO: DOWN: SSRC = "+f+" KIND = "+g+" BR = "+c[d].bytesReceived+" PR = "+c[d].packetsReceived+" PL = "+c[d].packetsLost+" BitRate = "+h+"kbps"))}else{if(ConnectionManager.isFF()){if("audio"===g){var l=rtcSFU.mssrcVidReference[4];if(!l)return;var m=l.stream;if(!m)return;var n=m.getAudioTracks()[0];if(!n||n.id!==a)return;e=l.msid}else for(i=0;i<6;i++)if(4!==i){var l=rtcSFU.mssrcVidReference[i.toString()];if(l){var m=l.stream;if(!m)return;var n=m.getVideoTracks()[0];if(n&&n.id===a){e=l.msid;break}}}}else{var o=c[d].trackId;if(!f||!a)return;var p=b.inStats[a].track;if(!p||!p[o])return;var q=p[o].trackIdentifier;if(!q)return;e=q.split("+")[0]}b.ssrcMapping[a]={msid:e}}if(e&&rtcSFU.mssrcStreams[e]){b.ssrcMapping[a].bytesReceived=c[d].bytesReceived,b.ssrcMapping[a].timestamp=c[d].timestamp;var r=rtcSFU.mssrcStreams[e],s=parseInt(r.index);if("audio"!==g)return"video"===g?(r.videoSSRC=f,void(4!==s&&rtcSFU.handleInboundStats("inVideoTrack"+s,c[d],h))):void 0;if(r.audioSsrcId=f,4===s){rtcSFU.handleInboundStats("inAudioTrack4",c[d],h),b.impStats.audioJitter=c[d].jitter,b.impStats.audioPacketsLost=c[d].packetsLost,b.impStats.audioBytesReceived=c[d].bytesReceived,b.impStats.audioPacketsReceived=c[d].packetsReceived;var t=b.inStats[a].track;if(!t)return;Object.keys(t).forEach(function(a){var c=t[a].concealedSamples;isNaN(c)||(b.impStats.concealedSamples=c)})}}})}},checkOutgoingMedia:function(a){this.outStats&&this.outStats[a]&&(this.parseOutboundRtp(this.outStats[a]["outbound-rtp"],a),this.parseOutCandidatePair(this.outStats[a]["candidate-pair"]))},parseOutCandidatePair:function(a){if(a){var b=this;Object.keys(a).forEach(function(c){b.impStats.availableIncomingBitrate=a[c].availableIncomingBitrate,b.impStats.availableOutgoingBitrate=a[c].availableOutgoingBitrate,b.impStats.currentRoundTripTime=a[c].currentRoundTripTime})}},parseOutboundRtp:function(a,b){if(a){var c=this;Object.keys(a).forEach(function(d){var e=a[d].ssrc,f=a[d].mediaType,g=a[d].bytesSent,h=a[d].packetsSent,i=a[d].timestamp;if(c.ssrcMapping[b]){var j=0,k=0,l=0;c.ssrcMapping[b].bytesSent&&(j=c.ssrcMapping[b].bytesSent),c.ssrcMapping[b].timestamp&&(k=c.ssrcMapping[b].timestamp),j>0&&k>0&&(l=Math.round(8*(g-j)/(i-k)),l>0&&c.log("STREAM_INFO: UP: SSRC = "+e+" KIND = "+f+" BS = "+g+" PS = "+h+" BitRate = "+l+"kbps"))}c.ssrcMapping[b]={bytesSent:g,timestamp:i}})}},checkConnProtocol:function(a){if(null===this.protocol&&this.inStats){var b=this,c=null;if(this.inStats[a]&&(c=this.inStats[a].transport),c)return void Object.keys(c).forEach(function(d){if(c[d].selectedCandidatePairId){var e=b.inStats[a]["local-candidate"];Object.keys(e).forEach(function(a){var f=e[a];if(f.transportId===c[d].id){if("relay"===f.candidateType){var g=f.relayProtocol?f.relayProtocol:f.protocol;b.impStats.connection="TURN",b.impStats.protocol=g.toUpperCase()}else b.impStats.connection="DIRECT",b.impStats.protocol=f.protocol.toUpperCase();b.protocol=b.impStats.connection+" "+b.impStats.protocol,b.impStats.address=f.ip?f.ip:f.address?f.address:"",f.networkType?(b.impStats.networkType=f.networkType,b.protocol=b.protocol+" ("+f.networkType+")"):b.impStats.networkType=""}})}});var d=b.inStats[a]["candidate-pair"];d&&Object.keys(d).forEach(function(c){if(d[c]&&d[c].selected){var e=d[c].localCandidateId,f=b.inStats[a]["local-candidate"][e];if(f){if("relay"===f.candidateType){var g=f.relayProtocol?f.relayProtocol:f.protocol;b.impStats.connection="TURN",b.impStats.protocol=g.toUpperCase()}else b.impStats.connection="DIRECT",b.impStats.protocol=f.protocol.toUpperCase();b.protocol=b.impStats.connection+" "+b.impStats.protocol,b.impStats.address=f.ip?f.ip:f.address?f.address:""}}})}},stopRtcStatsGathering:function(){this.enableStatsGathering=!1,this.protocol=null,this.outStats={},this.inStats={},this.ssrcMapping={}},saveOldStats:function(a,b){this.oldStats=Object.assign({},this.impStats),this.oldStats.downBitrate=rtcSFU.getDownBitrate(),this.oldStats.errorCode=a,this.oldStats.errorMessage=b},log:function(a){(this.logEnabled||Platform.debugLogEnabled)&&Platform.log("rtcStats: "+a)}};